import{a_ as e,aw as t,a$ as r,b0 as n,V as i,av as s,r as o,q as a,a8 as u,a4 as l,as as c,l as h,b1 as d,B as p,x as f,L as g,b2 as m,ap as y,b3 as b,aI as _,d as v,b4 as x,b5 as T,aE as w,n as S,b6 as N,aU as E,b7 as C,b8 as A,b9 as M,K as R,m as P,ba as D,bb as F,bc as O,bd as L,an as B,a0 as k,be as I,p as U,D as V,bf as j,o as G,bg as z,bh as $,bi as H,bj as W,bk as q,bl as X,bm as K,bn as Y,bo as Q,ab as Z,Z as J,bp as ee,bq as te,a9 as re,br as ne,ay as ie,aD as se,bs as oe,bt as ae,bu as ue,bv as le,bw as ce,a1 as he,bx as de,by as pe,bz as fe,Q as ge,bA as me,bB as ye,bC as be,bD as _e,bE as ve,ai as xe,bF as Te,bG as we,bH as Se,bI as Ne,bJ as Ee,bK as Ce,bL as Ae,bM as Me,W as Re,X as Pe,U as De,z as Fe,H as Oe,N as Le,J as Be,R as ke,bN as Ie,bO as Ue,bP as Ve,bQ as je,bR as Ge,bS as ze,bT as $e,bU as He,bV as We,am as qe,bW as Xe,bX as Ke,bY as Ye,bZ as Qe,b_ as Ze,b$ as Je,c0 as et,c1 as tt,c2 as rt,c3 as nt,c4 as it,c5 as st,c6 as ot,c7 as at,c8 as ut,c9 as lt,ca as ct,cb as ht,cc as dt,cd as pt,ce as ft,A as gt,cf as mt,cg as yt,ch as bt,ci as _t,cj as vt,ck as xt,cl as Tt,cm as wt,cn as St,co as Nt,cp as Et,cq as Ct,cr as At,cs as Mt,ct as Rt,cu as Pt,cv as Dt,cw as Ft,cx as Ot,cy as Lt,cz as Bt,cA as kt,cB as It,cC as Ut,cD as Vt,cE as jt,cF as Gt,cG as zt,cH as $t,cI as Ht,cJ as Wt,cK as qt,cL as Xt,cM as Kt,cN as Yt,cO as Qt,cP as Zt,cQ as Jt,cR as er,cS as tr,cT as rr,cU as nr,cV as ir,cW as sr,cX as or,cY as ar,cZ as ur,c_ as lr,c$ as cr,d0 as hr,d1 as dr,d2 as pr,d3 as fr,$ as gr,M as mr,d4 as yr,d5 as br,d6 as _r,d7 as vr,Y as xr,d8 as Tr,d9 as wr,F as Sr,da as Nr,db as Er,dc as Cr,dd as Ar,de as Mr,df as Rr,dg as Pr,dh as Dr,di as Fr,dj as Or,dk as Lr,dl as Br,dm as kr,dn as Ir,dp as Ur,dq as Vr,dr as jr,ds as Gr,dt as zr,du as $r,dv as Hr,dw as Wr,dx as qr,dy as Xr,dz as Kr,dA as Yr,dB as Qr,aa as Zr,dC as Jr,dD as en,aJ as tn,dE as rn,ax as nn,dF as sn,dG as on,dH as an,s as un,dI as ln,dJ as cn,aq as hn,dK as dn,dL as pn,dM as fn,dN as gn,y as mn,ah as yn,dO as bn,dP as _n,dQ as vn,ar as xn,dR as Tn,dS as wn,aC as Sn,dT as Nn,dU as En,v as Cn,dV as An,dW as Mn,j as Rn}from"./vendor-three-ULghQGFO.js";import{b as Pn,R as Dn,g as Fn}from"./vendor-react-e4fu8oQ2.js";import{f as On,b as Ln,c as Bn,d as kn,e as In,m as Un,g as Vn,o as jn,_ as Gn,h as zn,i as $n,P as Hn}from"./vendor-charts-DMm1PkpN.js";import"./vendor-utils-Ms3aQSpU.js";function Wn(e,t,r){return(t=function(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t);if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function qn(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,i,s,o,a=[],u=!0,l=!1;try{if(s=(r=r.call(e)).next,0===t){if(Object(r)!==r)return;u=!1}else for(;!(u=(n=s.call(r)).done)&&(a.push(n.value),a.length!==t);u=!0);}catch(c){l=!0,i=c}finally{try{if(!u&&null!=r.return&&(o=r.return(),Object(o)!==o))return}finally{if(l)throw i}}return a}}(e,t)||Kn(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Xn(e){return function(e){if(Array.isArray(e))return Yn(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||Kn(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Kn(e,t){if(e){if("string"==typeof e)return Yn(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?Yn(e,t):void 0}}function Yn(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function Qn(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function Zn(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,i,s,o,a=[],u=!0,l=!1;try{if(s=(r=r.call(e)).next,0===t);else for(;!(u=(n=s.call(r)).done)&&(a.push(n.value),a.length!==t);u=!0);}catch(e){l=!0,i=e}finally{try{if(!u&&null!=r.return&&(o=r.return(),Object(o)!==o))return}finally{if(l)throw i}}return a}}(e,t)||ei(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Jn(e){return function(e){if(Array.isArray(e))return Qn(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||ei(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ei(e,t){if(e){if("string"==typeof e)return Qn(e,t);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?Qn(e,t):void 0}}function ti(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Pn.useEffect,r=Pn.useRef(),n=Pn.useRef(!1),i=Pn.useRef(!1),s=Zn(Pn.useState(0),2);s[0];var o=s[1];n.current&&(i.current=!0),t((function(){return n.current||(r.current=e(),n.current=!0),o((function(e){return e+1})),function(){i.current&&r.current&&r.current()}}),[])}const ri=new s,ni=new i,ii=new o,si=new i,oi=new i,ai=new o,ui=new o,li=new a,ci=new o,hi=new o;let di=null,pi=null;const fi=[],gi=-1,mi=0,yi=1;class bi extends e{constructor(e,i,s=null){super(i,s),this.objects=e,this.recursive=!0,this.transformGroup=!1,this.rotateSpeed=1,this.raycaster=new t,this.mouseButtons={LEFT:r.PAN,MIDDLE:r.PAN,RIGHT:r.ROTATE},this.touches={ONE:n.PAN},this._onPointerMove=_i.bind(this),this._onPointerDown=vi.bind(this),this._onPointerCancel=xi.bind(this),this._onContextMenu=Ti.bind(this),null!==s&&this.connect(s)}connect(e){super.connect(e),this.domElement.addEventListener("pointermove",this._onPointerMove),this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointerup",this._onPointerCancel),this.domElement.addEventListener("pointerleave",this._onPointerCancel),this.domElement.addEventListener("contextmenu",this._onContextMenu),this.domElement.style.touchAction="none"}disconnect(){this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointerup",this._onPointerCancel),this.domElement.removeEventListener("pointerleave",this._onPointerCancel),this.domElement.removeEventListener("contextmenu",this._onContextMenu),this.domElement.style.touchAction="auto",this.domElement.style.cursor=""}dispose(){this.disconnect()}_updatePointer(e){const t=this.domElement.getBoundingClientRect();ni.x=(e.clientX-t.left)/t.width*2-1,ni.y=-(e.clientY-t.top)/t.height*2+1}_updateState(e){let t;if("touch"===e.pointerType)t=this.touches.ONE;else switch(e.button){case 0:t=this.mouseButtons.LEFT;break;case 1:t=this.mouseButtons.MIDDLE;break;case 2:t=this.mouseButtons.RIGHT;break;default:t=null}switch(t){case r.PAN:case n.PAN:this.state=mi;break;case r.ROTATE:case n.ROTATE:this.state=yi;break;default:this.state=gi}}getRaycaster(){return this.raycaster}setObjects(e){this.objects=e}getObjects(){return this.objects}activate(){this.connect()}deactivate(){this.disconnect()}set mode(e){}get mode(){}}function _i(e){const t=this.object,r=this.domElement,n=this.raycaster;if(!1!==this.enabled){if(this._updatePointer(e),n.setFromCamera(ni,t),di)this.state===mi?n.ray.intersectPlane(ri,ai)&&di.position.copy(ai.sub(ii).applyMatrix4(li)):this.state===yi&&(si.subVectors(ni,oi).multiplyScalar(this.rotateSpeed),di.rotateOnWorldAxis(ci,si.x),di.rotateOnWorldAxis(hi.normalize(),-si.y)),this.dispatchEvent({type:"drag",object:di}),oi.copy(ni);else if("mouse"===e.pointerType||"pen"===e.pointerType)if(fi.length=0,n.setFromCamera(ni,t),n.intersectObjects(this.objects,this.recursive,fi),fi.length>0){const e=fi[0].object;ri.setFromNormalAndCoplanarPoint(t.getWorldDirection(ri.normal),ui.setFromMatrixPosition(e.matrixWorld)),pi!==e&&null!==pi&&(this.dispatchEvent({type:"hoveroff",object:pi}),r.style.cursor="auto",pi=null),pi!==e&&(this.dispatchEvent({type:"hoveron",object:e}),r.style.cursor="pointer",pi=e)}else null!==pi&&(this.dispatchEvent({type:"hoveroff",object:pi}),r.style.cursor="auto",pi=null);oi.copy(ni)}}function vi(e){const t=this.object,r=this.domElement,n=this.raycaster;!1!==this.enabled&&(this._updatePointer(e),this._updateState(e),fi.length=0,n.setFromCamera(ni,t),n.intersectObjects(this.objects,this.recursive,fi),fi.length>0&&(di=!0===this.transformGroup?wi(fi[0].object):fi[0].object,ri.setFromNormalAndCoplanarPoint(t.getWorldDirection(ri.normal),ui.setFromMatrixPosition(di.matrixWorld)),n.ray.intersectPlane(ri,ai)&&(this.state===mi?(li.copy(di.parent.matrixWorld).invert(),ii.copy(ai).sub(ui.setFromMatrixPosition(di.matrixWorld))):this.state===yi&&(ci.set(0,1,0).applyQuaternion(t.quaternion).normalize(),hi.set(1,0,0).applyQuaternion(t.quaternion).normalize())),r.style.cursor="move",this.dispatchEvent({type:"dragstart",object:di})),oi.copy(ni))}function xi(){!1!==this.enabled&&(di&&(this.dispatchEvent({type:"dragend",object:di}),di=null),this.domElement.style.cursor=pi?"pointer":"auto",this.state=gi)}function Ti(e){!1!==this.enabled&&e.preventDefault()}function wi(e,t=null){return e.isGroup&&(t=e),null===e.parent?t:wi(e.parent,t)}var Si,Ni,Ei,Ci;function Ai(){if(Ni)return Si;return Ni=1,Si=function(e){!function(e){if(!e)throw new Error("Eventify cannot use falsy object as events subject");for(var t=["on","fire","off"],r=0;r<t.length;++r)if(e.hasOwnProperty(t[r]))throw new Error("Subject cannot be eventified, since it already has property '"+t[r]+"'")}(e);var t=function(e){var t=Object.create(null);return{on:function(r,n,i){if("function"!=typeof n)throw new Error("callback is expected to be a function");var s=t[r];return s||(s=t[r]=[]),s.push({callback:n,ctx:i}),e},off:function(r,n){if(void 0===r)return t=Object.create(null),e;if(t[r])if("function"!=typeof n)delete t[r];else for(var i=t[r],s=0;s<i.length;++s)i[s].callback===n&&i.splice(s,1);return e},fire:function(r){var n,i=t[r];if(!i)return e;arguments.length>1&&(n=Array.prototype.splice.call(arguments,1));for(var s=0;s<i.length;++s){var o=i[s];o.callback.apply(o.ctx,n)}return e}}}(e);return e.on=t.on,e.off=t.off,e.fire=t.fire,e},Si}var Mi=function(){if(Ci)return Ei;Ci=1,Ei=function(s){"uniqueLinkId"in(s=s||{})&&(s.multigraph=s.uniqueLinkId);void 0===s.multigraph&&(s.multigraph=!1);if("function"!=typeof Map)throw new Error("ngraph.graph requires `Map` to be defined. Please polyfill it before using ngraph");var o=new Map,a=new Map,u={},l=0,c=s.multigraph?function(e,t,r){var s=i(e,t),o=u.hasOwnProperty(s);if(o||N(e,t)){o||(u[s]=0);var a="@"+ ++u[s];s=i(e+a,t+a)}return new n(e,t,r,s)}:function(e,t,r){var s=i(e,t),o=a.get(s);if(o)return o.data=r,o;return new n(e,t,r,s)},h=[],d=E,p=E,f=E,g=E,m={version:20,addNode:_,addLink:function(e,t,n){f();var i=v(e)||_(e),s=v(t)||_(t),o=c(e,t,n),u=a.has(o.id);a.set(o.id,o),r(i,o),e!==t&&r(s,o);return d(o,u?"update":"add"),g(),o},removeLink:function(e,t){void 0!==t&&(e=N(e,t));return S(e)},removeNode:x,getNode:v,getNodeCount:T,getLinkCount:w,getEdgeCount:w,getLinksCount:w,getNodesCount:T,getLinks:function(e){var t=v(e);return t?t.links:null},forEachNode:M,forEachLinkedNode:function(e,t,r){var n=v(e);if(n&&n.links&&"function"==typeof t)return r?function(e,t,r){var n=e.values(),i=n.next();for(;!i.done;){var s=i.value;if(s.fromId===t&&r(o.get(s.toId),s))return!0;i=n.next()}}(n.links,e,t):function(e,t,r){var n=e.values(),i=n.next();for(;!i.done;){var s=i.value,a=s.fromId===t?s.toId:s.fromId;if(r(o.get(a),s))return!0;i=n.next()}}(n.links,e,t)},forEachLink:function(e){if("function"==typeof e)for(var t=a.values(),r=t.next();!r.done;){if(e(r.value))return!0;r=t.next()}},beginUpdate:f,endUpdate:g,clear:function(){f(),M((function(e){x(e.id)})),g()},hasLink:N,hasNode:v,getLink:N};return e(m),function(){var e=m.on;function t(){return m.beginUpdate=f=C,m.endUpdate=g=A,d=y,p=b,m.on=e,e.apply(m,arguments)}m.on=t}(),m;function y(e,t){h.push({link:e,changeType:t})}function b(e,t){h.push({node:e,changeType:t})}function _(e,r){if(void 0===e)throw new Error("Invalid node identifier");f();var n=v(e);return n?(n.data=r,p(n,"update")):(n=new t(e,r),p(n,"add")),o.set(e,n),g(),n}function v(e){return o.get(e)}function x(e){var t=v(e);if(!t)return!1;f();var r=t.links;return r&&(r.forEach(S),t.links=null),o.delete(e),p(t,"remove"),g(),!0}function T(){return o.size}function w(){return a.size}function S(e){if(!e)return!1;if(!a.get(e.id))return!1;f(),a.delete(e.id);var t=v(e.fromId),r=v(e.toId);return t&&t.links.delete(e),r&&r.links.delete(e),d(e,"remove"),g(),!0}function N(e,t){if(void 0!==e&&void 0!==t)return a.get(i(e,t))}function E(){}function C(){l+=1}function A(){0===(l-=1)&&h.length>0&&(m.fire("changed",h),h.length=0)}function M(e){if("function"!=typeof e)throw new Error("Function is expected to iterate over graph nodes. You passed "+e);for(var t=o.values(),r=t.next();!r.done;){if(e(r.value))return!0;r=t.next()}}};var e=Ai();function t(e,t){this.id=e,this.links=null,this.data=t}function r(e,t){e.links?e.links.add(t):e.links=new Set([t])}function n(e,t,r,n){this.fromId=e,this.toId=t,this.data=r,this.id=n}function i(e,t){return e.toString()+"ðŸ‘‰ "+t.toString()}return Ei}();const Ri=Fn(Mi);var Pi,Di,Fi,Oi,Li,Bi={exports:{}},ki={exports:{}};function Ii(){return Di||(Di=1,Pi=function(e){return 0===e?"x":1===e?"y":2===e?"z":"c"+(e+1)}),Pi}function Ui(){if(Oi)return Fi;Oi=1;const e=Ii();return Fi=function(t){return function(r,n){let i=n&&n.indent||0,s=n&&void 0!==n.join?n.join:"\n",o=Array(i+1).join(" "),a=[];for(let u=0;u<t;++u){let t=e(u),n=0===u?"":o;a.push(n+r.replace(/{var}/g,t))}return a.join(s)}},Fi}var Vi,ji={exports:{}};var Gi,zi={exports:{}};var $i,Hi={exports:{}};var Wi,qi={exports:{}};var Xi,Ki,Yi,Qi,Zi,Ji={exports:{}};var es,ts,rs,ns,is={exports:{}};function ss(){if(rs)return ts;rs=1,ts=function(u){var l=(Yi||(Yi=1,Ki=function(e,t,r,n){this.from=e,this.to=t,this.length=r,this.coefficient=n}),Ki),c=(Zi||(Zi=1,Qi=function e(t,r){var n;if(t||(t={}),r)for(n in r)if(r.hasOwnProperty(n)){var i=t.hasOwnProperty(n),s=typeof r[n];i&&typeof t[n]===s?"object"===s&&(t[n]=e(t[n],r[n])):t[n]=r[n]}return t}),Qi),h=Ai();if(u){if(void 0!==u.springCoeff)throw new Error("springCoeff was renamed to springCoefficient");if(void 0!==u.dragCoeff)throw new Error("dragCoeff was renamed to dragCoefficient")}u=c(u,{springLength:10,springCoefficient:.8,gravity:-12,theta:.8,dragCoefficient:.9,timeStep:.5,adaptiveTimeStepWeight:0,dimensions:2,debug:!1});var d=o[u.dimensions];if(!d){var p=u.dimensions;d={Body:e(p,u.debug),createQuadTree:t(p),createBounds:r(p),createDragForce:n(p),createSpringForce:i(p),integrate:s(p)},o[p]=d}var f=d.Body,g=d.createQuadTree,m=d.createBounds,y=d.createDragForce,b=d.createSpringForce,_=d.integrate,v=function(){if(es)return is.exports;function e(e){return new t("number"==typeof e?e:+new Date)}function t(e){this.seed=e}function r(e){return Math.sqrt(2*Math.PI/e)*Math.pow(1/Math.E*(e+1/(12*e-1/(10*e))),e)}function n(){var e=this.seed;return e=4294967295&(3042594569^(e=4251993797+(e=4294967295&(3550635116+(e=374761393+(e=4294967295&(3345072700^(e=e+2127912214+(e<<12)&4294967295)^e>>>19))+(e<<5)&4294967295)^e<<9))+(e<<3)&4294967295)^e>>>16),this.seed=e,(268435455&e)/268435456}return es=1,is.exports=e,is.exports.random=e,is.exports.randomIterator=function(t,r){var n=r||e();if("function"!=typeof n.next)throw new Error("customRandom does not match expected API: next() function is missing");return{forEach:function(e){var r,i,s;for(r=t.length-1;r>0;--r)i=n.next(r+1),s=t[i],t[i]=t[r],t[r]=s,e(s);t.length&&e(t[0])},shuffle:function(){var e,r,i;for(e=t.length-1;e>0;--e)r=n.next(e+1),i=t[r],t[r]=t[e],t[e]=i;return t}}},t.prototype.next=function(e){return Math.floor(this.nextDouble()*e)},t.prototype.nextDouble=n,t.prototype.uniform=n,t.prototype.gaussian=function(){var e,t,r;do{e=(t=2*this.nextDouble()-1)*t+(r=2*this.nextDouble()-1)*r}while(e>=1||0===e);return t*Math.sqrt(-2*Math.log(e)/e)},t.prototype.random=n,t.prototype.levy=function(){var e=1.5,t=Math.pow(r(2.5)*Math.sin(Math.PI*e/2)/(r(1.25)*e*Math.pow(2,.25)),1/e);return this.gaussian()*t/Math.pow(Math.abs(this.gaussian()),1/e)},is.exports}().random(42),x=[],T=[],w=g(u,v),S=m(x,u,v),N=b(u,v),E=y(u),C=[],A=new Map,M=0;D("nbody",(function(){if(0===x.length)return;w.insertBodies(x);var e=x.length;for(;e--;){var t=x[e];t.isPinned||(t.reset(),w.updateBodyForce(t),E.update(t))}})),D("spring",(function(){var e=T.length;for(;e--;)N.update(T[e])}));var R={bodies:x,quadTree:w,springs:T,settings:u,addForce:D,removeForce:function(e){var t=C.indexOf(A.get(e));if(t<0)return;C.splice(t,1),A.delete(e)},getForces:function(){return A},step:function(){for(var e=0;e<C.length;++e)C[e](M);var t=_(x,u.timeStep,u.adaptiveTimeStepWeight);return M+=1,t},addBody:function(e){if(!e)throw new Error("Body is required");return x.push(e),e},addBodyAt:function(e){if(!e)throw new Error("Body position is required");var t=(e=>new f(e))(e);return x.push(t),t},removeBody:function(e){if(e){var t=x.indexOf(e);if(!(t<0))return x.splice(t,1),0===x.length&&S.reset(),!0}},addSpring:function(e,t,r,n){if(!e||!t)throw new Error("Cannot add null spring to force simulator");"number"!=typeof r&&(r=-1);var i=new l(e,t,r,n>=0?n:-1);return T.push(i),i},getTotalMovement:function(){return 0},removeSpring:function(e){if(e){var t=T.indexOf(e);return t>-1?(T.splice(t,1),!0):void 0}},getBestNewBodyPosition:function(e){return S.getBestNewPosition(e)},getBBox:P,getBoundingBox:P,invalidateBBox:function(){},gravity:function(e){return void 0!==e?(u.gravity=e,w.options({gravity:e}),this):u.gravity},theta:function(e){return void 0!==e?(u.theta=e,w.options({theta:e}),this):u.theta},random:v};return function(e,t){for(var r in e)a(e,t,r)}(u,R),h(R),R;function P(){return S.update(),S.box}function D(e,t){if(A.has(e))throw new Error("Force "+e+" is already added");A.set(e,t),C.push(t)}};var e=function(){if(Li)return ki.exports;Li=1;const e=Ui();function t(e,t){return`\n${n(e,t)}\n${r(e)}\nreturn {Body: Body, Vector: Vector};\n`}function r(t){let r=e(t),n=r("{var}",{join:", "});return`\nfunction Body(${n}) {\n  this.isPinned = false;\n  this.pos = new Vector(${n});\n  this.force = new Vector();\n  this.velocity = new Vector();\n  this.mass = 1;\n\n  this.springCount = 0;\n  this.springLength = 0;\n}\n\nBody.prototype.reset = function() {\n  this.force.reset();\n  this.springCount = 0;\n  this.springLength = 0;\n}\n\nBody.prototype.setPosition = function (${n}) {\n  ${r("this.pos.{var} = {var} || 0;",{indent:2})}\n};`}function n(t,r){let n=e(t),i="";return r&&(i=`${n("\n\t   var v{var};\n\tObject.defineProperty(this, '{var}', {\n\t  set: function(v) { \n\t    if (!Number.isFinite(v)) throw new Error('Cannot set non-numbers to {var}');\n\t    v{var} = v; \n\t  },\n\t  get: function() { return v{var}; }\n\t});")}`),`function Vector(${n("{var}",{join:", "})}) {\n  ${i}\n    if (typeof arguments[0] === 'object') {\n      // could be another vector\n      let v = arguments[0];\n      ${n('if (!Number.isFinite(v.{var})) throw new Error("Expected value is not a finite number at Vector constructor ({var})");',{indent:4})}\n      ${n("this.{var} = v.{var};",{indent:4})}\n    } else {\n      ${n('this.{var} = typeof {var} === "number" ? {var} : 0;',{indent:4})}\n    }\n  }\n  \n  Vector.prototype.reset = function () {\n    ${n("this.{var} = ",{join:""})}0;\n  };`}return ki.exports=function(e,r){let n=t(e,r),{Body:i}=new Function(n)();return i},ki.exports.generateCreateBodyFunctionBody=t,ki.exports.getVectorCode=n,ki.exports.getBodyCode=r,ki.exports}(),t=function(){if(Vi)return ji.exports;Vi=1;const e=Ui(),t=Ii();function r(r){let u=e(r),l=Math.pow(2,r),c=`\n${a()}\n${o(r)}\n${n(r)}\n${s(r)}\n${i(r)}\n\nfunction createQuadTree(options, random) {\n  options = options || {};\n  options.gravity = typeof options.gravity === 'number' ? options.gravity : -1;\n  options.theta = typeof options.theta === 'number' ? options.theta : 0.8;\n\n  var gravity = options.gravity;\n  var updateQueue = [];\n  var insertStack = new InsertStack();\n  var theta = options.theta;\n\n  var nodesCache = [];\n  var currentInCache = 0;\n  var root = newNode();\n\n  return {\n    insertBodies: insertBodies,\n\n    /**\n     * Gets root node if it is present\n     */\n    getRoot: function() {\n      return root;\n    },\n\n    updateBodyForce: update,\n\n    options: function(newOptions) {\n      if (newOptions) {\n        if (typeof newOptions.gravity === 'number') {\n          gravity = newOptions.gravity;\n        }\n        if (typeof newOptions.theta === 'number') {\n          theta = newOptions.theta;\n        }\n\n        return this;\n      }\n\n      return {\n        gravity: gravity,\n        theta: theta\n      };\n    }\n  };\n\n  function newNode() {\n    // To avoid pressure on GC we reuse nodes.\n    var node = nodesCache[currentInCache];\n    if (node) {\n${function(e){let t=[];for(let r=0;r<l;++r)t.push(`${e}quad${r} = null;`);return t.join("\n")}("      node.")}\n      node.body = null;\n      node.mass = ${u("node.mass_{var} = ",{join:""})}0;\n      ${u("node.min_{var} = node.max_{var} = ",{join:""})}0;\n    } else {\n      node = new QuadNode();\n      nodesCache[currentInCache] = node;\n    }\n\n    ++currentInCache;\n    return node;\n  }\n\n  function update(sourceBody) {\n    var queue = updateQueue;\n    var v;\n    ${u("var d{var};",{indent:4})}\n    var r; \n    ${u("var f{var} = 0;",{indent:4})}\n    var queueLength = 1;\n    var shiftIdx = 0;\n    var pushIdx = 1;\n\n    queue[0] = root;\n\n    while (queueLength) {\n      var node = queue[shiftIdx];\n      var body = node.body;\n\n      queueLength -= 1;\n      shiftIdx += 1;\n      var differentBody = (body !== sourceBody);\n      if (body && differentBody) {\n        // If the current node is a leaf node (and it is not source body),\n        // calculate the force exerted by the current node on body, and add this\n        // amount to body's net force.\n        ${u("d{var} = body.pos.{var} - sourceBody.pos.{var};",{indent:8})}\n        r = Math.sqrt(${u("d{var} * d{var}",{join:" + "})});\n\n        if (r === 0) {\n          // Poor man's protection against zero distance.\n          ${u("d{var} = (random.nextDouble() - 0.5) / 50;",{indent:10})}\n          r = Math.sqrt(${u("d{var} * d{var}",{join:" + "})});\n        }\n\n        // This is standard gravitation force calculation but we divide\n        // by r^3 to save two operations when normalizing force vector.\n        v = gravity * body.mass * sourceBody.mass / (r * r * r);\n        ${u("f{var} += v * d{var};",{indent:8})}\n      } else if (differentBody) {\n        // Otherwise, calculate the ratio s / r,  where s is the width of the region\n        // represented by the internal node, and r is the distance between the body\n        // and the node's center-of-mass\n        ${u("d{var} = node.mass_{var} / node.mass - sourceBody.pos.{var};",{indent:8})}\n        r = Math.sqrt(${u("d{var} * d{var}",{join:" + "})});\n\n        if (r === 0) {\n          // Sorry about code duplication. I don't want to create many functions\n          // right away. Just want to see performance first.\n          ${u("d{var} = (random.nextDouble() - 0.5) / 50;",{indent:10})}\n          r = Math.sqrt(${u("d{var} * d{var}",{join:" + "})});\n        }\n        // If s / r < Î¸, treat this internal node as a single body, and calculate the\n        // force it exerts on sourceBody, and add this amount to sourceBody's net force.\n        if ((node.max_${t(0)} - node.min_${t(0)}) / r < theta) {\n          // in the if statement above we consider node's width only\n          // because the region was made into square during tree creation.\n          // Thus there is no difference between using width or height.\n          v = gravity * node.mass * sourceBody.mass / (r * r * r);\n          ${u("f{var} += v * d{var};",{indent:10})}\n        } else {\n          // Otherwise, run the procedure recursively on each of the current node's children.\n\n          // I intentionally unfolded this loop, to save several CPU cycles.\n${function(){let e=Array(11).join(" "),t=[];for(let r=0;r<l;++r)t.push(e+`if (node.quad${r}) {`),t.push(e+`  queue[pushIdx] = node.quad${r};`),t.push(e+"  queueLength += 1;"),t.push(e+"  pushIdx += 1;"),t.push(e+"}");return t.join("\n")}()}\n        }\n      }\n    }\n\n    ${u("sourceBody.force.{var} += f{var};",{indent:4})}\n  }\n\n  function insertBodies(bodies) {\n    ${u("var {var}min = Number.MAX_VALUE;",{indent:4})}\n    ${u("var {var}max = Number.MIN_VALUE;",{indent:4})}\n    var i = bodies.length;\n\n    // To reduce quad tree depth we are looking for exact bounding box of all particles.\n    while (i--) {\n      var pos = bodies[i].pos;\n      ${u("if (pos.{var} < {var}min) {var}min = pos.{var};",{indent:6})}\n      ${u("if (pos.{var} > {var}max) {var}max = pos.{var};",{indent:6})}\n    }\n\n    // Makes the bounds square.\n    var maxSideLength = -Infinity;\n    ${u("if ({var}max - {var}min > maxSideLength) maxSideLength = {var}max - {var}min ;",{indent:4})}\n\n    currentInCache = 0;\n    root = newNode();\n    ${u("root.min_{var} = {var}min;",{indent:4})}\n    ${u("root.max_{var} = {var}min + maxSideLength;",{indent:4})}\n\n    i = bodies.length - 1;\n    if (i >= 0) {\n      root.body = bodies[i];\n    }\n    while (i--) {\n      insert(bodies[i], root);\n    }\n  }\n\n  function insert(newBody) {\n    insertStack.reset();\n    insertStack.push(root, newBody);\n\n    while (!insertStack.isEmpty()) {\n      var stackItem = insertStack.pop();\n      var node = stackItem.node;\n      var body = stackItem.body;\n\n      if (!node.body) {\n        // This is internal node. Update the total mass of the node and center-of-mass.\n        ${u("var {var} = body.pos.{var};",{indent:8})}\n        node.mass += body.mass;\n        ${u("node.mass_{var} += body.mass * {var};",{indent:8})}\n\n        // Recursively insert the body in the appropriate quadrant.\n        // But first find the appropriate quadrant.\n        var quadIdx = 0; // Assume we are in the 0's quad.\n        ${u("var min_{var} = node.min_{var};",{indent:8})}\n        ${u("var max_{var} = (min_{var} + node.max_{var}) / 2;",{indent:8})}\n\n${function(){let e=[],n=Array(8+1).join(" ");for(let i=0;i<r;++i)e.push(n+`if (${t(i)} > max_${t(i)}) {`),e.push(n+`  quadIdx = quadIdx + ${Math.pow(2,i)};`),e.push(n+`  min_${t(i)} = max_${t(i)};`),e.push(n+`  max_${t(i)} = node.max_${t(i)};`),e.push(n+"}");return e.join("\n")}()}\n\n        var child = getChild(node, quadIdx);\n\n        if (!child) {\n          // The node is internal but this quadrant is not taken. Add\n          // subnode to it.\n          child = newNode();\n          ${u("child.min_{var} = min_{var};",{indent:10})}\n          ${u("child.max_{var} = max_{var};",{indent:10})}\n          child.body = body;\n\n          setChild(node, quadIdx, child);\n        } else {\n          // continue searching in this quadrant.\n          insertStack.push(child, body);\n        }\n      } else {\n        // We are trying to add to the leaf node.\n        // We have to convert current leaf into internal node\n        // and continue adding two nodes.\n        var oldBody = node.body;\n        node.body = null; // internal nodes do not cary bodies\n\n        if (isSamePosition(oldBody.pos, body.pos)) {\n          // Prevent infinite subdivision by bumping one node\n          // anywhere in this quadrant\n          var retriesCount = 3;\n          do {\n            var offset = random.nextDouble();\n            ${u("var d{var} = (node.max_{var} - node.min_{var}) * offset;",{indent:12})}\n\n            ${u("oldBody.pos.{var} = node.min_{var} + d{var};",{indent:12})}\n            retriesCount -= 1;\n            // Make sure we don't bump it out of the box. If we do, next iteration should fix it\n          } while (retriesCount > 0 && isSamePosition(oldBody.pos, body.pos));\n\n          if (retriesCount === 0 && isSamePosition(oldBody.pos, body.pos)) {\n            // This is very bad, we ran out of precision.\n            // if we do not return from the method we'll get into\n            // infinite loop here. So we sacrifice correctness of layout, and keep the app running\n            // Next layout iteration should get larger bounding box in the first step and fix this\n            return;\n          }\n        }\n        // Next iteration should subdivide node further.\n        insertStack.push(node, oldBody);\n        insertStack.push(node, body);\n      }\n    }\n  }\n}\nreturn createQuadTree;\n\n`;return c}function n(t){let r=e(t);return`\n  function isSamePosition(point1, point2) {\n    ${r("var d{var} = Math.abs(point1.{var} - point2.{var});",{indent:2})}\n  \n    return ${r("d{var} < 1e-8",{join:" && "})};\n  }  \n`}function i(e){var t=Math.pow(2,e);return`\nfunction setChild(node, idx, child) {\n  ${function(){let e=[];for(let r=0;r<t;++r){let t=0===r?"  ":"  else ";e.push(`${t}if (idx === ${r}) node.quad${r} = child;`)}return e.join("\n")}()}\n}`}function s(e){return`function getChild(node, idx) {\n${function(){let t=[],r=Math.pow(2,e);for(let e=0;e<r;++e)t.push(`  if (idx === ${e}) return node.quad${e};`);return t.join("\n")}()}\n  return null;\n}`}function o(t){let r=e(t),n=Math.pow(2,t);var i=`\nfunction QuadNode() {\n  // body stored inside this node. In quad tree only leaf nodes (by construction)\n  // contain bodies:\n  this.body = null;\n\n  // Child nodes are stored in quads. Each quad is presented by number:\n  // 0 | 1\n  // -----\n  // 2 | 3\n${function(e){let t=[];for(let r=0;r<n;++r)t.push(`${e}quad${r} = null;`);return t.join("\n")}("  this.")}\n\n  // Total mass of current node\n  this.mass = 0;\n\n  // Center of mass coordinates\n  ${r("this.mass_{var} = 0;",{indent:2})}\n\n  // bounding box coordinates\n  ${r("this.min_{var} = 0;",{indent:2})}\n  ${r("this.max_{var} = 0;",{indent:2})}\n}\n`;return i}function a(){return"\n/**\n * Our implementation of QuadTree is non-recursive to avoid GC hit\n * This data structure represent stack of elements\n * which we are trying to insert into quad tree.\n */\nfunction InsertStack () {\n    this.stack = [];\n    this.popIdx = 0;\n}\n\nInsertStack.prototype = {\n    isEmpty: function() {\n        return this.popIdx === 0;\n    },\n    push: function (node, body) {\n        var item = this.stack[this.popIdx];\n        if (!item) {\n            // we are trying to avoid memory pressure: create new element\n            // only when absolutely necessary\n            this.stack[this.popIdx] = new InsertStackElement(node, body);\n        } else {\n            item.node = node;\n            item.body = body;\n        }\n        ++this.popIdx;\n    },\n    pop: function () {\n        if (this.popIdx > 0) {\n            return this.stack[--this.popIdx];\n        }\n    },\n    reset: function () {\n        this.popIdx = 0;\n    }\n};\n\nfunction InsertStackElement(node, body) {\n    this.node = node; // QuadTree node\n    this.body = body; // physical body which needs to be inserted to node\n}\n"}return ji.exports=function(e){let t=r(e);return new Function(t)()},ji.exports.generateQuadTreeFunctionBody=r,ji.exports.getInsertStackCode=a,ji.exports.getQuadNodeCode=o,ji.exports.isSamePosition=n,ji.exports.getChildBodyCode=s,ji.exports.setChildBodyCode=i,ji.exports}(),r=function(){if(Gi)return zi.exports;Gi=1,zi.exports=function(e){let r=t(e);return new Function("bodies","settings","random",r)},zi.exports.generateFunctionBody=t;const e=Ui();function t(t){let r=e(t);return`\n  var boundingBox = {\n    ${r("min_{var}: 0, max_{var}: 0,",{indent:4})}\n  };\n\n  return {\n    box: boundingBox,\n\n    update: updateBoundingBox,\n\n    reset: resetBoundingBox,\n\n    getBestNewPosition: function (neighbors) {\n      var ${r("base_{var} = 0",{join:", "})};\n\n      if (neighbors.length) {\n        for (var i = 0; i < neighbors.length; ++i) {\n          let neighborPos = neighbors[i].pos;\n          ${r("base_{var} += neighborPos.{var};",{indent:10})}\n        }\n\n        ${r("base_{var} /= neighbors.length;",{indent:8})}\n      } else {\n        ${r("base_{var} = (boundingBox.min_{var} + boundingBox.max_{var}) / 2;",{indent:8})}\n      }\n\n      var springLength = settings.springLength;\n      return {\n        ${r("{var}: base_{var} + (random.nextDouble() - 0.5) * springLength,",{indent:8})}\n      };\n    }\n  };\n\n  function updateBoundingBox() {\n    var i = bodies.length;\n    if (i === 0) return; // No bodies - no borders.\n\n    ${r("var max_{var} = -Infinity;",{indent:4})}\n    ${r("var min_{var} = Infinity;",{indent:4})}\n\n    while(i--) {\n      // this is O(n), it could be done faster with quadtree, if we check the root node bounds\n      var bodyPos = bodies[i].pos;\n      ${r("if (bodyPos.{var} < min_{var}) min_{var} = bodyPos.{var};",{indent:6})}\n      ${r("if (bodyPos.{var} > max_{var}) max_{var} = bodyPos.{var};",{indent:6})}\n    }\n\n    ${r("boundingBox.min_{var} = min_{var};",{indent:4})}\n    ${r("boundingBox.max_{var} = max_{var};",{indent:4})}\n  }\n\n  function resetBoundingBox() {\n    ${r("boundingBox.min_{var} = boundingBox.max_{var} = 0;",{indent:4})}\n  }\n`}return zi.exports}(),n=function(){if($i)return Hi.exports;$i=1;const e=Ui();function t(t){return`\n  if (!Number.isFinite(options.dragCoefficient)) throw new Error('dragCoefficient is not a finite number');\n\n  return {\n    update: function(body) {\n      ${e(t)("body.force.{var} -= options.dragCoefficient * body.velocity.{var};",{indent:6})}\n    }\n  };\n`}return Hi.exports=function(e){let r=t(e);return new Function("options",r)},Hi.exports.generateCreateDragForceFunctionBody=t,Hi.exports}(),i=function(){if(Wi)return qi.exports;Wi=1;const e=Ui();function t(t){let r=e(t);return`\n  if (!Number.isFinite(options.springCoefficient)) throw new Error('Spring coefficient is not a number');\n  if (!Number.isFinite(options.springLength)) throw new Error('Spring length is not a number');\n\n  return {\n    /**\n     * Updates forces acting on a spring\n     */\n    update: function (spring) {\n      var body1 = spring.from;\n      var body2 = spring.to;\n      var length = spring.length < 0 ? options.springLength : spring.length;\n      ${r("var d{var} = body2.pos.{var} - body1.pos.{var};",{indent:6})}\n      var r = Math.sqrt(${r("d{var} * d{var}",{join:" + "})});\n\n      if (r === 0) {\n        ${r("d{var} = (random.nextDouble() - 0.5) / 50;",{indent:8})}\n        r = Math.sqrt(${r("d{var} * d{var}",{join:" + "})});\n      }\n\n      var d = r - length;\n      var coefficient = ((spring.coefficient > 0) ? spring.coefficient : options.springCoefficient) * d / r;\n\n      ${r("body1.force.{var} += coefficient * d{var}",{indent:6})};\n      body1.springCount += 1;\n      body1.springLength += r;\n\n      ${r("body2.force.{var} -= coefficient * d{var}",{indent:6})};\n      body2.springCount += 1;\n      body2.springLength += r;\n    }\n  };\n`}return qi.exports=function(e){let r=t(e);return new Function("options","random",r)},qi.exports.generateCreateSpringForceFunctionBody=t,qi.exports}(),s=function(){if(Xi)return Ji.exports;Xi=1;const e=Ui();function t(t){let r=e(t);return`\n  var length = bodies.length;\n  if (length === 0) return 0;\n\n  ${r("var d{var} = 0, t{var} = 0;",{indent:2})}\n\n  for (var i = 0; i < length; ++i) {\n    var body = bodies[i];\n    if (body.isPinned) continue;\n\n    if (adaptiveTimeStepWeight && body.springCount) {\n      timeStep = (adaptiveTimeStepWeight * body.springLength/body.springCount);\n    }\n\n    var coeff = timeStep / body.mass;\n\n    ${r("body.velocity.{var} += coeff * body.force.{var};",{indent:4})}\n    ${r("var v{var} = body.velocity.{var};",{indent:4})}\n    var v = Math.sqrt(${r("v{var} * v{var}",{join:" + "})});\n\n    if (v > 1) {\n      // We normalize it so that we move within timeStep range. \n      // for the case when v <= 1 - we let velocity to fade out.\n      ${r("body.velocity.{var} = v{var} / v;",{indent:6})}\n    }\n\n    ${r("d{var} = timeStep * body.velocity.{var};",{indent:4})}\n\n    ${r("body.pos.{var} += d{var};",{indent:4})}\n\n    ${r("t{var} += Math.abs(d{var});",{indent:4})}\n  }\n\n  return (${r("t{var} * t{var}",{join:" + "})})/length;\n`}return Ji.exports=function(e){let r=t(e);return new Function("bodies","timeStep","adaptiveTimeStepWeight",r)},Ji.exports.generateIntegratorFunctionBody=t,Ji.exports}(),o={};function a(e,t,r){if(e.hasOwnProperty(r)&&"function"!=typeof t[r]){var n=Number.isFinite(e[r]);t[r]=n?function(n){if(void 0!==n){if(!Number.isFinite(n))throw new Error("Value of "+r+" should be a valid number.");return e[r]=n,t}return e[r]}:function(n){return void 0!==n?(e[r]=n,t):e[r]}}}return ts}var os=function(){if(ns)return Bi.exports;ns=1,Bi.exports=function(r,n){if(!r)throw new Error("Graph structure cannot be undefined");var i=(n&&n.createSimulator||ss())(n);if(Array.isArray(n))throw new Error("Physics settings is expected to be an object");var s=r.version>19?function(e){var t=r.getLinks(e);return t?1+t.size/3:1}:function(e){var t=r.getLinks(e);return t?1+t.length/3:1};n&&"function"==typeof n.nodeMass&&(s=n.nodeMass);var o=new Map,a={},u=0,l=i.settings.springTransform||t;u=0,r.forEachNode((function(e){g(e.id),u+=1})),r.forEachLink(y),r.on("changed",f);var c=!1,h={step:function(){if(0===u)return d(!0),!0;var e=i.step();h.lastMove=e,h.fire("step");var t=e/u<=.01;return d(t),t},getNodePosition:function(e){return v(e).pos},setNodePosition:function(e){var t=v(e);t.setPosition.apply(t,Array.prototype.slice.call(arguments,1))},getLinkPosition:function(e){var t=a[e];if(t)return{from:t.from.pos,to:t.to.pos}},getGraphRect:function(){return i.getBBox()},forEachBody:p,pinNode:function(e,t){v(e.id).isPinned=!!t},isNodePinned:function(e){return v(e.id).isPinned},dispose:function(){r.off("changed",f),h.fire("disposed")},getBody:function(e){return o.get(e)},getSpring:function(e,t){var n;if(void 0===t)n="object"!=typeof e?e:e.id;else{var i=r.hasLink(e,t);if(!i)return;n=i.id}return a[n]},getForceVectorLength:function(){var e=0,t=0;return p((function(r){e+=Math.abs(r.force.x),t+=Math.abs(r.force.y)})),Math.sqrt(e*e+t*t)},simulator:i,graph:r,lastMove:0};return e(h),h;function d(e){var t;c!==e&&(c=e,t=e,h.fire("stable",t))}function p(e){o.forEach(e)}function f(e){for(var t=0;t<e.length;++t){var n=e[t];"add"===n.changeType?(n.node&&g(n.node.id),n.link&&y(n.link)):"remove"===n.changeType&&(n.node&&m(n.node),n.link&&b(n.link))}u=r.getNodesCount()}function g(e){var t=o.get(e);if(!t){var n=r.getNode(e);if(!n)throw new Error("initBody() was called with unknown node id");var s=n.position;if(!s){var a=function(e){var t=[];if(!e.links)return t;for(var r=Math.min(e.links.length,2),n=0;n<r;++n){var i=e.links[n],s=i.fromId!==e.id?o.get(i.fromId):o.get(i.toId);s&&s.pos&&t.push(s)}return t}(n);s=i.getBestNewBodyPosition(a)}(t=i.addBodyAt(s)).id=e,o.set(e,t),_(e),function(e){return e&&(e.isPinned||e.data&&e.data.isPinned)}(n)&&(t.isPinned=!0)}}function m(e){var t=e.id,r=o.get(t);r&&(o.delete(t),i.removeBody(r))}function y(e){_(e.fromId),_(e.toId);var t=o.get(e.fromId),r=o.get(e.toId),n=i.addSpring(t,r,e.length);l(e,n),a[e.id]=n}function b(e){var t=a[e.id];if(t){var n=r.getNode(e.fromId),s=r.getNode(e.toId);n&&_(n.id),s&&_(s.id),delete a[e.id],i.removeSpring(t)}}function _(e){var t=o.get(e);if(t.mass=s(e),Number.isNaN(t.mass))throw new Error("Node mass should be a number")}function v(e){var t=o.get(e);return t||(g(e),t=o.get(e)),t}},Bi.exports.simulator=ss();var e=Ai();function t(){}return Bi.exports}();const as=Fn(os);function us(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)}var ls="object"==typeof globalThis&&globalThis&&globalThis.Object===Object&&globalThis,cs="object"==typeof self&&self&&self.Object===Object&&self,hs=ls||cs||Function("return this")(),ds=function(){return hs.Date.now()},ps=/\s/;var fs=/^\s+/;function gs(e){return e?e.slice(0,function(e){for(var t=e.length;t--&&ps.test(e.charAt(t)););return t}(e)+1).replace(fs,""):e}var ms=hs.Symbol,ys=Object.prototype,bs=ys.hasOwnProperty,_s=ys.toString,vs=ms?ms.toStringTag:void 0;var xs=Object.prototype.toString;var Ts=ms?ms.toStringTag:void 0;function ws(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":Ts&&Ts in Object(e)?function(e){var t=bs.call(e,vs),r=e[vs];try{e[vs]=void 0;var n=!0}catch(uR){}var i=_s.call(e);return n&&(t?e[vs]=r:delete e[vs]),i}(e):function(e){return xs.call(e)}(e)}var Ss=/^[-+]0x[0-9a-f]+$/i,Ns=/^0b[01]+$/i,Es=/^0o[0-7]+$/i,Cs=parseInt;function As(e){if("number"==typeof e)return e;if(function(e){return"symbol"==typeof e||function(e){return null!=e&&"object"==typeof e}(e)&&"[object Symbol]"==ws(e)}(e))return NaN;if(us(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=us(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=gs(e);var r=Ns.test(e);return r||Es.test(e)?Cs(e.slice(2),r?2:8):Ss.test(e)?NaN:+e}var Ms=Math.max,Rs=Math.min;function Ps(e,t,r){var n,i,s,o,a,u,l=0,c=!1,h=!1,d=!0;if("function"!=typeof e)throw new TypeError("Expected a function");function p(t){var r=n,s=i;return n=i=void 0,l=t,o=e.apply(s,r)}function f(e){var r=e-u;return void 0===u||r>=t||r<0||h&&e-l>=s}function g(){var e=ds();if(f(e))return m(e);a=setTimeout(g,function(e){var r=t-(e-u);return h?Rs(r,s-(e-l)):r}(e))}function m(e){return a=void 0,d&&n?p(e):(n=i=void 0,o)}function y(){var e=ds(),r=f(e);if(n=arguments,i=this,u=e,r){if(void 0===a)return function(e){return l=e,a=setTimeout(g,t),c?p(e):o}(u);if(h)return clearTimeout(a),a=setTimeout(g,t),p(u)}return void 0===a&&(a=setTimeout(g,t)),o}return t=As(t)||0,us(r)&&(c=!!r.leading,s=(h="maxWait"in r)?Ms(As(r.maxWait)||0,t):s,d="trailing"in r?!!r.trailing:d),y.cancel=function(){void 0!==a&&clearTimeout(a),l=0,n=u=i=a=void 0},y.flush=function(){return void 0===a?o:m(ds())},y}function Ds(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function Fs(e,t,r){return Object.defineProperty(e,"prototype",{writable:!1}),e}function Os(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,i,s,o,a=[],u=!0,l=!1;try{if(s=(r=r.call(e)).next,0===t);else for(;!(u=(n=s.call(r)).done)&&(a.push(n.value),a.length!==t);u=!0);}catch(e){l=!0,i=e}finally{try{if(!u&&null!=r.return&&(o=r.return(),Object(o)!==o))return}finally{if(l)throw i}}return a}}(e,t)||function(e,t){if(e){if("string"==typeof e)return Ds(e,t);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?Ds(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}var Ls=Fs((function e(t,r){var n=r.default,i=void 0===n?null:n,s=r.triggerUpdate,o=void 0===s||s,a=r.onChange,u=void 0===a?function(e,t){}:a;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.name=t,this.defaultVal=i,this.triggerUpdate=o,this.onChange=u}));function Bs(e){var t=e.stateInit,r=void 0===t?function(){return{}}:t,n=e.props,i=void 0===n?{}:n,s=e.methods,o=void 0===s?{}:s,a=e.aliases,u=void 0===a?{}:a,l=e.init,c=void 0===l?function(){}:l,h=e.update,d=void 0===h?function(){}:h,p=Object.keys(i).map((function(e){return new Ls(e,i[e])}));return function e(){for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];var s=!!(this instanceof e?this.constructor:void 0),a=s?n.shift():void 0,l=n[0],h=void 0===l?{}:l,f=Object.assign({},r instanceof Function?r(h):r,{initialised:!1}),g={};function m(e){return y(e,h),b(),m}var y=function(e,t){c.call(m,e,f,t),f.initialised=!0},b=Ps((function(){f.initialised&&(d.call(m,f,g),g={})}),1);return p.forEach((function(e){m[e.name]=function(e){var t=e.name,r=e.triggerUpdate,n=void 0!==r&&r,i=e.onChange,s=void 0===i?function(e,t){}:i,o=e.defaultVal,a=void 0===o?null:o;return function(e){var r=f[t];if(!arguments.length)return r;var i=void 0===e?a:e;return f[t]=i,s.call(m,i,f,r),!g.hasOwnProperty(t)&&(g[t]=r),n&&b(),m}}(e)})),Object.keys(o).forEach((function(e){m[e]=function(){for(var t,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(t=o[e]).call.apply(t,[m,f].concat(n))}})),Object.entries(u).forEach((function(e){var t=Os(e,2),r=t[0],n=t[1];return m[r]=m[n]})),m.resetProps=function(){return p.forEach((function(e){m[e.name](e.defaultVal)})),m},m.resetProps(),f._rerender=b,s&&a&&m(a),m}}var ks=function(e){return"function"==typeof e?e:"string"==typeof e?function(t){return t[e]}:function(t){return e}};function Is(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function Us(e,t,r){if("function"==typeof e?e===t:e.has(t))return arguments.length<3?t:r;throw new TypeError("Private element is not present on this object")}function Vs(e,t){return e.get(Us(e,t))}function js(e,t,r){(function(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")})(e,t),t.set(e,r)}function Gs(e,t,r){return e.set(Us(e,t),r),r}function zs(e,t,r){return t&&function(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,Ws(n.key),n)}}(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function $s(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,i,s,o,a=[],u=!0,l=!1;try{if(s=(r=r.call(e)).next,0===t);else for(;!(u=(n=s.call(r)).done)&&(a.push(n.value),a.length!==t);u=!0);}catch(e){l=!0,i=e}finally{try{if(!u&&null!=r.return&&(o=r.return(),Object(o)!==o))return}finally{if(l)throw i}}return a}}(e,t)||qs(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Hs(e){return function(e){if(Array.isArray(e))return Is(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||qs(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Ws(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t);if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e,"string");return"symbol"==typeof t?t:t+""}function qs(e,t){if(e){if("string"==typeof e)return Is(e,t);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?Is(e,t):void 0}}var Xs=new WeakMap,Ks=new WeakMap,Ys=new WeakMap,Qs=new WeakMap,Zs=new WeakMap,Js=new WeakMap,eo=function(){return zs((function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),js(this,Xs,new Map),js(this,Ks,new Map),js(this,Ys,(function(e){return e})),js(this,Qs,(function(){return{}})),js(this,Zs,(function(){})),js(this,Js,(function(){}))}),[{key:"getObj",value:function(e){return Vs(Xs,this).get(Vs(Ys,this).call(this,e))}},{key:"getData",value:function(e){return Vs(Ks,this).get(e)}},{key:"entries",value:function(){return Hs(Vs(Ks,this).entries()).map((function(e){var t=$s(e,2),r=t[0];return[t[1],r]}))}},{key:"id",value:function(e){return Gs(Ys,this,ks(e)),this}},{key:"onCreateObj",value:function(e){return Gs(Qs,this,e),this}},{key:"onUpdateObj",value:function(e){return Gs(Zs,this,e),this}},{key:"onRemoveObj",value:function(e){return Gs(Js,this,e),this}},{key:"digest",value:function(e){var t=this;e.filter((function(e){return!Vs(Xs,t).has(Vs(Ys,t).call(t,e))})).forEach((function(e){var r=Vs(Qs,t).call(t,e);Vs(Xs,t).set(Vs(Ys,t).call(t,e),r),Vs(Ks,t).set(r,e)}));var r=new Map(e.map((function(e){return[Vs(Ys,t).call(t,e),e]})));return Vs(Xs,this).forEach((function(e,n){r.has(n)?Vs(Zs,t).call(t,e,r.get(n)):(Vs(Js,t).call(t,e,n),Vs(Xs,t).delete(n),Vs(Ks,t).delete(e))})),this}},{key:"clear",value:function(){return this.digest([]),this}}])}();const to=function(e){for(var t=e.length/6|0,r=new Array(t),n=0;n<t;)r[n]="#"+e.slice(6*n,6*++n);return r}("a6cee31f78b4b2df8a33a02cfb9a99e31a1cfdbf6fff7f00cab2d66a3d9affff99b15928");function ro(e){return ro="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ro(e)}var no=/^\s+/,io=/\s+$/;function so(e,t){if(t=t||{},(e=e||"")instanceof so)return e;if(!(this instanceof so))return new so(e,t);var r=function(e){var t={r:0,g:0,b:0},r=1,n=null,i=null,s=null,o=!1,a=!1;"string"==typeof e&&(e=function(e){e=e.replace(no,"").replace(io,"").toLowerCase();var t,r=!1;if(wo[e])e=wo[e],r=!0;else if("transparent"==e)return{r:0,g:0,b:0,a:0,format:"name"};if(t=Bo.rgb.exec(e))return{r:t[1],g:t[2],b:t[3]};if(t=Bo.rgba.exec(e))return{r:t[1],g:t[2],b:t[3],a:t[4]};if(t=Bo.hsl.exec(e))return{h:t[1],s:t[2],l:t[3]};if(t=Bo.hsla.exec(e))return{h:t[1],s:t[2],l:t[3],a:t[4]};if(t=Bo.hsv.exec(e))return{h:t[1],s:t[2],v:t[3]};if(t=Bo.hsva.exec(e))return{h:t[1],s:t[2],v:t[3],a:t[4]};if(t=Bo.hex8.exec(e))return{r:Ao(t[1]),g:Ao(t[2]),b:Ao(t[3]),a:Do(t[4]),format:r?"name":"hex8"};if(t=Bo.hex6.exec(e))return{r:Ao(t[1]),g:Ao(t[2]),b:Ao(t[3]),format:r?"name":"hex"};if(t=Bo.hex4.exec(e))return{r:Ao(t[1]+""+t[1]),g:Ao(t[2]+""+t[2]),b:Ao(t[3]+""+t[3]),a:Do(t[4]+""+t[4]),format:r?"name":"hex8"};if(t=Bo.hex3.exec(e))return{r:Ao(t[1]+""+t[1]),g:Ao(t[2]+""+t[2]),b:Ao(t[3]+""+t[3]),format:r?"name":"hex"};return!1}(e));"object"==ro(e)&&(ko(e.r)&&ko(e.g)&&ko(e.b)?(t=function(e,t,r){return{r:255*Eo(e,255),g:255*Eo(t,255),b:255*Eo(r,255)}}(e.r,e.g,e.b),o=!0,a="%"===String(e.r).substr(-1)?"prgb":"rgb"):ko(e.h)&&ko(e.s)&&ko(e.v)?(n=Ro(e.s),i=Ro(e.v),t=function(e,t,r){e=6*Eo(e,360),t=Eo(t,100),r=Eo(r,100);var n=Math.floor(e),i=e-n,s=r*(1-t),o=r*(1-i*t),a=r*(1-(1-i)*t),u=n%6,l=[r,o,s,s,a,r][u],c=[a,r,r,o,s,s][u],h=[s,s,a,r,r,o][u];return{r:255*l,g:255*c,b:255*h}}(e.h,n,i),o=!0,a="hsv"):ko(e.h)&&ko(e.s)&&ko(e.l)&&(n=Ro(e.s),s=Ro(e.l),t=function(e,t,r){var n,i,s;function o(e,t,r){return r<0&&(r+=1),r>1&&(r-=1),r<1/6?e+6*(t-e)*r:r<.5?t:r<2/3?e+(t-e)*(2/3-r)*6:e}if(e=Eo(e,360),t=Eo(t,100),r=Eo(r,100),0===t)n=i=s=r;else{var a=r<.5?r*(1+t):r+t-r*t,u=2*r-a;n=o(u,a,e+1/3),i=o(u,a,e),s=o(u,a,e-1/3)}return{r:255*n,g:255*i,b:255*s}}(e.h,n,s),o=!0,a="hsl"),e.hasOwnProperty("a")&&(r=e.a));return r=No(r),{ok:o,format:e.format||a,r:Math.min(255,Math.max(t.r,0)),g:Math.min(255,Math.max(t.g,0)),b:Math.min(255,Math.max(t.b,0)),a:r}}(e);this._originalInput=e,this._r=r.r,this._g=r.g,this._b=r.b,this._a=r.a,this._roundA=Math.round(100*this._a)/100,this._format=t.format||r.format,this._gradientType=t.gradientType,this._r<1&&(this._r=Math.round(this._r)),this._g<1&&(this._g=Math.round(this._g)),this._b<1&&(this._b=Math.round(this._b)),this._ok=r.ok}function oo(e,t,r){e=Eo(e,255),t=Eo(t,255),r=Eo(r,255);var n,i,s=Math.max(e,t,r),o=Math.min(e,t,r),a=(s+o)/2;if(s==o)n=i=0;else{var u=s-o;switch(i=a>.5?u/(2-s-o):u/(s+o),s){case e:n=(t-r)/u+(t<r?6:0);break;case t:n=(r-e)/u+2;break;case r:n=(e-t)/u+4}n/=6}return{h:n,s:i,l:a}}function ao(e,t,r){e=Eo(e,255),t=Eo(t,255),r=Eo(r,255);var n,i,s=Math.max(e,t,r),o=Math.min(e,t,r),a=s,u=s-o;if(i=0===s?0:u/s,s==o)n=0;else{switch(s){case e:n=(t-r)/u+(t<r?6:0);break;case t:n=(r-e)/u+2;break;case r:n=(e-t)/u+4}n/=6}return{h:n,s:i,v:a}}function uo(e,t,r,n){var i=[Mo(Math.round(e).toString(16)),Mo(Math.round(t).toString(16)),Mo(Math.round(r).toString(16))];return n&&i[0].charAt(0)==i[0].charAt(1)&&i[1].charAt(0)==i[1].charAt(1)&&i[2].charAt(0)==i[2].charAt(1)?i[0].charAt(0)+i[1].charAt(0)+i[2].charAt(0):i.join("")}function lo(e,t,r,n){return[Mo(Po(n)),Mo(Math.round(e).toString(16)),Mo(Math.round(t).toString(16)),Mo(Math.round(r).toString(16))].join("")}function co(e,t){t=0===t?0:t||10;var r=so(e).toHsl();return r.s-=t/100,r.s=Co(r.s),so(r)}function ho(e,t){t=0===t?0:t||10;var r=so(e).toHsl();return r.s+=t/100,r.s=Co(r.s),so(r)}function po(e){return so(e).desaturate(100)}function fo(e,t){t=0===t?0:t||10;var r=so(e).toHsl();return r.l+=t/100,r.l=Co(r.l),so(r)}function go(e,t){t=0===t?0:t||10;var r=so(e).toRgb();return r.r=Math.max(0,Math.min(255,r.r-Math.round(-t/100*255))),r.g=Math.max(0,Math.min(255,r.g-Math.round(-t/100*255))),r.b=Math.max(0,Math.min(255,r.b-Math.round(-t/100*255))),so(r)}function mo(e,t){t=0===t?0:t||10;var r=so(e).toHsl();return r.l-=t/100,r.l=Co(r.l),so(r)}function yo(e,t){var r=so(e).toHsl(),n=(r.h+t)%360;return r.h=n<0?360+n:n,so(r)}function bo(e){var t=so(e).toHsl();return t.h=(t.h+180)%360,so(t)}function _o(e,t){if(isNaN(t)||t<=0)throw new Error("Argument to polyad must be a positive number");for(var r=so(e).toHsl(),n=[so(e)],i=360/t,s=1;s<t;s++)n.push(so({h:(r.h+s*i)%360,s:r.s,l:r.l}));return n}function vo(e){var t=so(e).toHsl(),r=t.h;return[so(e),so({h:(r+72)%360,s:t.s,l:t.l}),so({h:(r+216)%360,s:t.s,l:t.l})]}function xo(e,t,r){t=t||6,r=r||30;var n=so(e).toHsl(),i=360/r,s=[so(e)];for(n.h=(n.h-(i*t>>1)+720)%360;--t;)n.h=(n.h+i)%360,s.push(so(n));return s}function To(e,t){t=t||6;for(var r=so(e).toHsv(),n=r.h,i=r.s,s=r.v,o=[],a=1/t;t--;)o.push(so({h:n,s:i,v:s})),s=(s+a)%1;return o}so.prototype={isDark:function(){return this.getBrightness()<128},isLight:function(){return!this.isDark()},isValid:function(){return this._ok},getOriginalInput:function(){return this._originalInput},getFormat:function(){return this._format},getAlpha:function(){return this._a},getBrightness:function(){var e=this.toRgb();return(299*e.r+587*e.g+114*e.b)/1e3},getLuminance:function(){var e,t,r,n=this.toRgb();return e=n.r/255,t=n.g/255,r=n.b/255,.2126*(e<=.03928?e/12.92:Math.pow((e+.055)/1.055,2.4))+.7152*(t<=.03928?t/12.92:Math.pow((t+.055)/1.055,2.4))+.0722*(r<=.03928?r/12.92:Math.pow((r+.055)/1.055,2.4))},setAlpha:function(e){return this._a=No(e),this._roundA=Math.round(100*this._a)/100,this},toHsv:function(){var e=ao(this._r,this._g,this._b);return{h:360*e.h,s:e.s,v:e.v,a:this._a}},toHsvString:function(){var e=ao(this._r,this._g,this._b),t=Math.round(360*e.h),r=Math.round(100*e.s),n=Math.round(100*e.v);return 1==this._a?"hsv("+t+", "+r+"%, "+n+"%)":"hsva("+t+", "+r+"%, "+n+"%, "+this._roundA+")"},toHsl:function(){var e=oo(this._r,this._g,this._b);return{h:360*e.h,s:e.s,l:e.l,a:this._a}},toHslString:function(){var e=oo(this._r,this._g,this._b),t=Math.round(360*e.h),r=Math.round(100*e.s),n=Math.round(100*e.l);return 1==this._a?"hsl("+t+", "+r+"%, "+n+"%)":"hsla("+t+", "+r+"%, "+n+"%, "+this._roundA+")"},toHex:function(e){return uo(this._r,this._g,this._b,e)},toHexString:function(e){return"#"+this.toHex(e)},toHex8:function(e){return function(e,t,r,n,i){var s=[Mo(Math.round(e).toString(16)),Mo(Math.round(t).toString(16)),Mo(Math.round(r).toString(16)),Mo(Po(n))];if(i&&s[0].charAt(0)==s[0].charAt(1)&&s[1].charAt(0)==s[1].charAt(1)&&s[2].charAt(0)==s[2].charAt(1)&&s[3].charAt(0)==s[3].charAt(1))return s[0].charAt(0)+s[1].charAt(0)+s[2].charAt(0)+s[3].charAt(0);return s.join("")}(this._r,this._g,this._b,this._a,e)},toHex8String:function(e){return"#"+this.toHex8(e)},toRgb:function(){return{r:Math.round(this._r),g:Math.round(this._g),b:Math.round(this._b),a:this._a}},toRgbString:function(){return 1==this._a?"rgb("+Math.round(this._r)+", "+Math.round(this._g)+", "+Math.round(this._b)+")":"rgba("+Math.round(this._r)+", "+Math.round(this._g)+", "+Math.round(this._b)+", "+this._roundA+")"},toPercentageRgb:function(){return{r:Math.round(100*Eo(this._r,255))+"%",g:Math.round(100*Eo(this._g,255))+"%",b:Math.round(100*Eo(this._b,255))+"%",a:this._a}},toPercentageRgbString:function(){return 1==this._a?"rgb("+Math.round(100*Eo(this._r,255))+"%, "+Math.round(100*Eo(this._g,255))+"%, "+Math.round(100*Eo(this._b,255))+"%)":"rgba("+Math.round(100*Eo(this._r,255))+"%, "+Math.round(100*Eo(this._g,255))+"%, "+Math.round(100*Eo(this._b,255))+"%, "+this._roundA+")"},toName:function(){return 0===this._a?"transparent":!(this._a<1)&&(So[uo(this._r,this._g,this._b,!0)]||!1)},toFilter:function(e){var t="#"+lo(this._r,this._g,this._b,this._a),r=t,n=this._gradientType?"GradientType = 1, ":"";if(e){var i=so(e);r="#"+lo(i._r,i._g,i._b,i._a)}return"progid:DXImageTransform.Microsoft.gradient("+n+"startColorstr="+t+",endColorstr="+r+")"},toString:function(e){var t=!!e;e=e||this._format;var r=!1,n=this._a<1&&this._a>=0;return t||!n||"hex"!==e&&"hex6"!==e&&"hex3"!==e&&"hex4"!==e&&"hex8"!==e&&"name"!==e?("rgb"===e&&(r=this.toRgbString()),"prgb"===e&&(r=this.toPercentageRgbString()),"hex"!==e&&"hex6"!==e||(r=this.toHexString()),"hex3"===e&&(r=this.toHexString(!0)),"hex4"===e&&(r=this.toHex8String(!0)),"hex8"===e&&(r=this.toHex8String()),"name"===e&&(r=this.toName()),"hsl"===e&&(r=this.toHslString()),"hsv"===e&&(r=this.toHsvString()),r||this.toHexString()):"name"===e&&0===this._a?this.toName():this.toRgbString()},clone:function(){return so(this.toString())},_applyModification:function(e,t){var r=e.apply(null,[this].concat([].slice.call(t)));return this._r=r._r,this._g=r._g,this._b=r._b,this.setAlpha(r._a),this},lighten:function(){return this._applyModification(fo,arguments)},brighten:function(){return this._applyModification(go,arguments)},darken:function(){return this._applyModification(mo,arguments)},desaturate:function(){return this._applyModification(co,arguments)},saturate:function(){return this._applyModification(ho,arguments)},greyscale:function(){return this._applyModification(po,arguments)},spin:function(){return this._applyModification(yo,arguments)},_applyCombination:function(e,t){return e.apply(null,[this].concat([].slice.call(t)))},analogous:function(){return this._applyCombination(xo,arguments)},complement:function(){return this._applyCombination(bo,arguments)},monochromatic:function(){return this._applyCombination(To,arguments)},splitcomplement:function(){return this._applyCombination(vo,arguments)},triad:function(){return this._applyCombination(_o,[3])},tetrad:function(){return this._applyCombination(_o,[4])}},so.fromRatio=function(e,t){if("object"==ro(e)){var r={};for(var n in e)e.hasOwnProperty(n)&&(r[n]="a"===n?e[n]:Ro(e[n]));e=r}return so(e,t)},so.equals=function(e,t){return!(!e||!t)&&so(e).toRgbString()==so(t).toRgbString()},so.random=function(){return so.fromRatio({r:Math.random(),g:Math.random(),b:Math.random()})},so.mix=function(e,t,r){r=0===r?0:r||50;var n=so(e).toRgb(),i=so(t).toRgb(),s=r/100;return so({r:(i.r-n.r)*s+n.r,g:(i.g-n.g)*s+n.g,b:(i.b-n.b)*s+n.b,a:(i.a-n.a)*s+n.a})},so.readability=function(e,t){var r=so(e),n=so(t);return(Math.max(r.getLuminance(),n.getLuminance())+.05)/(Math.min(r.getLuminance(),n.getLuminance())+.05)},so.isReadable=function(e,t,r){var n,i,s=so.readability(e,t);switch(i=!1,(n=function(e){var t,r;t=((e=e||{level:"AA",size:"small"}).level||"AA").toUpperCase(),r=(e.size||"small").toLowerCase(),"AA"!==t&&"AAA"!==t&&(t="AA");"small"!==r&&"large"!==r&&(r="small");return{level:t,size:r}}(r)).level+n.size){case"AAsmall":case"AAAlarge":i=s>=4.5;break;case"AAlarge":i=s>=3;break;case"AAAsmall":i=s>=7}return i},so.mostReadable=function(e,t,r){var n,i,s,o,a=null,u=0;i=(r=r||{}).includeFallbackColors,s=r.level,o=r.size;for(var l=0;l<t.length;l++)(n=so.readability(e,t[l]))>u&&(u=n,a=so(t[l]));return so.isReadable(e,a,{level:s,size:o})||!i?a:(r.includeFallbackColors=!1,so.mostReadable(e,["#fff","#000"],r))};var wo=so.names={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"0ff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000",blanchedalmond:"ffebcd",blue:"00f",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",burntsienna:"ea7e5d",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"0ff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkgrey:"a9a9a9",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkslategrey:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dimgrey:"696969",dodgerblue:"1e90ff",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"f0f",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",grey:"808080",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgray:"d3d3d3",lightgreen:"90ee90",lightgrey:"d3d3d3",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslategray:"789",lightslategrey:"789",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"0f0",limegreen:"32cd32",linen:"faf0e6",magenta:"f0f",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370db",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"db7093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",rebeccapurple:"663399",red:"f00",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",slategrey:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",wheat:"f5deb3",white:"fff",whitesmoke:"f5f5f5",yellow:"ff0",yellowgreen:"9acd32"},So=so.hexNames=function(e){var t={};for(var r in e)e.hasOwnProperty(r)&&(t[e[r]]=r);return t}(wo);function No(e){return e=parseFloat(e),(isNaN(e)||e<0||e>1)&&(e=1),e}function Eo(e,t){(function(e){return"string"==typeof e&&-1!=e.indexOf(".")&&1===parseFloat(e)})(e)&&(e="100%");var r=function(e){return"string"==typeof e&&-1!=e.indexOf("%")}(e);return e=Math.min(t,Math.max(0,parseFloat(e))),r&&(e=parseInt(e*t,10)/100),Math.abs(e-t)<1e-6?1:e%t/parseFloat(t)}function Co(e){return Math.min(1,Math.max(0,e))}function Ao(e){return parseInt(e,16)}function Mo(e){return 1==e.length?"0"+e:""+e}function Ro(e){return e<=1&&(e=100*e+"%"),e}function Po(e){return Math.round(255*parseFloat(e)).toString(16)}function Do(e){return Ao(e)/255}var Fo,Oo,Lo,Bo=(Oo="[\\s|\\(]+("+(Fo="(?:[-\\+]?\\d*\\.\\d+%?)|(?:[-\\+]?\\d+%?)")+")[,|\\s]+("+Fo+")[,|\\s]+("+Fo+")\\s*\\)?",Lo="[\\s|\\(]+("+Fo+")[,|\\s]+("+Fo+")[,|\\s]+("+Fo+")[,|\\s]+("+Fo+")\\s*\\)?",{CSS_UNIT:new RegExp(Fo),rgb:new RegExp("rgb"+Oo),rgba:new RegExp("rgba"+Lo),hsl:new RegExp("hsl"+Oo),hsla:new RegExp("hsla"+Lo),hsv:new RegExp("hsv"+Oo),hsva:new RegExp("hsva"+Lo),hex3:/^#?([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})$/,hex6:/^#?([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})$/,hex4:/^#?([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})$/,hex8:/^#?([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})$/});function ko(e){return!!Bo.CSS_UNIT.exec(e)}function Io(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function Uo(e,t,r){if("function"==typeof e?e===t:e.has(t))return arguments.length<3?t:r;throw new TypeError("Private element is not present on this object")}function Vo(e,t,r){return t=Ko(t),function(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}(e,Qo()?Reflect.construct(t,r||[],Ko(e).constructor):t.apply(e,r))}function jo(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Go(e,t){return e.get(Uo(e,t))}function zo(e,t,r){(function(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")})(e,t),t.set(e,r)}function $o(e,t,r){return e.set(Uo(e,t),r),r}function Ho(e,t,r){if(Qo())return Reflect.construct.apply(null,arguments);var n=[null];return n.push.apply(n,t),new(e.bind.apply(e,n))}function Wo(e,t,r){return t&&function(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,na(n.key),n)}}(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function qo(e,t,r){return(t=na(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function Xo(){return Xo="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=function(e,t){for(;!{}.hasOwnProperty.call(e,t)&&null!==(e=Ko(e)););return e}(e,t);if(n){var i=Object.getOwnPropertyDescriptor(n,t);return i.get?i.get.call(arguments.length<3?e:r):i.value}},Xo.apply(null,arguments)}function Ko(e){return(Ko=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Yo(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&Jo(e,t)}function Qo(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(t){}return(Qo=function(){return!!e})()}function Zo(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function Jo(e,t){return(Jo=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function ea(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,i,s,o,a=[],u=!0,l=!1;try{if(s=(r=r.call(e)).next,0===t);else for(;!(u=(n=s.call(r)).done)&&(a.push(n.value),a.length!==t);u=!0);}catch(c){l=!0,i=c}finally{try{if(!u&&null!=r.return&&(o=r.return(),Object(o)!==o))return}finally{if(l)throw i}}return a}}(e,t)||sa(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ta(e,t,r,n){var i=Xo(Ko(e.prototype),t,r);return"function"==typeof i?function(e){return i.apply(r,e)}:i}function ra(e){return function(e){if(Array.isArray(e))return Io(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||sa(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function na(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t);if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}function ia(e){return(ia="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function sa(e,t){if(e){if("string"==typeof e)return Io(e,t);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?Io(e,t):void 0}}var oa=function(e){e instanceof Array?e.forEach(oa):(e.map&&e.map.dispose(),e.dispose())},aa=function(e){e.geometry&&e.geometry.dispose(),e.material&&oa(e.material),e.texture&&e.texture.dispose(),e.children&&e.children.forEach(aa)},ua=function(e){for(;e.children.length;){var t=e.children[0];e.remove(t),aa(t)}},la=new WeakMap,ca=new WeakMap,ha=function(){function e(t){var r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=n.dataBindAttr,s=void 0===i?"__data":i,o=n.objBindAttr,a=void 0===o?"__threeObj":o;return jo(this,e),qo(r=Vo(this,e),"scene",void 0),zo(r,la,void 0),zo(r,ca,void 0),r.scene=t,$o(la,r,s),$o(ca,r,a),r.onRemoveObj((function(){})),r}return Yo(e,eo),Wo(e,[{key:"onCreateObj",value:function(t){var r=this;return ta(e,"onCreateObj",this)([function(e){var n=t(e);return e[Go(ca,r)]=n,n[Go(la,r)]=e,r.scene.add(n),n}]),this}},{key:"onRemoveObj",value:function(t){var r=this;return ta(e,"onRemoveObj",this)([function(n,i){var s=ta(e,"getData",r)([n]);t(n,i),r.scene.remove(n),ua(n),delete s[Go(ca,r)]}]),this}}])}(),da=function(e){return isNaN(e)?parseInt(so(e).toHex(),16):e},pa=function(e){return isNaN(e)?so(e).getAlpha():1},fa=jn(to);function ga(e,t,r){t&&"string"==typeof r&&e.filter((function(e){return!e[r]})).forEach((function(e){e[r]=fa(t(e))}))}var ma=window.THREE?window.THREE:{Group:u,Mesh:l,MeshLambertMaterial:d,Color:h,BufferGeometry:p,BufferAttribute:f,Matrix4:a,Vector3:o,SphereGeometry:c,CylinderGeometry:m,TubeGeometry:T,ConeGeometry:x,Line:g,LineBasicMaterial:v,QuadraticBezierCurve3:_,CubicBezierCurve3:b,Box3:y},ya={graph:Ri,forcelayout:as},ba=(new ma.BufferGeometry).setAttribute?"setAttribute":"addAttribute",_a=(new ma.BufferGeometry).applyMatrix4?"applyMatrix4":"applyMatrix",va=Bs({props:{jsonUrl:{onChange:function(e,t){var r=this;e&&!t.fetchingJson&&(t.fetchingJson=!0,t.onLoading(),fetch(e).then((function(e){return e.json()})).then((function(e){t.fetchingJson=!1,t.onFinishLoading(e),r.graphData(e)})))},triggerUpdate:!1},graphData:{default:{nodes:[],links:[]},onChange:function(e,t){t.engineRunning=!1}},numDimensions:{default:3,onChange:function(e,t){var r=t.d3ForceLayout.force("charge");function n(e,t){e.forEach((function(e){delete e[t],delete e["v".concat(t)]}))}r&&r.strength(e>2?-60:-30),e<3&&n(t.graphData.nodes,"z"),e<2&&n(t.graphData.nodes,"y")}},dagMode:{onChange:function(e,t){!e&&"d3"===t.forceEngine&&(t.graphData.nodes||[]).forEach((function(e){return e.fx=e.fy=e.fz=void 0}))}},dagLevelDistance:{},dagNodeFilter:{default:function(e){return!0}},onDagError:{triggerUpdate:!1},nodeRelSize:{default:4},nodeId:{default:"id"},nodeVal:{default:"val"},nodeResolution:{default:8},nodeColor:{default:"color"},nodeAutoColorBy:{},nodeOpacity:{default:.75},nodeVisibility:{default:!0},nodeThreeObject:{},nodeThreeObjectExtend:{default:!1},nodePositionUpdate:{triggerUpdate:!1},linkSource:{default:"source"},linkTarget:{default:"target"},linkVisibility:{default:!0},linkColor:{default:"color"},linkAutoColorBy:{},linkOpacity:{default:.2},linkWidth:{},linkResolution:{default:6},linkCurvature:{default:0,triggerUpdate:!1},linkCurveRotation:{default:0,triggerUpdate:!1},linkMaterial:{},linkThreeObject:{},linkThreeObjectExtend:{default:!1},linkPositionUpdate:{triggerUpdate:!1},linkDirectionalArrowLength:{default:0},linkDirectionalArrowColor:{},linkDirectionalArrowRelPos:{default:.5,triggerUpdate:!1},linkDirectionalArrowResolution:{default:8},linkDirectionalParticles:{default:0},linkDirectionalParticleSpeed:{default:.01,triggerUpdate:!1},linkDirectionalParticleWidth:{default:.5},linkDirectionalParticleColor:{},linkDirectionalParticleResolution:{default:4},forceEngine:{default:"d3"},d3AlphaMin:{default:0},d3AlphaDecay:{default:.0228,triggerUpdate:!1,onChange:function(e,t){t.d3ForceLayout.alphaDecay(e)}},d3AlphaTarget:{default:0,triggerUpdate:!1,onChange:function(e,t){t.d3ForceLayout.alphaTarget(e)}},d3VelocityDecay:{default:.4,triggerUpdate:!1,onChange:function(e,t){t.d3ForceLayout.velocityDecay(e)}},ngraphPhysics:{default:{timeStep:20,gravity:-1.2,theta:.8,springLength:30,springCoefficient:8e-4,dragCoefficient:.02}},warmupTicks:{default:0,triggerUpdate:!1},cooldownTicks:{default:1/0,triggerUpdate:!1},cooldownTime:{default:15e3,triggerUpdate:!1},onLoading:{default:function(){},triggerUpdate:!1},onFinishLoading:{default:function(){},triggerUpdate:!1},onUpdate:{default:function(){},triggerUpdate:!1},onFinishUpdate:{default:function(){},triggerUpdate:!1},onEngineTick:{default:function(){},triggerUpdate:!1},onEngineStop:{default:function(){},triggerUpdate:!1}},methods:{refresh:function(e){return e._flushObjects=!0,e._rerender(),this},d3Force:function(e,t,r){return void 0===r?e.d3ForceLayout.force(t):(e.d3ForceLayout.force(t,r),this)},d3ReheatSimulation:function(e){return e.d3ForceLayout.alpha(1),this.resetCountdown(),this},resetCountdown:function(e){return e.cntTicks=0,e.startTickTime=new Date,e.engineRunning=!0,this},tickFrame:function(e){var t,r,n,i,s="ngraph"!==e.forceEngine;return e.engineRunning&&function(){++e.cntTicks>e.cooldownTicks||new Date-e.startTickTime>e.cooldownTime||s&&e.d3AlphaMin>0&&e.d3ForceLayout.alpha()<e.d3AlphaMin?(e.engineRunning=!1,e.onEngineStop()):(e.layout[s?"tick":"step"](),e.onEngineTick());var t=ks(e.nodeThreeObjectExtend);e.nodeDataMapper.entries().forEach((function(r){var n=ea(r,2),i=n[0],o=n[1];if(o){var a=s?i:e.layout.getNodePosition(i[e.nodeId]),u=t(i);e.nodePositionUpdate&&e.nodePositionUpdate(u?o.children[0]:o,{x:a.x,y:a.y,z:a.z},i)&&!u||(o.position.x=a.x,o.position.y=a.y||0,o.position.z=a.z||0)}}));var r=ks(e.linkWidth),n=ks(e.linkCurvature),i=ks(e.linkCurveRotation),o=ks(e.linkThreeObjectExtend);function a(t){var r=s?t:e.layout.getLinkPosition(e.layout.graph.getLink(t.source,t.target).id),o=r[s?"source":"from"],a=r[s?"target":"to"];if(o&&a&&o.hasOwnProperty("x")&&a.hasOwnProperty("x")){var u=n(t);if(u){var l,c=new ma.Vector3(o.x,o.y||0,o.z||0),h=new ma.Vector3(a.x,a.y||0,a.z||0),d=c.distanceTo(h),p=i(t);if(d>0){var f=a.x-o.x,g=a.y-o.y||0,m=(new ma.Vector3).subVectors(h,c),y=m.clone().multiplyScalar(u).cross(0!==f||0!==g?new ma.Vector3(0,0,1):new ma.Vector3(0,1,0)).applyAxisAngle(m.normalize(),p).add((new ma.Vector3).addVectors(c,h).divideScalar(2));l=new ma.QuadraticBezierCurve3(c,y,h)}else{var b=70*u,_=-p,v=_+Math.PI/2;l=new ma.CubicBezierCurve3(c,new ma.Vector3(b*Math.cos(v),b*Math.sin(v),0).add(c),new ma.Vector3(b*Math.cos(_),b*Math.sin(_),0).add(c),h)}t.__curve=l}else t.__curve=null}}e.linkDataMapper.entries().forEach((function(t){var n=ea(t,2),i=n[0],u=n[1];if(u){var l=s?i:e.layout.getLinkPosition(e.layout.graph.getLink(i.source,i.target).id),c=l[s?"source":"from"],h=l[s?"target":"to"];if(c&&h&&c.hasOwnProperty("x")&&h.hasOwnProperty("x")){a(i);var d=o(i);if(!e.linkPositionUpdate||!e.linkPositionUpdate(d?u.children[1]:u,{start:{x:c.x,y:c.y,z:c.z},end:{x:h.x,y:h.y,z:h.z}},i)||d){var p=30,f=i.__curve,g=u.children.length?u.children[0]:u;if("Line"===g.type){if(f){var m=f.getPoints(p);g.geometry.getAttribute("position").array.length!==3*m.length&&g.geometry[ba]("position",new ma.BufferAttribute(new Float32Array(3*m.length),3)),g.geometry.setFromPoints(m)}else{var y=g.geometry.getAttribute("position");y&&y.array&&6===y.array.length||g.geometry[ba]("position",y=new ma.BufferAttribute(new Float32Array(6),3)),y.array[0]=c.x,y.array[1]=c.y||0,y.array[2]=c.z||0,y.array[3]=h.x,y.array[4]=h.y||0,y.array[5]=h.z||0,y.needsUpdate=!0}g.geometry.computeBoundingSphere()}else if("Mesh"===g.type)if(f){g.geometry.type.match(/^Tube(Buffer)?Geometry$/)||(g.position.set(0,0,0),g.rotation.set(0,0,0),g.scale.set(1,1,1));var b=Math.ceil(10*r(i))/10/2,_=new ma.TubeGeometry(f,p,b,e.linkResolution,!1);g.geometry.dispose(),g.geometry=_}else{if(!g.geometry.type.match(/^Cylinder(Buffer)?Geometry$/)){var v=Math.ceil(10*r(i))/10/2,x=new ma.CylinderGeometry(v,v,1,e.linkResolution,1,!1);x[_a]((new ma.Matrix4).makeTranslation(0,.5,0)),x[_a]((new ma.Matrix4).makeRotationX(Math.PI/2)),g.geometry.dispose(),g.geometry=x}var T=new ma.Vector3(c.x,c.y||0,c.z||0),w=new ma.Vector3(h.x,h.y||0,h.z||0),S=T.distanceTo(w);g.position.x=T.x,g.position.y=T.y,g.position.z=T.z,g.scale.z=S,g.parent.localToWorld(w),g.lookAt(w)}}}}}))}(),t=ks(e.linkDirectionalArrowRelPos),r=ks(e.linkDirectionalArrowLength),n=ks(e.nodeVal),e.arrowDataMapper.entries().forEach((function(i){var o=ea(i,2),a=o[0],u=o[1];if(u){var l=s?a:e.layout.getLinkPosition(e.layout.graph.getLink(a.source,a.target).id),c=l[s?"source":"from"],h=l[s?"target":"to"];if(c&&h&&c.hasOwnProperty("x")&&h.hasOwnProperty("x")){var d=Math.cbrt(Math.max(0,n(c)||1))*e.nodeRelSize,p=Math.cbrt(Math.max(0,n(h)||1))*e.nodeRelSize,f=r(a),g=t(a),m=a.__curve?function(e){return a.__curve.getPoint(e)}:function(e){var t=function(e,t,r,n){return t[e]+(r[e]-t[e])*n||0};return{x:t("x",c,h,e),y:t("y",c,h,e),z:t("z",c,h,e)}},y=a.__curve?a.__curve.getLength():Math.sqrt(["x","y","z"].map((function(e){return Math.pow((h[e]||0)-(c[e]||0),2)})).reduce((function(e,t){return e+t}),0)),b=d+f+(y-d-p-f)*g,_=m(b/y),v=m((b-f)/y);["x","y","z"].forEach((function(e){return u.position[e]=v[e]}));var x=Ho(ma.Vector3,ra(["x","y","z"].map((function(e){return _[e]}))));u.parent.localToWorld(x),u.lookAt(x)}}})),i=ks(e.linkDirectionalParticleSpeed),e.graphData.links.forEach((function(t){var r=e.particlesDataMapper.getObj(t),n=r&&r.children,o=t.__singleHopPhotonsObj&&t.__singleHopPhotonsObj.children;if(o&&o.length||n&&n.length){var a=s?t:e.layout.getLinkPosition(e.layout.graph.getLink(t.source,t.target).id),u=a[s?"source":"from"],l=a[s?"target":"to"];if(u&&l&&u.hasOwnProperty("x")&&l.hasOwnProperty("x")){var c=i(t),h=t.__curve?function(e){return t.__curve.getPoint(e)}:function(e){var t=function(e,t,r,n){return t[e]+(r[e]-t[e])*n||0};return{x:t("x",u,l,e),y:t("y",u,l,e),z:t("z",u,l,e)}};[].concat(ra(n||[]),ra(o||[])).forEach((function(e,t){var r="singleHopPhotons"===e.parent.__linkThreeObjType;if(e.hasOwnProperty("__progressRatio")||(e.__progressRatio=r?0:t/n.length),e.__progressRatio+=c,e.__progressRatio>=1){if(r)return e.parent.remove(e),void ua(e);e.__progressRatio=e.__progressRatio%1}var i=e.__progressRatio,s=h(i);["x","y","z"].forEach((function(t){return e.position[t]=s[t]}))}))}}})),this},emitParticle:function(e,t){if(t&&e.graphData.links.includes(t)){if(!t.__singleHopPhotonsObj){var r=new ma.Group;r.__linkThreeObjType="singleHopPhotons",t.__singleHopPhotonsObj=r,e.graphScene.add(r)}var n=ks(e.linkDirectionalParticleWidth),i=Math.ceil(10*n(t))/10/2,s=e.linkDirectionalParticleResolution,o=new ma.SphereGeometry(i,s,s),a=ks(e.linkColor),u=ks(e.linkDirectionalParticleColor)(t)||a(t)||"#f0f0f0",l=new ma.Color(da(u)),c=3*e.linkOpacity,h=new ma.MeshLambertMaterial({color:l,transparent:!0,opacity:c});t.__singleHopPhotonsObj.add(new ma.Mesh(o,h))}return this},getGraphBbox:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){return!0};if(!e.initialised)return null;var r=function e(r){var n=[];if(r.geometry){r.geometry.computeBoundingBox();var i=new ma.Box3;i.copy(r.geometry.boundingBox).applyMatrix4(r.matrixWorld),n.push(i)}return n.concat.apply(n,ra((r.children||[]).filter((function(e){return!e.hasOwnProperty("__graphObjType")||"node"===e.__graphObjType&&t(e.__data)})).map(e)))}(e.graphScene);return r.length?Object.assign.apply(Object,ra(["x","y","z"].map((function(e){return qo({},e,[Un(r,(function(t){return t.min[e]})),Vn(r,(function(t){return t.max[e]}))])})))):null}},stateInit:function(){return{d3ForceLayout:Ln().force("link",Bn()).force("charge",kn()).force("center",In()).force("dagRadial",null).stop(),engineRunning:!1}},init:function(e,t){t.graphScene=e,t.nodeDataMapper=new ha(e,{objBindAttr:"__threeObj"}),t.linkDataMapper=new ha(e,{objBindAttr:"__lineObj"}),t.arrowDataMapper=new ha(e,{objBindAttr:"__arrowObj"}),t.particlesDataMapper=new ha(e,{objBindAttr:"__photonsObj"})},update:function(e,t){var r=function(e){return e.some((function(e){return t.hasOwnProperty(e)}))};if(e.engineRunning=!1,"function"==typeof e.onUpdate&&e.onUpdate(),null!==e.nodeAutoColorBy&&r(["nodeAutoColorBy","graphData","nodeColor"])&&ga(e.graphData.nodes,ks(e.nodeAutoColorBy),e.nodeColor),null!==e.linkAutoColorBy&&r(["linkAutoColorBy","graphData","linkColor"])&&ga(e.graphData.links,ks(e.linkAutoColorBy),e.linkColor),e._flushObjects||r(["graphData","nodeThreeObject","nodeThreeObjectExtend","nodeVal","nodeColor","nodeVisibility","nodeRelSize","nodeResolution","nodeOpacity"])){var n=ks(e.nodeThreeObject),i=ks(e.nodeThreeObjectExtend),s=ks(e.nodeVal),o=ks(e.nodeColor),a=ks(e.nodeVisibility),u={},l={};(e._flushObjects||r(["nodeThreeObject","nodeThreeObjectExtend"]))&&e.nodeDataMapper.clear(),e.nodeDataMapper.onCreateObj((function(t){var r,s=n(t),o=i(t);return s&&e.nodeThreeObject===s&&(s=s.clone()),s&&!o?r=s:((r=new ma.Mesh).__graphDefaultObj=!0,s&&o&&r.add(s)),r.__graphObjType="node",r})).onUpdateObj((function(t,r){if(t.__graphDefaultObj){var n=s(r)||1,i=Math.cbrt(n)*e.nodeRelSize,a=e.nodeResolution;t.geometry.type.match(/^Sphere(Buffer)?Geometry$/)&&t.geometry.parameters.radius===i&&t.geometry.parameters.widthSegments===a||(u.hasOwnProperty(n)||(u[n]=new ma.SphereGeometry(i,a,a)),t.geometry.dispose(),t.geometry=u[n]);var c=o(r),h=new ma.Color(da(c||"#ffffaa")),d=e.nodeOpacity*pa(c);"MeshLambertMaterial"===t.material.type&&t.material.color.equals(h)&&t.material.opacity===d||(l.hasOwnProperty(c)||(l[c]=new ma.MeshLambertMaterial({color:h,transparent:!0,opacity:d})),t.material.dispose(),t.material=l[c])}})).digest(e.graphData.nodes.filter(a))}if(e._flushObjects||r(["graphData","linkThreeObject","linkThreeObjectExtend","linkMaterial","linkColor","linkWidth","linkVisibility","linkResolution","linkOpacity","linkDirectionalArrowLength","linkDirectionalArrowColor","linkDirectionalArrowResolution","linkDirectionalParticles","linkDirectionalParticleWidth","linkDirectionalParticleColor","linkDirectionalParticleResolution"])){var c=ks(e.linkThreeObject),h=ks(e.linkThreeObjectExtend),d=ks(e.linkMaterial),p=ks(e.linkVisibility),f=ks(e.linkColor),g=ks(e.linkWidth),m={},y={},b={},_=e.graphData.links.filter(p);if((e._flushObjects||r(["linkThreeObject","linkThreeObjectExtend","linkWidth"]))&&e.linkDataMapper.clear(),e.linkDataMapper.onRemoveObj((function(e){var t=e.__data&&e.__data.__singleHopPhotonsObj;t&&(t.parent.remove(t),ua(t),delete e.__data.__singleHopPhotonsObj)})).onCreateObj((function(t){var r,n,i=c(t),s=h(t);if(i&&e.linkThreeObject===i&&(i=i.clone()),!i||s)if(!!g(t))r=new ma.Mesh;else{var o=new ma.BufferGeometry;o[ba]("position",new ma.BufferAttribute(new Float32Array(6),3)),r=new ma.Line(o)}return i?s?((n=new ma.Group).__graphDefaultObj=!0,n.add(r),n.add(i)):n=i:(n=r).__graphDefaultObj=!0,n.renderOrder=10,n.__graphObjType="link",n})).onUpdateObj((function(t,r){if(t.__graphDefaultObj){var n=t.children.length?t.children[0]:t,i=Math.ceil(10*g(r))/10,s=!!i;if(s){var o=i/2,a=e.linkResolution;if(!n.geometry.type.match(/^Cylinder(Buffer)?Geometry$/)||n.geometry.parameters.radiusTop!==o||n.geometry.parameters.radialSegments!==a){if(!m.hasOwnProperty(i)){var u=new ma.CylinderGeometry(o,o,1,a,1,!1);u[_a]((new ma.Matrix4).makeTranslation(0,.5,0)),u[_a]((new ma.Matrix4).makeRotationX(Math.PI/2)),m[i]=u}n.geometry.dispose(),n.geometry=m[i]}}var l=d(r);if(l)n.material=l;else{var c=f(r),h=new ma.Color(da(c||"#f0f0f0")),p=e.linkOpacity*pa(c),_=s?"MeshLambertMaterial":"LineBasicMaterial";if(n.material.type!==_||!n.material.color.equals(h)||n.material.opacity!==p){var v=s?y:b;v.hasOwnProperty(c)||(v[c]=new ma[_]({color:h,transparent:p<1,opacity:p,depthWrite:p>=1})),n.material.dispose(),n.material=v[c]}}}})).digest(_),e.linkDirectionalArrowLength||t.hasOwnProperty("linkDirectionalArrowLength")){var v=ks(e.linkDirectionalArrowLength),x=ks(e.linkDirectionalArrowColor);e.arrowDataMapper.onCreateObj((function(){var e=new ma.Mesh(void 0,new ma.MeshLambertMaterial({transparent:!0}));return e.__linkThreeObjType="arrow",e})).onUpdateObj((function(t,r){var n=v(r),i=e.linkDirectionalArrowResolution;if(!t.geometry.type.match(/^Cone(Buffer)?Geometry$/)||t.geometry.parameters.height!==n||t.geometry.parameters.radialSegments!==i){var s=new ma.ConeGeometry(.25*n,n,i);s.translate(0,n/2,0),s.rotateX(Math.PI/2),t.geometry.dispose(),t.geometry=s}var o=x(r)||f(r)||"#f0f0f0";t.material.color=new ma.Color(da(o)),t.material.opacity=3*e.linkOpacity*pa(o)})).digest(_.filter(v))}if(e.linkDirectionalParticles||t.hasOwnProperty("linkDirectionalParticles")){var T=ks(e.linkDirectionalParticles),w=ks(e.linkDirectionalParticleWidth),S=ks(e.linkDirectionalParticleColor),N={},E={};e.particlesDataMapper.onCreateObj((function(){var e=new ma.Group;return e.__linkThreeObjType="photons",e.__photonDataMapper=new ha(e),e})).onUpdateObj((function(t,r){var n,i=Math.round(Math.abs(T(r))),s=!!t.children.length&&t.children[0],o=Math.ceil(10*w(r))/10/2,a=e.linkDirectionalParticleResolution;s&&s.geometry.parameters.radius===o&&s.geometry.parameters.widthSegments===a?n=s.geometry:(E.hasOwnProperty(o)||(E[o]=new ma.SphereGeometry(o,a,a)),n=E[o],s&&s.geometry.dispose());var u,l=S(r)||f(r)||"#f0f0f0",c=new ma.Color(da(l)),h=3*e.linkOpacity;s&&s.material.color.equals(c)&&s.material.opacity===h?u=s.material:(N.hasOwnProperty(l)||(N[l]=new ma.MeshLambertMaterial({color:c,transparent:!0,opacity:h})),u=N[l],s&&s.material.dispose()),t.__photonDataMapper.id((function(e){return e.idx})).onCreateObj((function(){return new ma.Mesh(n,u)})).onUpdateObj((function(e){e.geometry=n,e.material=u})).digest(ra(new Array(i)).map((function(e,t){return{idx:t}})))})).digest(_.filter(T))}}if(e._flushObjects=!1,r(["graphData","nodeId","linkSource","linkTarget","numDimensions","forceEngine","dagMode","dagNodeFilter","dagLevelDistance"])){e.engineRunning=!1,e.graphData.links.forEach((function(t){t.source=t[e.linkSource],t.target=t[e.linkTarget]}));var C,A="ngraph"!==e.forceEngine;if(A){(C=e.d3ForceLayout).stop().alpha(1).numDimensions(e.numDimensions).nodes(e.graphData.nodes);var M=e.d3ForceLayout.force("link");M&&M.id((function(t){return t[e.nodeId]})).links(e.graphData.links);var R=e.dagMode&&function(e,t){var r=e.nodes,n=e.links,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s=i.nodeFilter,o=void 0===s?function(){return!0}:s,a=i.onLoopError,u=void 0===a?function(e){throw"Invalid DAG structure! Found cycle in node path: ".concat(e.join(" -> "),".")}:a,l={};r.forEach((function(e){return l[t(e)]={data:e,out:[],depth:-1,skip:!o(e)}})),n.forEach((function(e){var r=e.source,n=e.target,i=u(r),s=u(n);if(!l.hasOwnProperty(i))throw"Missing source node with id: ".concat(i);if(!l.hasOwnProperty(s))throw"Missing target node with id: ".concat(s);var o=l[i],a=l[s];function u(e){return"object"===ia(e)?t(e):e}o.out.push(a)}));var c=[];return function e(r){for(var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=function(){var s=r[o];if(-1!==n.indexOf(s)){var a=[].concat(ra(n.slice(n.indexOf(s))),[s]).map((function(e){return t(e.data)}));return c.some((function(e){return e.length===a.length&&e.every((function(e,t){return e===a[t]}))}))||(c.push(a),u(a)),1}i>s.depth&&(s.depth=i,e(s.out,[].concat(ra(n),[s]),i+(s.skip?0:1)))},o=0,a=r.length;o<a;o++)s()}(Object.values(l)),Object.assign.apply(Object,[{}].concat(ra(Object.entries(l).filter((function(e){return!ea(e,2)[1].skip})).map((function(e){var t=ea(e,2);return qo({},t[0],t[1].depth)})))))}(e.graphData,(function(t){return t[e.nodeId]}),{nodeFilter:e.dagNodeFilter,onLoopError:e.onDagError||void 0}),P=Math.max.apply(Math,ra(Object.values(R||[]))),D=e.dagLevelDistance||e.graphData.nodes.length/(P||1)*2*(-1!==["radialin","radialout"].indexOf(e.dagMode)?.7:1);if(["lr","rl","td","bu","zin","zout"].includes(t.dagMode)){var F=["lr","rl"].includes(t.dagMode)?"fx":["td","bu"].includes(t.dagMode)?"fy":"fz";e.graphData.nodes.filter(e.dagNodeFilter).forEach((function(e){return delete e[F]}))}if(["lr","rl","td","bu","zin","zout"].includes(e.dagMode)){var O=["rl","td","zout"].includes(e.dagMode),L=["lr","rl"].includes(e.dagMode)?"fx":["td","bu"].includes(e.dagMode)?"fy":"fz";e.graphData.nodes.filter(e.dagNodeFilter).forEach((function(t){return t[L]=function(t){return(R[t[e.nodeId]]-P/2)*D*(O?-1:1)}(t)}))}e.d3ForceLayout.force("dagRadial",-1!==["radialin","radialout"].indexOf(e.dagMode)?On((function(t){var r=R[t[e.nodeId]]||-1;return("radialin"===e.dagMode?P-r:r)*D})).strength((function(t){return e.dagNodeFilter(t)?1:0})):null)}else{var B=ya.graph();e.graphData.nodes.forEach((function(t){B.addNode(t[e.nodeId])})),e.graphData.links.forEach((function(e){B.addLink(e.source,e.target)})),C=ya.forcelayout(B,function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Zo(Object(r),!0).forEach((function(t){qo(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Zo(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}({dimensions:e.numDimensions},e.ngraphPhysics)),C.graph=B}for(var k=0;k<e.warmupTicks&&!(A&&e.d3AlphaMin>0&&e.d3ForceLayout.alpha()<e.d3AlphaMin);k++)C[A?"tick":"step"]();e.layout=C,this.resetCountdown()}e.engineRunning=!0,e.onFinishUpdate()}});var xa=function(e){var t=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=function(r){function n(){var r;jo(this,n);for(var i=arguments.length,s=new Array(i),o=0;o<i;o++)s[o]=arguments[o];return(r=Vo(this,n,[].concat(s))).__kapsuleInstance=Ho(e,[].concat(ra(t?[r]:[]),s)),r}return Yo(n,r),Wo(n)}(arguments.length>1&&void 0!==arguments[1]?arguments[1]:Object);return Object.keys(e()).forEach((function(e){return r.prototype[e]=function(){var t,r=(t=this.__kapsuleInstance)[e].apply(t,arguments);return r===this.__kapsuleInstance?this:r}})),r}(va,(window.THREE?window.THREE:{Group:u}).Group,!0);
/**
 * @license
 * Copyright 2010-2025 Three.js Authors
 * SPDX-License-Identifier: MIT
 */
const Ta=["alphaMap","alphaTest","anisotropy","anisotropyMap","anisotropyRotation","aoMap","aoMapIntensity","attenuationColor","attenuationDistance","bumpMap","clearcoat","clearcoatMap","clearcoatNormalMap","clearcoatNormalScale","clearcoatRoughness","color","dispersion","displacementMap","emissive","emissiveIntensity","emissiveMap","envMap","envMapIntensity","gradientMap","ior","iridescence","iridescenceIOR","iridescenceMap","iridescenceThicknessMap","lightMap","lightMapIntensity","map","matcap","metalness","metalnessMap","normalMap","normalScale","opacity","roughness","roughnessMap","sheen","sheenColor","sheenColorMap","sheenRoughnessMap","shininess","specular","specularColor","specularColorMap","specularIntensity","specularIntensityMap","specularMap","thickness","transmission","transmissionMap"];class wa{constructor(e){this.renderObjects=new WeakMap,this.hasNode=this.containsNode(e),this.hasAnimation=!0===e.object.isSkinnedMesh,this.refreshUniforms=Ta,this.renderId=0}firstInitialization(e){return!1===this.renderObjects.has(e)&&(this.getRenderObjectData(e),!0)}needsVelocity(e){const t=e.getMRT();return null!==t&&t.has("velocity")}getRenderObjectData(e){let t=this.renderObjects.get(e);if(void 0===t){const{geometry:r,material:n,object:i}=e;if(t={material:this.getMaterialData(n),geometry:{id:r.id,attributes:this.getAttributesData(r.attributes),indexVersion:r.index?r.index.version:null,drawRange:{start:r.drawRange.start,count:r.drawRange.count}},worldMatrix:i.matrixWorld.clone()},i.center&&(t.center=i.center.clone()),i.morphTargetInfluences&&(t.morphTargetInfluences=i.morphTargetInfluences.slice()),null!==e.bundle&&(t.version=e.bundle.version),t.material.transmission>0){const{width:r,height:n}=e.context;t.bufferWidth=r,t.bufferHeight=n}this.renderObjects.set(e,t)}return t}getAttributesData(e){const t={};for(const r in e){const n=e[r];t[r]={version:n.version}}return t}containsNode(e){const t=e.material;for(const r in t)if(t[r]&&t[r].isNode)return!0;return null!==e.renderer.overrideNodes.modelViewMatrix||null!==e.renderer.overrideNodes.modelNormalViewMatrix}getMaterialData(e){const t={};for(const r of this.refreshUniforms){const n=e[r];null!=n&&("object"==typeof n&&void 0!==n.clone?!0===n.isTexture?t[r]={id:n.id,version:n.version}:t[r]=n.clone():t[r]=n)}return t}equals(e){const{object:t,material:r,geometry:n}=e,i=this.getRenderObjectData(e);if(!0!==i.worldMatrix.equals(t.matrixWorld))return i.worldMatrix.copy(t.matrixWorld),!1;const s=i.material;for(const f in s){const e=s[f],t=r[f];if(void 0!==e.equals){if(!1===e.equals(t))return e.copy(t),!1}else if(!0===t.isTexture){if(e.id!==t.id||e.version!==t.version)return e.id=t.id,e.version=t.version,!1}else if(e!==t)return s[f]=t,!1}if(s.transmission>0){const{width:t,height:r}=e.context;if(i.bufferWidth!==t||i.bufferHeight!==r)return i.bufferWidth=t,i.bufferHeight=r,!1}const o=i.geometry,a=n.attributes,u=o.attributes,l=Object.keys(u),c=Object.keys(a);if(o.id!==n.id)return o.id=n.id,!1;if(l.length!==c.length)return i.geometry.attributes=this.getAttributesData(a),!1;for(const f of l){const e=u[f],t=a[f];if(void 0===t)return delete u[f],!1;if(e.version!==t.version)return e.version=t.version,!1}const h=n.index,d=o.indexVersion,p=h?h.version:null;if(d!==p)return o.indexVersion=p,!1;if(o.drawRange.start!==n.drawRange.start||o.drawRange.count!==n.drawRange.count)return o.drawRange.start=n.drawRange.start,o.drawRange.count=n.drawRange.count,!1;if(i.morphTargetInfluences){let e=!1;for(let r=0;r<i.morphTargetInfluences.length;r++)i.morphTargetInfluences[r]!==t.morphTargetInfluences[r]&&(e=!0);if(e)return!0}return i.center&&!1===i.center.equals(t.center)?(i.center.copy(t.center),!0):(null!==e.bundle&&(i.version=e.bundle.version),!0)}needsRefresh(e,t){if(this.hasNode||this.hasAnimation||this.firstInitialization(e)||this.needsVelocity(t.renderer))return!0;const{renderId:r}=t;if(this.renderId!==r)return this.renderId=r,!0;const n=!0===e.object.static,i=null!==e.bundle&&!0===e.bundle.static&&this.getRenderObjectData(e).version===e.bundle.version;if(n||i)return!1;return!0!==this.equals(e)}}function Sa(e,t=0){let r=3735928559^t,n=1103547991^t;if(e instanceof Array)for(let i,s=0;s<e.length;s++)i=e[s],r=Math.imul(r^i,2654435761),n=Math.imul(n^i,1597334677);else for(let i,s=0;s<e.length;s++)i=e.charCodeAt(s),r=Math.imul(r^i,2654435761),n=Math.imul(n^i,1597334677);return r=Math.imul(r^r>>>16,2246822507),r^=Math.imul(n^n>>>13,3266489909),n=Math.imul(n^n>>>16,2246822507),n^=Math.imul(r^r>>>13,3266489909),4294967296*(2097151&n)+(r>>>0)}const Na=e=>Sa(e),Ea=(...e)=>Sa(e);function Ca(e,t=!1){const r=[];!0===e.isNode&&(r.push(e.id),e=e.getSelf());for(const{property:n,childNode:i}of Aa(e))r.push(Sa(n.slice(0,-4)),i.getCacheKey(t));return Sa(r)}function*Aa(e,t=!1){for(const r in e){if(!0===r.startsWith("_"))continue;const n=e[r];if(!0===Array.isArray(n))for(let e=0;e<n.length;e++){const i=n[e];i&&(!0===i.isNode||t&&"function"==typeof i.toJSON)&&(yield{property:r,index:e,childNode:i})}else if(n&&!0===n.isNode)yield{property:r,childNode:n};else if("object"==typeof n)for(const e in n){const i=n[e];i&&(!0===i.isNode||t&&"function"==typeof i.toJSON)&&(yield{property:r,index:e,childNode:i})}}}const Ma=new Map([[1,"float"],[2,"vec2"],[3,"vec3"],[4,"vec4"],[9,"mat3"],[16,"mat4"]]),Ra=new WeakMap;function Pa(e){if(null==e)return null;const t=typeof e;return!0===e.isNode?"node":"number"===t?"float":"boolean"===t?"bool":"string"===t?"string":"function"===t?"shader":!0===e.isVector2?"vec2":!0===e.isVector3?"vec3":!0===e.isVector4?"vec4":!0===e.isMatrix2?"mat2":!0===e.isMatrix3?"mat3":!0===e.isMatrix4?"mat4":!0===e.isColor?"color":e instanceof ArrayBuffer?"ArrayBuffer":null}function Da(e,...t){const r=e?e.slice(-4):void 0;return 1===t.length&&("vec2"===r?t=[t[0],t[0]]:"vec3"===r?t=[t[0],t[0],t[0]]:"vec4"===r&&(t=[t[0],t[0],t[0],t[0]])),"color"===e?new h(...t):"vec2"===r?new i(...t):"vec3"===r?new o(...t):"vec4"===r?new E(...t):"mat2"===r?new Jr(...t):"mat3"===r?new Se(...t):"mat4"===r?new a(...t):"bool"===e?t[0]||!1:"float"===e||"int"===e||"uint"===e?t[0]||0:"string"===e?t[0]||"":"ArrayBuffer"===e?(n=t[0],Uint8Array.from(atob(n),(e=>e.charCodeAt(0))).buffer):null;var n}function Fa(e){let t=Ra.get(e);return void 0===t&&(t={},Ra.set(e,t)),t}const Oa="vertex",La="none",Ba="frame",ka="render",Ia="object",Ua="readOnly",Va="writeOnly",ja="readWrite",Ga=["setup","analyze","generate"],za=["fragment","vertex","compute"],$a=["x","y","z","w"],Ha={analyze:"setup",generate:"analyze"};let Wa=0;class qa extends te{static get type(){return"Node"}constructor(e=null){super(),this.nodeType=e,this.updateType=La,this.updateBeforeType=La,this.updateAfterType=La,this.uuid=Zr.generateUUID(),this.version=0,this.global=!1,this.parents=!1,this.isNode=!0,this._cacheKey=null,this._cacheKeyVersion=0,Object.defineProperty(this,"id",{value:Wa++})}set needsUpdate(e){!0===e&&this.version++}get type(){return this.constructor.type}onUpdate(e,t){return this.updateType=t,this.update=e.bind(this.getSelf()),this}onFrameUpdate(e){return this.onUpdate(e,Ba)}onRenderUpdate(e){return this.onUpdate(e,ka)}onObjectUpdate(e){return this.onUpdate(e,Ia)}onReference(e){return this.updateReference=e.bind(this.getSelf()),this}getSelf(){return this.self||this}updateReference(){return this}isGlobal(){return this.global}*getChildren(){for(const{childNode:e}of Aa(this))yield e}dispose(){this.dispatchEvent({type:"dispose"})}traverse(e){e(this);for(const t of this.getChildren())t.traverse(e)}getCacheKey(e=!1){return!0!==(e=e||this.version!==this._cacheKeyVersion)&&null!==this._cacheKey||(this._cacheKey=Ea(Ca(this,e),this.customCacheKey()),this._cacheKeyVersion=this.version),this._cacheKey}customCacheKey(){return 0}getScope(){return this}getHash(){return this.uuid}getUpdateType(){return this.updateType}getUpdateBeforeType(){return this.updateBeforeType}getUpdateAfterType(){return this.updateAfterType}getElementType(e){const t=this.getNodeType(e);return e.getElementType(t)}getMemberType(){return"void"}getNodeType(e){const t=e.getNodeProperties(this);return t.outputNode?t.outputNode.getNodeType(e):this.nodeType}getShared(e){const t=this.getHash(e);return e.getNodeFromHash(t)||this}setup(e){const t=e.getNodeProperties(this);let r=0;for(const n of this.getChildren())t["node"+r++]=n;return t.outputNode||null}analyze(e,t=null){const r=e.increaseUsage(this);if(!0===this.parents){const r=e.getDataFromNode(this,"any");r.stages=r.stages||{},r.stages[e.shaderStage]=r.stages[e.shaderStage]||[],r.stages[e.shaderStage].push(t)}if(1===r){const t=e.getNodeProperties(this);for(const r of Object.values(t))r&&!0===r.isNode&&r.build(e,this)}}generate(e,t){const{outputNode:r}=e.getNodeProperties(this);if(r&&!0===r.isNode)return r.build(e,t)}updateBefore(){}updateAfter(){}update(){}build(e,t=null){const r=this.getShared(e);if(this!==r)return r.build(e,t);const n=e.getDataFromNode(this);n.buildStages=n.buildStages||{},n.buildStages[e.buildStage]=!0;const i=Ha[e.buildStage];if(i&&!0!==n.buildStages[i]){const t=e.getBuildStage();e.setBuildStage(i),this.build(e),e.setBuildStage(t)}e.addNode(this),e.addChain(this);let s=null;const o=e.getBuildStage();if("setup"===o){this.updateReference(e);const t=e.getNodeProperties(this);if(!0!==t.initialized){t.initialized=!0,t.outputNode=this.setup(e)||t.outputNode||null;for(const r of Object.values(t))if(r&&!0===r.isNode){if(!0===r.parents){const t=e.getNodeProperties(r);t.parents=t.parents||[],t.parents.push(this)}r.build(e)}}s=t.outputNode}else if("analyze"===o)this.analyze(e,t);else if("generate"===o){if(1===this.generate.length){const r=this.getNodeType(e),n=e.getDataFromNode(this);s=n.snippet,void 0===s?void 0===n.generated?(n.generated=!0,s=this.generate(e)||"",n.snippet=s):s="":void 0!==n.flowCodes&&void 0!==e.context.nodeBlock&&e.addFlowCodeHierarchy(this,e.context.nodeBlock),s=e.format(s,r,t)}else s=this.generate(e,t)||""}return e.removeChain(this),e.addSequentialNode(this),s}getSerializeChildren(){return Aa(this)}serialize(e){const t=this.getSerializeChildren(),r={};for(const{property:n,index:i,childNode:s}of t)void 0!==i?(void 0===r[n]&&(r[n]=Number.isInteger(i)?[]:{}),r[n][i]=s.toJSON(e.meta).uuid):r[n]=s.toJSON(e.meta).uuid;Object.keys(r).length>0&&(e.inputNodes=r)}deserialize(e){if(void 0!==e.inputNodes){const t=e.meta.nodes;for(const r in e.inputNodes)if(Array.isArray(e.inputNodes[r])){const n=[];for(const i of e.inputNodes[r])n.push(t[i]);this[r]=n}else if("object"==typeof e.inputNodes[r]){const n={};for(const i in e.inputNodes[r]){const s=e.inputNodes[r][i];n[i]=t[s]}this[r]=n}else{const n=e.inputNodes[r];this[r]=t[n]}}}toJSON(e){const{uuid:t,type:r}=this,n=void 0===e||"string"==typeof e;n&&(e={textures:{},images:{},nodes:{}});let i=e.nodes[t];function s(e){const t=[];for(const r in e){const n=e[r];delete n.metadata,t.push(n)}return t}if(void 0===i&&(i={uuid:t,type:r,meta:e,metadata:{version:4.7,type:"Node",generator:"Node.toJSON"}},!0!==n&&(e.nodes[i.uuid]=i),this.serialize(i),delete i.meta),n){const t=s(e.textures),r=s(e.images),n=s(e.nodes);t.length>0&&(i.textures=t),r.length>0&&(i.images=r),n.length>0&&(i.nodes=n)}return i}}class Xa extends qa{static get type(){return"ArrayElementNode"}constructor(e,t){super(),this.node=e,this.indexNode=t,this.isArrayElementNode=!0}getNodeType(e){return this.node.getElementType(e)}generate(e){const t=this.indexNode.getNodeType(e);return`${this.node.build(e)}[ ${this.indexNode.build(e,!e.isVector(t)&&e.isInteger(t)?t:"uint")} ]`}}class Ka extends qa{static get type(){return"ConvertNode"}constructor(e,t){super(),this.node=e,this.convertTo=t}getNodeType(e){const t=this.node.getNodeType(e);let r=null;for(const n of this.convertTo.split("|"))null!==r&&e.getTypeLength(t)!==e.getTypeLength(n)||(r=n);return r}serialize(e){super.serialize(e),e.convertTo=this.convertTo}deserialize(e){super.deserialize(e),this.convertTo=e.convertTo}generate(e,t){const r=this.node,n=this.getNodeType(e),i=r.build(e,n);return e.format(i,n,t)}}class Ya extends qa{static get type(){return"TempNode"}constructor(e=null){super(e),this.isTempNode=!0}hasDependencies(e){return e.getDataFromNode(this).usageCount>1}build(e,t){if("generate"===e.getBuildStage()){const r=e.getVectorType(this.getNodeType(e,t)),n=e.getDataFromNode(this);if(void 0!==n.propertyName)return e.format(n.propertyName,r,t);if("void"!==r&&"void"!==t&&this.hasDependencies(e)){const i=super.build(e,r),s=e.getVarFromNode(this,null,r),o=e.getPropertyName(s);return e.addLineFlowCode(`${o} = ${i}`,this),n.snippet=i,n.propertyName=o,e.format(n.propertyName,r,t)}}return super.build(e,t)}}class Qa extends Ya{static get type(){return"JoinNode"}constructor(e=[],t=null){super(t),this.nodes=e}getNodeType(e){return null!==this.nodeType?e.getVectorType(this.nodeType):e.getTypeFromLength(this.nodes.reduce(((t,r)=>t+e.getTypeLength(r.getNodeType(e))),0))}generate(e,t){const r=this.getNodeType(e),n=e.getTypeLength(r),i=this.nodes,s=e.getComponentType(r),o=[];let a=0;for(const l of i){if(a>=n)break;let t,r=l.getNodeType(e),i=e.getTypeLength(r);a+i>n&&(i=n-a,r=e.getTypeFromLength(i)),a+=i,t=l.build(e,r);const u=e.getComponentType(r);u!==s&&(t=e.format(t,u,s)),o.push(t)}const u=`${e.getType(r)}( ${o.join(", ")} )`;return e.format(u,r,t)}}const Za=$a.join("");class Ja extends qa{static get type(){return"SplitNode"}constructor(e,t="x"){super(),this.node=e,this.components=t,this.isSplitNode=!0}getVectorLength(){let e=this.components.length;for(const t of this.components)e=Math.max($a.indexOf(t)+1,e);return e}getComponentType(e){return e.getComponentType(this.node.getNodeType(e))}getNodeType(e){return e.getTypeFromLength(this.components.length,this.getComponentType(e))}generate(e,t){const r=this.node,n=e.getTypeLength(r.getNodeType(e));let i=null;if(n>1){let s=null;this.getVectorLength()>=n&&(s=e.getTypeFromLength(this.getVectorLength(),this.getComponentType(e)));const o=r.build(e,s);i=this.components.length===n&&this.components===Za.slice(0,this.components.length)?e.format(o,s,t):e.format(`${o}.${this.components}`,this.getNodeType(e),t)}else i=r.build(e,t);return i}serialize(e){super.serialize(e),e.components=this.components}deserialize(e){super.deserialize(e),this.components=e.components}}class eu extends Ya{static get type(){return"SetNode"}constructor(e,t,r){super(),this.sourceNode=e,this.components=t,this.targetNode=r}getNodeType(e){return this.sourceNode.getNodeType(e)}generate(e){const{sourceNode:t,components:r,targetNode:n}=this,i=this.getNodeType(e),s=e.getComponentType(n.getNodeType(e)),o=e.getTypeFromLength(r.length,s),a=n.build(e,o),u=t.build(e,i),l=e.getTypeLength(i),c=[];for(let h=0;h<l;h++){const e=$a[h];e===r[0]?(c.push(a),h+=r.length-1):c.push(u+"."+e)}return`${e.getType(i)}( ${c.join(", ")} )`}}class tu extends Ya{static get type(){return"FlipNode"}constructor(e,t){super(),this.sourceNode=e,this.components=t}getNodeType(e){return this.sourceNode.getNodeType(e)}generate(e){const{components:t,sourceNode:r}=this,n=this.getNodeType(e),i=r.build(e),s=e.getVarFromNode(this),o=e.getPropertyName(s);e.addLineFlowCode(o+" = "+i,this);const a=e.getTypeLength(n),u=[];let l=0;for(let c=0;c<a;c++){const e=$a[c];e===t[l]?(u.push("1.0 - "+o+"."+e),l++):u.push(o+"."+e)}return`${e.getType(n)}( ${u.join(", ")} )`}}class ru extends qa{static get type(){return"InputNode"}constructor(e,t=null){super(t),this.isInputNode=!0,this.value=e,this.precision=null}getNodeType(){return null===this.nodeType?Pa(this.value):this.nodeType}getInputType(e){return this.getNodeType(e)}setPrecision(e){return this.precision=e,this}serialize(e){super.serialize(e),e.value=this.value,this.value&&this.value.toArray&&(e.value=this.value.toArray()),e.valueType=Pa(this.value),e.nodeType=this.nodeType,"ArrayBuffer"===e.valueType&&(e.value=function(e){let t="";const r=new Uint8Array(e);for(let n=0;n<r.length;n++)t+=String.fromCharCode(r[n]);return btoa(t)}(e.value)),e.precision=this.precision}deserialize(e){super.deserialize(e),this.nodeType=e.nodeType,this.value=Array.isArray(e.value)?Da(e.valueType,...e.value):e.value,this.precision=e.precision||null,this.value&&this.value.fromArray&&(this.value=this.value.fromArray(e.value))}generate(){}}const nu=/float|u?int/;class iu extends ru{static get type(){return"ConstNode"}constructor(e,t=null){super(e,t),this.isConstNode=!0}generateConst(e){return e.generateConst(this.getNodeType(e),this.value)}generate(e,t){const r=this.getNodeType(e);return nu.test(r)&&nu.test(t)?e.generateConst(t,this.value):e.format(this.generateConst(e),r,t)}}class su extends qa{static get type(){return"MemberNode"}constructor(e,t){super(),this.node=e,this.property=t,this.isMemberNode=!0}getNodeType(e){return this.node.getMemberType(e,this.property)}generate(e){return this.node.build(e)+"."+this.property}}let ou=null;const au=new Map;function uu(e,t){if(!au.has(e)){if("function"!=typeof t)throw new Error(`THREE.TSL: Node element ${e} is not a function`);au.set(e,t)}}const lu=e=>e.replace(/r|s/g,"x").replace(/g|t/g,"y").replace(/b|p/g,"z").replace(/a|q/g,"w"),cu=e=>lu(e).split("").sort().join(""),hu={setup(e,t){const r=t.shift();return e(Lu(r),...t)},get(e,t,r){if("string"==typeof t&&void 0===e[t]){if(!0!==e.isStackNode&&"assign"===t)return(...e)=>(ou.assign(r,...e),r);if(au.has(t)){const n=au.get(t);return e.isStackNode?(...e)=>r.add(n(...e)):(...e)=>n(r,...e)}if("self"===t)return e;if(t.endsWith("Assign")&&au.has(t.slice(0,t.length-6))){const n=au.get(t.slice(0,t.length-6));return e.isStackNode?(...e)=>r.assign(e[0],n(...e)):(...e)=>r.assign(n(r,...e))}if(!0===/^[xyzwrgbastpq]{1,4}$/.test(t))return t=lu(t),Ou(new Ja(r,t));if(!0===/^set[XYZWRGBASTPQ]{1,4}$/.test(t))return t=cu(t.slice(3).toLowerCase()),r=>Ou(new eu(e,t,Ou(r)));if(!0===/^flip[XYZWRGBASTPQ]{1,4}$/.test(t))return t=cu(t.slice(4).toLowerCase()),()=>Ou(new tu(Ou(e),t));if("width"===t||"height"===t||"depth"===t)return"width"===t?t="x":"height"===t?t="y":"depth"===t&&(t="z"),Ou(new Ja(e,t));if(!0===/^\d+$/.test(t))return Ou(new Xa(r,new iu(Number(t),"uint")));if(!0===/^get$/.test(t))return e=>Ou(new su(r,e))}return Reflect.get(e,t,r)},set:(e,t,r,n)=>"string"!=typeof t||void 0!==e[t]||!0!==/^[xyzwrgbastpq]{1,4}$/.test(t)&&"width"!==t&&"height"!==t&&"depth"!==t&&!0!==/^\d+$/.test(t)?Reflect.set(e,t,r,n):(n[t].assign(r),!0)},du=new WeakMap,pu=new WeakMap,fu=function(e,t=null){for(const r in e)e[r]=Ou(e[r],t);return e},gu=function(e,t=null){const r=e.length;for(let n=0;n<r;n++)e[n]=Ou(e[n],t);return e},mu=function(e,t=null,r=null,n=null){const i=e=>Ou(null!==n?Object.assign(e,n):e);let s,o,a,u=t;function l(t){let r;return r=u?/[a-z]/i.test(u)?u+"()":u:e.type,void 0!==o&&t.length<o?t.concat(new Array(o-t.length).fill(0)):void 0!==a&&t.length>a?t.slice(0,a):t}return null===t?s=(...t)=>i(new e(...Bu(l(t)))):null!==r?(r=Ou(r),s=(...n)=>i(new e(t,...Bu(l(n)),r))):s=(...r)=>i(new e(t,...Bu(l(r)))),s.setParameterLength=(...e)=>(1===e.length?o=a=e[0]:2===e.length&&([o,a]=e),s),s.setName=e=>(u=e,s),s},yu=function(e,...t){return Ou(new e(...Bu(t)))};class bu extends qa{constructor(e,t){super(),this.shaderNode=e,this.inputNodes=t,this.isShaderCallNodeInternal=!0}getNodeType(e){return this.shaderNode.nodeType||this.getOutputNode(e).getNodeType(e)}getMemberType(e,t){return this.getOutputNode(e).getMemberType(e,t)}call(e){const{shaderNode:t,inputNodes:r}=this,n=e.getNodeProperties(t),i=t.namespace&&t.namespace===e.namespace?e.getNamespace("once"):"once";if(n[i])return n[i];let s=null;if(t.layout){let n=pu.get(e.constructor);void 0===n&&(n=new WeakMap,pu.set(e.constructor,n));let i=n.get(t);void 0===i&&(i=Ou(e.buildFunctionNode(t)),n.set(t,i)),e.addInclude(i),s=Ou(i.call(r))}else{const n=t.jsFunc,i=null!==r||n.length>1?n(r||[],e):n(e);s=Ou(i)}return t.once&&(n[i]=s),s}setupOutput(e){return e.addStack(),e.stack.outputNode=this.call(e),e.removeStack()}getOutputNode(e){const t=e.getNodeProperties(this),r=e.getOutputNamespace();return t[r]=t[r]||this.setupOutput(e),t[r]}build(e,t=null){let r=null;const n=e.getBuildStage(),i=e.getNodeProperties(this),s=e.getOutputNamespace(),o=this.getOutputNode(e);if("setup"===n){const t=e.getNamespace("initialized");!0!==i[t]&&(i[t]=!0,i[s]=this.getOutputNode(e),i[s].build(e)),r=i[s]}else"analyze"===n?o.build(e,t):"generate"===n&&(r=o.build(e,t)||"");return r}}class _u extends qa{constructor(e,t){super(t),this.jsFunc=e,this.layout=null,this.global=!0,this.once=!1,this.namespace=null}setLayout(e){return this.layout=e,this}call(e=null){return Lu(e),Ou(new bu(this,e))}setup(){return this.call()}}const vu=[!1,!0],xu=[0,1,2,3],Tu=[-1,-2],wu=[.5,1.5,1/3,1e-6,1e6,Math.PI,2*Math.PI,1/Math.PI,2/Math.PI,1/(2*Math.PI),Math.PI/2],Su=new Map;for(const yP of vu)Su.set(yP,new iu(yP));const Nu=new Map;for(const yP of xu)Nu.set(yP,new iu(yP,"uint"));const Eu=new Map([...Nu].map((e=>new iu(e.value,"int"))));for(const yP of Tu)Eu.set(yP,new iu(yP,"int"));const Cu=new Map([...Eu].map((e=>new iu(e.value))));for(const yP of wu)Cu.set(yP,new iu(yP));for(const yP of wu)Cu.set(-yP,new iu(-yP));const Au={bool:Su,uint:Nu,ints:Eu,float:Cu},Mu=new Map([...Su,...Cu]),Ru=(e,t)=>Mu.has(e)?Mu.get(e):!0===e.isNode?e:new iu(e,t),Pu=function(e,t=null){return(...r)=>{if((0===r.length||!["bool","float","int","uint"].includes(e)&&r.every((e=>"object"!=typeof e)))&&(r=[Da(e,...r)]),1===r.length&&null!==t&&t.has(r[0]))return Ou(t.get(r[0]));if(1===r.length){const t=Ru(r[0],e);return(e=>{try{return e.getNodeType()}catch(_R){return}})(t)===e?Ou(t):Ou(new Ka(t,e))}const n=r.map((e=>Ru(e)));return Ou(new Qa(n,e))}},Du=e=>"object"==typeof e&&null!==e?e.value:e;function Fu(e,t){return new Proxy(new _u(e,t),hu)}const Ou=(e,t=null)=>function(e,t=null){const r=Pa(e);if("node"===r){let t=du.get(e);return void 0===t&&(t=new Proxy(e,hu),du.set(e,t),du.set(t,t)),t}return null===t&&("float"===r||"boolean"===r)||r&&"shader"!==r&&"string"!==r?Ou(Ru(e,t)):"shader"===r?Vu(e):e}(e,t),Lu=(e,t=null)=>new fu(e,t),Bu=(e,t=null)=>new gu(e,t),ku=(...e)=>new mu(...e),Iu=(...e)=>new yu(...e);let Uu=0;const Vu=(e,t=null)=>{let r=null;null!==t&&("object"==typeof t?r=t.return:("string"==typeof t&&(r=t),t=null));const n=new Fu(e,r),i=(...e)=>{let t;Lu(e);t=e[0]&&(e[0].isNode||Object.getPrototypeOf(e[0])!==Object.prototype)?[...e]:e[0];const i=n.call(t);return"void"===r&&i.toStack(),i};if(i.shaderNode=n,i.id=n.id,i.getNodeType=(...e)=>n.getNodeType(...e),i.getCacheKey=(...e)=>n.getCacheKey(...e),i.setLayout=e=>(n.setLayout(e),i),i.once=(e=null)=>(n.once=!0,n.namespace=e,i),null!==t){if("object"!=typeof t.inputs){const e={name:"fn"+Uu++,type:r,inputs:[]};for(const r in t)"return"!==r&&e.inputs.push({name:r,type:t[r]});t=e}i.setLayout(t)}return i},ju=e=>{ou=e},Gu=()=>ou,zu=(...e)=>ou.If(...e);function $u(e){return ou&&ou.add(e),e}uu("toStack",$u);const Hu=new Pu("color"),Wu=new Pu("float",Au.float),qu=new Pu("int",Au.ints),Xu=new Pu("uint",Au.uint),Ku=new Pu("bool",Au.bool),Yu=new Pu("vec2"),Qu=new Pu("ivec2"),Zu=new Pu("uvec2"),Ju=new Pu("bvec2"),el=new Pu("vec3"),tl=new Pu("ivec3"),rl=new Pu("uvec3"),nl=new Pu("bvec3"),il=new Pu("vec4"),sl=new Pu("ivec4"),ol=new Pu("uvec4"),al=new Pu("bvec4"),ul=new Pu("mat2"),ll=new Pu("mat3"),cl=new Pu("mat4");uu("toColor",Hu),uu("toFloat",Wu),uu("toInt",qu),uu("toUint",Xu),uu("toBool",Ku),uu("toVec2",Yu),uu("toIVec2",Qu),uu("toUVec2",Zu),uu("toBVec2",Ju),uu("toVec3",el),uu("toIVec3",tl),uu("toUVec3",rl),uu("toBVec3",nl),uu("toVec4",il),uu("toIVec4",sl),uu("toUVec4",ol),uu("toBVec4",al),uu("toMat2",ul),uu("toMat3",ll),uu("toMat4",cl);uu("element",ku(Xa).setParameterLength(2)),uu("convert",((e,t)=>Ou(new Ka(Ou(e),t)))),uu("append",(e=>$u(e)));class hl extends qa{static get type(){return"PropertyNode"}constructor(e,t=null,r=!1){super(e),this.name=t,this.varying=r,this.isPropertyNode=!0,this.global=!0}getHash(e){return this.name||super.getHash(e)}generate(e){let t;return!0===this.varying?(t=e.getVaryingFromNode(this,this.name),t.needsInterpolation=!0):t=e.getVarFromNode(this,this.name),e.getPropertyName(t)}}const dl=(e,t)=>Ou(new hl(e,t)),pl=(e,t)=>Ou(new hl(e,t,!0)),fl=Iu(hl,"vec4","DiffuseColor"),gl=Iu(hl,"vec3","EmissiveColor"),ml=Iu(hl,"float","Roughness"),yl=Iu(hl,"float","Metalness"),bl=Iu(hl,"float","Clearcoat"),_l=Iu(hl,"float","ClearcoatRoughness"),vl=Iu(hl,"vec3","Sheen"),xl=Iu(hl,"float","SheenRoughness"),Tl=Iu(hl,"float","Iridescence"),wl=Iu(hl,"float","IridescenceIOR"),Sl=Iu(hl,"float","IridescenceThickness"),Nl=Iu(hl,"float","AlphaT"),El=Iu(hl,"float","Anisotropy"),Cl=Iu(hl,"vec3","AnisotropyT"),Al=Iu(hl,"vec3","AnisotropyB"),Ml=Iu(hl,"color","SpecularColor"),Rl=Iu(hl,"float","SpecularF90"),Pl=Iu(hl,"float","Shininess"),Dl=Iu(hl,"vec4","Output"),Fl=Iu(hl,"float","dashSize"),Ol=Iu(hl,"float","gapSize"),Ll=Iu(hl,"float","IOR"),Bl=Iu(hl,"float","Transmission"),kl=Iu(hl,"float","Thickness"),Il=Iu(hl,"float","AttenuationDistance"),Ul=Iu(hl,"color","AttenuationColor"),Vl=Iu(hl,"float","Dispersion");class jl extends qa{static get type(){return"UniformGroupNode"}constructor(e,t=!1,r=1){super("string"),this.name=e,this.shared=t,this.order=r,this.isUniformGroup=!0}serialize(e){super.serialize(e),e.name=this.name,e.version=this.version,e.shared=this.shared}deserialize(e){super.deserialize(e),this.name=e.name,this.version=e.version,this.shared=e.shared}}const Gl=e=>new jl(e),zl=(e,t=0)=>new jl(e,!0,t),$l=zl("frame"),Hl=zl("render"),Wl=Gl("object");class ql extends ru{static get type(){return"UniformNode"}constructor(e,t=null){super(e,t),this.isUniformNode=!0,this.name="",this.groupNode=Wl}label(e){return this.name=e,this}setGroup(e){return this.groupNode=e,this}getGroup(){return this.groupNode}getUniformHash(e){return this.getHash(e)}onUpdate(e,t){const r=this.getSelf();return e=e.bind(r),super.onUpdate((t=>{const n=e(t,r);void 0!==n&&(this.value=n)}),t)}generate(e,t){const r=this.getNodeType(e),n=this.getUniformHash(e);let i=e.getNodeFromHash(n);void 0===i&&(e.setHashNode(this,n),i=this);const s=i.getInputType(e),o=e.getUniformFromNode(i,s,e.shaderStage,this.name||e.context.label),a=e.getPropertyName(o);return void 0!==e.context.label&&delete e.context.label,e.format(a,r,t)}}const Xl=(e,t)=>{const r=(e=>null!=e?e.nodeType||e.convertTo||("string"==typeof e?e:null):null)(t||e),n=e&&!0===e.isNode?e.node&&e.node.value||e.value:e;return Ou(new ql(n,r))};class Kl extends Ya{static get type(){return"ArrayNode"}constructor(e,t,r=null){super(e),this.count=t,this.values=r,this.isArrayNode=!0}getNodeType(e){return null===this.nodeType&&(this.nodeType=this.values[0].getNodeType(e)),this.nodeType}getElementType(e){return this.getNodeType(e)}generate(e){const t=this.getNodeType(e);return e.generateArray(t,this.count,this.values)}}uu("toArray",((e,t)=>((...e)=>{let t;if(1===e.length){const r=e[0];t=new Kl(null,r.length,r)}else{const r=e[0],n=e[1];t=new Kl(r,n)}return Ou(t)})(Array(t).fill(e))));class Yl extends Ya{static get type(){return"AssignNode"}constructor(e,t){super(),this.targetNode=e,this.sourceNode=t,this.isAssignNode=!0}hasDependencies(){return!1}getNodeType(e,t){return"void"!==t?this.targetNode.getNodeType(e):"void"}needsSplitAssign(e){const{targetNode:t}=this;if(!1===e.isAvailable("swizzleAssign")&&t.isSplitNode&&t.components.length>1){const r=e.getTypeLength(t.node.getNodeType(e));return $a.join("").slice(0,r)!==t.components}return!1}setup(e){const{targetNode:t,sourceNode:r}=this,n=e.getNodeProperties(this);n.sourceNode=r,n.targetNode=t.context({assign:!0})}generate(e,t){const{targetNode:r,sourceNode:n}=e.getNodeProperties(this),i=this.needsSplitAssign(e),s=r.getNodeType(e),o=r.build(e),a=n.build(e,s),u=n.getNodeType(e),l=e.getDataFromNode(this);let c;if(!0===l.initialized)"void"!==t&&(c=o);else if(i){const n=e.getVarFromNode(this,null,s),i=e.getPropertyName(n);e.addLineFlowCode(`${i} = ${a}`,this);const u=r.node,l=u.node.context({assign:!0}).build(e);for(let t=0;t<u.components.length;t++){const r=u.components[t];e.addLineFlowCode(`${l}.${r} = ${i}[ ${t} ]`,this)}"void"!==t&&(c=o)}else c=`${o} = ${a}`,"void"!==t&&"void"!==u||(e.addLineFlowCode(c,this),"void"!==t&&(c=o));return l.initialized=!0,e.format(c,s,t)}}uu("assign",ku(Yl).setParameterLength(2));class Ql extends Ya{static get type(){return"FunctionCallNode"}constructor(e=null,t={}){super(),this.functionNode=e,this.parameters=t}setParameters(e){return this.parameters=e,this}getParameters(){return this.parameters}getNodeType(e){return this.functionNode.getNodeType(e)}generate(e){const t=[],r=this.functionNode,n=r.getInputs(e),i=this.parameters,s=(t,r)=>{const n=r.type;let i;return i="pointer"===n?"&"+t.build(e):t.build(e,n),i};if(Array.isArray(i)){if(i.length>n.length)i.length=n.length;else if(i.length<n.length)for(;i.length<n.length;)i.push(Wu(0));for(let e=0;e<i.length;e++)t.push(s(i[e],n[e]))}else for(const o of n){const e=i[o.name];void 0!==e?t.push(s(e,o)):t.push(s(Wu(0),o))}return`${r.build(e,"property")}( ${t.join(", ")} )`}}uu("call",((e,...t)=>(t=t.length>1||t[0]&&!0===t[0].isNode?Bu(t):Lu(t[0]),Ou(new Ql(Ou(e),t)))));const Zl={"==":"equal","!=":"notEqual","<":"lessThan",">":"greaterThan","<=":"lessThanEqual",">=":"greaterThanEqual","%":"mod"};class Jl extends Ya{static get type(){return"OperatorNode"}constructor(e,t,r,...n){if(super(),n.length>0){let i=new Jl(e,t,r);for(let t=0;t<n.length-1;t++)i=new Jl(e,i,n[t]);t=i,r=n[n.length-1]}this.op=e,this.aNode=t,this.bNode=r,this.isOperatorNode=!0}getOperatorMethod(e,t){return e.getMethod(Zl[this.op],t)}getNodeType(e){const t=this.op,r=this.aNode,n=this.bNode,i=r.getNodeType(e),s=n?n.getNodeType(e):null;if("void"===i||"void"===s)return"void";if("%"===t)return i;if("~"===t||"&"===t||"|"===t||"^"===t||">>"===t||"<<"===t)return e.getIntegerType(i);if("!"===t||"&&"===t||"||"===t||"^^"===t)return"bool";if("=="===t||"!="===t||"<"===t||">"===t||"<="===t||">="===t){const t=Math.max(e.getTypeLength(i),e.getTypeLength(s));return t>1?`bvec${t}`:"bool"}if(e.isMatrix(i)){if("float"===s)return i;if(e.isVector(s))return e.getVectorFromMatrix(i);if(e.isMatrix(s))return i}else if(e.isMatrix(s)){if("float"===i)return s;if(e.isVector(i))return e.getVectorFromMatrix(s)}return e.getTypeLength(s)>e.getTypeLength(i)?s:i}generate(e,t){const r=this.op,{aNode:n,bNode:i}=this,s=this.getNodeType(e);let o=null,a=null;"void"!==s?(o=n.getNodeType(e),a=i?i.getNodeType(e):null,"<"===r||">"===r||"<="===r||">="===r||"=="===r||"!="===r?e.isVector(o)?a=o:e.isVector(a)?o=a:o!==a&&(o=a="float"):">>"===r||"<<"===r?(o=s,a=e.changeComponentType(a,"uint")):"%"===r?(o=s,a=e.isInteger(o)&&e.isInteger(a)?a:o):e.isMatrix(o)?"float"===a?a="float":e.isVector(a)?a=e.getVectorFromMatrix(o):e.isMatrix(a)||(o=a=s):o=e.isMatrix(a)?"float"===o?"float":e.isVector(o)?e.getVectorFromMatrix(a):a=s:a=s):o=a=s;const u=n.build(e,o),l=i?i.build(e,a):null,c=e.getFunctionOperator(r);if("void"!==t){const n=e.renderer.coordinateSystem===I;if("=="===r||"!="===r||"<"===r||">"===r||"<="===r||">="===r)return n&&e.isVector(o)?e.format(`${this.getOperatorMethod(e,t)}( ${u}, ${l} )`,s,t):e.format(`( ${u} ${r} ${l} )`,s,t);if("%"===r)return e.isInteger(a)?e.format(`( ${u} % ${l} )`,s,t):e.format(`${this.getOperatorMethod(e,s)}( ${u}, ${l} )`,s,t);if("!"===r||"~"===r)return e.format(`(${r}${u})`,o,t);if(c)return e.format(`${c}( ${u}, ${l} )`,s,t);if(e.isMatrix(o)&&"float"===a)return e.format(`( ${l} ${r} ${u} )`,s,t);if("float"===o&&e.isMatrix(a))return e.format(`${u} ${r} ${l}`,s,t);{let i=`( ${u} ${r} ${l} )`;return!n&&"bool"===s&&e.isVector(o)&&e.isVector(a)&&(i=`all${i}`),e.format(i,s,t)}}if("void"!==o)return c?e.format(`${c}( ${u}, ${l} )`,s,t):e.isMatrix(o)&&"float"===a?e.format(`${l} ${r} ${u}`,s,t):e.format(`${u} ${r} ${l}`,s,t)}serialize(e){super.serialize(e),e.op=this.op}deserialize(e){super.deserialize(e),this.op=e.op}}const ec=ku(Jl,"+").setParameterLength(2,1/0).setName("add"),tc=ku(Jl,"-").setParameterLength(2,1/0).setName("sub"),rc=ku(Jl,"*").setParameterLength(2,1/0).setName("mul"),nc=ku(Jl,"/").setParameterLength(2,1/0).setName("div"),ic=ku(Jl,"%").setParameterLength(2).setName("mod"),sc=ku(Jl,"==").setParameterLength(2).setName("equal"),oc=ku(Jl,"!=").setParameterLength(2).setName("notEqual"),ac=ku(Jl,"<").setParameterLength(2).setName("lessThan"),uc=ku(Jl,">").setParameterLength(2).setName("greaterThan"),lc=ku(Jl,"<=").setParameterLength(2).setName("lessThanEqual"),cc=ku(Jl,">=").setParameterLength(2).setName("greaterThanEqual"),hc=ku(Jl,"&&").setParameterLength(2,1/0).setName("and"),dc=ku(Jl,"||").setParameterLength(2,1/0).setName("or"),pc=ku(Jl,"!").setParameterLength(1).setName("not"),fc=ku(Jl,"^^").setParameterLength(2).setName("xor"),gc=ku(Jl,"&").setParameterLength(2).setName("bitAnd"),mc=ku(Jl,"~").setParameterLength(2).setName("bitNot"),yc=ku(Jl,"|").setParameterLength(2).setName("bitOr"),bc=ku(Jl,"^").setParameterLength(2).setName("bitXor"),_c=ku(Jl,"<<").setParameterLength(2).setName("shiftLeft"),vc=ku(Jl,">>").setParameterLength(2).setName("shiftRight"),xc=Vu((([e])=>(e.addAssign(1),e))),Tc=Vu((([e])=>(e.subAssign(1),e))),wc=Vu((([e])=>{const t=qu(e).toConst();return e.addAssign(1),t})),Sc=Vu((([e])=>{const t=qu(e).toConst();return e.subAssign(1),t}));uu("add",ec),uu("sub",tc),uu("mul",rc),uu("div",nc),uu("mod",ic),uu("equal",sc),uu("notEqual",oc),uu("lessThan",ac),uu("greaterThan",uc),uu("lessThanEqual",lc),uu("greaterThanEqual",cc),uu("and",hc),uu("or",dc),uu("not",pc),uu("xor",fc),uu("bitAnd",gc),uu("bitNot",mc),uu("bitOr",yc),uu("bitXor",bc),uu("shiftLeft",_c),uu("shiftRight",vc),uu("incrementBefore",xc),uu("decrementBefore",Tc),uu("increment",wc),uu("decrement",Sc);uu("remainder",((e,t)=>ic(e,t))),uu("modInt",((e,t)=>ic(qu(e),qu(t))));class Nc extends Ya{static get type(){return"MathNode"}constructor(e,t,r=null,n=null){if(super(),(e===Nc.MAX||e===Nc.MIN)&&arguments.length>3){let i=new Nc(e,t,r);for(let t=2;t<arguments.length-1;t++)i=new Nc(e,i,arguments[t]);t=i,r=arguments[arguments.length-1],n=null}this.method=e,this.aNode=t,this.bNode=r,this.cNode=n,this.isMathNode=!0}getInputType(e){const t=this.aNode.getNodeType(e),r=this.bNode?this.bNode.getNodeType(e):null,n=this.cNode?this.cNode.getNodeType(e):null,i=e.isMatrix(t)?0:e.getTypeLength(t),s=e.isMatrix(r)?0:e.getTypeLength(r),o=e.isMatrix(n)?0:e.getTypeLength(n);return i>s&&i>o?t:s>o?r:o>i?n:t}getNodeType(e){const t=this.method;return t===Nc.LENGTH||t===Nc.DISTANCE||t===Nc.DOT?"float":t===Nc.CROSS?"vec3":t===Nc.ALL||t===Nc.ANY?"bool":t===Nc.EQUALS?e.changeComponentType(this.aNode.getNodeType(e),"bool"):this.getInputType(e)}setup(e){const{aNode:t,bNode:r,method:n}=this;let i=null;if(n===Nc.ONE_MINUS)i=tc(1,t);else if(n===Nc.RECIPROCAL)i=nc(1,t);else if(n===Nc.DIFFERENCE)i=Xc(tc(t,r));else if(n===Nc.TRANSFORM_DIRECTION){let n=t,s=r;e.isMatrix(n.getNodeType(e))?s=il(el(s),0):n=il(el(n),0);const o=rc(n,s).xyz;i=Vc(o)}return null!==i?i:super.setup(e)}generate(e,t){if(e.getNodeProperties(this).outputNode)return super.generate(e,t);let r=this.method;const n=this.getNodeType(e),i=this.getInputType(e),s=this.aNode,o=this.bNode,a=this.cNode,u=e.renderer.coordinateSystem;if(r===Nc.NEGATE)return e.format("( - "+s.build(e,i)+" )",n,t);{const l=[];return r===Nc.CROSS?l.push(s.build(e,n),o.build(e,n)):u===I&&r===Nc.STEP?l.push(s.build(e,1===e.getTypeLength(s.getNodeType(e))?"float":i),o.build(e,i)):u!==I||r!==Nc.MIN&&r!==Nc.MAX?r===Nc.REFRACT?l.push(s.build(e,i),o.build(e,i),a.build(e,"float")):r===Nc.MIX?l.push(s.build(e,i),o.build(e,i),a.build(e,1===e.getTypeLength(a.getNodeType(e))?"float":i)):(u===Ne&&r===Nc.ATAN&&null!==o&&(r="atan2"),"fragment"===e.shaderStage||r!==Nc.DFDX&&r!==Nc.DFDY||(r="/*"+r+"*/"),l.push(s.build(e,i)),null!==o&&l.push(o.build(e,i)),null!==a&&l.push(a.build(e,i))):l.push(s.build(e,i),o.build(e,1===e.getTypeLength(o.getNodeType(e))?"float":i)),e.format(`${e.getMethod(r,n)}( ${l.join(", ")} )`,n,t)}}serialize(e){super.serialize(e),e.method=this.method}deserialize(e){super.deserialize(e),this.method=e.method}}Nc.ALL="all",Nc.ANY="any",Nc.RADIANS="radians",Nc.DEGREES="degrees",Nc.EXP="exp",Nc.EXP2="exp2",Nc.LOG="log",Nc.LOG2="log2",Nc.SQRT="sqrt",Nc.INVERSE_SQRT="inversesqrt",Nc.FLOOR="floor",Nc.CEIL="ceil",Nc.NORMALIZE="normalize",Nc.FRACT="fract",Nc.SIN="sin",Nc.COS="cos",Nc.TAN="tan",Nc.ASIN="asin",Nc.ACOS="acos",Nc.ATAN="atan",Nc.ABS="abs",Nc.SIGN="sign",Nc.LENGTH="length",Nc.NEGATE="negate",Nc.ONE_MINUS="oneMinus",Nc.DFDX="dFdx",Nc.DFDY="dFdy",Nc.ROUND="round",Nc.RECIPROCAL="reciprocal",Nc.TRUNC="trunc",Nc.FWIDTH="fwidth",Nc.TRANSPOSE="transpose",Nc.BITCAST="bitcast",Nc.EQUALS="equals",Nc.MIN="min",Nc.MAX="max",Nc.STEP="step",Nc.REFLECT="reflect",Nc.DISTANCE="distance",Nc.DIFFERENCE="difference",Nc.DOT="dot",Nc.CROSS="cross",Nc.POW="pow",Nc.TRANSFORM_DIRECTION="transformDirection",Nc.MIX="mix",Nc.CLAMP="clamp",Nc.REFRACT="refract",Nc.SMOOTHSTEP="smoothstep",Nc.FACEFORWARD="faceforward";const Ec=Wu(1e-6),Cc=Wu(Math.PI),Ac=ku(Nc,Nc.ALL).setParameterLength(1),Mc=ku(Nc,Nc.ANY).setParameterLength(1),Rc=ku(Nc,Nc.RADIANS).setParameterLength(1),Pc=ku(Nc,Nc.DEGREES).setParameterLength(1),Dc=ku(Nc,Nc.EXP).setParameterLength(1),Fc=ku(Nc,Nc.EXP2).setParameterLength(1),Oc=ku(Nc,Nc.LOG).setParameterLength(1),Lc=ku(Nc,Nc.LOG2).setParameterLength(1),Bc=ku(Nc,Nc.SQRT).setParameterLength(1),kc=ku(Nc,Nc.INVERSE_SQRT).setParameterLength(1),Ic=ku(Nc,Nc.FLOOR).setParameterLength(1),Uc=ku(Nc,Nc.CEIL).setParameterLength(1),Vc=ku(Nc,Nc.NORMALIZE).setParameterLength(1),jc=ku(Nc,Nc.FRACT).setParameterLength(1),Gc=ku(Nc,Nc.SIN).setParameterLength(1),zc=ku(Nc,Nc.COS).setParameterLength(1),$c=ku(Nc,Nc.TAN).setParameterLength(1),Hc=ku(Nc,Nc.ASIN).setParameterLength(1),Wc=ku(Nc,Nc.ACOS).setParameterLength(1),qc=ku(Nc,Nc.ATAN).setParameterLength(1,2),Xc=ku(Nc,Nc.ABS).setParameterLength(1),Kc=ku(Nc,Nc.SIGN).setParameterLength(1),Yc=ku(Nc,Nc.LENGTH).setParameterLength(1),Qc=ku(Nc,Nc.NEGATE).setParameterLength(1),Zc=ku(Nc,Nc.ONE_MINUS).setParameterLength(1),Jc=ku(Nc,Nc.DFDX).setParameterLength(1),eh=ku(Nc,Nc.DFDY).setParameterLength(1),th=ku(Nc,Nc.ROUND).setParameterLength(1),rh=ku(Nc,Nc.RECIPROCAL).setParameterLength(1),nh=ku(Nc,Nc.TRUNC).setParameterLength(1),ih=ku(Nc,Nc.FWIDTH).setParameterLength(1),sh=ku(Nc,Nc.TRANSPOSE).setParameterLength(1),oh=ku(Nc,Nc.MIN).setParameterLength(2,1/0),ah=ku(Nc,Nc.MAX).setParameterLength(2,1/0),uh=ku(Nc,Nc.STEP).setParameterLength(2),lh=ku(Nc,Nc.REFLECT).setParameterLength(2),ch=ku(Nc,Nc.DISTANCE).setParameterLength(2),hh=ku(Nc,Nc.DIFFERENCE).setParameterLength(2),dh=ku(Nc,Nc.DOT).setParameterLength(2),ph=ku(Nc,Nc.CROSS).setParameterLength(2),fh=ku(Nc,Nc.POW).setParameterLength(2),gh=ku(Nc,Nc.POW,2).setParameterLength(1),mh=ku(Nc,Nc.POW,3).setParameterLength(1),yh=ku(Nc,Nc.POW,4).setParameterLength(1),bh=ku(Nc,Nc.TRANSFORM_DIRECTION).setParameterLength(2),_h=e=>dh(e,e),vh=ku(Nc,Nc.MIX).setParameterLength(3),xh=(e,t=0,r=1)=>Ou(new Nc(Nc.CLAMP,Ou(e),Ou(t),Ou(r))),Th=e=>xh(e),wh=ku(Nc,Nc.REFRACT).setParameterLength(3),Sh=ku(Nc,Nc.SMOOTHSTEP).setParameterLength(3),Nh=ku(Nc,Nc.FACEFORWARD).setParameterLength(3),Eh=Vu((([e])=>{const t=dh(e.xy,Yu(12.9898,78.233)),r=ic(t,Cc);return jc(Gc(r).mul(43758.5453))}));uu("all",Ac),uu("any",Mc),uu("equals",((e,t)=>sc(e,t))),uu("radians",Rc),uu("degrees",Pc),uu("exp",Dc),uu("exp2",Fc),uu("log",Oc),uu("log2",Lc),uu("sqrt",Bc),uu("inverseSqrt",kc),uu("floor",Ic),uu("ceil",Uc),uu("normalize",Vc),uu("fract",jc),uu("sin",Gc),uu("cos",zc),uu("tan",$c),uu("asin",Hc),uu("acos",Wc),uu("atan",qc),uu("abs",Xc),uu("sign",Kc),uu("length",Yc),uu("lengthSq",_h),uu("negate",Qc),uu("oneMinus",Zc),uu("dFdx",Jc),uu("dFdy",eh),uu("round",th),uu("reciprocal",rh),uu("trunc",nh),uu("fwidth",ih),uu("atan2",((e,t)=>qc(e,t))),uu("min",oh),uu("max",ah),uu("step",uh),uu("reflect",lh),uu("distance",ch),uu("dot",dh),uu("cross",ph),uu("pow",fh),uu("pow2",gh),uu("pow3",mh),uu("pow4",yh),uu("transformDirection",bh),uu("mix",((e,t,r)=>vh(t,r,e))),uu("clamp",xh),uu("refract",wh),uu("smoothstep",((e,t,r)=>Sh(t,r,e))),uu("faceForward",Nh),uu("difference",hh),uu("saturate",Th),uu("cbrt",(e=>rc(Kc(e),fh(Xc(e),1/3)))),uu("transpose",sh),uu("rand",Eh);class Ch extends qa{static get type(){return"ConditionalNode"}constructor(e,t,r=null){super(),this.condNode=e,this.ifNode=t,this.elseNode=r}getNodeType(e){const{ifNode:t,elseNode:r}=e.getNodeProperties(this);if(void 0===t)return this.setup(e),this.getNodeType(e);const n=t.getNodeType(e);if(null!==r){const t=r.getNodeType(e);if(e.getTypeLength(t)>e.getTypeLength(n))return t}return n}setup(e){const t=this.condNode.cache(),r=this.ifNode.cache(),n=this.elseNode?this.elseNode.cache():null,i=e.context.nodeBlock;e.getDataFromNode(r).parentNodeBlock=i,null!==n&&(e.getDataFromNode(n).parentNodeBlock=i);const s=e.getNodeProperties(this);s.condNode=t,s.ifNode=r.context({nodeBlock:r}),s.elseNode=n?n.context({nodeBlock:n}):null}generate(e,t){const r=this.getNodeType(e),n=e.getDataFromNode(this);if(void 0!==n.nodeProperty)return n.nodeProperty;const{condNode:i,ifNode:s,elseNode:o}=e.getNodeProperties(this),a=e.currentFunctionNode,u="void"!==t,l=u?dl(r).build(e):"";n.nodeProperty=l;const c=i.build(e,"bool");e.addFlowCode(`\n${e.tab}if ( ${c} ) {\n\n`).addFlowTab();let h=s.build(e,r);if(h&&(u?h=l+" = "+h+";":(h="return "+h+";",null===a&&(h="// "+h))),e.removeFlowTab().addFlowCode(e.tab+"\t"+h+"\n\n"+e.tab+"}"),null!==o){e.addFlowCode(" else {\n\n").addFlowTab();let t=o.build(e,r);t&&(u?t=l+" = "+t+";":(t="return "+t+";",null===a&&(t="// "+t))),e.removeFlowTab().addFlowCode(e.tab+"\t"+t+"\n\n"+e.tab+"}\n\n")}else e.addFlowCode("\n\n");return e.format(l,r,t)}}const Ah=ku(Ch).setParameterLength(2,3);uu("select",Ah);uu("cond",((...e)=>Ah(...e)));class Mh extends qa{static get type(){return"ContextNode"}constructor(e,t={}){super(),this.isContextNode=!0,this.node=e,this.value=t}getScope(){return this.node.getScope()}getNodeType(e){return this.node.getNodeType(e)}analyze(e){const t=e.getContext();e.setContext({...e.context,...this.value}),this.node.build(e),e.setContext(t)}setup(e){const t=e.getContext();e.setContext({...e.context,...this.value}),this.node.build(e),e.setContext(t)}generate(e,t){const r=e.getContext();e.setContext({...e.context,...this.value});const n=this.node.build(e,t);return e.setContext(r),n}}const Rh=ku(Mh).setParameterLength(1,2);uu("context",Rh),uu("label",((e,t)=>Rh(e,{label:t})));class Ph extends qa{static get type(){return"VarNode"}constructor(e,t=null,r=!1){super(),this.node=e,this.name=t,this.global=!0,this.isVarNode=!0,this.readOnly=r,this.parents=!0}getMemberType(e,t){return this.node.getMemberType(e,t)}getElementType(e){return this.node.getElementType(e)}getNodeType(e){return this.node.getNodeType(e)}generate(e){const{node:t,name:r,readOnly:n}=this,{renderer:i}=e,s=!0===i.backend.isWebGPUBackend;let o=!1,a=!1;n&&(o=e.isDeterministic(t),a=s?n:o);const u=e.getVectorType(this.getNodeType(e)),l=t.build(e,u),c=e.getVarFromNode(this,r,u,void 0,a),h=e.getPropertyName(c);let d=h;if(a)if(s)d=o?`const ${h}`:`let ${h}`;else{const r=e.getArrayCount(t);d=`const ${e.getVar(c.type,h,r)}`}return e.addLineFlowCode(`${d} = ${l}`,this),h}}const Dh=ku(Ph);uu("toVar",((e,t=null)=>Dh(e,t).toStack())),uu("toConst",((e,t=null)=>Dh(e,t,!0).toStack()));uu("temp",(e=>Dh(e)));class Fh extends qa{static get type(){return"VaryingNode"}constructor(e,t=null){super(),this.node=e,this.name=t,this.isVaryingNode=!0,this.interpolationType=null,this.interpolationSampling=null,this.global=!0}setInterpolation(e,t=null){return this.interpolationType=e,this.interpolationSampling=t,this}getHash(e){return this.name||super.getHash(e)}getNodeType(e){return this.node.getNodeType(e)}setupVarying(e){const t=e.getNodeProperties(this);let r=t.varying;if(void 0===r){const n=this.name,i=this.getNodeType(e),s=this.interpolationType,o=this.interpolationSampling;t.varying=r=e.getVaryingFromNode(this,n,i,s,o),t.node=this.node}return r.needsInterpolation||(r.needsInterpolation="fragment"===e.shaderStage),r}setup(e){this.setupVarying(e),e.flowNodeFromShaderStage(Oa,this.node)}analyze(e){this.setupVarying(e),e.flowNodeFromShaderStage(Oa,this.node)}generate(e){const t=e.getNodeProperties(this),r=this.setupVarying(e);if(void 0===t.propertyName){const n=this.getNodeType(e),i=e.getPropertyName(r,Oa);e.flowNodeFromShaderStage(Oa,this.node,n,i),t.propertyName=i}return e.getPropertyName(r)}}const Oh=ku(Fh).setParameterLength(1,2);uu("toVarying",Oh),uu("toVertexStage",(e=>Oh(e))),uu("varying",((...e)=>Oh(...e))),uu("vertexStage",((...e)=>Oh(...e)));const Lh=Vu((([e])=>{const t=e.mul(.9478672986).add(.0521327014).pow(2.4),r=e.mul(.0773993808),n=e.lessThanEqual(.04045);return vh(t,r,n)})).setLayout({name:"sRGBTransferEOTF",type:"vec3",inputs:[{name:"color",type:"vec3"}]}),Bh=Vu((([e])=>{const t=e.pow(.41666).mul(1.055).sub(.055),r=e.mul(12.92),n=e.lessThanEqual(.0031308);return vh(t,r,n)})).setLayout({name:"sRGBTransferOETF",type:"vec3",inputs:[{name:"color",type:"vec3"}]}),kh="WorkingColorSpace";class Ih extends Ya{static get type(){return"ColorSpaceNode"}constructor(e,t,r){super("vec4"),this.colorNode=e,this.source=t,this.target=r}resolveColorSpace(e,t){return t===kh?qe.workingColorSpace:"OutputColorSpace"===t?e.context.outputColorSpace||e.renderer.outputColorSpace:t}setup(e){const{colorNode:t}=this,r=this.resolveColorSpace(e,this.source),n=this.resolveColorSpace(e,this.target);let i=t;return!1!==qe.enabled&&r!==n&&r&&n?(qe.getTransfer(r)===Xe&&(i=il(Lh(i.rgb),i.a)),qe.getPrimaries(r)!==qe.getPrimaries(n)&&(i=il(ll(qe._getMatrix(new Se,r,n)).mul(i.rgb),i.a)),qe.getTransfer(n)===Xe&&(i=il(Bh(i.rgb),i.a)),i):i}}const Uh=(e,t)=>Ou(new Ih(Ou(e),t,kh));uu("workingToColorSpace",((e,t)=>Ou(new Ih(Ou(e),kh,t)))),uu("colorSpaceToWorking",Uh);let Vh=class extends Xa{static get type(){return"ReferenceElementNode"}constructor(e,t){super(e,t),this.referenceNode=e,this.isReferenceElementNode=!0}getNodeType(){return this.referenceNode.uniformType}generate(e){const t=super.generate(e),r=this.referenceNode.getNodeType(),n=this.getNodeType();return e.format(t,r,n)}};class jh extends qa{static get type(){return"ReferenceBaseNode"}constructor(e,t,r=null,n=null){super(),this.property=e,this.uniformType=t,this.object=r,this.count=n,this.properties=e.split("."),this.reference=r,this.node=null,this.group=null,this.updateType=Ia}setGroup(e){return this.group=e,this}element(e){return Ou(new Vh(this,Ou(e)))}setNodeType(e){const t=Xl(null,e).getSelf();null!==this.group&&t.setGroup(this.group),this.node=t}getNodeType(e){return null===this.node&&(this.updateReference(e),this.updateValue()),this.node.getNodeType(e)}getValueFromReference(e=this.reference){const{properties:t}=this;let r=e[t[0]];for(let n=1;n<t.length;n++)r=r[t[n]];return r}updateReference(e){return this.reference=null!==this.object?this.object:e.object,this.reference}setup(){return this.updateValue(),this.node}update(){this.updateValue()}updateValue(){null===this.node&&this.setNodeType(this.uniformType);const e=this.getValueFromReference();Array.isArray(e)?this.node.array=e:this.node.value=e}}class Gh extends jh{static get type(){return"RendererReferenceNode"}constructor(e,t,r=null){super(e,t,r),this.renderer=r,this.setGroup(Hl)}updateReference(e){return this.reference=null!==this.renderer?this.renderer:e.renderer,this.reference}}const zh=(e,t,r=null)=>Ou(new Gh(e,t,r));class $h extends Ya{static get type(){return"ToneMappingNode"}constructor(e,t=Hh,r=null){super("vec3"),this.toneMapping=e,this.exposureNode=t,this.colorNode=r}customCacheKey(){return Ea(this.toneMapping)}setup(e){const t=this.colorNode||e.context.color,r=this.toneMapping;if(r===N)return t;let n=null;const i=e.renderer.library.getToneMappingFunction(r);return n=null!==i?il(i(t.rgb,this.exposureNode),t.a):t,n}}const Hh=zh("toneMappingExposure","float");uu("toneMapping",((e,t,r)=>((e,t,r)=>Ou(new $h(e,Ou(t),Ou(r))))(t,r,e)));class Wh extends ru{static get type(){return"BufferAttributeNode"}constructor(e,t=null,r=0,n=0){super(e,t),this.isBufferNode=!0,this.bufferType=t,this.bufferStride=r,this.bufferOffset=n,this.usage=gn,this.instanced=!1,this.attribute=null,this.global=!0,e&&!0===e.isBufferAttribute&&(this.attribute=e,this.usage=e.usage,this.instanced=e.isInstancedBufferAttribute)}getHash(e){if(0===this.bufferStride&&0===this.bufferOffset){let t=e.globalCache.getData(this.value);return void 0===t&&(t={node:this},e.globalCache.setData(this.value,t)),t.node.uuid}return this.uuid}getNodeType(e){return null===this.bufferType&&(this.bufferType=e.getTypeFromAttribute(this.attribute)),this.bufferType}setup(e){if(null!==this.attribute)return;const t=this.getNodeType(e),r=this.value,n=e.getTypeLength(t),i=this.bufferStride||n,s=this.bufferOffset,o=!0===r.isInterleavedBuffer?r:new mn(r,i),a=new yn(o,n,s);o.setUsage(this.usage),this.attribute=a,this.attribute.isInstancedBufferAttribute=this.instanced}generate(e){const t=this.getNodeType(e),r=e.getBufferAttributeFromNode(this,t),n=e.getPropertyName(r);let i=null;if("vertex"===e.shaderStage||"compute"===e.shaderStage)this.name=n,i=n;else{i=Oh(this).build(e,t)}return i}getInputType(){return"bufferAttribute"}setUsage(e){return this.usage=e,this.attribute&&!0===this.attribute.isBufferAttribute&&(this.attribute.usage=e),this}setInstanced(e){return this.instanced=e,this}}const qh=(e,t=null,r=0,n=0)=>Ou(new Wh(e,t,r,n)),Xh=(e,t=null,r=0,n=0)=>qh(e,t,r,n).setInstanced(!0),Kh=(e,t=null,r=0,n=0)=>((e,t=null,r=0,n=0)=>qh(e,t,r,n).setUsage(Te))(e,t,r,n).setInstanced(!0);uu("toAttribute",(e=>qh(e.value)));class Yh extends qa{static get type(){return"ComputeNode"}constructor(e,t,r=[64]){super("void"),this.isComputeNode=!0,this.computeNode=e,this.count=t,this.workgroupSize=r,this.dispatchCount=0,this.version=1,this.name="",this.updateBeforeType=Ia,this.onInitFunction=null,this.updateDispatchCount()}dispose(){this.dispatchEvent({type:"dispose"})}label(e){return this.name=e,this}updateDispatchCount(){const{count:e,workgroupSize:t}=this;let r=t[0];for(let n=1;n<t.length;n++)r*=t[n];this.dispatchCount=Math.ceil(e/r)}onInit(e){return this.onInitFunction=e,this}updateBefore({renderer:e}){e.compute(this)}setup(e){const t=this.computeNode.build(e);if(t){e.getNodeProperties(this).outputComputeNode=t.outputNode,t.outputNode=null}return t}generate(e,t){const{shaderStage:r}=e;if("compute"===r){const t=this.computeNode.build(e,"void");""!==t&&e.addLineFlowCode(t,this)}else{const r=e.getNodeProperties(this).outputComputeNode;if(r)return r.build(e,t)}}}uu("compute",((e,t,r)=>Ou(new Yh(Ou(e),t,r))));class Qh extends qa{static get type(){return"CacheNode"}constructor(e,t=!0){super(),this.node=e,this.parent=t,this.isCacheNode=!0}getNodeType(e){const t=e.getCache(),r=e.getCacheFromNode(this,this.parent);e.setCache(r);const n=this.node.getNodeType(e);return e.setCache(t),n}build(e,...t){const r=e.getCache(),n=e.getCacheFromNode(this,this.parent);e.setCache(n);const i=this.node.build(e,...t);return e.setCache(r),i}}const Zh=(e,t)=>Ou(new Qh(Ou(e),t));uu("cache",Zh);class Jh extends qa{static get type(){return"BypassNode"}constructor(e,t){super(),this.isBypassNode=!0,this.outputNode=e,this.callNode=t}getNodeType(e){return this.outputNode.getNodeType(e)}generate(e){const t=this.callNode.build(e,"void");return""!==t&&e.addLineFlowCode(t,this),this.outputNode.build(e)}}uu("bypass",ku(Jh).setParameterLength(2));class ed extends qa{static get type(){return"RemapNode"}constructor(e,t,r,n=Wu(0),i=Wu(1)){super(),this.node=e,this.inLowNode=t,this.inHighNode=r,this.outLowNode=n,this.outHighNode=i,this.doClamp=!0}setup(){const{node:e,inLowNode:t,inHighNode:r,outLowNode:n,outHighNode:i,doClamp:s}=this;let o=e.sub(t).div(r.sub(t));return!0===s&&(o=o.clamp()),o.mul(i.sub(n)).add(n)}}const td=ku(ed,null,null,{doClamp:!1}).setParameterLength(3,5),rd=ku(ed).setParameterLength(3,5);uu("remap",td),uu("remapClamp",rd);class nd extends qa{static get type(){return"ExpressionNode"}constructor(e="",t="void"){super(t),this.snippet=e}generate(e,t){const r=this.getNodeType(e),n=this.snippet;if("void"!==r)return e.format(n,r,t);e.addLineFlowCode(n,this)}}const id=ku(nd).setParameterLength(1,2);uu("discard",(e=>(e?Ah(e,id("discard")):id("discard")).toStack()));class sd extends Ya{static get type(){return"RenderOutputNode"}constructor(e,t,r){super("vec4"),this.colorNode=e,this.toneMapping=t,this.outputColorSpace=r,this.isRenderOutputNode=!0}setup({context:e}){let t=this.colorNode||e.color;const r=(null!==this.toneMapping?this.toneMapping:e.toneMapping)||N,n=(null!==this.outputColorSpace?this.outputColorSpace:e.outputColorSpace)||Ke;return r!==N&&(t=t.toneMapping(r)),n!==Ke&&n!==qe.workingColorSpace&&(t=t.workingToColorSpace(n)),t}}uu("renderOutput",((e,t=null,r=null)=>Ou(new sd(Ou(e),t,r))));class od extends Ya{static get type(){return"DebugNode"}constructor(e,t=null){super(),this.node=e,this.callback=t}getNodeType(e){return this.node.getNodeType(e)}setup(e){return this.node.build(e)}analyze(e){return this.node.build(e)}generate(e){const t=this.callback,r=this.node.build(e),n="--- TSL debug - "+e.shaderStage+" shader ---",i="-".repeat(n.length);let s="";return s+="// #"+n+"#\n",s+=e.flow.code.replace(/^\t/gm,"")+"\n",s+="/* ... */ "+r+" /* ... */\n",s+="// #"+i+"#\n",null!==t&&t(e,s),r}}uu("debug",((e,t=null)=>Ou(new od(Ou(e),t))));class ad extends qa{static get type(){return"AttributeNode"}constructor(e,t=null){super(t),this.global=!0,this._attributeName=e}getHash(e){return this.getAttributeName(e)}getNodeType(e){let t=this.nodeType;if(null===t){const r=this.getAttributeName(e);if(e.hasGeometryAttribute(r)){const n=e.geometry.getAttribute(r);t=e.getTypeFromAttribute(n)}else t="float"}return t}setAttributeName(e){return this._attributeName=e,this}getAttributeName(){return this._attributeName}generate(e){const t=this.getAttributeName(e),r=this.getNodeType(e);if(!0===e.hasGeometryAttribute(t)){const n=e.geometry.getAttribute(t),i=e.getTypeFromAttribute(n),s=e.getAttribute(t,i);if("vertex"===e.shaderStage)return e.format(s.name,i,r);return Oh(this).build(e,r)}return e.generateConst(r)}serialize(e){super.serialize(e),e.global=this.global,e._attributeName=this._attributeName}deserialize(e){super.deserialize(e),this.global=e.global,this._attributeName=e._attributeName}}const ud=(e,t=null)=>Ou(new ad(e,t)),ld=(e=0)=>ud("uv"+(e>0?e:""),"vec2");class cd extends qa{static get type(){return"TextureSizeNode"}constructor(e,t=null){super("uvec2"),this.isTextureSizeNode=!0,this.textureNode=e,this.levelNode=t}generate(e,t){const r=this.textureNode.build(e,"property"),n=null===this.levelNode?"0":this.levelNode.build(e,"int");return e.format(`${e.getMethod("textureDimensions")}( ${r}, ${n} )`,this.getNodeType(e),t)}}const hd=ku(cd).setParameterLength(1,2);class dd extends ql{static get type(){return"MaxMipLevelNode"}constructor(e){super(0),this._textureNode=e,this.updateType=Ba}get textureNode(){return this._textureNode}get texture(){return this._textureNode.value}update(){const e=this.texture,t=e.images,r=t&&t.length>0?t[0]&&t[0].image||t[0]:e.image;if(r&&void 0!==r.width){const{width:e,height:t}=r;this.value=Math.log2(Math.max(e,t))}}}const pd=ku(dd).setParameterLength(1),fd=new xe;class gd extends ql{static get type(){return"TextureNode"}constructor(e=fd,t=null,r=null,n=null){super(e),this.isTextureNode=!0,this.uvNode=t,this.levelNode=r,this.biasNode=n,this.compareNode=null,this.depthNode=null,this.gradNode=null,this.sampler=!0,this.updateMatrix=!1,this.updateType=La,this.referenceNode=null,this._value=e,this._matrixUniform=null,this.setUpdateMatrix(null===t)}set value(e){this.referenceNode?this.referenceNode.value=e:this._value=e}get value(){return this.referenceNode?this.referenceNode.value:this._value}getUniformHash(){return this.value.uuid}getNodeType(){return!0===this.value.isDepthTexture?"float":this.value.type===ue?"uvec4":this.value.type===Me?"ivec4":"vec4"}getInputType(){return"texture"}getDefaultUV(){return ld(this.value.channel)}updateReference(){return this.value}getTransformedUV(e){return null===this._matrixUniform&&(this._matrixUniform=Xl(this.value.matrix)),this._matrixUniform.mul(el(e,1)).xy}setUpdateMatrix(e){return this.updateMatrix=e,this.updateType=e?Ia:La,this}setupUV(e,t){const r=this.value;return e.isFlipY()&&(r.image instanceof ImageBitmap&&!0===r.flipY||!0===r.isRenderTargetTexture||!0===r.isFramebufferTexture||!0===r.isDepthTexture)&&(t=this.sampler?t.flipY():t.setY(qu(hd(this,this.levelNode).y).sub(t.y).sub(1))),t}setup(e){const t=e.getNodeProperties(this);t.referenceNode=this.referenceNode;const r=this.value;if(!r||!0!==r.isTexture)throw new Error("THREE.TSL: `texture( value )` function expects a valid instance of THREE.Texture().");let n=this.uvNode;null!==n&&!0!==e.context.forceUVContext||!e.context.getUV||(n=e.context.getUV(this,e)),n||(n=this.getDefaultUV()),!0===this.updateMatrix&&(n=this.getTransformedUV(n)),n=this.setupUV(e,n);let i=this.levelNode;null===i&&e.context.getTextureLevel&&(i=e.context.getTextureLevel(this)),t.uvNode=n,t.levelNode=i,t.biasNode=this.biasNode,t.compareNode=this.compareNode,t.gradNode=this.gradNode,t.depthNode=this.depthNode}generateUV(e,t){return t.build(e,!0===this.sampler?"vec2":"ivec2")}generateSnippet(e,t,r,n,i,s,o,a){const u=this.value;let l;return l=n?e.generateTextureLevel(u,t,r,n,s):i?e.generateTextureBias(u,t,r,i,s):a?e.generateTextureGrad(u,t,r,a,s):o?e.generateTextureCompare(u,t,r,o,s):!1===this.sampler?e.generateTextureLoad(u,t,r,s):e.generateTexture(u,t,r,s),l}generate(e,t){const r=this.value,n=e.getNodeProperties(this),i=super.generate(e,"property");if(/^sampler/.test(t))return i+"_sampler";if(e.isReference(t))return i;{const s=e.getDataFromNode(this);let o=s.propertyName;if(void 0===o){const{uvNode:t,levelNode:r,biasNode:a,compareNode:u,depthNode:l,gradNode:c}=n,h=this.generateUV(e,t),d=r?r.build(e,"float"):null,p=a?a.build(e,"float"):null,f=l?l.build(e,"int"):null,g=u?u.build(e,"float"):null,m=c?[c[0].build(e,"vec2"),c[1].build(e,"vec2")]:null,y=e.getVarFromNode(this);o=e.getPropertyName(y);const b=this.generateSnippet(e,i,h,d,p,f,g,m);e.addLineFlowCode(`${o} = ${b}`,this),s.snippet=b,s.propertyName=o}let a=o;const u=this.getNodeType(e);return e.needsToWorkingColorSpace(r)&&(a=Uh(id(a,u),r.colorSpace).setup(e).build(e,u)),e.format(a,u,t)}}setSampler(e){return this.sampler=e,this}getSampler(){return this.sampler}uv(e){return this.sample(e)}sample(e){const t=this.clone();return t.uvNode=Ou(e),t.referenceNode=this.getSelf(),Ou(t)}blur(e){const t=this.clone();t.biasNode=Ou(e).mul(pd(t)),t.referenceNode=this.getSelf();const r=t.value;return!1===t.generateMipmaps&&(r&&!1===r.generateMipmaps||r.minFilter===ke||r.magFilter===ke)&&(t.biasNode=null),Ou(t)}level(e){const t=this.clone();return t.levelNode=Ou(e),t.referenceNode=this.getSelf(),Ou(t)}size(e){return hd(this,e)}bias(e){const t=this.clone();return t.biasNode=Ou(e),t.referenceNode=this.getSelf(),Ou(t)}compare(e){const t=this.clone();return t.compareNode=Ou(e),t.referenceNode=this.getSelf(),Ou(t)}grad(e,t){const r=this.clone();return r.gradNode=[Ou(e),Ou(t)],r.referenceNode=this.getSelf(),Ou(r)}depth(e){const t=this.clone();return t.depthNode=Ou(e),t.referenceNode=this.getSelf(),Ou(t)}serialize(e){super.serialize(e),e.value=this.value.toJSON(e.meta).uuid,e.sampler=this.sampler,e.updateMatrix=this.updateMatrix,e.updateType=this.updateType}deserialize(e){super.deserialize(e),this.value=e.meta.textures[e.value],this.sampler=e.sampler,this.updateMatrix=e.updateMatrix,this.updateType=e.updateType}update(){const e=this.value,t=this._matrixUniform;null!==t&&(t.value=e.matrix),!0===e.matrixAutoUpdate&&e.updateMatrix()}clone(){const e=new this.constructor(this.value,this.uvNode,this.levelNode,this.biasNode);return e.sampler=this.sampler,e.depthNode=this.depthNode,e.compareNode=this.compareNode,e.gradNode=this.gradNode,e}}const md=ku(gd).setParameterLength(1,4).setName("texture"),yd=(e=fd,t=null,r=null,n=null)=>{let i;return e&&!0===e.isTextureNode?(i=Ou(e.clone()),i.referenceNode=e.getSelf(),null!==t&&(i.uvNode=Ou(t)),null!==r&&(i.levelNode=Ou(r)),null!==n&&(i.biasNode=Ou(n))):i=md(e,t,r,n),i},bd=(...e)=>yd(...e).setSampler(!1);class _d extends ql{static get type(){return"BufferNode"}constructor(e,t,r=0){super(e,t),this.isBufferNode=!0,this.bufferType=t,this.bufferCount=r}getElementType(e){return this.getNodeType(e)}getInputType(){return"buffer"}}const vd=(e,t,r)=>Ou(new _d(e,t,r));class xd extends Xa{static get type(){return"UniformArrayElementNode"}constructor(e,t){super(e,t),this.isArrayBufferElementNode=!0}generate(e){const t=super.generate(e),r=this.getNodeType(),n=this.node.getPaddedType();return e.format(t,n,r)}}class Td extends _d{static get type(){return"UniformArrayNode"}constructor(e,t=null){super(null),this.array=e,this.elementType=null===t?Pa(e[0]):t,this.paddedType=this.getPaddedType(),this.updateType=ka,this.isArrayBufferNode=!0}getNodeType(){return this.paddedType}getElementType(){return this.elementType}getPaddedType(){const e=this.elementType;let t="vec4";return"mat2"===e?t="mat2":!0===/mat/.test(e)?t="mat4":"i"===e.charAt(0)?t="ivec4":"u"===e.charAt(0)&&(t="uvec4"),t}update(){const{array:e,value:t}=this,r=this.elementType;if("float"===r||"int"===r||"uint"===r)for(let n=0;n<e.length;n++){t[4*n]=e[n]}else if("color"===r)for(let n=0;n<e.length;n++){const r=4*n,i=e[n];t[r]=i.r,t[r+1]=i.g,t[r+2]=i.b||0}else if("mat2"===r)for(let n=0;n<e.length;n++){const r=4*n,i=e[n];t[r]=i.elements[0],t[r+1]=i.elements[1],t[r+2]=i.elements[2],t[r+3]=i.elements[3]}else if("mat3"===r)for(let n=0;n<e.length;n++){const r=16*n,i=e[n];t[r]=i.elements[0],t[r+1]=i.elements[1],t[r+2]=i.elements[2],t[r+4]=i.elements[3],t[r+5]=i.elements[4],t[r+6]=i.elements[5],t[r+8]=i.elements[6],t[r+9]=i.elements[7],t[r+10]=i.elements[8],t[r+15]=1}else if("mat4"===r)for(let n=0;n<e.length;n++){const r=16*n,i=e[n];for(let e=0;e<i.elements.length;e++)t[r+e]=i.elements[e]}else for(let n=0;n<e.length;n++){const r=4*n,i=e[n];t[r]=i.x,t[r+1]=i.y,t[r+2]=i.z||0,t[r+3]=i.w||0}}setup(e){const t=this.array.length,r=this.elementType;let n=Float32Array;const i=this.paddedType,s=e.getTypeLength(i);return"i"===r.charAt(0)&&(n=Int32Array),"u"===r.charAt(0)&&(n=Uint32Array),this.value=new n(t*s),this.bufferCount=t,this.bufferType=i,super.setup(e)}element(e){return Ou(new xd(this,Ou(e)))}}const wd=(e,t)=>Ou(new Td(e,t));const Sd=ku(class extends qa{constructor(e){super("float"),this.name=e,this.isBuiltinNode=!0}generate(){return this.name}}).setParameterLength(1),Nd=Xl(0,"uint").label("u_cameraIndex").setGroup(zl("cameraIndex")).toVarying("v_cameraIndex"),Ed=Xl("float").label("cameraNear").setGroup(Hl).onRenderUpdate((({camera:e})=>e.near)),Cd=Xl("float").label("cameraFar").setGroup(Hl).onRenderUpdate((({camera:e})=>e.far)),Ad=Vu((({camera:e})=>{let t;if(e.isArrayCamera&&e.cameras.length>0){const r=[];for(const t of e.cameras)r.push(t.projectionMatrix);t=wd(r).setGroup(Hl).label("cameraProjectionMatrices").element(e.isMultiViewCamera?Sd("gl_ViewID_OVR"):Nd).toVar("cameraProjectionMatrix")}else t=Xl("mat4").label("cameraProjectionMatrix").setGroup(Hl).onRenderUpdate((({camera:e})=>e.projectionMatrix));return t})).once()(),Md=Vu((({camera:e})=>{let t;if(e.isArrayCamera&&e.cameras.length>0){const r=[];for(const t of e.cameras)r.push(t.matrixWorldInverse);t=wd(r).setGroup(Hl).label("cameraViewMatrices").element(e.isMultiViewCamera?Sd("gl_ViewID_OVR"):Nd).toVar("cameraViewMatrix")}else t=Xl("mat4").label("cameraViewMatrix").setGroup(Hl).onRenderUpdate((({camera:e})=>e.matrixWorldInverse));return t})).once()(),Rd=Xl(new o).label("cameraPosition").setGroup(Hl).onRenderUpdate((({camera:e},t)=>t.value.setFromMatrixPosition(e.matrixWorld))),Pd=new hn;class Dd extends qa{static get type(){return"Object3DNode"}constructor(e,t=null){super(),this.scope=e,this.object3d=t,this.updateType=Ia,this.uniformNode=new ql(null)}getNodeType(){const e=this.scope;return e===Dd.WORLD_MATRIX?"mat4":e===Dd.POSITION||e===Dd.VIEW_POSITION||e===Dd.DIRECTION||e===Dd.SCALE?"vec3":e===Dd.RADIUS?"float":void 0}update(e){const t=this.object3d,r=this.uniformNode,n=this.scope;if(n===Dd.WORLD_MATRIX)r.value=t.matrixWorld;else if(n===Dd.POSITION)r.value=r.value||new o,r.value.setFromMatrixPosition(t.matrixWorld);else if(n===Dd.SCALE)r.value=r.value||new o,r.value.setFromMatrixScale(t.matrixWorld);else if(n===Dd.DIRECTION)r.value=r.value||new o,t.getWorldDirection(r.value);else if(n===Dd.VIEW_POSITION){const n=e.camera;r.value=r.value||new o,r.value.setFromMatrixPosition(t.matrixWorld),r.value.applyMatrix4(n.matrixWorldInverse)}else if(n===Dd.RADIUS){const n=e.object.geometry;null===n.boundingSphere&&n.computeBoundingSphere(),Pd.copy(n.boundingSphere).applyMatrix4(t.matrixWorld),r.value=Pd.radius}}generate(e){const t=this.scope;return t===Dd.WORLD_MATRIX?this.uniformNode.nodeType="mat4":t===Dd.POSITION||t===Dd.VIEW_POSITION||t===Dd.DIRECTION||t===Dd.SCALE?this.uniformNode.nodeType="vec3":t===Dd.RADIUS&&(this.uniformNode.nodeType="float"),this.uniformNode.build(e)}serialize(e){super.serialize(e),e.scope=this.scope}deserialize(e){super.deserialize(e),this.scope=e.scope}}Dd.WORLD_MATRIX="worldMatrix",Dd.POSITION="position",Dd.SCALE="scale",Dd.VIEW_POSITION="viewPosition",Dd.DIRECTION="direction",Dd.RADIUS="radius";const Fd=ku(Dd,Dd.POSITION).setParameterLength(1);class Od extends Dd{static get type(){return"ModelNode"}constructor(e){super(e)}update(e){this.object3d=e.object,super.update(e)}}const Ld=Iu(Od,Od.WORLD_MATRIX),Bd=Xl(new Se).onObjectUpdate((({object:e},t)=>t.value.getNormalMatrix(e.matrixWorld))),kd=Vu((e=>e.renderer.overrideNodes.modelViewMatrix||Id)).once()().toVar("modelViewMatrix"),Id=Md.mul(Ld),Ud=Vu((e=>(e.context.isHighPrecisionModelViewMatrix=!0,Xl("mat4").onObjectUpdate((({object:e,camera:t})=>e.modelViewMatrix.multiplyMatrices(t.matrixWorldInverse,e.matrixWorld)))))).once()().toVar("highpModelViewMatrix"),Vd=Vu((e=>{const t=e.context.isHighPrecisionModelViewMatrix;return Xl("mat3").onObjectUpdate((({object:e,camera:r})=>(!0!==t&&e.modelViewMatrix.multiplyMatrices(r.matrixWorldInverse,e.matrixWorld),e.normalMatrix.getNormalMatrix(e.modelViewMatrix))))})).once()().toVar("highpModelNormalViewMatrix"),jd=ud("position","vec3"),Gd=jd.toVarying("positionLocal"),zd=jd.toVarying("positionPrevious"),$d=Vu((e=>Ld.mul(Gd).xyz.toVarying(e.getNamespace("v_positionWorld"))),"vec3").once("POSITION")(),Hd=Vu((e=>Gd.transformDirection(Ld).toVarying(e.getNamespace("v_positionWorldDirection")).normalize().toVar("positionWorldDirection")),"vec3").once("POSITION")(),Wd=Vu((e=>e.context.setupPositionView().toVarying(e.getNamespace("v_positionView"))),"vec3").once("POSITION")(),qd=Wd.negate().toVarying("v_positionViewDirection").normalize().toVar("positionViewDirection");class Xd extends qa{static get type(){return"FrontFacingNode"}constructor(){super("bool"),this.isFrontFacingNode=!0}generate(e){const{renderer:t,material:r}=e;return t.coordinateSystem===I&&r.side===L?"false":e.getFrontFacing()}}const Kd=Wu(Iu(Xd)).mul(2).sub(1),Yd=ud("normal","vec3"),Qd=Vu((e=>!1===e.geometry.hasAttribute("normal")?el(0,1,0):Yd),"vec3").once()().toVar("normalLocal"),Zd=Wd.dFdx().cross(Wd.dFdy()).normalize().toVar("normalFlat"),Jd=Vu((e=>{let t;return t=!0===e.material.flatShading?Zd:Oh(sp(Qd),"v_normalView").normalize(),t}),"vec3").once()().toVar("normalView"),ep=Vu((e=>{let t=Jd.transformDirection(Md);return!0!==e.material.flatShading&&(t=Oh(t,"v_normalWorld")),t}),"vec3").once()().normalize().toVar("normalWorld"),tp=Vu((e=>{let t=e.context.setupNormal().context({getUV:null});return!0!==e.material.flatShading&&(t=t.mul(Kd)),t}),"vec3").once()().toVar("transformedNormalView"),rp=tp.transformDirection(Md).toVar("transformedNormalWorld"),np=Vu((e=>{let t=e.context.setupClearcoatNormal().context({getUV:null});return!0!==e.material.flatShading&&(t=t.mul(Kd)),t}),"vec3").once()().toVar("transformedClearcoatNormalView"),ip=Vu((([e,t=Ld])=>{const r=ll(t),n=e.div(el(r[0].dot(r[0]),r[1].dot(r[1]),r[2].dot(r[2])));return r.mul(n).xyz})),sp=Vu((([e],t)=>{const r=t.renderer.overrideNodes.modelNormalViewMatrix;if(null!==r)return r.transformDirection(e);const n=Bd.mul(e);return Md.transformDirection(n)})),op=new tn,ap=new a,up=Xl(0).onReference((({material:e})=>e)).onObjectUpdate((({material:e})=>e.refractionRatio)),lp=Xl(1).onReference((({material:e})=>e)).onObjectUpdate((function({material:e,scene:t}){return e.envMap?e.envMapIntensity:t.environmentIntensity})),cp=Xl(new a).onReference((function(e){return e.material})).onObjectUpdate((function({material:e,scene:t}){const r=null!==t.environment&&null===e.envMap?t.environmentRotation:e.envMapRotation;return r?(op.copy(r),ap.makeRotationFromEuler(op)):ap.identity(),ap})),hp=qd.negate().reflect(tp),dp=qd.negate().refract(tp,up),pp=hp.transformDirection(Md).toVar("reflectVector"),fp=dp.transformDirection(Md).toVar("reflectVector"),gp=new ve;class mp extends gd{static get type(){return"CubeTextureNode"}constructor(e,t=null,r=null,n=null){super(e,t,r,n),this.isCubeTextureNode=!0}getInputType(){return"cubeTexture"}getDefaultUV(){const e=this.value;return e.mapping===ln?pp:e.mapping===cn?fp:el(0,0,0)}setUpdateMatrix(){}setupUV(e,t){const r=this.value;return e.renderer.coordinateSystem!==Ne&&r.isRenderTargetTexture||(t=el(t.x.negate(),t.yz)),cp.mul(t)}generateUV(e,t){return t.build(e,"vec3")}}const yp=ku(mp).setParameterLength(1,4).setName("cubeTexture"),bp=(e=gp,t=null,r=null,n=null)=>{let i;return e&&!0===e.isCubeTextureNode?(i=Ou(e.clone()),i.referenceNode=e.getSelf(),null!==t&&(i.uvNode=Ou(t)),null!==r&&(i.levelNode=Ou(r)),null!==n&&(i.biasNode=Ou(n))):i=yp(e,t,r,n),i};class _p extends Xa{static get type(){return"ReferenceElementNode"}constructor(e,t){super(e,t),this.referenceNode=e,this.isReferenceElementNode=!0}getNodeType(){return this.referenceNode.uniformType}generate(e){const t=super.generate(e),r=this.referenceNode.getNodeType(),n=this.getNodeType();return e.format(t,r,n)}}class vp extends qa{static get type(){return"ReferenceNode"}constructor(e,t,r=null,n=null){super(),this.property=e,this.uniformType=t,this.object=r,this.count=n,this.properties=e.split("."),this.reference=r,this.node=null,this.group=null,this.name=null,this.updateType=Ia}element(e){return Ou(new _p(this,Ou(e)))}setGroup(e){return this.group=e,this}label(e){return this.name=e,this}setNodeType(e){let t=null;t=null!==this.count?vd(null,e,this.count):Array.isArray(this.getValueFromReference())?wd(null,e):"texture"===e?yd(null):"cubeTexture"===e?bp(null):Xl(null,e),null!==this.group&&t.setGroup(this.group),null!==this.name&&t.label(this.name),this.node=t.getSelf()}getNodeType(e){return null===this.node&&(this.updateReference(e),this.updateValue()),this.node.getNodeType(e)}getValueFromReference(e=this.reference){const{properties:t}=this;let r=e[t[0]];for(let n=1;n<t.length;n++)r=r[t[n]];return r}updateReference(e){return this.reference=null!==this.object?this.object:e.object,this.reference}setup(){return this.updateValue(),this.node}update(){this.updateValue()}updateValue(){null===this.node&&this.setNodeType(this.uniformType);const e=this.getValueFromReference();Array.isArray(e)?this.node.array=e:this.node.value=e}}const xp=(e,t,r)=>Ou(new vp(e,t,r)),Tp=(e,t,r,n)=>Ou(new vp(e,t,n,r));class wp extends vp{static get type(){return"MaterialReferenceNode"}constructor(e,t,r=null){super(e,t,r),this.material=r,this.isMaterialReferenceNode=!0}updateReference(e){return this.reference=null!==this.material?this.material:e.material,this.reference}}const Sp=(e,t,r=null)=>Ou(new wp(e,t,r)),Np=Vu((e=>(!1===e.geometry.hasAttribute("tangent")&&e.geometry.computeTangents(),ud("tangent","vec4"))))(),Ep=Np.xyz.toVar("tangentLocal"),Cp=kd.mul(il(Ep,0)).xyz.toVarying("v_tangentView").normalize().toVar("tangentView"),Ap=Vu((([e,t],r)=>{let n=e.mul(Np.w).xyz;return!0!==r.material.flatShading&&(n=Oh(n,t)),n})).once()(Jd.cross(Cp),"v_bitangentView").normalize().toVar("bitangentView"),Mp=ll(Cp,Ap,Jd),Rp=(()=>{let e=Al.cross(qd);return e=e.cross(Al).normalize(),e=vh(e,tp,El.mul(ml.oneMinus()).oneMinus().pow2().pow2()).normalize(),e})(),Pp=Vu((e=>{const{eye_pos:t,surf_norm:r,mapN:n,uv:i}=e,s=t.dFdx(),o=t.dFdy(),a=i.dFdx(),u=i.dFdy(),l=r,c=o.cross(l),h=l.cross(s),d=c.mul(a.x).add(h.mul(u.x)),p=c.mul(a.y).add(h.mul(u.y)),f=d.dot(d).max(p.dot(p)),g=Kd.mul(f.inverseSqrt());return ec(d.mul(n.x,g),p.mul(n.y,g),l.mul(n.z)).normalize()}));class Dp extends Ya{static get type(){return"NormalMapNode"}constructor(e,t=null){super("vec3"),this.node=e,this.scaleNode=t,this.normalMapType=pn}setup(e){const{normalMapType:t,scaleNode:r}=this;let n=this.node.mul(2).sub(1);null!==r&&(n=el(n.xy.mul(r),n.z));let i=null;if(t===fn)i=sp(n);else if(t===pn){i=!0===e.hasGeometryAttribute("tangent")?Mp.mul(n).normalize():Pp({eye_pos:Wd,surf_norm:Jd,mapN:n,uv:ld()})}return i}}const Fp=ku(Dp).setParameterLength(1,2),Op=Vu((({textureNode:e,bumpScale:t})=>{const r=t=>e.cache().context({getUV:e=>t(e.uvNode||ld()),forceUVContext:!0}),n=Wu(r((e=>e)));return Yu(Wu(r((e=>e.add(e.dFdx())))).sub(n),Wu(r((e=>e.add(e.dFdy())))).sub(n)).mul(t)})),Lp=Vu((e=>{const{surf_pos:t,surf_norm:r,dHdxy:n}=e,i=t.dFdx().normalize(),s=r,o=t.dFdy().normalize().cross(s),a=s.cross(i),u=i.dot(o).mul(Kd),l=u.sign().mul(n.x.mul(o).add(n.y.mul(a)));return u.abs().mul(r).sub(l).normalize()}));class Bp extends Ya{static get type(){return"BumpMapNode"}constructor(e,t=null){super("vec3"),this.textureNode=e,this.scaleNode=t}setup(){const e=null!==this.scaleNode?this.scaleNode:1,t=Op({textureNode:this.textureNode,bumpScale:e});return Lp({surf_pos:Wd,surf_norm:Jd,dHdxy:t})}}const kp=ku(Bp).setParameterLength(1,2),Ip=new Map;class Up extends qa{static get type(){return"MaterialNode"}constructor(e){super(),this.scope=e}getCache(e,t){let r=Ip.get(e);return void 0===r&&(r=Sp(e,t),Ip.set(e,r)),r}getFloat(e){return this.getCache(e,"float")}getColor(e){return this.getCache(e,"color")}getTexture(e){return this.getCache("map"===e?"map":e+"Map","texture")}setup(e){const t=e.context.material,r=this.scope;let n=null;if(r===Up.COLOR){const e=void 0!==t.color?this.getColor(r):el();n=t.map&&!0===t.map.isTexture?e.mul(this.getTexture("map")):e}else if(r===Up.OPACITY){const e=this.getFloat(r);n=t.alphaMap&&!0===t.alphaMap.isTexture?e.mul(this.getTexture("alpha")):e}else if(r===Up.SPECULAR_STRENGTH)n=t.specularMap&&!0===t.specularMap.isTexture?this.getTexture("specular").r:Wu(1);else if(r===Up.SPECULAR_INTENSITY){const e=this.getFloat(r);n=t.specularIntensityMap&&!0===t.specularIntensityMap.isTexture?e.mul(this.getTexture(r).a):e}else if(r===Up.SPECULAR_COLOR){const e=this.getColor(r);n=t.specularColorMap&&!0===t.specularColorMap.isTexture?e.mul(this.getTexture(r).rgb):e}else if(r===Up.ROUGHNESS){const e=this.getFloat(r);n=t.roughnessMap&&!0===t.roughnessMap.isTexture?e.mul(this.getTexture(r).g):e}else if(r===Up.METALNESS){const e=this.getFloat(r);n=t.metalnessMap&&!0===t.metalnessMap.isTexture?e.mul(this.getTexture(r).b):e}else if(r===Up.EMISSIVE){const e=this.getFloat("emissiveIntensity"),i=this.getColor(r).mul(e);n=t.emissiveMap&&!0===t.emissiveMap.isTexture?i.mul(this.getTexture(r)):i}else if(r===Up.NORMAL)t.normalMap?(n=Fp(this.getTexture("normal"),this.getCache("normalScale","vec2")),n.normalMapType=t.normalMapType):n=t.bumpMap?kp(this.getTexture("bump").r,this.getFloat("bumpScale")):Jd;else if(r===Up.CLEARCOAT){const e=this.getFloat(r);n=t.clearcoatMap&&!0===t.clearcoatMap.isTexture?e.mul(this.getTexture(r).r):e}else if(r===Up.CLEARCOAT_ROUGHNESS){const e=this.getFloat(r);n=t.clearcoatRoughnessMap&&!0===t.clearcoatRoughnessMap.isTexture?e.mul(this.getTexture(r).r):e}else if(r===Up.CLEARCOAT_NORMAL)n=t.clearcoatNormalMap?Fp(this.getTexture(r),this.getCache(r+"Scale","vec2")):Jd;else if(r===Up.SHEEN){const e=this.getColor("sheenColor").mul(this.getFloat("sheen"));n=t.sheenColorMap&&!0===t.sheenColorMap.isTexture?e.mul(this.getTexture("sheenColor").rgb):e}else if(r===Up.SHEEN_ROUGHNESS){const e=this.getFloat(r);n=t.sheenRoughnessMap&&!0===t.sheenRoughnessMap.isTexture?e.mul(this.getTexture(r).a):e,n=n.clamp(.07,1)}else if(r===Up.ANISOTROPY)if(t.anisotropyMap&&!0===t.anisotropyMap.isTexture){const e=this.getTexture(r);n=ul(wf.x,wf.y,wf.y.negate(),wf.x).mul(e.rg.mul(2).sub(Yu(1)).normalize().mul(e.b))}else n=wf;else if(r===Up.IRIDESCENCE_THICKNESS){const e=xp("1","float",t.iridescenceThicknessRange);if(t.iridescenceThicknessMap){const i=xp("0","float",t.iridescenceThicknessRange);n=e.sub(i).mul(this.getTexture(r).g).add(i)}else n=e}else if(r===Up.TRANSMISSION){const e=this.getFloat(r);n=t.transmissionMap?e.mul(this.getTexture(r).r):e}else if(r===Up.THICKNESS){const e=this.getFloat(r);n=t.thicknessMap?e.mul(this.getTexture(r).g):e}else if(r===Up.IOR)n=this.getFloat(r);else if(r===Up.LIGHT_MAP)n=this.getTexture(r).rgb.mul(this.getFloat("lightMapIntensity"));else if(r===Up.AO)n=this.getTexture(r).r.sub(1).mul(this.getFloat("aoMapIntensity")).add(1);else if(r===Up.LINE_DASH_OFFSET)n=t.dashOffset?this.getFloat(r):Wu(0);else{const t=this.getNodeType(e);n=this.getCache(r,t)}return n}}Up.ALPHA_TEST="alphaTest",Up.COLOR="color",Up.OPACITY="opacity",Up.SHININESS="shininess",Up.SPECULAR="specular",Up.SPECULAR_STRENGTH="specularStrength",Up.SPECULAR_INTENSITY="specularIntensity",Up.SPECULAR_COLOR="specularColor",Up.REFLECTIVITY="reflectivity",Up.ROUGHNESS="roughness",Up.METALNESS="metalness",Up.NORMAL="normal",Up.CLEARCOAT="clearcoat",Up.CLEARCOAT_ROUGHNESS="clearcoatRoughness",Up.CLEARCOAT_NORMAL="clearcoatNormal",Up.EMISSIVE="emissive",Up.ROTATION="rotation",Up.SHEEN="sheen",Up.SHEEN_ROUGHNESS="sheenRoughness",Up.ANISOTROPY="anisotropy",Up.IRIDESCENCE="iridescence",Up.IRIDESCENCE_IOR="iridescenceIOR",Up.IRIDESCENCE_THICKNESS="iridescenceThickness",Up.IOR="ior",Up.TRANSMISSION="transmission",Up.THICKNESS="thickness",Up.ATTENUATION_DISTANCE="attenuationDistance",Up.ATTENUATION_COLOR="attenuationColor",Up.LINE_SCALE="scale",Up.LINE_DASH_SIZE="dashSize",Up.LINE_GAP_SIZE="gapSize",Up.LINE_WIDTH="linewidth",Up.LINE_DASH_OFFSET="dashOffset",Up.POINT_SIZE="size",Up.DISPERSION="dispersion",Up.LIGHT_MAP="light",Up.AO="ao";const Vp=Iu(Up,Up.ALPHA_TEST),jp=Iu(Up,Up.COLOR),Gp=Iu(Up,Up.SHININESS),zp=Iu(Up,Up.EMISSIVE),$p=Iu(Up,Up.OPACITY),Hp=Iu(Up,Up.SPECULAR),Wp=Iu(Up,Up.SPECULAR_INTENSITY),qp=Iu(Up,Up.SPECULAR_COLOR),Xp=Iu(Up,Up.SPECULAR_STRENGTH),Kp=Iu(Up,Up.REFLECTIVITY),Yp=Iu(Up,Up.ROUGHNESS),Qp=Iu(Up,Up.METALNESS),Zp=Iu(Up,Up.NORMAL),Jp=Iu(Up,Up.CLEARCOAT),ef=Iu(Up,Up.CLEARCOAT_ROUGHNESS),tf=Iu(Up,Up.CLEARCOAT_NORMAL),rf=Iu(Up,Up.ROTATION),nf=Iu(Up,Up.SHEEN),sf=Iu(Up,Up.SHEEN_ROUGHNESS),of=Iu(Up,Up.ANISOTROPY),af=Iu(Up,Up.IRIDESCENCE),uf=Iu(Up,Up.IRIDESCENCE_IOR),lf=Iu(Up,Up.IRIDESCENCE_THICKNESS),cf=Iu(Up,Up.TRANSMISSION),hf=Iu(Up,Up.THICKNESS),df=Iu(Up,Up.IOR),pf=Iu(Up,Up.ATTENUATION_DISTANCE),ff=Iu(Up,Up.ATTENUATION_COLOR),gf=Iu(Up,Up.LINE_SCALE),mf=Iu(Up,Up.LINE_DASH_SIZE),yf=Iu(Up,Up.LINE_GAP_SIZE);Up.LINE_WIDTH;const bf=Iu(Up,Up.LINE_DASH_OFFSET),_f=Iu(Up,Up.POINT_SIZE),vf=Iu(Up,Up.DISPERSION),xf=Iu(Up,Up.LIGHT_MAP),Tf=Iu(Up,Up.AO),wf=Xl(new i).onReference((function(e){return e.material})).onRenderUpdate((function({material:e}){this.value.set(e.anisotropy*Math.cos(e.anisotropyRotation),e.anisotropy*Math.sin(e.anisotropyRotation))})),Sf=Vu((e=>e.context.setupModelViewProjection()),"vec4").once()().toVarying("v_modelViewProjection");class Nf extends qa{static get type(){return"IndexNode"}constructor(e){super("uint"),this.scope=e,this.isIndexNode=!0}generate(e){const t=this.getNodeType(e),r=this.scope;let n,i;if(r===Nf.VERTEX)n=e.getVertexIndex();else if(r===Nf.INSTANCE)n=e.getInstanceIndex();else if(r===Nf.DRAW)n=e.getDrawIndex();else if(r===Nf.INVOCATION_LOCAL)n=e.getInvocationLocalIndex();else if(r===Nf.INVOCATION_SUBGROUP)n=e.getInvocationSubgroupIndex();else{if(r!==Nf.SUBGROUP)throw new Error("THREE.IndexNode: Unknown scope: "+r);n=e.getSubgroupIndex()}if("vertex"===e.shaderStage||"compute"===e.shaderStage)i=n;else{i=Oh(this).build(e,t)}return i}}Nf.VERTEX="vertex",Nf.INSTANCE="instance",Nf.SUBGROUP="subgroup",Nf.INVOCATION_LOCAL="invocationLocal",Nf.INVOCATION_SUBGROUP="invocationSubgroup",Nf.DRAW="draw";const Ef=Iu(Nf,Nf.VERTEX),Cf=Iu(Nf,Nf.INSTANCE);Nf.SUBGROUP,Nf.INVOCATION_SUBGROUP,Nf.INVOCATION_LOCAL;const Af=Iu(Nf,Nf.DRAW);class Mf extends qa{static get type(){return"InstanceNode"}constructor(e,t,r=null){super("void"),this.count=e,this.instanceMatrix=t,this.instanceColor=r,this.instanceMatrixNode=null,this.instanceColorNode=null,this.updateType=Ba,this.buffer=null,this.bufferColor=null}setup(e){const{count:t,instanceMatrix:r,instanceColor:n}=this;let{instanceMatrixNode:i,instanceColorNode:s}=this;if(null===i){if(t<=1e3)i=vd(r.array,"mat4",Math.max(t,1)).element(Cf);else{const e=new an(r.array,16,1);this.buffer=e;const t=r.usage===Te?Kh:Xh,n=[t(e,"vec4",16,0),t(e,"vec4",16,4),t(e,"vec4",16,8),t(e,"vec4",16,12)];i=cl(...n)}this.instanceMatrixNode=i}if(n&&null===s){const e=new un(n.array,3),t=n.usage===Te?Kh:Xh;this.bufferColor=e,s=el(t(e,"vec3",3,0)),this.instanceColorNode=s}const o=i.mul(Gd).xyz;if(Gd.assign(o),e.hasGeometryAttribute("normal")){const e=ip(Qd,i);Qd.assign(e)}null!==this.instanceColorNode&&pl("vec3","vInstanceColor").assign(this.instanceColorNode)}update(){this.instanceMatrix.usage!==Te&&null!==this.buffer&&this.instanceMatrix.version!==this.buffer.version&&(this.buffer.version=this.instanceMatrix.version),this.instanceColor&&this.instanceColor.usage!==Te&&null!==this.bufferColor&&this.instanceColor.version!==this.bufferColor.version&&(this.bufferColor.version=this.instanceColor.version)}}class Rf extends Mf{static get type(){return"InstancedMeshNode"}constructor(e){const{count:t,instanceMatrix:r,instanceColor:n}=e;super(t,r,n),this.instancedMesh=e}}const Pf=ku(Rf).setParameterLength(1);class Df extends qa{static get type(){return"BatchNode"}constructor(e){super("void"),this.batchMesh=e,this.batchingIdNode=null}setup(e){null===this.batchingIdNode&&(null===e.getDrawIndex()?this.batchingIdNode=Cf:this.batchingIdNode=Af);const t=Vu((([e])=>{const t=qu(hd(bd(this.batchMesh._indirectTexture),0).x),r=qu(e).mod(t),n=qu(e).div(t);return bd(this.batchMesh._indirectTexture,Qu(r,n)).x})).setLayout({name:"getIndirectIndex",type:"uint",inputs:[{name:"id",type:"int"}]})(qu(this.batchingIdNode)),r=this.batchMesh._matricesTexture,n=qu(hd(bd(r),0).x),i=Wu(t).mul(4).toInt().toVar(),s=i.mod(n),o=i.div(n),a=cl(bd(r,Qu(s,o)),bd(r,Qu(s.add(1),o)),bd(r,Qu(s.add(2),o)),bd(r,Qu(s.add(3),o))),u=this.batchMesh._colorsTexture;if(null!==u){const e=Vu((([e])=>{const t=qu(hd(bd(u),0).x),r=e,n=r.mod(t),i=r.div(t);return bd(u,Qu(n,i)).rgb})).setLayout({name:"getBatchingColor",type:"vec3",inputs:[{name:"id",type:"int"}]})(t);pl("vec3","vBatchColor").assign(e)}const l=ll(a);Gd.assign(a.mul(Gd));const c=Qd.div(el(l[0].dot(l[0]),l[1].dot(l[1]),l[2].dot(l[2]))),h=l.mul(c).xyz;Qd.assign(h),e.hasGeometryAttribute("tangent")&&Ep.mulAssign(l)}}const Ff=ku(Df).setParameterLength(1),Of=new WeakMap;class Lf extends qa{static get type(){return"SkinningNode"}constructor(e){super("void"),this.skinnedMesh=e,this.updateType=Ia,this.skinIndexNode=ud("skinIndex","uvec4"),this.skinWeightNode=ud("skinWeight","vec4"),this.bindMatrixNode=xp("bindMatrix","mat4"),this.bindMatrixInverseNode=xp("bindMatrixInverse","mat4"),this.boneMatricesNode=Tp("skeleton.boneMatrices","mat4",e.skeleton.bones.length),this.positionNode=Gd,this.toPositionNode=Gd,this.previousBoneMatricesNode=null}getSkinnedPosition(e=this.boneMatricesNode,t=this.positionNode){const{skinIndexNode:r,skinWeightNode:n,bindMatrixNode:i,bindMatrixInverseNode:s}=this,o=e.element(r.x),a=e.element(r.y),u=e.element(r.z),l=e.element(r.w),c=i.mul(t),h=ec(o.mul(n.x).mul(c),a.mul(n.y).mul(c),u.mul(n.z).mul(c),l.mul(n.w).mul(c));return s.mul(h).xyz}getSkinnedNormal(e=this.boneMatricesNode,t=Qd){const{skinIndexNode:r,skinWeightNode:n,bindMatrixNode:i,bindMatrixInverseNode:s}=this,o=e.element(r.x),a=e.element(r.y),u=e.element(r.z),l=e.element(r.w);let c=ec(n.x.mul(o),n.y.mul(a),n.z.mul(u),n.w.mul(l));return c=s.mul(c).mul(i),c.transformDirection(t).xyz}getPreviousSkinnedPosition(e){const t=e.object;return null===this.previousBoneMatricesNode&&(t.skeleton.previousBoneMatrices=new Float32Array(t.skeleton.boneMatrices),this.previousBoneMatricesNode=Tp("skeleton.previousBoneMatrices","mat4",t.skeleton.bones.length)),this.getSkinnedPosition(this.previousBoneMatricesNode,zd)}needsPreviousBoneMatrices(e){const t=e.renderer.getMRT();return t&&t.has("velocity")||!0===Fa(e.object).useVelocity}setup(e){this.needsPreviousBoneMatrices(e)&&zd.assign(this.getPreviousSkinnedPosition(e));const t=this.getSkinnedPosition();if(this.toPositionNode&&this.toPositionNode.assign(t),e.hasGeometryAttribute("normal")){const t=this.getSkinnedNormal();Qd.assign(t),e.hasGeometryAttribute("tangent")&&Ep.assign(t)}return t}generate(e,t){if("void"!==t)return super.generate(e,t)}update(e){const t=e.object&&e.object.skeleton?e.object.skeleton:this.skinnedMesh.skeleton;Of.get(t)!==e.frameId&&(Of.set(t,e.frameId),null!==this.previousBoneMatricesNode&&t.previousBoneMatrices.set(t.boneMatrices),t.update())}}class Bf extends qa{static get type(){return"LoopNode"}constructor(e=[]){super(),this.params=e}getVarName(e){return String.fromCharCode("i".charCodeAt(0)+e)}getProperties(e){const t=e.getNodeProperties(this);if(void 0!==t.stackNode)return t;const r={};for(let s=0,o=this.params.length-1;s<o;s++){const e=this.params[s],t=!0!==e.isNode&&e.name||this.getVarName(s),n=!0!==e.isNode&&e.type||"int";r[t]=id(t,n)}const n=e.addStack();t.returnsNode=this.params[this.params.length-1](r,e),t.stackNode=n;const i=this.params[0];return!0!==i.isNode&&"function"==typeof i.update&&(t.updateNode=Vu(this.params[0].update)(r)),e.removeStack(),t}getNodeType(e){const{returnsNode:t}=this.getProperties(e);return t?t.getNodeType(e):"void"}setup(e){this.getProperties(e)}generate(e){const t=this.getProperties(e),r=this.params,n=t.stackNode;for(let o=0,a=r.length-1;o<a;o++){const n=r[o];let i,s=!1,a=null,u=null,l=null,c=null,h=null,d=null;if(n.isNode?"bool"===n.getNodeType(e)?(s=!0,c="bool",u=n.build(e,c)):(c="int",l=this.getVarName(o),a="0",u=n.build(e,c),h="<"):(c=n.type||"int",l=n.name||this.getVarName(o),a=n.start,u=n.end,h=n.condition,d=n.update,"number"==typeof a?a=e.generateConst(c,a):a&&a.isNode&&(a=a.build(e,c)),"number"==typeof u?u=e.generateConst(c,u):u&&u.isNode&&(u=u.build(e,c)),void 0!==a&&void 0===u?(a+=" - 1",u="0",h=">="):void 0!==u&&void 0===a&&(a="0",h="<"),void 0===h&&(h=Number(a)>Number(u)?">=":"<")),s)i=`while ( ${u} )`;else{const r={start:a,end:u},n=r.start,s=r.end;let o;const p=()=>h.includes("<")?"+=":"-=";if(null!=d)switch(typeof d){case"function":o=e.flowStagesNode(t.updateNode,"void").code.replace(/\t|;/g,"");break;case"number":o=l+" "+p()+" "+e.generateConst(c,d);break;case"string":o=l+" "+d;break;default:o=d.isNode?l+" "+p()+" "+d.build(e):"break /* invalid update */"}else d="int"===c||"uint"===c?h.includes("<")?"++":"--":p()+" 1.",o=l+" "+d;i=`for ( ${e.getVar(c,l)+" = "+n}; ${l+" "+h+" "+s}; ${o} )`}e.addFlowCode((0===o?"\n":"")+e.tab+i+" {\n\n").addFlowTab()}const i=n.build(e,"void"),s=t.returnsNode?t.returnsNode.build(e):"";e.removeFlowTab().addFlowCode("\n"+e.tab+i);for(let o=0,a=this.params.length-1;o<a;o++)e.addFlowCode((0===o?"":e.tab)+"}\n\n").removeFlowTab();return e.addFlowTab(),s}}const kf=(...e)=>Ou(new Bf(Bu(e,"int"))).toStack(),If=new WeakMap,Uf=new E,Vf=Vu((({bufferMap:e,influence:t,stride:r,width:n,depth:i,offset:s})=>{const o=qu(Ef).mul(r).add(s),a=o.div(n),u=o.sub(a.mul(n));return bd(e,Qu(u,a)).depth(i).xyz.mul(t)}));class jf extends qa{static get type(){return"MorphNode"}constructor(e){super("void"),this.mesh=e,this.morphBaseInfluence=Xl(1),this.updateType=Ia}setup(e){const{geometry:t}=e,r=void 0!==t.morphAttributes.position,n=t.hasAttribute("normal")&&void 0!==t.morphAttributes.normal,s=t.morphAttributes.position||t.morphAttributes.normal||t.morphAttributes.color,o=void 0!==s?s.length:0,{texture:a,stride:u,size:l}=function(e){const t=void 0!==e.morphAttributes.position,r=void 0!==e.morphAttributes.normal,n=void 0!==e.morphAttributes.color,s=e.morphAttributes.position||e.morphAttributes.normal||e.morphAttributes.color,o=void 0!==s?s.length:0;let a=If.get(e);if(void 0===a||a.count!==o){let s=function(){m.dispose(),If.delete(e),e.removeEventListener("dispose",s)};void 0!==a&&a.texture.dispose();const u=e.morphAttributes.position||[],l=e.morphAttributes.normal||[],c=e.morphAttributes.color||[];let h=0;!0===t&&(h=1),!0===r&&(h=2),!0===n&&(h=3);let d=e.attributes.position.count*h,p=1;const f=4096;d>f&&(p=Math.ceil(d/f),d=f);const g=new Float32Array(d*p*4*o),m=new _n(g,d,p,o);m.type=Ye,m.needsUpdate=!0;const y=4*h;for(let e=0;e<o;e++){const i=u[e],s=l[e],o=c[e],a=d*p*4*e;for(let e=0;e<i.count;e++){const u=e*y;!0===t&&(Uf.fromBufferAttribute(i,e),g[a+u+0]=Uf.x,g[a+u+1]=Uf.y,g[a+u+2]=Uf.z,g[a+u+3]=0),!0===r&&(Uf.fromBufferAttribute(s,e),g[a+u+4]=Uf.x,g[a+u+5]=Uf.y,g[a+u+6]=Uf.z,g[a+u+7]=0),!0===n&&(Uf.fromBufferAttribute(o,e),g[a+u+8]=Uf.x,g[a+u+9]=Uf.y,g[a+u+10]=Uf.z,g[a+u+11]=4===o.itemSize?Uf.w:1)}}a={count:o,texture:m,stride:h,size:new i(d,p)},If.set(e,a),e.addEventListener("dispose",s)}return a}(t);!0===r&&Gd.mulAssign(this.morphBaseInfluence),!0===n&&Qd.mulAssign(this.morphBaseInfluence);const c=qu(l.width);kf(o,(({i:e})=>{const t=Wu(0).toVar();this.mesh.count>1&&null!==this.mesh.morphTexture&&void 0!==this.mesh.morphTexture?t.assign(bd(this.mesh.morphTexture,Qu(qu(e).add(1),qu(Cf))).r):t.assign(xp("morphTargetInfluences","float").element(e).toVar()),zu(t.notEqual(0),(()=>{!0===r&&Gd.addAssign(Vf({bufferMap:a,influence:t,stride:u,width:c,depth:e,offset:qu(0)})),!0===n&&Qd.addAssign(Vf({bufferMap:a,influence:t,stride:u,width:c,depth:e,offset:qu(1)}))}))}))}update(){const e=this.morphBaseInfluence;this.mesh.geometry.morphTargetsRelative?e.value=1:e.value=1-this.mesh.morphTargetInfluences.reduce(((e,t)=>e+t),0)}}const Gf=ku(jf).setParameterLength(1);class zf extends qa{static get type(){return"LightingNode"}constructor(){super("vec3"),this.isLightingNode=!0}}class $f extends zf{static get type(){return"AONode"}constructor(e=null){super(),this.aoNode=e}setup(e){e.context.ambientOcclusion.mulAssign(this.aoNode)}}class Hf extends Mh{static get type(){return"LightingContextNode"}constructor(e,t=null,r=null,n=null){super(e),this.lightingModel=t,this.backdropNode=r,this.backdropAlphaNode=n,this._value=null}getContext(){const{backdropNode:e,backdropAlphaNode:t}=this,r={directDiffuse:el().toVar("directDiffuse"),directSpecular:el().toVar("directSpecular"),indirectDiffuse:el().toVar("indirectDiffuse"),indirectSpecular:el().toVar("indirectSpecular")};return{radiance:el().toVar("radiance"),irradiance:el().toVar("irradiance"),iblIrradiance:el().toVar("iblIrradiance"),ambientOcclusion:Wu(1).toVar("ambientOcclusion"),reflectedLight:r,backdrop:e,backdropAlpha:t}}setup(e){return this.value=this._value||(this._value=this.getContext()),this.value.lightingModel=this.lightingModel||e.context.lightingModel,super.setup(e)}}const Wf=ku(Hf);class qf extends zf{static get type(){return"IrradianceNode"}constructor(e){super(),this.node=e}setup(e){e.context.irradiance.addAssign(this.node)}}let Xf,Kf;class Yf extends qa{static get type(){return"ScreenNode"}constructor(e){super(),this.scope=e,this.isViewportNode=!0}getNodeType(){return this.scope===Yf.VIEWPORT?"vec4":"vec2"}getUpdateType(){let e=La;return this.scope!==Yf.SIZE&&this.scope!==Yf.VIEWPORT||(e=ka),this.updateType=e,e}update({renderer:e}){const t=e.getRenderTarget();this.scope===Yf.VIEWPORT?null!==t?Kf.copy(t.viewport):(e.getViewport(Kf),Kf.multiplyScalar(e.getPixelRatio())):null!==t?(Xf.width=t.width,Xf.height=t.height):e.getDrawingBufferSize(Xf)}setup(){const e=this.scope;let t=null;return t=e===Yf.SIZE?Xl(Xf||(Xf=new i)):e===Yf.VIEWPORT?Xl(Kf||(Kf=new E)):Yu(Jf.div(Zf)),t}generate(e){if(this.scope===Yf.COORDINATE){let t=e.getFragCoord();if(e.isFlipY()){const r=e.getNodeProperties(Zf).outputNode.build(e);t=`${e.getType("vec2")}( ${t}.x, ${r}.y - ${t}.y )`}return t}return super.generate(e)}}Yf.COORDINATE="coordinate",Yf.VIEWPORT="viewport",Yf.SIZE="size",Yf.UV="uv";const Qf=Iu(Yf,Yf.UV),Zf=Iu(Yf,Yf.SIZE),Jf=Iu(Yf,Yf.COORDINATE),eg=Iu(Yf,Yf.VIEWPORT);eg.zw,eg.xy;const tg=new i;class rg extends gd{static get type(){return"ViewportTextureNode"}constructor(e=Qf,t=null,r=null){null===r&&((r=new bn).minFilter=Fe),super(r,e,t),this.generateMipmaps=!1,this.isOutputTextureNode=!0,this.updateBeforeType=Ba}updateBefore(e){const t=e.renderer;t.getDrawingBufferSize(tg);const r=this.value;r.image.width===tg.width&&r.image.height===tg.height||(r.image.width=tg.width,r.image.height=tg.height,r.needsUpdate=!0);const n=r.generateMipmaps;r.generateMipmaps=this.generateMipmaps,t.copyFramebufferToTexture(r),r.generateMipmaps=n}clone(){const e=new this.constructor(this.uvNode,this.levelNode,this.value);return e.generateMipmaps=this.generateMipmaps,e}}const ng=ku(rg,null,null,{generateMipmaps:!0}).setParameterLength(0,3);let ig=null;class sg extends rg{static get type(){return"ViewportDepthTextureNode"}constructor(e=Qf,t=null){null===ig&&(ig=new se),super(e,t,ig)}}const og=ku(sg).setParameterLength(0,2);class ag extends qa{static get type(){return"ViewportDepthNode"}constructor(e,t=null){super("float"),this.scope=e,this.valueNode=t,this.isViewportDepthNode=!0}generate(e){const{scope:t}=this;return t===ag.DEPTH_BASE?e.getFragDepth():super.generate(e)}setup({camera:e}){const{scope:t}=this,r=this.valueNode;let n=null;if(t===ag.DEPTH_BASE)null!==r&&(n=dg().assign(r));else if(t===ag.DEPTH)n=e.isPerspectiveCamera?lg(Wd.z,Ed,Cd):ug(Wd.z,Ed,Cd);else if(t===ag.LINEAR_DEPTH)if(null!==r)if(e.isPerspectiveCamera){const e=cg(r,Ed,Cd);n=ug(e,Ed,Cd)}else n=r;else n=ug(Wd.z,Ed,Cd);return n}}ag.DEPTH_BASE="depthBase",ag.DEPTH="depth",ag.LINEAR_DEPTH="linearDepth";const ug=(e,t,r)=>e.add(t).div(t.sub(r)),lg=(e,t,r)=>t.add(e).mul(r).div(r.sub(t).mul(e)),cg=(e,t,r)=>t.mul(r).div(r.sub(t).mul(e).sub(r)),hg=(e,t,r)=>{t=t.max(1e-6).toVar();const n=Lc(e.negate().div(t)),i=Lc(r.div(t));return n.div(i)},dg=ku(ag,ag.DEPTH_BASE),pg=Iu(ag,ag.DEPTH);og(),pg.assign=e=>dg(e);class fg extends qa{static get type(){return"ClippingNode"}constructor(e=fg.DEFAULT){super(),this.scope=e}setup(e){super.setup(e);const t=e.clippingContext,{intersectionPlanes:r,unionPlanes:n}=t;return this.hardwareClipping=e.material.hardwareClipping,this.scope===fg.ALPHA_TO_COVERAGE?this.setupAlphaToCoverage(r,n):this.scope===fg.HARDWARE?this.setupHardwareClipping(n,e):this.setupDefault(r,n)}setupAlphaToCoverage(e,t){return Vu((()=>{const r=Wu().toVar("distanceToPlane"),n=Wu().toVar("distanceToGradient"),i=Wu(1).toVar("clipOpacity"),s=t.length;if(!1===this.hardwareClipping&&s>0){const e=wd(t);kf(s,(({i:t})=>{const s=e.element(t);r.assign(Wd.dot(s.xyz).negate().add(s.w)),n.assign(r.fwidth().div(2)),i.mulAssign(Sh(n.negate(),n,r))}))}const o=e.length;if(o>0){const t=wd(e),s=Wu(1).toVar("intersectionClipOpacity");kf(o,(({i:e})=>{const i=t.element(e);r.assign(Wd.dot(i.xyz).negate().add(i.w)),n.assign(r.fwidth().div(2)),s.mulAssign(Sh(n.negate(),n,r).oneMinus())})),i.mulAssign(s.oneMinus())}fl.a.mulAssign(i),fl.a.equal(0).discard()}))()}setupDefault(e,t){return Vu((()=>{const r=t.length;if(!1===this.hardwareClipping&&r>0){const e=wd(t);kf(r,(({i:t})=>{const r=e.element(t);Wd.dot(r.xyz).greaterThan(r.w).discard()}))}const n=e.length;if(n>0){const t=wd(e),r=Ku(!0).toVar("clipped");kf(n,(({i:e})=>{const n=t.element(e);r.assign(Wd.dot(n.xyz).greaterThan(n.w).and(r))})),r.discard()}}))()}setupHardwareClipping(e,t){const r=e.length;return t.enableHardwareClipping(r),Vu((()=>{const n=wd(e),i=Sd(t.getClipDistance());kf(r,(({i:e})=>{const t=n.element(e),r=Wd.dot(t.xyz).sub(t.w).negate();i.element(e).assign(r)}))}))()}}fg.ALPHA_TO_COVERAGE="alphaToCoverage",fg.DEFAULT="default",fg.HARDWARE="hardware";const gg=Vu((([e])=>jc(rc(1e4,Gc(rc(17,e.x).add(rc(.1,e.y)))).mul(ec(.1,Xc(Gc(rc(13,e.y).add(e.x)))))))),mg=Vu((([e])=>gg(Yu(gg(e.xy),e.z)))),yg=Vu((([e])=>{const t=ah(Yc(Jc(e.xyz)),Yc(eh(e.xyz))),r=Wu(1).div(Wu(.05).mul(t)).toVar("pixScale"),n=Yu(Fc(Ic(Lc(r))),Fc(Uc(Lc(r)))),i=Yu(mg(Ic(n.x.mul(e.xyz))),mg(Ic(n.y.mul(e.xyz)))),s=jc(Lc(r)),o=ec(rc(s.oneMinus(),i.x),rc(s,i.y)),a=oh(s,s.oneMinus()),u=el(o.mul(o).div(rc(2,a).mul(tc(1,a))),o.sub(rc(.5,a)).div(tc(1,a)),tc(1,tc(1,o).mul(tc(1,o)).div(rc(2,a).mul(tc(1,a))))),l=o.lessThan(a.oneMinus()).select(o.lessThan(a).select(u.x,u.y),u.z);return xh(l,1e-6,1)})).setLayout({name:"getAlphaHashThreshold",type:"float",inputs:[{name:"position",type:"vec3"}]});class bg extends ad{static get type(){return"VertexColorNode"}constructor(e){super(null,"vec4"),this.isVertexColorNode=!0,this.index=e}getAttributeName(){const e=this.index;return"color"+(e>0?e:"")}generate(e){const t=this.getAttributeName(e);let r;return r=!0===e.hasGeometryAttribute(t)?super.generate(e):e.generateConst(this.nodeType,new E(1,1,1,1)),r}serialize(e){super.serialize(e),e.index=this.index}deserialize(e){super.deserialize(e),this.index=e.index}}class _g extends J{static get type(){return"NodeMaterial"}get type(){return this.constructor.type}set type(e){}constructor(){super(),this.isNodeMaterial=!0,this.fog=!0,this.lights=!1,this.hardwareClipping=!1,this.lightsNode=null,this.envNode=null,this.aoNode=null,this.colorNode=null,this.normalNode=null,this.opacityNode=null,this.backdropNode=null,this.backdropAlphaNode=null,this.alphaTestNode=null,this.maskNode=null,this.positionNode=null,this.geometryNode=null,this.depthNode=null,this.receivedShadowPositionNode=null,this.castShadowPositionNode=null,this.receivedShadowNode=null,this.castShadowNode=null,this.outputNode=null,this.mrtNode=null,this.fragmentNode=null,this.vertexNode=null,Object.defineProperty(this,"shadowPositionNode",{get:()=>this.receivedShadowPositionNode,set:e=>{this.receivedShadowPositionNode=e}})}customProgramCacheKey(){return this.type+Ca(this)}build(e){this.setup(e)}setupObserver(e){return new wa(e)}setup(e){e.context.setupNormal=()=>this.setupNormal(e),e.context.setupPositionView=()=>this.setupPositionView(e),e.context.setupModelViewProjection=()=>this.setupModelViewProjection(e);const t=e.renderer,r=t.getRenderTarget();e.addStack();const n=this.setupVertex(e),i=this.vertexNode||n;let s;e.stack.outputNode=i,this.setupHardwareClipping(e),null!==this.geometryNode&&(e.stack.outputNode=e.stack.outputNode.bypass(this.geometryNode)),e.addFlow("vertex",e.removeStack()),e.addStack();const o=this.setupClipping(e);if(!0!==this.depthWrite&&!0!==this.depthTest||(null!==r?!0===r.depthBuffer&&this.setupDepth(e):!0===t.depth&&this.setupDepth(e)),null===this.fragmentNode){this.setupDiffuseColor(e),this.setupVariants(e);const n=this.setupLighting(e);null!==o&&e.stack.add(o);const i=il(n,fl.a).max(0);s=this.setupOutput(e,i),Dl.assign(s);const a=null!==this.outputNode;if(a&&(s=this.outputNode),null!==r){const e=t.getMRT(),r=this.mrtNode;null!==e?(a&&Dl.assign(s),s=e,null!==r&&(s=e.merge(r))):null!==r&&(s=r)}}else{let t=this.fragmentNode;!0!==t.isOutputStructNode&&(t=il(t)),s=this.setupOutput(e,t)}e.stack.outputNode=s,e.addFlow("fragment",e.removeStack()),e.observer=this.setupObserver(e)}setupClipping(e){if(null===e.clippingContext)return null;const{unionPlanes:t,intersectionPlanes:r}=e.clippingContext;let n=null;if(t.length>0||r.length>0){const t=e.renderer.samples;this.alphaToCoverage&&t>1?n=Ou(new fg(fg.ALPHA_TO_COVERAGE)):e.stack.add(Ou(new fg))}return n}setupHardwareClipping(e){if(this.hardwareClipping=!1,null===e.clippingContext)return;const t=e.clippingContext.unionPlanes.length;t>0&&t<=8&&e.isAvailable("clipDistance")&&(e.stack.add(Ou(new fg(fg.HARDWARE))),this.hardwareClipping=!0)}setupDepth(e){const{renderer:t,camera:r}=e;let n=this.depthNode;if(null===n){const e=t.getMRT();e&&e.has("depth")?n=e.get("depth"):!0===t.logarithmicDepthBuffer&&(n=r.isPerspectiveCamera?hg(Wd.z,Ed,Cd):ug(Wd.z,Ed,Cd))}null!==n&&pg.assign(n).toStack()}setupPositionView(){return kd.mul(Gd).xyz}setupModelViewProjection(){return Ad.mul(Wd)}setupVertex(e){return e.addStack(),this.setupPosition(e),e.context.vertex=e.removeStack(),Sf}setupPosition(e){const{object:t,geometry:r}=e;var n,i,s;if((r.morphAttributes.position||r.morphAttributes.normal||r.morphAttributes.color)&&Gf(t).toStack(),!0===t.isSkinnedMesh&&(n=t,Ou(new Lf(n))).toStack(),this.displacementMap){const e=Sp("displacementMap","texture"),t=Sp("displacementScale","float"),r=Sp("displacementBias","float");Gd.addAssign(Qd.normalize().mul(e.x.mul(t).add(r)))}return t.isBatchedMesh&&Ff(t).toStack(),t.isInstancedMesh&&t.instanceMatrix&&!0===t.instanceMatrix.isInstancedBufferAttribute&&Pf(t).toStack(),null!==this.positionNode&&Gd.assign((i=this.positionNode,s="POSITION",i.context({namespace:s}))),Gd}setupDiffuseColor({object:e,geometry:t}){null!==this.maskNode&&Ku(this.maskNode).not().discard();let r=this.colorNode?il(this.colorNode):jp;if(!0===this.vertexColors&&t.hasAttribute("color")&&(r=r.mul(((e=0)=>Ou(new bg(e)))())),e.instanceColor){r=pl("vec3","vInstanceColor").mul(r)}if(e.isBatchedMesh&&e._colorsTexture){r=pl("vec3","vBatchColor").mul(r)}fl.assign(r);const n=this.opacityNode?Wu(this.opacityNode):$p;fl.a.assign(fl.a.mul(n));let i=null;(null!==this.alphaTestNode||this.alphaTest>0)&&(i=null!==this.alphaTestNode?Wu(this.alphaTestNode):Vp,fl.a.lessThanEqual(i).discard()),!0===this.alphaHash&&fl.a.lessThan(yg(Gd)).discard();!1===this.transparent&&this.blending===ee&&!1===this.alphaToCoverage?fl.a.assign(1):null===i&&fl.a.lessThanEqual(0).discard()}setupVariants(){}setupOutgoingLight(){return!0===this.lights?el(0):fl.rgb}setupNormal(){return this.normalNode?el(this.normalNode):Zp}setupEnvironment(){let e=null;return this.envNode?e=this.envNode:this.envMap&&(e=this.envMap.isCubeTexture?Sp("envMap","cubeTexture"):Sp("envMap","texture")),e}setupLightMap(e){let t=null;return e.material.lightMap&&(t=new qf(xf)),t}setupLights(e){const t=[],r=this.setupEnvironment(e);r&&r.isLightingNode&&t.push(r);const n=this.setupLightMap(e);if(n&&n.isLightingNode&&t.push(n),null!==this.aoNode||e.material.aoMap){const e=null!==this.aoNode?this.aoNode:Tf;t.push(new $f(e))}let i=this.lightsNode||e.lightsNode;return t.length>0&&(i=e.renderer.lighting.createNode([...i.getLights(),...t])),i}setupLightingModel(){}setupLighting(e){const{material:t}=e,{backdropNode:r,backdropAlphaNode:n,emissiveNode:i}=this,s=!0===this.lights||null!==this.lightsNode?this.setupLights(e):null;let o=this.setupOutgoingLight(e);if(s&&s.getScope().hasLights){const t=this.setupLightingModel(e)||null;o=Wf(s,t,r,n)}else null!==r&&(o=el(null!==n?vh(o,r,n):r));return(i&&!0===i.isNode||t.emissive&&!0===t.emissive.isColor)&&(gl.assign(el(i||zp)),o=o.add(gl)),o}setupFog(e,t){const r=e.fogNode;return r&&(Dl.assign(t),t=il(r)),t}setupOutput(e,t){return!0===this.fog&&(t=this.setupFog(e,t)),t}setDefaultValues(e){for(const r in e){const t=e[r];void 0===this[r]&&(this[r]=t,t&&t.clone&&(this[r]=t.clone()))}const t=Object.getOwnPropertyDescriptors(e.constructor.prototype);for(const r in t)void 0===Object.getOwnPropertyDescriptor(this.constructor.prototype,r)&&void 0!==t[r].get&&Object.defineProperty(this.constructor.prototype,r,t[r])}toJSON(e){const t=void 0===e||"string"==typeof e;t&&(e={textures:{},images:{},nodes:{}});const r=J.prototype.toJSON.call(this,e),n=Aa(this);r.inputNodes={};for(const{property:s,childNode:o}of n)r.inputNodes[s]=o.toJSON(e).uuid;function i(e){const t=[];for(const r in e){const n=e[r];delete n.metadata,t.push(n)}return t}if(t){const t=i(e.textures),n=i(e.images),s=i(e.nodes);t.length>0&&(r.textures=t),n.length>0&&(r.images=n),s.length>0&&(r.nodes=s)}return r}copy(e){return this.lightsNode=e.lightsNode,this.envNode=e.envNode,this.colorNode=e.colorNode,this.normalNode=e.normalNode,this.opacityNode=e.opacityNode,this.backdropNode=e.backdropNode,this.backdropAlphaNode=e.backdropAlphaNode,this.alphaTestNode=e.alphaTestNode,this.maskNode=e.maskNode,this.positionNode=e.positionNode,this.geometryNode=e.geometryNode,this.depthNode=e.depthNode,this.receivedShadowPositionNode=e.receivedShadowPositionNode,this.castShadowPositionNode=e.castShadowPositionNode,this.receivedShadowNode=e.receivedShadowNode,this.castShadowNode=e.castShadowNode,this.outputNode=e.outputNode,this.mrtNode=e.mrtNode,this.fragmentNode=e.fragmentNode,this.vertexNode=e.vertexNode,super.copy(e)}}const vg=new v;class xg extends _g{static get type(){return"LineBasicNodeMaterial"}constructor(e){super(),this.isLineBasicNodeMaterial=!0,this.setDefaultValues(vg),this.setValues(e)}}const Tg=new vr;class wg extends _g{static get type(){return"LineDashedNodeMaterial"}constructor(e){super(),this.isLineDashedNodeMaterial=!0,this.setDefaultValues(Tg),this.dashOffset=0,this.offsetNode=null,this.dashScaleNode=null,this.dashSizeNode=null,this.gapSizeNode=null,this.setValues(e)}setupVariants(){const e=this.offsetNode?Wu(this.offsetNode):bf,t=this.dashScaleNode?Wu(this.dashScaleNode):gf,r=this.dashSizeNode?Wu(this.dashSizeNode):mf,n=this.gapSizeNode?Wu(this.gapSizeNode):yf;Fl.assign(r),Ol.assign(n);const i=Oh(ud("lineDistance").mul(t));(e?i.add(e):i).mod(Fl.add(Ol)).greaterThan(Fl).discard()}}const Sg=new br;class Ng extends _g{static get type(){return"MeshNormalNodeMaterial"}constructor(e){super(),this.isMeshNormalNodeMaterial=!0,this.setDefaultValues(Sg),this.setValues(e)}setupDiffuseColor(){const e=this.opacityNode?Wu(this.opacityNode):$p;fl.assign(Uh(il(Ou(tp).mul(.5).add(.5),e),S))}}class Eg extends Ya{static get type(){return"EquirectUVNode"}constructor(e=Hd){super("vec2"),this.dirNode=e}setup(){const e=this.dirNode,t=e.z.atan(e.x).mul(1/(2*Math.PI)).add(.5),r=e.y.clamp(-1,1).asin().mul(1/Math.PI).add(.5);return Yu(t,r)}}const Cg=ku(Eg).setParameterLength(0,1);class Ag extends rn{constructor(e=1,t={}){super(e,t),this.isCubeRenderTarget=!0}fromEquirectangularTexture(e,t){const r=t.minFilter,n=t.generateMipmaps;t.generateMipmaps=!0,this.texture.type=t.type,this.texture.colorSpace=t.colorSpace,this.texture.generateMipmaps=t.generateMipmaps,this.texture.minFilter=t.minFilter,this.texture.magFilter=t.magFilter;const i=new nn(5,5,5),s=Cg(Hd),o=new _g;o.colorNode=yd(t,s,0),o.side=L,o.blending=dt;const a=new l(i,o),u=new A;u.add(a),t.minFilter===Fe&&(t.minFilter=R);const c=new sn(1,10,this),h=e.getMRT();return e.setMRT(null),c.update(e,u),e.setMRT(h),t.minFilter=r,t.currentGenerateMipmaps=n,a.geometry.dispose(),a.material.dispose(),this}}const Mg=new WeakMap;class Rg extends Ya{static get type(){return"CubeMapNode"}constructor(e){super("vec3"),this.envNode=e,this._cubeTexture=null,this._cubeTextureNode=bp(null);const t=new ve;t.isRenderTargetTexture=!0,this._defaultTexture=t,this.updateBeforeType=ka}updateBefore(e){const{renderer:t,material:r}=e,n=this.envNode;if(n.isTextureNode||n.isMaterialReferenceNode){const e=n.isTextureNode?n.value:r[n.property];if(e&&e.isTexture){const r=e.mapping;if(r===ye||r===be){if(Mg.has(e)){const t=Mg.get(e);Dg(t,e.mapping),this._cubeTexture=t}else{const r=e.image;if(function(e){return null!=e&&e.height>0}(r)){const n=new Ag(r.height);n.fromEquirectangularTexture(t,e),Dg(n.texture,e.mapping),this._cubeTexture=n.texture,Mg.set(e,n.texture),e.addEventListener("dispose",Pg)}else this._cubeTexture=this._defaultTexture}this._cubeTextureNode.value=this._cubeTexture}else this._cubeTextureNode=this.envNode}}}setup(e){return this.updateBefore(e),this._cubeTextureNode}}function Pg(e){const t=e.target;t.removeEventListener("dispose",Pg);const r=Mg.get(t);void 0!==r&&(Mg.delete(t),r.dispose())}function Dg(e,t){t===ye?e.mapping=ln:t===be&&(e.mapping=cn)}const Fg=ku(Rg).setParameterLength(1);class Og extends zf{static get type(){return"BasicEnvironmentNode"}constructor(e=null){super(),this.envNode=e}setup(e){e.context.environment=Fg(this.envNode)}}class Lg extends zf{static get type(){return"BasicLightMapNode"}constructor(e=null){super(),this.lightMapNode=e}setup(e){const t=Wu(1/Math.PI);e.context.irradianceLightMap=this.lightMapNode.mul(t)}}class Bg{start(e){e.lightsNode.setupLights(e,e.lightsNode.getLightNodes(e)),this.indirect(e)}finish(){}direct(){}directRectArea(){}indirect(){}ambientOcclusion(){}}class kg extends Bg{constructor(){super()}indirect({context:e}){const t=e.ambientOcclusion,r=e.reflectedLight,n=e.irradianceLightMap;r.indirectDiffuse.assign(il(0)),n?r.indirectDiffuse.addAssign(n):r.indirectDiffuse.addAssign(il(1,1,1,0)),r.indirectDiffuse.mulAssign(t),r.indirectDiffuse.mulAssign(fl.rgb)}finish(e){const{material:t,context:r}=e,n=r.outgoingLight,i=e.context.environment;if(i)switch(t.combine){case Qr:n.rgb.assign(vh(n.rgb,n.rgb.mul(i.rgb),Xp.mul(Kp)));break;case Yr:n.rgb.assign(vh(n.rgb,i.rgb,Xp.mul(Kp)));break;case Kr:n.rgb.addAssign(i.rgb.mul(Xp.mul(Kp)))}}}const Ig=new he;class Ug extends _g{static get type(){return"MeshBasicNodeMaterial"}constructor(e){super(),this.isMeshBasicNodeMaterial=!0,this.lights=!0,this.setDefaultValues(Ig),this.setValues(e)}setupNormal(){return Jd}setupEnvironment(e){const t=super.setupEnvironment(e);return t?new Og(t):null}setupLightMap(e){let t=null;return e.material.lightMap&&(t=new Lg(xf)),t}setupOutgoingLight(){return fl.rgb}setupLightingModel(){return new kg}}const Vg=Vu((({f0:e,f90:t,dotVH:r})=>{const n=r.mul(-5.55473).sub(6.98316).mul(r).exp2();return e.mul(n.oneMinus()).add(t.mul(n))})),jg=Vu((e=>e.diffuseColor.mul(1/Math.PI))),Gg=Vu((({dotNH:e})=>Pl.mul(Wu(.5)).add(1).mul(Wu(1/Math.PI)).mul(e.pow(Pl)))),zg=Vu((({lightDirection:e})=>{const t=e.add(qd).normalize(),r=tp.dot(t).clamp(),n=qd.dot(t).clamp(),i=Vg({f0:Ml,f90:1,dotVH:n}),s=Wu(.25),o=Gg({dotNH:r});return i.mul(s).mul(o)}));class $g extends kg{constructor(e=!0){super(),this.specular=e}direct({lightDirection:e,lightColor:t,reflectedLight:r}){const n=tp.dot(e).clamp().mul(t);r.directDiffuse.addAssign(n.mul(jg({diffuseColor:fl.rgb}))),!0===this.specular&&r.directSpecular.addAssign(n.mul(zg({lightDirection:e})).mul(Xp))}indirect(e){const{ambientOcclusion:t,irradiance:r,reflectedLight:n}=e.context;n.indirectDiffuse.addAssign(r.mul(jg({diffuseColor:fl}))),n.indirectDiffuse.mulAssign(t)}}const Hg=new d;class Wg extends _g{static get type(){return"MeshLambertNodeMaterial"}constructor(e){super(),this.isMeshLambertNodeMaterial=!0,this.lights=!0,this.setDefaultValues(Hg),this.setValues(e)}setupEnvironment(e){const t=super.setupEnvironment(e);return t?new Og(t):null}setupLightingModel(){return new $g(!1)}}const qg=new fr;class Xg extends _g{static get type(){return"MeshPhongNodeMaterial"}constructor(e){super(),this.isMeshPhongNodeMaterial=!0,this.lights=!0,this.shininessNode=null,this.specularNode=null,this.setDefaultValues(qg),this.setValues(e)}setupEnvironment(e){const t=super.setupEnvironment(e);return t?new Og(t):null}setupLightingModel(){return new $g}setupVariants(){const e=(this.shininessNode?Wu(this.shininessNode):Gp).max(1e-4);Pl.assign(e);const t=this.specularNode||Hp;Ml.assign(t)}copy(e){return this.shininessNode=e.shininessNode,this.specularNode=e.specularNode,super.copy(e)}}const Kg=Vu((e=>{if(!1===e.geometry.hasAttribute("normal"))return Wu(0);const t=Jd.dFdx().abs().max(Jd.dFdy().abs());return t.x.max(t.y).max(t.z)})),Yg=Vu((e=>{const{roughness:t}=e,r=Kg();let n=t.max(.0525);return n=n.add(r),n=n.min(1),n})),Qg=Vu((({alpha:e,dotNL:t,dotNV:r})=>{const n=e.pow2(),i=t.mul(n.add(n.oneMinus().mul(r.pow2())).sqrt()),s=r.mul(n.add(n.oneMinus().mul(t.pow2())).sqrt());return nc(.5,i.add(s).max(Ec))})).setLayout({name:"V_GGX_SmithCorrelated",type:"float",inputs:[{name:"alpha",type:"float"},{name:"dotNL",type:"float"},{name:"dotNV",type:"float"}]}),Zg=Vu((({alphaT:e,alphaB:t,dotTV:r,dotBV:n,dotTL:i,dotBL:s,dotNV:o,dotNL:a})=>{const u=a.mul(el(e.mul(r),t.mul(n),o).length()),l=o.mul(el(e.mul(i),t.mul(s),a).length());return nc(.5,u.add(l)).saturate()})).setLayout({name:"V_GGX_SmithCorrelated_Anisotropic",type:"float",inputs:[{name:"alphaT",type:"float",qualifier:"in"},{name:"alphaB",type:"float",qualifier:"in"},{name:"dotTV",type:"float",qualifier:"in"},{name:"dotBV",type:"float",qualifier:"in"},{name:"dotTL",type:"float",qualifier:"in"},{name:"dotBL",type:"float",qualifier:"in"},{name:"dotNV",type:"float",qualifier:"in"},{name:"dotNL",type:"float",qualifier:"in"}]}),Jg=Vu((({alpha:e,dotNH:t})=>{const r=e.pow2(),n=t.pow2().mul(r.oneMinus()).oneMinus();return r.div(n.pow2()).mul(1/Math.PI)})).setLayout({name:"D_GGX",type:"float",inputs:[{name:"alpha",type:"float"},{name:"dotNH",type:"float"}]}),em=Wu(1/Math.PI),tm=Vu((({alphaT:e,alphaB:t,dotNH:r,dotTH:n,dotBH:i})=>{const s=e.mul(t),o=el(t.mul(n),e.mul(i),s.mul(r)),a=o.dot(o),u=s.div(a);return em.mul(s.mul(u.pow2()))})).setLayout({name:"D_GGX_Anisotropic",type:"float",inputs:[{name:"alphaT",type:"float",qualifier:"in"},{name:"alphaB",type:"float",qualifier:"in"},{name:"dotNH",type:"float",qualifier:"in"},{name:"dotTH",type:"float",qualifier:"in"},{name:"dotBH",type:"float",qualifier:"in"}]}),rm=Vu((e=>{const{lightDirection:t,f0:r,f90:n,roughness:i,f:s,USE_IRIDESCENCE:o,USE_ANISOTROPY:a}=e,u=e.normalView||tp,l=i.pow2(),c=t.add(qd).normalize(),h=u.dot(t).clamp(),d=u.dot(qd).clamp(),p=u.dot(c).clamp(),f=qd.dot(c).clamp();let g,m,y=Vg({f0:r,f90:n,dotVH:f});if(Du(o)&&(y=Tl.mix(y,s)),Du(a)){const e=Cl.dot(t),r=Cl.dot(qd),n=Cl.dot(c),i=Al.dot(t),s=Al.dot(qd),o=Al.dot(c);g=Zg({alphaT:Nl,alphaB:l,dotTV:r,dotBV:s,dotTL:e,dotBL:i,dotNV:d,dotNL:h}),m=tm({alphaT:Nl,alphaB:l,dotNH:p,dotTH:n,dotBH:o})}else g=Qg({alpha:l,dotNL:h,dotNV:d}),m=Jg({alpha:l,dotNH:p});return y.mul(g).mul(m)})),nm=Vu((({roughness:e,dotNV:t})=>{const r=il(-1,-.0275,-.572,.022),n=il(1,.0425,1.04,-.04),i=e.mul(r).add(n),s=i.x.mul(i.x).min(t.mul(-9.28).exp2()).mul(i.x).add(i.y);return Yu(-1.04,1.04).mul(s).add(i.zw)})).setLayout({name:"DFGApprox",type:"vec2",inputs:[{name:"roughness",type:"float"},{name:"dotNV",type:"vec3"}]}),im=Vu((e=>{const{dotNV:t,specularColor:r,specularF90:n,roughness:i}=e,s=nm({dotNV:t,roughness:i});return r.mul(s.x).add(n.mul(s.y))})),sm=Vu((({f:e,f90:t,dotVH:r})=>{const n=r.oneMinus().saturate(),i=n.mul(n),s=n.mul(i,i).clamp(0,.9999);return e.sub(el(t).mul(s)).div(s.oneMinus())})).setLayout({name:"Schlick_to_F0",type:"vec3",inputs:[{name:"f",type:"vec3"},{name:"f90",type:"float"},{name:"dotVH",type:"float"}]}),om=Vu((({roughness:e,dotNH:t})=>{const r=e.pow2(),n=Wu(1).div(r),i=t.pow2().oneMinus().max(.0078125);return Wu(2).add(n).mul(i.pow(n.mul(.5))).div(2*Math.PI)})).setLayout({name:"D_Charlie",type:"float",inputs:[{name:"roughness",type:"float"},{name:"dotNH",type:"float"}]}),am=Vu((({dotNV:e,dotNL:t})=>Wu(1).div(Wu(4).mul(t.add(e).sub(t.mul(e)))))).setLayout({name:"V_Neubelt",type:"float",inputs:[{name:"dotNV",type:"float"},{name:"dotNL",type:"float"}]}),um=Vu((({lightDirection:e})=>{const t=e.add(qd).normalize(),r=tp.dot(e).clamp(),n=tp.dot(qd).clamp(),i=tp.dot(t).clamp(),s=om({roughness:xl,dotNH:i}),o=am({dotNV:n,dotNL:r});return vl.mul(s).mul(o)})),lm=Vu((({N:e,V:t,roughness:r})=>{const n=e.dot(t).saturate(),i=Yu(r,n.oneMinus().sqrt());return i.assign(i.mul(.984375).add(.0078125)),i})).setLayout({name:"LTC_Uv",type:"vec2",inputs:[{name:"N",type:"vec3"},{name:"V",type:"vec3"},{name:"roughness",type:"float"}]}),cm=Vu((({f:e})=>{const t=e.length();return ah(t.mul(t).add(e.z).div(t.add(1)),0)})).setLayout({name:"LTC_ClippedSphereFormFactor",type:"float",inputs:[{name:"f",type:"vec3"}]}),hm=Vu((({v1:e,v2:t})=>{const r=e.dot(t),n=r.abs().toVar(),i=n.mul(.0145206).add(.4965155).mul(n).add(.8543985).toVar(),s=n.add(4.1616724).mul(n).add(3.417594).toVar(),o=i.div(s),a=r.greaterThan(0).select(o,ah(r.mul(r).oneMinus(),1e-7).inverseSqrt().mul(.5).sub(o));return e.cross(t).mul(a)})).setLayout({name:"LTC_EdgeVectorFormFactor",type:"vec3",inputs:[{name:"v1",type:"vec3"},{name:"v2",type:"vec3"}]}),dm=Vu((({N:e,V:t,P:r,mInv:n,p0:i,p1:s,p2:o,p3:a})=>{const u=s.sub(i).toVar(),l=a.sub(i).toVar(),c=u.cross(l),h=el().toVar();return zu(c.dot(r.sub(i)).greaterThanEqual(0),(()=>{const u=t.sub(e.mul(t.dot(e))).normalize(),l=e.cross(u).negate(),c=n.mul(ll(u,l,e).transpose()).toVar(),d=c.mul(i.sub(r)).normalize().toVar(),p=c.mul(s.sub(r)).normalize().toVar(),f=c.mul(o.sub(r)).normalize().toVar(),g=c.mul(a.sub(r)).normalize().toVar(),m=el(0).toVar();m.addAssign(hm({v1:d,v2:p})),m.addAssign(hm({v1:p,v2:f})),m.addAssign(hm({v1:f,v2:g})),m.addAssign(hm({v1:g,v2:d})),h.assign(el(cm({f:m})))})),h})).setLayout({name:"LTC_Evaluate",type:"vec3",inputs:[{name:"N",type:"vec3"},{name:"V",type:"vec3"},{name:"P",type:"vec3"},{name:"mInv",type:"mat3"},{name:"p0",type:"vec3"},{name:"p1",type:"vec3"},{name:"p2",type:"vec3"},{name:"p3",type:"vec3"}]}),pm=1/6,fm=e=>rc(pm,rc(e,rc(e,e.negate().add(3)).sub(3)).add(1)),gm=e=>rc(pm,rc(e,rc(e,rc(3,e).sub(6))).add(4)),mm=e=>rc(pm,rc(e,rc(e,rc(-3,e).add(3)).add(3)).add(1)),ym=e=>rc(pm,fh(e,3)),bm=e=>fm(e).add(gm(e)),_m=e=>mm(e).add(ym(e)),vm=e=>ec(-1,gm(e).div(fm(e).add(gm(e)))),xm=e=>ec(1,ym(e).div(mm(e).add(ym(e)))),Tm=(e,t,r)=>{const n=e.uvNode,i=rc(n,t.zw).add(.5),s=Ic(i),o=jc(i),a=bm(o.x),u=_m(o.x),l=vm(o.x),c=xm(o.x),h=vm(o.y),d=xm(o.y),p=Yu(s.x.add(l),s.y.add(h)).sub(.5).mul(t.xy),f=Yu(s.x.add(c),s.y.add(h)).sub(.5).mul(t.xy),g=Yu(s.x.add(l),s.y.add(d)).sub(.5).mul(t.xy),m=Yu(s.x.add(c),s.y.add(d)).sub(.5).mul(t.xy),y=bm(o.y).mul(ec(a.mul(e.sample(p).level(r)),u.mul(e.sample(f).level(r)))),b=_m(o.y).mul(ec(a.mul(e.sample(g).level(r)),u.mul(e.sample(m).level(r))));return y.add(b)},wm=Vu((([e,t=Wu(3)])=>{const r=Yu(e.size(qu(t))),n=Yu(e.size(qu(t.add(1)))),i=nc(1,r),s=nc(1,n),o=Tm(e,il(i,r),Ic(t)),a=Tm(e,il(s,n),Uc(t));return jc(t).mix(o,a)})),Sm=Vu((([e,t,r,n,i])=>{const s=el(wh(t.negate(),Vc(e),nc(1,n))),o=el(Yc(i[0].xyz),Yc(i[1].xyz),Yc(i[2].xyz));return Vc(s).mul(r.mul(o))})).setLayout({name:"getVolumeTransmissionRay",type:"vec3",inputs:[{name:"n",type:"vec3"},{name:"v",type:"vec3"},{name:"thickness",type:"float"},{name:"ior",type:"float"},{name:"modelMatrix",type:"mat4"}]}),Nm=Vu((([e,t])=>e.mul(xh(t.mul(2).sub(2),0,1)))).setLayout({name:"applyIorToRoughness",type:"float",inputs:[{name:"roughness",type:"float"},{name:"ior",type:"float"}]}),Em=ng(),Cm=ng(),Am=Vu((([e,t,r],{material:n})=>{const i=(n.side===L?Em:Cm).sample(e),s=Lc(Zf.x).mul(Nm(t,r));return wm(i,s)})),Mm=Vu((([e,t,r])=>(zu(r.notEqual(0),(()=>{const n=Oc(t).negate().div(r);return Dc(n.negate().mul(e))})),el(1)))).setLayout({name:"volumeAttenuation",type:"vec3",inputs:[{name:"transmissionDistance",type:"float"},{name:"attenuationColor",type:"vec3"},{name:"attenuationDistance",type:"float"}]}),Rm=Vu((([e,t,r,n,i,s,o,a,u,l,c,h,d,p,f])=>{let g,m;if(f){g=il().toVar(),m=el().toVar();const i=c.sub(1).mul(f.mul(.025)),s=el(c.sub(i),c,c.add(i));kf({start:0,end:3},(({i:i})=>{const c=s.element(i),f=Sm(e,t,h,c,a),y=o.add(f),b=l.mul(u.mul(il(y,1))),_=Yu(b.xy.div(b.w)).toVar();_.addAssign(1),_.divAssign(2),_.assign(Yu(_.x,_.y.oneMinus()));const v=Am(_,r,c);g.element(i).assign(v.element(i)),g.a.addAssign(v.a),m.element(i).assign(n.element(i).mul(Mm(Yc(f),d,p).element(i)))})),g.a.divAssign(3)}else{const i=Sm(e,t,h,c,a),s=o.add(i),f=l.mul(u.mul(il(s,1))),y=Yu(f.xy.div(f.w)).toVar();y.addAssign(1),y.divAssign(2),y.assign(Yu(y.x,y.y.oneMinus())),g=Am(y,r,c),m=n.mul(Mm(Yc(i),d,p))}const y=m.rgb.mul(g.rgb),b=e.dot(t).clamp(),_=el(im({dotNV:b,specularColor:i,specularF90:s,roughness:r})),v=m.r.add(m.g,m.b).div(3);return il(_.oneMinus().mul(y),g.a.oneMinus().mul(v).oneMinus())})),Pm=ll(3.2404542,-.969266,.0556434,-1.5371385,1.8760108,-.2040259,-.4985314,.041556,1.0572252),Dm=(e,t)=>e.sub(t).div(e.add(t)).pow2(),Fm=Vu((({outsideIOR:e,eta2:t,cosTheta1:r,thinFilmThickness:n,baseF0:i})=>{const s=vh(e,t,Sh(0,.03,n)),o=e.div(s).pow2().mul(r.pow2().oneMinus()).oneMinus();zu(o.lessThan(0),(()=>el(1)));const a=o.sqrt(),u=Dm(s,e),l=Vg({f0:u,f90:1,dotVH:r}),c=l.oneMinus(),h=s.lessThan(e).select(Math.PI,0),d=Wu(Math.PI).sub(h),p=(e=>{const t=e.sqrt();return el(1).add(t).div(el(1).sub(t))})(i.clamp(0,.9999)),f=Dm(p,s.toVec3()),g=Vg({f0:f,f90:1,dotVH:a}),m=el(p.x.lessThan(s).select(Math.PI,0),p.y.lessThan(s).select(Math.PI,0),p.z.lessThan(s).select(Math.PI,0)),y=s.mul(n,a,2),b=el(d).add(m),_=l.mul(g).clamp(1e-5,.9999),v=_.sqrt(),x=c.pow2().mul(g).div(el(1).sub(_)),T=l.add(x).toVar(),w=x.sub(c).toVar();return kf({start:1,end:2,condition:"<=",name:"m"},(({m:e})=>{w.mulAssign(v);const t=((e,t)=>{const r=e.mul(2*Math.PI*1e-9),n=el(54856e-17,44201e-17,52481e-17),i=el(1681e3,1795300,2208400),s=el(43278e5,93046e5,66121e5),o=Wu(9747e-17*Math.sqrt(2*Math.PI*45282e5)).mul(r.mul(2239900).add(t.x).cos()).mul(r.pow2().mul(-45282e5).exp());let a=n.mul(s.mul(2*Math.PI).sqrt()).mul(i.mul(r).add(t).cos()).mul(r.pow2().negate().mul(s).exp());return a=el(a.x.add(o),a.y,a.z).div(1.0685e-7),Pm.mul(a)})(Wu(e).mul(y),Wu(e).mul(b)).mul(2);T.addAssign(w.mul(t))})),T.max(el(0))})).setLayout({name:"evalIridescence",type:"vec3",inputs:[{name:"outsideIOR",type:"float"},{name:"eta2",type:"float"},{name:"cosTheta1",type:"float"},{name:"thinFilmThickness",type:"float"},{name:"baseF0",type:"vec3"}]}),Om=Vu((({normal:e,viewDir:t,roughness:r})=>{const n=e.dot(t).saturate(),i=r.pow2(),s=Ah(r.lessThan(.25),Wu(-339.2).mul(i).add(Wu(161.4).mul(r)).sub(25.9),Wu(-8.48).mul(i).add(Wu(14.3).mul(r)).sub(9.95)),o=Ah(r.lessThan(.25),Wu(44).mul(i).sub(Wu(23.7).mul(r)).add(3.26),Wu(1.97).mul(i).sub(Wu(3.27).mul(r)).add(.72));return Ah(r.lessThan(.25),0,Wu(.1).mul(r).sub(.025)).add(s.mul(n).add(o).exp()).mul(1/Math.PI).saturate()})),Lm=el(.04),Bm=Wu(1);class km extends Bg{constructor(e=!1,t=!1,r=!1,n=!1,i=!1,s=!1){super(),this.clearcoat=e,this.sheen=t,this.iridescence=r,this.anisotropy=n,this.transmission=i,this.dispersion=s,this.clearcoatRadiance=null,this.clearcoatSpecularDirect=null,this.clearcoatSpecularIndirect=null,this.sheenSpecularDirect=null,this.sheenSpecularIndirect=null,this.iridescenceFresnel=null,this.iridescenceF0=null}start(e){if(!0===this.clearcoat&&(this.clearcoatRadiance=el().toVar("clearcoatRadiance"),this.clearcoatSpecularDirect=el().toVar("clearcoatSpecularDirect"),this.clearcoatSpecularIndirect=el().toVar("clearcoatSpecularIndirect")),!0===this.sheen&&(this.sheenSpecularDirect=el().toVar("sheenSpecularDirect"),this.sheenSpecularIndirect=el().toVar("sheenSpecularIndirect")),!0===this.iridescence){const e=tp.dot(qd).clamp();this.iridescenceFresnel=Fm({outsideIOR:Wu(1),eta2:wl,cosTheta1:e,thinFilmThickness:Sl,baseF0:Ml}),this.iridescenceF0=sm({f:this.iridescenceFresnel,f90:1,dotVH:e})}if(!0===this.transmission){const t=$d,r=Rd.sub($d).normalize(),n=rp,i=e.context;i.backdrop=Rm(n,r,ml,fl,Ml,Rl,t,Ld,Md,Ad,Ll,kl,Ul,Il,this.dispersion?Vl:null),i.backdropAlpha=Bl,fl.a.mulAssign(vh(1,i.backdrop.a,Bl))}super.start(e)}computeMultiscattering(e,t,r){const n=tp.dot(qd).clamp(),i=nm({roughness:ml,dotNV:n}),s=(this.iridescenceF0?Tl.mix(Ml,this.iridescenceF0):Ml).mul(i.x).add(r.mul(i.y)),o=i.x.add(i.y).oneMinus(),a=Ml.add(Ml.oneMinus().mul(.047619)),u=s.mul(a).div(o.mul(a).oneMinus());e.addAssign(s),t.addAssign(u.mul(o))}direct({lightDirection:e,lightColor:t,reflectedLight:r}){const n=tp.dot(e).clamp().mul(t);if(!0===this.sheen&&this.sheenSpecularDirect.addAssign(n.mul(um({lightDirection:e}))),!0===this.clearcoat){const r=np.dot(e).clamp().mul(t);this.clearcoatSpecularDirect.addAssign(r.mul(rm({lightDirection:e,f0:Lm,f90:Bm,roughness:_l,normalView:np})))}r.directDiffuse.addAssign(n.mul(jg({diffuseColor:fl.rgb}))),r.directSpecular.addAssign(n.mul(rm({lightDirection:e,f0:Ml,f90:1,roughness:ml,iridescence:this.iridescence,f:this.iridescenceFresnel,USE_IRIDESCENCE:this.iridescence,USE_ANISOTROPY:this.anisotropy})))}directRectArea({lightColor:e,lightPosition:t,halfWidth:r,halfHeight:n,reflectedLight:i,ltc_1:s,ltc_2:o}){const a=t.add(r).sub(n),u=t.sub(r).sub(n),l=t.sub(r).add(n),c=t.add(r).add(n),h=tp,d=qd,p=Wd.toVar(),f=lm({N:h,V:d,roughness:ml}),g=s.sample(f).toVar(),m=o.sample(f).toVar(),y=ll(el(g.x,0,g.y),el(0,1,0),el(g.z,0,g.w)).toVar(),b=Ml.mul(m.x).add(Ml.oneMinus().mul(m.y)).toVar();i.directSpecular.addAssign(e.mul(b).mul(dm({N:h,V:d,P:p,mInv:y,p0:a,p1:u,p2:l,p3:c}))),i.directDiffuse.addAssign(e.mul(fl).mul(dm({N:h,V:d,P:p,mInv:ll(1,0,0,0,1,0,0,0,1),p0:a,p1:u,p2:l,p3:c})))}indirect(e){this.indirectDiffuse(e),this.indirectSpecular(e),this.ambientOcclusion(e)}indirectDiffuse(e){const{irradiance:t,reflectedLight:r}=e.context;r.indirectDiffuse.addAssign(t.mul(jg({diffuseColor:fl})))}indirectSpecular(e){const{radiance:t,iblIrradiance:r,reflectedLight:n}=e.context;if(!0===this.sheen&&this.sheenSpecularIndirect.addAssign(r.mul(vl,Om({normal:tp,viewDir:qd,roughness:xl}))),!0===this.clearcoat){const e=np.dot(qd).clamp(),t=im({dotNV:e,specularColor:Lm,specularF90:Bm,roughness:_l});this.clearcoatSpecularIndirect.addAssign(this.clearcoatRadiance.mul(t))}const i=el().toVar("singleScattering"),s=el().toVar("multiScattering"),o=r.mul(1/Math.PI);this.computeMultiscattering(i,s,Rl);const a=i.add(s),u=fl.mul(a.r.max(a.g).max(a.b).oneMinus());n.indirectSpecular.addAssign(t.mul(i)),n.indirectSpecular.addAssign(s.mul(o)),n.indirectDiffuse.addAssign(u.mul(o))}ambientOcclusion(e){const{ambientOcclusion:t,reflectedLight:r}=e.context,n=tp.dot(qd).clamp().add(t),i=ml.mul(-16).oneMinus().negate().exp2(),s=t.sub(n.pow(i).oneMinus()).clamp();!0===this.clearcoat&&this.clearcoatSpecularIndirect.mulAssign(t),!0===this.sheen&&this.sheenSpecularIndirect.mulAssign(t),r.indirectDiffuse.mulAssign(t),r.indirectSpecular.mulAssign(s)}finish({context:e}){const{outgoingLight:t}=e;if(!0===this.clearcoat){const e=np.dot(qd).clamp(),r=Vg({dotVH:e,f0:Lm,f90:Bm}),n=t.mul(bl.mul(r).oneMinus()).add(this.clearcoatSpecularDirect.add(this.clearcoatSpecularIndirect).mul(bl));t.assign(n)}if(!0===this.sheen){const e=vl.r.max(vl.g).max(vl.b).mul(.157).oneMinus(),r=t.mul(e).add(this.sheenSpecularDirect,this.sheenSpecularIndirect);t.assign(r)}}}const Im=Wu(1),Um=Wu(-2),Vm=Wu(.8),jm=Wu(-1),Gm=Wu(.4),zm=Wu(2),$m=Wu(.305),Hm=Wu(3),Wm=Wu(.21),qm=Wu(4),Xm=Wu(4),Km=Wu(16),Ym=Vu((([e])=>{const t=el(Xc(e)).toVar(),r=Wu(-1).toVar();return zu(t.x.greaterThan(t.z),(()=>{zu(t.x.greaterThan(t.y),(()=>{r.assign(Ah(e.x.greaterThan(0),0,3))})).Else((()=>{r.assign(Ah(e.y.greaterThan(0),1,4))}))})).Else((()=>{zu(t.z.greaterThan(t.y),(()=>{r.assign(Ah(e.z.greaterThan(0),2,5))})).Else((()=>{r.assign(Ah(e.y.greaterThan(0),1,4))}))})),r})).setLayout({name:"getFace",type:"float",inputs:[{name:"direction",type:"vec3"}]}),Qm=Vu((([e,t])=>{const r=Yu().toVar();return zu(t.equal(0),(()=>{r.assign(Yu(e.z,e.y).div(Xc(e.x)))})).ElseIf(t.equal(1),(()=>{r.assign(Yu(e.x.negate(),e.z.negate()).div(Xc(e.y)))})).ElseIf(t.equal(2),(()=>{r.assign(Yu(e.x.negate(),e.y).div(Xc(e.z)))})).ElseIf(t.equal(3),(()=>{r.assign(Yu(e.z.negate(),e.y).div(Xc(e.x)))})).ElseIf(t.equal(4),(()=>{r.assign(Yu(e.x.negate(),e.z).div(Xc(e.y)))})).Else((()=>{r.assign(Yu(e.x,e.y).div(Xc(e.z)))})),rc(.5,r.add(1))})).setLayout({name:"getUV",type:"vec2",inputs:[{name:"direction",type:"vec3"},{name:"face",type:"float"}]}),Zm=Vu((([e])=>{const t=Wu(0).toVar();return zu(e.greaterThanEqual(Vm),(()=>{t.assign(Im.sub(e).mul(jm.sub(Um)).div(Im.sub(Vm)).add(Um))})).ElseIf(e.greaterThanEqual(Gm),(()=>{t.assign(Vm.sub(e).mul(zm.sub(jm)).div(Vm.sub(Gm)).add(jm))})).ElseIf(e.greaterThanEqual($m),(()=>{t.assign(Gm.sub(e).mul(Hm.sub(zm)).div(Gm.sub($m)).add(zm))})).ElseIf(e.greaterThanEqual(Wm),(()=>{t.assign($m.sub(e).mul(qm.sub(Hm)).div($m.sub(Wm)).add(Hm))})).Else((()=>{t.assign(Wu(-2).mul(Lc(rc(1.16,e))))})),t})).setLayout({name:"roughnessToMip",type:"float",inputs:[{name:"roughness",type:"float"}]}),Jm=Vu((([e,t])=>{const r=e.toVar();r.assign(rc(2,r).sub(1));const n=el(r,1).toVar();return zu(t.equal(0),(()=>{n.assign(n.zyx)})).ElseIf(t.equal(1),(()=>{n.assign(n.xzy),n.xz.mulAssign(-1)})).ElseIf(t.equal(2),(()=>{n.x.mulAssign(-1)})).ElseIf(t.equal(3),(()=>{n.assign(n.zyx),n.xz.mulAssign(-1)})).ElseIf(t.equal(4),(()=>{n.assign(n.xzy),n.xy.mulAssign(-1)})).ElseIf(t.equal(5),(()=>{n.z.mulAssign(-1)})),n})).setLayout({name:"getDirection",type:"vec3",inputs:[{name:"uv",type:"vec2"},{name:"face",type:"float"}]}),ey=Vu((([e,t,r,n,i,s])=>{const o=Wu(r),a=el(t),u=xh(Zm(o),Um,s),l=jc(u),c=Ic(u),h=el(ty(e,a,c,n,i,s)).toVar();return zu(l.notEqual(0),(()=>{const t=el(ty(e,a,c.add(1),n,i,s)).toVar();h.assign(vh(h,t,l))})),h})),ty=Vu((([e,t,r,n,i,s])=>{const o=Wu(r).toVar(),a=el(t),u=Wu(Ym(a)).toVar(),l=Wu(ah(Xm.sub(o),0)).toVar();o.assign(ah(o,Xm));const c=Wu(Fc(o)).toVar(),h=Yu(Qm(a,u).mul(c.sub(2)).add(1)).toVar();return zu(u.greaterThan(2),(()=>{h.y.addAssign(c),u.subAssign(3)})),h.x.addAssign(u.mul(c)),h.x.addAssign(l.mul(rc(3,Km))),h.y.addAssign(rc(4,Fc(s).sub(c))),h.x.mulAssign(n),h.y.mulAssign(i),e.sample(h).grad(Yu(),Yu())})),ry=Vu((({envMap:e,mipInt:t,outputDirection:r,theta:n,axis:i,CUBEUV_TEXEL_WIDTH:s,CUBEUV_TEXEL_HEIGHT:o,CUBEUV_MAX_MIP:a})=>{const u=zc(n),l=r.mul(u).add(i.cross(r).mul(Gc(n))).add(i.mul(i.dot(r).mul(u.oneMinus())));return ty(e,l,t,s,o,a)})),ny=Vu((({n:e,latitudinal:t,poleAxis:r,outputDirection:n,weights:i,samples:s,dTheta:o,mipInt:a,envMap:u,CUBEUV_TEXEL_WIDTH:l,CUBEUV_TEXEL_HEIGHT:c,CUBEUV_MAX_MIP:h})=>{const d=el(Ah(t,r,ph(r,n))).toVar();zu(d.equal(el(0)),(()=>{d.assign(el(n.z,0,n.x.negate()))})),d.assign(Vc(d));const p=el().toVar();return p.addAssign(i.element(0).mul(ry({theta:0,axis:d,outputDirection:n,mipInt:a,envMap:u,CUBEUV_TEXEL_WIDTH:l,CUBEUV_TEXEL_HEIGHT:c,CUBEUV_MAX_MIP:h}))),kf({start:qu(1),end:e},(({i:e})=>{zu(e.greaterThanEqual(s),(()=>{id("break").toStack()}));const t=Wu(o.mul(Wu(e))).toVar();p.addAssign(i.element(e).mul(ry({theta:t.mul(-1),axis:d,outputDirection:n,mipInt:a,envMap:u,CUBEUV_TEXEL_WIDTH:l,CUBEUV_TEXEL_HEIGHT:c,CUBEUV_MAX_MIP:h}))),p.addAssign(i.element(e).mul(ry({theta:t,axis:d,outputDirection:n,mipInt:a,envMap:u,CUBEUV_TEXEL_WIDTH:l,CUBEUV_TEXEL_HEIGHT:c,CUBEUV_MAX_MIP:h})))})),il(p,1)})),iy=[.125,.215,.35,.446,.526,.582],sy=20,oy=new Z(-1,1,1,-1,0,1),ay=new re(90,1),uy=new h;let ly=null,cy=0,hy=0;const dy=(1+Math.sqrt(5))/2,py=1/dy,fy=[new o(-dy,py,0),new o(dy,py,0),new o(-py,0,dy),new o(py,0,dy),new o(0,dy,-py),new o(0,dy,py),new o(-1,1,-1),new o(1,1,-1),new o(-1,1,1),new o(1,1,1)],gy=new o,my=new WeakMap,yy=[3,1,5,0,4,2],by=Jm(ld(),ud("faceIndex")).normalize(),_y=el(by.x,by.y,by.z);class vy{constructor(e){this._renderer=e,this._pingPongRenderTarget=null,this._lodMax=0,this._cubeSize=0,this._lodPlanes=[],this._sizeLods=[],this._sigmas=[],this._lodMeshes=[],this._blurMaterial=null,this._cubemapMaterial=null,this._equirectMaterial=null,this._backgroundBox=null}get _hasInitialized(){return this._renderer.hasInitialized()}fromScene(e,t=0,r=.1,n=100,i={}){const{size:s=256,position:o=gy,renderTarget:a=null}=i;if(this._setSize(s),!1===this._hasInitialized){const s=a||this._allocateTarget();return i.renderTarget=s,this.fromSceneAsync(e,t,r,n,i),s}ly=this._renderer.getRenderTarget(),cy=this._renderer.getActiveCubeFace(),hy=this._renderer.getActiveMipmapLevel();const u=a||this._allocateTarget();return u.depthBuffer=!0,this._init(u),this._sceneToCubeUV(e,r,n,u,o),t>0&&this._blur(u,0,0,t),this._applyPMREM(u),this._cleanup(u),u}async fromSceneAsync(e,t=0,r=.1,n=100,i={}){return!1===this._hasInitialized&&await this._renderer.init(),this.fromScene(e,t,r,n,i)}fromEquirectangular(e,t=null){if(!1===this._hasInitialized){this._setSizeFromTexture(e);const r=t||this._allocateTarget();return this.fromEquirectangularAsync(e,r),r}return this._fromTexture(e,t)}async fromEquirectangularAsync(e,t=null){return!1===this._hasInitialized&&await this._renderer.init(),this._fromTexture(e,t)}fromCubemap(e,t=null){if(!1===this._hasInitialized){this._setSizeFromTexture(e);const r=t||this._allocateTarget();return this.fromCubemapAsync(e,t),r}return this._fromTexture(e,t)}async fromCubemapAsync(e,t=null){return!1===this._hasInitialized&&await this._renderer.init(),this._fromTexture(e,t)}async compileCubemapShader(){null===this._cubemapMaterial&&(this._cubemapMaterial=Sy(),await this._compileMaterial(this._cubemapMaterial))}async compileEquirectangularShader(){null===this._equirectMaterial&&(this._equirectMaterial=Ny(),await this._compileMaterial(this._equirectMaterial))}dispose(){this._dispose(),null!==this._cubemapMaterial&&this._cubemapMaterial.dispose(),null!==this._equirectMaterial&&this._equirectMaterial.dispose(),null!==this._backgroundBox&&(this._backgroundBox.geometry.dispose(),this._backgroundBox.material.dispose())}_setSizeFromTexture(e){e.mapping===ln||e.mapping===cn?this._setSize(0===e.image.length?16:e.image[0].width||e.image[0].image.width):this._setSize(e.image.width/4)}_setSize(e){this._lodMax=Math.floor(Math.log2(e)),this._cubeSize=Math.pow(2,this._lodMax)}_dispose(){null!==this._blurMaterial&&this._blurMaterial.dispose(),null!==this._pingPongRenderTarget&&this._pingPongRenderTarget.dispose();for(let e=0;e<this._lodPlanes.length;e++)this._lodPlanes[e].dispose()}_cleanup(e){this._renderer.setRenderTarget(ly,cy,hy),e.scissorTest=!1,Ty(e,0,0,e.width,e.height)}_fromTexture(e,t){this._setSizeFromTexture(e),ly=this._renderer.getRenderTarget(),cy=this._renderer.getActiveCubeFace(),hy=this._renderer.getActiveMipmapLevel();const r=t||this._allocateTarget();return this._init(r),this._textureToCubeUV(e,r),this._applyPMREM(r),this._cleanup(r),r}_allocateTarget(){return xy(3*Math.max(this._cubeSize,112),4*this._cubeSize)}_init(e){if(null===this._pingPongRenderTarget||this._pingPongRenderTarget.width!==e.width||this._pingPongRenderTarget.height!==e.height){null!==this._pingPongRenderTarget&&this._dispose(),this._pingPongRenderTarget=xy(e.width,e.height);const{_lodMax:t}=this;({sizeLods:this._sizeLods,lodPlanes:this._lodPlanes,sigmas:this._sigmas,lodMeshes:this._lodMeshes}=function(e){const t=[],r=[],n=[],i=[];let s=e;const o=e-4+1+iy.length;for(let a=0;a<o;a++){const o=Math.pow(2,s);r.push(o);let u=1/o;a>e-4?u=iy[a-e+4-1]:0===a&&(u=0),n.push(u);const c=1/(o-2),h=-c,d=1+c,g=[h,h,d,h,d,d,h,h,d,d,h,d],m=6,y=6,b=3,_=2,v=1,x=new Float32Array(b*y*m),T=new Float32Array(_*y*m),w=new Float32Array(v*y*m);for(let e=0;e<m;e++){const t=e%3*2/3-1,r=e>2?0:-1,n=[t,r,0,t+2/3,r,0,t+2/3,r+1,0,t,r,0,t+2/3,r+1,0,t,r+1,0],i=yy[e];x.set(n,b*y*i),T.set(g,_*y*i);const s=[i,i,i,i,i,i];w.set(s,v*y*i)}const S=new p;S.setAttribute("position",new f(x,b)),S.setAttribute("uv",new f(T,_)),S.setAttribute("faceIndex",new f(w,v)),t.push(S),i.push(new l(S,null)),s>4&&s--}return{lodPlanes:t,sizeLods:r,sigmas:n,lodMeshes:i}}(t)),this._blurMaterial=function(e,t,r){const n=wd(new Array(sy).fill(0)),i=Xl(new o(0,1,0)),s=Xl(0),a=Wu(sy),u=Xl(0),l=Xl(1),c=yd(null),h=Xl(0),d=Wu(1/t),p=Wu(1/r),f=Wu(e),g={n:a,latitudinal:u,weights:n,poleAxis:i,outputDirection:_y,dTheta:s,samples:l,envMap:c,mipInt:h,CUBEUV_TEXEL_WIDTH:d,CUBEUV_TEXEL_HEIGHT:p,CUBEUV_MAX_MIP:f},m=wy("blur");return m.fragmentNode=ny({...g,latitudinal:u.equal(1)}),my.set(m,g),m}(t,e.width,e.height)}}async _compileMaterial(e){const t=new l(this._lodPlanes[0],e);await this._renderer.compile(t,oy)}_sceneToCubeUV(e,t,r,n,i){const s=ay;s.near=t,s.far=r;const o=[1,1,1,1,-1,1],a=[1,-1,1,-1,1,-1],u=this._renderer,c=u.autoClear;u.getClearColor(uy),u.autoClear=!1;let h=this._backgroundBox;if(null===h){const e=new he({name:"PMREM.Background",side:L,depthWrite:!1,depthTest:!1});h=new l(new nn,e)}let d=!1;const p=e.background;p?p.isColor&&(h.material.color.copy(p),e.background=null,d=!0):(h.material.color.copy(uy),d=!0),u.setRenderTarget(n),u.clear(),d&&u.render(h,s);for(let l=0;l<6;l++){const t=l%3;0===t?(s.up.set(0,o[l],0),s.position.set(i.x,i.y,i.z),s.lookAt(i.x+a[l],i.y,i.z)):1===t?(s.up.set(0,0,o[l]),s.position.set(i.x,i.y,i.z),s.lookAt(i.x,i.y+a[l],i.z)):(s.up.set(0,o[l],0),s.position.set(i.x,i.y,i.z),s.lookAt(i.x,i.y,i.z+a[l]));const r=this._cubeSize;Ty(n,t*r,l>2?r:0,r,r),u.render(e,s)}u.autoClear=c,e.background=p}_textureToCubeUV(e,t){const r=this._renderer,n=e.mapping===ln||e.mapping===cn;n?null===this._cubemapMaterial&&(this._cubemapMaterial=Sy(e)):null===this._equirectMaterial&&(this._equirectMaterial=Ny(e));const i=n?this._cubemapMaterial:this._equirectMaterial;i.fragmentNode.value=e;const s=this._lodMeshes[0];s.material=i;const o=this._cubeSize;Ty(t,0,0,3*o,2*o),r.setRenderTarget(t),r.render(s,oy)}_applyPMREM(e){const t=this._renderer,r=t.autoClear;t.autoClear=!1;const n=this._lodPlanes.length;for(let i=1;i<n;i++){const t=Math.sqrt(this._sigmas[i]*this._sigmas[i]-this._sigmas[i-1]*this._sigmas[i-1]),r=fy[(n-i-1)%fy.length];this._blur(e,i-1,i,t,r)}t.autoClear=r}_blur(e,t,r,n,i){const s=this._pingPongRenderTarget;this._halfBlur(e,s,t,r,n,"latitudinal",i),this._halfBlur(s,e,r,r,n,"longitudinal",i)}_halfBlur(e,t,r,n,i,s,o){const a=this._renderer,u=this._blurMaterial,l=this._lodMeshes[n];l.material=u;const c=my.get(u),h=this._sizeLods[r]-1,d=isFinite(i)?Math.PI/(2*h):2*Math.PI/39,p=i/d,f=isFinite(i)?1+Math.floor(3*p):sy,g=[];let m=0;for(let _=0;_<sy;++_){const e=_/p,t=Math.exp(-e*e/2);g.push(t),0===_?m+=t:_<f&&(m+=2*t)}for(let _=0;_<g.length;_++)g[_]=g[_]/m;e.texture.frame=(e.texture.frame||0)+1,c.envMap.value=e.texture,c.samples.value=f,c.weights.array=g,c.latitudinal.value="latitudinal"===s?1:0,o&&(c.poleAxis.value=o);const{_lodMax:y}=this;c.dTheta.value=d,c.mipInt.value=y-r;const b=this._sizeLods[n];Ty(t,3*b*(n>y-4?n-y+4:0),4*(this._cubeSize-b),3*b,2*b),a.setRenderTarget(t),a.render(l,oy)}}function xy(e,t){const r=new M(e,t,{magFilter:R,minFilter:R,generateMipmaps:!1,type:w,format:D,colorSpace:P});return r.texture.mapping=_e,r.texture.name="PMREM.cubeUv",r.texture.isPMREMTexture=!0,r.scissorTest=!0,r}function Ty(e,t,r,n,i){e.viewport.set(t,r,n,i),e.scissor.set(t,r,n,i)}function wy(e){const t=new _g;return t.depthTest=!1,t.depthWrite=!1,t.blending=dt,t.name=`PMREM_${e}`,t}function Sy(e){const t=wy("cubemap");return t.fragmentNode=bp(e,_y),t}function Ny(e){const t=wy("equirect");return t.fragmentNode=yd(e,Cg(_y),0),t}const Ey=new WeakMap;function Cy(e,t,r){const n=function(e){let t=Ey.get(e);void 0===t&&(t=new WeakMap,Ey.set(e,t));return t}(t);let i=n.get(e);if((void 0!==i?i.pmremVersion:-1)!==e.pmremVersion){const t=e.image;if(e.isCubeTexture){if(!function(e){if(null==e)return!1;let t=0;const r=6;for(let n=0;n<r;n++)void 0!==e[n]&&t++;return t===r}(t))return null;i=r.fromCubemap(e,i)}else{if(!function(e){return null!=e&&e.height>0}(t))return null;i=r.fromEquirectangular(e,i)}i.pmremVersion=e.pmremVersion,n.set(e,i)}return i.texture}class Ay extends Ya{static get type(){return"PMREMNode"}constructor(e,t=null,r=null){super("vec3"),this._value=e,this._pmrem=null,this.uvNode=t,this.levelNode=r,this._generator=null;const n=new xe;n.isRenderTargetTexture=!0,this._texture=yd(n),this._width=Xl(0),this._height=Xl(0),this._maxMip=Xl(0),this.updateBeforeType=ka}set value(e){this._value=e,this._pmrem=null}get value(){return this._value}updateFromTexture(e){const t=function(e){const t=Math.log2(e)-2,r=1/e;return{texelWidth:1/(3*Math.max(Math.pow(2,t),112)),texelHeight:r,maxMip:t}}(e.image.height);this._texture.value=e,this._width.value=t.texelWidth,this._height.value=t.texelHeight,this._maxMip.value=t.maxMip}updateBefore(e){let t=this._pmrem;const r=t?t.pmremVersion:-1,n=this._value;r!==n.pmremVersion&&(t=!0===n.isPMREMTexture?n:Cy(n,e.renderer,this._generator),null!==t&&(this._pmrem=t,this.updateFromTexture(t)))}setup(e){null===this._generator&&(this._generator=new vy(e.renderer)),this.updateBefore(e);let t=this.uvNode;null===t&&e.context.getUV&&(t=e.context.getUV(this)),t=cp.mul(el(t.x,t.y.negate(),t.z));let r=this.levelNode;return null===r&&e.context.getTextureLevel&&(r=e.context.getTextureLevel(this)),ey(this._texture,t,r,this._width,this._height,this._maxMip)}dispose(){super.dispose(),null!==this._generator&&this._generator.dispose()}}const My=ku(Ay).setParameterLength(1,3),Ry=new WeakMap;class Py extends zf{static get type(){return"EnvironmentNode"}constructor(e=null){super(),this.envNode=e}setup(e){const{material:t}=e;let r=this.envNode;if(r.isTextureNode||r.isMaterialReferenceNode){const e=r.isTextureNode?r.value:t[r.property];let n=Ry.get(e);void 0===n&&(n=My(e),Ry.set(e,n)),r=n}const n=!0===t.useAnisotropy||t.anisotropy>0?Rp:tp,i=r.context(Dy(ml,n)).mul(lp),s=r.context(Fy(rp)).mul(Math.PI).mul(lp),o=Zh(i),a=Zh(s);e.context.radiance.addAssign(o),e.context.iblIrradiance.addAssign(a);const u=e.context.lightingModel.clearcoatRadiance;if(u){const e=r.context(Dy(_l,np)).mul(lp),t=Zh(e);u.addAssign(t)}}}const Dy=(e,t)=>{let r=null;return{getUV:()=>(null===r&&(r=qd.negate().reflect(t),r=e.mul(e).mix(r,t).normalize(),r=r.transformDirection(Md)),r),getTextureLevel:()=>e}},Fy=e=>({getUV:()=>e,getTextureLevel:()=>Wu(1)}),Oy=new gr;class Ly extends _g{static get type(){return"MeshStandardNodeMaterial"}constructor(e){super(),this.isMeshStandardNodeMaterial=!0,this.lights=!0,this.emissiveNode=null,this.metalnessNode=null,this.roughnessNode=null,this.setDefaultValues(Oy),this.setValues(e)}setupEnvironment(e){let t=super.setupEnvironment(e);return null===t&&e.environmentNode&&(t=e.environmentNode),t?new Py(t):null}setupLightingModel(){return new km}setupSpecular(){const e=vh(el(.04),fl.rgb,yl);Ml.assign(e),Rl.assign(1)}setupVariants(){const e=this.metalnessNode?Wu(this.metalnessNode):Qp;yl.assign(e);let t=this.roughnessNode?Wu(this.roughnessNode):Yp;t=Yg({roughness:t}),ml.assign(t),this.setupSpecular(),fl.assign(il(fl.rgb.mul(e.oneMinus()),fl.a))}copy(e){return this.emissiveNode=e.emissiveNode,this.metalnessNode=e.metalnessNode,this.roughnessNode=e.roughnessNode,super.copy(e)}}const By=new mr;class ky extends Ly{static get type(){return"MeshPhysicalNodeMaterial"}constructor(e){super(),this.isMeshPhysicalNodeMaterial=!0,this.clearcoatNode=null,this.clearcoatRoughnessNode=null,this.clearcoatNormalNode=null,this.sheenNode=null,this.sheenRoughnessNode=null,this.iridescenceNode=null,this.iridescenceIORNode=null,this.iridescenceThicknessNode=null,this.specularIntensityNode=null,this.specularColorNode=null,this.iorNode=null,this.transmissionNode=null,this.thicknessNode=null,this.attenuationDistanceNode=null,this.attenuationColorNode=null,this.dispersionNode=null,this.anisotropyNode=null,this.setDefaultValues(By),this.setValues(e)}get useClearcoat(){return this.clearcoat>0||null!==this.clearcoatNode}get useIridescence(){return this.iridescence>0||null!==this.iridescenceNode}get useSheen(){return this.sheen>0||null!==this.sheenNode}get useAnisotropy(){return this.anisotropy>0||null!==this.anisotropyNode}get useTransmission(){return this.transmission>0||null!==this.transmissionNode}get useDispersion(){return this.dispersion>0||null!==this.dispersionNode}setupSpecular(){const e=this.iorNode?Wu(this.iorNode):df;Ll.assign(e),Ml.assign(vh(oh(gh(Ll.sub(1).div(Ll.add(1))).mul(qp),el(1)).mul(Wp),fl.rgb,yl)),Rl.assign(vh(Wp,1,yl))}setupLightingModel(){return new km(this.useClearcoat,this.useSheen,this.useIridescence,this.useAnisotropy,this.useTransmission,this.useDispersion)}setupVariants(e){if(super.setupVariants(e),this.useClearcoat){const e=this.clearcoatNode?Wu(this.clearcoatNode):Jp,t=this.clearcoatRoughnessNode?Wu(this.clearcoatRoughnessNode):ef;bl.assign(e),_l.assign(Yg({roughness:t}))}if(this.useSheen){const e=this.sheenNode?el(this.sheenNode):nf,t=this.sheenRoughnessNode?Wu(this.sheenRoughnessNode):sf;vl.assign(e),xl.assign(t)}if(this.useIridescence){const e=this.iridescenceNode?Wu(this.iridescenceNode):af,t=this.iridescenceIORNode?Wu(this.iridescenceIORNode):uf,r=this.iridescenceThicknessNode?Wu(this.iridescenceThicknessNode):lf;Tl.assign(e),wl.assign(t),Sl.assign(r)}if(this.useAnisotropy){const e=(this.anisotropyNode?Yu(this.anisotropyNode):of).toVar();El.assign(e.length()),zu(El.equal(0),(()=>{e.assign(Yu(1,0))})).Else((()=>{e.divAssign(Yu(El)),El.assign(El.saturate())})),Nl.assign(El.pow2().mix(ml.pow2(),1)),Cl.assign(Mp[0].mul(e.x).add(Mp[1].mul(e.y))),Al.assign(Mp[1].mul(e.x).sub(Mp[0].mul(e.y)))}if(this.useTransmission){const e=this.transmissionNode?Wu(this.transmissionNode):cf,t=this.thicknessNode?Wu(this.thicknessNode):hf,r=this.attenuationDistanceNode?Wu(this.attenuationDistanceNode):pf,n=this.attenuationColorNode?el(this.attenuationColorNode):ff;if(Bl.assign(e),kl.assign(t),Il.assign(r),Ul.assign(n),this.useDispersion){const e=this.dispersionNode?Wu(this.dispersionNode):vf;Vl.assign(e)}}}setupClearcoatNormal(){return this.clearcoatNormalNode?el(this.clearcoatNormalNode):tf}setup(e){e.context.setupClearcoatNormal=()=>this.setupClearcoatNormal(e),super.setup(e)}copy(e){return this.clearcoatNode=e.clearcoatNode,this.clearcoatRoughnessNode=e.clearcoatRoughnessNode,this.clearcoatNormalNode=e.clearcoatNormalNode,this.sheenNode=e.sheenNode,this.sheenRoughnessNode=e.sheenRoughnessNode,this.iridescenceNode=e.iridescenceNode,this.iridescenceIORNode=e.iridescenceIORNode,this.iridescenceThicknessNode=e.iridescenceThicknessNode,this.specularIntensityNode=e.specularIntensityNode,this.specularColorNode=e.specularColorNode,this.transmissionNode=e.transmissionNode,this.thicknessNode=e.thicknessNode,this.attenuationDistanceNode=e.attenuationDistanceNode,this.attenuationColorNode=e.attenuationColorNode,this.dispersionNode=e.dispersionNode,this.anisotropyNode=e.anisotropyNode,super.copy(e)}}const Iy=Vu((({normal:e,lightDirection:t,builder:r})=>{const n=e.dot(t),i=Yu(n.mul(.5).add(.5),0);if(r.material.gradientMap){const e=Sp("gradientMap","texture").context({getUV:()=>i});return el(e.r)}{const e=i.fwidth().mul(.5);return vh(el(.7),el(1),Sh(Wu(.7).sub(e.x),Wu(.7).add(e.x),i.x))}}));class Uy extends Bg{direct({lightDirection:e,lightColor:t,reflectedLight:r},n){const i=Iy({normal:Yd,lightDirection:e,builder:n}).mul(t);r.directDiffuse.addAssign(i.mul(jg({diffuseColor:fl.rgb})))}indirect(e){const{ambientOcclusion:t,irradiance:r,reflectedLight:n}=e.context;n.indirectDiffuse.addAssign(r.mul(jg({diffuseColor:fl}))),n.indirectDiffuse.mulAssign(t)}}const Vy=new yr;class jy extends _g{static get type(){return"MeshToonNodeMaterial"}constructor(e){super(),this.isMeshToonNodeMaterial=!0,this.lights=!0,this.setDefaultValues(Vy),this.setValues(e)}setupLightingModel(){return new Uy}}class Gy extends Ya{static get type(){return"MatcapUVNode"}constructor(){super("vec2")}setup(){const e=el(qd.z,0,qd.x.negate()).normalize(),t=qd.cross(e);return Yu(e.dot(tp),t.dot(tp)).mul(.495).add(.5)}}const zy=Iu(Gy),$y=new _r;class Hy extends _g{static get type(){return"MeshMatcapNodeMaterial"}constructor(e){super(),this.isMeshMatcapNodeMaterial=!0,this.setDefaultValues($y),this.setValues(e)}setupVariants(e){const t=zy;let r;r=e.material.matcap?Sp("matcap","texture").context({getUV:()=>t}):el(vh(.2,.8,t.y)),fl.rgb.mulAssign(r.rgb)}}class Wy extends Ya{static get type(){return"RotateNode"}constructor(e,t){super(),this.positionNode=e,this.rotationNode=t}getNodeType(e){return this.positionNode.getNodeType(e)}setup(e){const{rotationNode:t,positionNode:r}=this;if("vec2"===this.getNodeType(e)){const e=t.cos(),n=t.sin();return ul(e,n,n.negate(),e).mul(r)}{const e=t,n=cl(il(1,0,0,0),il(0,zc(e.x),Gc(e.x).negate(),0),il(0,Gc(e.x),zc(e.x),0),il(0,0,0,1)),i=cl(il(zc(e.y),0,Gc(e.y),0),il(0,1,0,0),il(Gc(e.y).negate(),0,zc(e.y),0),il(0,0,0,1)),s=cl(il(zc(e.z),Gc(e.z).negate(),0,0),il(Gc(e.z),zc(e.z),0,0),il(0,0,1,0),il(0,0,0,1));return n.mul(i).mul(s).mul(il(r,1)).xyz}}}const qy=ku(Wy).setParameterLength(2),Xy=new Tr;class Ky extends _g{static get type(){return"SpriteNodeMaterial"}constructor(e){super(),this.isSpriteNodeMaterial=!0,this._useSizeAttenuation=!0,this.positionNode=null,this.rotationNode=null,this.scaleNode=null,this.transparent=!0,this.setDefaultValues(Xy),this.setValues(e)}setupPositionView(e){const{object:t,camera:r}=e,n=this.sizeAttenuation,{positionNode:i,rotationNode:s,scaleNode:o}=this,a=kd.mul(el(i||0));let u=Yu(Ld[0].xyz.length(),Ld[1].xyz.length());if(null!==o&&(u=u.mul(Yu(o))),!1===n)if(r.isPerspectiveCamera)u=u.mul(a.z.negate());else{const e=Wu(2).div(Ad.element(1).element(1));u=u.mul(e.mul(2))}let l=jd.xy;if(t.center&&!0===t.center.isVector2){const e=((e,t,r)=>Ou(new jh(e,t,r)))("center","vec2",t);l=l.sub(e.sub(.5))}l=l.mul(u);const c=Wu(s||rf),h=qy(l,c);return il(a.xy.add(h),a.zw)}copy(e){return this.positionNode=e.positionNode,this.rotationNode=e.rotationNode,this.scaleNode=e.scaleNode,super.copy(e)}get sizeAttenuation(){return this._useSizeAttenuation}set sizeAttenuation(e){this._useSizeAttenuation!==e&&(this._useSizeAttenuation=e,this.needsUpdate=!0)}}const Yy=new xr;class Qy extends Ky{static get type(){return"PointsNodeMaterial"}constructor(e){super(),this.sizeNode=null,this.isPointsNodeMaterial=!0,this.setDefaultValues(Yy),this.setValues(e)}setupPositionView(){const{positionNode:e}=this;return kd.mul(el(e||Gd)).xyz}setupVertex(e){const t=super.setupVertex(e);if(!0!==e.material.isNodeMaterial)return t;const{rotationNode:r,scaleNode:n,sizeNode:i}=this,s=jd.xy.toVar(),o=eg.z.div(eg.w);if(r&&r.isNode){const e=Wu(r);s.assign(qy(s,e))}let a=null!==i?Yu(i):_f;return!0===this.sizeAttenuation&&(a=a.mul(a.div(Wd.z.negate()))),n&&n.isNode&&(a=a.mul(Yu(n))),s.mulAssign(a.mul(2)),s.assign(s.div(eg.z)),s.y.assign(s.y.mul(o)),s.assign(s.mul(t.w)),t.addAssign(il(s,0,0)),t}get alphaToCoverage(){return this._useAlphaToCoverage}set alphaToCoverage(e){this._useAlphaToCoverage!==e&&(this._useAlphaToCoverage=e,this.needsUpdate=!0)}}class Zy extends Bg{constructor(){super(),this.shadowNode=Wu(1).toVar("shadowMask")}direct({lightNode:e}){null!==e.shadowNode&&this.shadowNode.mulAssign(e.shadowNode)}finish({context:e}){fl.a.mulAssign(this.shadowNode.oneMinus()),e.outgoingLight.rgb.assign(fl.rgb)}}const Jy=new wr;class eb extends _g{static get type(){return"ShadowNodeMaterial"}constructor(e){super(),this.isShadowNodeMaterial=!0,this.lights=!0,this.transparent=!0,this.setDefaultValues(Jy),this.setValues(e)}setupLightingModel(){return new Zy}}dl("vec3"),dl("vec3"),dl("vec3");class tb{constructor(e,t){this.nodes=e,this.info=t,this._context="undefined"!=typeof self?self:null,this._animationLoop=null,this._requestId=null}start(){const e=(t,r)=>{this._requestId=this._context.requestAnimationFrame(e),!0===this.info.autoReset&&this.info.reset(),this.nodes.nodeFrame.update(),this.info.frame=this.nodes.nodeFrame.frameId,null!==this._animationLoop&&this._animationLoop(t,r)};e()}stop(){this._context.cancelAnimationFrame(this._requestId),this._requestId=null}getAnimationLoop(){return this._animationLoop}setAnimationLoop(e){this._animationLoop=e}getContext(){return this._context}setContext(e){this._context=e}dispose(){this.stop()}}class rb{constructor(){this.weakMap=new WeakMap}get(e){let t=this.weakMap;for(let r=0;r<e.length-1;r++)if(t=t.get(e[r]),void 0===t)return;return t.get(e[e.length-1])}set(e,t){let r=this.weakMap;for(let n=0;n<e.length-1;n++){const t=e[n];!1===r.has(t)&&r.set(t,new WeakMap),r=r.get(t)}return r.set(e[e.length-1],t),this}delete(e){let t=this.weakMap;for(let r=0;r<e.length-1;r++)if(t=t.get(e[r]),void 0===t)return!1;return t.delete(e[e.length-1])}}let nb=0;class ib{constructor(e,t,r,n,i,s,o,a,u,l){this.id=nb++,this._nodes=e,this._geometries=t,this.renderer=r,this.object=n,this.material=i,this.scene=s,this.camera=o,this.lightsNode=a,this.context=u,this.geometry=n.geometry,this.version=i.version,this.drawRange=null,this.attributes=null,this.pipeline=null,this.group=null,this.vertexBuffers=null,this.drawParams=null,this.bundle=null,this.clippingContext=l,this.clippingContextCacheKey=null!==l?l.cacheKey:"",this.initialNodesCacheKey=this.getDynamicCacheKey(),this.initialCacheKey=this.getCacheKey(),this._nodeBuilderState=null,this._bindings=null,this._monitor=null,this.onDispose=null,this.isRenderObject=!0,this.onMaterialDispose=()=>{this.dispose()},this.material.addEventListener("dispose",this.onMaterialDispose)}updateClipping(e){this.clippingContext=e}get clippingNeedsUpdate(){return null!==this.clippingContext&&this.clippingContext.cacheKey!==this.clippingContextCacheKey&&(this.clippingContextCacheKey=this.clippingContext.cacheKey,!0)}get hardwareClippingPlanes(){return!0===this.material.hardwareClipping?this.clippingContext.unionClippingCount:0}getNodeBuilderState(){return this._nodeBuilderState||(this._nodeBuilderState=this._nodes.getForRender(this))}getMonitor(){return this._monitor||(this._monitor=this.getNodeBuilderState().observer)}getBindings(){return this._bindings||(this._bindings=this.getNodeBuilderState().createBindings())}getBindingGroup(e){for(const t of this.getBindings())if(t.name===e)return t}getIndex(){return this._geometries.getIndex(this)}getIndirect(){return this._geometries.getIndirect(this)}getChainArray(){return[this.object,this.material,this.context,this.lightsNode]}setGeometry(e){this.geometry=e,this.attributes=null}getAttributes(){if(null!==this.attributes)return this.attributes;const e=this.getNodeBuilderState().nodeAttributes,t=this.geometry,r=[],n=new Set;for(const i of e){const e=i.node&&i.node.attribute?i.node.attribute:t.getAttribute(i.name);if(void 0===e)continue;r.push(e);const s=e.isInterleavedBufferAttribute?e.data:e;n.add(s)}return this.attributes=r,this.vertexBuffers=Array.from(n.values()),r}getVertexBuffers(){return null===this.vertexBuffers&&this.getAttributes(),this.vertexBuffers}getDrawParameters(){const{object:e,material:t,geometry:r,group:n,drawRange:i}=this,s=this.drawParams||(this.drawParams={vertexCount:0,firstVertex:0,instanceCount:0,firstInstance:0}),o=this.getIndex(),a=null!==o;let u=1;if(!0===r.isInstancedBufferGeometry?u=r.instanceCount:void 0!==e.count&&(u=Math.max(0,e.count)),0===u)return null;if(s.instanceCount=u,!0===e.isBatchedMesh)return s;let l=1;!0!==t.wireframe||e.isPoints||e.isLineSegments||e.isLine||e.isLineLoop||(l=2);let c=i.start*l,h=(i.start+i.count)*l;null!==n&&(c=Math.max(c,n.start*l),h=Math.min(h,(n.start+n.count)*l));const d=r.attributes.position;let p=1/0;a?p=o.count:null!=d&&(p=d.count),c=Math.max(c,0),h=Math.min(h,p);const f=h-c;return f<0||f===1/0?null:(s.vertexCount=f,s.firstVertex=c,s)}getGeometryCacheKey(){const{geometry:e}=this;let t="";for(const r of Object.keys(e.attributes).sort()){const n=e.attributes[r];t+=r+",",n.data&&(t+=n.data.stride+","),n.offset&&(t+=n.offset+","),n.itemSize&&(t+=n.itemSize+","),n.normalized&&(t+="n,")}for(const r of Object.keys(e.morphAttributes).sort()){const n=e.morphAttributes[r];t+="morph-"+r+",";for(let e=0,r=n.length;e<r;e++){t+=n[e].id+","}}return e.index&&(t+="index,"),t}getMaterialCacheKey(){const{object:e,material:t}=this;let r=t.customProgramCacheKey();for(const n of function(e){const t=Object.keys(e);let r=Object.getPrototypeOf(e);for(;r;){const e=Object.getOwnPropertyDescriptors(r);for(const r in e)if(void 0!==e[r]){const n=e[r];n&&"function"==typeof n.get&&t.push(r)}r=Object.getPrototypeOf(r)}return t}(t)){if(/^(is[A-Z]|_)|^(visible|version|uuid|name|opacity|userData)$/.test(n))continue;const e=t[n];let i;if(null!==e){const t=typeof e;"number"===t?i=0!==e?"1":"0":"object"===t?(i="{",e.isTexture&&(i+=e.mapping),i+="}"):i=String(e)}else i=String(e);r+=i+","}return r+=this.clippingContextCacheKey+",",e.geometry&&(r+=this.getGeometryCacheKey()),e.skeleton&&(r+=e.skeleton.bones.length+","),e.isBatchedMesh&&(r+=e._matricesTexture.uuid+",",null!==e._colorsTexture&&(r+=e._colorsTexture.uuid+",")),e.count>1&&(r+=e.uuid+","),r+=e.receiveShadow+",",Sa(r)}get needsGeometryUpdate(){return this.geometry.id!==this.object.geometry.id}get needsUpdate(){return this.initialNodesCacheKey!==this.getDynamicCacheKey()||this.clippingNeedsUpdate}getDynamicCacheKey(){let e=0;return!0!==this.material.isShadowPassMaterial&&(e=this._nodes.getCacheKey(this.scene,this.lightsNode)),this.camera.isArrayCamera&&(e=Ea(e,this.camera.cameras.length)),this.object.receiveShadow&&(e=Ea(e,1)),e}getCacheKey(){return this.getMaterialCacheKey()+this.getDynamicCacheKey()}dispose(){this.material.removeEventListener("dispose",this.onMaterialDispose),this.onDispose()}}const sb=[];class ob{constructor(e,t,r,n,i,s){this.renderer=e,this.nodes=t,this.geometries=r,this.pipelines=n,this.bindings=i,this.info=s,this.chainMaps={}}get(e,t,r,n,i,s,o,a){const u=this.getChainMap(a);sb[0]=e,sb[1]=t,sb[2]=s,sb[3]=i;let l=u.get(sb);return void 0===l?(l=this.createRenderObject(this.nodes,this.geometries,this.renderer,e,t,r,n,i,s,o,a),u.set(sb,l)):(l.updateClipping(o),l.needsGeometryUpdate&&l.setGeometry(e.geometry),(l.version!==t.version||l.needsUpdate)&&(l.initialCacheKey!==l.getCacheKey()?(l.dispose(),l=this.get(e,t,r,n,i,s,o,a)):l.version=t.version)),sb.length=0,l}getChainMap(e="default"){return this.chainMaps[e]||(this.chainMaps[e]=new rb)}dispose(){this.chainMaps={}}createRenderObject(e,t,r,n,i,s,o,a,u,l,c){const h=this.getChainMap(c),d=new ib(e,t,r,n,i,s,o,a,u,l);return d.onDispose=()=>{this.pipelines.delete(d),this.bindings.delete(d),this.nodes.delete(d),h.delete(d.getChainArray())},d}}class ab{constructor(){this.data=new WeakMap}get(e){let t=this.data.get(e);return void 0===t&&(t={},this.data.set(e,t)),t}delete(e){let t=null;return this.data.has(e)&&(t=this.data.get(e),this.data.delete(e)),t}has(e){return this.data.has(e)}dispose(){this.data=new WeakMap}}const ub=1,lb=2,cb=3,hb=4,db=16;class pb extends ab{constructor(e){super(),this.backend=e}delete(e){const t=super.delete(e);return null!==t&&this.backend.destroyAttribute(e),t}update(e,t){const r=this.get(e);if(void 0===r.version)t===ub?this.backend.createAttribute(e):t===lb?this.backend.createIndexAttribute(e):t===cb?this.backend.createStorageAttribute(e):t===hb&&this.backend.createIndirectStorageAttribute(e),r.version=this._getBufferAttribute(e).version;else{const t=this._getBufferAttribute(e);(r.version<t.version||t.usage===Te)&&(this.backend.updateAttribute(e),r.version=t.version)}}_getBufferAttribute(e){return e.isInterleavedBufferAttribute&&(e=e.data),e}}function fb(e){return null!==e.index?e.index.version:e.attributes.position.version}function gb(e){const t=[],r=e.index,n=e.attributes.position;if(null!==r){const e=r.array;for(let r=0,n=e.length;r<n;r+=3){const n=e[r+0],i=e[r+1],s=e[r+2];t.push(n,i,i,s,s,n)}}else{for(let e=0,r=n.array.length/3-1;e<r;e+=3){const r=e+0,n=e+1,i=e+2;t.push(r,n,n,i,i,r)}}const i=new(Ar(t)?Er:Cr)(t,1);return i.version=fb(e),i}class mb extends ab{constructor(e,t){super(),this.attributes=e,this.info=t,this.wireframes=new WeakMap,this.attributeCall=new WeakMap}has(e){const t=e.geometry;return super.has(t)&&!0===this.get(t).initialized}updateForRender(e){!1===this.has(e)&&this.initGeometry(e),this.updateAttributes(e)}initGeometry(e){const t=e.geometry;this.get(t).initialized=!0,this.info.memory.geometries++;const r=()=>{this.info.memory.geometries--;const n=t.index,i=e.getAttributes();null!==n&&this.attributes.delete(n);for(const e of i)this.attributes.delete(e);const s=this.wireframes.get(t);void 0!==s&&this.attributes.delete(s),t.removeEventListener("dispose",r)};t.addEventListener("dispose",r)}updateAttributes(e){const t=e.getAttributes();for(const i of t)i.isStorageBufferAttribute||i.isStorageInstancedBufferAttribute?this.updateAttribute(i,cb):this.updateAttribute(i,ub);const r=this.getIndex(e);null!==r&&this.updateAttribute(r,lb);const n=e.geometry.indirect;null!==n&&this.updateAttribute(n,hb)}updateAttribute(e,t){const r=this.info.render.calls;e.isInterleavedBufferAttribute?void 0===this.attributeCall.get(e)?(this.attributes.update(e,t),this.attributeCall.set(e,r)):this.attributeCall.get(e.data)!==r&&(this.attributes.update(e,t),this.attributeCall.set(e.data,r),this.attributeCall.set(e,r)):this.attributeCall.get(e)!==r&&(this.attributes.update(e,t),this.attributeCall.set(e,r))}getIndirect(e){return e.geometry.indirect}getIndex(e){const{geometry:t,material:r}=e;let n=t.index;if(!0===r.wireframe){const e=this.wireframes;let r=e.get(t);void 0===r?(r=gb(t),e.set(t,r)):r.version!==fb(t)&&(this.attributes.delete(r),r=gb(t),e.set(t,r)),n=r}return n}}class yb{constructor(){this.autoReset=!0,this.frame=0,this.calls=0,this.render={calls:0,frameCalls:0,drawCalls:0,triangles:0,points:0,lines:0,timestamp:0},this.compute={calls:0,frameCalls:0,timestamp:0},this.memory={geometries:0,textures:0}}update(e,t,r){this.render.drawCalls++,e.isMesh||e.isSprite?this.render.triangles+=r*(t/3):e.isPoints?this.render.points+=r*t:e.isLineSegments?this.render.lines+=r*(t/2):e.isLine&&(this.render.lines+=r*(t-1))}reset(){this.render.drawCalls=0,this.render.frameCalls=0,this.compute.frameCalls=0,this.render.triangles=0,this.render.points=0,this.render.lines=0}dispose(){this.reset(),this.calls=0,this.render.calls=0,this.compute.calls=0,this.render.timestamp=0,this.compute.timestamp=0,this.memory.geometries=0,this.memory.textures=0}}class bb{constructor(e){this.cacheKey=e,this.usedTimes=0}}class _b extends bb{constructor(e,t,r){super(e),this.vertexProgram=t,this.fragmentProgram=r}}class vb extends bb{constructor(e,t){super(e),this.computeProgram=t,this.isComputePipeline=!0}}let xb=0;class Tb{constructor(e,t,r,n=null,i=null){this.id=xb++,this.code=e,this.stage=t,this.name=r,this.transforms=n,this.attributes=i,this.usedTimes=0}}class wb extends ab{constructor(e,t){super(),this.backend=e,this.nodes=t,this.bindings=null,this.caches=new Map,this.programs={vertex:new Map,fragment:new Map,compute:new Map}}getForCompute(e,t){const{backend:r}=this,n=this.get(e);if(this._needsComputeUpdate(e)){const i=n.pipeline;i&&(i.usedTimes--,i.computeProgram.usedTimes--);const s=this.nodes.getForCompute(e);let o=this.programs.compute.get(s.computeShader);void 0===o&&(i&&0===i.computeProgram.usedTimes&&this._releaseProgram(i.computeProgram),o=new Tb(s.computeShader,"compute",e.name,s.transforms,s.nodeAttributes),this.programs.compute.set(s.computeShader,o),r.createProgram(o));const a=this._getComputeCacheKey(e,o);let u=this.caches.get(a);void 0===u&&(i&&0===i.usedTimes&&this._releasePipeline(i),u=this._getComputePipeline(e,o,a,t)),u.usedTimes++,o.usedTimes++,n.version=e.version,n.pipeline=u}return n.pipeline}getForRender(e,t=null){const{backend:r}=this,n=this.get(e);if(this._needsRenderUpdate(e)){const i=n.pipeline;i&&(i.usedTimes--,i.vertexProgram.usedTimes--,i.fragmentProgram.usedTimes--);const s=e.getNodeBuilderState(),o=e.material?e.material.name:"";let a=this.programs.vertex.get(s.vertexShader);void 0===a&&(i&&0===i.vertexProgram.usedTimes&&this._releaseProgram(i.vertexProgram),a=new Tb(s.vertexShader,"vertex",o),this.programs.vertex.set(s.vertexShader,a),r.createProgram(a));let u=this.programs.fragment.get(s.fragmentShader);void 0===u&&(i&&0===i.fragmentProgram.usedTimes&&this._releaseProgram(i.fragmentProgram),u=new Tb(s.fragmentShader,"fragment",o),this.programs.fragment.set(s.fragmentShader,u),r.createProgram(u));const l=this._getRenderCacheKey(e,a,u);let c=this.caches.get(l);void 0===c?(i&&0===i.usedTimes&&this._releasePipeline(i),c=this._getRenderPipeline(e,a,u,l,t)):e.pipeline=c,c.usedTimes++,a.usedTimes++,u.usedTimes++,n.pipeline=c}return n.pipeline}delete(e){const t=this.get(e).pipeline;return t&&(t.usedTimes--,0===t.usedTimes&&this._releasePipeline(t),t.isComputePipeline?(t.computeProgram.usedTimes--,0===t.computeProgram.usedTimes&&this._releaseProgram(t.computeProgram)):(t.fragmentProgram.usedTimes--,t.vertexProgram.usedTimes--,0===t.vertexProgram.usedTimes&&this._releaseProgram(t.vertexProgram),0===t.fragmentProgram.usedTimes&&this._releaseProgram(t.fragmentProgram))),super.delete(e)}dispose(){super.dispose(),this.caches=new Map,this.programs={vertex:new Map,fragment:new Map,compute:new Map}}updateForRender(e){this.getForRender(e)}_getComputePipeline(e,t,r,n){r=r||this._getComputeCacheKey(e,t);let i=this.caches.get(r);return void 0===i&&(i=new vb(r,t),this.caches.set(r,i),this.backend.createComputePipeline(i,n)),i}_getRenderPipeline(e,t,r,n,i){n=n||this._getRenderCacheKey(e,t,r);let s=this.caches.get(n);return void 0===s&&(s=new _b(n,t,r),this.caches.set(n,s),e.pipeline=s,this.backend.createRenderPipeline(e,i)),s}_getComputeCacheKey(e,t){return e.id+","+t.id}_getRenderCacheKey(e,t,r){return t.id+","+r.id+","+this.backend.getRenderCacheKey(e)}_releasePipeline(e){this.caches.delete(e.cacheKey)}_releaseProgram(e){const t=e.code,r=e.stage;this.programs[r].delete(t)}_needsComputeUpdate(e){const t=this.get(e);return void 0===t.pipeline||t.version!==e.version}_needsRenderUpdate(e){return void 0===this.get(e).pipeline||this.backend.needsRenderUpdate(e)}}class Sb extends ab{constructor(e,t,r,n,i,s){super(),this.backend=e,this.textures=r,this.pipelines=i,this.attributes=n,this.nodes=t,this.info=s,this.pipelines.bindings=this}getForRender(e){const t=e.getBindings();for(const r of t){const e=this.get(r);void 0===e.bindGroup&&(this._init(r),this.backend.createBindings(r,t,0),e.bindGroup=r)}return t}getForCompute(e){const t=this.nodes.getForCompute(e).bindings;for(const r of t){const e=this.get(r);void 0===e.bindGroup&&(this._init(r),this.backend.createBindings(r,t,0),e.bindGroup=r)}return t}updateForCompute(e){this._updateBindings(this.getForCompute(e))}updateForRender(e){this._updateBindings(this.getForRender(e))}_updateBindings(e){for(const t of e)this._update(t,e)}_init(e){for(const t of e.bindings)if(t.isSampledTexture)this.textures.updateTexture(t.texture);else if(t.isStorageBuffer){const e=t.attribute,r=e.isIndirectStorageBufferAttribute?hb:cb;this.attributes.update(e,r)}}_update(e,t){const{backend:r}=this;let n=!1,i=!0,s=0,o=0;for(const a of e.bindings){if(a.isNodeUniformsGroup){if(!1===this.nodes.updateGroup(a))continue}if(a.isStorageBuffer){const e=a.attribute,t=e.isIndirectStorageBufferAttribute?hb:cb;this.attributes.update(e,t)}if(a.isUniformBuffer){a.update()&&r.updateBinding(a)}else if(a.isSampler)a.update();else if(a.isSampledTexture){const e=this.textures.get(a.texture);a.needsBindingsUpdate(e.generation)&&(n=!0);const t=a.update(),u=a.texture;t&&this.textures.updateTexture(u);const l=r.get(u);if(void 0!==l.externalTexture||e.isDefaultTexture?i=!1:(s=10*s+u.id,o+=u.version),!0===r.isWebGPUBackend&&void 0===l.texture&&void 0===l.externalTexture&&(this.textures.updateTexture(u),n=!0),!0===u.isStorageTexture){const e=this.get(u);!0===a.store?e.needsMipmap=!0:this.textures.needsMipmaps(u)&&!0===e.needsMipmap&&(this.backend.generateMipmaps(u),e.needsMipmap=!1)}}}!0===n&&this.backend.updateBindings(e,t,i?s:0,o)}}function Nb(e,t){return e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.z!==t.z?e.z-t.z:e.id-t.id}function Eb(e,t){return e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.z!==t.z?t.z-e.z:e.id-t.id}function Cb(e){return(e.transmission>0||e.transmissionNode)&&e.side===k&&!1===e.forceSinglePass}class Ab{constructor(e,t,r){this.renderItems=[],this.renderItemsIndex=0,this.opaque=[],this.transparentDoublePass=[],this.transparent=[],this.bundles=[],this.lightsNode=e.getNode(t,r),this.lightsArray=[],this.scene=t,this.camera=r,this.occlusionQueryCount=0}begin(){return this.renderItemsIndex=0,this.opaque.length=0,this.transparentDoublePass.length=0,this.transparent.length=0,this.bundles.length=0,this.lightsArray.length=0,this.occlusionQueryCount=0,this}getNextRenderItem(e,t,r,n,i,s,o){let a=this.renderItems[this.renderItemsIndex];return void 0===a?(a={id:e.id,object:e,geometry:t,material:r,groupOrder:n,renderOrder:e.renderOrder,z:i,group:s,clippingContext:o},this.renderItems[this.renderItemsIndex]=a):(a.id=e.id,a.object=e,a.geometry=t,a.material=r,a.groupOrder=n,a.renderOrder=e.renderOrder,a.z=i,a.group=s,a.clippingContext=o),this.renderItemsIndex++,a}push(e,t,r,n,i,s,o){const a=this.getNextRenderItem(e,t,r,n,i,s,o);!0===e.occlusionTest&&this.occlusionQueryCount++,!0===r.transparent||r.transmission>0?(Cb(r)&&this.transparentDoublePass.push(a),this.transparent.push(a)):this.opaque.push(a)}unshift(e,t,r,n,i,s,o){const a=this.getNextRenderItem(e,t,r,n,i,s,o);!0===r.transparent||r.transmission>0?(Cb(r)&&this.transparentDoublePass.unshift(a),this.transparent.unshift(a)):this.opaque.unshift(a)}pushBundle(e){this.bundles.push(e)}pushLight(e){this.lightsArray.push(e)}sort(e,t){this.opaque.length>1&&this.opaque.sort(e||Nb),this.transparentDoublePass.length>1&&this.transparentDoublePass.sort(t||Eb),this.transparent.length>1&&this.transparent.sort(t||Eb)}finish(){this.lightsNode.setLights(this.lightsArray);for(let e=this.renderItemsIndex,t=this.renderItems.length;e<t;e++){const t=this.renderItems[e];if(null===t.id)break;t.id=null,t.object=null,t.geometry=null,t.material=null,t.groupOrder=null,t.renderOrder=null,t.z=null,t.group=null,t.clippingContext=null}}}const Mb=[];class Rb{constructor(e){this.lighting=e,this.lists=new rb}get(e,t){const r=this.lists;Mb[0]=e,Mb[1]=t;let n=r.get(Mb);return void 0===n&&(n=new Ab(this.lighting,e,t),r.set(Mb,n)),Mb.length=0,n}dispose(){this.lists=new rb}}let Pb=0;class Db{constructor(){this.id=Pb++,this.color=!0,this.clearColor=!0,this.clearColorValue={r:0,g:0,b:0,a:1},this.depth=!0,this.clearDepth=!0,this.clearDepthValue=1,this.stencil=!1,this.clearStencil=!0,this.clearStencilValue=1,this.viewport=!1,this.viewportValue=new E,this.scissor=!1,this.scissorValue=new E,this.renderTarget=null,this.textures=null,this.depthTexture=null,this.activeCubeFace=0,this.activeMipmapLevel=0,this.sampleCount=1,this.width=0,this.height=0,this.occlusionQueryCount=0,this.clippingContext=null,this.isRenderContext=!0}getCacheKey(){return Fb(this)}}function Fb(e){const{textures:t,activeCubeFace:r}=e,n=[r];for(const i of t)n.push(i.id);return Na(n)}const Ob=[],Lb=new A,Bb=new we;class kb{constructor(){this.chainMaps={}}get(e,t,r=null){let n;if(Ob[0]=e,Ob[1]=t,null===r)n="default";else{const e=r.texture.format;n=`${r.textures.length}:${e}:${r.samples}:${r.depthBuffer}:${r.stencilBuffer}`}const i=this._getChainMap(n);let s=i.get(Ob);return void 0===s&&(s=new Db,i.set(Ob,s)),Ob.length=0,null!==r&&(s.sampleCount=0===r.samples?1:r.samples),s}getForClear(e=null){return this.get(Lb,Bb,e)}_getChainMap(e){return this.chainMaps[e]||(this.chainMaps[e]=new rb)}dispose(){this.chainMaps={}}}const Ib=new o;class Ub extends ab{constructor(e,t,r){super(),this.renderer=e,this.backend=t,this.info=r}updateRenderTarget(e,t=0){const r=this.get(e),n=0===e.samples?1:e.samples,i=r.depthTextureMips||(r.depthTextureMips={}),s=e.textures,o=this.getSize(s[0]),a=o.width>>t,u=o.height>>t;let l=e.depthTexture||i[t];const c=!0===e.depthBuffer||!0===e.stencilBuffer;let h=!1;void 0===l&&c&&(l=new se,l.format=e.stencilBuffer?le:ce,l.type=e.stencilBuffer?ae:ue,l.image.width=a,l.image.height=u,l.image.depth=o.depth,l.isArrayTexture=!0===e.multiview&&o.depth>1,i[t]=l),r.width===o.width&&o.height===r.height||(h=!0,l&&(l.needsUpdate=!0,l.image.width=a,l.image.height=u,l.image.depth=l.isArrayTexture?l.image.depth:1)),r.width=o.width,r.height=o.height,r.textures=s,r.depthTexture=l||null,r.depth=e.depthBuffer,r.stencil=e.stencilBuffer,r.renderTarget=e,r.sampleCount!==n&&(h=!0,l&&(l.needsUpdate=!0),r.sampleCount=n);const d={sampleCount:n};if(!0!==e.isXRRenderTarget){for(let e=0;e<s.length;e++){const t=s[e];h&&(t.needsUpdate=!0),this.updateTexture(t,d)}l&&this.updateTexture(l,d)}if(!0!==r.initialized){r.initialized=!0;const t=()=>{e.removeEventListener("dispose",t);for(let e=0;e<s.length;e++)this._destroyTexture(s[e]);l&&this._destroyTexture(l),this.delete(e)};e.addEventListener("dispose",t)}}updateTexture(e,t={}){const r=this.get(e);if(!0===r.initialized&&r.version===e.version)return;const n=e.isRenderTargetTexture||e.isDepthTexture||e.isFramebufferTexture,i=this.backend;if(n&&!0===r.initialized&&(i.destroySampler(e),i.destroyTexture(e)),e.isFramebufferTexture){const t=this.renderer.getRenderTarget();e.type=t?t.texture.type:oe}const{width:s,height:o,depth:a}=this.getSize(e);if(t.width=s,t.height=o,t.depth=a,t.needsMipmaps=this.needsMipmaps(e),t.levels=t.needsMipmaps?this.getMipLevels(e,s,o):1,n||!0===e.isStorageTexture)i.createSampler(e),i.createTexture(e,t),r.generation=e.version;else{if(!0!==r.initialized&&i.createSampler(e),e.version>0){const n=e.image;if(void 0===n);else if(!1===n.complete);else{if(e.images){const r=[];for(const t of e.images)r.push(t);t.images=r}else t.image=n;void 0!==r.isDefaultTexture&&!0!==r.isDefaultTexture||(i.createTexture(e,t),r.isDefaultTexture=!1,r.generation=e.version),!0===e.source.dataReady&&i.updateTexture(e,t),t.needsMipmaps&&0===e.mipmaps.length&&i.generateMipmaps(e)}}else i.createDefaultTexture(e),r.isDefaultTexture=!0,r.generation=e.version}if(!0!==r.initialized){r.initialized=!0,r.generation=e.version,this.info.memory.textures++;const t=()=>{e.removeEventListener("dispose",t),this._destroyTexture(e)};e.addEventListener("dispose",t)}r.version=e.version}getSize(e,t=Ib){let r=e.images?e.images[0]:e.image;return r?(void 0!==r.image&&(r=r.image),t.width=r.width||1,t.height=r.height||1,t.depth=e.isCubeTexture?6:r.depth||1):t.width=t.height=t.depth=1,t}getMipLevels(e,t,r){let n;return n=e.isCompressedTexture?e.mipmaps?e.mipmaps.length:1:Math.floor(Math.log2(Math.max(t,r)))+1,n}needsMipmaps(e){return!0===e.isCompressedTexture||e.generateMipmaps}_destroyTexture(e){!0===this.has(e)&&(this.backend.destroySampler(e),this.backend.destroyTexture(e),this.delete(e),this.info.memory.textures--)}}class Vb extends h{constructor(e,t,r,n=1){super(e,t,r),this.a=n}set(e,t,r,n=1){return this.a=n,super.set(e,t,r)}copy(e){return void 0!==e.a&&(this.a=e.a),super.copy(e)}clone(){return new this.constructor(this.r,this.g,this.b,this.a)}}class jb extends hl{static get type(){return"ParameterNode"}constructor(e,t=null){super(e,t),this.isParameterNode=!0}getHash(){return this.uuid}generate(){return this.name}}class Gb extends qa{static get type(){return"StackNode"}constructor(e=null){super(),this.nodes=[],this.outputNode=null,this.parent=e,this._currentCond=null,this._expressionNode=null,this.isStackNode=!0}getNodeType(e){return this.outputNode?this.outputNode.getNodeType(e):"void"}getMemberType(e,t){return this.outputNode?this.outputNode.getMemberType(e,t):"void"}add(e){return this.nodes.push(e),this}If(e,t){const r=new Fu(t);return this._currentCond=Ah(e,r),this.add(this._currentCond)}ElseIf(e,t){const r=new Fu(t),n=Ah(e,r);return this._currentCond.elseNode=n,this._currentCond=n,this}Else(e){return this._currentCond.elseNode=new Fu(e),this}Switch(e){return this._expressionNode=Ou(e),this}Case(...e){const t=[];if(!(e.length>=2))throw new Error("TSL: Invalid parameter length. Case() requires at least two parameters.");for(let s=0;s<e.length-1;s++)t.push(this._expressionNode.equal(Ou(e[s])));const r=new Fu(e[e.length-1]);let n=t[0];for(let s=1;s<t.length;s++)n=n.or(t[s]);const i=Ah(n,r);return null===this._currentCond?(this._currentCond=i,this.add(this._currentCond)):(this._currentCond.elseNode=i,this._currentCond=i,this)}Default(e){return this.Else(e),this}build(e,...t){const r=Gu();ju(this);const n=e.buildStage;for(const i of this.nodes)if("setup"===n)i.build(e);else if("analyze"===n)i.build(e,this);else if("generate"===n){const t=e.getDataFromNode(i,"any").stages,r=t&&t[e.shaderStage];if(i.isVarNode&&r&&1===r.length&&r[0]&&r[0].isStackNode)continue;i.build(e,"void")}return ju(r),this.outputNode?this.outputNode.build(e,...t):super.build(e,...t)}else(...e){return this.Else(...e)}elseif(...e){return this.ElseIf(...e)}}const zb=ku(Gb).setParameterLength(0,1);new s,new o,new o,new o,new a,new o(0,0,-1),new E,new o,new o,new E,new i;const $b=new M;Qf.flipX(),$b.depthTexture=new se(1,1);const Hb=new Z(-1,1,1,-1,0,1);class Wb extends p{constructor(e=!1){super();const t=!1===e?[0,-1,0,1,2,1]:[0,2,0,0,2,0];this.setAttribute("position",new Sr([-1,3,0,-1,-1,0,3,-1,0],3)),this.setAttribute("uv",new Sr(t,2))}}const qb=new Wb;class Xb extends l{constructor(e=null){super(qb,e),this.camera=Hb,this.isQuadMesh=!0}async renderAsync(e){return e.renderAsync(this,Hb)}render(e){e.render(this,Hb)}}const Kb=new tn,Yb=new a;class Qb extends qa{static get type(){return"SceneNode"}constructor(e=Qb.BACKGROUND_BLURRINESS,t=null){super(),this.scope=e,this.scene=t}setup(e){const t=this.scope,r=null!==this.scene?this.scene:e.scene;let n;return t===Qb.BACKGROUND_BLURRINESS?n=xp("backgroundBlurriness","float",r):t===Qb.BACKGROUND_INTENSITY?n=xp("backgroundIntensity","float",r):t===Qb.BACKGROUND_ROTATION&&(n=Xl("mat4").label("backgroundRotation").setGroup(Hl).onRenderUpdate((()=>{const e=r.background;return null!==e&&e.isTexture&&e.mapping!==en?(Kb.copy(r.backgroundRotation),Kb.x*=-1,Kb.y*=-1,Kb.z*=-1,Yb.makeRotationFromEuler(Kb)):Yb.identity(),Yb}))),n}}Qb.BACKGROUND_BLURRINESS="backgroundBlurriness",Qb.BACKGROUND_INTENSITY="backgroundIntensity",Qb.BACKGROUND_ROTATION="backgroundRotation";const Zb=Iu(Qb,Qb.BACKGROUND_BLURRINESS),Jb=Iu(Qb,Qb.BACKGROUND_INTENSITY),e_=Iu(Qb,Qb.BACKGROUND_ROTATION),t_=Vu((({texture:e,uv:t})=>{const r=1e-4,n=el().toVar();return zu(t.x.lessThan(r),(()=>{n.assign(el(1,0,0))})).ElseIf(t.y.lessThan(r),(()=>{n.assign(el(0,1,0))})).ElseIf(t.z.lessThan(r),(()=>{n.assign(el(0,0,1))})).ElseIf(t.x.greaterThan(.9999),(()=>{n.assign(el(-1,0,0))})).ElseIf(t.y.greaterThan(.9999),(()=>{n.assign(el(0,-1,0))})).ElseIf(t.z.greaterThan(.9999),(()=>{n.assign(el(0,0,-1))})).Else((()=>{const r=.01,i=e.sample(t.add(el(-.01,0,0))).r.sub(e.sample(t.add(el(r,0,0))).r),s=e.sample(t.add(el(0,-.01,0))).r.sub(e.sample(t.add(el(0,r,0))).r),o=e.sample(t.add(el(0,0,-.01))).r.sub(e.sample(t.add(el(0,0,r))).r);n.assign(el(i,s,o))})),n.normalize()}));class r_ extends gd{static get type(){return"Texture3DNode"}constructor(e,t=null,r=null){super(e,t,r),this.isTexture3DNode=!0}getInputType(){return"texture3D"}getDefaultUV(){return el(.5,.5,.5)}setUpdateMatrix(){}setupUV(e,t){const r=this.value;return!e.isFlipY()||!0!==r.isRenderTargetTexture&&!0!==r.isFramebufferTexture||(t=this.sampler?t.flipY():t.setY(qu(hd(this,this.levelNode).y).sub(t.y).sub(1))),t}generateUV(e,t){return t.build(e,"vec3")}normal(e){return t_({texture:this,uv:e})}}const n_=ku(r_).setParameterLength(1,3),i_=new i;class s_ extends gd{static get type(){return"PassTextureNode"}constructor(e,t){super(t),this.passNode=e,this.setUpdateMatrix(!1)}setup(e){return e.object.isQuadMesh&&this.passNode.build(e),super.setup(e)}clone(){return new this.constructor(this.passNode,this.value)}}class o_ extends s_{static get type(){return"PassMultipleTextureNode"}constructor(e,t,r=!1){super(e,null),this.textureName=t,this.previousTexture=r}updateTexture(){this.value=this.previousTexture?this.passNode.getPreviousTexture(this.textureName):this.passNode.getTexture(this.textureName)}setup(e){return this.updateTexture(),super.setup(e)}clone(){return new this.constructor(this.passNode,this.textureName,this.previousTexture)}}class a_ extends Ya{static get type(){return"PassNode"}constructor(e,t,r,n={}){super("vec4"),this.scope=e,this.scene=t,this.camera=r,this.options=n,this._pixelRatio=1,this._width=1,this._height=1;const i=new se;i.isRenderTargetTexture=!0,i.name="depth";const s=new M(this._width*this._pixelRatio,this._height*this._pixelRatio,{type:w,...n});s.texture.name="output",s.depthTexture=i,this.renderTarget=s,this._textures={output:s.texture,depth:i},this._textureNodes={},this._linearDepthNodes={},this._viewZNodes={},this._previousTextures={},this._previousTextureNodes={},this._cameraNear=Xl(0),this._cameraFar=Xl(0),this._mrt=null,this._layers=null,this._resolution=1,this.isPassNode=!0,this.updateBeforeType=Ba,this.global=!0}setResolution(e){return this._resolution=e,this}getResolution(){return this._resolution}setLayers(e){return this._layers=e,this}getLayers(){return this._layers}setMRT(e){return this._mrt=e,this}getMRT(){return this._mrt}getTexture(e){let t=this._textures[e];if(void 0===t){t=this.renderTarget.texture.clone(),t.name=e,this._textures[e]=t,this.renderTarget.textures.push(t)}return t}getPreviousTexture(e){let t=this._previousTextures[e];return void 0===t&&(t=this.getTexture(e).clone(),this._previousTextures[e]=t),t}toggleTexture(e){const t=this._previousTextures[e];if(void 0!==t){const r=this._textures[e],n=this.renderTarget.textures.indexOf(r);this.renderTarget.textures[n]=t,this._textures[e]=t,this._previousTextures[e]=r,this._textureNodes[e].updateTexture(),this._previousTextureNodes[e].updateTexture()}}getTextureNode(e="output"){let t=this._textureNodes[e];return void 0===t&&(t=Ou(new o_(this,e)),t.updateTexture(),this._textureNodes[e]=t),t}getPreviousTextureNode(e="output"){let t=this._previousTextureNodes[e];return void 0===t&&(void 0===this._textureNodes[e]&&this.getTextureNode(e),t=Ou(new o_(this,e,!0)),t.updateTexture(),this._previousTextureNodes[e]=t),t}getViewZNode(e="depth"){let t=this._viewZNodes[e];if(void 0===t){const r=this._cameraNear,n=this._cameraFar;this._viewZNodes[e]=t=cg(this.getTextureNode(e),r,n)}return t}getLinearDepthNode(e="depth"){let t=this._linearDepthNodes[e];if(void 0===t){const r=this._cameraNear,n=this._cameraFar,i=this.getViewZNode(e);this._linearDepthNodes[e]=t=ug(i,r,n)}return t}setup({renderer:e}){return this.renderTarget.samples=void 0===this.options.samples?e.samples:this.options.samples,!0===e.backend.isWebGLBackend&&(this.renderTarget.samples=0),this.renderTarget.texture.type=e.getColorBufferType(),this.scope===a_.COLOR?this.getTextureNode():this.getLinearDepthNode()}updateBefore(e){const{renderer:t}=e,{scene:r}=this;let n,i;const s=t.getOutputRenderTarget();s&&!0===s.isXRRenderTarget?(i=1,n=t.xr.getCamera(),t.xr.updateCamera(n),i_.set(s.width,s.height)):(n=this.camera,i=t.getPixelRatio(),t.getSize(i_)),this._pixelRatio=i,this.setSize(i_.width,i_.height);const o=t.getRenderTarget(),a=t.getMRT(),u=n.layers.mask;this._cameraNear.value=n.near,this._cameraFar.value=n.far,null!==this._layers&&(n.layers.mask=this._layers.mask);for(const l in this._previousTextures)this.toggleTexture(l);t.setRenderTarget(this.renderTarget),t.setMRT(this._mrt),t.render(r,n),t.setRenderTarget(o),t.setMRT(a),n.layers.mask=u}setSize(e,t){this._width=e,this._height=t;const r=this._width*this._pixelRatio*this._resolution,n=this._height*this._pixelRatio*this._resolution;this.renderTarget.setSize(r,n)}setPixelRatio(e){this._pixelRatio=e,this.setSize(this._width,this._height)}dispose(){this.renderTarget.dispose()}}a_.COLOR="color",a_.DEPTH="depth";const u_=Vu((([e,t])=>e.mul(t).clamp())).setLayout({name:"linearToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]}),l_=Vu((([e,t])=>(e=e.mul(t)).div(e.add(1)).clamp())).setLayout({name:"reinhardToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]}),c_=Vu((([e,t])=>{const r=(e=(e=e.mul(t)).sub(.004).max(0)).mul(e.mul(6.2).add(.5)),n=e.mul(e.mul(6.2).add(1.7)).add(.06);return r.div(n).pow(2.2)})).setLayout({name:"cineonToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]}),h_=Vu((([e])=>{const t=e.mul(e.add(.0245786)).sub(90537e-9),r=e.mul(e.add(.432951).mul(.983729)).add(.238081);return t.div(r)})),d_=Vu((([e,t])=>{const r=ll(.59719,.35458,.04823,.076,.90834,.01566,.0284,.13383,.83777),n=ll(1.60475,-.53108,-.07367,-.10208,1.10813,-.00605,-.00327,-.07276,1.07602);return e=e.mul(t).div(.6),e=r.mul(e),e=h_(e),(e=n.mul(e)).clamp()})).setLayout({name:"acesFilmicToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]}),p_=ll(el(1.6605,-.1246,-.0182),el(-.5876,1.1329,-.1006),el(-.0728,-.0083,1.1187)),f_=ll(el(.6274,.0691,.0164),el(.3293,.9195,.088),el(.0433,.0113,.8956)),g_=Vu((([e])=>{const t=el(e).toVar(),r=el(t.mul(t)).toVar(),n=el(r.mul(r)).toVar();return Wu(15.5).mul(n.mul(r)).sub(rc(40.14,n.mul(t))).add(rc(31.96,n).sub(rc(6.868,r.mul(t))).add(rc(.4298,r).add(rc(.1191,t).sub(.00232))))})),m_=Vu((([e,t])=>{const r=el(e).toVar(),n=ll(el(.856627153315983,.137318972929847,.11189821299995),el(.0951212405381588,.761241990602591,.0767994186031903),el(.0482516061458583,.101439036467562,.811302368396859)),i=ll(el(1.1271005818144368,-.1413297634984383,-.14132976349843826),el(-.11060664309660323,1.157823702216272,-.11060664309660294),el(-.016493938717834573,-.016493938717834257,1.2519364065950405)),s=Wu(-12.47393),o=Wu(4.026069);return r.mulAssign(t),r.assign(f_.mul(r)),r.assign(n.mul(r)),r.assign(ah(r,1e-10)),r.assign(Lc(r)),r.assign(r.sub(s).div(o.sub(s))),r.assign(xh(r,0,1)),r.assign(g_(r)),r.assign(i.mul(r)),r.assign(fh(ah(el(0),r),el(2.2))),r.assign(p_.mul(r)),r.assign(xh(r,0,1)),r})).setLayout({name:"agxToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]}),y_=Vu((([e,t])=>{const r=Wu(.76),n=Wu(.15);e=e.mul(t);const i=oh(e.r,oh(e.g,e.b)),s=Ah(i.lessThan(.08),i.sub(rc(6.25,i.mul(i))),.04);e.subAssign(s);const o=ah(e.r,ah(e.g,e.b));zu(o.lessThan(r),(()=>e));const a=tc(1,r),u=tc(1,a.mul(a).div(o.add(a.sub(r))));e.mulAssign(u.div(o));const l=tc(1,nc(1,n.mul(o.sub(u)).add(1)));return vh(e,el(u),l)})).setLayout({name:"neutralToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]});class b_ extends qa{static get type(){return"CodeNode"}constructor(e="",t=[],r=""){super("code"),this.isCodeNode=!0,this.global=!0,this.code=e,this.includes=t,this.language=r}setIncludes(e){return this.includes=e,this}getIncludes(){return this.includes}generate(e){const t=this.getIncludes(e);for(const n of t)n.build(e);const r=e.getCodeFromNode(this,this.getNodeType(e));return r.code=this.code,r.code}serialize(e){super.serialize(e),e.code=this.code,e.language=this.language}deserialize(e){super.deserialize(e),this.code=e.code,this.language=e.language}}class __ extends b_{static get type(){return"FunctionNode"}constructor(e="",t=[],r=""){super(e,t,r)}getNodeType(e){return this.getNodeFunction(e).type}getInputs(e){return this.getNodeFunction(e).inputs}getNodeFunction(e){const t=e.getDataFromNode(this);let r=t.nodeFunction;return void 0===r&&(r=e.parser.parseFunction(this.code),t.nodeFunction=r),r}generate(e,t){super.generate(e);const r=this.getNodeFunction(e),n=r.name,i=r.type,s=e.getCodeFromNode(this,i);""!==n&&(s.name=n);const o=e.getPropertyName(s),a=this.getNodeFunction(e).getCode(o);return s.code=a+"\n","property"===t?o:e.format(`${o}()`,i,t)}}function v_(e){let t;const r=e.context.getViewZ;return void 0!==r&&(t=r(this)),(t||Wd.z).negate()}const x_=Vu((([e,t],r)=>{const n=v_(r);return Sh(e,t,n)})),T_=Vu((([e],t)=>{const r=v_(t);return e.mul(e,r,r).negate().exp().oneMinus()})),w_=Vu((([e,t])=>il(t.toFloat().mix(Dl.rgb,e.toVec3()),Dl.a)));ku(class extends qa{constructor(e){super(),this.scope=e}generate(e){const{scope:t}=this,{renderer:r}=e;!0===r.backend.isWebGLBackend?e.addFlowCode(`\t// ${t}Barrier \n`):e.addLineFlowCode(`${t}Barrier()`,this)}});class S_ extends qa{static get type(){return"AtomicFunctionNode"}constructor(e,t,r){super("uint"),this.method=e,this.pointerNode=t,this.valueNode=r,this.parents=!0}getInputType(e){return this.pointerNode.getNodeType(e)}getNodeType(e){return this.getInputType(e)}generate(e){const t=e.getNodeProperties(this),r=t.parents,n=this.method,i=this.getNodeType(e),s=this.getInputType(e),o=this.pointerNode,a=this.valueNode,u=[];u.push(`&${o.build(e,s)}`),null!==a&&u.push(a.build(e,s));const l=`${e.getMethod(n,i)}( ${u.join(", ")} )`;if(!(1===r.length&&!0===r[0].isStackNode))return void 0===t.constNode&&(t.constNode=id(l,i).toConst()),t.constNode.build(e);e.addLineFlowCode(l,this)}}let N_;function E_(e){N_=N_||new WeakMap;let t=N_.get(e);return void 0===t&&N_.set(e,t={}),t}function C_(e){const t=E_(e);return t.shadowMatrix||(t.shadowMatrix=Xl("mat4").setGroup(Hl).onRenderUpdate((t=>(!0===e.castShadow&&!1!==t.renderer.shadowMap.enabled||e.shadow.updateMatrices(e),e.shadow.matrix))))}function A_(e){const t=E_(e);return t.position||(t.position=Xl(new o).setGroup(Hl).onRenderUpdate(((t,r)=>r.value.setFromMatrixPosition(e.matrixWorld))))}function M_(e){const t=E_(e);return t.viewPosition||(t.viewPosition=Xl(new o).setGroup(Hl).onRenderUpdate((({camera:t},r)=>{r.value=r.value||new o,r.value.setFromMatrixPosition(e.matrixWorld),r.value.applyMatrix4(t.matrixWorldInverse)})))}S_.ATOMIC_LOAD="atomicLoad",S_.ATOMIC_STORE="atomicStore",S_.ATOMIC_ADD="atomicAdd",S_.ATOMIC_SUB="atomicSub",S_.ATOMIC_MAX="atomicMax",S_.ATOMIC_MIN="atomicMin",S_.ATOMIC_AND="atomicAnd",S_.ATOMIC_OR="atomicOr",S_.ATOMIC_XOR="atomicXor",ku(S_);const R_=e=>Md.transformDirection(A_(e).sub(function(e){const t=E_(e);return t.targetPosition||(t.targetPosition=Xl(new o).setGroup(Hl).onRenderUpdate(((t,r)=>r.value.setFromMatrixPosition(e.target.matrixWorld))))}(e))),P_=(e,t)=>{for(const r of t)if(r.isAnalyticLightNode&&r.light.id===e)return r;return null},D_=new WeakMap,F_=[];class O_ extends qa{static get type(){return"LightsNode"}constructor(){super("vec3"),this.totalDiffuseNode=el().toVar(),this.totalSpecularNode=el().toVar(),this.outgoingLightNode=el().toVar(),this._lights=[],this._lightNodes=null,this._lightNodesHash=null,this.global=!0}customCacheKey(){const e=this._lights;for(let r=0;r<e.length;r++){const t=e[r];if(F_.push(t.id),F_.push(t.castShadow?1:0),!0===t.isSpotLight){const e=null!==t.map?t.map.id:-1,r=t.colorNode?t.colorNode.getCacheKey():-1;F_.push(e,r)}}const t=Na(F_);return F_.length=0,t}getHash(e){if(null===this._lightNodesHash){null===this._lightNodes&&this.setupLightsNode(e);const t=[];for(const e of this._lightNodes)t.push(e.getSelf().getHash());this._lightNodesHash="lights-"+t.join(",")}return this._lightNodesHash}analyze(e){const t=e.getNodeProperties(this);for(const r of t.nodes)r.build(e);t.outputNode.build(e)}setupLightsNode(e){const t=[],r=this._lightNodes,n=(e=>e.sort(((e,t)=>e.id-t.id)))(this._lights),i=e.renderer.library;for(const s of n)if(s.isNode)t.push(Ou(s));else{let e=null;if(null!==r&&(e=P_(s.id,r)),null===e){const e=i.getLightNodeClass(s.constructor);if(null===e)continue;let r=null;D_.has(s)?r=D_.get(s):(r=Ou(new e(s)),D_.set(s,r)),t.push(r)}}this._lightNodes=t}setupDirectLight(e,t,r){const{lightingModel:n,reflectedLight:i}=e.context;n.direct({...r,lightNode:t,reflectedLight:i},e)}setupDirectRectAreaLight(e,t,r){const{lightingModel:n,reflectedLight:i}=e.context;n.directRectArea({...r,lightNode:t,reflectedLight:i},e)}setupLights(e,t){for(const r of t)r.build(e)}getLightNodes(e){return null===this._lightNodes&&this.setupLightsNode(e),this._lightNodes}setup(e){const t=e.lightsNode;e.lightsNode=this;let r=this.outgoingLightNode;const n=e.context,i=n.lightingModel,s=e.getNodeProperties(this);if(i){const{totalDiffuseNode:t,totalSpecularNode:o}=this;n.outgoingLight=r;const a=e.addStack();s.nodes=a.nodes,i.start(e);const{backdrop:u,backdropAlpha:l}=n,{directDiffuse:c,directSpecular:h,indirectDiffuse:d,indirectSpecular:p}=n.reflectedLight;let f=c.add(d);null!==u&&(f=el(null!==l?l.mix(f,u):u),n.material.transparent=!0),t.assign(f),o.assign(h.add(p)),r.assign(t.add(o)),i.finish(e),r=r.bypass(e.removeStack())}else s.nodes=[];return e.lightsNode=t,r}setLights(e){return this._lights=e,this._lightNodes=null,this._lightNodesHash=null,this}getLights(){return this._lights}get hasLights(){return this._lights.length>0}}class L_ extends qa{static get type(){return"ShadowBaseNode"}constructor(e){super(),this.light=e,this.updateBeforeType=ka,this.isShadowBaseNode=!0}setupShadowPosition({context:e,material:t}){B_.assign(t.receivedShadowPositionNode||e.shadowPositionWorld||$d)}}const B_=dl("vec3","shadowPositionWorld");function k_(e,t){return t=function(e,t={}){return t.toneMapping=e.toneMapping,t.toneMappingExposure=e.toneMappingExposure,t.outputColorSpace=e.outputColorSpace,t.renderTarget=e.getRenderTarget(),t.activeCubeFace=e.getActiveCubeFace(),t.activeMipmapLevel=e.getActiveMipmapLevel(),t.renderObjectFunction=e.getRenderObjectFunction(),t.pixelRatio=e.getPixelRatio(),t.mrt=e.getMRT(),t.clearColor=e.getClearColor(t.clearColor||new h),t.clearAlpha=e.getClearAlpha(),t.autoClear=e.autoClear,t.scissorTest=e.getScissorTest(),t}(e,t),e.setMRT(null),e.setRenderObjectFunction(null),e.setClearColor(0,1),e.autoClear=!0,t}const I_=new WeakMap,U_=Vu((({depthTexture:e,shadowCoord:t,depthLayer:r})=>{let n=yd(e,t.xy).label("t_basic");return e.isArrayTexture&&(n=n.depth(r)),n.compare(t.z)})),V_=Vu((({depthTexture:e,shadowCoord:t,shadow:r,depthLayer:n})=>{const i=(t,r)=>{let i=yd(e,t);return e.isArrayTexture&&(i=i.depth(n)),i.compare(r)},s=xp("mapSize","vec2",r).setGroup(Hl),o=xp("radius","float",r).setGroup(Hl),a=Yu(1).div(s),u=a.x.negate().mul(o),l=a.y.negate().mul(o),c=a.x.mul(o),h=a.y.mul(o),d=u.div(2),p=l.div(2),f=c.div(2),g=h.div(2);return ec(i(t.xy.add(Yu(u,l)),t.z),i(t.xy.add(Yu(0,l)),t.z),i(t.xy.add(Yu(c,l)),t.z),i(t.xy.add(Yu(d,p)),t.z),i(t.xy.add(Yu(0,p)),t.z),i(t.xy.add(Yu(f,p)),t.z),i(t.xy.add(Yu(u,0)),t.z),i(t.xy.add(Yu(d,0)),t.z),i(t.xy,t.z),i(t.xy.add(Yu(f,0)),t.z),i(t.xy.add(Yu(c,0)),t.z),i(t.xy.add(Yu(d,g)),t.z),i(t.xy.add(Yu(0,g)),t.z),i(t.xy.add(Yu(f,g)),t.z),i(t.xy.add(Yu(u,h)),t.z),i(t.xy.add(Yu(0,h)),t.z),i(t.xy.add(Yu(c,h)),t.z)).mul(1/17)})),j_=Vu((({depthTexture:e,shadowCoord:t,shadow:r,depthLayer:n})=>{const i=(t,r)=>{let i=yd(e,t);return e.isArrayTexture&&(i=i.depth(n)),i.compare(r)},s=xp("mapSize","vec2",r).setGroup(Hl),o=Yu(1).div(s),a=o.x,u=o.y,l=t.xy,c=jc(l.mul(s).add(.5));return l.subAssign(c.mul(o)),ec(i(l,t.z),i(l.add(Yu(a,0)),t.z),i(l.add(Yu(0,u)),t.z),i(l.add(o),t.z),vh(i(l.add(Yu(a.negate(),0)),t.z),i(l.add(Yu(a.mul(2),0)),t.z),c.x),vh(i(l.add(Yu(a.negate(),u)),t.z),i(l.add(Yu(a.mul(2),u)),t.z),c.x),vh(i(l.add(Yu(0,u.negate())),t.z),i(l.add(Yu(0,u.mul(2))),t.z),c.y),vh(i(l.add(Yu(a,u.negate())),t.z),i(l.add(Yu(a,u.mul(2))),t.z),c.y),vh(vh(i(l.add(Yu(a.negate(),u.negate())),t.z),i(l.add(Yu(a.mul(2),u.negate())),t.z),c.x),vh(i(l.add(Yu(a.negate(),u.mul(2))),t.z),i(l.add(Yu(a.mul(2),u.mul(2))),t.z),c.x),c.y)).mul(1/9)})),G_=Vu((({depthTexture:e,shadowCoord:t,depthLayer:r})=>{const n=Wu(1).toVar();let i=yd(e).sample(t.xy);e.isArrayTexture&&(i=i.depth(r)),i=i.rg;const s=uh(t.z,i.x);return zu(s.notEqual(Wu(1)),(()=>{const e=t.z.sub(i.x),r=ah(0,i.y.mul(i.y));let o=r.div(r.add(e.mul(e)));o=xh(tc(o,.3).div(.95-.3)),n.assign(xh(ah(s,o)))})),n})),z_=Vu((([e,t,r])=>{let n=$d.sub(e).length();return n=n.sub(t).div(r.sub(t)),n=n.saturate(),n})),$_=e=>{let t=I_.get(e);if(void 0===t){const r=e.isPointLight?(e=>{const t=e.shadow.camera,r=xp("near","float",t).setGroup(Hl),n=xp("far","float",t).setGroup(Hl),i=Fd(e);return z_(i,r,n)})(e):null;t=new _g,t.colorNode=il(0,0,0,1),t.depthNode=r,t.isShadowPassMaterial=!0,t.name="ShadowMaterial",t.fog=!1,I_.set(e,t)}return t},H_=new rb,W_=[],q_=Vu((({samples:e,radius:t,size:r,shadowPass:n,depthLayer:i})=>{const s=Wu(0).toVar("meanVertical"),o=Wu(0).toVar("squareMeanVertical"),a=e.lessThanEqual(Wu(1)).select(Wu(0),Wu(2).div(e.sub(1))),u=e.lessThanEqual(Wu(1)).select(Wu(0),Wu(-1));kf({start:qu(0),end:qu(e),type:"int",condition:"<"},(({i:e})=>{const l=u.add(Wu(e).mul(a));let c=n.sample(ec(Jf.xy,Yu(0,l).mul(t)).div(r));n.value.isArrayTexture&&(c=c.depth(i)),c=c.x,s.addAssign(c),o.addAssign(c.mul(c))})),s.divAssign(e),o.divAssign(e);const l=Bc(o.sub(s.mul(s)));return Yu(s,l)})),X_=Vu((({samples:e,radius:t,size:r,shadowPass:n,depthLayer:i})=>{const s=Wu(0).toVar("meanHorizontal"),o=Wu(0).toVar("squareMeanHorizontal"),a=e.lessThanEqual(Wu(1)).select(Wu(0),Wu(2).div(e.sub(1))),u=e.lessThanEqual(Wu(1)).select(Wu(0),Wu(-1));kf({start:qu(0),end:qu(e),type:"int",condition:"<"},(({i:e})=>{const l=u.add(Wu(e).mul(a));let c=n.sample(ec(Jf.xy,Yu(l,0).mul(t)).div(r));n.value.isArrayTexture&&(c=c.depth(i)),s.addAssign(c.x),o.addAssign(ec(c.y.mul(c.y),c.x.mul(c.x)))})),s.divAssign(e),o.divAssign(e);const l=Bc(o.sub(s.mul(s)));return Yu(s,l)})),K_=[U_,V_,j_,G_];let Y_;const Q_=new Xb;class Z_ extends L_{static get type(){return"ShadowNode"}constructor(e,t=null){super(e),this.shadow=t||e.shadow,this.shadowMap=null,this.vsmShadowMapVertical=null,this.vsmShadowMapHorizontal=null,this.vsmMaterialVertical=null,this.vsmMaterialHorizontal=null,this._node=null,this._cameraFrameId=new WeakMap,this.isShadowNode=!0,this.depthLayer=0}setupShadowFilter(e,{filterFn:t,depthTexture:r,shadowCoord:n,shadow:i,depthLayer:s}){const o=n.x.greaterThanEqual(0).and(n.x.lessThanEqual(1)).and(n.y.greaterThanEqual(0)).and(n.y.lessThanEqual(1)).and(n.z.lessThanEqual(1)),a=t({depthTexture:r,shadowCoord:n,shadow:i,depthLayer:s});return o.select(a,Wu(1))}setupShadowCoord(e,t){const{shadow:r}=this,{renderer:n}=e,i=xp("bias","float",r).setGroup(Hl);let s,o=t;if(r.camera.isOrthographicCamera||!0!==n.logarithmicDepthBuffer)o=o.xyz.div(o.w),s=o.z,n.coordinateSystem===Ne&&(s=s.mul(2).sub(1));else{const e=o.w;o=o.xy.div(e);const t=xp("near","float",r.camera).setGroup(Hl),n=xp("far","float",r.camera).setGroup(Hl);s=hg(e.negate(),t,n)}return o=el(o.x,o.y.oneMinus(),s.add(i)),o}getShadowFilterFn(e){return K_[e]}setupRenderTarget(e,t){const r=new se(e.mapSize.width,e.mapSize.height);r.name="ShadowDepthTexture",r.compareFunction=ze;const n=t.createRenderTarget(e.mapSize.width,e.mapSize.height);return n.texture.name="ShadowMap",n.texture.type=e.mapType,n.depthTexture=r,{shadowMap:n,depthTexture:r}}setupShadow(e){const{renderer:t}=e,{light:r,shadow:n}=this,i=t.shadowMap.type,{depthTexture:s,shadowMap:o}=this.setupRenderTarget(n,e);if(n.camera.updateProjectionMatrix(),i===dn&&!0!==n.isPointLightShadow){s.compareFunction=null,o.depth>1?(o._vsmShadowMapVertical||(o._vsmShadowMapVertical=e.createRenderTarget(n.mapSize.width,n.mapSize.height,{format:Ot,type:w,depth:o.depth,depthBuffer:!1}),o._vsmShadowMapVertical.texture.name="VSMVertical"),this.vsmShadowMapVertical=o._vsmShadowMapVertical,o._vsmShadowMapHorizontal||(o._vsmShadowMapHorizontal=e.createRenderTarget(n.mapSize.width,n.mapSize.height,{format:Ot,type:w,depth:o.depth,depthBuffer:!1}),o._vsmShadowMapHorizontal.texture.name="VSMHorizontal"),this.vsmShadowMapHorizontal=o._vsmShadowMapHorizontal):(this.vsmShadowMapVertical=e.createRenderTarget(n.mapSize.width,n.mapSize.height,{format:Ot,type:w,depthBuffer:!1}),this.vsmShadowMapHorizontal=e.createRenderTarget(n.mapSize.width,n.mapSize.height,{format:Ot,type:w,depthBuffer:!1}));let t=yd(s);s.isArrayTexture&&(t=t.depth(this.depthLayer));let r=yd(this.vsmShadowMapVertical.texture);s.isArrayTexture&&(r=r.depth(this.depthLayer));const i=xp("blurSamples","float",n).setGroup(Hl),a=xp("radius","float",n).setGroup(Hl),u=xp("mapSize","vec2",n).setGroup(Hl);let l=this.vsmMaterialVertical||(this.vsmMaterialVertical=new _g);l.fragmentNode=q_({samples:i,radius:a,size:u,shadowPass:t,depthLayer:this.depthLayer}).context(e.getSharedContext()),l.name="VSMVertical",l=this.vsmMaterialHorizontal||(this.vsmMaterialHorizontal=new _g),l.fragmentNode=X_({samples:i,radius:a,size:u,shadowPass:r,depthLayer:this.depthLayer}).context(e.getSharedContext()),l.name="VSMHorizontal"}const a=xp("intensity","float",n).setGroup(Hl),u=xp("normalBias","float",n).setGroup(Hl),l=C_(r).mul(B_.add(rp.mul(u))),c=this.setupShadowCoord(e,l),h=n.filterNode||this.getShadowFilterFn(t.shadowMap.type)||null;if(null===h)throw new Error("THREE.WebGPURenderer: Shadow map type not supported yet.");const d=i===dn&&!0!==n.isPointLightShadow?this.vsmShadowMapHorizontal.texture:s,p=this.setupShadowFilter(e,{filterFn:h,shadowTexture:o.texture,depthTexture:d,shadowCoord:c,shadow:n,depthLayer:this.depthLayer});let f=yd(o.texture,c);s.isArrayTexture&&(f=f.depth(this.depthLayer));const g=vh(1,p.rgb.mix(f,1),a.mul(f.a)).toVar();return this.shadowMap=o,this.shadow.map=o,g}setup(e){if(!1!==e.renderer.shadowMap.enabled)return Vu((()=>{let t=this._node;return this.setupShadowPosition(e),null===t&&(this._node=t=this.setupShadow(e)),e.material.shadowNode,e.material.receivedShadowNode&&(t=e.material.receivedShadowNode(t)),t}))()}renderShadow(e){const{shadow:t,shadowMap:r,light:n}=this,{renderer:i,scene:s}=e;t.updateMatrices(n),r.setSize(t.mapSize.width,t.mapSize.height,r.depth),i.render(s,t.camera)}updateShadow(e){const{shadowMap:t,light:r,shadow:n}=this,{renderer:i,scene:s,camera:o}=e,a=i.shadowMap.type,u=t.depthTexture.version;this._depthVersionCached=u;const l=n.camera.layers.mask;4294967294&n.camera.layers.mask||(n.camera.layers.mask=o.layers.mask);const c=i.getRenderObjectFunction(),h=i.getMRT(),d=!!h&&h.has("velocity");Y_=function(e,t,r){return r=function(e,t){return t=function(e,t={}){return t.background=e.background,t.backgroundNode=e.backgroundNode,t.overrideMaterial=e.overrideMaterial,t}(e,t),e.background=null,e.backgroundNode=null,e.overrideMaterial=null,t}(t,r=k_(e,r)),r}(i,s,Y_),s.overrideMaterial=$_(r),i.setRenderObjectFunction(((e,t,r,n)=>{W_[0]=e,W_[1]=t;let i=H_.get(W_);return void 0!==i&&i.shadowType===r&&i.useVelocity===n||(i=(i,s,o,a,u,l,...c)=>{(!0===i.castShadow||i.receiveShadow&&r===dn)&&(n&&(Fa(i).useVelocity=!0),i.onBeforeShadow(e,i,o,t.camera,a,s.overrideMaterial,l),e.renderObject(i,s,o,a,u,l,...c),i.onAfterShadow(e,i,o,t.camera,a,s.overrideMaterial,l))},i.shadowType=r,i.useVelocity=n,H_.set(W_,i)),W_[0]=null,W_[1]=null,i})(i,n,a,d)),i.setClearColor(0,0),i.setRenderTarget(t),this.renderShadow(e),i.setRenderObjectFunction(c),a===dn&&!0!==n.isPointLightShadow&&this.vsmPass(i),n.camera.layers.mask=l,function(e,t,r){!function(e,t){e.toneMapping=t.toneMapping,e.toneMappingExposure=t.toneMappingExposure,e.outputColorSpace=t.outputColorSpace,e.setRenderTarget(t.renderTarget,t.activeCubeFace,t.activeMipmapLevel),e.setRenderObjectFunction(t.renderObjectFunction),e.setPixelRatio(t.pixelRatio),e.setMRT(t.mrt),e.setClearColor(t.clearColor,t.clearAlpha),e.autoClear=t.autoClear,e.setScissorTest(t.scissorTest)}(e,r),function(e,t){e.background=t.background,e.backgroundNode=t.backgroundNode,e.overrideMaterial=t.overrideMaterial}(t,r)}(i,s,Y_)}vsmPass(e){const{shadow:t}=this,r=this.shadowMap.depth;this.vsmShadowMapVertical.setSize(t.mapSize.width,t.mapSize.height,r),this.vsmShadowMapHorizontal.setSize(t.mapSize.width,t.mapSize.height,r),e.setRenderTarget(this.vsmShadowMapVertical),Q_.material=this.vsmMaterialVertical,Q_.render(e),e.setRenderTarget(this.vsmShadowMapHorizontal),Q_.material=this.vsmMaterialHorizontal,Q_.render(e)}dispose(){this.shadowMap.dispose(),this.shadowMap=null,null!==this.vsmShadowMapVertical&&(this.vsmShadowMapVertical.dispose(),this.vsmShadowMapVertical=null,this.vsmMaterialVertical.dispose(),this.vsmMaterialVertical=null),null!==this.vsmShadowMapHorizontal&&(this.vsmShadowMapHorizontal.dispose(),this.vsmShadowMapHorizontal=null,this.vsmMaterialHorizontal.dispose(),this.vsmMaterialHorizontal=null),super.dispose()}updateBefore(e){const{shadow:t}=this;let r=t.needsUpdate||t.autoUpdate;r&&(this._cameraFrameId[e.camera]===e.frameId&&(r=!1),this._cameraFrameId[e.camera]=e.frameId),r&&(this.updateShadow(e),this.shadowMap.depthTexture.version===this._depthVersionCached&&(t.needsUpdate=!1))}}const J_=new h,ev=Vu((([e,t])=>{const r=e.toVar(),n=Xc(r),i=nc(1,ah(n.x,ah(n.y,n.z)));n.mulAssign(i),r.mulAssign(i.mul(t.mul(2).oneMinus()));const s=Yu(r.xy).toVar(),o=t.mul(1.5).oneMinus();return zu(n.z.greaterThanEqual(o),(()=>{zu(r.z.greaterThan(0),(()=>{s.x.assign(tc(4,r.x))}))})).ElseIf(n.x.greaterThanEqual(o),(()=>{const e=Kc(r.x);s.x.assign(r.z.mul(e).add(e.mul(2)))})).ElseIf(n.y.greaterThanEqual(o),(()=>{const e=Kc(r.y);s.x.assign(r.x.add(e.mul(2)).add(2)),s.y.assign(r.z.mul(e).sub(2))})),Yu(.125,.25).mul(s).add(Yu(.375,.75)).flipY()})).setLayout({name:"cubeToUV",type:"vec2",inputs:[{name:"pos",type:"vec3"},{name:"texelSizeY",type:"float"}]}),tv=Vu((({depthTexture:e,bd3D:t,dp:r,texelSize:n})=>yd(e,ev(t,n.y)).compare(r))),rv=Vu((({depthTexture:e,bd3D:t,dp:r,texelSize:n,shadow:i})=>{const s=xp("radius","float",i).setGroup(Hl),o=Yu(-1,1).mul(s).mul(n.y);return yd(e,ev(t.add(o.xyy),n.y)).compare(r).add(yd(e,ev(t.add(o.yyy),n.y)).compare(r)).add(yd(e,ev(t.add(o.xyx),n.y)).compare(r)).add(yd(e,ev(t.add(o.yyx),n.y)).compare(r)).add(yd(e,ev(t,n.y)).compare(r)).add(yd(e,ev(t.add(o.xxy),n.y)).compare(r)).add(yd(e,ev(t.add(o.yxy),n.y)).compare(r)).add(yd(e,ev(t.add(o.xxx),n.y)).compare(r)).add(yd(e,ev(t.add(o.yxx),n.y)).compare(r)).mul(1/9)})),nv=Vu((({filterFn:e,depthTexture:t,shadowCoord:r,shadow:n})=>{const i=r.xyz.toVar(),s=i.length(),o=Xl("float").setGroup(Hl).onRenderUpdate((()=>n.camera.near)),a=Xl("float").setGroup(Hl).onRenderUpdate((()=>n.camera.far)),u=xp("bias","float",n).setGroup(Hl),l=Xl(n.mapSize).setGroup(Hl),c=Wu(1).toVar();return zu(s.sub(a).lessThanEqual(0).and(s.sub(o).greaterThanEqual(0)),(()=>{const r=s.sub(o).div(a.sub(o)).toVar();r.addAssign(u);const h=i.normalize(),d=Yu(1).div(l.mul(Yu(4,2)));c.assign(e({depthTexture:t,bd3D:h,dp:r,texelSize:d,shadow:n}))})),c})),iv=new E,sv=new i,ov=new i;class av extends Z_{static get type(){return"PointShadowNode"}constructor(e,t=null){super(e,t)}getShadowFilterFn(e){return e===on?tv:rv}setupShadowCoord(e,t){return t}setupShadowFilter(e,{filterFn:t,shadowTexture:r,depthTexture:n,shadowCoord:i,shadow:s}){return nv({filterFn:t,shadowTexture:r,depthTexture:n,shadowCoord:i,shadow:s})}renderShadow(e){const{shadow:t,shadowMap:r,light:n}=this,{renderer:i,scene:s}=e,o=t.getFrameExtents();ov.copy(t.mapSize),ov.multiply(o),r.setSize(ov.width,ov.height),sv.copy(t.mapSize);const a=i.autoClear,u=i.getClearColor(J_),l=i.getClearAlpha();i.autoClear=!1,i.setClearColor(t.clearColor,t.clearAlpha),i.clear();const c=t.getViewportCount();for(let h=0;h<c;h++){const e=t.getViewport(h),o=sv.x*e.x,a=ov.y-sv.y-sv.y*e.y;iv.set(o,a,sv.x*e.z,sv.y*e.w),r.viewport.copy(iv),t.updateMatrices(n,h),i.render(s,t.camera)}i.autoClear=a,i.setClearColor(u,l)}}class uv extends zf{static get type(){return"AnalyticLightNode"}constructor(e=null){super(),this.light=e,this.color=new h,this.colorNode=e&&e.colorNode||Xl(this.color).setGroup(Hl),this.baseColorNode=null,this.shadowNode=null,this.shadowColorNode=null,this.isAnalyticLightNode=!0,this.updateType=Ba}getHash(){return this.light.uuid}getLightVector(e){return M_(this.light).sub(e.context.positionView||Wd)}setupDirect(){}setupDirectRectArea(){}setupShadowNode(){return e=this.light,Ou(new Z_(e,t));var e,t}setupShadow(e){const{renderer:t}=e;if(!1===t.shadowMap.enabled)return;let r=this.shadowColorNode;if(null===r){const e=this.light.shadow.shadowNode;let t;t=void 0!==e?Ou(e):this.setupShadowNode(),this.shadowNode=t,this.shadowColorNode=r=this.colorNode.mul(t),this.baseColorNode=this.colorNode}this.colorNode=r}setup(e){this.colorNode=this.baseColorNode||this.colorNode,this.light.castShadow?e.object.receiveShadow&&this.setupShadow(e):null!==this.shadowNode&&(this.shadowNode.dispose(),this.shadowNode=null,this.shadowColorNode=null);const t=this.setupDirect(e),r=this.setupDirectRectArea(e);t&&e.lightsNode.setupDirectLight(e,this,t),r&&e.lightsNode.setupDirectRectAreaLight(e,this,r)}update(){const{light:e}=this;this.color.copy(e.color).multiplyScalar(e.intensity)}}const lv=Vu((({lightDistance:e,cutoffDistance:t,decayExponent:r})=>{const n=e.pow(r).max(.01).reciprocal();return t.greaterThan(0).select(n.mul(e.div(t).pow4().oneMinus().clamp().pow2()),n)}));class cv extends uv{static get type(){return"PointLightNode"}constructor(e=null){super(e),this.cutoffDistanceNode=Xl(0).setGroup(Hl),this.decayExponentNode=Xl(2).setGroup(Hl)}update(e){const{light:t}=this;super.update(e),this.cutoffDistanceNode.value=t.distance,this.decayExponentNode.value=t.decay}setupShadowNode(){return e=this.light,Ou(new av(e,t));var e,t}setupDirect(e){return(({color:e,lightVector:t,cutoffDistance:r,decayExponent:n})=>{const i=t.normalize(),s=t.length(),o=lv({lightDistance:s,cutoffDistance:r,decayExponent:n});return{lightDirection:i,lightColor:e.mul(o)}})({color:this.colorNode,lightVector:this.getLightVector(e),cutoffDistance:this.cutoffDistanceNode,decayExponent:this.decayExponentNode})}}Vu((([e=ld()],{renderer:t,material:r})=>{const n=_h(e.mul(2).sub(1));let i;if(r.alphaToCoverage&&t.samples>1){const e=Wu(n.fwidth()).toVar();i=Sh(e.oneMinus(),e.add(1),n).oneMinus()}else i=Ah(n.greaterThan(1),0,1);return i}));const hv=Vu((([e,t])=>{const r=e.x,n=e.y,i=e.z;let s=t.element(0).mul(.886227);return s=s.add(t.element(1).mul(1.023328).mul(n)),s=s.add(t.element(2).mul(1.023328).mul(i)),s=s.add(t.element(3).mul(1.023328).mul(r)),s=s.add(t.element(4).mul(.858086).mul(r).mul(n)),s=s.add(t.element(5).mul(.858086).mul(n).mul(i)),s=s.add(t.element(6).mul(i.mul(i).mul(.743125).sub(.247708))),s=s.add(t.element(7).mul(.858086).mul(r).mul(i)),s=s.add(t.element(8).mul(.429043).mul(rc(r,r).sub(rc(n,n)))),s})),dv=new Vb;class pv extends ab{constructor(e,t){super(),this.renderer=e,this.nodes=t}update(e,t,r){const n=this.renderer,i=this.nodes.getBackgroundNode(e)||e.background;let s=!1;if(null===i)n._clearColor.getRGB(dv),dv.a=n._clearColor.a;else if(!0===i.isColor)i.getRGB(dv),dv.a=1,s=!0;else if(!0===i.isNode){const r=this.get(e),s=i;dv.copy(n._clearColor);let o=r.backgroundMesh;if(void 0===o){let e=function(){i.removeEventListener("dispose",e),o.material.dispose(),o.geometry.dispose()};const t=Rh(il(s).mul(Jb),{getUV:()=>e_.mul(ep),getTextureLevel:()=>Zb});let n=Sf;n=n.setZ(n.w);const a=new _g;a.name="Background.material",a.side=L,a.depthTest=!1,a.depthWrite=!1,a.allowOverride=!1,a.fog=!1,a.lights=!1,a.vertexNode=n,a.colorNode=t,r.backgroundMeshNode=t,r.backgroundMesh=o=new l(new c(1,32,32),a),o.frustumCulled=!1,o.name="Background.mesh",o.onBeforeRender=function(e,t,r){this.matrixWorld.copyPosition(r.matrixWorld)},i.addEventListener("dispose",e)}const a=s.getCacheKey();r.backgroundCacheKey!==a&&(r.backgroundMeshNode.node=il(s).mul(Jb),r.backgroundMeshNode.needsUpdate=!0,o.material.needsUpdate=!0,r.backgroundCacheKey=a),t.unshift(o,o.geometry,o.material,0,0,null,null)}const o=n.xr.getEnvironmentBlendMode();if("additive"===o?dv.set(0,0,0,1):"alpha-blend"===o&&dv.set(0,0,0,0),!0===n.autoClear||!0===s){const e=r.clearColorValue;e.r=dv.r,e.g=dv.g,e.b=dv.b,e.a=dv.a,!0!==n.backend.isWebGLBackend&&!0!==n.alpha||(e.r*=e.a,e.g*=e.a,e.b*=e.a),r.depthClearValue=n._clearDepth,r.stencilClearValue=n._clearStencil,r.clearColor=!0===n.autoClearColor,r.clearDepth=!0===n.autoClearDepth,r.clearStencil=!0===n.autoClearStencil}else r.clearColor=!1,r.clearDepth=!1,r.clearStencil=!1}}let fv=0;class gv{constructor(e="",t=[],r=0,n=[]){this.name=e,this.bindings=t,this.index=r,this.bindingsReference=n,this.id=fv++}}class mv{constructor(e,t,r,n,i,s,o,a,u,l=[]){this.vertexShader=e,this.fragmentShader=t,this.computeShader=r,this.transforms=l,this.nodeAttributes=n,this.bindings=i,this.updateNodes=s,this.updateBeforeNodes=o,this.updateAfterNodes=a,this.observer=u,this.usedTimes=0}createBindings(){const e=[];for(const t of this.bindings){if(!0!==t.bindings[0].groupNode.shared){const r=new gv(t.name,[],t.index,t);e.push(r);for(const e of t.bindings)r.bindings.push(e.clone())}else e.push(t)}return e}}class yv{constructor(e,t,r=null){this.isNodeAttribute=!0,this.name=e,this.type=t,this.node=r}}class bv{constructor(e,t,r){this.isNodeUniform=!0,this.name=e,this.type=t,this.node=r.getSelf()}get value(){return this.node.value}set value(e){this.node.value=e}get id(){return this.node.id}get groupNode(){return this.node.groupNode}}class _v{constructor(e,t,r=!1,n=null){this.isNodeVar=!0,this.name=e,this.type=t,this.readOnly=r,this.count=n}}class vv extends _v{constructor(e,t,r=null,n=null){super(e,t),this.needsInterpolation=!1,this.isNodeVarying=!0,this.interpolationType=r,this.interpolationSampling=n}}class xv{constructor(e,t,r=""){this.name=e,this.type=t,this.code=r,Object.defineProperty(this,"isNodeCode",{value:!0})}}let Tv=0;class wv{constructor(e=null){this.id=Tv++,this.nodesData=new WeakMap,this.parent=e}getData(e){let t=this.nodesData.get(e);return void 0===t&&null!==this.parent&&(t=this.parent.getData(e)),t}setData(e,t){this.nodesData.set(e,t)}}class Sv{constructor(e,t){this.name=e,this.members=t,this.output=!1}}class Nv{constructor(e,t){this.name=e,this.value=t,this.boundary=0,this.itemSize=0,this.offset=0}setValue(e){this.value=e}getValue(){return this.value}}class Ev extends Nv{constructor(e,t=0){super(e,t),this.isNumberUniform=!0,this.boundary=4,this.itemSize=1}}class Cv extends Nv{constructor(e,t=new i){super(e,t),this.isVector2Uniform=!0,this.boundary=8,this.itemSize=2}}class Av extends Nv{constructor(e,t=new o){super(e,t),this.isVector3Uniform=!0,this.boundary=16,this.itemSize=3}}class Mv extends Nv{constructor(e,t=new E){super(e,t),this.isVector4Uniform=!0,this.boundary=16,this.itemSize=4}}class Rv extends Nv{constructor(e,t=new h){super(e,t),this.isColorUniform=!0,this.boundary=16,this.itemSize=3}}class Pv extends Nv{constructor(e,t=new Jr){super(e,t),this.isMatrix2Uniform=!0,this.boundary=8,this.itemSize=4}}class Dv extends Nv{constructor(e,t=new Se){super(e,t),this.isMatrix3Uniform=!0,this.boundary=48,this.itemSize=12}}class Fv extends Nv{constructor(e,t=new a){super(e,t),this.isMatrix4Uniform=!0,this.boundary=64,this.itemSize=16}}class Ov extends Ev{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}}class Lv extends Cv{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}}class Bv extends Av{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}}class kv extends Mv{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}}class Iv extends Rv{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}}class Uv extends Pv{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}}class Vv extends Dv{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}}class jv extends Fv{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}}const Gv=new WeakMap,zv=new Map([[Int8Array,"int"],[Int16Array,"int"],[Int32Array,"int"],[Uint8Array,"uint"],[Uint16Array,"uint"],[Uint32Array,"uint"],[Float32Array,"float"]]),$v=e=>/e/g.test(e)?String(e).replace(/\+/g,""):(e=Number(e))+(e%1?"":".0");class Hv{constructor(e,t,r){this.object=e,this.material=e&&e.material||null,this.geometry=e&&e.geometry||null,this.renderer=t,this.parser=r,this.scene=null,this.camera=null,this.nodes=[],this.sequentialNodes=[],this.updateNodes=[],this.updateBeforeNodes=[],this.updateAfterNodes=[],this.hashNodes={},this.observer=null,this.lightsNode=null,this.environmentNode=null,this.fogNode=null,this.clippingContext=null,this.vertexShader=null,this.fragmentShader=null,this.computeShader=null,this.flowNodes={vertex:[],fragment:[],compute:[]},this.flowCode={vertex:"",fragment:"",compute:""},this.uniforms={vertex:[],fragment:[],compute:[],index:0},this.structs={vertex:[],fragment:[],compute:[],index:0},this.bindings={vertex:{},fragment:{},compute:{}},this.bindingsIndexes={},this.bindGroups=null,this.attributes=[],this.bufferAttributes=[],this.varyings=[],this.codes={},this.vars={},this.declarations={},this.flow={code:""},this.chaining=[],this.stack=zb(),this.stacks=[],this.tab="\t",this.currentFunctionNode=null,this.context={material:this.material},this.cache=new wv,this.globalCache=this.cache,this.flowsData=new WeakMap,this.shaderStage=null,this.buildStage=null}getBindGroupsCache(){let e=Gv.get(this.renderer);return void 0===e&&(e=new rb,Gv.set(this.renderer,e)),e}createRenderTarget(e,t,r){return new M(e,t,r)}createCubeRenderTarget(e,t){return new Ag(e,t)}includes(e){return this.nodes.includes(e)}getOutputStructName(){}_getBindGroup(e,t){const r=this.getBindGroupsCache(),n=[];let i,s=!0;for(const o of t)n.push(o),s=s&&!0!==o.groupNode.shared;return s?(i=r.get(n),void 0===i&&(i=new gv(e,n,this.bindingsIndexes[e].group,n),r.set(n,i))):i=new gv(e,n,this.bindingsIndexes[e].group,n),i}getBindGroupArray(e,t){const r=this.bindings[t];let n=r[e];return void 0===n&&(void 0===this.bindingsIndexes[e]&&(this.bindingsIndexes[e]={binding:0,group:Object.keys(this.bindingsIndexes).length}),r[e]=n=[]),n}getBindings(){let e=this.bindGroups;if(null===e){const t={},r=this.bindings;for(const e of za)for(const n in r[e]){const i=r[e][n];(t[n]||(t[n]=[])).push(...i)}e=[];for(const n in t){const r=t[n],i=this._getBindGroup(n,r);e.push(i)}this.bindGroups=e}return e}sortBindingGroups(){const e=this.getBindings();e.sort(((e,t)=>e.bindings[0].groupNode.order-t.bindings[0].groupNode.order));for(let t=0;t<e.length;t++){const r=e[t];this.bindingsIndexes[r.name].group=t,r.index=t}}setHashNode(e,t){this.hashNodes[t]=e}addNode(e){!1===this.nodes.includes(e)&&(this.nodes.push(e),this.setHashNode(e,e.getHash(this)))}addSequentialNode(e){!1===this.sequentialNodes.includes(e)&&this.sequentialNodes.push(e)}buildUpdateNodes(){for(const e of this.nodes){e.getUpdateType()!==La&&this.updateNodes.push(e.getSelf())}for(const e of this.sequentialNodes){const t=e.getUpdateBeforeType(),r=e.getUpdateAfterType();t!==La&&this.updateBeforeNodes.push(e.getSelf()),r!==La&&this.updateAfterNodes.push(e.getSelf())}}get currentNode(){return this.chaining[this.chaining.length-1]}isFilteredTexture(e){return e.magFilter===R||e.magFilter===Oe||e.magFilter===Le||e.magFilter===Fe||e.minFilter===R||e.minFilter===Oe||e.minFilter===Le||e.minFilter===Fe}addChain(e){this.chaining.push(e)}removeChain(e){if(this.chaining.pop()!==e)throw new Error("NodeBuilder: Invalid node chaining!")}getMethod(e){return e}getNodeFromHash(e){return this.hashNodes[e]}addFlow(e,t){return this.flowNodes[e].push(t),t}setContext(e){this.context=e}getContext(){return this.context}getSharedContext(){return this.context,this.context}setCache(e){this.cache=e}getCache(){return this.cache}getCacheFromNode(e,t=!0){const r=this.getDataFromNode(e);return void 0===r.cache&&(r.cache=new wv(t?this.getCache():null)),r.cache}isAvailable(){return!1}getVertexIndex(){}getInstanceIndex(){}getDrawIndex(){}getFrontFacing(){}getFragCoord(){}isFlipY(){return!1}increaseUsage(e){const t=this.getDataFromNode(e);return t.usageCount=void 0===t.usageCount?1:t.usageCount+1,t.usageCount}generateTexture(){}generateTextureLod(){}generateArrayDeclaration(e,t){return this.getType(e)+"[ "+t+" ]"}generateArray(e,t,r=null){let n=this.generateArrayDeclaration(e,t)+"( ";for(let i=0;i<t;i++){const s=r?r[i]:null;n+=null!==s?s.build(this,e):this.generateConst(e),i<t-1&&(n+=", ")}return n+=" )",n}generateStruct(e,t,r=null){const n=[];for(const i of t){const{name:e,type:t}=i;r&&r[e]&&r[e].isNode?n.push(r[e].build(this,t)):n.push(this.generateConst(t))}return e+"( "+n.join(", ")+" )"}generateConst(e,t=null){if(null===t&&("float"===e||"int"===e||"uint"===e?t=0:"bool"===e?t=!1:"color"===e?t=new h:"vec2"===e?t=new i:"vec3"===e?t=new o:"vec4"===e&&(t=new E)),"float"===e)return $v(t);if("int"===e)return`${Math.round(t)}`;if("uint"===e)return t>=0?`${Math.round(t)}u`:"0u";if("bool"===e)return t?"true":"false";if("color"===e)return`${this.getType("vec3")}( ${$v(t.r)}, ${$v(t.g)}, ${$v(t.b)} )`;const r=this.getTypeLength(e),n=this.getComponentType(e),s=e=>this.generateConst(n,e);if(2===r)return`${this.getType(e)}( ${s(t.x)}, ${s(t.y)} )`;if(3===r)return`${this.getType(e)}( ${s(t.x)}, ${s(t.y)}, ${s(t.z)} )`;if(4===r&&"mat2"!==e)return`${this.getType(e)}( ${s(t.x)}, ${s(t.y)}, ${s(t.z)}, ${s(t.w)} )`;if(r>=4&&t&&(t.isMatrix2||t.isMatrix3||t.isMatrix4))return`${this.getType(e)}( ${t.elements.map(s).join(", ")} )`;if(r>4)return`${this.getType(e)}()`;throw new Error(`NodeBuilder: Type '${e}' not found in generate constant attempt.`)}getType(e){return"color"===e?"vec3":e}hasGeometryAttribute(e){return this.geometry&&void 0!==this.geometry.getAttribute(e)}getAttribute(e,t){const r=this.attributes;for(const i of r)if(i.name===e)return i;const n=new yv(e,t);return this.registerDeclaration(n),r.push(n),n}getPropertyName(e){return e.name}isVector(e){return/vec\d/.test(e)}isMatrix(e){return/mat\d/.test(e)}isReference(e){return"void"===e||"property"===e||"sampler"===e||"samplerComparison"===e||"texture"===e||"cubeTexture"===e||"storageTexture"===e||"depthTexture"===e||"texture3D"===e}needsToWorkingColorSpace(){return!1}getComponentTypeFromTexture(e){const t=e.type;if(e.isDataTexture){if(t===Me)return"int";if(t===ue)return"uint"}return"float"}getElementType(e){return"mat2"===e?"vec2":"mat3"===e?"vec3":"mat4"===e?"vec4":this.getComponentType(e)}getComponentType(e){if("float"===(e=this.getVectorType(e))||"bool"===e||"int"===e||"uint"===e)return e;const t=/(b|i|u|)(vec|mat)([2-4])/.exec(e);return null===t?null:"b"===t[1]?"bool":"i"===t[1]?"int":"u"===t[1]?"uint":"float"}getVectorType(e){return"color"===e?"vec3":"texture"===e||"cubeTexture"===e||"storageTexture"===e||"texture3D"===e?"vec4":e}getTypeFromLength(e,t="float"){if(1===e)return t;let r=function(e){return Ma.get(e)}(e);const n="float"===t?"":t[0];return!0===/mat2/.test(t)&&(r=r.replace("vec","mat")),n+r}getTypeFromArray(e){return zv.get(e.constructor)}isInteger(e){return/int|uint|(i|u)vec/.test(e)}getTypeFromAttribute(e){let t=e;e.isInterleavedBufferAttribute&&(t=e.data);const r=t.array,n=e.itemSize,i=e.normalized;let s;return e instanceof qr||!0===i||(s=this.getTypeFromArray(r)),this.getTypeFromLength(n,s)}getTypeLength(e){const t=this.getVectorType(e),r=/vec([2-4])/.exec(t);return null!==r?Number(r[1]):"float"===t||"bool"===t||"int"===t||"uint"===t?1:!0===/mat2/.test(e)?4:!0===/mat3/.test(e)?9:!0===/mat4/.test(e)?16:0}getVectorFromMatrix(e){return e.replace("mat","vec")}changeComponentType(e,t){return this.getTypeFromLength(this.getTypeLength(e),t)}getIntegerType(e){const t=this.getComponentType(e);return"int"===t||"uint"===t?e:this.changeComponentType(e,"int")}addStack(){return this.stack=zb(this.stack),this.stacks.push(Gu()||this.stack),ju(this.stack),this.stack}removeStack(){const e=this.stack;return this.stack=e.parent,ju(this.stacks.pop()),e}getDataFromNode(e,t=this.shaderStage,r=null){let n=(r=null===r?e.isGlobal(this)?this.globalCache:this.cache:r).getData(e);return void 0===n&&(n={},r.setData(e,n)),void 0===n[t]&&(n[t]={}),n[t]}getNodeProperties(e,t="any"){const r=this.getDataFromNode(e,t);return r.properties||(r.properties={outputNode:null})}getBufferAttributeFromNode(e,t){const r=this.getDataFromNode(e);let n=r.bufferAttribute;if(void 0===n){const i=this.uniforms.index++;n=new yv("nodeAttribute"+i,t,e),this.bufferAttributes.push(n),r.bufferAttribute=n}return n}getStructTypeFromNode(e,t,r=null,n=this.shaderStage){const i=this.getDataFromNode(e,n,this.globalCache);let s=i.structType;if(void 0===s){const e=this.structs.index++;null===r&&(r="StructType"+e),s=new Sv(r,t),this.structs[n].push(s),i.structType=s}return s}getOutputStructTypeFromNode(e,t){const r=this.getStructTypeFromNode(e,t,"OutputType","fragment");return r.output=!0,r}getUniformFromNode(e,t,r=this.shaderStage,n=null){const i=this.getDataFromNode(e,r,this.globalCache);let s=i.uniform;if(void 0===s){const o=this.uniforms.index++;s=new bv(n||"nodeUniform"+o,t,e),this.uniforms[r].push(s),this.registerDeclaration(s),i.uniform=s}return s}getArrayCount(e){let t=null;return e.isArrayNode?t=e.count:e.isVarNode&&e.node.isArrayNode&&(t=e.node.count),t}getVarFromNode(e,t=null,r=e.getNodeType(this),n=this.shaderStage,i=!1){const s=this.getDataFromNode(e,n);let o=s.variable;if(void 0===o){const a=i?"_const":"_var",u=this.vars[n]||(this.vars[n]=[]),l=this.vars[a]||(this.vars[a]=0);null===t&&(t=(i?"nodeConst":"nodeVar")+l,this.vars[a]++);const c=this.getArrayCount(e);o=new _v(t,r,i,c),i||u.push(o),this.registerDeclaration(o),s.variable=o}return o}isDeterministic(e){if(e.isMathNode)return this.isDeterministic(e.aNode)&&(!e.bNode||this.isDeterministic(e.bNode))&&(!e.cNode||this.isDeterministic(e.cNode));if(e.isOperatorNode)return this.isDeterministic(e.aNode)&&(!e.bNode||this.isDeterministic(e.bNode));if(e.isArrayNode){if(null!==e.values)for(const t of e.values)if(!this.isDeterministic(t))return!1;return!0}return!!e.isConstNode}getVaryingFromNode(e,t=null,r=e.getNodeType(this),n=null,i=null){const s=this.getDataFromNode(e,"any");let o=s.varying;if(void 0===o){const e=this.varyings,a=e.length;null===t&&(t="nodeVarying"+a),o=new vv(t,r,n,i),e.push(o),this.registerDeclaration(o),s.varying=o}return o}get namespace(){return this.context.namespace}getOutputNamespace(){return this.getNamespace("outputNode")}getNamespace(e=""){const t=this.namespace;let r;return r=t?e?t+"_"+e:t:e,r}registerDeclaration(e){const t=this.shaderStage,r=this.declarations[t]||(this.declarations[t]={}),n=this.getPropertyName(e);let i=1,s=n;for(;void 0!==r[s];)s=n+"_"+i++;i>1&&(e.name=s),r[s]=e}getCodeFromNode(e,t,r=this.shaderStage){const n=this.getDataFromNode(e);let i=n.code;if(void 0===i){const e=this.codes[r]||(this.codes[r]=[]),s=e.length;i=new xv("nodeCode"+s,t),e.push(i),n.code=i}return i}addFlowCodeHierarchy(e,t){const{flowCodes:r,flowCodeBlock:n}=this.getDataFromNode(e);let i=!0,s=t;for(;s;){if(!0===n.get(s)){i=!1;break}s=this.getDataFromNode(s).parentNodeBlock}if(i)for(const o of r)this.addLineFlowCode(o)}addLineFlowCodeBlock(e,t,r){const n=this.getDataFromNode(e),i=n.flowCodes||(n.flowCodes=[]),s=n.flowCodeBlock||(n.flowCodeBlock=new WeakMap);i.push(t),s.set(r,!0)}addLineFlowCode(e,t=null){return""===e||(null!==t&&this.context.nodeBlock&&this.addLineFlowCodeBlock(t,e,this.context.nodeBlock),e=this.tab+e,/;\s*$/.test(e)||(e+=";\n"),this.flow.code+=e),this}addFlowCode(e){return this.flow.code+=e,this}addFlowTab(){return this.tab+="\t",this}removeFlowTab(){return this.tab=this.tab.slice(0,-1),this}getFlowData(e){return this.flowsData.get(e)}flowNode(e){const t=e.getNodeType(this),r=this.flowChildNode(e,t);return this.flowsData.set(e,r),r}addInclude(e){null!==this.currentFunctionNode&&this.currentFunctionNode.includes.push(e)}buildFunctionNode(e){const t=new __,r=this.currentFunctionNode;return this.currentFunctionNode=t,t.code=this.buildFunctionCode(e),this.currentFunctionNode=r,t}flowShaderNode(e){const t=e.layout,r={[Symbol.iterator](){let e=0;const t=Object.values(this);return{next:()=>({value:t[e],done:e++>=t.length})}}};for(const s of t.inputs)r[s.name]=new jb(s.type,s.name);e.layout=null;const n=e.call(r),i=this.flowStagesNode(n,t.type);return e.layout=t,i}flowStagesNode(e,t=null){const r=this.flow,n=this.vars,i=this.declarations,s=this.cache,o=this.buildStage,a=this.stack,u={code:""};this.flow=u,this.vars={},this.declarations={},this.cache=new wv,this.stack=zb();for(const l of Ga)this.setBuildStage(l),u.result=e.build(this,t);return u.vars=this.getVars(this.shaderStage),this.flow=r,this.vars=n,this.declarations=i,this.cache=s,this.stack=a,this.setBuildStage(o),u}getFunctionOperator(){return null}buildFunctionCode(){}flowChildNode(e,t=null){const r=this.flow,n={code:""};return this.flow=n,n.result=e.build(this,t),this.flow=r,n}flowNodeFromShaderStage(e,t,r=null,n=null){const i=this.tab,s=this.cache,o=this.shaderStage,a=this.context;this.setShaderStage(e);const u={...this.context};delete u.nodeBlock,this.cache=this.globalCache,this.tab="\t",this.context=u;let l=null;if("generate"===this.buildStage){const i=this.flowChildNode(t,r);null!==n&&(i.code+=`${this.tab+n} = ${i.result};\n`),this.flowCode[e]=this.flowCode[e]+i.code,l=i}else l=t.build(this);return this.setShaderStage(o),this.cache=s,this.tab=i,this.context=a,l}getAttributesArray(){return this.attributes.concat(this.bufferAttributes)}getAttributes(){}getVaryings(){}getVar(e,t,r=null){return`${null!==r?this.generateArrayDeclaration(e,r):this.getType(e)} ${t}`}getVars(e){let t="";const r=this.vars[e];if(void 0!==r)for(const n of r)t+=`${this.getVar(n.type,n.name)}; `;return t}getUniforms(){}getCodes(e){const t=this.codes[e];let r="";if(void 0!==t)for(const n of t)r+=n.code+"\n";return r}getHash(){return this.vertexShader+this.fragmentShader+this.computeShader}setShaderStage(e){this.shaderStage=e}getShaderStage(){return this.shaderStage}setBuildStage(e){this.buildStage=e}getBuildStage(){return this.buildStage}buildCode(){}build(){const{object:e,material:t,renderer:r}=this;if(null!==t){let e=r.library.fromMaterial(t);null===e&&(e=new _g),e.build(this)}else this.addFlow("compute",e);for(const n of Ga){this.setBuildStage(n),this.context.vertex&&this.context.vertex.isNode&&this.flowNodeFromShaderStage("vertex",this.context.vertex);for(const e of za){this.setShaderStage(e);const t=this.flowNodes[e];for(const e of t)"generate"===n?this.flowNode(e):e.build(this)}}return this.setBuildStage(null),this.setShaderStage(null),this.buildCode(),this.buildUpdateNodes(),this}getNodeUniform(e,t){if("float"===t||"int"===t||"uint"===t)return new Ov(e);if("vec2"===t||"ivec2"===t||"uvec2"===t)return new Lv(e);if("vec3"===t||"ivec3"===t||"uvec3"===t)return new Bv(e);if("vec4"===t||"ivec4"===t||"uvec4"===t)return new kv(e);if("color"===t)return new Iv(e);if("mat2"===t)return new Uv(e);if("mat3"===t)return new Vv(e);if("mat4"===t)return new jv(e);throw new Error(`Uniform "${t}" not declared.`)}format(e,t,r){if((t=this.getVectorType(t))===(r=this.getVectorType(r))||null===r||this.isReference(r))return e;const n=this.getTypeLength(t),i=this.getTypeLength(r);return 16===n&&9===i?`${this.getType(r)}( ${e}[ 0 ].xyz, ${e}[ 1 ].xyz, ${e}[ 2 ].xyz )`:9===n&&4===i?`${this.getType(r)}( ${e}[ 0 ].xy, ${e}[ 1 ].xy )`:n>4||i>4||0===i?e:n===i?`${this.getType(r)}( ${e} )`:n>i?(e="bool"===r?`all( ${e} )`:`${e}.${"xyz".slice(0,i)}`,this.format(e,this.getTypeFromLength(i,this.getComponentType(t)),r)):4===i&&n>1?`${this.getType(r)}( ${this.format(e,t,"vec3")}, 1.0 )`:2===n?`${this.getType(r)}( ${this.format(e,t,"vec2")}, 0.0 )`:(1===n&&i>1&&t!==this.getComponentType(r)&&(e=`${this.getType(this.getComponentType(r))}( ${e} )`),`${this.getType(r)}( ${e} )`)}getSignature(){return`// Three.js r${Ae} - Node System\n`}*[Symbol.iterator](){}createNodeMaterial(e="NodeMaterial"){throw new Error(`THREE.NodeBuilder: createNodeMaterial() was deprecated. Use new ${e}() instead.`)}}class Wv{constructor(){this.time=0,this.deltaTime=0,this.frameId=0,this.renderId=0,this.updateMap=new WeakMap,this.updateBeforeMap=new WeakMap,this.updateAfterMap=new WeakMap,this.renderer=null,this.material=null,this.camera=null,this.object=null,this.scene=null}_getMaps(e,t){let r=e.get(t);return void 0===r&&(r={renderMap:new WeakMap,frameMap:new WeakMap},e.set(t,r)),r}updateBeforeNode(e){const t=e.getUpdateBeforeType(),r=e.updateReference(this);if(t===Ba){const{frameMap:t}=this._getMaps(this.updateBeforeMap,r);t.get(r)!==this.frameId&&!1!==e.updateBefore(this)&&t.set(r,this.frameId)}else if(t===ka){const{renderMap:t}=this._getMaps(this.updateBeforeMap,r);t.get(r)!==this.renderId&&!1!==e.updateBefore(this)&&t.set(r,this.renderId)}else t===Ia&&e.updateBefore(this)}updateAfterNode(e){const t=e.getUpdateAfterType(),r=e.updateReference(this);if(t===Ba){const{frameMap:t}=this._getMaps(this.updateAfterMap,r);t.get(r)!==this.frameId&&!1!==e.updateAfter(this)&&t.set(r,this.frameId)}else if(t===ka){const{renderMap:t}=this._getMaps(this.updateAfterMap,r);t.get(r)!==this.renderId&&!1!==e.updateAfter(this)&&t.set(r,this.renderId)}else t===Ia&&e.updateAfter(this)}updateNode(e){const t=e.getUpdateType(),r=e.updateReference(this);if(t===Ba){const{frameMap:t}=this._getMaps(this.updateMap,r);t.get(r)!==this.frameId&&!1!==e.update(this)&&t.set(r,this.frameId)}else if(t===ka){const{renderMap:t}=this._getMaps(this.updateMap,r);t.get(r)!==this.renderId&&!1!==e.update(this)&&t.set(r,this.renderId)}else t===Ia&&e.update(this)}update(){this.frameId++,void 0===this.lastTime&&(this.lastTime=performance.now()),this.deltaTime=(performance.now()-this.lastTime)/1e3,this.lastTime=performance.now(),this.time+=this.deltaTime}}class qv{constructor(e,t,r=null,n="",i=!1){this.type=e,this.name=t,this.count=r,this.qualifier=n,this.isConst=i}}qv.isNodeFunctionInput=!0;class Xv extends uv{static get type(){return"DirectionalLightNode"}constructor(e=null){super(e)}setupDirect(){const e=this.colorNode;return{lightDirection:R_(this.light),lightColor:e}}}const Kv=new a,Yv=new a;let Qv=null;class Zv extends uv{static get type(){return"RectAreaLightNode"}constructor(e=null){super(e),this.halfHeight=Xl(new o).setGroup(Hl),this.halfWidth=Xl(new o).setGroup(Hl),this.updateType=ka}update(e){super.update(e);const{light:t}=this,r=e.camera.matrixWorldInverse;Yv.identity(),Kv.copy(t.matrixWorld),Kv.premultiply(r),Yv.extractRotation(Kv),this.halfWidth.value.set(.5*t.width,0,0),this.halfHeight.value.set(0,.5*t.height,0),this.halfWidth.value.applyMatrix4(Yv),this.halfHeight.value.applyMatrix4(Yv)}setupDirectRectArea(e){let t,r;e.isAvailable("float32Filterable")?(t=yd(Qv.LTC_FLOAT_1),r=yd(Qv.LTC_FLOAT_2)):(t=yd(Qv.LTC_HALF_1),r=yd(Qv.LTC_HALF_2));const{colorNode:n,light:i}=this;return{lightColor:n,lightPosition:M_(i),halfWidth:this.halfWidth,halfHeight:this.halfHeight,ltc_1:t,ltc_2:r}}static setLTC(e){Qv=e}}class Jv extends uv{static get type(){return"SpotLightNode"}constructor(e=null){super(e),this.coneCosNode=Xl(0).setGroup(Hl),this.penumbraCosNode=Xl(0).setGroup(Hl),this.cutoffDistanceNode=Xl(0).setGroup(Hl),this.decayExponentNode=Xl(0).setGroup(Hl),this.colorNode=Xl(this.color).setGroup(Hl)}update(e){super.update(e);const{light:t}=this;this.coneCosNode.value=Math.cos(t.angle),this.penumbraCosNode.value=Math.cos(t.angle*(1-t.penumbra)),this.cutoffDistanceNode.value=t.distance,this.decayExponentNode.value=t.decay}getSpotAttenuation(e,t){const{coneCosNode:r,penumbraCosNode:n}=this;return Sh(r,n,t)}getLightCoord(e){const t=e.getNodeProperties(this);let r=t.projectionUV;return void 0===r&&(r=function(e,t=$d){const r=C_(e).mul(t);return r.xyz.div(r.w)}(this.light,e.context.positionWorld),t.projectionUV=r),r}setupDirect(e){const{colorNode:t,cutoffDistanceNode:r,decayExponentNode:n,light:i}=this,s=this.getLightVector(e),o=s.normalize(),a=o.dot(R_(i)),u=this.getSpotAttenuation(e,a),l=s.length(),c=lv({lightDistance:l,cutoffDistance:r,decayExponent:n});let h,d,p=t.mul(u).mul(c);if(i.colorNode?(d=this.getLightCoord(e),h=i.colorNode(d)):i.map&&(d=this.getLightCoord(e),h=yd(i.map,d.xy).onRenderUpdate((()=>i.map))),h){p=d.mul(2).sub(1).abs().lessThan(1).all().select(p.mul(h),p)}return{lightColor:p,lightDirection:o}}}class ex extends Jv{static get type(){return"IESSpotLightNode"}getSpotAttenuation(e,t){const r=this.light.iesMap;let n=null;if(r&&!0===r.isTexture){const e=t.acos().mul(1/Math.PI);n=yd(r,Yu(e,0),0).r}else n=super.getSpotAttenuation(t);return n}}const tx=Vu((([e,t])=>{const r=e.abs().sub(t);return Yc(ah(r,0)).add(oh(ah(r.x,r.y),0))}));class rx extends Jv{static get type(){return"ProjectorLightNode"}update(e){super.update(e);const t=this.light;if(this.penumbraCosNode.value=Math.min(Math.cos(t.angle*(1-t.penumbra)),.99999),null===t.aspect){let e=1;null!==t.map&&(e=t.map.width/t.map.height),t.shadow.aspect=e}else t.shadow.aspect=t.aspect}getSpotAttenuation(e){const t=this.penumbraCosNode,r=this.getLightCoord(e),n=r.xyz.div(r.w),i=tx(n.xy.sub(Yu(.5)),Yu(.5)),s=nc(-1,tc(1,Wc(t)).sub(1));return Th(i.mul(-2).mul(s))}}class nx extends uv{static get type(){return"AmbientLightNode"}constructor(e=null){super(e)}setup({context:e}){e.irradiance.addAssign(this.colorNode)}}class ix extends uv{static get type(){return"HemisphereLightNode"}constructor(e=null){super(e),this.lightPositionNode=A_(e),this.lightDirectionNode=this.lightPositionNode.normalize(),this.groundColorNode=Xl(new h).setGroup(Hl)}update(e){const{light:t}=this;super.update(e),this.lightPositionNode.object3d=t,this.groundColorNode.value.copy(t.groundColor).multiplyScalar(t.intensity)}setup(e){const{colorNode:t,groundColorNode:r,lightDirectionNode:n}=this,i=ep.dot(n).mul(.5).add(.5),s=vh(r,t,i);e.context.irradiance.addAssign(s)}}class sx extends uv{static get type(){return"LightProbeNode"}constructor(e=null){super(e);const t=[];for(let r=0;r<9;r++)t.push(new o);this.lightProbe=wd(t)}update(e){const{light:t}=this;super.update(e);for(let r=0;r<9;r++)this.lightProbe.array[r].copy(t.sh.coefficients[r]).multiplyScalar(t.intensity)}setup(e){const t=hv(ep,this.lightProbe);e.context.irradiance.addAssign(t)}}class ox{parseFunction(){}}class ax{constructor(e,t,r="",n=""){this.type=e,this.inputs=t,this.name=r,this.precision=n}getCode(){}}ax.isNodeFunction=!0;const ux=/^\s*(highp|mediump|lowp)?\s*([a-z_0-9]+)\s*([a-z_0-9]+)?\s*\(([\s\S]*?)\)/i,lx=/[a-z_0-9]+/gi,cx="#pragma main";class hx extends ax{constructor(e){const{type:t,inputs:r,name:n,precision:i,inputsCode:s,blockCode:o,headerCode:a}=(e=>{const t=(e=e.trim()).indexOf(cx),r=-1!==t?e.slice(t+12):e,n=r.match(ux);if(null!==n&&5===n.length){const i=n[4],s=[];let o=null;for(;null!==(o=lx.exec(i));)s.push(o);const a=[];let u=0;for(;u<s.length;){const e="const"===s[u][0];!0===e&&u++;let t=s[u][0];"in"===t||"out"===t||"inout"===t?u++:t="";const r=s[u++][0];let n=Number.parseInt(s[u][0]);!1===Number.isNaN(n)?u++:n=null;const i=s[u++][0];a.push(new qv(r,i,n,t,e))}const l=r.substring(n[0].length),c=void 0!==n[3]?n[3]:"";return{type:n[2],inputs:a,name:c,precision:void 0!==n[1]?n[1]:"",inputsCode:i,blockCode:l,headerCode:-1!==t?e.slice(0,t):""}}throw new Error("FunctionNode: Function is not a GLSL code.")})(e);super(t,r,n,i),this.inputsCode=s,this.blockCode=o,this.headerCode=a}getCode(e=this.name){let t;const r=this.blockCode;if(""!==r){const{type:n,inputsCode:i,headerCode:s,precision:o}=this;let a=`${n} ${e} ( ${i.trim()} )`;""!==o&&(a=`${o} ${a}`),t=s+a+r}else t="";return t}}class dx extends ox{parseFunction(e){return new hx(e)}}const px=new WeakMap,fx=[],gx=[];class mx extends ab{constructor(e,t){super(),this.renderer=e,this.backend=t,this.nodeFrame=new Wv,this.nodeBuilderCache=new Map,this.callHashCache=new rb,this.groupsData=new rb,this.cacheLib={}}updateGroup(e){const t=e.groupNode,r=t.name;if(r===Wl.name)return!0;if(r===Hl.name){const t=this.get(e),r=this.nodeFrame.renderId;return t.renderId!==r&&(t.renderId=r,!0)}if(r===$l.name){const t=this.get(e),r=this.nodeFrame.frameId;return t.frameId!==r&&(t.frameId=r,!0)}fx[0]=t,fx[1]=e;let n=this.groupsData.get(fx);return void 0===n&&this.groupsData.set(fx,n={}),fx.length=0,n.version!==t.version&&(n.version=t.version,!0)}getForRenderCacheKey(e){return e.initialCacheKey}getForRender(e){const t=this.get(e);let r=t.nodeBuilderState;if(void 0===r){const{nodeBuilderCache:n}=this,i=this.getForRenderCacheKey(e);if(r=n.get(i),void 0===r){const t=this.backend.createNodeBuilder(e.object,this.renderer);t.scene=e.scene,t.material=e.material,t.camera=e.camera,t.context.material=e.material,t.lightsNode=e.lightsNode,t.environmentNode=this.getEnvironmentNode(e.scene),t.fogNode=this.getFogNode(e.scene),t.clippingContext=e.clippingContext,this.renderer.getOutputRenderTarget()&&this.renderer.getOutputRenderTarget().multiview&&t.enableMultiview(),t.build(),r=this._createNodeBuilderState(t),n.set(i,r)}r.usedTimes++,t.nodeBuilderState=r}return r}delete(e){if(e.isRenderObject){const t=this.get(e).nodeBuilderState;t.usedTimes--,0===t.usedTimes&&this.nodeBuilderCache.delete(this.getForRenderCacheKey(e))}return super.delete(e)}getForCompute(e){const t=this.get(e);let r=t.nodeBuilderState;if(void 0===r){const n=this.backend.createNodeBuilder(e,this.renderer);n.build(),r=this._createNodeBuilderState(n),t.nodeBuilderState=r}return r}_createNodeBuilderState(e){return new mv(e.vertexShader,e.fragmentShader,e.computeShader,e.getAttributesArray(),e.getBindings(),e.updateNodes,e.updateBeforeNodes,e.updateAfterNodes,e.observer,e.transforms)}getEnvironmentNode(e){this.updateEnvironment(e);let t=null;if(e.environmentNode&&e.environmentNode.isNode)t=e.environmentNode;else{const r=this.get(e);r.environmentNode&&(t=r.environmentNode)}return t}getBackgroundNode(e){this.updateBackground(e);let t=null;if(e.backgroundNode&&e.backgroundNode.isNode)t=e.backgroundNode;else{const r=this.get(e);r.backgroundNode&&(t=r.backgroundNode)}return t}getFogNode(e){return this.updateFog(e),e.fogNode||this.get(e).fogNode||null}getCacheKey(e,t){fx[0]=e,fx[1]=t;const r=this.renderer.info.calls,n=this.callHashCache.get(fx)||{};if(n.callId!==r){const i=this.getEnvironmentNode(e),s=this.getFogNode(e);t&&gx.push(t.getCacheKey(!0)),i&&gx.push(i.getCacheKey()),s&&gx.push(s.getCacheKey()),gx.push(this.renderer.getOutputRenderTarget()&&this.renderer.getOutputRenderTarget().multiview?1:0),gx.push(this.renderer.shadowMap.enabled?1:0),n.callId=r,n.cacheKey=Na(gx),this.callHashCache.set(fx,n),gx.length=0}return fx.length=0,n.cacheKey}get isToneMappingState(){return!this.renderer.getRenderTarget()}updateBackground(e){const t=this.get(e),r=e.background;if(r){const n=0===e.backgroundBlurriness&&t.backgroundBlurriness>0||e.backgroundBlurriness>0&&0===t.backgroundBlurriness;if(t.background!==r||n){const i=this.getCacheNode("background",r,(()=>{if(!0===r.isCubeTexture||r.mapping===ye||r.mapping===be||r.mapping===_e){if(e.backgroundBlurriness>0||r.mapping===_e)return My(r);{let e;return e=!0===r.isCubeTexture?bp(r):yd(r),Fg(e)}}if(!0===r.isTexture)return yd(r,Qf.flipY()).setUpdateMatrix(!0);r.isColor}),n);t.backgroundNode=i,t.background=r,t.backgroundBlurriness=e.backgroundBlurriness}}else t.backgroundNode&&(delete t.backgroundNode,delete t.background)}getCacheNode(e,t,r,n=!1){const i=this.cacheLib[e]||(this.cacheLib[e]=new WeakMap);let s=i.get(t);return(void 0===s||n)&&(s=r(),i.set(t,s)),s}updateFog(e){const t=this.get(e),r=e.fog;if(r){if(t.fog!==r){const e=this.getCacheNode("fog",r,(()=>{if(r.isFogExp2){const e=xp("color","color",r).setGroup(Hl),t=xp("density","float",r).setGroup(Hl);return w_(e,T_(t))}if(r.isFog){const e=xp("color","color",r).setGroup(Hl),t=xp("near","float",r).setGroup(Hl),n=xp("far","float",r).setGroup(Hl);return w_(e,x_(t,n))}}));t.fogNode=e,t.fog=r}}else delete t.fogNode,delete t.fog}updateEnvironment(e){const t=this.get(e),r=e.environment;if(r){if(t.environment!==r){const e=this.getCacheNode("environment",r,(()=>!0===r.isCubeTexture?bp(r):!0===r.isTexture?yd(r):void 0));t.environmentNode=e,t.environment=r}}else t.environmentNode&&(delete t.environmentNode,delete t.environment)}getNodeFrame(e=this.renderer,t=null,r=null,n=null,i=null){const s=this.nodeFrame;return s.renderer=e,s.scene=t,s.object=r,s.camera=n,s.material=i,s}getNodeFrameForRender(e){return this.getNodeFrame(e.renderer,e.scene,e.object,e.camera,e.material)}getOutputCacheKey(){const e=this.renderer;return e.toneMapping+","+e.currentColorSpace+","+e.xr.isPresenting}hasOutputChange(e){return px.get(e)!==this.getOutputCacheKey()}getOutputNode(e){const t=this.renderer,r=this.getOutputCacheKey(),n=e.isArrayTexture?n_(e,el(Qf,Sd("gl_ViewID_OVR"))).renderOutput(t.toneMapping,t.currentColorSpace):yd(e,Qf).renderOutput(t.toneMapping,t.currentColorSpace);return px.set(e,r),n}updateBefore(e){const t=e.getNodeBuilderState();for(const r of t.updateBeforeNodes)this.getNodeFrameForRender(e).updateBeforeNode(r)}updateAfter(e){const t=e.getNodeBuilderState();for(const r of t.updateAfterNodes)this.getNodeFrameForRender(e).updateAfterNode(r)}updateForCompute(e){const t=this.getNodeFrame(),r=this.getForCompute(e);for(const n of r.updateNodes)t.updateNode(n)}updateForRender(e){const t=this.getNodeFrameForRender(e),r=e.getNodeBuilderState();for(const n of r.updateNodes)t.updateNode(n)}needsRefresh(e){const t=this.getNodeFrameForRender(e);return e.getMonitor().needsRefresh(e,t)}dispose(){super.dispose(),this.nodeFrame=new Wv,this.nodeBuilderCache=new Map,this.cacheLib={}}}const yx=new s;class bx{constructor(e=null){this.version=0,this.clipIntersection=null,this.cacheKey="",this.shadowPass=!1,this.viewNormalMatrix=new Se,this.clippingGroupContexts=new WeakMap,this.intersectionPlanes=[],this.unionPlanes=[],this.parentVersion=null,null!==e&&(this.viewNormalMatrix=e.viewNormalMatrix,this.clippingGroupContexts=e.clippingGroupContexts,this.shadowPass=e.shadowPass,this.viewMatrix=e.viewMatrix)}projectPlanes(e,t,r){const n=e.length;for(let i=0;i<n;i++){yx.copy(e[i]).applyMatrix4(this.viewMatrix,this.viewNormalMatrix);const n=t[r+i],s=yx.normal;n.x=-s.x,n.y=-s.y,n.z=-s.z,n.w=yx.constant}}updateGlobal(e,t){this.shadowPass=null!==e.overrideMaterial&&e.overrideMaterial.isShadowPassMaterial,this.viewMatrix=t.matrixWorldInverse,this.viewNormalMatrix.getNormalMatrix(this.viewMatrix)}update(e,t){let r=!1;e.version!==this.parentVersion&&(this.intersectionPlanes=Array.from(e.intersectionPlanes),this.unionPlanes=Array.from(e.unionPlanes),this.parentVersion=e.version),this.clipIntersection!==t.clipIntersection&&(this.clipIntersection=t.clipIntersection,this.clipIntersection?this.unionPlanes.length=e.unionPlanes.length:this.intersectionPlanes.length=e.intersectionPlanes.length);const n=t.clippingPlanes,i=n.length;let s,o;if(this.clipIntersection?(s=this.intersectionPlanes,o=e.intersectionPlanes.length):(s=this.unionPlanes,o=e.unionPlanes.length),s.length!==o+i){s.length=o+i;for(let e=0;e<i;e++)s[o+e]=new E;r=!0}this.projectPlanes(n,s,o),r&&(this.version++,this.cacheKey=`${this.intersectionPlanes.length}:${this.unionPlanes.length}`)}getGroupContext(e){if(this.shadowPass&&!e.clipShadows)return this;let t=this.clippingGroupContexts.get(e);return void 0===t&&(t=new bx(this),this.clippingGroupContexts.set(e,t)),t.update(this,e),t}get unionClippingCount(){return this.unionPlanes.length}}class _x{constructor(e,t){this.bundleGroup=e,this.camera=t}}const vx=[];class xx{constructor(){this.bundles=new rb}get(e,t){const r=this.bundles;vx[0]=e,vx[1]=t;let n=r.get(vx);return void 0===n&&(n=new _x(e,t),r.set(vx,n)),vx.length=0,n}dispose(){this.bundles=new rb}}class Tx{constructor(){this.lightNodes=new WeakMap,this.materialNodes=new Map,this.toneMappingNodes=new Map}fromMaterial(e){if(e.isNodeMaterial)return e;let t=null;const r=this.getMaterialNodeClass(e.type);if(null!==r){t=new r;for(const r in e)t[r]=e[r]}return t}addToneMapping(e,t){this.addType(e,t,this.toneMappingNodes)}getToneMappingFunction(e){return this.toneMappingNodes.get(e)||null}getMaterialNodeClass(e){return this.materialNodes.get(e)||null}addMaterial(e,t){this.addType(e,t,this.materialNodes)}getLightNodeClass(e){return this.lightNodes.get(e)||null}addLight(e,t){this.addClass(e,t,this.lightNodes)}addType(e,t,r){if(!r.has(t)){if("function"!=typeof e)throw new Error(`Node class ${e.name} is not a class.`);if("function"==typeof t||"object"==typeof t)throw new Error(`Base class ${t} is not a class.`);r.set(t,e)}}addClass(e,t,r){if(!r.has(t)){if("function"!=typeof e)throw new Error(`Node class ${e.name} is not a class.`);if("function"!=typeof t)throw new Error(`Base class ${t.name} is not a class.`);r.set(t,e)}}}const wx=new O_,Sx=[];class Nx extends rb{constructor(){super()}createNode(e=[]){return(new O_).setLights(e)}getNode(e,t){if(e.isQuadMesh)return wx;Sx[0]=e,Sx[1]=t;let r=this.get(Sx);return void 0===r&&(r=this.createNode(),this.set(Sx,r)),Sx.length=0,r}}class Ex extends M{constructor(e=1,t=1,r={}){super(e,t,r),this.isXRRenderTarget=!0,this.hasExternalTextures=!1,this.autoAllocateDepthBuffer=!0}copy(e){return super.copy(e),this.hasExternalTextures=e.hasExternalTextures,this.autoAllocateDepthBuffer=e.autoAllocateDepthBuffer,this}}const Cx=new o,Ax=new o;class Mx extends te{constructor(e,t=!1){super(),this.enabled=!1,this.isPresenting=!1,this.cameraAutoUpdate=!0,this._renderer=e,this._cameraL=new re,this._cameraL.viewport=new E,this._cameraR=new re,this._cameraR.viewport=new E,this._cameras=[this._cameraL,this._cameraR],this._cameraXR=new ne,this._currentDepthNear=null,this._currentDepthFar=null,this._controllers=[],this._controllerInputSources=[],this._xrRenderTarget=null,this._layers=[],this._supportsLayers=!1,this._frameBufferTargets=null,this._createXRLayer=Ox.bind(this),this._gl=null,this._currentAnimationContext=null,this._currentAnimationLoop=null,this._currentPixelRatio=null,this._currentSize=new i,this._onSessionEvent=Px.bind(this),this._onSessionEnd=Dx.bind(this),this._onInputSourcesChange=Fx.bind(this),this._onAnimationFrame=Lx.bind(this),this._referenceSpace=null,this._referenceSpaceType="local-floor",this._customReferenceSpace=null,this._framebufferScaleFactor=1,this._foveation=1,this._session=null,this._glBaseLayer=null,this._glBinding=null,this._glProjLayer=null,this._xrFrame=null,this._useLayers="undefined"!=typeof XRWebGLBinding&&"createProjectionLayer"in XRWebGLBinding.prototype,this._useMultiviewIfPossible=t,this._useMultiview=!1}getController(e){return this._getController(e).getTargetRaySpace()}getControllerGrip(e){return this._getController(e).getGripSpace()}getHand(e){return this._getController(e).getHandSpace()}getFoveation(){if(null!==this._glProjLayer||null!==this._glBaseLayer)return this._foveation}setFoveation(e){this._foveation=e,null!==this._glProjLayer&&(this._glProjLayer.fixedFoveation=e),null!==this._glBaseLayer&&void 0!==this._glBaseLayer.fixedFoveation&&(this._glBaseLayer.fixedFoveation=e)}getFramebufferScaleFactor(){return this._framebufferScaleFactor}setFramebufferScaleFactor(e){this._framebufferScaleFactor=e,this.isPresenting}getReferenceSpaceType(){return this._referenceSpaceType}setReferenceSpaceType(e){this._referenceSpaceType=e,this.isPresenting}getReferenceSpace(){return this._customReferenceSpace||this._referenceSpace}setReferenceSpace(e){this._customReferenceSpace=e}getCamera(){return this._cameraXR}getEnvironmentBlendMode(){if(null!==this._session)return this._session.environmentBlendMode}getFrame(){return this._xrFrame}useMultiview(){return this._useMultiview}createQuadLayer(e,t,r,n,i,s,o,a={}){const u=new ie(e,t),c=new Ex(i,s,{format:D,type:oe,depthTexture:new se(i,s,a.stencil?ae:ue,void 0,void 0,void 0,void 0,void 0,void 0,a.stencil?le:ce),stencilBuffer:a.stencil,resolveDepthBuffer:!1,resolveStencilBuffer:!1});c.autoAllocateDepthBuffer=!0;const h=new he({color:16777215,side:B});h.map=c.texture,h.map.offset.y=1,h.map.repeat.y=-1;const d=new l(u,h);d.position.copy(r),d.quaternion.copy(n);const p={type:"quad",width:e,height:t,translation:r,quaternion:n,pixelwidth:i,pixelheight:s,plane:d,material:h,rendercall:o,renderTarget:c};if(this._layers.push(p),null!==this._session){p.plane.material=new he({color:16777215,side:B}),p.plane.material.blending=de,p.plane.material.blendEquation=pe,p.plane.material.blendSrc=fe,p.plane.material.blendDst=fe,p.xrlayer=this._createXRLayer(p);const e=this._session.renderState.layers;e.unshift(p.xrlayer),this._session.updateRenderState({layers:e})}else c.isXRRenderTarget=!1;return d}createCylinderLayer(e,t,r,n,i,s,o,a,u={}){const c=new m(e,e,e*t/r,64,64,!0,Math.PI-t/2,t),h=new Ex(s,o,{format:D,type:oe,depthTexture:new se(s,o,u.stencil?ae:ue,void 0,void 0,void 0,void 0,void 0,void 0,u.stencil?le:ce),stencilBuffer:u.stencil,resolveDepthBuffer:!1,resolveStencilBuffer:!1});h.autoAllocateDepthBuffer=!0;const d=new he({color:16777215,side:L});d.map=h.texture,d.map.offset.y=1,d.map.repeat.y=-1;const p=new l(c,d);p.position.copy(n),p.quaternion.copy(i);const f={type:"cylinder",radius:e,centralAngle:t,aspectratio:r,translation:n,quaternion:i,pixelwidth:s,pixelheight:o,plane:p,material:d,rendercall:a,renderTarget:h};if(this._layers.push(f),null!==this._session){f.plane.material=new he({color:16777215,side:L}),f.plane.material.blending=de,f.plane.material.blendEquation=pe,f.plane.material.blendSrc=fe,f.plane.material.blendDst=fe,f.xrlayer=this._createXRLayer(f);const e=this._session.renderState.layers;e.unshift(f.xrlayer),this._session.updateRenderState({layers:e})}else h.isXRRenderTarget=!1;return p}renderLayers(){const e=new o,t=new ge,r=this._renderer,n=this.isPresenting,s=r.getOutputRenderTarget(),a=r._frameBufferTarget;this.isPresenting=!1;const u=new i;r.getSize(u);const l=r._quad;for(const i of this._layers)if(i.renderTarget.isXRRenderTarget=null!==this._session,i.renderTarget.hasExternalTextures=i.renderTarget.isXRRenderTarget,i.renderTarget.isXRRenderTarget&&this._supportsLayers){i.xrlayer.transform=new XRRigidTransform(i.plane.getWorldPosition(e),i.plane.getWorldQuaternion(t));const n=this._glBinding.getSubImage(i.xrlayer,this._xrFrame);r.backend.setXRRenderTargetTextures(i.renderTarget,n.colorTexture,void 0),r._setXRLayerSize(i.renderTarget.width,i.renderTarget.height),r.setOutputRenderTarget(i.renderTarget),r.setRenderTarget(null),r._frameBufferTarget=null,this._frameBufferTargets||(this._frameBufferTargets=new WeakMap);const{frameBufferTarget:s,quad:o}=this._frameBufferTargets.get(i.renderTarget)||{frameBufferTarget:null,quad:null};s?(r._frameBufferTarget=s,r._quad=o):(r._quad=new Xb(new _g),this._frameBufferTargets.set(i.renderTarget,{frameBufferTarget:r._getFrameBufferTarget(),quad:r._quad})),i.rendercall(),r._frameBufferTarget=null}else r.setRenderTarget(i.renderTarget),i.rendercall();r.setRenderTarget(null),r.setOutputRenderTarget(s),r._frameBufferTarget=a,r._setXRLayerSize(u.x,u.y),r._quad=l,this.isPresenting=n}getSession(){return this._session}async setSession(e){const t=this._renderer,r=t.backend;this._gl=t.getContext();const n=this._gl,i=n.getContextAttributes();if(this._session=e,null!==e){if(!0===r.isWebGPUBackend)throw new Error('THREE.XRManager: XR is currently not supported with a WebGPU backend. Use WebGL by passing "{ forceWebGL: true }" to the constructor of the renderer.');if(e.addEventListener("select",this._onSessionEvent),e.addEventListener("selectstart",this._onSessionEvent),e.addEventListener("selectend",this._onSessionEvent),e.addEventListener("squeeze",this._onSessionEvent),e.addEventListener("squeezestart",this._onSessionEvent),e.addEventListener("squeezeend",this._onSessionEvent),e.addEventListener("end",this._onSessionEnd),e.addEventListener("inputsourceschange",this._onInputSourcesChange),await r.makeXRCompatible(),this._currentPixelRatio=t.getPixelRatio(),t.getSize(this._currentSize),this._currentAnimationContext=t._animation.getContext(),this._currentAnimationLoop=t._animation.getAnimationLoop(),t._animation.stop(),!0===this._useLayers){let r=null,s=null,o=null;t.depth&&(o=t.stencil?n.DEPTH24_STENCIL8:n.DEPTH_COMPONENT24,r=t.stencil?le:ce,s=t.stencil?ae:ue);const a={colorFormat:n.RGBA8,depthFormat:o,scaleFactor:this._framebufferScaleFactor,clearOnAccess:!1};this._useMultiviewIfPossible&&t.hasFeature("OVR_multiview2")&&(a.textureType="texture-array",this._useMultiview=!0);const u=new XRWebGLBinding(e,n),l=u.createProjectionLayer(a),c=[l];this._glBinding=u,this._glProjLayer=l,t.setPixelRatio(1),t._setXRLayerSize(l.textureWidth,l.textureHeight);const h=this._useMultiview?2:1,d=new se(l.textureWidth,l.textureHeight,s,void 0,void 0,void 0,void 0,void 0,void 0,r,h);if(this._xrRenderTarget=new Ex(l.textureWidth,l.textureHeight,{format:D,type:oe,colorSpace:t.outputColorSpace,depthTexture:d,stencilBuffer:t.stencil,samples:i.antialias?4:0,resolveDepthBuffer:!1===l.ignoreDepthValues,resolveStencilBuffer:!1===l.ignoreDepthValues,depth:this._useMultiview?2:1,multiview:this._useMultiview}),this._xrRenderTarget.hasExternalTextures=!0,this._xrRenderTarget.depth=this._useMultiview?2:1,this._supportsLayers=e.enabledFeatures.includes("layers"),this._referenceSpace=await e.requestReferenceSpace(this.getReferenceSpaceType()),this._supportsLayers)for(const e of this._layers)e.plane.material=new he({color:16777215,side:"cylinder"===e.type?L:B}),e.plane.material.blending=de,e.plane.material.blendEquation=pe,e.plane.material.blendSrc=fe,e.plane.material.blendDst=fe,e.xrlayer=this._createXRLayer(e),c.unshift(e.xrlayer);e.updateRenderState({layers:c})}else{const r={antialias:t.samples>0,alpha:!0,depth:t.depth,stencil:t.stencil,framebufferScaleFactor:this.getFramebufferScaleFactor()},i=new XRWebGLLayer(e,n,r);this._glBaseLayer=i,e.updateRenderState({baseLayer:i}),t.setPixelRatio(1),t._setXRLayerSize(i.framebufferWidth,i.framebufferHeight),this._xrRenderTarget=new Ex(i.framebufferWidth,i.framebufferHeight,{format:D,type:oe,colorSpace:t.outputColorSpace,stencilBuffer:t.stencil,resolveDepthBuffer:!1===i.ignoreDepthValues,resolveStencilBuffer:!1===i.ignoreDepthValues}),this._referenceSpace=await e.requestReferenceSpace(this.getReferenceSpaceType())}this.setFoveation(this.getFoveation()),t._animation.setAnimationLoop(this._onAnimationFrame),t._animation.setContext(e),t._animation.start(),this.isPresenting=!0,this.dispatchEvent({type:"sessionstart"})}}updateCamera(e){const t=this._session;if(null===t)return;const r=e.near,n=e.far,i=this._cameraXR,s=this._cameraL,o=this._cameraR;i.near=o.near=s.near=r,i.far=o.far=s.far=n,i.isMultiViewCamera=this._useMultiview,this._currentDepthNear===i.near&&this._currentDepthFar===i.far||(t.updateRenderState({depthNear:i.near,depthFar:i.far}),this._currentDepthNear=i.near,this._currentDepthFar=i.far),s.layers.mask=2|e.layers.mask,o.layers.mask=4|e.layers.mask,i.layers.mask=s.layers.mask|o.layers.mask;const a=e.parent,u=i.cameras;Rx(i,a);for(let l=0;l<u.length;l++)Rx(u[l],a);2===u.length?function(e,t,r){Cx.setFromMatrixPosition(t.matrixWorld),Ax.setFromMatrixPosition(r.matrixWorld);const n=Cx.distanceTo(Ax),i=t.projectionMatrix.elements,s=r.projectionMatrix.elements,o=i[14]/(i[10]-1),a=i[14]/(i[10]+1),u=(i[9]+1)/i[5],l=(i[9]-1)/i[5],c=(i[8]-1)/i[0],h=(s[8]+1)/s[0],d=o*c,p=o*h,f=n/(-c+h),g=f*-c;if(t.matrixWorld.decompose(e.position,e.quaternion,e.scale),e.translateX(g),e.translateZ(f),e.matrixWorld.compose(e.position,e.quaternion,e.scale),e.matrixWorldInverse.copy(e.matrixWorld).invert(),-1===i[10])e.projectionMatrix.copy(t.projectionMatrix),e.projectionMatrixInverse.copy(t.projectionMatrixInverse);else{const t=o+f,r=a+f,i=d-g,s=p+(n-g),c=u*a/r*t,h=l*a/r*t;e.projectionMatrix.makePerspective(i,s,c,h,t,r),e.projectionMatrixInverse.copy(e.projectionMatrix).invert()}}(i,s,o):i.projectionMatrix.copy(s.projectionMatrix),function(e,t,r){null===r?e.matrix.copy(t.matrixWorld):(e.matrix.copy(r.matrixWorld),e.matrix.invert(),e.matrix.multiply(t.matrixWorld));e.matrix.decompose(e.position,e.quaternion,e.scale),e.updateMatrixWorld(!0),e.projectionMatrix.copy(t.projectionMatrix),e.projectionMatrixInverse.copy(t.projectionMatrixInverse),e.isPerspectiveCamera&&(e.fov=2*Nr*Math.atan(1/e.projectionMatrix.elements[5]),e.zoom=1)}(e,i,a)}_getController(e){let t=this._controllers[e];return void 0===t&&(t=new me,this._controllers[e]=t),t}}function Rx(e,t){null===t?e.matrixWorld.copy(e.matrix):e.matrixWorld.multiplyMatrices(t.matrixWorld,e.matrix),e.matrixWorldInverse.copy(e.matrixWorld).invert()}function Px(e){const t=this._controllerInputSources.indexOf(e.inputSource);if(-1===t)return;const r=this._controllers[t];if(void 0!==r){const t=this.getReferenceSpace();r.update(e.inputSource,e.frame,t),r.dispatchEvent({type:e.type,data:e.inputSource})}}function Dx(){const e=this._session,t=this._renderer;e.removeEventListener("select",this._onSessionEvent),e.removeEventListener("selectstart",this._onSessionEvent),e.removeEventListener("selectend",this._onSessionEvent),e.removeEventListener("squeeze",this._onSessionEvent),e.removeEventListener("squeezestart",this._onSessionEvent),e.removeEventListener("squeezeend",this._onSessionEvent),e.removeEventListener("end",this._onSessionEnd),e.removeEventListener("inputsourceschange",this._onInputSourcesChange);for(let r=0;r<this._controllers.length;r++){const e=this._controllerInputSources[r];null!==e&&(this._controllerInputSources[r]=null,this._controllers[r].disconnect(e))}if(this._currentDepthNear=null,this._currentDepthFar=null,t._resetXRState(),this._session=null,this._xrRenderTarget=null,!0===this._supportsLayers)for(const r of this._layers)r.renderTarget=new Ex(r.pixelwidth,r.pixelheight,{format:D,type:oe,depthTexture:new se(r.pixelwidth,r.pixelheight,r.stencilBuffer?ae:ue,void 0,void 0,void 0,void 0,void 0,void 0,r.stencilBuffer?le:ce),stencilBuffer:r.stencilBuffer,resolveDepthBuffer:!1,resolveStencilBuffer:!1}),r.renderTarget.isXRRenderTarget=!1,r.plane.material=r.material,r.material.map=r.renderTarget.texture,r.material.map.offset.y=1,r.material.map.repeat.y=-1,delete r.xrlayer;this.isPresenting=!1,this._useMultiview=!1,t._animation.stop(),t._animation.setAnimationLoop(this._currentAnimationLoop),t._animation.setContext(this._currentAnimationContext),t._animation.start(),t.setPixelRatio(this._currentPixelRatio),t.setSize(this._currentSize.width,this._currentSize.height,!1),this.dispatchEvent({type:"sessionend"})}function Fx(e){const t=this._controllers,r=this._controllerInputSources;for(let n=0;n<e.removed.length;n++){const i=e.removed[n],s=r.indexOf(i);s>=0&&(r[s]=null,t[s].disconnect(i))}for(let n=0;n<e.added.length;n++){const i=e.added[n];let s=r.indexOf(i);if(-1===s){for(let e=0;e<t.length;e++){if(e>=r.length){r.push(i),s=e;break}if(null===r[e]){r[e]=i,s=e;break}}if(-1===s)break}const o=t[s];o&&o.connect(i)}}function Ox(e){return"quad"===e.type?this._glBinding.createQuadLayer({transform:new XRRigidTransform(e.translation,e.quaternion),width:e.width/2,height:e.height/2,space:this._referenceSpace,viewPixelWidth:e.pixelwidth,viewPixelHeight:e.pixelheight,clearOnAccess:!1}):this._glBinding.createCylinderLayer({transform:new XRRigidTransform(e.translation,e.quaternion),radius:e.radius,centralAngle:e.centralAngle,aspectRatio:e.aspectRatio,space:this._referenceSpace,viewPixelWidth:e.pixelwidth,viewPixelHeight:e.pixelheight,clearOnAccess:!1})}function Lx(e,t){if(void 0===t)return;const r=this._cameraXR,n=this._renderer,i=n.backend,s=this._glBaseLayer,o=this.getReferenceSpace(),a=t.getViewerPose(o);if(this._xrFrame=t,null!==a){const e=a.views;null!==this._glBaseLayer&&i.setXRTarget(s.framebuffer);let t=!1;e.length!==r.cameras.length&&(r.cameras.length=0,t=!0);for(let n=0;n<e.length;n++){const o=e[n];let a;if(!0===this._useLayers){const e=this._glBinding.getViewSubImage(this._glProjLayer,o);a=e.viewport,0===n&&i.setXRRenderTargetTextures(this._xrRenderTarget,e.colorTexture,this._glProjLayer.ignoreDepthValues&&!this._useMultiview?void 0:e.depthStencilTexture)}else a=s.getViewport(o);let u=this._cameras[n];void 0===u&&(u=new re,u.layers.enable(n),u.viewport=new E,this._cameras[n]=u),u.matrix.fromArray(o.transform.matrix),u.matrix.decompose(u.position,u.quaternion,u.scale),u.projectionMatrix.fromArray(o.projectionMatrix),u.projectionMatrixInverse.copy(u.projectionMatrix).invert(),u.viewport.set(a.x,a.y,a.width,a.height),0===n&&(r.matrix.copy(u.matrix),r.matrix.decompose(r.position,r.quaternion,r.scale)),!0===t&&r.cameras.push(u)}n.setOutputRenderTarget(this._xrRenderTarget)}for(let u=0;u<this._controllers.length;u++){const e=this._controllerInputSources[u],r=this._controllers[u];null!==e&&void 0!==r&&r.update(e,t,o)}this._currentAnimationLoop&&this._currentAnimationLoop(e,t),t.detectedPlanes&&this.dispatchEvent({type:"planesdetected",data:t}),this._xrFrame=null}const Bx=new A,kx=new i,Ix=new E,Ux=new O,Vx=new F,jx=new a,Gx=new E;class zx{constructor(e,t={}){this.isRenderer=!0;const{logarithmicDepthBuffer:r=!1,alpha:n=!0,depth:i=!0,stencil:s=!1,antialias:o=!1,samples:a=0,getFallback:u=null,colorBufferType:l=w,multiview:c=!1}=t;this.domElement=e.getDomElement(),this.backend=e,this.samples=a||!0===o?4:0,this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.alpha=n,this.logarithmicDepthBuffer=r,this.outputColorSpace=S,this.toneMapping=N,this.toneMappingExposure=1,this.sortObjects=!0,this.depth=i,this.stencil=s,this.info=new yb,this.overrideNodes={modelViewMatrix:null,modelNormalViewMatrix:null},this.library=new Tx,this.lighting=new Nx,this._getFallback=u,this._pixelRatio=1,this._width=this.domElement.width,this._height=this.domElement.height,this._viewport=new E(0,0,this._width,this._height),this._scissor=new E(0,0,this._width,this._height),this._scissorTest=!1,this._attributes=null,this._geometries=null,this._nodes=null,this._animation=null,this._bindings=null,this._objects=null,this._pipelines=null,this._bundles=null,this._renderLists=null,this._renderContexts=null,this._textures=null,this._background=null,this._quad=new Xb(new _g),this._quad.material.name="Renderer_output",this._currentRenderContext=null,this._opaqueSort=null,this._transparentSort=null,this._frameBufferTarget=null;const h=!0===this.alpha?0:1;this._clearColor=new Vb(0,0,0,h),this._clearDepth=1,this._clearStencil=0,this._renderTarget=null,this._activeCubeFace=0,this._activeMipmapLevel=0,this._outputRenderTarget=null,this._mrt=null,this._renderObjectFunction=null,this._currentRenderObjectFunction=null,this._currentRenderBundle=null,this._handleObjectFunction=this._renderObjectDirect,this._isDeviceLost=!1,this.onDeviceLost=this._onDeviceLost,this._colorBufferType=l,this._initialized=!1,this._initPromise=null,this._compilationPromises=null,this.transparent=!0,this.opaque=!0,this.shadowMap={enabled:!1,type:C},this.xr=new Mx(this,c),this.debug={checkShaderErrors:!0,onShaderError:null,getShaderAsync:async(e,t,r)=>{await this.compileAsync(e,t);const n=this._renderLists.get(e,t),i=this._renderContexts.get(e,t,this._renderTarget),s=e.overrideMaterial||r.material,o=this._objects.get(r,s,e,t,n.lightsNode,i,i.clippingContext),{fragmentShader:a,vertexShader:u}=o.getNodeBuilderState();return{fragmentShader:a,vertexShader:u}}}}async init(){if(this._initialized)throw new Error("Renderer: Backend has already been initialized.");return null!==this._initPromise||(this._initPromise=new Promise((async(e,t)=>{let r=this.backend;try{await r.init(this)}catch(n){if(null===this._getFallback)return void t(n);try{this.backend=r=this._getFallback(n),await r.init(this)}catch(i){return void t(i)}}this._nodes=new mx(this,r),this._animation=new tb(this._nodes,this.info),this._attributes=new pb(r),this._background=new pv(this,this._nodes),this._geometries=new mb(this._attributes,this.info),this._textures=new Ub(this,r,this.info),this._pipelines=new wb(r,this._nodes),this._bindings=new Sb(r,this._nodes,this._textures,this._attributes,this._pipelines,this.info),this._objects=new ob(this,this._nodes,this._geometries,this._pipelines,this._bindings,this.info),this._renderLists=new Rb(this.lighting),this._bundles=new xx,this._renderContexts=new kb,this._animation.start(),this._initialized=!0,e(this)}))),this._initPromise}get coordinateSystem(){return this.backend.coordinateSystem}async compileAsync(e,t,r=null){if(!0===this._isDeviceLost)return;!1===this._initialized&&await this.init();const n=this._nodes.nodeFrame,i=n.renderId,s=this._currentRenderContext,o=this._currentRenderObjectFunction,a=this._compilationPromises,u=!0===e.isScene?e:Bx;null===r&&(r=e);const l=this._renderTarget,c=this._renderContexts.get(r,t,l),h=this._activeMipmapLevel,d=[];this._currentRenderContext=c,this._currentRenderObjectFunction=this.renderObject,this._handleObjectFunction=this._createObjectPipeline,this._compilationPromises=d,n.renderId++,n.update(),c.depth=this.depth,c.stencil=this.stencil,c.clippingContext||(c.clippingContext=new bx),c.clippingContext.updateGlobal(u,t),u.onBeforeRender(this,e,t,l);const p=this._renderLists.get(e,t);if(p.begin(),this._projectObject(e,t,0,p,c.clippingContext),r!==e&&r.traverseVisible((function(e){e.isLight&&e.layers.test(t.layers)&&p.pushLight(e)})),p.finish(),null!==l){this._textures.updateRenderTarget(l,h);const e=this._textures.get(l);c.textures=e.textures,c.depthTexture=e.depthTexture}else c.textures=null,c.depthTexture=null;this._background.update(u,p,c);const f=p.opaque,g=p.transparent,m=p.transparentDoublePass,y=p.lightsNode;!0===this.opaque&&f.length>0&&this._renderObjects(f,t,u,y),!0===this.transparent&&g.length>0&&this._renderTransparents(g,m,t,u,y),n.renderId=i,this._currentRenderContext=s,this._currentRenderObjectFunction=o,this._compilationPromises=a,this._handleObjectFunction=this._renderObjectDirect,await Promise.all(d)}async renderAsync(e,t){!1===this._initialized&&await this.init(),this._renderScene(e,t)}async waitForGPU(){await this.backend.waitForGPU()}set highPrecision(e){!0===e?(this.overrideNodes.modelViewMatrix=Ud,this.overrideNodes.modelNormalViewMatrix=Vd):this.highPrecision&&(this.overrideNodes.modelViewMatrix=null,this.overrideNodes.modelNormalViewMatrix=null)}get highPrecision(){return this.overrideNodes.modelViewMatrix===Ud&&this.overrideNodes.modelNormalViewMatrix===Vd}setMRT(e){return this._mrt=e,this}getMRT(){return this._mrt}getColorBufferType(){return this._colorBufferType}_onDeviceLost(e){let t=`THREE.WebGPURenderer: ${e.api} Device Lost:\n\nMessage: ${e.message}`;e.reason&&(t+=`\nReason: ${e.reason}`),this._isDeviceLost=!0}_renderBundle(e,t,r){const{bundleGroup:n,camera:i,renderList:s}=e,o=this._currentRenderContext,a=this._bundles.get(n,i),u=this.backend.get(a);void 0===u.renderContexts&&(u.renderContexts=new Set);const l=n.version!==u.version,c=!1===u.renderContexts.has(o)||l;if(u.renderContexts.add(o),c){this.backend.beginBundle(o),(void 0===u.renderObjects||l)&&(u.renderObjects=[]),this._currentRenderBundle=a;const{transparentDoublePass:e,transparent:c,opaque:h}=s;!0===this.opaque&&h.length>0&&this._renderObjects(h,i,t,r),!0===this.transparent&&c.length>0&&this._renderTransparents(c,e,i,t,r),this._currentRenderBundle=null,this.backend.finishBundle(o,a),u.version=n.version}else{const{renderObjects:e}=u;for(let t=0,r=e.length;t<r;t++){const r=e[t];this._nodes.needsRefresh(r)&&(this._nodes.updateBefore(r),this._nodes.updateForRender(r),this._bindings.updateForRender(r),this._nodes.updateAfter(r))}}this.backend.addBundle(o,a)}render(e,t){if(!1===this._initialized)return this.renderAsync(e,t);this._renderScene(e,t)}_getFrameBufferTarget(){const{currentToneMapping:e,currentColorSpace:t}=this;if(!1===(e!==N)&&!1===(t!==P))return null;const{width:r,height:n}=this.getDrawingBufferSize(kx),{depth:i,stencil:s}=this;let o=this._frameBufferTarget;null===o&&(o=new M(r,n,{depthBuffer:i,stencilBuffer:s,type:this._colorBufferType,format:D,colorSpace:P,generateMipmaps:!1,minFilter:R,magFilter:R,samples:this.samples}),o.isPostProcessingRenderTarget=!0,this._frameBufferTarget=o);const a=this.getOutputRenderTarget();return o.depthBuffer=i,o.stencilBuffer=s,null!==a?o.setSize(a.width,a.height,a.depth):o.setSize(r,n,1),o.viewport.copy(this._viewport),o.scissor.copy(this._scissor),o.viewport.multiplyScalar(this._pixelRatio),o.scissor.multiplyScalar(this._pixelRatio),o.scissorTest=this._scissorTest,o.multiview=null!==a&&a.multiview,o.resolveDepthBuffer=null===a||a.resolveDepthBuffer,o.autoAllocateDepthBuffer=null!==a&&a.autoAllocateDepthBuffer,o}_renderScene(e,t,r=!0){if(!0===this._isDeviceLost)return;const n=r?this._getFrameBufferTarget():null,i=this._nodes.nodeFrame,s=i.renderId,o=this._currentRenderContext,a=this._currentRenderObjectFunction,u=!0===e.isScene?e:Bx,l=this._renderTarget||this._outputRenderTarget,c=this._activeCubeFace,h=this._activeMipmapLevel;let d;null!==n?(d=n,this.setRenderTarget(d)):d=l;const p=this._renderContexts.get(e,t,d);this._currentRenderContext=p,this._currentRenderObjectFunction=this._renderObjectFunction||this.renderObject,this.info.calls++,this.info.render.calls++,this.info.render.frameCalls++,i.renderId=this.info.calls;const f=this.coordinateSystem,g=this.xr;if(t.coordinateSystem!==f&&!1===g.isPresenting&&(t.coordinateSystem=f,t.updateProjectionMatrix(),t.isArrayCamera))for(const A of t.cameras)A.coordinateSystem=f,A.updateProjectionMatrix();!0===e.matrixWorldAutoUpdate&&e.updateMatrixWorld(),null===t.parent&&!0===t.matrixWorldAutoUpdate&&t.updateMatrixWorld(),!0===g.enabled&&!0===g.isPresenting&&(!0===g.cameraAutoUpdate&&g.updateCamera(t),t=g.getCamera());let m=this._viewport,y=this._scissor,b=this._pixelRatio;null!==d&&(m=d.viewport,y=d.scissor,b=1),this.getDrawingBufferSize(kx),Ix.set(0,0,kx.width,kx.height);const _=void 0===m.minDepth?0:m.minDepth,v=void 0===m.maxDepth?1:m.maxDepth;p.viewportValue.copy(m).multiplyScalar(b).floor(),p.viewportValue.width>>=h,p.viewportValue.height>>=h,p.viewportValue.minDepth=_,p.viewportValue.maxDepth=v,p.viewport=!1===p.viewportValue.equals(Ix),p.scissorValue.copy(y).multiplyScalar(b).floor(),p.scissor=this._scissorTest&&!1===p.scissorValue.equals(Ix),p.scissorValue.width>>=h,p.scissorValue.height>>=h,p.clippingContext||(p.clippingContext=new bx),p.clippingContext.updateGlobal(u,t),u.onBeforeRender(this,e,t,d);const x=t.isArrayCamera?Vx:Ux;t.isArrayCamera||(jx.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),x.setFromProjectionMatrix(jx,f));const T=this._renderLists.get(e,t);if(T.begin(),this._projectObject(e,t,0,T,p.clippingContext),T.finish(),!0===this.sortObjects&&T.sort(this._opaqueSort,this._transparentSort),null!==d){this._textures.updateRenderTarget(d,h);const e=this._textures.get(d);p.textures=e.textures,p.depthTexture=e.depthTexture,p.width=e.width,p.height=e.height,p.renderTarget=d,p.depth=d.depthBuffer,p.stencil=d.stencilBuffer}else p.textures=null,p.depthTexture=null,p.width=this.domElement.width,p.height=this.domElement.height,p.depth=this.depth,p.stencil=this.stencil;p.width>>=h,p.height>>=h,p.activeCubeFace=c,p.activeMipmapLevel=h,p.occlusionQueryCount=T.occlusionQueryCount,this._background.update(u,T,p),p.camera=t,this.backend.beginRender(p);const{bundles:w,lightsNode:S,transparentDoublePass:N,transparent:E,opaque:C}=T;return w.length>0&&this._renderBundles(w,u,S),!0===this.opaque&&C.length>0&&this._renderObjects(C,t,u,S),!0===this.transparent&&E.length>0&&this._renderTransparents(E,N,t,u,S),this.backend.finishRender(p),i.renderId=s,this._currentRenderContext=o,this._currentRenderObjectFunction=a,null!==n&&(this.setRenderTarget(l,c,h),this._renderOutput(d)),u.onAfterRender(this,e,t,d),p}_setXRLayerSize(e,t){this._width=e,this._height=t,this.setViewport(0,0,e,t)}_renderOutput(e){const t=this._quad;this._nodes.hasOutputChange(e.texture)&&(t.material.fragmentNode=this._nodes.getOutputNode(e.texture),t.material.needsUpdate=!0);const r=this.autoClear,n=this.xr.enabled;this.autoClear=!1,this.xr.enabled=!1,this._renderScene(t,t.camera,!1),this.autoClear=r,this.xr.enabled=n}getMaxAnisotropy(){return this.backend.getMaxAnisotropy()}getActiveCubeFace(){return this._activeCubeFace}getActiveMipmapLevel(){return this._activeMipmapLevel}async setAnimationLoop(e){!1===this._initialized&&await this.init(),this._animation.setAnimationLoop(e)}async getArrayBufferAsync(e){return await this.backend.getArrayBufferAsync(e)}getContext(){return this.backend.getContext()}getPixelRatio(){return this._pixelRatio}getDrawingBufferSize(e){return e.set(this._width*this._pixelRatio,this._height*this._pixelRatio).floor()}getSize(e){return e.set(this._width,this._height)}setPixelRatio(e=1){this._pixelRatio!==e&&(this._pixelRatio=e,this.setSize(this._width,this._height,!1))}setDrawingBufferSize(e,t,r){this.xr&&this.xr.isPresenting||(this._width=e,this._height=t,this._pixelRatio=r,this.domElement.width=Math.floor(e*r),this.domElement.height=Math.floor(t*r),this.setViewport(0,0,e,t),this._initialized&&this.backend.updateSize())}setSize(e,t,r=!0){this.xr&&this.xr.isPresenting||(this._width=e,this._height=t,this.domElement.width=Math.floor(e*this._pixelRatio),this.domElement.height=Math.floor(t*this._pixelRatio),!0===r&&(this.domElement.style.width=e+"px",this.domElement.style.height=t+"px"),this.setViewport(0,0,e,t),this._initialized&&this.backend.updateSize())}setOpaqueSort(e){this._opaqueSort=e}setTransparentSort(e){this._transparentSort=e}getScissor(e){const t=this._scissor;return e.x=t.x,e.y=t.y,e.width=t.width,e.height=t.height,e}setScissor(e,t,r,n){const i=this._scissor;e.isVector4?i.copy(e):i.set(e,t,r,n)}getScissorTest(){return this._scissorTest}setScissorTest(e){this._scissorTest=e,this.backend.setScissorTest(e)}getViewport(e){return e.copy(this._viewport)}setViewport(e,t,r,n,i=0,s=1){const o=this._viewport;e.isVector4?o.copy(e):o.set(e,t,r,n),o.minDepth=i,o.maxDepth=s}getClearColor(e){return e.copy(this._clearColor)}setClearColor(e,t=1){this._clearColor.set(e),this._clearColor.a=t}getClearAlpha(){return this._clearColor.a}setClearAlpha(e){this._clearColor.a=e}getClearDepth(){return this._clearDepth}setClearDepth(e){this._clearDepth=e}getClearStencil(){return this._clearStencil}setClearStencil(e){this._clearStencil=e}isOccluded(e){const t=this._currentRenderContext;return t&&this.backend.isOccluded(t,e)}clear(e=!0,t=!0,r=!0){if(!1===this._initialized)return this.clearAsync(e,t,r);const n=this._renderTarget||this._getFrameBufferTarget();let i=null;if(null!==n){this._textures.updateRenderTarget(n);const e=this._textures.get(n);i=this._renderContexts.getForClear(n),i.textures=e.textures,i.depthTexture=e.depthTexture,i.width=e.width,i.height=e.height,i.renderTarget=n,i.depth=n.depthBuffer,i.stencil=n.stencilBuffer,i.clearColorValue=this.backend.getClearColor(),i.activeCubeFace=this.getActiveCubeFace(),i.activeMipmapLevel=this.getActiveMipmapLevel()}this.backend.clear(e,t,r,i),null!==n&&null===this._renderTarget&&this._renderOutput(n)}clearColor(){return this.clear(!0,!1,!1)}clearDepth(){return this.clear(!1,!0,!1)}clearStencil(){return this.clear(!1,!1,!0)}async clearAsync(e=!0,t=!0,r=!0){!1===this._initialized&&await this.init(),this.clear(e,t,r)}async clearColorAsync(){this.clearAsync(!0,!1,!1)}async clearDepthAsync(){this.clearAsync(!1,!0,!1)}async clearStencilAsync(){this.clearAsync(!1,!1,!0)}get currentToneMapping(){return this.isOutputTarget?this.toneMapping:N}get currentColorSpace(){return this.isOutputTarget?this.outputColorSpace:P}get isOutputTarget(){return this._renderTarget===this._outputRenderTarget||null===this._renderTarget}dispose(){this.info.dispose(),this.backend.dispose(),this._animation.dispose(),this._objects.dispose(),this._pipelines.dispose(),this._nodes.dispose(),this._bindings.dispose(),this._renderLists.dispose(),this._renderContexts.dispose(),this._textures.dispose(),null!==this._frameBufferTarget&&this._frameBufferTarget.dispose(),Object.values(this.backend.timestampQueryPool).forEach((e=>{null!==e&&e.dispose()})),this.setRenderTarget(null),this.setAnimationLoop(null)}setRenderTarget(e,t=0,r=0){this._renderTarget=e,this._activeCubeFace=t,this._activeMipmapLevel=r}getRenderTarget(){return this._renderTarget}setOutputRenderTarget(e){this._outputRenderTarget=e}getOutputRenderTarget(){return this._outputRenderTarget}_resetXRState(){this.backend.setXRTarget(null),this.setOutputRenderTarget(null),this.setRenderTarget(null),this._frameBufferTarget.dispose(),this._frameBufferTarget=null}setRenderObjectFunction(e){this._renderObjectFunction=e}getRenderObjectFunction(){return this._renderObjectFunction}compute(e){if(!0===this._isDeviceLost)return;if(!1===this._initialized)return this.computeAsync(e);const t=this._nodes.nodeFrame,r=t.renderId;this.info.calls++,this.info.compute.calls++,this.info.compute.frameCalls++,t.renderId=this.info.calls;const n=this.backend,i=this._pipelines,s=this._bindings,o=this._nodes,a=Array.isArray(e)?e:[e];if(void 0===a[0]||!0!==a[0].isComputeNode)throw new Error("THREE.Renderer: .compute() expects a ComputeNode.");n.beginCompute(e);for(const u of a){if(!1===i.has(u)){const e=()=>{u.removeEventListener("dispose",e),i.delete(u),s.delete(u),o.delete(u)};u.addEventListener("dispose",e);const t=u.onInitFunction;null!==t&&t.call(u,{renderer:this})}o.updateForCompute(u),s.updateForCompute(u);const t=s.getForCompute(u),r=i.getForCompute(u,t);n.compute(e,u,t,r)}n.finishCompute(e),t.renderId=r}async computeAsync(e){!1===this._initialized&&await this.init(),this.compute(e)}async hasFeatureAsync(e){return!1===this._initialized&&await this.init(),this.backend.hasFeature(e)}async resolveTimestampsAsync(e="render"){return!1===this._initialized&&await this.init(),this.backend.resolveTimestampsAsync(e)}hasFeature(e){return!1!==this._initialized&&this.backend.hasFeature(e)}hasInitialized(){return this._initialized}async initTextureAsync(e){!1===this._initialized&&await this.init(),this._textures.updateTexture(e)}initTexture(e){this._initialized,this._textures.updateTexture(e)}copyFramebufferToTexture(e,t=null){if(null!==t)if(t.isVector2)t=Gx.set(t.x,t.y,e.image.width,e.image.height).floor();else{if(!t.isVector4)return;t=Gx.copy(t).floor()}else t=Gx.set(0,0,e.image.width,e.image.height);let r,n=this._currentRenderContext;null!==n?r=n.renderTarget:(r=this._renderTarget||this._getFrameBufferTarget(),null!==r&&(this._textures.updateRenderTarget(r),n=this._textures.get(r))),this._textures.updateTexture(e,{renderTarget:r}),this.backend.copyFramebufferToTexture(e,n,t)}copyTextureToTexture(e,t,r=null,n=null,i=0,s=0){this._textures.updateTexture(e),this._textures.updateTexture(t),this.backend.copyTextureToTexture(e,t,r,n,i,s)}async readRenderTargetPixelsAsync(e,t,r,n,i,s=0,o=0){return this.backend.copyTextureToBuffer(e.textures[s],t,r,n,i,o)}_projectObject(e,t,r,n,i){if(!1===e.visible)return;if(e.layers.test(t.layers))if(e.isGroup)r=e.renderOrder,e.isClippingGroup&&e.enabled&&(i=i.getGroupContext(e));else if(e.isLOD)!0===e.autoUpdate&&e.update(t);else if(e.isLight)n.pushLight(e);else if(e.isSprite){const s=t.isArrayCamera?Vx:Ux;if(!e.frustumCulled||s.intersectsSprite(e,t)){!0===this.sortObjects&&Gx.setFromMatrixPosition(e.matrixWorld).applyMatrix4(jx);const{geometry:t,material:s}=e;s.visible&&n.push(e,t,s,r,Gx.z,null,i)}}else if(e.isLineLoop);else if(e.isMesh||e.isLine||e.isPoints){const s=t.isArrayCamera?Vx:Ux;if(!e.frustumCulled||s.intersectsObject(e,t)){const{geometry:t,material:s}=e;if(!0===this.sortObjects&&(null===t.boundingSphere&&t.computeBoundingSphere(),Gx.copy(t.boundingSphere.center).applyMatrix4(e.matrixWorld).applyMatrix4(jx)),Array.isArray(s)){const o=t.groups;for(let a=0,u=o.length;a<u;a++){const u=o[a],l=s[u.materialIndex];l&&l.visible&&n.push(e,t,l,r,Gx.z,u,i)}}else s.visible&&n.push(e,t,s,r,Gx.z,null,i)}}if(!0===e.isBundleGroup&&void 0!==this.backend.beginBundle){const r=n;(n=this._renderLists.get(e,t)).begin(),r.pushBundle({bundleGroup:e,camera:t,renderList:n}),n.finish()}const s=e.children;for(let o=0,a=s.length;o<a;o++)this._projectObject(s[o],t,r,n,i)}_renderBundles(e,t,r){for(const n of e)this._renderBundle(n,t,r)}_renderTransparents(e,t,r,n,i){if(t.length>0){for(const{material:e}of t)e.side=L;this._renderObjects(t,r,n,i,"backSide");for(const{material:e}of t)e.side=B;this._renderObjects(e,r,n,i);for(const{material:e}of t)e.side=k}else this._renderObjects(e,r,n,i)}_renderObjects(e,t,r,n,i=null){for(let s=0,o=e.length;s<o;s++){const{object:o,geometry:a,material:u,group:l,clippingContext:c}=e[s];this._currentRenderObjectFunction(o,r,t,a,u,l,n,c,i)}}renderObject(e,t,r,n,i,s,o,a=null,u=null){let l,c,h;if(e.onBeforeRender(this,t,r,n,i,s),!0===i.allowOverride&&null!==t.overrideMaterial){const e=t.overrideMaterial;i.positionNode&&i.positionNode.isNode&&(l=e.positionNode,e.positionNode=i.positionNode),e.alphaTest=i.alphaTest,e.alphaMap=i.alphaMap,e.transparent=i.transparent||i.transmission>0,e.isShadowPassMaterial&&(e.side=null===i.shadowSide?i.side:i.shadowSide,i.depthNode&&i.depthNode.isNode&&(h=e.depthNode,e.depthNode=i.depthNode),i.castShadowNode&&i.castShadowNode.isNode&&(c=e.colorNode,e.colorNode=i.castShadowNode),i.castShadowPositionNode&&i.castShadowPositionNode.isNode&&(l=e.positionNode,e.positionNode=i.castShadowPositionNode)),i=e}!0===i.transparent&&i.side===k&&!1===i.forceSinglePass?(i.side=L,this._handleObjectFunction(e,i,t,r,o,s,a,"backSide"),i.side=B,this._handleObjectFunction(e,i,t,r,o,s,a,u),i.side=k):this._handleObjectFunction(e,i,t,r,o,s,a,u),void 0!==l&&(t.overrideMaterial.positionNode=l),void 0!==h&&(t.overrideMaterial.depthNode=h),void 0!==c&&(t.overrideMaterial.colorNode=c),e.onAfterRender(this,t,r,n,i,s)}_renderObjectDirect(e,t,r,n,i,s,o,a){const u=this._objects.get(e,t,r,n,i,this._currentRenderContext,o,a);u.drawRange=e.geometry.drawRange,u.group=s;const l=this._nodes.needsRefresh(u);if(l&&(this._nodes.updateBefore(u),this._geometries.updateForRender(u),this._nodes.updateForRender(u),this._bindings.updateForRender(u)),this._pipelines.updateForRender(u),null!==this._currentRenderBundle){this.backend.get(this._currentRenderBundle).renderObjects.push(u),u.bundle=this._currentRenderBundle.bundleGroup}this.backend.draw(u,this.info),l&&this._nodes.updateAfter(u)}_createObjectPipeline(e,t,r,n,i,s,o,a){const u=this._objects.get(e,t,r,n,i,this._currentRenderContext,o,a);u.drawRange=e.geometry.drawRange,u.group=s,this._nodes.updateBefore(u),this._geometries.updateForRender(u),this._nodes.updateForRender(u),this._bindings.updateForRender(u),this._pipelines.getForRender(u,this._compilationPromises),this._nodes.updateAfter(u)}get compile(){return this.compileAsync}}class $x{constructor(e=""){this.name=e,this.visibility=0}setVisibility(e){this.visibility|=e}clone(){return Object.assign(new this.constructor,this)}}class Hx extends $x{constructor(e,t=null){super(e),this.isBuffer=!0,this.bytesPerElement=Float32Array.BYTES_PER_ELEMENT,this._buffer=t}get byteLength(){return(e=this._buffer.byteLength)+(db-e%db)%db;var e}get buffer(){return this._buffer}update(){return!0}}class Wx extends Hx{constructor(e,t=null){super(e,t),this.isUniformBuffer=!0}}let qx=0;class Xx extends Wx{constructor(e,t){super("UniformBuffer_"+qx++,e?e.value:null),this.nodeUniform=e,this.groupNode=t}get buffer(){return this.nodeUniform.value}}class Kx extends Wx{constructor(e){super(e),this.isUniformsGroup=!0,this._values=null,this.uniforms=[]}addUniform(e){return this.uniforms.push(e),this}removeUniform(e){const t=this.uniforms.indexOf(e);return-1!==t&&this.uniforms.splice(t,1),this}get values(){return null===this._values&&(this._values=Array.from(this.buffer)),this._values}get buffer(){let e=this._buffer;if(null===e){const t=this.byteLength;e=new Float32Array(new ArrayBuffer(t)),this._buffer=e}return e}get byteLength(){const e=this.bytesPerElement;let t=0;for(let r=0,n=this.uniforms.length;r<n;r++){const n=this.uniforms[r],i=n.boundary,s=n.itemSize*e,o=t%db,a=o%i,u=o+a;t+=a,0!==u&&db-u<s&&(t+=db-u),n.offset=t/e,t+=s}return Math.ceil(t/db)*db}update(){let e=!1;for(const t of this.uniforms)!0===this.updateByType(t)&&(e=!0);return e}updateByType(e){return e.isNumberUniform?this.updateNumber(e):e.isVector2Uniform?this.updateVector2(e):e.isVector3Uniform?this.updateVector3(e):e.isVector4Uniform?this.updateVector4(e):e.isColorUniform?this.updateColor(e):e.isMatrix3Uniform?this.updateMatrix3(e):e.isMatrix4Uniform?this.updateMatrix4(e):void 0}updateNumber(e){let t=!1;const r=this.values,n=e.getValue(),i=e.offset,s=e.getType();if(r[i]!==n){this._getBufferForType(s)[i]=r[i]=n,t=!0}return t}updateVector2(e){let t=!1;const r=this.values,n=e.getValue(),i=e.offset,s=e.getType();if(r[i+0]!==n.x||r[i+1]!==n.y){const e=this._getBufferForType(s);e[i+0]=r[i+0]=n.x,e[i+1]=r[i+1]=n.y,t=!0}return t}updateVector3(e){let t=!1;const r=this.values,n=e.getValue(),i=e.offset,s=e.getType();if(r[i+0]!==n.x||r[i+1]!==n.y||r[i+2]!==n.z){const e=this._getBufferForType(s);e[i+0]=r[i+0]=n.x,e[i+1]=r[i+1]=n.y,e[i+2]=r[i+2]=n.z,t=!0}return t}updateVector4(e){let t=!1;const r=this.values,n=e.getValue(),i=e.offset,s=e.getType();if(r[i+0]!==n.x||r[i+1]!==n.y||r[i+2]!==n.z||r[i+4]!==n.w){const e=this._getBufferForType(s);e[i+0]=r[i+0]=n.x,e[i+1]=r[i+1]=n.y,e[i+2]=r[i+2]=n.z,e[i+3]=r[i+3]=n.w,t=!0}return t}updateColor(e){let t=!1;const r=this.values,n=e.getValue(),i=e.offset;if(r[i+0]!==n.r||r[i+1]!==n.g||r[i+2]!==n.b){const e=this.buffer;e[i+0]=r[i+0]=n.r,e[i+1]=r[i+1]=n.g,e[i+2]=r[i+2]=n.b,t=!0}return t}updateMatrix3(e){let t=!1;const r=this.values,n=e.getValue().elements,i=e.offset;if(r[i+0]!==n[0]||r[i+1]!==n[1]||r[i+2]!==n[2]||r[i+4]!==n[3]||r[i+5]!==n[4]||r[i+6]!==n[5]||r[i+8]!==n[6]||r[i+9]!==n[7]||r[i+10]!==n[8]){const e=this.buffer;e[i+0]=r[i+0]=n[0],e[i+1]=r[i+1]=n[1],e[i+2]=r[i+2]=n[2],e[i+4]=r[i+4]=n[3],e[i+5]=r[i+5]=n[4],e[i+6]=r[i+6]=n[5],e[i+8]=r[i+8]=n[6],e[i+9]=r[i+9]=n[7],e[i+10]=r[i+10]=n[8],t=!0}return t}updateMatrix4(e){let t=!1;const r=this.values,n=e.getValue().elements,i=e.offset;if(!1===function(e,t,r){for(let n=0,i=t.length;n<i;n++)if(e[r+n]!==t[n])return!1;return!0}(r,n,i)){this.buffer.set(n,i),function(e,t,r){for(let n=0,i=t.length;n<i;n++)e[r+n]=t[n]}(r,n,i),t=!0}return t}_getBufferForType(e){return"int"===e||"ivec2"===e||"ivec3"===e||"ivec4"===e?new Int32Array(this.buffer.buffer):"uint"===e||"uvec2"===e||"uvec3"===e||"uvec4"===e?new Uint32Array(this.buffer.buffer):this.buffer}}let Yx=0;class Qx extends Kx{constructor(e,t){super(e),this.id=Yx++,this.groupNode=t,this.isNodeUniformsGroup=!0}}let Zx=0;class Jx extends $x{constructor(e,t){super(e),this.id=Zx++,this.texture=t,this.version=t?t.version:0,this.store=!1,this.generation=null,this.isSampledTexture=!0}needsBindingsUpdate(e){const{texture:t}=this;return e!==this.generation?(this.generation=e,!0):t.isVideoTexture}update(){const{texture:e,version:t}=this;return t!==e.version&&(this.version=e.version,!0)}}class eT extends Jx{constructor(e,t,r,n=null){super(e,t?t.value:null),this.textureNode=t,this.groupNode=r,this.access=n}needsBindingsUpdate(e){return this.textureNode.value!==this.texture||super.needsBindingsUpdate(e)}update(){const{textureNode:e}=this;return this.texture!==e.value?(this.texture=e.value,!0):super.update()}}class tT extends eT{constructor(e,t,r,n=null){super(e,t,r,n),this.isSampledCubeTexture=!0}}class rT extends eT{constructor(e,t,r,n=null){super(e,t,r,n),this.isSampledTexture3D=!0}}const nT={textureDimensions:"textureSize",equals:"equal"},iT={low:"lowp",medium:"mediump",high:"highp"},sT={swizzleAssign:!0,storageBuffer:!1},oT={perspective:"smooth",linear:"noperspective"},aT={centroid:"centroid","flat first":"flat","flat either":"flat"},uT="\nprecision highp float;\nprecision highp int;\nprecision highp sampler2D;\nprecision highp sampler3D;\nprecision highp samplerCube;\nprecision highp sampler2DArray;\n\nprecision highp usampler2D;\nprecision highp usampler3D;\nprecision highp usamplerCube;\nprecision highp usampler2DArray;\n\nprecision highp isampler2D;\nprecision highp isampler3D;\nprecision highp isamplerCube;\nprecision highp isampler2DArray;\n\nprecision lowp sampler2DShadow;\nprecision lowp sampler2DArrayShadow;\nprecision lowp samplerCubeShadow;\n";class lT extends Hv{constructor(e,t){super(e,t,new dx),this.uniformGroups={},this.transforms=[],this.extensions={},this.builtins={vertex:[],fragment:[],compute:[]}}needsToWorkingColorSpace(e){return!0===e.isVideoTexture&&e.colorSpace!==Ke}getMethod(e){return nT[e]||e}getOutputStructName(){return""}buildFunctionCode(e){const t=e.layout,r=this.flowShaderNode(e),n=[];for(const i of t.inputs)n.push(this.getType(i.type)+" "+i.name);return`${this.getType(t.type)} ${t.name}( ${n.join(", ")} ) {\n\n\t${r.vars}\n\n${r.code}\n\treturn ${r.result};\n\n}`}setupPBO(e){const t=e.value;if(void 0===t.pbo){const e=t.array,r=t.count*t.itemSize,{itemSize:n}=t,i=t.array.constructor.name.toLowerCase().includes("int");let s=i?Ft:Dt;2===n?s=i?Lt:Ot:3===n?s=i?Xr:Pt:4===n&&(s=i?Bt:D);const o={Float32Array:Ye,Uint8Array:oe,Uint16Array:Mt,Uint32Array:ue,Int8Array:Ct,Int16Array:At,Int32Array:Me,Uint8ClampedArray:oe},a=Math.pow(2,Math.ceil(Math.log2(Math.sqrt(r/n))));let u=Math.ceil(r/n/a);a*u*n<r&&u++;const l=a*u*n,c=new e.constructor(l);c.set(e,0),t.array=c;const h=new pr(t.array,a,u,s,o[t.array.constructor.name]||Ye);h.needsUpdate=!0,h.isPBOTexture=!0;const d=new gd(h,null,null);d.setPrecision("high"),t.pboNode=d,t.pbo=d.value,this.getUniformFromNode(t.pboNode,"texture",this.shaderStage,this.context.label)}}getPropertyName(e,t=this.shaderStage){return e.isNodeUniform&&!0!==e.node.isTextureNode&&!0!==e.node.isBufferNode?t.charAt(0)+"_"+e.name:super.getPropertyName(e,t)}generatePBO(e){const{node:t,indexNode:r}=e,n=t.value;if(this.renderer.backend.has(n)){this.renderer.backend.get(n).pbo=n.pbo}const i=this.getUniformFromNode(n.pboNode,"texture",this.shaderStage,this.context.label),s=this.getPropertyName(i);this.increaseUsage(r);const o=r.build(this,"uint"),a=this.getDataFromNode(e);let u=a.propertyName;if(void 0===u){const r=this.getVarFromNode(e);u=this.getPropertyName(r);const i=this.getDataFromNode(t);let l=i.propertySizeName;void 0===l&&(l=u+"Size",this.getVarFromNode(t,l,"uint"),this.addLineFlowCode(`${l} = uint( textureSize( ${s}, 0 ).x )`,e),i.propertySizeName=l);const{itemSize:c}=n,h="."+$a.join("").slice(0,c),d=`ivec2(${o} % ${l}, ${o} / ${l})`,p=this.generateTextureLoad(null,s,d,null,"0");let f="vec4";n.pbo.type===ue?f="uvec4":n.pbo.type===Me&&(f="ivec4"),this.addLineFlowCode(`${u} = ${f}(${p})${h}`,e),a.propertyName=u}return u}generateTextureLoad(e,t,r,n,i="0"){return n?`texelFetch( ${t}, ivec3( ${r}, ${n} ), ${i} )`:`texelFetch( ${t}, ${r}, ${i} )`}generateTexture(e,t,r,n){return e.isDepthTexture?(n&&(r=`vec4( ${r}, ${n} )`),`texture( ${t}, ${r} ).x`):(n&&(r=`vec3( ${r}, ${n} )`),`texture( ${t}, ${r} )`)}generateTextureLevel(e,t,r,n){return`textureLod( ${t}, ${r}, ${n} )`}generateTextureBias(e,t,r,n){return`texture( ${t}, ${r}, ${n} )`}generateTextureGrad(e,t,r,n){return`textureGrad( ${t}, ${r}, ${n[0]}, ${n[1]} )`}generateTextureCompare(e,t,r,n,i,s=this.shaderStage){if("fragment"===s)return i?`texture( ${t}, vec4( ${r}, ${i}, ${n} ) )`:`texture( ${t}, vec3( ${r}, ${n} ) )`}getVars(e){const t=[],r=this.vars[e];if(void 0!==r)for(const n of r)t.push(`${this.getVar(n.type,n.name,n.count)};`);return t.join("\n\t")}getUniforms(e){const t=this.uniforms[e],r=[],n={};for(const s of t){let t=null,i=!1;if("texture"===s.type||"texture3D"===s.type){const e=s.node.value;let r="";!0!==e.isDataTexture&&!0!==e.isData3DTexture||(e.type===ue?r="u":e.type===Me&&(r="i")),t="texture3D"===s.type&&!1===e.isArrayTexture?`${r}sampler3D ${s.name};`:e.compareFunction?!0===e.isArrayTexture?`sampler2DArrayShadow ${s.name};`:`sampler2DShadow ${s.name};`:!0===e.isArrayTexture||!0===e.isDataArrayTexture||!0===e.isCompressedArrayTexture?`${r}sampler2DArray ${s.name};`:`${r}sampler2D ${s.name};`}else if("cubeTexture"===s.type)t=`samplerCube ${s.name};`;else if("buffer"===s.type){const e=s.node,r=this.getType(e.bufferType),n=e.bufferCount,i=n>0?n:"";t=`${e.name} {\n\t${r} ${s.name}[${i}];\n};\n`}else{t=`${this.getVectorType(s.type)} ${this.getPropertyName(s,e)};`,i=!0}const o=s.node.precision;if(null!==o&&(t=iT[o]+" "+t),i){t="\t"+t;const e=s.groupNode.name;(n[e]||(n[e]=[])).push(t)}else t="uniform "+t,r.push(t)}let i="";for(const s in n){const t=n[s];i+=this._getGLSLUniformStruct(e+"_"+s,t.join("\n"))+"\n"}return i+=r.join("\n"),i}getTypeFromAttribute(e){let t=super.getTypeFromAttribute(e);if(/^[iu]/.test(t)&&e.gpuType!==Me){let r=e;e.isInterleavedBufferAttribute&&(r=e.data);const n=r.array;!1==(n instanceof Uint32Array||n instanceof Int32Array)&&(t=t.slice(1))}return t}getAttributes(e){let t="";if("vertex"===e||"compute"===e){const e=this.getAttributesArray();let r=0;for(const n of e)t+=`layout( location = ${r++} ) in ${n.type} ${n.name};\n`}return t}getStructMembers(e){const t=[];for(const r of e.members)t.push(`\t${r.type} ${r.name};`);return t.join("\n")}getStructs(e){const t=[],r=this.structs[e],n=[];for(const i of r)if(i.output)for(const e of i.members)n.push(`layout( location = ${e.index} ) out ${e.type} ${e.name};`);else{let e="struct "+i.name+" {\n";e+=this.getStructMembers(i),e+="\n};\n",t.push(e)}return 0===n.length&&n.push("layout( location = 0 ) out vec4 fragColor;"),"\n"+n.join("\n")+"\n\n"+t.join("\n")}getVaryings(e){let t="";const r=this.varyings;if("vertex"===e||"compute"===e)for(const n of r){"compute"===e&&(n.needsInterpolation=!0);const r=this.getType(n.type);if(n.needsInterpolation)if(n.interpolationType){t+=`${oT[n.interpolationType]||n.interpolationType} ${aT[n.interpolationSampling]||""} out ${r} ${n.name};\n`}else{t+=`${r.includes("int")||r.includes("uv")||r.includes("iv")?"flat ":""}out ${r} ${n.name};\n`}else t+=`${r} ${n.name};\n`}else if("fragment"===e)for(const n of r)if(n.needsInterpolation){const e=this.getType(n.type);if(n.interpolationType){t+=`${oT[n.interpolationType]||n.interpolationType} ${aT[n.interpolationSampling]||""} in ${e} ${n.name};\n`}else{t+=`${e.includes("int")||e.includes("uv")||e.includes("iv")?"flat ":""}in ${e} ${n.name};\n`}}for(const n of this.builtins[e])t+=`${n};\n`;return t}getVertexIndex(){return"uint( gl_VertexID )"}getInstanceIndex(){return"uint( gl_InstanceID )"}getInvocationLocalIndex(){return`uint( gl_InstanceID ) % ${this.object.workgroupSize.reduce(((e,t)=>e*t),1)}u`}getDrawIndex(){return this.renderer.backend.extensions.has("WEBGL_multi_draw")?"uint( gl_DrawID )":null}getFrontFacing(){return"gl_FrontFacing"}getFragCoord(){return"gl_FragCoord.xy"}getFragDepth(){return"gl_FragDepth"}enableExtension(e,t,r=this.shaderStage){const n=this.extensions[r]||(this.extensions[r]=new Map);!1===n.has(e)&&n.set(e,{name:e,behavior:t})}getExtensions(e){const t=[];if("vertex"===e){const t=this.renderer.backend.extensions;this.object.isBatchedMesh&&t.has("WEBGL_multi_draw")&&this.enableExtension("GL_ANGLE_multi_draw","require",e)}const r=this.extensions[e];if(void 0!==r)for(const{name:n,behavior:i}of r.values())t.push(`#extension ${n} : ${i}`);return t.join("\n")}getClipDistance(){return"gl_ClipDistance"}isAvailable(e){let t=sT[e];if(void 0===t){let r;switch(t=!1,e){case"float32Filterable":r="OES_texture_float_linear";break;case"clipDistance":r="WEBGL_clip_cull_distance"}if(void 0!==r){const e=this.renderer.backend.extensions;e.has(r)&&(e.get(r),t=!0)}sT[e]=t}return t}isFlipY(){return!0}enableHardwareClipping(e){this.enableExtension("GL_ANGLE_clip_cull_distance","require"),this.builtins.vertex.push(`out float gl_ClipDistance[ ${e} ]`)}enableMultiview(){this.enableExtension("GL_OVR_multiview2","require","fragment"),this.enableExtension("GL_OVR_multiview2","require","vertex"),this.builtins.vertex.push("layout(num_views = 2) in")}registerTransform(e,t){this.transforms.push({varyingName:e,attributeNode:t})}getTransforms(){const e=this.transforms;let t="";for(let r=0;r<e.length;r++){const n=e[r],i=this.getPropertyName(n.attributeNode);i&&(t+=`${n.varyingName} = ${i};\n\t`)}return t}_getGLSLUniformStruct(e,t){return`\nlayout( std140 ) uniform ${e} {\n${t}\n};`}_getGLSLVertexCode(e){return`#version 300 es\n\n${this.getSignature()}\n\n// extensions\n${e.extensions}\n\n// precision\n${uT}\n\n// uniforms\n${e.uniforms}\n\n// varyings\n${e.varyings}\n\n// attributes\n${e.attributes}\n\n// codes\n${e.codes}\n\nvoid main() {\n\n\t// vars\n\t${e.vars}\n\n\t// transforms\n\t${e.transforms}\n\n\t// flow\n\t${e.flow}\n\n\tgl_PointSize = 1.0;\n\n}\n`}_getGLSLFragmentCode(e){return`#version 300 es\n\n${this.getSignature()}\n\n// extensions\n${e.extensions}\n\n// precision\n${uT}\n\n// uniforms\n${e.uniforms}\n\n// varyings\n${e.varyings}\n\n// codes\n${e.codes}\n\n// structs\n${e.structs}\n\nvoid main() {\n\n\t// vars\n\t${e.vars}\n\n\t// flow\n\t${e.flow}\n\n}\n`}buildCode(){const e=null!==this.material?{fragment:{},vertex:{}}:{compute:{}};this.sortBindingGroups();for(const t in e){let r="// code\n\n";r+=this.flowCode[t];const n=this.flowNodes[t],i=n[n.length-1];for(const e of n){const n=this.getFlowData(e),s=e.name;s&&(r.length>0&&(r+="\n"),r+=`\t// flow -> ${s}\n\t`),r+=`${n.code}\n\t`,e===i&&"compute"!==t&&(r+="// result\n\t","vertex"===t?(r+="gl_Position = ",r+=`${n.result};`):"fragment"===t&&(e.outputNode.isOutputStructNode||(r+="fragColor = ",r+=`${n.result};`)))}const s=e[t];s.extensions=this.getExtensions(t),s.uniforms=this.getUniforms(t),s.attributes=this.getAttributes(t),s.varyings=this.getVaryings(t),s.vars=this.getVars(t),s.structs=this.getStructs(t),s.codes=this.getCodes(t),s.transforms=this.getTransforms(t),s.flow=r}null!==this.material?(this.vertexShader=this._getGLSLVertexCode(e.vertex),this.fragmentShader=this._getGLSLFragmentCode(e.fragment)):this.computeShader=this._getGLSLVertexCode(e.compute)}getUniformFromNode(e,t,r,n=null){const i=super.getUniformFromNode(e,t,r,n),s=this.getDataFromNode(e,r,this.globalCache);let o=s.uniformGPU;if(void 0===o){const n=e.groupNode,a=n.name,u=this.getBindGroupArray(a,r);if("texture"===t)o=new eT(i.name,i.node,n),u.push(o);else if("cubeTexture"===t)o=new tT(i.name,i.node,n),u.push(o);else if("texture3D"===t)o=new rT(i.name,i.node,n),u.push(o);else if("buffer"===t){e.name=`NodeBuffer_${e.id}`,i.name=`buffer${e.id}`;const t=new Xx(e,n);t.name=e.name,u.push(t),o=t}else{const e=this.uniformGroups[r]||(this.uniformGroups[r]={});let s=e[a];void 0===s&&(s=new Qx(r+"_"+a,n),e[a]=s,u.push(s)),o=this.getNodeUniform(i,t),s.addUniform(o)}s.uniformGPU=o}return i}}let cT=null,hT=null;class dT{constructor(e={}){this.parameters=Object.assign({},e),this.data=new WeakMap,this.renderer=null,this.domElement=null,this.timestampQueryPool={render:null,compute:null},this.trackTimestamp=!0===e.trackTimestamp}async init(e){this.renderer=e}get coordinateSystem(){}beginRender(){}finishRender(){}beginCompute(){}finishCompute(){}draw(){}compute(){}createProgram(){}destroyProgram(){}createBindings(){}updateBindings(){}updateBinding(){}createRenderPipeline(){}createComputePipeline(){}needsRenderUpdate(){}getRenderCacheKey(){}createNodeBuilder(){}createSampler(){}destroySampler(){}createDefaultTexture(){}createTexture(){}updateTexture(){}generateMipmaps(){}destroyTexture(){}async copyTextureToBuffer(){}copyTextureToTexture(){}copyFramebufferToTexture(){}createAttribute(){}createIndexAttribute(){}createStorageAttribute(){}updateAttribute(){}destroyAttribute(){}getContext(){}updateSize(){}updateViewport(){}isOccluded(){}async resolveTimestampsAsync(e="render"){if(!this.trackTimestamp)return void Ee("WebGPURenderer: Timestamp tracking is disabled.");const t=this.timestampQueryPool[e];if(!t)return void Ee(`WebGPURenderer: No timestamp query pool for type '${e}' found.`);const r=await t.resolveQueriesAsync();return this.renderer.info[e].timestamp=r,r}async waitForGPU(){}async getArrayBufferAsync(){}async hasFeatureAsync(){}hasFeature(){}getMaxAnisotropy(){}getDrawingBufferSize(){return cT=cT||new i,this.renderer.getDrawingBufferSize(cT)}setScissorTest(){}getClearColor(){const e=this.renderer;return hT=hT||new Vb,e.getClearColor(hT),hT.getRGB(hT),hT}getDomElement(){let e=this.domElement;return null===e&&(e=void 0!==this.parameters.canvas?this.parameters.canvas:Ce(),"setAttribute"in e&&e.setAttribute("data-engine",`three.js r${Ae} webgpu`),this.domElement=e),e}set(e,t){this.data.set(e,t)}get(e){let t=this.data.get(e);return void 0===t&&(t={},this.data.set(e,t)),t}has(e){return this.data.has(e)}delete(e){this.data.delete(e)}dispose(){}}let pT,fT,gT=0;class mT{constructor(e,t){this.buffers=[e.bufferGPU,t],this.type=e.type,this.bufferType=e.bufferType,this.pbo=e.pbo,this.byteLength=e.byteLength,this.bytesPerElement=e.BYTES_PER_ELEMENT,this.version=e.version,this.isInteger=e.isInteger,this.activeBufferIndex=0,this.baseId=e.id}get id(){return`${this.baseId}|${this.activeBufferIndex}`}get bufferGPU(){return this.buffers[this.activeBufferIndex]}get transformBuffer(){return this.buffers[1^this.activeBufferIndex]}switchBuffers(){this.activeBufferIndex^=1}}class yT{constructor(e){this.backend=e}createAttribute(e,t){const r=this.backend,{gl:n}=r,i=e.array,s=e.usage||n.STATIC_DRAW,o=e.isInterleavedBufferAttribute?e.data:e,a=r.get(o);let u,l=a.bufferGPU;if(void 0===l&&(l=this._createBuffer(n,t,i,s),a.bufferGPU=l,a.bufferType=t,a.version=o.version),i instanceof Float32Array)u=n.FLOAT;else if(i instanceof Uint16Array)u=e.isFloat16BufferAttribute?n.HALF_FLOAT:n.UNSIGNED_SHORT;else if(i instanceof Int16Array)u=n.SHORT;else if(i instanceof Uint32Array)u=n.UNSIGNED_INT;else if(i instanceof Int32Array)u=n.INT;else if(i instanceof Int8Array)u=n.BYTE;else if(i instanceof Uint8Array)u=n.UNSIGNED_BYTE;else{if(!(i instanceof Uint8ClampedArray))throw new Error("THREE.WebGLBackend: Unsupported buffer data format: "+i);u=n.UNSIGNED_BYTE}let c={bufferGPU:l,bufferType:t,type:u,byteLength:i.byteLength,bytesPerElement:i.BYTES_PER_ELEMENT,version:e.version,pbo:e.pbo,isInteger:u===n.INT||u===n.UNSIGNED_INT||e.gpuType===Me,id:gT++};if(e.isStorageBufferAttribute||e.isStorageInstancedBufferAttribute){const e=this._createBuffer(n,t,i,s);c=new mT(c,e)}r.set(e,c)}updateAttribute(e){const t=this.backend,{gl:r}=t,n=e.array,i=e.isInterleavedBufferAttribute?e.data:e,s=t.get(i),o=s.bufferType,a=e.isInterleavedBufferAttribute?e.data.updateRanges:e.updateRanges;if(r.bindBuffer(o,s.bufferGPU),0===a.length)r.bufferSubData(o,0,n);else{for(let e=0,t=a.length;e<t;e++){const t=a[e];r.bufferSubData(o,t.start*n.BYTES_PER_ELEMENT,n,t.start,t.count)}i.clearUpdateRanges()}r.bindBuffer(o,null),s.version=i.version}destroyAttribute(e){const t=this.backend,{gl:r}=t;e.isInterleavedBufferAttribute&&t.delete(e.data);const n=t.get(e);r.deleteBuffer(n.bufferGPU),t.delete(e)}async getArrayBufferAsync(e){const t=this.backend,{gl:r}=t,n=e.isInterleavedBufferAttribute?e.data:e,{bufferGPU:i}=t.get(n),s=e.array,o=s.byteLength;r.bindBuffer(r.COPY_READ_BUFFER,i);const a=r.createBuffer();r.bindBuffer(r.COPY_WRITE_BUFFER,a),r.bufferData(r.COPY_WRITE_BUFFER,o,r.STREAM_READ),r.copyBufferSubData(r.COPY_READ_BUFFER,r.COPY_WRITE_BUFFER,0,0,o),await t.utils._clientWaitAsync();const u=new e.array.constructor(s.length);return r.bindBuffer(r.COPY_WRITE_BUFFER,a),r.getBufferSubData(r.COPY_WRITE_BUFFER,0,u),r.deleteBuffer(a),r.bindBuffer(r.COPY_READ_BUFFER,null),r.bindBuffer(r.COPY_WRITE_BUFFER,null),u.buffer}_createBuffer(e,t,r,n){const i=e.createBuffer();return e.bindBuffer(t,i),e.bufferData(t,r,n),e.bindBuffer(t,null),i}}class bT{constructor(e){this.backend=e,this.gl=this.backend.gl,this.enabled={},this.currentFlipSided=null,this.currentCullFace=null,this.currentProgram=null,this.currentBlendingEnabled=!1,this.currentBlending=null,this.currentBlendSrc=null,this.currentBlendDst=null,this.currentBlendSrcAlpha=null,this.currentBlendDstAlpha=null,this.currentPremultipledAlpha=null,this.currentPolygonOffsetFactor=null,this.currentPolygonOffsetUnits=null,this.currentColorMask=null,this.currentDepthFunc=null,this.currentDepthMask=null,this.currentStencilFunc=null,this.currentStencilRef=null,this.currentStencilFuncMask=null,this.currentStencilFail=null,this.currentStencilZFail=null,this.currentStencilZPass=null,this.currentStencilMask=null,this.currentLineWidth=null,this.currentClippingPlanes=0,this.currentVAO=null,this.currentIndex=null,this.currentBoundFramebuffers={},this.currentDrawbuffers=new WeakMap,this.maxTextures=this.gl.getParameter(this.gl.MAX_TEXTURE_IMAGE_UNITS),this.currentTextureSlot=null,this.currentBoundTextures={},this.currentBoundBufferBases={},this._init()}_init(){const e=this.gl;pT={[pe]:e.FUNC_ADD,[Ze]:e.FUNC_SUBTRACT,[Qe]:e.FUNC_REVERSE_SUBTRACT},fT={[fe]:e.ZERO,[ut]:e.ONE,[at]:e.SRC_COLOR,[ot]:e.SRC_ALPHA,[st]:e.SRC_ALPHA_SATURATE,[it]:e.DST_COLOR,[nt]:e.DST_ALPHA,[rt]:e.ONE_MINUS_SRC_COLOR,[tt]:e.ONE_MINUS_SRC_ALPHA,[et]:e.ONE_MINUS_DST_COLOR,[Je]:e.ONE_MINUS_DST_ALPHA};const t=e.getParameter(e.SCISSOR_BOX),r=e.getParameter(e.VIEWPORT);this.currentScissor=(new E).fromArray(t),this.currentViewport=(new E).fromArray(r),this._tempVec4=new E}enable(e){const{enabled:t}=this;!0!==t[e]&&(this.gl.enable(e),t[e]=!0)}disable(e){const{enabled:t}=this;!1!==t[e]&&(this.gl.disable(e),t[e]=!1)}setFlipSided(e){if(this.currentFlipSided!==e){const{gl:t}=this;e?t.frontFace(t.CW):t.frontFace(t.CCW),this.currentFlipSided=e}}setCullFace(e){const{gl:t}=this;e!==lt?(this.enable(t.CULL_FACE),e!==this.currentCullFace&&(e===ct?t.cullFace(t.BACK):e===ht?t.cullFace(t.FRONT):t.cullFace(t.FRONT_AND_BACK))):this.disable(t.CULL_FACE),this.currentCullFace=e}setLineWidth(e){const{currentLineWidth:t,gl:r}=this;e!==t&&(r.lineWidth(e),this.currentLineWidth=e)}setBlending(e,t,r,n,i,s,o,a){const{gl:u}=this;if(e!==dt){if(!1===this.currentBlendingEnabled&&(this.enable(u.BLEND),this.currentBlendingEnabled=!0),e===de)i=i||t,s=s||r,o=o||n,t===this.currentBlendEquation&&i===this.currentBlendEquationAlpha||(u.blendEquationSeparate(pT[t],pT[i]),this.currentBlendEquation=t,this.currentBlendEquationAlpha=i),r===this.currentBlendSrc&&n===this.currentBlendDst&&s===this.currentBlendSrcAlpha&&o===this.currentBlendDstAlpha||(u.blendFuncSeparate(fT[r],fT[n],fT[s],fT[o]),this.currentBlendSrc=r,this.currentBlendDst=n,this.currentBlendSrcAlpha=s,this.currentBlendDstAlpha=o),this.currentBlending=e,this.currentPremultipledAlpha=!1;else if(e!==this.currentBlending||a!==this.currentPremultipledAlpha){if(this.currentBlendEquation===pe&&this.currentBlendEquationAlpha===pe||(u.blendEquation(u.FUNC_ADD),this.currentBlendEquation=pe,this.currentBlendEquationAlpha=pe),a)switch(e){case ee:u.blendFuncSeparate(u.ONE,u.ONE_MINUS_SRC_ALPHA,u.ONE,u.ONE_MINUS_SRC_ALPHA);break;case gt:u.blendFunc(u.ONE,u.ONE);break;case ft:u.blendFuncSeparate(u.ZERO,u.ONE_MINUS_SRC_COLOR,u.ZERO,u.ONE);break;case pt:u.blendFuncSeparate(u.ZERO,u.SRC_COLOR,u.ZERO,u.SRC_ALPHA)}else switch(e){case ee:u.blendFuncSeparate(u.SRC_ALPHA,u.ONE_MINUS_SRC_ALPHA,u.ONE,u.ONE_MINUS_SRC_ALPHA);break;case gt:u.blendFunc(u.SRC_ALPHA,u.ONE);break;case ft:u.blendFuncSeparate(u.ZERO,u.ONE_MINUS_SRC_COLOR,u.ZERO,u.ONE);break;case pt:u.blendFunc(u.ZERO,u.SRC_COLOR)}this.currentBlendSrc=null,this.currentBlendDst=null,this.currentBlendSrcAlpha=null,this.currentBlendDstAlpha=null,this.currentBlending=e,this.currentPremultipledAlpha=a}}else!0===this.currentBlendingEnabled&&(this.disable(u.BLEND),this.currentBlendingEnabled=!1)}setColorMask(e){this.currentColorMask!==e&&(this.gl.colorMask(e,e,e,e),this.currentColorMask=e)}setDepthTest(e){const{gl:t}=this;e?this.enable(t.DEPTH_TEST):this.disable(t.DEPTH_TEST)}setDepthMask(e){this.currentDepthMask!==e&&(this.gl.depthMask(e),this.currentDepthMask=e)}setDepthFunc(e){if(this.currentDepthFunc!==e){const{gl:t}=this;switch(e){case wt:t.depthFunc(t.NEVER);break;case Tt:t.depthFunc(t.ALWAYS);break;case xt:t.depthFunc(t.LESS);break;case vt:t.depthFunc(t.LEQUAL);break;case _t:t.depthFunc(t.EQUAL);break;case bt:t.depthFunc(t.GEQUAL);break;case yt:t.depthFunc(t.GREATER);break;case mt:t.depthFunc(t.NOTEQUAL);break;default:t.depthFunc(t.LEQUAL)}this.currentDepthFunc=e}}scissor(e,t,r,n){const i=this._tempVec4.set(e,t,r,n);if(!1===this.currentScissor.equals(i)){const{gl:e}=this;e.scissor(i.x,i.y,i.z,i.w),this.currentScissor.copy(i)}}viewport(e,t,r,n){const i=this._tempVec4.set(e,t,r,n);if(!1===this.currentViewport.equals(i)){const{gl:e}=this;e.viewport(i.x,i.y,i.z,i.w),this.currentViewport.copy(i)}}setScissorTest(e){const t=this.gl;e?t.enable(t.SCISSOR_TEST):t.disable(t.SCISSOR_TEST)}setStencilTest(e){const{gl:t}=this;e?this.enable(t.STENCIL_TEST):this.disable(t.STENCIL_TEST)}setStencilMask(e){this.currentStencilMask!==e&&(this.gl.stencilMask(e),this.currentStencilMask=e)}setStencilFunc(e,t,r){this.currentStencilFunc===e&&this.currentStencilRef===t&&this.currentStencilFuncMask===r||(this.gl.stencilFunc(e,t,r),this.currentStencilFunc=e,this.currentStencilRef=t,this.currentStencilFuncMask=r)}setStencilOp(e,t,r){this.currentStencilFail===e&&this.currentStencilZFail===t&&this.currentStencilZPass===r||(this.gl.stencilOp(e,t,r),this.currentStencilFail=e,this.currentStencilZFail=t,this.currentStencilZPass=r)}setMaterial(e,t,r){const{gl:n}=this;e.side===k?this.disable(n.CULL_FACE):this.enable(n.CULL_FACE);let i=e.side===L;t&&(i=!i),this.setFlipSided(i),e.blending===ee&&!1===e.transparent?this.setBlending(dt):this.setBlending(e.blending,e.blendEquation,e.blendSrc,e.blendDst,e.blendEquationAlpha,e.blendSrcAlpha,e.blendDstAlpha,e.premultipliedAlpha),this.setDepthFunc(e.depthFunc),this.setDepthTest(e.depthTest),this.setDepthMask(e.depthWrite),this.setColorMask(e.colorWrite);const s=e.stencilWrite;if(this.setStencilTest(s),s&&(this.setStencilMask(e.stencilWriteMask),this.setStencilFunc(e.stencilFunc,e.stencilRef,e.stencilFuncMask),this.setStencilOp(e.stencilFail,e.stencilZFail,e.stencilZPass)),this.setPolygonOffset(e.polygonOffset,e.polygonOffsetFactor,e.polygonOffsetUnits),!0===e.alphaToCoverage&&this.backend.renderer.samples>1?this.enable(n.SAMPLE_ALPHA_TO_COVERAGE):this.disable(n.SAMPLE_ALPHA_TO_COVERAGE),r>0&&this.currentClippingPlanes!==r){const e=12288;for(let t=0;t<8;t++)t<r?this.enable(e+t):this.disable(e+t)}}setPolygonOffset(e,t,r){const{gl:n}=this;e?(this.enable(n.POLYGON_OFFSET_FILL),this.currentPolygonOffsetFactor===t&&this.currentPolygonOffsetUnits===r||(n.polygonOffset(t,r),this.currentPolygonOffsetFactor=t,this.currentPolygonOffsetUnits=r)):this.disable(n.POLYGON_OFFSET_FILL)}useProgram(e){return this.currentProgram!==e&&(this.gl.useProgram(e),this.currentProgram=e,!0)}setVertexState(e,t=null){const r=this.gl;return(this.currentVAO!==e||this.currentIndex!==t)&&(r.bindVertexArray(e),null!==t&&r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,t),this.currentVAO=e,this.currentIndex=t,!0)}resetVertexState(){const e=this.gl;e.bindVertexArray(null),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null),this.currentVAO=null,this.currentIndex=null}bindFramebuffer(e,t){const{gl:r,currentBoundFramebuffers:n}=this;return n[e]!==t&&(r.bindFramebuffer(e,t),n[e]=t,e===r.DRAW_FRAMEBUFFER&&(n[r.FRAMEBUFFER]=t),e===r.FRAMEBUFFER&&(n[r.DRAW_FRAMEBUFFER]=t),!0)}drawBuffers(e,t){const{gl:r}=this;let n=[],i=!1;if(null!==e.textures){n=this.currentDrawbuffers.get(t),void 0===n&&(n=[],this.currentDrawbuffers.set(t,n));const s=e.textures;if(n.length!==s.length||n[0]!==r.COLOR_ATTACHMENT0){for(let e=0,t=s.length;e<t;e++)n[e]=r.COLOR_ATTACHMENT0+e;n.length=s.length,i=!0}}else n[0]!==r.BACK&&(n[0]=r.BACK,i=!0);i&&r.drawBuffers(n)}activeTexture(e){const{gl:t,currentTextureSlot:r,maxTextures:n}=this;void 0===e&&(e=t.TEXTURE0+n-1),r!==e&&(t.activeTexture(e),this.currentTextureSlot=e)}bindTexture(e,t,r){const{gl:n,currentTextureSlot:i,currentBoundTextures:s,maxTextures:o}=this;void 0===r&&(r=null===i?n.TEXTURE0+o-1:i);let a=s[r];void 0===a&&(a={type:void 0,texture:void 0},s[r]=a),a.type===e&&a.texture===t||(i!==r&&(n.activeTexture(r),this.currentTextureSlot=r),n.bindTexture(e,t),a.type=e,a.texture=t)}bindBufferBase(e,t,r){const{gl:n}=this,i=`${e}-${t}`;return this.currentBoundBufferBases[i]!==r&&(n.bindBufferBase(e,t,r),this.currentBoundBufferBases[i]=r,!0)}unbindTexture(){const{gl:e,currentTextureSlot:t,currentBoundTextures:r}=this,n=r[t];void 0!==n&&void 0!==n.type&&(e.bindTexture(n.type,null),n.type=void 0,n.texture=void 0)}}class _T{constructor(e){this.backend=e,this.gl=this.backend.gl,this.extensions=e.extensions}convert(e,t=Ke){const{gl:r,extensions:n}=this;let i;const s=qe.getTransfer(t);if(e===oe)return r.UNSIGNED_BYTE;if(e===St)return r.UNSIGNED_SHORT_4_4_4_4;if(e===Nt)return r.UNSIGNED_SHORT_5_5_5_1;if(e===Et)return r.UNSIGNED_INT_5_9_9_9_REV;if(e===Ct)return r.BYTE;if(e===At)return r.SHORT;if(e===Mt)return r.UNSIGNED_SHORT;if(e===Me)return r.INT;if(e===ue)return r.UNSIGNED_INT;if(e===Ye)return r.FLOAT;if(e===w)return r.HALF_FLOAT;if(e===Rt)return r.ALPHA;if(e===Pt)return r.RGB;if(e===D)return r.RGBA;if(e===ce)return r.DEPTH_COMPONENT;if(e===le)return r.DEPTH_STENCIL;if(e===Dt)return r.RED;if(e===Ft)return r.RED_INTEGER;if(e===Ot)return r.RG;if(e===Lt)return r.RG_INTEGER;if(e===Bt)return r.RGBA_INTEGER;if(e===kt||e===It||e===Ut||e===Vt)if(s===Xe){if(i=n.get("WEBGL_compressed_texture_s3tc_srgb"),null===i)return null;if(e===kt)return i.COMPRESSED_SRGB_S3TC_DXT1_EXT;if(e===It)return i.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;if(e===Ut)return i.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;if(e===Vt)return i.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT}else{if(i=n.get("WEBGL_compressed_texture_s3tc"),null===i)return null;if(e===kt)return i.COMPRESSED_RGB_S3TC_DXT1_EXT;if(e===It)return i.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(e===Ut)return i.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(e===Vt)return i.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(e===jt||e===Gt||e===zt||e===$t){if(i=n.get("WEBGL_compressed_texture_pvrtc"),null===i)return null;if(e===jt)return i.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(e===Gt)return i.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(e===zt)return i.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(e===$t)return i.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(e===Ht||e===Wt||e===qt){if(i=n.get("WEBGL_compressed_texture_etc"),null===i)return null;if(e===Ht||e===Wt)return s===Xe?i.COMPRESSED_SRGB8_ETC2:i.COMPRESSED_RGB8_ETC2;if(e===qt)return s===Xe?i.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:i.COMPRESSED_RGBA8_ETC2_EAC}if(e===Xt||e===Kt||e===Yt||e===Qt||e===Zt||e===Jt||e===er||e===tr||e===rr||e===nr||e===ir||e===sr||e===or||e===ar){if(i=n.get("WEBGL_compressed_texture_astc"),null===i)return null;if(e===Xt)return s===Xe?i.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR:i.COMPRESSED_RGBA_ASTC_4x4_KHR;if(e===Kt)return s===Xe?i.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR:i.COMPRESSED_RGBA_ASTC_5x4_KHR;if(e===Yt)return s===Xe?i.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR:i.COMPRESSED_RGBA_ASTC_5x5_KHR;if(e===Qt)return s===Xe?i.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR:i.COMPRESSED_RGBA_ASTC_6x5_KHR;if(e===Zt)return s===Xe?i.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR:i.COMPRESSED_RGBA_ASTC_6x6_KHR;if(e===Jt)return s===Xe?i.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR:i.COMPRESSED_RGBA_ASTC_8x5_KHR;if(e===er)return s===Xe?i.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR:i.COMPRESSED_RGBA_ASTC_8x6_KHR;if(e===tr)return s===Xe?i.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR:i.COMPRESSED_RGBA_ASTC_8x8_KHR;if(e===rr)return s===Xe?i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR:i.COMPRESSED_RGBA_ASTC_10x5_KHR;if(e===nr)return s===Xe?i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR:i.COMPRESSED_RGBA_ASTC_10x6_KHR;if(e===ir)return s===Xe?i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR:i.COMPRESSED_RGBA_ASTC_10x8_KHR;if(e===sr)return s===Xe?i.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR:i.COMPRESSED_RGBA_ASTC_10x10_KHR;if(e===or)return s===Xe?i.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR:i.COMPRESSED_RGBA_ASTC_12x10_KHR;if(e===ar)return s===Xe?i.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR:i.COMPRESSED_RGBA_ASTC_12x12_KHR}if(e===ur){if(i=n.get("EXT_texture_compression_bptc"),null===i)return null;if(e===ur)return s===Xe?i.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT:i.COMPRESSED_RGBA_BPTC_UNORM_EXT}if(e===lr||e===cr||e===hr||e===dr){if(i=n.get("EXT_texture_compression_rgtc"),null===i)return null;if(e===ur)return i.COMPRESSED_RED_RGTC1_EXT;if(e===cr)return i.COMPRESSED_SIGNED_RED_RGTC1_EXT;if(e===hr)return i.COMPRESSED_RED_GREEN_RGTC2_EXT;if(e===dr)return i.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT}return e===ae?r.UNSIGNED_INT_24_8:void 0!==r[e]?r[e]:null}_clientWaitAsync(){const{gl:e}=this,t=e.fenceSync(e.SYNC_GPU_COMMANDS_COMPLETE,0);return e.flush(),new Promise(((r,n)=>{!function i(){const s=e.clientWaitSync(t,e.SYNC_FLUSH_COMMANDS_BIT,0);if(s===e.WAIT_FAILED)return e.deleteSync(t),void n();s!==e.TIMEOUT_EXPIRED?(e.deleteSync(t),r()):requestAnimationFrame(i)}()}))}}let vT,xT,TT,wT=!1;class ST{constructor(e){this.backend=e,this.gl=e.gl,this.extensions=e.extensions,this.defaultTextures={},!1===wT&&(this._init(),wT=!0)}_init(){const e=this.gl;vT={[De]:e.REPEAT,[Pe]:e.CLAMP_TO_EDGE,[Re]:e.MIRRORED_REPEAT},xT={[ke]:e.NEAREST,[Be]:e.NEAREST_MIPMAP_NEAREST,[Le]:e.NEAREST_MIPMAP_LINEAR,[R]:e.LINEAR,[Oe]:e.LINEAR_MIPMAP_NEAREST,[Fe]:e.LINEAR_MIPMAP_LINEAR},TT={[He]:e.NEVER,[$e]:e.ALWAYS,[ze]:e.LESS,[Ge]:e.LEQUAL,[je]:e.EQUAL,[Ve]:e.GEQUAL,[Ue]:e.GREATER,[Ie]:e.NOTEQUAL}}getGLTextureType(e){const{gl:t}=this;let r;return r=!0===e.isCubeTexture?t.TEXTURE_CUBE_MAP:!0===e.isArrayTexture||!0===e.isDataArrayTexture||!0===e.isCompressedArrayTexture?t.TEXTURE_2D_ARRAY:!0===e.isData3DTexture?t.TEXTURE_3D:t.TEXTURE_2D,r}getInternalFormat(e,t,r,n,i=!1){const{gl:s,extensions:o}=this;if(null!==e&&void 0!==s[e])return s[e];let a=t;if(t===s.RED&&(r===s.FLOAT&&(a=s.R32F),r===s.HALF_FLOAT&&(a=s.R16F),r===s.UNSIGNED_BYTE&&(a=s.R8),r===s.UNSIGNED_SHORT&&(a=s.R16),r===s.UNSIGNED_INT&&(a=s.R32UI),r===s.BYTE&&(a=s.R8I),r===s.SHORT&&(a=s.R16I),r===s.INT&&(a=s.R32I)),t===s.RED_INTEGER&&(r===s.UNSIGNED_BYTE&&(a=s.R8UI),r===s.UNSIGNED_SHORT&&(a=s.R16UI),r===s.UNSIGNED_INT&&(a=s.R32UI),r===s.BYTE&&(a=s.R8I),r===s.SHORT&&(a=s.R16I),r===s.INT&&(a=s.R32I)),t===s.RG&&(r===s.FLOAT&&(a=s.RG32F),r===s.HALF_FLOAT&&(a=s.RG16F),r===s.UNSIGNED_BYTE&&(a=s.RG8),r===s.UNSIGNED_SHORT&&(a=s.RG16),r===s.UNSIGNED_INT&&(a=s.RG32UI),r===s.BYTE&&(a=s.RG8I),r===s.SHORT&&(a=s.RG16I),r===s.INT&&(a=s.RG32I)),t===s.RG_INTEGER&&(r===s.UNSIGNED_BYTE&&(a=s.RG8UI),r===s.UNSIGNED_SHORT&&(a=s.RG16UI),r===s.UNSIGNED_INT&&(a=s.RG32UI),r===s.BYTE&&(a=s.RG8I),r===s.SHORT&&(a=s.RG16I),r===s.INT&&(a=s.RG32I)),t===s.RGB){const e=i?We:qe.getTransfer(n);r===s.FLOAT&&(a=s.RGB32F),r===s.HALF_FLOAT&&(a=s.RGB16F),r===s.UNSIGNED_BYTE&&(a=s.RGB8),r===s.UNSIGNED_SHORT&&(a=s.RGB16),r===s.UNSIGNED_INT&&(a=s.RGB32UI),r===s.BYTE&&(a=s.RGB8I),r===s.SHORT&&(a=s.RGB16I),r===s.INT&&(a=s.RGB32I),r===s.UNSIGNED_BYTE&&(a=e===Xe?s.SRGB8:s.RGB8),r===s.UNSIGNED_SHORT_5_6_5&&(a=s.RGB565),r===s.UNSIGNED_SHORT_5_5_5_1&&(a=s.RGB5_A1),r===s.UNSIGNED_SHORT_4_4_4_4&&(a=s.RGB4),r===s.UNSIGNED_INT_5_9_9_9_REV&&(a=s.RGB9_E5)}if(t===s.RGB_INTEGER&&(r===s.UNSIGNED_BYTE&&(a=s.RGB8UI),r===s.UNSIGNED_SHORT&&(a=s.RGB16UI),r===s.UNSIGNED_INT&&(a=s.RGB32UI),r===s.BYTE&&(a=s.RGB8I),r===s.SHORT&&(a=s.RGB16I),r===s.INT&&(a=s.RGB32I)),t===s.RGBA){const e=i?We:qe.getTransfer(n);r===s.FLOAT&&(a=s.RGBA32F),r===s.HALF_FLOAT&&(a=s.RGBA16F),r===s.UNSIGNED_BYTE&&(a=s.RGBA8),r===s.UNSIGNED_SHORT&&(a=s.RGBA16),r===s.UNSIGNED_INT&&(a=s.RGBA32UI),r===s.BYTE&&(a=s.RGBA8I),r===s.SHORT&&(a=s.RGBA16I),r===s.INT&&(a=s.RGBA32I),r===s.UNSIGNED_BYTE&&(a=e===Xe?s.SRGB8_ALPHA8:s.RGBA8),r===s.UNSIGNED_SHORT_4_4_4_4&&(a=s.RGBA4),r===s.UNSIGNED_SHORT_5_5_5_1&&(a=s.RGB5_A1)}return t===s.RGBA_INTEGER&&(r===s.UNSIGNED_BYTE&&(a=s.RGBA8UI),r===s.UNSIGNED_SHORT&&(a=s.RGBA16UI),r===s.UNSIGNED_INT&&(a=s.RGBA32UI),r===s.BYTE&&(a=s.RGBA8I),r===s.SHORT&&(a=s.RGBA16I),r===s.INT&&(a=s.RGBA32I)),t===s.DEPTH_COMPONENT&&(r===s.UNSIGNED_SHORT&&(a=s.DEPTH_COMPONENT16),r===s.UNSIGNED_INT&&(a=s.DEPTH_COMPONENT24),r===s.FLOAT&&(a=s.DEPTH_COMPONENT32F)),t===s.DEPTH_STENCIL&&r===s.UNSIGNED_INT_24_8&&(a=s.DEPTH24_STENCIL8),a!==s.R16F&&a!==s.R32F&&a!==s.RG16F&&a!==s.RG32F&&a!==s.RGBA16F&&a!==s.RGBA32F||o.get("EXT_color_buffer_float"),a}setTextureParameters(e,t){const{gl:r,extensions:n,backend:i}=this,s=qe.getPrimaries(qe.workingColorSpace),o=t.colorSpace===Ke?null:qe.getPrimaries(t.colorSpace),a=t.colorSpace===Ke||s===o?r.NONE:r.BROWSER_DEFAULT_WEBGL;r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,t.flipY),r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t.premultiplyAlpha),r.pixelStorei(r.UNPACK_ALIGNMENT,t.unpackAlignment),r.pixelStorei(r.UNPACK_COLORSPACE_CONVERSION_WEBGL,a),r.texParameteri(e,r.TEXTURE_WRAP_S,vT[t.wrapS]),r.texParameteri(e,r.TEXTURE_WRAP_T,vT[t.wrapT]),e!==r.TEXTURE_3D&&e!==r.TEXTURE_2D_ARRAY||t.isArrayTexture||r.texParameteri(e,r.TEXTURE_WRAP_R,vT[t.wrapR]),r.texParameteri(e,r.TEXTURE_MAG_FILTER,xT[t.magFilter]);const u=void 0!==t.mipmaps&&t.mipmaps.length>0,l=t.minFilter===R&&u?Fe:t.minFilter;if(r.texParameteri(e,r.TEXTURE_MIN_FILTER,xT[l]),t.compareFunction&&(r.texParameteri(e,r.TEXTURE_COMPARE_MODE,r.COMPARE_REF_TO_TEXTURE),r.texParameteri(e,r.TEXTURE_COMPARE_FUNC,TT[t.compareFunction])),!0===n.has("EXT_texture_filter_anisotropic")){if(t.magFilter===ke)return;if(t.minFilter!==Le&&t.minFilter!==Fe)return;if(t.type===Ye&&!1===n.has("OES_texture_float_linear"))return;if(t.anisotropy>1){const s=n.get("EXT_texture_filter_anisotropic");r.texParameterf(e,s.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(t.anisotropy,i.getMaxAnisotropy()))}}}createDefaultTexture(e){const{gl:t,backend:r,defaultTextures:n}=this,i=this.getGLTextureType(e);let s=n[i];void 0===s&&(s=t.createTexture(),r.state.bindTexture(i,s),t.texParameteri(i,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(i,t.TEXTURE_MAG_FILTER,t.NEAREST),n[i]=s),r.set(e,{textureGPU:s,glTextureType:i,isDefault:!0})}createTexture(e,t){const{gl:r,backend:n}=this,{levels:i,width:s,height:o,depth:a}=t,u=n.utils.convert(e.format,e.colorSpace),l=n.utils.convert(e.type),c=this.getInternalFormat(e.internalFormat,u,l,e.colorSpace,e.isVideoTexture),h=r.createTexture(),d=this.getGLTextureType(e);n.state.bindTexture(d,h),this.setTextureParameters(d,e),e.isArrayTexture||e.isDataArrayTexture||e.isCompressedArrayTexture?r.texStorage3D(r.TEXTURE_2D_ARRAY,i,c,s,o,a):e.isData3DTexture?r.texStorage3D(r.TEXTURE_3D,i,c,s,o,a):e.isVideoTexture||r.texStorage2D(d,i,c,s,o),n.set(e,{textureGPU:h,glTextureType:d,glFormat:u,glType:l,glInternalFormat:c})}copyBufferToTexture(e,t){const{gl:r,backend:n}=this,{textureGPU:i,glTextureType:s,glFormat:o,glType:a}=n.get(t),{width:u,height:l}=t.source.data;r.bindBuffer(r.PIXEL_UNPACK_BUFFER,e),n.state.bindTexture(s,i),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,!1),r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),r.texSubImage2D(s,0,0,0,u,l,o,a,0),r.bindBuffer(r.PIXEL_UNPACK_BUFFER,null),n.state.unbindTexture()}updateTexture(e,t){const{gl:r}=this,{width:n,height:i}=t,{textureGPU:s,glTextureType:o,glFormat:a,glType:u,glInternalFormat:l}=this.backend.get(e);if(!e.isRenderTargetTexture&&void 0!==s)if(this.backend.state.bindTexture(o,s),this.setTextureParameters(o,e),e.isCompressedTexture){const n=e.mipmaps,i=t.image;for(let t=0;t<n.length;t++){const s=n[t];e.isCompressedArrayTexture?e.format!==r.RGBA?null!==a&&r.compressedTexSubImage3D(r.TEXTURE_2D_ARRAY,t,0,0,0,s.width,s.height,i.depth,a,s.data):r.texSubImage3D(r.TEXTURE_2D_ARRAY,t,0,0,0,s.width,s.height,i.depth,a,u,s.data):null!==a&&r.compressedTexSubImage2D(r.TEXTURE_2D,t,0,0,s.width,s.height,a,s.data)}}else if(e.isCubeTexture){const e=t.images;for(let t=0;t<6;t++){const s=NT(e[t]);r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,0,0,n,i,a,u,s)}}else if(e.isDataArrayTexture||e.isArrayTexture){const e=t.image;r.texSubImage3D(r.TEXTURE_2D_ARRAY,0,0,0,0,e.width,e.height,e.depth,a,u,e.data)}else if(e.isData3DTexture){const e=t.image;r.texSubImage3D(r.TEXTURE_3D,0,0,0,0,e.width,e.height,e.depth,a,u,e.data)}else if(e.isVideoTexture)e.update(),r.texImage2D(o,0,l,a,u,t.image);else{const e=NT(t.image);r.texSubImage2D(o,0,0,0,n,i,a,u,e)}}generateMipmaps(e){const{gl:t,backend:r}=this,{textureGPU:n,glTextureType:i}=r.get(e);r.state.bindTexture(i,n),t.generateMipmap(i)}deallocateRenderBuffers(e){const{gl:t,backend:r}=this;if(e){const n=r.get(e);if(n.renderBufferStorageSetup=void 0,n.framebuffers){for(const e in n.framebuffers)t.deleteFramebuffer(n.framebuffers[e]);delete n.framebuffers}if(n.depthRenderbuffer&&(t.deleteRenderbuffer(n.depthRenderbuffer),delete n.depthRenderbuffer),n.stencilRenderbuffer&&(t.deleteRenderbuffer(n.stencilRenderbuffer),delete n.stencilRenderbuffer),n.msaaFrameBuffer&&(t.deleteFramebuffer(n.msaaFrameBuffer),delete n.msaaFrameBuffer),n.msaaRenderbuffers){for(let e=0;e<n.msaaRenderbuffers.length;e++)t.deleteRenderbuffer(n.msaaRenderbuffers[e]);delete n.msaaRenderbuffers}}}destroyTexture(e){const{gl:t,backend:r}=this,{textureGPU:n,renderTarget:i}=r.get(e);this.deallocateRenderBuffers(i),t.deleteTexture(n),r.delete(e)}copyTextureToTexture(e,t,r=null,n=null,i=0,s=0){const{gl:o,backend:a}=this,{state:u}=this.backend,{textureGPU:l,glTextureType:c,glType:h,glFormat:d}=a.get(t);let p,f,g,m,y,b,_,v,x;u.bindTexture(c,l);const T=e.isCompressedTexture?e.mipmaps[s]:e.image;if(null!==r)p=r.max.x-r.min.x,f=r.max.y-r.min.y,g=r.isBox3?r.max.z-r.min.z:1,m=r.min.x,y=r.min.y,b=r.isBox3?r.min.z:0;else{const t=Math.pow(2,-i);p=Math.floor(T.width*t),f=Math.floor(T.height*t),g=e.isDataArrayTexture||e.isArrayTexture?T.depth:e.isData3DTexture?Math.floor(T.depth*t):1,m=0,y=0,b=0}null!==n?(_=n.x,v=n.y,x=n.z):(_=0,v=0,x=0),o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,t.flipY),o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t.premultiplyAlpha),o.pixelStorei(o.UNPACK_ALIGNMENT,t.unpackAlignment);const w=o.getParameter(o.UNPACK_ROW_LENGTH),S=o.getParameter(o.UNPACK_IMAGE_HEIGHT),N=o.getParameter(o.UNPACK_SKIP_PIXELS),E=o.getParameter(o.UNPACK_SKIP_ROWS),C=o.getParameter(o.UNPACK_SKIP_IMAGES);o.pixelStorei(o.UNPACK_ROW_LENGTH,T.width),o.pixelStorei(o.UNPACK_IMAGE_HEIGHT,T.height),o.pixelStorei(o.UNPACK_SKIP_PIXELS,m),o.pixelStorei(o.UNPACK_SKIP_ROWS,y),o.pixelStorei(o.UNPACK_SKIP_IMAGES,b);const A=t.isDataArrayTexture||t.isData3DTexture||t.isArrayTexture;if(e.isRenderTargetTexture||e.isDepthTexture){const r=a.get(e),n=a.get(t),i=a.get(r.renderTarget),s=a.get(n.renderTarget),l=i.framebuffers[r.cacheKey],c=s.framebuffers[n.cacheKey];u.bindFramebuffer(o.READ_FRAMEBUFFER,l),u.bindFramebuffer(o.DRAW_FRAMEBUFFER,c);let h=o.COLOR_BUFFER_BIT;e.isDepthTexture&&(h=o.DEPTH_BUFFER_BIT),o.blitFramebuffer(m,y,p,f,_,v,p,f,h,o.NEAREST),u.bindFramebuffer(o.READ_FRAMEBUFFER,null),u.bindFramebuffer(o.DRAW_FRAMEBUFFER,null)}else A?e.isDataTexture||e.isData3DTexture?o.texSubImage3D(c,s,_,v,x,p,f,g,d,h,T.data):t.isCompressedArrayTexture?o.compressedTexSubImage3D(c,s,_,v,x,p,f,g,d,T.data):o.texSubImage3D(c,s,_,v,x,p,f,g,d,h,T):e.isDataTexture?o.texSubImage2D(c,s,_,v,p,f,d,h,T.data):e.isCompressedTexture?o.compressedTexSubImage2D(c,s,_,v,T.width,T.height,d,T.data):o.texSubImage2D(c,s,_,v,p,f,d,h,T);o.pixelStorei(o.UNPACK_ROW_LENGTH,w),o.pixelStorei(o.UNPACK_IMAGE_HEIGHT,S),o.pixelStorei(o.UNPACK_SKIP_PIXELS,N),o.pixelStorei(o.UNPACK_SKIP_ROWS,E),o.pixelStorei(o.UNPACK_SKIP_IMAGES,C),0===s&&t.generateMipmaps&&o.generateMipmap(c),u.unbindTexture()}copyFramebufferToTexture(e,t,r){const{gl:n}=this,{state:i}=this.backend,{textureGPU:s}=this.backend.get(e),{x:o,y:a,z:u,w:l}=r,c=!0===e.isDepthTexture||t.renderTarget&&t.renderTarget.samples>0,h=t.renderTarget?t.renderTarget.height:this.backend.getDrawingBufferSize().y;if(c){const r=0!==o||0!==a;let c,d;if(!0===e.isDepthTexture?(c=n.DEPTH_BUFFER_BIT,d=n.DEPTH_ATTACHMENT,t.stencil&&(c|=n.STENCIL_BUFFER_BIT)):(c=n.COLOR_BUFFER_BIT,d=n.COLOR_ATTACHMENT0),r){const e=this.backend.get(t.renderTarget),r=e.framebuffers[t.getCacheKey()],d=e.msaaFrameBuffer;i.bindFramebuffer(n.DRAW_FRAMEBUFFER,r),i.bindFramebuffer(n.READ_FRAMEBUFFER,d);const p=h-a-l;n.blitFramebuffer(o,p,o+u,p+l,o,p,o+u,p+l,c,n.NEAREST),i.bindFramebuffer(n.READ_FRAMEBUFFER,r),i.bindTexture(n.TEXTURE_2D,s),n.copyTexSubImage2D(n.TEXTURE_2D,0,0,0,o,p,u,l),i.unbindTexture()}else{const e=n.createFramebuffer();i.bindFramebuffer(n.DRAW_FRAMEBUFFER,e),n.framebufferTexture2D(n.DRAW_FRAMEBUFFER,d,n.TEXTURE_2D,s,0),n.blitFramebuffer(0,0,u,l,0,0,u,l,c,n.NEAREST),n.deleteFramebuffer(e)}}else i.bindTexture(n.TEXTURE_2D,s),n.copyTexSubImage2D(n.TEXTURE_2D,0,0,0,o,h-l-a,u,l),i.unbindTexture();e.generateMipmaps&&this.generateMipmaps(e),this.backend._setFramebuffer(t)}setupRenderBufferStorage(e,t,r,n=!1){const{gl:i}=this,s=t.renderTarget,{depthTexture:o,depthBuffer:a,stencilBuffer:u,width:l,height:c}=s;if(i.bindRenderbuffer(i.RENDERBUFFER,e),a&&!u){let t=i.DEPTH_COMPONENT24;if(!0===n){this.extensions.get("WEBGL_multisampled_render_to_texture").renderbufferStorageMultisampleEXT(i.RENDERBUFFER,s.samples,t,l,c)}else r>0?(o&&o.isDepthTexture&&o.type===i.FLOAT&&(t=i.DEPTH_COMPONENT32F),i.renderbufferStorageMultisample(i.RENDERBUFFER,r,t,l,c)):i.renderbufferStorage(i.RENDERBUFFER,t,l,c);i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,e)}else a&&u&&(r>0?i.renderbufferStorageMultisample(i.RENDERBUFFER,r,i.DEPTH24_STENCIL8,l,c):i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_STENCIL,l,c),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,i.RENDERBUFFER,e))}async copyTextureToBuffer(e,t,r,n,i,s){const{backend:o,gl:a}=this,{textureGPU:u,glFormat:l,glType:c}=this.backend.get(e),h=a.createFramebuffer();a.bindFramebuffer(a.READ_FRAMEBUFFER,h);const d=e.isCubeTexture?a.TEXTURE_CUBE_MAP_POSITIVE_X+s:a.TEXTURE_2D;a.framebufferTexture2D(a.READ_FRAMEBUFFER,a.COLOR_ATTACHMENT0,d,u,0);const p=this._getTypedArrayType(c),f=n*i*this._getBytesPerTexel(c,l),g=a.createBuffer();a.bindBuffer(a.PIXEL_PACK_BUFFER,g),a.bufferData(a.PIXEL_PACK_BUFFER,f,a.STREAM_READ),a.readPixels(t,r,n,i,l,c,0),a.bindBuffer(a.PIXEL_PACK_BUFFER,null),await o.utils._clientWaitAsync();const m=new p(f/p.BYTES_PER_ELEMENT);return a.bindBuffer(a.PIXEL_PACK_BUFFER,g),a.getBufferSubData(a.PIXEL_PACK_BUFFER,0,m),a.bindBuffer(a.PIXEL_PACK_BUFFER,null),a.deleteFramebuffer(h),m}_getTypedArrayType(e){const{gl:t}=this;if(e===t.UNSIGNED_BYTE)return Uint8Array;if(e===t.UNSIGNED_SHORT_4_4_4_4)return Uint16Array;if(e===t.UNSIGNED_SHORT_5_5_5_1)return Uint16Array;if(e===t.UNSIGNED_SHORT_5_6_5)return Uint16Array;if(e===t.UNSIGNED_SHORT)return Uint16Array;if(e===t.UNSIGNED_INT)return Uint32Array;if(e===t.HALF_FLOAT)return Uint16Array;if(e===t.FLOAT)return Float32Array;throw new Error(`Unsupported WebGL type: ${e}`)}_getBytesPerTexel(e,t){const{gl:r}=this;let n=0;return e===r.UNSIGNED_BYTE&&(n=1),e!==r.UNSIGNED_SHORT_4_4_4_4&&e!==r.UNSIGNED_SHORT_5_5_5_1&&e!==r.UNSIGNED_SHORT_5_6_5&&e!==r.UNSIGNED_SHORT&&e!==r.HALF_FLOAT||(n=2),e!==r.UNSIGNED_INT&&e!==r.FLOAT||(n=4),t===r.RGBA?4*n:t===r.RGB?3*n:t===r.ALPHA?n:void 0}}function NT(e){return e.isDataTexture?e.image.data:"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas?e:e.data}class ET{constructor(e){this.backend=e,this.gl=this.backend.gl,this.availableExtensions=this.gl.getSupportedExtensions(),this.extensions={}}get(e){let t=this.extensions[e];return void 0===t&&(t=this.gl.getExtension(e),this.extensions[e]=t),t}has(e){return this.availableExtensions.includes(e)}}class CT{constructor(e){this.backend=e,this.maxAnisotropy=null}getMaxAnisotropy(){if(null!==this.maxAnisotropy)return this.maxAnisotropy;const e=this.backend.gl,t=this.backend.extensions;if(!0===t.has("EXT_texture_filter_anisotropic")){const r=t.get("EXT_texture_filter_anisotropic");this.maxAnisotropy=e.getParameter(r.MAX_TEXTURE_MAX_ANISOTROPY_EXT)}else this.maxAnisotropy=0;return this.maxAnisotropy}}const AT={WEBGL_multi_draw:"WEBGL_multi_draw",WEBGL_compressed_texture_astc:"texture-compression-astc",WEBGL_compressed_texture_etc:"texture-compression-etc2",WEBGL_compressed_texture_etc1:"texture-compression-etc1",WEBGL_compressed_texture_pvrtc:"texture-compression-pvrtc",WEBKIT_WEBGL_compressed_texture_pvrtc:"texture-compression-pvrtc",WEBGL_compressed_texture_s3tc:"texture-compression-bc",EXT_texture_compression_bptc:"texture-compression-bptc",EXT_disjoint_timer_query_webgl2:"timestamp-query",OVR_multiview2:"OVR_multiview2"};class MT{constructor(e){this.gl=e.gl,this.extensions=e.extensions,this.info=e.renderer.info,this.mode=null,this.index=0,this.type=null,this.object=null}render(e,t){const{gl:r,mode:n,object:i,type:s,info:o,index:a}=this;0!==a?r.drawElements(n,t,s,e):r.drawArrays(n,e,t),o.update(i,t,1)}renderInstances(e,t,r){const{gl:n,mode:i,type:s,index:o,object:a,info:u}=this;0!==r&&(0!==o?n.drawElementsInstanced(i,t,s,e,r):n.drawArraysInstanced(i,e,t,r),u.update(a,t,r))}renderMultiDraw(e,t,r){const{extensions:n,mode:i,object:s,info:o}=this;if(0===r)return;const a=n.get("WEBGL_multi_draw");if(null===a)for(let u=0;u<r;u++)this.render(e[u],t[u]);else{0!==this.index?a.multiDrawElementsWEBGL(i,t,0,this.type,e,0,r):a.multiDrawArraysWEBGL(i,e,0,t,0,r);let n=0;for(let e=0;e<r;e++)n+=t[e];o.update(s,n,1)}}renderMultiDrawInstances(e,t,r,n){const{extensions:i,mode:s,object:o,info:a}=this;if(0===r)return;const u=i.get("WEBGL_multi_draw");if(null===u)for(let l=0;l<r;l++)this.renderInstances(e[l],t[l],n[l]);else{0!==this.index?u.multiDrawElementsInstancedWEBGL(s,t,0,this.type,e,0,n,0,r):u.multiDrawArraysInstancedWEBGL(s,e,0,t,0,n,0,r);let i=0;for(let e=0;e<r;e++)i+=t[e]*n[e];a.update(o,i,1)}}}class RT{constructor(e=256){this.trackTimestamp=!0,this.maxQueries=e,this.currentQueryIndex=0,this.queryOffsets=new Map,this.isDisposed=!1,this.lastValue=0,this.pendingResolve=!1}allocateQueriesForContext(){}async resolveQueriesAsync(){}dispose(){}}class PT extends RT{constructor(e,t,r=2048){if(super(r),this.gl=e,this.type=t,this.ext=e.getExtension("EXT_disjoint_timer_query_webgl2")||e.getExtension("EXT_disjoint_timer_query"),this.ext){this.queries=[];for(let t=0;t<this.maxQueries;t++)this.queries.push(e.createQuery());this.activeQuery=null,this.queryStates=new Map}else this.trackTimestamp=!1}allocateQueriesForContext(e){if(!this.trackTimestamp)return null;if(this.currentQueryIndex+2>this.maxQueries)return Ee(`WebGPUTimestampQueryPool [${this.type}]: Maximum number of queries exceeded, when using trackTimestamp it is necessary to resolves the queries via renderer.resolveTimestampsAsync( THREE.TimestampQuery.${this.type.toUpperCase()} ).`),null;const t=this.currentQueryIndex;return this.currentQueryIndex+=2,this.queryStates.set(t,"inactive"),this.queryOffsets.set(e.id,t),t}beginQuery(e){if(!this.trackTimestamp||this.isDisposed)return;const t=this.queryOffsets.get(e.id);if(null==t)return;if(null!==this.activeQuery)return;const r=this.queries[t];if(r)try{"inactive"===this.queryStates.get(t)&&(this.gl.beginQuery(this.ext.TIME_ELAPSED_EXT,r),this.activeQuery=t,this.queryStates.set(t,"started"))}catch(n){this.activeQuery=null,this.queryStates.set(t,"inactive")}}endQuery(e){if(!this.trackTimestamp||this.isDisposed)return;const t=this.queryOffsets.get(e.id);if(null!=t&&this.activeQuery===t)try{this.gl.endQuery(this.ext.TIME_ELAPSED_EXT),this.queryStates.set(t,"ended"),this.activeQuery=null}catch(r){this.queryStates.set(t,"inactive"),this.activeQuery=null}}async resolveQueriesAsync(){if(!this.trackTimestamp||this.pendingResolve)return this.lastValue;this.pendingResolve=!0;try{const e=[];for(const[r,n]of this.queryStates)if("ended"===n){const t=this.queries[r];e.push(this.resolveQuery(t))}if(0===e.length)return this.lastValue;const t=(await Promise.all(e)).reduce(((e,t)=>e+t),0);return this.lastValue=t,this.currentQueryIndex=0,this.queryOffsets.clear(),this.queryStates.clear(),this.activeQuery=null,t}catch(e){return this.lastValue}finally{this.pendingResolve=!1}}async resolveQuery(e){return new Promise((t=>{if(this.isDisposed)return void t(this.lastValue);let r,n=!1;const i=e=>{n||(n=!0,r&&(clearTimeout(r),r=null),t(e))},s=()=>{if(this.isDisposed)i(this.lastValue);else try{if(this.gl.getParameter(this.ext.GPU_DISJOINT_EXT))return void i(this.lastValue);if(!this.gl.getQueryParameter(e,this.gl.QUERY_RESULT_AVAILABLE))return void(r=setTimeout(s,1));const n=this.gl.getQueryParameter(e,this.gl.QUERY_RESULT);t(Number(n)/1e6)}catch(n){t(this.lastValue)}};s()}))}dispose(){if(!this.isDisposed&&(this.isDisposed=!0,this.trackTimestamp)){for(const e of this.queries)this.gl.deleteQuery(e);this.queries=[],this.queryStates.clear(),this.queryOffsets.clear(),this.lastValue=0,this.activeQuery=null}}}const DT=new i;class FT extends dT{constructor(e={}){super(e),this.isWebGLBackend=!0,this.attributeUtils=null,this.extensions=null,this.capabilities=null,this.textureUtils=null,this.bufferRenderer=null,this.gl=null,this.state=null,this.utils=null,this.vaoCache={},this.transformFeedbackCache={},this.discard=!1,this.disjoint=null,this.parallel=null,this._currentContext=null,this._knownBindings=new WeakSet,this._supportsInvalidateFramebuffer="undefined"!=typeof navigator&&/OculusBrowser/g.test(navigator.userAgent),this._xrFramebuffer=null}init(e){super.init(e);const t=this.parameters,r={antialias:e.samples>0,alpha:!0,depth:e.depth,stencil:e.stencil},n=void 0!==t.context?t.context:e.domElement.getContext("webgl2",r);function i(t){t.preventDefault();const r={api:"WebGL",message:t.statusMessage||"Unknown reason",reason:null,originalEvent:t};e.onDeviceLost(r)}this._onContextLost=i,e.domElement.addEventListener("webglcontextlost",i,!1),this.gl=n,this.extensions=new ET(this),this.capabilities=new CT(this),this.attributeUtils=new yT(this),this.textureUtils=new ST(this),this.bufferRenderer=new MT(this),this.state=new bT(this),this.utils=new _T(this),this.extensions.get("EXT_color_buffer_float"),this.extensions.get("WEBGL_clip_cull_distance"),this.extensions.get("OES_texture_float_linear"),this.extensions.get("EXT_color_buffer_half_float"),this.extensions.get("WEBGL_multisampled_render_to_texture"),this.extensions.get("WEBGL_render_shared_exponent"),this.extensions.get("WEBGL_multi_draw"),this.extensions.get("OVR_multiview2"),this.disjoint=this.extensions.get("EXT_disjoint_timer_query_webgl2"),this.parallel=this.extensions.get("KHR_parallel_shader_compile")}get coordinateSystem(){return I}async getArrayBufferAsync(e){return await this.attributeUtils.getArrayBufferAsync(e)}async waitForGPU(){await this.utils._clientWaitAsync()}async makeXRCompatible(){!0!==this.gl.getContextAttributes().xrCompatible&&await this.gl.makeXRCompatible()}setXRTarget(e){this._xrFramebuffer=e}setXRRenderTargetTextures(e,t,r=null){const n=this.gl;if(this.set(e.texture,{textureGPU:t,glInternalFormat:n.RGBA8}),null!==r){const t=e.stencilBuffer?n.DEPTH24_STENCIL8:n.DEPTH_COMPONENT24;this.set(e.depthTexture,{textureGPU:r,glInternalFormat:t}),!0===this.extensions.has("WEBGL_multisampled_render_to_texture")&&!0===e.autoAllocateDepthBuffer&&e.multiview,e.autoAllocateDepthBuffer=!1}}initTimestampQuery(e){if(!this.disjoint||!this.trackTimestamp)return;const t=e.isComputeNode?"compute":"render";this.timestampQueryPool[t]||(this.timestampQueryPool[t]=new PT(this.gl,t,2048));const r=this.timestampQueryPool[t];null!==r.allocateQueriesForContext(e)&&r.beginQuery(e)}prepareTimestampBuffer(e){if(!this.disjoint||!this.trackTimestamp)return;const t=e.isComputeNode?"compute":"render";this.timestampQueryPool[t].endQuery(e)}getContext(){return this.gl}beginRender(e){const{state:t}=this,r=this.get(e);if(e.viewport)this.updateViewport(e);else{const{width:e,height:r}=this.getDrawingBufferSize(DT);t.viewport(0,0,e,r)}if(e.scissor){const{x:r,y:n,width:i,height:s}=e.scissorValue;t.scissor(r,e.height-s-n,i,s)}this.initTimestampQuery(e),r.previousContext=this._currentContext,this._currentContext=e,this._setFramebuffer(e),this.clear(e.clearColor,e.clearDepth,e.clearStencil,e,!1);const n=e.occlusionQueryCount;n>0&&(r.currentOcclusionQueries=r.occlusionQueries,r.currentOcclusionQueryObjects=r.occlusionQueryObjects,r.lastOcclusionObject=null,r.occlusionQueries=new Array(n),r.occlusionQueryObjects=new Array(n),r.occlusionQueryIndex=0)}finishRender(e){const{gl:t,state:r}=this,n=this.get(e),i=n.previousContext;r.resetVertexState();const s=e.occlusionQueryCount;s>0&&(s>n.occlusionQueryIndex&&t.endQuery(t.ANY_SAMPLES_PASSED),this.resolveOccludedAsync(e));const o=e.textures;if(null!==o)for(let a=0;a<o.length;a++){const e=o[a];e.generateMipmaps&&this.generateMipmaps(e)}if(this._currentContext=i,null!==e.textures&&e.renderTarget){const n=this.get(e.renderTarget),{resolveDepthBuffer:i,samples:s}=e.renderTarget;if(s>0&&!1===this._useMultisampledExtension(e.renderTarget)){const i=n.framebuffers[e.getCacheKey()],s=t.COLOR_BUFFER_BIT,o=n.msaaFrameBuffer,a=e.textures;r.bindFramebuffer(t.READ_FRAMEBUFFER,o),r.bindFramebuffer(t.DRAW_FRAMEBUFFER,i);for(let r=0;r<a.length;r++)if(e.scissor){const{x:r,y:i,width:o,height:a}=e.scissorValue,u=e.height-a-i;t.blitFramebuffer(r,u,r+o,u+a,r,u,r+o,u+a,s,t.NEAREST),!0===this._supportsInvalidateFramebuffer&&t.invalidateSubFramebuffer(t.READ_FRAMEBUFFER,n.invalidationArray,r,u,o,a)}else t.blitFramebuffer(0,0,e.width,e.height,0,0,e.width,e.height,s,t.NEAREST),!0===this._supportsInvalidateFramebuffer&&t.invalidateFramebuffer(t.READ_FRAMEBUFFER,n.invalidationArray)}else if(!1===i&&n.framebuffers){const i=n.framebuffers[e.getCacheKey()];r.bindFramebuffer(t.DRAW_FRAMEBUFFER,i),t.invalidateFramebuffer(t.DRAW_FRAMEBUFFER,n.depthInvalidationArray)}}if(null!==i)if(this._setFramebuffer(i),i.viewport)this.updateViewport(i);else{const{width:e,height:t}=this.getDrawingBufferSize(DT);r.viewport(0,0,e,t)}this.prepareTimestampBuffer(e)}resolveOccludedAsync(e){const t=this.get(e),{currentOcclusionQueries:r,currentOcclusionQueryObjects:n}=t;if(r&&n){const e=new WeakSet,{gl:i}=this;t.currentOcclusionQueryObjects=null,t.currentOcclusionQueries=null;const s=()=>{let o=0;for(let t=0;t<r.length;t++){const s=r[t];null!==s&&(i.getQueryParameter(s,i.QUERY_RESULT_AVAILABLE)&&(0===i.getQueryParameter(s,i.QUERY_RESULT)&&e.add(n[t]),r[t]=null,i.deleteQuery(s),o++))}o<r.length?requestAnimationFrame(s):t.occluded=e};s()}}isOccluded(e,t){const r=this.get(e);return r.occluded&&r.occluded.has(t)}updateViewport(e){const{state:t}=this,{x:r,y:n,width:i,height:s}=e.viewportValue;t.viewport(r,e.height-s-n,i,s)}setScissorTest(e){this.state.setScissorTest(e)}getClearColor(){const e=super.getClearColor();return e.r*=e.a,e.g*=e.a,e.b*=e.a,e}clear(e,t,r,n=null,i=!0){const{gl:s,renderer:o}=this;if(null===n){n={textures:null,clearColorValue:this.getClearColor()}}let a=0;if(e&&(a|=s.COLOR_BUFFER_BIT),t&&(a|=s.DEPTH_BUFFER_BIT),r&&(a|=s.STENCIL_BUFFER_BIT),0!==a){let u;u=n.clearColorValue?n.clearColorValue:this.getClearColor();const l=o.getClearDepth(),c=o.getClearStencil();if(t&&this.state.setDepthMask(!0),null===n.textures)s.clearColor(u.r,u.g,u.b,u.a),s.clear(a);else{if(i&&this._setFramebuffer(n),e)for(let e=0;e<n.textures.length;e++)0===e?s.clearBufferfv(s.COLOR,e,[u.r,u.g,u.b,u.a]):s.clearBufferfv(s.COLOR,e,[0,0,0,1]);t&&r?s.clearBufferfi(s.DEPTH_STENCIL,0,l,c):t?s.clearBufferfv(s.DEPTH,0,[l]):r&&s.clearBufferiv(s.STENCIL,0,[c])}}}beginCompute(e){const{state:t,gl:r}=this;t.bindFramebuffer(r.FRAMEBUFFER,null),this.initTimestampQuery(e)}compute(e,t,r,n){const{state:i,gl:s}=this;!1===this.discard&&(s.enable(s.RASTERIZER_DISCARD),this.discard=!0);const{programGPU:o,transformBuffers:a,attributes:u}=this.get(n),l=this._getVaoKey(u),c=this.vaoCache[l];void 0===c?this._createVao(u):i.setVertexState(c),i.useProgram(o),this._bindUniforms(r);const h=this._getTransformFeedback(a);s.bindTransformFeedback(s.TRANSFORM_FEEDBACK,h),s.beginTransformFeedback(s.POINTS),u[0].isStorageInstancedBufferAttribute?s.drawArraysInstanced(s.POINTS,0,1,t.count):s.drawArrays(s.POINTS,0,t.count),s.endTransformFeedback(),s.bindTransformFeedback(s.TRANSFORM_FEEDBACK,null);for(let d=0;d<a.length;d++){const e=a[d];e.pbo&&this.textureUtils.copyBufferToTexture(e.transformBuffer,e.pbo),e.switchBuffers()}}finishCompute(e){const t=this.gl;this.discard=!1,t.disable(t.RASTERIZER_DISCARD),this.prepareTimestampBuffer(e),this._currentContext&&this._setFramebuffer(this._currentContext)}_isRenderCameraDepthArray(e){return e.depthTexture&&e.depthTexture.isArrayTexture&&e.camera.isArrayCamera}draw(e){const{object:t,pipeline:r,material:n,context:i,hardwareClippingPlanes:s}=e,{programGPU:o}=this.get(r),{gl:a,state:u}=this,l=this.get(i),c=e.getDrawParameters();if(null===c)return;this._bindUniforms(e.getBindings());const h=t.isMesh&&t.matrixWorld.determinant()<0;u.setMaterial(n,h,s),u.useProgram(o);const d=this.get(e);let p=d.staticVao;if(void 0===p||d.geometryId!==e.geometry.id){const t=this._getVaoKey(e.getAttributes());if(p=this.vaoCache[t],void 0===p){let t;({vaoGPU:p,staticVao:t}=this._createVao(e.getAttributes())),t&&(d.staticVao=p,d.geometryId=e.geometry.id)}}const f=e.getIndex(),g=null!==f?this.get(f).bufferGPU:null;u.setVertexState(p,g);const m=l.lastOcclusionObject;if(m!==t&&void 0!==m){if(null!==m&&!0===m.occlusionTest&&(a.endQuery(a.ANY_SAMPLES_PASSED),l.occlusionQueryIndex++),!0===t.occlusionTest){const e=a.createQuery();a.beginQuery(a.ANY_SAMPLES_PASSED,e),l.occlusionQueries[l.occlusionQueryIndex]=e,l.occlusionQueryObjects[l.occlusionQueryIndex]=t}l.lastOcclusionObject=t}const y=this.bufferRenderer;t.isPoints?y.mode=a.POINTS:t.isLineSegments?y.mode=a.LINES:t.isLine?y.mode=a.LINE_STRIP:t.isLineLoop?y.mode=a.LINE_LOOP:!0===n.wireframe?(u.setLineWidth(n.wireframeLinewidth*this.renderer.getPixelRatio()),y.mode=a.LINES):y.mode=a.TRIANGLES;const{vertexCount:b,instanceCount:_}=c;let{firstVertex:v}=c;if(y.object=t,null!==f){v*=f.array.BYTES_PER_ELEMENT;const e=this.get(f);y.index=f.count,y.type=e.type}else y.index=0;const x=()=>{t.isBatchedMesh?null!==t._multiDrawInstances?(Ee("THREE.WebGLBackend: renderMultiDrawInstances has been deprecated and will be removed in r184. Append to renderMultiDraw arguments and use indirection."),y.renderMultiDrawInstances(t._multiDrawStarts,t._multiDrawCounts,t._multiDrawCount,t._multiDrawInstances)):this.hasFeature("WEBGL_multi_draw")?y.renderMultiDraw(t._multiDrawStarts,t._multiDrawCounts,t._multiDrawCount):Ee("THREE.WebGLRenderer: WEBGL_multi_draw not supported."):_>1?y.renderInstances(v,b,_):y.render(v,b)};if(!0===e.camera.isArrayCamera&&e.camera.cameras.length>0&&!1===e.camera.isMultiViewCamera){const r=this.get(e.camera),n=e.camera.cameras,i=e.getBindingGroup("cameraIndex").bindings[0];if(void 0===r.indexesGPU||r.indexesGPU.length!==n.length){const e=new Uint32Array([0,0,0,0]),t=[];for(let r=0,i=n.length;r<i;r++){const n=a.createBuffer();e[0]=r,a.bindBuffer(a.UNIFORM_BUFFER,n),a.bufferData(a.UNIFORM_BUFFER,e,a.STATIC_DRAW),t.push(n)}r.indexesGPU=t}const s=this.get(i),o=this.renderer.getPixelRatio(),l=this._currentContext.renderTarget,c=this._isRenderCameraDepthArray(this._currentContext),h=this._currentContext.activeCubeFace;if(c){const e=this.get(l.depthTexture);if(e.clearedRenderId!==this.renderer._nodes.nodeFrame.renderId){e.clearedRenderId=this.renderer._nodes.nodeFrame.renderId;const{stencilBuffer:t}=l;for(let e=0,r=n.length;e<r;e++)this.renderer._activeCubeFace=e,this._currentContext.activeCubeFace=e,this._setFramebuffer(this._currentContext),this.clear(!1,!0,t,this._currentContext,!1);this.renderer._activeCubeFace=h,this._currentContext.activeCubeFace=h}}for(let d=0,p=n.length;d<p;d++){const i=n[d];if(t.layers.test(i.layers)){c&&(this.renderer._activeCubeFace=d,this._currentContext.activeCubeFace=d,this._setFramebuffer(this._currentContext));const t=i.viewport;if(void 0!==t){const r=t.x*o,n=t.y*o,i=t.width*o,s=t.height*o;u.viewport(Math.floor(r),Math.floor(e.context.height-s-n),Math.floor(i),Math.floor(s))}u.bindBufferBase(a.UNIFORM_BUFFER,s.index,r.indexesGPU[d]),x()}this._currentContext.activeCubeFace=h,this.renderer._activeCubeFace=h}}else x()}needsRenderUpdate(){return!1}getRenderCacheKey(){return""}createDefaultTexture(e){this.textureUtils.createDefaultTexture(e)}createTexture(e,t){this.textureUtils.createTexture(e,t)}updateTexture(e,t){this.textureUtils.updateTexture(e,t)}generateMipmaps(e){this.textureUtils.generateMipmaps(e)}destroyTexture(e){this.textureUtils.destroyTexture(e)}async copyTextureToBuffer(e,t,r,n,i,s){return this.textureUtils.copyTextureToBuffer(e,t,r,n,i,s)}createSampler(){}destroySampler(){}createNodeBuilder(e,t){return new lT(e,t)}createProgram(e){const t=this.gl,{stage:r,code:n}=e,i="fragment"===r?t.createShader(t.FRAGMENT_SHADER):t.createShader(t.VERTEX_SHADER);t.shaderSource(i,n),t.compileShader(i),this.set(e,{shaderGPU:i})}destroyProgram(e){this.delete(e)}createRenderPipeline(e,t){const r=this.gl,n=e.pipeline,{fragmentProgram:i,vertexProgram:s}=n,o=r.createProgram(),a=this.get(i).shaderGPU,u=this.get(s).shaderGPU;if(r.attachShader(o,a),r.attachShader(o,u),r.linkProgram(o),this.set(n,{programGPU:o,fragmentShader:a,vertexShader:u}),null!==t&&this.parallel){const i=new Promise((t=>{const i=this.parallel,s=()=>{r.getProgramParameter(o,i.COMPLETION_STATUS_KHR)?(this._completeCompile(e,n),t()):requestAnimationFrame(s)};s()}));t.push(i)}else this._completeCompile(e,n)}_handleSource(e,t){const r=e.split("\n"),n=[],i=Math.max(t-6,0),s=Math.min(t+6,r.length);for(let o=i;o<s;o++){const e=o+1;n.push(`${e===t?">":" "} ${e}: ${r[o]}`)}return n.join("\n")}_getShaderErrors(e,t,r){const n=e.getShaderParameter(t,e.COMPILE_STATUS),i=e.getShaderInfoLog(t).trim();if(n&&""===i)return"";const s=/ERROR: 0:(\d+)/.exec(i);if(s){const n=parseInt(s[1]);return r.toUpperCase()+"\n\n"+i+"\n\n"+this._handleSource(e.getShaderSource(t),n)}return i}_logProgramError(e,t,r){if(this.renderer.debug.checkShaderErrors){const n=this.gl;n.getProgramInfoLog(e).trim();if(!1===n.getProgramParameter(e,n.LINK_STATUS))if("function"==typeof this.renderer.debug.onShaderError)this.renderer.debug.onShaderError(n,e,r,t);else{this._getShaderErrors(n,r,"vertex"),this._getShaderErrors(n,t,"fragment")}}}_completeCompile(e,t){const{state:r,gl:n}=this,i=this.get(t),{programGPU:s,fragmentShader:o,vertexShader:a}=i;!1===n.getProgramParameter(s,n.LINK_STATUS)&&this._logProgramError(s,o,a),r.useProgram(s);const u=e.getBindings();this._setupBindings(u,s),this.set(t,{programGPU:s})}createComputePipeline(e,t){const{state:r,gl:n}=this,i={stage:"fragment",code:"#version 300 es\nprecision highp float;\nvoid main() {}"};this.createProgram(i);const{computeProgram:s}=e,o=n.createProgram(),a=this.get(i).shaderGPU,u=this.get(s).shaderGPU,l=s.transforms,c=[],h=[];for(let g=0;g<l.length;g++){const e=l[g];c.push(e.varyingName),h.push(e.attributeNode)}n.attachShader(o,a),n.attachShader(o,u),n.transformFeedbackVaryings(o,c,n.SEPARATE_ATTRIBS),n.linkProgram(o),!1===n.getProgramParameter(o,n.LINK_STATUS)&&this._logProgramError(o,a,u),r.useProgram(o),this._setupBindings(t,o);const d=s.attributes,p=[],f=[];for(let g=0;g<d.length;g++){const e=d[g].node.attribute;p.push(e),this.has(e)||this.attributeUtils.createAttribute(e,n.ARRAY_BUFFER)}for(let g=0;g<h.length;g++){const e=h[g].attribute;this.has(e)||this.attributeUtils.createAttribute(e,n.ARRAY_BUFFER);const t=this.get(e);f.push(t)}this.set(e,{programGPU:o,transformBuffers:f,attributes:p})}createBindings(e,t){if(!1===this._knownBindings.has(t)){this._knownBindings.add(t);let e=0,r=0;for(const n of t){this.set(n,{textures:r,uniformBuffers:e});for(const t of n.bindings)t.isUniformBuffer&&e++,t.isSampledTexture&&r++}}this.updateBindings(e,t)}updateBindings(e){const{gl:t}=this,r=this.get(e);let n=r.uniformBuffers,i=r.textures;for(const s of e.bindings)if(s.isUniformsGroup||s.isUniformBuffer){const e=s.buffer,r=t.createBuffer();t.bindBuffer(t.UNIFORM_BUFFER,r),t.bufferData(t.UNIFORM_BUFFER,e,t.DYNAMIC_DRAW),this.set(s,{index:n++,bufferGPU:r})}else if(s.isSampledTexture){const{textureGPU:e,glTextureType:t}=this.get(s.texture);this.set(s,{index:i++,textureGPU:e,glTextureType:t})}}updateBinding(e){const t=this.gl;if(e.isUniformsGroup||e.isUniformBuffer){const r=this.get(e).bufferGPU,n=e.buffer;t.bindBuffer(t.UNIFORM_BUFFER,r),t.bufferData(t.UNIFORM_BUFFER,n,t.DYNAMIC_DRAW)}}createIndexAttribute(e){const t=this.gl;this.attributeUtils.createAttribute(e,t.ELEMENT_ARRAY_BUFFER)}createAttribute(e){if(this.has(e))return;const t=this.gl;this.attributeUtils.createAttribute(e,t.ARRAY_BUFFER)}createStorageAttribute(e){if(this.has(e))return;const t=this.gl;this.attributeUtils.createAttribute(e,t.ARRAY_BUFFER)}updateAttribute(e){this.attributeUtils.updateAttribute(e)}destroyAttribute(e){this.attributeUtils.destroyAttribute(e)}hasFeature(e){const t=Object.keys(AT).filter((t=>AT[t]===e)),r=this.extensions;for(let n=0;n<t.length;n++)if(r.has(t[n]))return!0;return!1}getMaxAnisotropy(){return this.capabilities.getMaxAnisotropy()}copyTextureToTexture(e,t,r=null,n=null,i=0,s=0){this.textureUtils.copyTextureToTexture(e,t,r,n,i,s)}copyFramebufferToTexture(e,t,r){this.textureUtils.copyFramebufferToTexture(e,t,r)}_setFramebuffer(e){const{gl:t,state:r}=this;let n=null;if(null!==e.textures){const i=e.renderTarget,s=this.get(i),{samples:o,depthBuffer:a,stencilBuffer:u}=i,l=!0===i.isWebGLCubeRenderTarget,c=!0===i.isRenderTarget3D,h=i.depth>1,d=!0===i.isXRRenderTarget,p=!0===d&&!0===i.hasExternalTextures;let f=s.msaaFrameBuffer,g=s.depthRenderbuffer;const m=this.extensions.get("WEBGL_multisampled_render_to_texture"),y=this.extensions.get("OVR_multiview2"),b=this._useMultisampledExtension(i),_=Fb(e);let v;if(l?(s.cubeFramebuffers||(s.cubeFramebuffers={}),v=s.cubeFramebuffers[_]):d&&!1===p?v=this._xrFramebuffer:(s.framebuffers||(s.framebuffers={}),v=s.framebuffers[_]),void 0===v){v=t.createFramebuffer(),r.bindFramebuffer(t.FRAMEBUFFER,v);const n=e.textures,a=[];if(l){s.cubeFramebuffers[_]=v;const{textureGPU:e}=this.get(n[0]),r=this.renderer._activeCubeFace;t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_CUBE_MAP_POSITIVE_X+r,e,0)}else{s.framebuffers[_]=v;for(let r=0;r<n.length;r++){const s=n[r],a=this.get(s);a.renderTarget=e.renderTarget,a.cacheKey=_;const u=t.COLOR_ATTACHMENT0+r;if(i.multiview)y.framebufferTextureMultisampleMultiviewOVR(t.FRAMEBUFFER,u,a.textureGPU,0,o,0,2);else if(c||h){const e=this.renderer._activeCubeFace;t.framebufferTextureLayer(t.FRAMEBUFFER,u,a.textureGPU,0,e)}else b?m.framebufferTexture2DMultisampleEXT(t.FRAMEBUFFER,u,t.TEXTURE_2D,a.textureGPU,0,o):t.framebufferTexture2D(t.FRAMEBUFFER,u,t.TEXTURE_2D,a.textureGPU,0)}r.drawBuffers(e,v)}const d=u?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT;if(!0===i.autoAllocateDepthBuffer){const r=t.createRenderbuffer();this.textureUtils.setupRenderBufferStorage(r,e,0,b),s.xrDepthRenderbuffer=r,a.push(u?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT),t.bindRenderbuffer(t.RENDERBUFFER,r),t.framebufferRenderbuffer(t.FRAMEBUFFER,d,t.RENDERBUFFER,r)}else if(null!==e.depthTexture){a.push(u?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT);const r=this.get(e.depthTexture);if(r.renderTarget=e.renderTarget,r.cacheKey=_,i.multiview)y.framebufferTextureMultisampleMultiviewOVR(t.FRAMEBUFFER,d,r.textureGPU,0,o,0,2);else if(p&&b)m.framebufferTexture2DMultisampleEXT(t.FRAMEBUFFER,d,t.TEXTURE_2D,r.textureGPU,0,o);else if(e.depthTexture.isArrayTexture){const e=this.renderer._activeCubeFace;t.framebufferTextureLayer(t.FRAMEBUFFER,d,r.textureGPU,0,e)}else t.framebufferTexture2D(t.FRAMEBUFFER,d,t.TEXTURE_2D,r.textureGPU,0)}s.depthInvalidationArray=a}else{if(this._isRenderCameraDepthArray(e)){r.bindFramebuffer(t.FRAMEBUFFER,v);const n=this.renderer._activeCubeFace,i=this.get(e.depthTexture),s=u?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT;t.framebufferTextureLayer(t.FRAMEBUFFER,s,i.textureGPU,0,n)}if(d||b||i.multiview){r.bindFramebuffer(t.FRAMEBUFFER,v);const n=this.get(e.textures[0]);i.multiview?y.framebufferTextureMultisampleMultiviewOVR(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,n.textureGPU,0,o,0,2):b?m.framebufferTexture2DMultisampleEXT(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,n.textureGPU,0,o):t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,n.textureGPU,0);const a=u?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT;if(!0===i.autoAllocateDepthBuffer){const e=s.xrDepthRenderbuffer;t.bindRenderbuffer(t.RENDERBUFFER,e),t.framebufferRenderbuffer(t.FRAMEBUFFER,a,t.RENDERBUFFER,e)}else{const r=this.get(e.depthTexture);i.multiview?y.framebufferTextureMultisampleMultiviewOVR(t.FRAMEBUFFER,a,r.textureGPU,0,o,0,2):b?m.framebufferTexture2DMultisampleEXT(t.FRAMEBUFFER,a,t.TEXTURE_2D,r.textureGPU,0,o):t.framebufferTexture2D(t.FRAMEBUFFER,a,t.TEXTURE_2D,r.textureGPU,0)}}}if(o>0&&!1===b&&!i.multiview){if(void 0===f){const n=[];f=t.createFramebuffer(),r.bindFramebuffer(t.FRAMEBUFFER,f);const i=[],l=e.textures;for(let r=0;r<l.length;r++){if(i[r]=t.createRenderbuffer(),t.bindRenderbuffer(t.RENDERBUFFER,i[r]),n.push(t.COLOR_ATTACHMENT0+r),a){const e=u?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT;n.push(e)}const s=e.textures[r],l=this.get(s);t.renderbufferStorageMultisample(t.RENDERBUFFER,o,l.glInternalFormat,e.width,e.height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+r,t.RENDERBUFFER,i[r])}if(s.msaaFrameBuffer=f,s.msaaRenderbuffers=i,void 0===g){g=t.createRenderbuffer(),this.textureUtils.setupRenderBufferStorage(g,e,o),s.depthRenderbuffer=g;const r=u?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT;n.push(r)}s.invalidationArray=n}n=s.msaaFrameBuffer}else n=v}r.bindFramebuffer(t.FRAMEBUFFER,n)}_getVaoKey(e){let t="";for(let r=0;r<e.length;r++){t+=":"+this.get(e[r]).id}return t}_createVao(e){const{gl:t}=this,r=t.createVertexArray();let n="",i=!0;t.bindVertexArray(r);for(let s=0;s<e.length;s++){const r=e[s],o=this.get(r);let a,u;n+=":"+o.id,t.bindBuffer(t.ARRAY_BUFFER,o.bufferGPU),t.enableVertexAttribArray(s),(r.isStorageBufferAttribute||r.isStorageInstancedBufferAttribute)&&(i=!1),!0===r.isInterleavedBufferAttribute?(a=r.data.stride*o.bytesPerElement,u=r.offset*o.bytesPerElement):(a=0,u=0),o.isInteger?t.vertexAttribIPointer(s,r.itemSize,o.type,a,u):t.vertexAttribPointer(s,r.itemSize,o.type,r.normalized,a,u),r.isInstancedBufferAttribute&&!r.isInterleavedBufferAttribute?t.vertexAttribDivisor(s,r.meshPerAttribute):r.isInterleavedBufferAttribute&&r.data.isInstancedInterleavedBuffer&&t.vertexAttribDivisor(s,r.data.meshPerAttribute)}return t.bindBuffer(t.ARRAY_BUFFER,null),this.vaoCache[n]=r,{vaoGPU:r,staticVao:i}}_getTransformFeedback(e){let t="";for(let i=0;i<e.length;i++)t+=":"+e[i].id;let r=this.transformFeedbackCache[t];if(void 0!==r)return r;const{gl:n}=this;r=n.createTransformFeedback(),n.bindTransformFeedback(n.TRANSFORM_FEEDBACK,r);for(let i=0;i<e.length;i++){const t=e[i];n.bindBufferBase(n.TRANSFORM_FEEDBACK_BUFFER,i,t.transformBuffer)}return n.bindTransformFeedback(n.TRANSFORM_FEEDBACK,null),this.transformFeedbackCache[t]=r,r}_setupBindings(e,t){const r=this.gl;for(const n of e)for(const e of n.bindings){const n=this.get(e).index;if(e.isUniformsGroup||e.isUniformBuffer){const i=r.getUniformBlockIndex(t,e.name);r.uniformBlockBinding(t,i,n)}else if(e.isSampledTexture){const i=r.getUniformLocation(t,e.name);r.uniform1i(i,n)}}}_bindUniforms(e){const{gl:t,state:r}=this;for(const n of e)for(const e of n.bindings){const n=this.get(e),i=n.index;e.isUniformsGroup||e.isUniformBuffer?r.bindBufferBase(t.UNIFORM_BUFFER,i,n.bufferGPU):e.isSampledTexture&&r.bindTexture(n.glTextureType,n.textureGPU,t.TEXTURE0+i)}}_useMultisampledExtension(e){return!0===e.multiview||e.samples>0&&!0===this.extensions.has("WEBGL_multisampled_render_to_texture")&&!1!==e.autoAllocateDepthBuffer}dispose(){const e=this.extensions.get("WEBGL_lose_context");e&&e.loseContext(),this.renderer.domElement.removeEventListener("webglcontextlost",this._onContextLost)}}const OT="point-list",LT="line-list",BT="line-strip",kT="triangle-list",IT="triangle-strip",UT="never",VT="less",jT="equal",GT="less-equal",zT="greater",$T="not-equal",HT="greater-equal",WT="always",qT="store",XT="load",KT="clear",YT="ccw",QT="none",ZT="front",JT="back",ew="uint16",tw="uint32",rw="r8unorm",nw="r8snorm",iw="r8uint",sw="r8sint",ow="r16uint",aw="r16sint",uw="r16float",lw="rg8unorm",cw="rg8snorm",hw="rg8uint",dw="rg8sint",pw="r32uint",fw="r32sint",gw="r32float",mw="rg16uint",yw="rg16sint",bw="rg16float",_w="rgba8unorm",vw="rgba8unorm-srgb",xw="rgba8snorm",Tw="rgba8uint",ww="rgba8sint",Sw="bgra8unorm",Nw="bgra8unorm-srgb",Ew="rgb9e5ufloat",Cw="rgb10a2unorm",Aw="rgb10a2unorm",Mw="rg32uint",Rw="rg32sint",Pw="rg32float",Dw="rgba16uint",Fw="rgba16sint",Ow="rgba16float",Lw="rgba32uint",Bw="rgba32sint",kw="rgba32float",Iw="depth16unorm",Uw="depth24plus",Vw="depth24plus-stencil8",jw="depth32float",Gw="depth32float-stencil8",zw="bc1-rgba-unorm",$w="bc1-rgba-unorm-srgb",Hw="bc2-rgba-unorm",Ww="bc2-rgba-unorm-srgb",qw="bc3-rgba-unorm",Xw="bc3-rgba-unorm-srgb",Kw="bc4-r-unorm",Yw="bc4-r-snorm",Qw="bc5-rg-unorm",Zw="bc5-rg-snorm",Jw="bc6h-rgb-ufloat",eS="bc6h-rgb-float",tS="bc7-rgba-unorm",rS="bc7-rgba-srgb",nS="etc2-rgb8unorm",iS="etc2-rgb8unorm-srgb",sS="etc2-rgb8a1unorm",oS="etc2-rgb8a1unorm-srgb",aS="etc2-rgba8unorm",uS="etc2-rgba8unorm-srgb",lS="eac-r11unorm",cS="eac-r11snorm",hS="eac-rg11unorm",dS="eac-rg11snorm",pS="astc-4x4-unorm",fS="astc-4x4-unorm-srgb",gS="astc-5x4-unorm",mS="astc-5x4-unorm-srgb",yS="astc-5x5-unorm",bS="astc-5x5-unorm-srgb",_S="astc-6x5-unorm",vS="astc-6x5-unorm-srgb",xS="astc-6x6-unorm",TS="astc-6x6-unorm-srgb",wS="astc-8x5-unorm",SS="astc-8x5-unorm-srgb",NS="astc-8x6-unorm",ES="astc-8x6-unorm-srgb",CS="astc-8x8-unorm",AS="astc-8x8-unorm-srgb",MS="astc-10x5-unorm",RS="astc-10x5-unorm-srgb",PS="astc-10x6-unorm",DS="astc-10x6-unorm-srgb",FS="astc-10x8-unorm",OS="astc-10x8-unorm-srgb",LS="astc-10x10-unorm",BS="astc-10x10-unorm-srgb",kS="astc-12x10-unorm",IS="astc-12x10-unorm-srgb",US="astc-12x12-unorm",VS="astc-12x12-unorm-srgb",jS="clamp-to-edge",GS="repeat",zS="mirror-repeat",$S="linear",HS="nearest",WS="zero",qS="one",XS="src",KS="one-minus-src",YS="src-alpha",QS="one-minus-src-alpha",ZS="dst",JS="one-minus-dst",eN="dst-alpha",tN="one-minus-dst-alpha",rN="src-alpha-saturated",nN="constant",iN="one-minus-constant",sN="add",oN="subtract",aN="reverse-subtract",uN="min",lN="max",cN=0,hN=15,dN="keep",pN="zero",fN="replace",gN="invert",mN="increment-clamp",yN="decrement-clamp",bN="increment-wrap",_N="decrement-wrap",vN="storage",xN="read-only-storage",TN="write-only",wN="read-only",SN="read-write",NN="non-filtering",EN="comparison",CN="float",AN="unfilterable-float",MN="depth",RN="sint",PN="uint",DN="2d",FN="3d",ON="2d",LN="2d-array",BN="cube",kN="3d",IN="all",UN="vertex",VN="instance",jN={DepthClipControl:"depth-clip-control",Depth32FloatStencil8:"depth32float-stencil8",TextureCompressionBC:"texture-compression-bc",TextureCompressionETC2:"texture-compression-etc2",TextureCompressionASTC:"texture-compression-astc",TimestampQuery:"timestamp-query",IndirectFirstInstance:"indirect-first-instance",ShaderF16:"shader-f16",RG11B10UFloat:"rg11b10ufloat-renderable",BGRA8UNormStorage:"bgra8unorm-storage",Float32Filterable:"float32-filterable",ClipDistances:"clip-distances",DualSourceBlending:"dual-source-blending",Subgroups:"subgroups"};class GN extends $x{constructor(e,t){super(e),this.texture=t,this.version=t?t.version:0,this.isSampler=!0}}class zN extends GN{constructor(e,t,r){super(e,t?t.value:null),this.textureNode=t,this.groupNode=r}update(){this.texture=this.textureNode.value}}class $N extends Hx{constructor(e,t){super(e,t?t.array:null),this.attribute=t,this.isStorageBuffer=!0}}let HN=0;class WN extends $N{constructor(e,t){super("StorageBuffer_"+HN++,e?e.value:null),this.nodeUniform=e,this.access=e?e.access:ja,this.groupNode=t}get buffer(){return this.nodeUniform.value}}class qN extends ab{constructor(e){super(),this.device=e;this.mipmapSampler=e.createSampler({minFilter:$S}),this.flipYSampler=e.createSampler({minFilter:HS}),this.transferPipelines={},this.flipYPipelines={},this.mipmapVertexShaderModule=e.createShaderModule({label:"mipmapVertex",code:"\nstruct VarysStruct {\n\t@builtin( position ) Position: vec4<f32>,\n\t@location( 0 ) vTex : vec2<f32>\n};\n\n@vertex\nfn main( @builtin( vertex_index ) vertexIndex : u32 ) -> VarysStruct {\n\n\tvar Varys : VarysStruct;\n\n\tvar pos = array< vec2<f32>, 4 >(\n\t\tvec2<f32>( -1.0,  1.0 ),\n\t\tvec2<f32>(  1.0,  1.0 ),\n\t\tvec2<f32>( -1.0, -1.0 ),\n\t\tvec2<f32>(  1.0, -1.0 )\n\t);\n\n\tvar tex = array< vec2<f32>, 4 >(\n\t\tvec2<f32>( 0.0, 0.0 ),\n\t\tvec2<f32>( 1.0, 0.0 ),\n\t\tvec2<f32>( 0.0, 1.0 ),\n\t\tvec2<f32>( 1.0, 1.0 )\n\t);\n\n\tVarys.vTex = tex[ vertexIndex ];\n\tVarys.Position = vec4<f32>( pos[ vertexIndex ], 0.0, 1.0 );\n\n\treturn Varys;\n\n}\n"}),this.mipmapFragmentShaderModule=e.createShaderModule({label:"mipmapFragment",code:"\n@group( 0 ) @binding( 0 )\nvar imgSampler : sampler;\n\n@group( 0 ) @binding( 1 )\nvar img : texture_2d<f32>;\n\n@fragment\nfn main( @location( 0 ) vTex : vec2<f32> ) -> @location( 0 ) vec4<f32> {\n\n\treturn textureSample( img, imgSampler, vTex );\n\n}\n"}),this.flipYFragmentShaderModule=e.createShaderModule({label:"flipYFragment",code:"\n@group( 0 ) @binding( 0 )\nvar imgSampler : sampler;\n\n@group( 0 ) @binding( 1 )\nvar img : texture_2d<f32>;\n\n@fragment\nfn main( @location( 0 ) vTex : vec2<f32> ) -> @location( 0 ) vec4<f32> {\n\n\treturn textureSample( img, imgSampler, vec2( vTex.x, 1.0 - vTex.y ) );\n\n}\n"})}getTransferPipeline(e){let t=this.transferPipelines[e];return void 0===t&&(t=this.device.createRenderPipeline({label:`mipmap-${e}`,vertex:{module:this.mipmapVertexShaderModule,entryPoint:"main"},fragment:{module:this.mipmapFragmentShaderModule,entryPoint:"main",targets:[{format:e}]},primitive:{topology:IT,stripIndexFormat:tw},layout:"auto"}),this.transferPipelines[e]=t),t}getFlipYPipeline(e){let t=this.flipYPipelines[e];return void 0===t&&(t=this.device.createRenderPipeline({label:`flipY-${e}`,vertex:{module:this.mipmapVertexShaderModule,entryPoint:"main"},fragment:{module:this.flipYFragmentShaderModule,entryPoint:"main",targets:[{format:e}]},primitive:{topology:IT,stripIndexFormat:tw},layout:"auto"}),this.flipYPipelines[e]=t),t}flipY(e,t,r=0){const n=t.format,{width:i,height:s}=t.size,o=this.getTransferPipeline(n),a=this.getFlipYPipeline(n),u=this.device.createTexture({size:{width:i,height:s,depthOrArrayLayers:1},format:n,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING}),l=e.createView({baseMipLevel:0,mipLevelCount:1,dimension:ON,baseArrayLayer:r}),c=u.createView({baseMipLevel:0,mipLevelCount:1,dimension:ON,baseArrayLayer:0}),h=this.device.createCommandEncoder({}),d=(e,t,r)=>{const n=e.getBindGroupLayout(0),i=this.device.createBindGroup({layout:n,entries:[{binding:0,resource:this.flipYSampler},{binding:1,resource:t}]}),s=h.beginRenderPass({colorAttachments:[{view:r,loadOp:KT,storeOp:qT,clearValue:[0,0,0,0]}]});s.setPipeline(e),s.setBindGroup(0,i),s.draw(4,1,0,0),s.end()};d(o,l,c),d(a,c,l),this.device.queue.submit([h.finish()]),u.destroy()}generateMipmaps(e,t,r=0){const n=this.get(e);void 0===n.useCount&&(n.useCount=0,n.layers=[]);const i=n.layers[r]||this._mipmapCreateBundles(e,t,r),s=this.device.createCommandEncoder({});this._mipmapRunBundles(s,i),this.device.queue.submit([s.finish()]),0!==n.useCount&&(n.layers[r]=i),n.useCount++}_mipmapCreateBundles(e,t,r){const n=this.getTransferPipeline(t.format),i=n.getBindGroupLayout(0);let s=e.createView({baseMipLevel:0,mipLevelCount:1,dimension:ON,baseArrayLayer:r});const o=[];for(let a=1;a<t.mipLevelCount;a++){const u=this.device.createBindGroup({layout:i,entries:[{binding:0,resource:this.mipmapSampler},{binding:1,resource:s}]}),l=e.createView({baseMipLevel:a,mipLevelCount:1,dimension:ON,baseArrayLayer:r}),c={colorAttachments:[{view:l,loadOp:KT,storeOp:qT,clearValue:[0,0,0,0]}]},h=this.device.createRenderBundleEncoder({colorFormats:[t.format]});h.setPipeline(n),h.setBindGroup(0,u),h.draw(4,1,0,0),o.push({renderBundles:[h.finish()],passDescriptor:c}),s=l}return o}_mipmapRunBundles(e,t){const r=t.length;for(let n=0;n<r;n++){const r=t[n],i=e.beginRenderPass(r.passDescriptor);i.executeBundles(r.renderBundles),i.end()}}}const XN={[He]:"never",[ze]:"less",[je]:"equal",[Ge]:"less-equal",[Ue]:"greater",[Ve]:"greater-equal",[$e]:"always",[Ie]:"not-equal"},KN=[0,1,3,2,4,5];class YN{constructor(e){this.backend=e,this._passUtils=null,this.defaultTexture={},this.defaultCubeTexture={},this.defaultVideoFrame=null,this.colorBuffer=null,this.depthTexture=new se,this.depthTexture.name="depthBuffer"}createSampler(e){const t=this.backend,r=t.device,n=t.get(e),i={addressModeU:this._convertAddressMode(e.wrapS),addressModeV:this._convertAddressMode(e.wrapT),addressModeW:this._convertAddressMode(e.wrapR),magFilter:this._convertFilterMode(e.magFilter),minFilter:this._convertFilterMode(e.minFilter),mipmapFilter:this._convertFilterMode(e.minFilter),maxAnisotropy:1};i.magFilter===$S&&i.minFilter===$S&&i.mipmapFilter===$S&&(i.maxAnisotropy=e.anisotropy),e.isDepthTexture&&null!==e.compareFunction&&(i.compare=XN[e.compareFunction]),n.sampler=r.createSampler(i)}createDefaultTexture(e){let t;const r=QN(e);e.isCubeTexture?t=this._getDefaultCubeTextureGPU(r):e.isVideoTexture?this.backend.get(e).externalTexture=this._getDefaultVideoFrame():t=this._getDefaultTextureGPU(r),this.backend.get(e).texture=t}createTexture(e,t={}){const r=this.backend,n=r.get(e);if(n.initialized)throw new Error("WebGPUTextureUtils: Texture already initialized.");void 0===t.needsMipmaps&&(t.needsMipmaps=!1),void 0===t.levels&&(t.levels=1),void 0===t.depth&&(t.depth=1);const{width:i,height:s,depth:o,levels:a}=t;e.isFramebufferTexture&&(t.renderTarget?t.format=this.backend.utils.getCurrentColorFormat(t.renderTarget):t.format=this.backend.utils.getPreferredCanvasFormat());const u=this._getDimension(e),l=e.internalFormat||t.format||QN(e,r.device);n.format=l;const{samples:c,primarySamples:h,isMSAA:d}=r.utils.getTextureSampleData(e);let p=GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.COPY_SRC;!0===e.isStorageTexture&&(p|=GPUTextureUsage.STORAGE_BINDING),!0!==e.isCompressedTexture&&!0!==e.isCompressedArrayTexture&&(p|=GPUTextureUsage.RENDER_ATTACHMENT);const f={label:e.name,size:{width:i,height:s,depthOrArrayLayers:o},mipLevelCount:a,sampleCount:h,dimension:u,format:l,usage:p};if(e.isVideoTexture){const t=e.source.data,r=new VideoFrame(t);f.size.width=r.displayWidth,f.size.height=r.displayHeight,r.close(),n.externalTexture=t}else{if(void 0===l)return void this.createDefaultTexture(e);e.isCubeTexture&&(f.textureBindingViewDimension=BN),n.texture=r.device.createTexture(f)}if(d){const e=Object.assign({},f);e.label=e.label+"-msaa",e.sampleCount=c,n.msaaTexture=r.device.createTexture(e)}n.initialized=!0,n.textureDescriptorGPU=f}destroyTexture(e){const t=this.backend,r=t.get(e);void 0!==r.texture&&r.texture.destroy(),void 0!==r.msaaTexture&&r.msaaTexture.destroy(),t.delete(e)}destroySampler(e){delete this.backend.get(e).sampler}generateMipmaps(e){const t=this.backend.get(e);if(e.isCubeTexture)for(let r=0;r<6;r++)this._generateMipmaps(t.texture,t.textureDescriptorGPU,r);else{const r=e.image.depth||1;for(let e=0;e<r;e++)this._generateMipmaps(t.texture,t.textureDescriptorGPU,e)}}getColorBuffer(){this.colorBuffer&&this.colorBuffer.destroy();const e=this.backend,{width:t,height:r}=e.getDrawingBufferSize();return this.colorBuffer=e.device.createTexture({label:"colorBuffer",size:{width:t,height:r,depthOrArrayLayers:1},sampleCount:e.utils.getSampleCount(e.renderer.samples),format:e.utils.getPreferredCanvasFormat(),usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC}),this.colorBuffer}getDepthBuffer(e=!0,t=!1){const r=this.backend,{width:n,height:i}=r.getDrawingBufferSize(),s=this.depthTexture,o=r.get(s).texture;let a,u;if(t?(a=le,u=ae):e&&(a=ce,u=ue),void 0!==o){if(s.image.width===n&&s.image.height===i&&s.format===a&&s.type===u)return o;this.destroyTexture(s)}return s.name="depthBuffer",s.format=a,s.type=u,s.image.width=n,s.image.height=i,this.createTexture(s,{width:n,height:i}),r.get(s).texture}updateTexture(e,t){const r=this.backend.get(e),{textureDescriptorGPU:n}=r;if(!e.isRenderTargetTexture&&void 0!==n){if(e.isDataTexture)this._copyBufferToTexture(t.image,r.texture,n,0,e.flipY);else if(e.isArrayTexture||e.isDataArrayTexture||e.isData3DTexture)for(let i=0;i<t.image.depth;i++)this._copyBufferToTexture(t.image,r.texture,n,i,e.flipY,i);else if(e.isCompressedTexture||e.isCompressedArrayTexture)this._copyCompressedBufferToTexture(e.mipmaps,r.texture,n);else if(e.isCubeTexture)this._copyCubeMapToTexture(t.images,r.texture,n,e.flipY,e.premultiplyAlpha);else if(e.isVideoTexture){const t=e.source.data;r.externalTexture=t}else this._copyImageToTexture(t.image,r.texture,n,0,e.flipY,e.premultiplyAlpha);r.version=e.version,e.onUpdate&&e.onUpdate(e)}}async copyTextureToBuffer(e,t,r,n,i,s){const o=this.backend.device,a=this.backend.get(e),u=a.texture,l=a.textureDescriptorGPU.format,c=this._getBytesPerTexel(l);let h=n*c;h=256*Math.ceil(h/256);const d=o.createBuffer({size:n*i*c,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),p=o.createCommandEncoder();p.copyTextureToBuffer({texture:u,origin:{x:t,y:r,z:s}},{buffer:d,bytesPerRow:h},{width:n,height:i});const f=this._getTypedArrayType(l);o.queue.submit([p.finish()]),await d.mapAsync(GPUMapMode.READ);return new f(d.getMappedRange())}_getDefaultTextureGPU(e){let t=this.defaultTexture[e];if(void 0===t){const r=new xe;r.minFilter=ke,r.magFilter=ke,this.createTexture(r,{width:1,height:1,format:e}),this.defaultTexture[e]=t=r}return this.backend.get(t).texture}_getDefaultCubeTextureGPU(e){let t=this.defaultTexture[e];if(void 0===t){const r=new ve;r.minFilter=ke,r.magFilter=ke,this.createTexture(r,{width:1,height:1,depth:6}),this.defaultCubeTexture[e]=t=r}return this.backend.get(t).texture}_getDefaultVideoFrame(){let e=this.defaultVideoFrame;if(null===e){const t={timestamp:0,codedWidth:1,codedHeight:1,format:"RGBA"};this.defaultVideoFrame=e=new VideoFrame(new Uint8Array([0,0,0,255]),t)}return e}_copyCubeMapToTexture(e,t,r,n,i){for(let s=0;s<6;s++){const o=e[s],a=!0===n?KN[s]:s;o.isDataTexture?this._copyBufferToTexture(o.image,t,r,a,n):this._copyImageToTexture(o,t,r,a,n,i)}}_copyImageToTexture(e,t,r,n,i,s){this.backend.device.queue.copyExternalImageToTexture({source:e,flipY:i},{texture:t,mipLevel:0,origin:{x:0,y:0,z:n},premultipliedAlpha:s},{width:e.width,height:e.height,depthOrArrayLayers:1})}_getPassUtils(){let e=this._passUtils;return null===e&&(this._passUtils=e=new qN(this.backend.device)),e}_generateMipmaps(e,t,r=0){this._getPassUtils().generateMipmaps(e,t,r)}_flipY(e,t,r=0){this._getPassUtils().flipY(e,t,r)}_copyBufferToTexture(e,t,r,n,i,s=0){const o=this.backend.device,a=e.data,u=this._getBytesPerTexel(r.format),l=e.width*u;o.queue.writeTexture({texture:t,mipLevel:0,origin:{x:0,y:0,z:n}},a,{offset:e.width*e.height*u*s,bytesPerRow:l},{width:e.width,height:e.height,depthOrArrayLayers:1}),!0===i&&this._flipY(t,r,n)}_copyCompressedBufferToTexture(e,t,r){const n=this.backend.device,i=this._getBlockData(r.format),s=r.size.depthOrArrayLayers>1;for(let o=0;o<e.length;o++){const a=e[o],u=a.width,l=a.height,c=s?r.size.depthOrArrayLayers:1,h=Math.ceil(u/i.width)*i.byteLength,d=h*Math.ceil(l/i.height);for(let e=0;e<c;e++)n.queue.writeTexture({texture:t,mipLevel:o,origin:{x:0,y:0,z:e}},a.data,{offset:e*d,bytesPerRow:h,rowsPerImage:Math.ceil(l/i.height)},{width:Math.ceil(u/i.width)*i.width,height:Math.ceil(l/i.height)*i.height,depthOrArrayLayers:1})}}_getBlockData(e){return e===zw||e===$w?{byteLength:8,width:4,height:4}:e===Hw||e===Ww||e===qw||e===Xw?{byteLength:16,width:4,height:4}:e===Kw||e===Yw?{byteLength:8,width:4,height:4}:e===Qw||e===Zw||e===Jw||e===eS||e===tS||e===rS?{byteLength:16,width:4,height:4}:e===nS||e===iS||e===sS||e===oS?{byteLength:8,width:4,height:4}:e===aS||e===uS?{byteLength:16,width:4,height:4}:e===lS||e===cS?{byteLength:8,width:4,height:4}:e===hS||e===dS||e===pS||e===fS?{byteLength:16,width:4,height:4}:e===gS||e===mS?{byteLength:16,width:5,height:4}:e===yS||e===bS?{byteLength:16,width:5,height:5}:e===_S||e===vS?{byteLength:16,width:6,height:5}:e===xS||e===TS?{byteLength:16,width:6,height:6}:e===wS||e===SS?{byteLength:16,width:8,height:5}:e===NS||e===ES?{byteLength:16,width:8,height:6}:e===CS||e===AS?{byteLength:16,width:8,height:8}:e===MS||e===RS?{byteLength:16,width:10,height:5}:e===PS||e===DS?{byteLength:16,width:10,height:6}:e===FS||e===OS?{byteLength:16,width:10,height:8}:e===LS||e===BS?{byteLength:16,width:10,height:10}:e===kS||e===IS?{byteLength:16,width:12,height:10}:e===US||e===VS?{byteLength:16,width:12,height:12}:void 0}_convertAddressMode(e){let t=jS;return e===De?t=GS:e===Re&&(t=zS),t}_convertFilterMode(e){let t=$S;return e!==ke&&e!==Be&&e!==Le||(t=HS),t}_getBytesPerTexel(e){return e===rw||e===nw||e===iw||e===sw?1:e===ow||e===aw||e===uw||e===lw||e===cw||e===hw||e===dw?2:e===pw||e===fw||e===gw||e===mw||e===yw||e===bw||e===_w||e===vw||e===xw||e===Tw||e===ww||e===Sw||e===Nw||e===Ew||e===Cw||e===Aw||e===jw||e===Uw||e===Vw||e===Gw?4:e===Mw||e===Rw||e===Pw||e===Dw||e===Fw||e===Ow?8:e===Lw||e===Bw||e===kw?16:void 0}_getTypedArrayType(e){return e===iw?Uint8Array:e===sw?Int8Array:e===rw?Uint8Array:e===nw?Int8Array:e===hw?Uint8Array:e===dw?Int8Array:e===lw?Uint8Array:e===cw?Int8Array:e===Tw?Uint8Array:e===ww?Int8Array:e===_w?Uint8Array:e===xw?Int8Array:e===ow?Uint16Array:e===aw?Int16Array:e===mw?Uint16Array:e===yw?Int16Array:e===Dw?Uint16Array:e===Fw?Int16Array:e===uw||e===bw||e===Ow?Uint16Array:e===pw?Uint32Array:e===fw?Int32Array:e===gw?Float32Array:e===Mw?Uint32Array:e===Rw?Int32Array:e===Pw?Float32Array:e===Lw?Uint32Array:e===Bw?Int32Array:e===kw?Float32Array:e===Sw||e===Nw?Uint8Array:e===Cw||e===Ew||e===Aw?Uint32Array:e===jw?Float32Array:e===Uw||e===Vw?Uint32Array:e===Gw?Float32Array:void 0}_getDimension(e){let t;return t=e.isData3DTexture?FN:DN,t}}function QN(e,t=null){const r=e.format,n=e.type,i=e.colorSpace,s=qe.getTransfer(i);let o;if(!0===e.isCompressedTexture||!0===e.isCompressedArrayTexture)switch(r){case It:o=s===Xe?$w:zw;break;case Ut:o=s===Xe?Ww:Hw;break;case Vt:o=s===Xe?Xw:qw;break;case Wt:o=s===Xe?iS:nS;break;case qt:o=s===Xe?uS:aS;break;case Xt:o=s===Xe?fS:pS;break;case Kt:o=s===Xe?mS:gS;break;case Yt:o=s===Xe?bS:yS;break;case Qt:o=s===Xe?vS:_S;break;case Zt:o=s===Xe?TS:xS;break;case Jt:o=s===Xe?SS:wS;break;case er:o=s===Xe?ES:NS;break;case tr:o=s===Xe?AS:CS;break;case rr:o=s===Xe?RS:MS;break;case nr:o=s===Xe?DS:PS;break;case ir:o=s===Xe?OS:FS;break;case sr:o=s===Xe?BS:LS;break;case or:o=s===Xe?IS:kS;break;case ar:o=s===Xe?VS:US;break;case D:o=s===Xe?vw:_w}else switch(r){case D:switch(n){case Ct:o=xw;break;case At:o=Fw;break;case Mt:o=Dw;break;case ue:o=Lw;break;case Me:o=Bw;break;case oe:o=s===Xe?vw:_w;break;case w:o=Ow;break;case Ye:o=kw}break;case Pt:if(n===Et)o=Ew;break;case Dt:switch(n){case Ct:o=nw;break;case At:o=aw;break;case Mt:o=ow;break;case ue:o=pw;break;case Me:o=fw;break;case oe:o=rw;break;case w:o=uw;break;case Ye:o=gw}break;case Ot:switch(n){case Ct:o=cw;break;case At:o=yw;break;case Mt:o=mw;break;case ue:o=Mw;break;case Me:o=Rw;break;case oe:o=lw;break;case w:o=bw;break;case Ye:o=Pw}break;case ce:switch(n){case Mt:o=Iw;break;case ue:o=Uw;break;case Ye:o=jw}break;case le:switch(n){case ae:o=Vw;break;case Ye:t&&t.features.has(jN.Depth32FloatStencil8),o=Gw}break;case Ft:switch(n){case Me:o=fw;break;case ue:o=pw}break;case Lt:switch(n){case Me:o=Rw;break;case ue:o=Mw}break;case Bt:switch(n){case Me:o=Bw;break;case ue:o=Lw}}return o}const ZN=/^[fn]*\s*([a-z_0-9]+)?\s*\(([\s\S]*?)\)\s*[\-\>]*\s*([a-z_0-9]+(?:<[\s\S]+?>)?)/i,JN=/([a-z_0-9]+)\s*:\s*([a-z_0-9]+(?:<[\s\S]+?>)?)/gi,eE={f32:"float",i32:"int",u32:"uint",bool:"bool","vec2<f32>":"vec2","vec2<i32>":"ivec2","vec2<u32>":"uvec2","vec2<bool>":"bvec2",vec2f:"vec2",vec2i:"ivec2",vec2u:"uvec2",vec2b:"bvec2","vec3<f32>":"vec3","vec3<i32>":"ivec3","vec3<u32>":"uvec3","vec3<bool>":"bvec3",vec3f:"vec3",vec3i:"ivec3",vec3u:"uvec3",vec3b:"bvec3","vec4<f32>":"vec4","vec4<i32>":"ivec4","vec4<u32>":"uvec4","vec4<bool>":"bvec4",vec4f:"vec4",vec4i:"ivec4",vec4u:"uvec4",vec4b:"bvec4","mat2x2<f32>":"mat2",mat2x2f:"mat2","mat3x3<f32>":"mat3",mat3x3f:"mat3","mat4x4<f32>":"mat4",mat4x4f:"mat4",sampler:"sampler",texture_1d:"texture",texture_2d:"texture",texture_2d_array:"texture",texture_multisampled_2d:"cubeTexture",texture_depth_2d:"depthTexture",texture_depth_2d_array:"depthTexture",texture_depth_multisampled_2d:"depthTexture",texture_depth_cube:"depthTexture",texture_depth_cube_array:"depthTexture",texture_3d:"texture3D",texture_cube:"cubeTexture",texture_cube_array:"cubeTexture",texture_storage_1d:"storageTexture",texture_storage_2d:"storageTexture",texture_storage_2d_array:"storageTexture",texture_storage_3d:"storageTexture"};class tE extends ax{constructor(e){const{type:t,inputs:r,name:n,inputsCode:i,blockCode:s,outputType:o}=(e=>{const t=(e=e.trim()).match(ZN);if(null!==t&&4===t.length){const r=t[2],n=[];let i=null;for(;null!==(i=JN.exec(r));)n.push({name:i[1],type:i[2]});const s=[];for(let e=0;e<n.length;e++){const{name:t,type:r}=n[e];let i=r;i.startsWith("ptr")?i="pointer":(i.startsWith("texture")&&(i=r.split("<")[0]),i=eE[i]),s.push(new qv(i,t))}const o=e.substring(t[0].length),a=t[3]||"void",u=void 0!==t[1]?t[1]:"";return{type:eE[a]||a,inputs:s,name:u,inputsCode:r,blockCode:o,outputType:a}}throw new Error("FunctionNode: Function is not a WGSL code.")})(e);super(t,r,n),this.inputsCode=i,this.blockCode=s,this.outputType=o}getCode(e=this.name){const t="void"!==this.outputType?"-> "+this.outputType:"";return`fn ${e} ( ${this.inputsCode.trim()} ) ${t}`+this.blockCode}}class rE extends ox{parseFunction(e){return new tE(e)}}const nE="undefined"!=typeof self?self.GPUShaderStage:{VERTEX:1,FRAGMENT:2,COMPUTE:4},iE={[Ua]:"read",[Va]:"write",[ja]:"read_write"},sE={[De]:"repeat",[Pe]:"clamp",[Re]:"mirror"},oE={vertex:nE?nE.VERTEX:1,fragment:nE?nE.FRAGMENT:2,compute:nE?nE.COMPUTE:4},aE={instance:!0,swizzleAssign:!1,storageBuffer:!0},uE={"^^":"tsl_xor"},lE={float:"f32",int:"i32",uint:"u32",bool:"bool",color:"vec3<f32>",vec2:"vec2<f32>",ivec2:"vec2<i32>",uvec2:"vec2<u32>",bvec2:"vec2<bool>",vec3:"vec3<f32>",ivec3:"vec3<i32>",uvec3:"vec3<u32>",bvec3:"vec3<bool>",vec4:"vec4<f32>",ivec4:"vec4<i32>",uvec4:"vec4<u32>",bvec4:"vec4<bool>",mat2:"mat2x2<f32>",mat3:"mat3x3<f32>",mat4:"mat4x4<f32>"},cE={},hE={tsl_xor:new b_("fn tsl_xor( a : bool, b : bool ) -> bool { return ( a || b ) && !( a && b ); }"),mod_float:new b_("fn tsl_mod_float( x : f32, y : f32 ) -> f32 { return x - y * floor( x / y ); }"),mod_vec2:new b_("fn tsl_mod_vec2( x : vec2f, y : vec2f ) -> vec2f { return x - y * floor( x / y ); }"),mod_vec3:new b_("fn tsl_mod_vec3( x : vec3f, y : vec3f ) -> vec3f { return x - y * floor( x / y ); }"),mod_vec4:new b_("fn tsl_mod_vec4( x : vec4f, y : vec4f ) -> vec4f { return x - y * floor( x / y ); }"),equals_bool:new b_("fn tsl_equals_bool( a : bool, b : bool ) -> bool { return a == b; }"),equals_bvec2:new b_("fn tsl_equals_bvec2( a : vec2f, b : vec2f ) -> vec2<bool> { return vec2<bool>( a.x == b.x, a.y == b.y ); }"),equals_bvec3:new b_("fn tsl_equals_bvec3( a : vec3f, b : vec3f ) -> vec3<bool> { return vec3<bool>( a.x == b.x, a.y == b.y, a.z == b.z ); }"),equals_bvec4:new b_("fn tsl_equals_bvec4( a : vec4f, b : vec4f ) -> vec4<bool> { return vec4<bool>( a.x == b.x, a.y == b.y, a.z == b.z, a.w == b.w ); }"),repeatWrapping_float:new b_("fn tsl_repeatWrapping_float( coord: f32 ) -> f32 { return fract( coord ); }"),mirrorWrapping_float:new b_("fn tsl_mirrorWrapping_float( coord: f32 ) -> f32 { let mirrored = fract( coord * 0.5 ) * 2.0; return 1.0 - abs( 1.0 - mirrored ); }"),clampWrapping_float:new b_("fn tsl_clampWrapping_float( coord: f32 ) -> f32 { return clamp( coord, 0.0, 1.0 ); }"),biquadraticTexture:new b_("\nfn tsl_biquadraticTexture( map : texture_2d<f32>, coord : vec2f, iRes : vec2u, level : u32 ) -> vec4f {\n\n\tlet res = vec2f( iRes );\n\n\tlet uvScaled = coord * res;\n\tlet uvWrapping = ( ( uvScaled % res ) + res ) % res;\n\n\t// https://www.shadertoy.com/view/WtyXRy\n\n\tlet uv = uvWrapping - 0.5;\n\tlet iuv = floor( uv );\n\tlet f = fract( uv );\n\n\tlet rg1 = textureLoad( map, vec2u( iuv + vec2( 0.5, 0.5 ) ) % iRes, level );\n\tlet rg2 = textureLoad( map, vec2u( iuv + vec2( 1.5, 0.5 ) ) % iRes, level );\n\tlet rg3 = textureLoad( map, vec2u( iuv + vec2( 0.5, 1.5 ) ) % iRes, level );\n\tlet rg4 = textureLoad( map, vec2u( iuv + vec2( 1.5, 1.5 ) ) % iRes, level );\n\n\treturn mix( mix( rg1, rg2, f.x ), mix( rg3, rg4, f.x ), f.y );\n\n}\n")},dE={dFdx:"dpdx",dFdy:"- dpdy",mod_float:"tsl_mod_float",mod_vec2:"tsl_mod_vec2",mod_vec3:"tsl_mod_vec3",mod_vec4:"tsl_mod_vec4",equals_bool:"tsl_equals_bool",equals_bvec2:"tsl_equals_bvec2",equals_bvec3:"tsl_equals_bvec3",equals_bvec4:"tsl_equals_bvec4",inversesqrt:"inverseSqrt",bitcast:"bitcast<f32>"};"undefined"!=typeof navigator&&/Windows/g.test(navigator.userAgent)&&(hE.pow_float=new b_("fn tsl_pow_float( a : f32, b : f32 ) -> f32 { return select( -pow( -a, b ), pow( a, b ), a > 0.0 ); }"),hE.pow_vec2=new b_("fn tsl_pow_vec2( a : vec2f, b : vec2f ) -> vec2f { return vec2f( tsl_pow_float( a.x, b.x ), tsl_pow_float( a.y, b.y ) ); }",[hE.pow_float]),hE.pow_vec3=new b_("fn tsl_pow_vec3( a : vec3f, b : vec3f ) -> vec3f { return vec3f( tsl_pow_float( a.x, b.x ), tsl_pow_float( a.y, b.y ), tsl_pow_float( a.z, b.z ) ); }",[hE.pow_float]),hE.pow_vec4=new b_("fn tsl_pow_vec4( a : vec4f, b : vec4f ) -> vec4f { return vec4f( tsl_pow_float( a.x, b.x ), tsl_pow_float( a.y, b.y ), tsl_pow_float( a.z, b.z ), tsl_pow_float( a.w, b.w ) ); }",[hE.pow_float]),dE.pow_float="tsl_pow_float",dE.pow_vec2="tsl_pow_vec2",dE.pow_vec3="tsl_pow_vec3",dE.pow_vec4="tsl_pow_vec4");let pE="";!0!==("undefined"!=typeof navigator&&/Firefox|Deno/g.test(navigator.userAgent))&&(pE+="diagnostic( off, derivative_uniformity );\n");class fE extends Hv{constructor(e,t){super(e,t,new rE),this.uniformGroups={},this.builtins={},this.directives={},this.scopedArrays=new Map}needsToWorkingColorSpace(e){return!0===e.isVideoTexture&&e.colorSpace!==Ke}_generateTextureSample(e,t,r,n,i=this.shaderStage){return"fragment"===i?n?`textureSample( ${t}, ${t}_sampler, ${r}, ${n} )`:`textureSample( ${t}, ${t}_sampler, ${r} )`:this._generateTextureSampleLevel(e,t,r,"0",n)}_generateVideoSample(e,t,r=this.shaderStage){if("fragment"===r)return`textureSampleBaseClampToEdge( ${e}, ${e}_sampler, vec2<f32>( ${t}.x, 1.0 - ${t}.y ) )`}_generateTextureSampleLevel(e,t,r,n,i){return!1===this.isUnfilterable(e)?`textureSampleLevel( ${t}, ${t}_sampler, ${r}, ${n} )`:this.isFilteredTexture(e)?this.generateFilteredTexture(e,t,r,n):this.generateTextureLod(e,t,r,i,n)}generateWrapFunction(e){const t=`tsl_coord_${sE[e.wrapS]}S_${sE[e.wrapT]}_${e.isData3DTexture?"3d":"2d"}T`;let r=cE[t];if(void 0===r){const n=[],i=e.isData3DTexture?"vec3f":"vec2f";let s=`fn ${t}( coord : ${i} ) -> ${i} {\n\n\treturn ${i}(\n`;const o=(e,t)=>{e===De?(n.push(hE.repeatWrapping_float),s+=`\t\ttsl_repeatWrapping_float( coord.${t} )`):e===Pe?(n.push(hE.clampWrapping_float),s+=`\t\ttsl_clampWrapping_float( coord.${t} )`):e===Re?(n.push(hE.mirrorWrapping_float),s+=`\t\ttsl_mirrorWrapping_float( coord.${t} )`):s+=`\t\tcoord.${t}`};o(e.wrapS,"x"),s+=",\n",o(e.wrapT,"y"),e.isData3DTexture&&(s+=",\n",o(e.wrapR,"z")),s+="\n\t);\n\n}\n",cE[t]=r=new b_(s,n)}return r.build(this),t}generateArrayDeclaration(e,t){return`array< ${this.getType(e)}, ${t} >`}generateTextureDimension(e,t,r){const n=this.getDataFromNode(e,this.shaderStage,this.globalCache);void 0===n.dimensionsSnippet&&(n.dimensionsSnippet={});let i=n.dimensionsSnippet[r];if(void 0===n.dimensionsSnippet[r]){let s,o;const{primarySamples:a}=this.renderer.backend.utils.getTextureSampleData(e),u=a>1;o=e.isData3DTexture?"vec3<u32>":"vec2<u32>",s=u||e.isVideoTexture||e.isStorageTexture?t:`${t}${r?`, u32( ${r} )`:""}`,i=new Ph(new nd(`textureDimensions( ${s} )`,o)),n.dimensionsSnippet[r]=i,(e.isArrayTexture||e.isDataArrayTexture||e.isData3DTexture)&&(n.arrayLayerCount=new Ph(new nd(`textureNumLayers(${t})`,"u32"))),e.isTextureCube&&(n.cubeFaceCount=new Ph(new nd("6u","u32")))}return i.build(this)}generateFilteredTexture(e,t,r,n="0u"){this._include("biquadraticTexture");return`tsl_biquadraticTexture( ${t}, ${this.generateWrapFunction(e)}( ${r} ), ${this.generateTextureDimension(e,t,n)}, u32( ${n} ) )`}generateTextureLod(e,t,r,n,i="0u"){const s=this.generateWrapFunction(e),o=this.generateTextureDimension(e,t,i),a=e.isData3DTexture?"vec3":"vec2",u=`${a}<u32>( ${s}( ${r} ) * ${a}<f32>( ${o} ) )`;return this.generateTextureLoad(e,t,u,n,i)}generateTextureLoad(e,t,r,n,i="0u"){let s;return!0===e.isVideoTexture?s=`textureLoad( ${t}, ${r} )`:n?s=`textureLoad( ${t}, ${r}, ${n}, u32( ${i} ) )`:(s=`textureLoad( ${t}, ${r}, u32( ${i} ) )`,this.renderer.backend.compatibilityMode&&e.isDepthTexture&&(s+=".x")),s}generateTextureStore(e,t,r,n,i){let s;return s=n?`textureStore( ${t}, ${r}, ${n}, ${i} )`:`textureStore( ${t}, ${r}, ${i} )`,s}isSampleCompare(e){return!0===e.isDepthTexture&&null!==e.compareFunction}isUnfilterable(e){return"float"!==this.getComponentTypeFromTexture(e)||!this.isAvailable("float32Filterable")&&!0===e.isDataTexture&&e.type===Ye||!1===this.isSampleCompare(e)&&e.minFilter===ke&&e.magFilter===ke||this.renderer.backend.utils.getTextureSampleData(e).primarySamples>1}generateTexture(e,t,r,n,i=this.shaderStage){let s=null;return s=!0===e.isVideoTexture?this._generateVideoSample(t,r,i):this.isUnfilterable(e)?this.generateTextureLod(e,t,r,n,"0",i):this._generateTextureSample(e,t,r,n,i),s}generateTextureGrad(e,t,r,n,i,s=this.shaderStage){if("fragment"===s)return`textureSampleGrad( ${t}, ${t}_sampler, ${r},  ${n[0]}, ${n[1]} )`}generateTextureCompare(e,t,r,n,i,s=this.shaderStage){if("fragment"===s)return!0===e.isDepthTexture&&!0===e.isArrayTexture?`textureSampleCompare( ${t}, ${t}_sampler, ${r}, ${i}, ${n} )`:`textureSampleCompare( ${t}, ${t}_sampler, ${r}, ${n} )`}generateTextureLevel(e,t,r,n,i,s=this.shaderStage){let o=null;return o=!0===e.isVideoTexture?this._generateVideoSample(t,r,s):this._generateTextureSampleLevel(e,t,r,n,i),o}generateTextureBias(e,t,r,n,i,s=this.shaderStage){if("fragment"===s)return`textureSampleBias( ${t}, ${t}_sampler, ${r}, ${n} )`}getPropertyName(e,t=this.shaderStage){if(!0===e.isNodeVarying&&!0===e.needsInterpolation){if("vertex"===t)return`varyings.${e.name}`}else if(!0===e.isNodeUniform){const t=e.name,r=e.type;return"texture"===r||"cubeTexture"===r||"storageTexture"===r||"texture3D"===r?t:"buffer"===r||"storageBuffer"===r||"indirectStorageBuffer"===r?this.isCustomStruct(e)?t:t+".value":e.groupNode.name+"."+t}return super.getPropertyName(e)}getOutputStructName(){return"output"}getFunctionOperator(e){const t=uE[e];return void 0!==t?(this._include(t),t):null}getNodeAccess(e,t){return"compute"!==t?Ua:e.access}getStorageAccess(e,t){return iE[this.getNodeAccess(e,t)]}getUniformFromNode(e,t,r,n=null){const i=super.getUniformFromNode(e,t,r,n),s=this.getDataFromNode(e,r,this.globalCache);if(void 0===s.uniformGPU){let o;const a=e.groupNode,u=a.name,l=this.getBindGroupArray(u,r);if("texture"===t||"cubeTexture"===t||"storageTexture"===t||"texture3D"===t){let n=null;const s=this.getNodeAccess(e,r);if("texture"===t||"storageTexture"===t?n=new eT(i.name,i.node,a,s):"cubeTexture"===t?n=new tT(i.name,i.node,a,s):"texture3D"===t&&(n=new rT(i.name,i.node,a,s)),n.store=!0===e.isStorageTextureNode,n.setVisibility(oE[r]),!1===this.isUnfilterable(e.value)&&!1===n.store){const e=new zN(`${i.name}_sampler`,i.node,a);e.setVisibility(oE[r]),l.push(e,n),o=[e,n]}else l.push(n),o=[n]}else if("buffer"===t||"storageBuffer"===t||"indirectStorageBuffer"===t){const s=new("buffer"===t?Xx:WN)(e,a);s.setVisibility(oE[r]),l.push(s),o=s,i.name=n||"NodeBuffer_"+i.id}else{const e=this.uniformGroups[r]||(this.uniformGroups[r]={});let n=e[u];void 0===n&&(n=new Qx(u,a),n.setVisibility(oE[r]),e[u]=n,l.push(n)),o=this.getNodeUniform(i,t),n.addUniform(o)}s.uniformGPU=o}return i}getBuiltin(e,t,r,n=this.shaderStage){const i=this.builtins[n]||(this.builtins[n]=new Map);return!1===i.has(e)&&i.set(e,{name:e,property:t,type:r}),t}hasBuiltin(e,t=this.shaderStage){return void 0!==this.builtins[t]&&this.builtins[t].has(e)}getVertexIndex(){return"vertex"===this.shaderStage?this.getBuiltin("vertex_index","vertexIndex","u32","attribute"):"vertexIndex"}buildFunctionCode(e){const t=e.layout,r=this.flowShaderNode(e),n=[];for(const s of t.inputs)n.push(s.name+" : "+this.getType(s.type));let i=`fn ${t.name}( ${n.join(", ")} ) -> ${this.getType(t.type)} {\n${r.vars}\n${r.code}\n`;return r.result&&(i+=`\treturn ${r.result};\n`),i+="\n}\n",i}getInstanceIndex(){return"vertex"===this.shaderStage?this.getBuiltin("instance_index","instanceIndex","u32","attribute"):"instanceIndex"}getInvocationLocalIndex(){return this.getBuiltin("local_invocation_index","invocationLocalIndex","u32","attribute")}getSubgroupSize(){return this.enableSubGroups(),this.getBuiltin("subgroup_size","subgroupSize","u32","attribute")}getInvocationSubgroupIndex(){return this.enableSubGroups(),this.getBuiltin("subgroup_invocation_id","invocationSubgroupIndex","u32","attribute")}getSubgroupIndex(){return this.enableSubGroups(),this.getBuiltin("subgroup_id","subgroupIndex","u32","attribute")}getDrawIndex(){return null}getFrontFacing(){return this.getBuiltin("front_facing","isFront","bool")}getFragCoord(){return this.getBuiltin("position","fragCoord","vec4<f32>")+".xy"}getFragDepth(){return"output."+this.getBuiltin("frag_depth","depth","f32","output")}getClipDistance(){return"varyings.hw_clip_distances"}isFlipY(){return!1}enableDirective(e,t=this.shaderStage){(this.directives[t]||(this.directives[t]=new Set)).add(e)}getDirectives(e){const t=[],r=this.directives[e];if(void 0!==r)for(const n of r)t.push(`enable ${n};`);return t.join("\n")}enableSubGroups(){this.enableDirective("subgroups")}enableSubgroupsF16(){this.enableDirective("subgroups-f16")}enableClipDistances(){this.enableDirective("clip_distances")}enableShaderF16(){this.enableDirective("f16")}enableDualSourceBlending(){this.enableDirective("dual_source_blending")}enableHardwareClipping(e){this.enableClipDistances(),this.getBuiltin("clip_distances","hw_clip_distances",`array<f32, ${e} >`,"vertex")}getBuiltins(e){const t=[],r=this.builtins[e];if(void 0!==r)for(const{name:n,property:i,type:s}of r.values())t.push(`@builtin( ${n} ) ${i} : ${s}`);return t.join(",\n\t")}getScopedArray(e,t,r,n){return!1===this.scopedArrays.has(e)&&this.scopedArrays.set(e,{name:e,scope:t,bufferType:r,bufferCount:n}),e}getScopedArrays(e){if("compute"!==e)return;const t=[];for(const{name:r,scope:n,bufferType:i,bufferCount:s}of this.scopedArrays.values()){const e=this.getType(i);t.push(`var<${n}> ${r}: array< ${e}, ${s} >;`)}return t.join("\n")}getAttributes(e){const t=[];if("compute"===e&&(this.getBuiltin("global_invocation_id","globalId","vec3<u32>","attribute"),this.getBuiltin("workgroup_id","workgroupId","vec3<u32>","attribute"),this.getBuiltin("local_invocation_id","localId","vec3<u32>","attribute"),this.getBuiltin("num_workgroups","numWorkgroups","vec3<u32>","attribute"),this.renderer.hasFeature("subgroups")&&(this.enableDirective("subgroups",e),this.getBuiltin("subgroup_size","subgroupSize","u32","attribute"))),"vertex"===e||"compute"===e){const e=this.getBuiltins("attribute");e&&t.push(e);const r=this.getAttributesArray();for(let n=0,i=r.length;n<i;n++){const e=r[n],i=e.name,s=this.getType(e.type);t.push(`@location( ${n} ) ${i} : ${s}`)}}return t.join(",\n\t")}getStructMembers(e){const t=[];for(const r of e.members){const n=e.output?"@location( "+r.index+" ) ":"";let i=this.getType(r.type);r.atomic&&(i="atomic< "+i+" >"),t.push(`\t${n+r.name} : ${i}`)}return e.output&&t.push(`\t${this.getBuiltins("output")}`),t.join(",\n")}getStructs(e){let t="";const r=this.structs[e];if(r.length>0){const e=[];for(const t of r){let r=`struct ${t.name} {\n`;r+=this.getStructMembers(t),r+="\n};",e.push(r)}t="\n"+e.join("\n\n")+"\n"}return t}getVar(e,t,r=null){let n=`var ${t} : `;return n+=null!==r?this.generateArrayDeclaration(e,r):this.getType(e),n}getVars(e){const t=[],r=this.vars[e];if(void 0!==r)for(const n of r)t.push(`\t${this.getVar(n.type,n.name,n.count)};`);return`\n${t.join("\n")}\n`}getVaryings(e){const t=[];if("vertex"===e&&this.getBuiltin("position","Vertex","vec4<f32>","vertex"),"vertex"===e||"fragment"===e){const r=this.varyings,n=this.vars[e];for(let i=0;i<r.length;i++){const s=r[i];if(s.needsInterpolation){let e=`@location( ${i} )`;if(s.interpolationType){const t=null!==s.interpolationSampling?`, ${s.interpolationSampling} )`:" )";e+=` @interpolate( ${s.interpolationType}${t}`}else/^(int|uint|ivec|uvec)/.test(s.type)&&(e+=` @interpolate( ${this.renderer.backend.compatibilityMode?"flat, either":"flat"} )`);t.push(`${e} ${s.name} : ${this.getType(s.type)}`)}else"vertex"===e&&!1===n.includes(s)&&n.push(s)}}const r=this.getBuiltins(e);r&&t.push(r);const n=t.join(",\n\t");return"vertex"===e?this._getWGSLStruct("VaryingsStruct","\t"+n):n}isCustomStruct(e){const t=e.value,r=e.node,n=(t.isBufferAttribute||t.isInstancedBufferAttribute)&&null!==r.structTypeNode,i=r.value&&r.value.array&&"number"==typeof r.value.itemSize&&r.value.array.length>r.value.itemSize;return n&&!i}getUniforms(e){const t=this.uniforms[e],r=[],n=[],i=[],s={};for(const a of t){const t=a.groupNode.name,i=this.bindingsIndexes[t];if("texture"===a.type||"cubeTexture"===a.type||"storageTexture"===a.type||"texture3D"===a.type){const t=a.node.value;let n;!1===this.isUnfilterable(t)&&!0!==a.node.isStorageTextureNode&&(this.isSampleCompare(t)?r.push(`@binding( ${i.binding++} ) @group( ${i.group} ) var ${a.name}_sampler : sampler_comparison;`):r.push(`@binding( ${i.binding++} ) @group( ${i.group} ) var ${a.name}_sampler : sampler;`));let s="";const{primarySamples:o}=this.renderer.backend.utils.getTextureSampleData(t);if(o>1&&(s="_multisampled"),!0===t.isCubeTexture)n="texture_cube<f32>";else if(!0===t.isDepthTexture)n=this.renderer.backend.compatibilityMode&&null===t.compareFunction?`texture${s}_2d<f32>`:`texture_depth${s}_2d${!0===t.isArrayTexture?"_array":""}`;else if(!0===t.isArrayTexture||!0===t.isDataArrayTexture||!0===t.isCompressedArrayTexture)n="texture_2d_array<f32>";else if(!0===t.isVideoTexture)n="texture_external";else if(!0===t.isData3DTexture)n="texture_3d<f32>";else if(!0===a.node.isStorageTextureNode){n=`texture_storage_2d<${QN(t)}, ${this.getStorageAccess(a.node,e)}>`}else{n=`texture${s}_2d<${this.getComponentTypeFromTexture(t).charAt(0)}32>`}r.push(`@binding( ${i.binding++} ) @group( ${i.group} ) var ${a.name} : ${n};`)}else if("buffer"===a.type||"storageBuffer"===a.type||"indirectStorageBuffer"===a.type){const t=a.node,r=this.getType(t.getNodeType(this)),s=t.bufferCount,o=s>0&&"buffer"===a.type?", "+s:"",u=t.isStorageBufferNode?`storage, ${this.getStorageAccess(t,e)}`:"uniform";if(this.isCustomStruct(a))n.push(`@binding( ${i.binding++} ) @group( ${i.group} ) var<${u}> ${a.name} : ${r};`);else{const e=`\tvalue : array< ${t.isAtomic?`atomic<${r}>`:`${r}`}${o} >`;n.push(this._getWGSLStructBinding(a.name,e,u,i.binding++,i.group))}}else{const e=this.getType(this.getVectorType(a.type)),t=a.groupNode.name;(s[t]||(s[t]={index:i.binding++,id:i.group,snippets:[]})).snippets.push(`\t${a.name} : ${e}`)}}for(const a in s){const e=s[a];i.push(this._getWGSLStructBinding(a,e.snippets.join(",\n"),"uniform",e.index,e.id))}let o=r.join("\n");return o+=n.join("\n"),o+=i.join("\n"),o}buildCode(){const e=null!==this.material?{fragment:{},vertex:{}}:{compute:{}};this.sortBindingGroups();for(const t in e){this.shaderStage=t;const r=e[t];r.uniforms=this.getUniforms(t),r.attributes=this.getAttributes(t),r.varyings=this.getVaryings(t),r.structs=this.getStructs(t),r.vars=this.getVars(t),r.codes=this.getCodes(t),r.directives=this.getDirectives(t),r.scopedArrays=this.getScopedArrays(t);let n="// code\n\n";n+=this.flowCode[t];const i=this.flowNodes[t],s=i[i.length-1],o=s.outputNode,a=void 0!==o&&!0===o.isOutputStructNode;for(const e of i){const i=this.getFlowData(e),u=e.name;if(u&&(n.length>0&&(n+="\n"),n+=`\t// flow -> ${u}\n`),n+=`${i.code}\n\t`,e===s&&"compute"!==t)if(n+="// result\n\n\t","vertex"===t)n+=`varyings.Vertex = ${i.result};`;else if("fragment"===t)if(a)r.returnType=o.getNodeType(this),r.structs+="var<private> output : "+r.returnType+";",n+=`return ${i.result};`;else{let e="\t@location(0) color: vec4<f32>";const t=this.getBuiltins("output");t&&(e+=",\n\t"+t),r.returnType="OutputStruct",r.structs+=this._getWGSLStruct("OutputStruct",e),r.structs+="\nvar<private> output : OutputStruct;",n+=`output.color = ${i.result};\n\n\treturn output;`}}r.flow=n}this.shaderStage=null,null!==this.material?(this.vertexShader=this._getWGSLVertexCode(e.vertex),this.fragmentShader=this._getWGSLFragmentCode(e.fragment)):this.computeShader=this._getWGSLComputeCode(e.compute,(this.object.workgroupSize||[64]).join(", "))}getMethod(e,t=null){let r;return null!==t&&(r=this._getWGSLMethod(e+"_"+t)),void 0===r&&(r=this._getWGSLMethod(e)),r||e}getType(e){return lE[e]||e}isAvailable(e){let t=aE[e];return void 0===t&&("float32Filterable"===e?t=this.renderer.hasFeature("float32-filterable"):"clipDistance"===e&&(t=this.renderer.hasFeature("clip-distances")),aE[e]=t),t}_getWGSLMethod(e){return void 0!==hE[e]&&this._include(e),dE[e]}_include(e){const t=hE[e];return t.build(this),null!==this.currentFunctionNode&&this.currentFunctionNode.includes.push(t),t}_getWGSLVertexCode(e){return`${this.getSignature()}\n// directives\n${e.directives}\n\n// structs\n${e.structs}\n\n// uniforms\n${e.uniforms}\n\n// varyings\n${e.varyings}\nvar<private> varyings : VaryingsStruct;\n\n// codes\n${e.codes}\n\n@vertex\nfn main( ${e.attributes} ) -> VaryingsStruct {\n\n\t// vars\n\t${e.vars}\n\n\t// flow\n\t${e.flow}\n\n\treturn varyings;\n\n}\n`}_getWGSLFragmentCode(e){return`${this.getSignature()}\n// global\n${pE}\n\n// structs\n${e.structs}\n\n// uniforms\n${e.uniforms}\n\n// codes\n${e.codes}\n\n@fragment\nfn main( ${e.varyings} ) -> ${e.returnType} {\n\n\t// vars\n\t${e.vars}\n\n\t// flow\n\t${e.flow}\n\n}\n`}_getWGSLComputeCode(e,t){return`${this.getSignature()}\n// directives\n${e.directives}\n\n// system\nvar<private> instanceIndex : u32;\n\n// locals\n${e.scopedArrays}\n\n// structs\n${e.structs}\n\n// uniforms\n${e.uniforms}\n\n// codes\n${e.codes}\n\n@compute @workgroup_size( ${t} )\nfn main( ${e.attributes} ) {\n\n\t// system\n\tinstanceIndex = globalId.x + globalId.y * numWorkgroups.x * u32(${t}) + globalId.z * numWorkgroups.x * numWorkgroups.y * u32(${t});\n\n\t// vars\n\t${e.vars}\n\n\t// flow\n\t${e.flow}\n\n}\n`}_getWGSLStruct(e,t){return`\nstruct ${e} {\n${t}\n};`}_getWGSLStructBinding(e,t,r,n=0,i=0){const s=e+"Struct";return`${this._getWGSLStruct(s,t)}\n@binding( ${n} ) @group( ${i} )\nvar<${r}> ${e} : ${s};`}}class gE{constructor(e){this.backend=e}getCurrentDepthStencilFormat(e){let t;return null!==e.depthTexture?t=this.getTextureFormatGPU(e.depthTexture):e.depth&&e.stencil?t=Vw:e.depth&&(t=Uw),t}getTextureFormatGPU(e){return this.backend.get(e).format}getTextureSampleData(e){let t;if(e.isFramebufferTexture)t=1;else if(e.isDepthTexture&&!e.renderTarget){const e=this.backend.renderer,r=e.getRenderTarget();t=r?r.samples:e.samples}else e.renderTarget&&(t=e.renderTarget.samples);t=t||1;const r=t>1&&null!==e.renderTarget&&!0!==e.isDepthTexture&&!0!==e.isFramebufferTexture;return{samples:t,primarySamples:r?1:t,isMSAA:r}}getCurrentColorFormat(e){let t;return t=null!==e.textures?this.getTextureFormatGPU(e.textures[0]):this.getPreferredCanvasFormat(),t}getCurrentColorSpace(e){return null!==e.textures?e.textures[0].colorSpace:this.backend.renderer.outputColorSpace}getPrimitiveTopology(e,t){return e.isPoints?OT:e.isLineSegments||e.isMesh&&!0===t.wireframe?LT:e.isLine?BT:e.isMesh?kT:void 0}getSampleCount(e){let t=1;return e>1&&(t=Math.pow(2,Math.floor(Math.log2(e))),2===t&&(t=4)),t}getSampleCountRenderContext(e){return null!==e.textures?this.getSampleCount(e.sampleCount):this.getSampleCount(this.backend.renderer.samples)}getPreferredCanvasFormat(){const e=this.backend.parameters.outputType;if(void 0===e)return navigator.gpu.getPreferredCanvasFormat();if(e===oe)return Sw;if(e===w)return Ow;throw new Error("Unsupported outputType")}}const mE=new Map([[Int8Array,["sint8","snorm8"]],[Uint8Array,["uint8","unorm8"]],[Int16Array,["sint16","snorm16"]],[Uint16Array,["uint16","unorm16"]],[Int32Array,["sint32","snorm32"]],[Uint32Array,["uint32","unorm32"]],[Float32Array,["float32"]]]),yE=new Map([[qr,["float16"]]]),bE=new Map([[Int32Array,"sint32"],[Int16Array,"sint32"],[Uint32Array,"uint32"],[Uint16Array,"uint32"],[Float32Array,"float32"]]);class _E{constructor(e){this.backend=e}createAttribute(e,t){const r=this._getBufferAttribute(e),n=this.backend,i=n.get(r);let s=i.buffer;if(void 0===s){const o=n.device;let a=r.array;if(!1===e.normalized)if(a.constructor===Int16Array||a.constructor===Int8Array)a=new Int32Array(a);else if((a.constructor===Uint16Array||a.constructor===Uint8Array)&&(a=new Uint32Array(a),t&GPUBufferUsage.INDEX))for(let e=0;e<a.length;e++)65535===a[e]&&(a[e]=4294967295);if(r.array=a,(r.isStorageBufferAttribute||r.isStorageInstancedBufferAttribute)&&3===r.itemSize){a=new a.constructor(4*r.count);for(let e=0;e<r.count;e++)a.set(r.array.subarray(3*e,3*e+3),4*e);r.itemSize=4,r.array=a,i._force3to4BytesAlignment=!0}const u=a.byteLength,l=u+(4-u%4)%4;s=o.createBuffer({label:r.name,size:l,usage:t,mappedAtCreation:!0}),new a.constructor(s.getMappedRange()).set(a),s.unmap(),i.buffer=s}}updateAttribute(e){const t=this._getBufferAttribute(e),r=this.backend,n=r.device,i=r.get(t),s=r.get(t).buffer;let o=t.array;if(!0===i._force3to4BytesAlignment){o=new o.constructor(4*t.count);for(let e=0;e<t.count;e++)o.set(t.array.subarray(3*e,3*e+3),4*e);t.array=o}const a=this._isTypedArray(o),u=t.updateRanges;if(0===u.length)n.queue.writeBuffer(s,0,o,0);else{const e=a?1:o.BYTES_PER_ELEMENT;for(let t=0,r=u.length;t<r;t++){const r=u[t];let l,c;if(!0===i._force3to4BytesAlignment){l=4*Math.floor(r.start/3)*e,c=4*Math.ceil(r.count/3)*e}else l=r.start*e,c=r.count*e;const h=l*(a?o.BYTES_PER_ELEMENT:1);n.queue.writeBuffer(s,h,o,l,c)}t.clearUpdateRanges()}}createShaderVertexBuffers(e){const t=e.getAttributes(),r=new Map;for(let n=0;n<t.length;n++){const e=t[n],i=e.array.BYTES_PER_ELEMENT,s=this._getBufferAttribute(e);let o=r.get(s);if(void 0===o){let t,n;!0===e.isInterleavedBufferAttribute?(t=e.data.stride*i,n=e.data.isInstancedInterleavedBuffer?VN:UN):(t=e.itemSize*i,n=e.isInstancedBufferAttribute?VN:UN),!1!==e.normalized||e.array.constructor!==Int16Array&&e.array.constructor!==Uint16Array||(t=4),o={arrayStride:t,attributes:[],stepMode:n},r.set(s,o)}const a=this._getVertexFormat(e),u=!0===e.isInterleavedBufferAttribute?e.offset*i:0;o.attributes.push({shaderLocation:n,offset:u,format:a})}return Array.from(r.values())}destroyAttribute(e){const t=this.backend;t.get(this._getBufferAttribute(e)).buffer.destroy(),t.delete(e)}async getArrayBufferAsync(e){const t=this.backend,r=t.device,n=t.get(this._getBufferAttribute(e)).buffer,i=n.size,s=r.createBuffer({label:`${e.name}_readback`,size:i,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),o=r.createCommandEncoder({label:`readback_encoder_${e.name}`});o.copyBufferToBuffer(n,0,s,0,i);const a=o.finish();r.queue.submit([a]),await s.mapAsync(GPUMapMode.READ);const u=s.getMappedRange(),l=new e.array.constructor(u.slice(0));return s.unmap(),l.buffer}_getVertexFormat(e){const{itemSize:t,normalized:r}=e,n=e.array.constructor,i=e.constructor;let s;if(1===t)s=bE.get(n);else{const e=(yE.get(i)||mE.get(n))[r?1:0];if(e){const r=n.BYTES_PER_ELEMENT*t,i=4*Math.floor((r+3)/4)/n.BYTES_PER_ELEMENT;if(i%1)throw new Error("THREE.WebGPUAttributeUtils: Bad vertex format item size.");s=`${e}x${i}`}}return s}_isTypedArray(e){return ArrayBuffer.isView(e)&&!(e instanceof DataView)}_getBufferAttribute(e){return e.isInterleavedBufferAttribute&&(e=e.data),e}}class vE{constructor(e){this.backend=e,this.bindGroupLayoutCache=new WeakMap}createBindingsLayout(e){const t=this.backend,r=t.device,n=[];let i=0;for(const s of e.bindings){const e={binding:i++,visibility:s.visibility};if(s.isUniformBuffer||s.isStorageBuffer){const t={};s.isStorageBuffer&&(4&s.visibility&&(s.access===ja||s.access===Va)?t.type=vN:t.type=xN),e.buffer=t}else if(s.isSampler){const r={};s.texture.isDepthTexture&&(null!==s.texture.compareFunction?r.type=EN:t.compatibilityMode&&(r.type=NN)),e.sampler=r}else if(s.isSampledTexture&&s.texture.isVideoTexture)e.externalTexture={};else if(s.isSampledTexture&&s.store){const t={};t.format=this.backend.get(s.texture).texture.format;const r=s.access;t.access=r===ja?SN:r===Va?TN:wN,e.storageTexture=t}else if(s.isSampledTexture){const r={},{primarySamples:n}=t.utils.getTextureSampleData(s.texture);if(n>1&&(r.multisampled=!0,s.texture.isDepthTexture||(r.sampleType=AN)),s.texture.isDepthTexture)t.compatibilityMode&&null===s.texture.compareFunction?r.sampleType=AN:r.sampleType=MN;else if(s.texture.isDataTexture||s.texture.isDataArrayTexture||s.texture.isData3DTexture){const e=s.texture.type;e===Me?r.sampleType=RN:e===ue?r.sampleType=PN:e===Ye&&(this.backend.hasFeature("float32-filterable")?r.sampleType=CN:r.sampleType=AN)}s.isSampledCubeTexture?r.viewDimension=BN:s.texture.isArrayTexture||s.texture.isDataArrayTexture||s.texture.isCompressedArrayTexture?r.viewDimension=LN:s.isSampledTexture3D&&(r.viewDimension=kN),e.texture=r}n.push(e)}return r.createBindGroupLayout({entries:n})}createBindings(e,t,r,n=0){const{backend:i,bindGroupLayoutCache:s}=this,o=i.get(e);let a,u=s.get(e.bindingsReference);void 0===u&&(u=this.createBindingsLayout(e),s.set(e.bindingsReference,u)),r>0&&(void 0===o.groups&&(o.groups=[],o.versions=[]),o.versions[r]===n&&(a=o.groups[r])),void 0===a&&(a=this.createBindGroup(e,u),r>0&&(o.groups[r]=a,o.versions[r]=n)),o.group=a,o.layout=u}updateBinding(e){const t=this.backend,r=t.device,n=e.buffer,i=t.get(e).buffer;r.queue.writeBuffer(i,0,n,0)}createBindGroupIndex(e,t){const r=this.backend.device,n=GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,i=e[0],s=r.createBuffer({label:"bindingCameraIndex_"+i,size:16,usage:n});r.queue.writeBuffer(s,0,e,0);const o=[{binding:0,resource:{buffer:s}}];return r.createBindGroup({label:"bindGroupCameraIndex_"+i,layout:t,entries:o})}createBindGroup(e,t){const r=this.backend,n=r.device;let i=0;const s=[];for(const o of e.bindings){if(o.isUniformBuffer){const e=r.get(o);if(void 0===e.buffer){const t=o.byteLength,r=GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,i=n.createBuffer({label:"bindingBuffer_"+o.name,size:t,usage:r});e.buffer=i}s.push({binding:i,resource:{buffer:e.buffer}})}else if(o.isStorageBuffer){const e=r.get(o);if(void 0===e.buffer){const t=o.attribute;e.buffer=r.get(t).buffer}s.push({binding:i,resource:{buffer:e.buffer}})}else if(o.isSampler){const e=r.get(o.texture);s.push({binding:i,resource:e.sampler})}else if(o.isSampledTexture){const e=r.get(o.texture);let t;if(void 0!==e.externalTexture)t=n.importExternalTexture({source:e.externalTexture});else{const r=o.store?1:e.texture.mipLevelCount,n=`view-${e.texture.width}-${e.texture.height}-${r}`;if(t=e[n],void 0===t){const i=IN;let s;s=o.isSampledCubeTexture?BN:o.isSampledTexture3D?kN:o.texture.isArrayTexture||o.texture.isDataArrayTexture||o.texture.isCompressedArrayTexture?LN:ON,t=e[n]=e.texture.createView({aspect:i,dimension:s,mipLevelCount:r})}}s.push({binding:i,resource:t})}i++}return n.createBindGroup({label:"bindGroup_"+e.name,layout:t,entries:s})}}class xE{constructor(e){this.backend=e,this._activePipelines=new WeakMap}setPipeline(e,t){this._activePipelines.get(e)!==t&&(e.setPipeline(t),this._activePipelines.set(e,t))}_getSampleCount(e){return this.backend.utils.getSampleCountRenderContext(e)}createRenderPipeline(e,t){const{object:r,material:n,geometry:i,pipeline:s}=e,{vertexProgram:o,fragmentProgram:a}=s,u=this.backend,l=u.device,c=u.utils,h=u.get(s),d=[];for(const A of e.getBindings()){const e=u.get(A);d.push(e.layout)}const p=u.attributeUtils.createShaderVertexBuffers(e);let f;n.blending===dt||n.blending===ee&&!1===n.transparent||(f=this._getBlending(n));let g={};!0===n.stencilWrite&&(g={compare:this._getStencilCompare(n),failOp:this._getStencilOperation(n.stencilFail),depthFailOp:this._getStencilOperation(n.stencilZFail),passOp:this._getStencilOperation(n.stencilZPass)});const m=this._getColorWriteMask(n),y=[];if(null!==e.context.textures){const t=e.context.textures;for(let e=0;e<t.length;e++){const r=c.getTextureFormatGPU(t[e]);y.push({format:r,blend:f,writeMask:m})}}else{const t=c.getCurrentColorFormat(e.context);y.push({format:t,blend:f,writeMask:m})}const b=u.get(o).module,_=u.get(a).module,v=this._getPrimitiveState(r,i,n),x=this._getDepthCompare(n),T=c.getCurrentDepthStencilFormat(e.context),w=this._getSampleCount(e.context),S={label:`renderPipeline_${n.name||n.type}_${n.id}`,vertex:Object.assign({},b,{buffers:p}),fragment:Object.assign({},_,{targets:y}),primitive:v,multisample:{count:w,alphaToCoverageEnabled:n.alphaToCoverage&&w>1},layout:l.createPipelineLayout({bindGroupLayouts:d})},N={},E=e.context.depth,C=e.context.stencil;if(!0!==E&&!0!==C||(!0===E&&(N.format=T,N.depthWriteEnabled=n.depthWrite,N.depthCompare=x),!0===C&&(N.stencilFront=g,N.stencilBack={},N.stencilReadMask=n.stencilFuncMask,N.stencilWriteMask=n.stencilWriteMask),!0===n.polygonOffset&&(N.depthBias=n.polygonOffsetUnits,N.depthBiasSlopeScale=n.polygonOffsetFactor,N.depthBiasClamp=0),S.depthStencil=N),null===t)h.pipeline=l.createRenderPipeline(S);else{const e=new Promise((e=>{l.createRenderPipelineAsync(S).then((t=>{h.pipeline=t,e()}))}));t.push(e)}}createBundleEncoder(e,t="renderBundleEncoder"){const r=this.backend,{utils:n,device:i}=r,s=n.getCurrentDepthStencilFormat(e),o={label:t,colorFormats:[n.getCurrentColorFormat(e)],depthStencilFormat:s,sampleCount:this._getSampleCount(e)};return i.createRenderBundleEncoder(o)}createComputePipeline(e,t){const r=this.backend,n=r.device,i=r.get(e.computeProgram).module,s=r.get(e),o=[];for(const a of t){const e=r.get(a);o.push(e.layout)}s.pipeline=n.createComputePipeline({compute:i,layout:n.createPipelineLayout({bindGroupLayouts:o})})}_getBlending(e){let t,r;const n=e.blending,i=e.blendSrc,s=e.blendDst,o=e.blendEquation;if(n===de){const n=null!==e.blendSrcAlpha?e.blendSrcAlpha:i,a=null!==e.blendDstAlpha?e.blendDstAlpha:s,u=null!==e.blendEquationAlpha?e.blendEquationAlpha:o;t={srcFactor:this._getBlendFactor(i),dstFactor:this._getBlendFactor(s),operation:this._getBlendOperation(o)},r={srcFactor:this._getBlendFactor(n),dstFactor:this._getBlendFactor(a),operation:this._getBlendOperation(u)}}else{const i=(e,n,i,s)=>{t={srcFactor:e,dstFactor:n,operation:sN},r={srcFactor:i,dstFactor:s,operation:sN}};if(e.premultipliedAlpha)switch(n){case ee:i(qS,QS,qS,QS);break;case gt:i(qS,qS,qS,qS);break;case ft:i(WS,KS,WS,qS);break;case pt:i(WS,XS,WS,YS)}else switch(n){case ee:i(YS,QS,qS,QS);break;case gt:i(YS,qS,YS,qS);break;case ft:i(WS,KS,WS,qS);break;case pt:i(WS,XS,WS,XS)}}if(void 0!==t&&void 0!==r)return{color:t,alpha:r}}_getBlendFactor(e){let t;switch(e){case fe:t=WS;break;case ut:t=qS;break;case at:t=XS;break;case rt:t=KS;break;case ot:t=YS;break;case tt:t=QS;break;case it:t=ZS;break;case et:t=JS;break;case nt:t=eN;break;case Je:t=tN;break;case st:t=rN;break;case 211:t=nN;break;case 212:t=iN}return t}_getStencilCompare(e){let t;switch(e.stencilFunc){case Br:t=UT;break;case Lr:t=WT;break;case Or:t=VT;break;case Fr:t=GT;break;case Dr:t=jT;break;case Pr:t=HT;break;case Rr:t=zT;break;case Mr:t=$T}return t}_getStencilOperation(e){let t;switch(e){case $r:t=dN;break;case zr:t=pN;break;case Gr:t=fN;break;case jr:t=gN;break;case Vr:t=mN;break;case Ur:t=yN;break;case Ir:t=bN;break;case kr:t=_N}return t}_getBlendOperation(e){let t;switch(e){case pe:t=sN;break;case Ze:t=oN;break;case Qe:t=aN;break;case Wr:t=uN;break;case Hr:t=lN}return t}_getPrimitiveState(e,t,r){const n={},i=this.backend.utils;switch(n.topology=i.getPrimitiveTopology(e,r),null!==t.index&&!0===e.isLine&&!0!==e.isLineSegments&&(n.stripIndexFormat=t.index.array instanceof Uint16Array?ew:tw),r.side){case B:n.frontFace=YT,n.cullMode=JT;break;case L:n.frontFace=YT,n.cullMode=ZT;break;case k:n.frontFace=YT,n.cullMode=QT}return n}_getColorWriteMask(e){return!0===e.colorWrite?hN:cN}_getDepthCompare(e){let t;if(!1===e.depthTest)t=WT;else{switch(e.depthFunc){case wt:t=UT;break;case Tt:t=WT;break;case xt:t=VT;break;case vt:t=GT;break;case _t:t=jT;break;case bt:t=HT;break;case yt:t=zT;break;case mt:t=$T}}return t}}class TE extends RT{constructor(e,t,r=2048){super(r),this.device=e,this.type=t,this.querySet=this.device.createQuerySet({type:"timestamp",count:this.maxQueries,label:`queryset_global_timestamp_${t}`});const n=8*this.maxQueries;this.resolveBuffer=this.device.createBuffer({label:`buffer_timestamp_resolve_${t}`,size:n,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.COPY_SRC}),this.resultBuffer=this.device.createBuffer({label:`buffer_timestamp_result_${t}`,size:n,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ})}allocateQueriesForContext(e){if(!this.trackTimestamp||this.isDisposed)return null;if(this.currentQueryIndex+2>this.maxQueries)return Ee(`WebGPUTimestampQueryPool [${this.type}]: Maximum number of queries exceeded, when using trackTimestamp it is necessary to resolves the queries via renderer.resolveTimestampsAsync( THREE.TimestampQuery.${this.type.toUpperCase()} ).`),null;const t=this.currentQueryIndex;return this.currentQueryIndex+=2,this.queryOffsets.set(e.id,t),t}async resolveQueriesAsync(){if(!this.trackTimestamp||0===this.currentQueryIndex||this.isDisposed)return this.lastValue;if(this.pendingResolve)return this.pendingResolve;this.pendingResolve=this._resolveQueries();try{return await this.pendingResolve}finally{this.pendingResolve=null}}async _resolveQueries(){if(this.isDisposed)return this.lastValue;try{if("unmapped"!==this.resultBuffer.mapState)return this.lastValue;const e=new Map(this.queryOffsets),t=this.currentQueryIndex,r=8*t;this.currentQueryIndex=0,this.queryOffsets.clear();const n=this.device.createCommandEncoder();n.resolveQuerySet(this.querySet,0,t,this.resolveBuffer,0),n.copyBufferToBuffer(this.resolveBuffer,0,this.resultBuffer,0,r);const i=n.finish();if(this.device.queue.submit([i]),"unmapped"!==this.resultBuffer.mapState)return this.lastValue;if(await this.resultBuffer.mapAsync(GPUMapMode.READ,0,r),this.isDisposed)return"mapped"===this.resultBuffer.mapState&&this.resultBuffer.unmap(),this.lastValue;const s=new BigUint64Array(this.resultBuffer.getMappedRange(0,r));let o=0;for(const[,a]of e){const e=s[a],t=s[a+1];o+=Number(t-e)/1e6}return this.resultBuffer.unmap(),this.lastValue=o,o}catch(e){return"mapped"===this.resultBuffer.mapState&&this.resultBuffer.unmap(),this.lastValue}}async dispose(){if(!this.isDisposed){if(this.isDisposed=!0,this.pendingResolve)try{await this.pendingResolve}catch(e){}if(this.resultBuffer&&"mapped"===this.resultBuffer.mapState)try{this.resultBuffer.unmap()}catch(e){}this.querySet&&(this.querySet.destroy(),this.querySet=null),this.resolveBuffer&&(this.resolveBuffer.destroy(),this.resolveBuffer=null),this.resultBuffer&&(this.resultBuffer.destroy(),this.resultBuffer=null),this.queryOffsets.clear(),this.pendingResolve=null}}}class wE extends dT{constructor(e={}){super(e),this.isWebGPUBackend=!0,this.parameters.alpha=void 0===e.alpha||e.alpha,this.parameters.compatibilityMode=void 0!==e.compatibilityMode&&e.compatibilityMode,this.parameters.requiredLimits=void 0===e.requiredLimits?{}:e.requiredLimits,this.compatibilityMode=this.parameters.compatibilityMode,this.device=null,this.context=null,this.colorBuffer=null,this.defaultRenderPassdescriptor=null,this.utils=new gE(this),this.attributeUtils=new _E(this),this.bindingUtils=new vE(this),this.pipelineUtils=new xE(this),this.textureUtils=new YN(this),this.occludedResolveCache=new Map}async init(e){await super.init(e);const t=this.parameters;let r;if(void 0===t.device){const e={powerPreference:t.powerPreference,featureLevel:t.compatibilityMode?"compatibility":void 0},n="undefined"!=typeof navigator?await navigator.gpu.requestAdapter(e):null;if(null===n)throw new Error("WebGPUBackend: Unable to create WebGPU adapter.");const i=Object.values(jN),s=[];for(const t of i)n.features.has(t)&&s.push(t);const o={requiredFeatures:s,requiredLimits:t.requiredLimits};r=await n.requestDevice(o)}else r=t.device;r.lost.then((t=>{const r={api:"WebGPU",message:t.message||"Unknown reason",reason:t.reason||null,originalEvent:t};e.onDeviceLost(r)}));const n=void 0!==t.context?t.context:e.domElement.getContext("webgpu");this.device=r,this.context=n;const i=t.alpha?"premultiplied":"opaque";this.trackTimestamp=this.trackTimestamp&&this.hasFeature(jN.TimestampQuery),this.context.configure({device:this.device,format:this.utils.getPreferredCanvasFormat(),usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC,alphaMode:i}),this.updateSize()}get coordinateSystem(){return Ne}async getArrayBufferAsync(e){return await this.attributeUtils.getArrayBufferAsync(e)}getContext(){return this.context}_getDefaultRenderPassDescriptor(){let e=this.defaultRenderPassdescriptor;if(null===e){const t=this.renderer;e={colorAttachments:[{view:null}]},!0!==this.renderer.depth&&!0!==this.renderer.stencil||(e.depthStencilAttachment={view:this.textureUtils.getDepthBuffer(t.depth,t.stencil).createView()});const r=e.colorAttachments[0];this.renderer.samples>0?r.view=this.colorBuffer.createView():r.resolveTarget=void 0,this.defaultRenderPassdescriptor=e}const t=e.colorAttachments[0];return this.renderer.samples>0?t.resolveTarget=this.context.getCurrentTexture().createView():t.view=this.context.getCurrentTexture().createView(),e}_isRenderCameraDepthArray(e){return e.depthTexture&&e.depthTexture.image.depth>1&&e.camera.isArrayCamera}_getRenderPassDescriptor(e,t={}){const r=e.renderTarget,n=this.get(r);let i=n.descriptors;if(void 0===i||n.width!==r.width||n.height!==r.height||n.dimensions!==r.dimensions||n.activeMipmapLevel!==e.activeMipmapLevel||n.activeCubeFace!==e.activeCubeFace||n.samples!==r.samples){i={},n.descriptors=i;const e=()=>{r.removeEventListener("dispose",e),this.delete(r)};!1===r.hasEventListener("dispose",e)&&r.addEventListener("dispose",e)}const s=e.getCacheKey();let o=i[s];if(void 0===o){const t=e.textures,a=[];let u;const l=this._isRenderCameraDepthArray(e);for(let n=0;n<t.length;n++){const i=this.get(t[n]),s={label:`colorAttachment_${n}`,baseMipLevel:e.activeMipmapLevel,mipLevelCount:1,baseArrayLayer:e.activeCubeFace,arrayLayerCount:1,dimension:ON};if(r.isRenderTarget3D)u=e.activeCubeFace,s.baseArrayLayer=0,s.dimension=kN,s.depthOrArrayLayers=t[n].image.depth;else if(r.isRenderTarget&&t[n].image.depth>1)if(!0===l){const t=e.camera.cameras;for(let e=0;e<t.length;e++){const t={...s,baseArrayLayer:e,arrayLayerCount:1,dimension:ON},r=i.texture.createView(t);a.push({view:r,resolveTarget:void 0,depthSlice:void 0})}}else s.dimension=LN,s.depthOrArrayLayers=t[n].image.depth;if(!0!==l){const e=i.texture.createView(s);let t,r;void 0!==i.msaaTexture?(t=i.msaaTexture.createView(),r=e):(t=e,r=void 0),a.push({view:t,resolveTarget:r,depthSlice:u})}}if(o={textureViews:a},e.depth){const t=this.get(e.depthTexture),r={};e.depthTexture.isArrayTexture&&(r.dimension=ON,r.arrayLayerCount=1,r.baseArrayLayer=e.activeCubeFace),o.depthStencilView=t.texture.createView(r)}i[s]=o,n.width=r.width,n.height=r.height,n.samples=r.samples,n.activeMipmapLevel=e.activeMipmapLevel,n.activeCubeFace=e.activeCubeFace,n.dimensions=r.dimensions}const a={colorAttachments:[]};for(let u=0;u<o.textureViews.length;u++){const e=o.textureViews[u];let r={r:0,g:0,b:0,a:1};0===u&&t.clearValue&&(r=t.clearValue),a.colorAttachments.push({view:e.view,depthSlice:e.depthSlice,resolveTarget:e.resolveTarget,loadOp:t.loadOp||XT,storeOp:t.storeOp||qT,clearValue:r})}return o.depthStencilView&&(a.depthStencilAttachment={view:o.depthStencilView}),a}beginRender(e){const t=this.get(e),r=this.device,n=e.occlusionQueryCount;let i,s;n>0&&(t.currentOcclusionQuerySet&&t.currentOcclusionQuerySet.destroy(),t.currentOcclusionQueryBuffer&&t.currentOcclusionQueryBuffer.destroy(),t.currentOcclusionQuerySet=t.occlusionQuerySet,t.currentOcclusionQueryBuffer=t.occlusionQueryBuffer,t.currentOcclusionQueryObjects=t.occlusionQueryObjects,i=r.createQuerySet({type:"occlusion",count:n,label:`occlusionQuerySet_${e.id}`}),t.occlusionQuerySet=i,t.occlusionQueryIndex=0,t.occlusionQueryObjects=new Array(n),t.lastOcclusionObject=null),s=null===e.textures?this._getDefaultRenderPassDescriptor():this._getRenderPassDescriptor(e,{loadOp:XT}),this.initTimestampQuery(e,s),s.occlusionQuerySet=i;const o=s.depthStencilAttachment;if(null!==e.textures){const t=s.colorAttachments;for(let r=0;r<t.length;r++){const n=t[r];e.clearColor?(n.clearValue=0===r?e.clearColorValue:{r:0,g:0,b:0,a:1},n.loadOp=KT):n.loadOp=XT,n.storeOp=qT}}else{const t=s.colorAttachments[0];e.clearColor?(t.clearValue=e.clearColorValue,t.loadOp=KT):t.loadOp=XT,t.storeOp=qT}e.depth&&(e.clearDepth?(o.depthClearValue=e.clearDepthValue,o.depthLoadOp=KT):o.depthLoadOp=XT,o.depthStoreOp=qT),e.stencil&&(e.clearStencil?(o.stencilClearValue=e.clearStencilValue,o.stencilLoadOp=KT):o.stencilLoadOp=XT,o.stencilStoreOp=qT);const a=r.createCommandEncoder({label:"renderContext_"+e.id});if(!0===this._isRenderCameraDepthArray(e)){const r=e.camera.cameras;t.layerDescriptors&&t.layerDescriptors.length===r.length?this._updateDepthLayerDescriptors(e,t,r):this._createDepthLayerDescriptors(e,t,s,r),t.bundleEncoders=[],t.bundleSets=[];for(let n=0;n<r.length;n++){const r=this.pipelineUtils.createBundleEncoder(e,"renderBundleArrayCamera_"+n),i={attributes:{},bindingGroups:[],pipeline:null,index:null};t.bundleEncoders.push(r),t.bundleSets.push(i)}t.currentPass=null}else{const r=a.beginRenderPass(s);if(t.currentPass=r,e.viewport&&this.updateViewport(e),e.scissor){const{x:t,y:n,width:i,height:s}=e.scissorValue;r.setScissorRect(t,n,i,s)}}t.descriptor=s,t.encoder=a,t.currentSets={attributes:{},bindingGroups:[],pipeline:null,index:null},t.renderBundles=[]}_createDepthLayerDescriptors(e,t,r,n){const i=r.depthStencilAttachment;t.layerDescriptors=[];const s=this.get(e.depthTexture);s.viewCache||(s.viewCache=[]);for(let o=0;o<n.length;o++){const n={...r,colorAttachments:[{...r.colorAttachments[0],view:r.colorAttachments[o].view}]};if(r.depthStencilAttachment){const t=o;s.viewCache[t]||(s.viewCache[t]=s.texture.createView({dimension:ON,baseArrayLayer:o,arrayLayerCount:1})),n.depthStencilAttachment={view:s.viewCache[t],depthLoadOp:i.depthLoadOp||KT,depthStoreOp:i.depthStoreOp||qT,depthClearValue:i.depthClearValue||1},e.stencil&&(n.depthStencilAttachment.stencilLoadOp=i.stencilLoadOp,n.depthStencilAttachment.stencilStoreOp=i.stencilStoreOp,n.depthStencilAttachment.stencilClearValue=i.stencilClearValue)}else n.depthStencilAttachment={...i};t.layerDescriptors.push(n)}}_updateDepthLayerDescriptors(e,t,r){for(let n=0;n<r.length;n++){const r=t.layerDescriptors[n];if(r.depthStencilAttachment){const t=r.depthStencilAttachment;e.depth&&(e.clearDepth?(t.depthClearValue=e.clearDepthValue,t.depthLoadOp=KT):t.depthLoadOp=XT),e.stencil&&(e.clearStencil?(t.stencilClearValue=e.clearStencilValue,t.stencilLoadOp=KT):t.stencilLoadOp=XT)}}}finishRender(e){const t=this.get(e),r=e.occlusionQueryCount;t.renderBundles.length>0&&t.currentPass.executeBundles(t.renderBundles),r>t.occlusionQueryIndex&&t.currentPass.endOcclusionQuery();const n=t.encoder;if(!0===this._isRenderCameraDepthArray(e)){const r=[];for(let e=0;e<t.bundleEncoders.length;e++){const n=t.bundleEncoders[e];r.push(n.finish())}for(let i=0;i<t.layerDescriptors.length;i++)if(i<r.length){const s=t.layerDescriptors[i],o=n.beginRenderPass(s);if(e.viewport){const{x:t,y:r,width:n,height:i,minDepth:s,maxDepth:a}=e.viewportValue;o.setViewport(t,r,n,i,s,a)}if(e.scissor){const{x:t,y:r,width:n,height:i}=e.scissorValue;o.setScissorRect(t,r,n,i)}o.executeBundles([r[i]]),o.end()}}else t.currentPass&&t.currentPass.end();if(r>0){const n=8*r;let i=this.occludedResolveCache.get(n);void 0===i&&(i=this.device.createBuffer({size:n,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.COPY_SRC}),this.occludedResolveCache.set(n,i));const s=this.device.createBuffer({size:n,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ});t.encoder.resolveQuerySet(t.occlusionQuerySet,0,r,i,0),t.encoder.copyBufferToBuffer(i,0,s,0,n),t.occlusionQueryBuffer=s,this.resolveOccludedAsync(e)}if(this.device.queue.submit([t.encoder.finish()]),null!==e.textures){const t=e.textures;for(let e=0;e<t.length;e++){const r=t[e];!0===r.generateMipmaps&&this.textureUtils.generateMipmaps(r)}}}isOccluded(e,t){const r=this.get(e);return r.occluded&&r.occluded.has(t)}async resolveOccludedAsync(e){const t=this.get(e),{currentOcclusionQueryBuffer:r,currentOcclusionQueryObjects:n}=t;if(r&&n){const e=new WeakSet;t.currentOcclusionQueryObjects=null,t.currentOcclusionQueryBuffer=null,await r.mapAsync(GPUMapMode.READ);const i=r.getMappedRange(),s=new BigUint64Array(i);for(let t=0;t<n.length;t++)s[t]===BigInt(0)&&e.add(n[t]);r.destroy(),t.occluded=e}}updateViewport(e){const{currentPass:t}=this.get(e),{x:r,y:n,width:i,height:s,minDepth:o,maxDepth:a}=e.viewportValue;t.setViewport(r,n,i,s,o,a)}getClearColor(){const e=super.getClearColor();return!0===this.renderer.alpha&&(e.r*=e.a,e.g*=e.a,e.b*=e.a),e}clear(e,t,r,n=null){const i=this.device,s=this.renderer;let o,a,u,l,c=[];if(e){const e=this.getClearColor();a={r:e.r,g:e.g,b:e.b,a:e.a}}if(null===n){u=s.depth,l=s.stencil;const t=this._getDefaultRenderPassDescriptor();if(e){c=t.colorAttachments;const e=c[0];e.clearValue=a,e.loadOp=KT,e.storeOp=qT}(u||l)&&(o=t.depthStencilAttachment)}else{u=n.depth,l=n.stencil;const i={loadOp:e?KT:XT,clearValue:e?a:void 0};u&&(i.depthLoadOp=t?KT:XT,i.depthClearValue=t?s.getClearDepth():void 0,i.depthStoreOp=qT),l&&(i.stencilLoadOp=r?KT:XT,i.stencilClearValue=r?s.getClearStencil():void 0,i.stencilStoreOp=qT);const h=this._getRenderPassDescriptor(n,i);c=h.colorAttachments,o=h.depthStencilAttachment}u&&o&&void 0===o.depthLoadOp&&(t?(o.depthLoadOp=KT,o.depthClearValue=s.getClearDepth(),o.depthStoreOp=qT):(o.depthLoadOp=XT,o.depthStoreOp=qT)),l&&o&&void 0===o.stencilLoadOp&&(r?(o.stencilLoadOp=KT,o.stencilClearValue=s.getClearStencil(),o.stencilStoreOp=qT):(o.stencilLoadOp=XT,o.stencilStoreOp=qT));const h=i.createCommandEncoder({label:"clear"});h.beginRenderPass({colorAttachments:c,depthStencilAttachment:o}).end(),i.queue.submit([h.finish()])}beginCompute(e){const t=this.get(e),r={label:"computeGroup_"+e.id};this.initTimestampQuery(e,r),t.cmdEncoderGPU=this.device.createCommandEncoder({label:"computeGroup_"+e.id}),t.passEncoderGPU=t.cmdEncoderGPU.beginComputePass(r)}compute(e,t,r,n){const{passEncoderGPU:i}=this.get(e),s=this.get(n).pipeline;this.pipelineUtils.setPipeline(i,s);for(let l=0,c=r.length;l<c;l++){const e=r[l],t=this.get(e);i.setBindGroup(l,t.group)}const o=this.device.limits.maxComputeWorkgroupsPerDimension,a=this.get(t);void 0===a.dispatchSize&&(a.dispatchSize={x:0,y:1,z:1});const{dispatchSize:u}=a;t.dispatchCount>o?(u.x=Math.min(t.dispatchCount,o),u.y=Math.ceil(t.dispatchCount/o)):u.x=t.dispatchCount,i.dispatchWorkgroups(u.x,u.y,u.z)}finishCompute(e){const t=this.get(e);t.passEncoderGPU.end(),this.device.queue.submit([t.cmdEncoderGPU.finish()])}async waitForGPU(){await this.device.queue.onSubmittedWorkDone()}draw(e,t){const{object:r,material:n,context:i,pipeline:s}=e,o=e.getBindings(),a=this.get(i),u=this.get(s).pipeline,l=e.getIndex(),c=null!==l,h=e.getDrawParameters();if(null===h)return;const d=(t,r)=>{this.pipelineUtils.setPipeline(t,u),r.pipeline=u;const s=r.bindingGroups;for(let e=0,n=o.length;e<n;e++){const r=o[e],n=this.get(r);s[r.index]!==r.id&&(t.setBindGroup(r.index,n.group),s[r.index]=r.id)}if(!0===c&&r.index!==l){const e=this.get(l).buffer,n=l.array instanceof Uint16Array?ew:tw;t.setIndexBuffer(e,n),r.index=l}const h=e.getVertexBuffers();for(let e=0,n=h.length;e<n;e++){const n=h[e];if(r.attributes[e]!==n){const i=this.get(n).buffer;t.setVertexBuffer(e,i),r.attributes[e]=n}}!0===i.stencil&&!0===n.stencilWrite&&a.currentStencilRef!==n.stencilRef&&(t.setStencilReference(n.stencilRef),a.currentStencilRef=n.stencilRef)},p=(n,i)=>{if(d(n,i),!0===r.isBatchedMesh){const e=r._multiDrawStarts,i=r._multiDrawCounts,s=r._multiDrawCount,o=r._multiDrawInstances;null!==o&&Ee("THREE.WebGPUBackend: renderMultiDrawInstances has been deprecated and will be removed in r184. Append to renderMultiDraw arguments and use indirection.");for(let a=0;a<s;a++){const s=o?o[a]:1,u=s>1?0:a;!0===c?n.drawIndexed(i[a],s,e[a]/l.array.BYTES_PER_ELEMENT,0,u):n.draw(i[a],s,e[a],u),t.update(r,i[a],s)}}else if(!0===c){const{vertexCount:i,instanceCount:s,firstVertex:o}=h,a=e.getIndirect();if(null!==a){const e=this.get(a).buffer;n.drawIndexedIndirect(e,0)}else n.drawIndexed(i,s,o,0,0);t.update(r,i,s)}else{const{vertexCount:i,instanceCount:s,firstVertex:o}=h,a=e.getIndirect();if(null!==a){const e=this.get(a).buffer;n.drawIndirect(e,0)}else n.draw(i,s,o,0);t.update(r,i,s)}};if(e.camera.isArrayCamera&&e.camera.cameras.length>0){const t=this.get(e.camera),n=e.camera.cameras,s=e.getBindingGroup("cameraIndex");if(void 0===t.indexesGPU||t.indexesGPU.length!==n.length){const e=this.get(s),r=[],i=new Uint32Array([0,0,0,0]);for(let t=0,s=n.length;t<s;t++){i[0]=t;const n=this.bindingUtils.createBindGroupIndex(i,e.layout);r.push(n)}t.indexesGPU=r}const o=this.renderer.getPixelRatio();for(let e=0,u=n.length;e<u;e++){const u=n[e];if(r.layers.test(u.layers)){const r=u.viewport;let n=a.currentPass,l=a.currentSets;if(a.bundleEncoders){n=a.bundleEncoders[e],l=a.bundleSets[e]}r&&n.setViewport(Math.floor(r.x*o),Math.floor(r.y*o),Math.floor(r.width*o),Math.floor(r.height*o),i.viewportValue.minDepth,i.viewportValue.maxDepth),s&&t.indexesGPU&&(n.setBindGroup(s.index,t.indexesGPU[e]),l.bindingGroups[s.index]=s.id),p(n,l)}}}else if(a.currentPass){if(void 0!==a.occlusionQuerySet){const e=a.lastOcclusionObject;e!==r&&(null!==e&&!0===e.occlusionTest&&(a.currentPass.endOcclusionQuery(),a.occlusionQueryIndex++),!0===r.occlusionTest&&(a.currentPass.beginOcclusionQuery(a.occlusionQueryIndex),a.occlusionQueryObjects[a.occlusionQueryIndex]=r),a.lastOcclusionObject=r)}p(a.currentPass,a.currentSets)}}needsRenderUpdate(e){const t=this.get(e),{object:r,material:n}=e,i=this.utils,s=i.getSampleCountRenderContext(e.context),o=i.getCurrentColorSpace(e.context),a=i.getCurrentColorFormat(e.context),u=i.getCurrentDepthStencilFormat(e.context),l=i.getPrimitiveTopology(r,n);let c=!1;return t.material===n&&t.materialVersion===n.version&&t.transparent===n.transparent&&t.blending===n.blending&&t.premultipliedAlpha===n.premultipliedAlpha&&t.blendSrc===n.blendSrc&&t.blendDst===n.blendDst&&t.blendEquation===n.blendEquation&&t.blendSrcAlpha===n.blendSrcAlpha&&t.blendDstAlpha===n.blendDstAlpha&&t.blendEquationAlpha===n.blendEquationAlpha&&t.colorWrite===n.colorWrite&&t.depthWrite===n.depthWrite&&t.depthTest===n.depthTest&&t.depthFunc===n.depthFunc&&t.stencilWrite===n.stencilWrite&&t.stencilFunc===n.stencilFunc&&t.stencilFail===n.stencilFail&&t.stencilZFail===n.stencilZFail&&t.stencilZPass===n.stencilZPass&&t.stencilFuncMask===n.stencilFuncMask&&t.stencilWriteMask===n.stencilWriteMask&&t.side===n.side&&t.alphaToCoverage===n.alphaToCoverage&&t.sampleCount===s&&t.colorSpace===o&&t.colorFormat===a&&t.depthStencilFormat===u&&t.primitiveTopology===l&&t.clippingContextCacheKey===e.clippingContextCacheKey||(t.material=n,t.materialVersion=n.version,t.transparent=n.transparent,t.blending=n.blending,t.premultipliedAlpha=n.premultipliedAlpha,t.blendSrc=n.blendSrc,t.blendDst=n.blendDst,t.blendEquation=n.blendEquation,t.blendSrcAlpha=n.blendSrcAlpha,t.blendDstAlpha=n.blendDstAlpha,t.blendEquationAlpha=n.blendEquationAlpha,t.colorWrite=n.colorWrite,t.depthWrite=n.depthWrite,t.depthTest=n.depthTest,t.depthFunc=n.depthFunc,t.stencilWrite=n.stencilWrite,t.stencilFunc=n.stencilFunc,t.stencilFail=n.stencilFail,t.stencilZFail=n.stencilZFail,t.stencilZPass=n.stencilZPass,t.stencilFuncMask=n.stencilFuncMask,t.stencilWriteMask=n.stencilWriteMask,t.side=n.side,t.alphaToCoverage=n.alphaToCoverage,t.sampleCount=s,t.colorSpace=o,t.colorFormat=a,t.depthStencilFormat=u,t.primitiveTopology=l,t.clippingContextCacheKey=e.clippingContextCacheKey,c=!0),c}getRenderCacheKey(e){const{object:t,material:r}=e,n=this.utils,i=e.context;return[r.transparent,r.blending,r.premultipliedAlpha,r.blendSrc,r.blendDst,r.blendEquation,r.blendSrcAlpha,r.blendDstAlpha,r.blendEquationAlpha,r.colorWrite,r.depthWrite,r.depthTest,r.depthFunc,r.stencilWrite,r.stencilFunc,r.stencilFail,r.stencilZFail,r.stencilZPass,r.stencilFuncMask,r.stencilWriteMask,r.side,n.getSampleCountRenderContext(i),n.getCurrentColorSpace(i),n.getCurrentColorFormat(i),n.getCurrentDepthStencilFormat(i),n.getPrimitiveTopology(t,r),e.getGeometryCacheKey(),e.clippingContextCacheKey].join()}createSampler(e){this.textureUtils.createSampler(e)}destroySampler(e){this.textureUtils.destroySampler(e)}createDefaultTexture(e){this.textureUtils.createDefaultTexture(e)}createTexture(e,t){this.textureUtils.createTexture(e,t)}updateTexture(e,t){this.textureUtils.updateTexture(e,t)}generateMipmaps(e){this.textureUtils.generateMipmaps(e)}destroyTexture(e){this.textureUtils.destroyTexture(e)}async copyTextureToBuffer(e,t,r,n,i,s){return this.textureUtils.copyTextureToBuffer(e,t,r,n,i,s)}initTimestampQuery(e,t){if(!this.trackTimestamp)return;const r=e.isComputeNode?"compute":"render";this.timestampQueryPool[r]||(this.timestampQueryPool[r]=new TE(this.device,r,2048));const n=this.timestampQueryPool[r],i=n.allocateQueriesForContext(e);t.timestampWrites={querySet:n.querySet,beginningOfPassWriteIndex:i,endOfPassWriteIndex:i+1}}createNodeBuilder(e,t){return new fE(e,t)}createProgram(e){this.get(e).module={module:this.device.createShaderModule({code:e.code,label:e.stage+(""!==e.name?`_${e.name}`:"")}),entryPoint:"main"}}destroyProgram(e){this.delete(e)}createRenderPipeline(e,t){this.pipelineUtils.createRenderPipeline(e,t)}createComputePipeline(e,t){this.pipelineUtils.createComputePipeline(e,t)}beginBundle(e){const t=this.get(e);t._currentPass=t.currentPass,t._currentSets=t.currentSets,t.currentSets={attributes:{},bindingGroups:[],pipeline:null,index:null},t.currentPass=this.pipelineUtils.createBundleEncoder(e)}finishBundle(e,t){const r=this.get(e),n=r.currentPass.finish();this.get(t).bundleGPU=n,r.currentSets=r._currentSets,r.currentPass=r._currentPass}addBundle(e,t){this.get(e).renderBundles.push(this.get(t).bundleGPU)}createBindings(e,t,r,n){this.bindingUtils.createBindings(e,t,r,n)}updateBindings(e,t,r,n){this.bindingUtils.createBindings(e,t,r,n)}updateBinding(e){this.bindingUtils.updateBinding(e)}createIndexAttribute(e){this.attributeUtils.createAttribute(e,GPUBufferUsage.INDEX|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST)}createAttribute(e){this.attributeUtils.createAttribute(e,GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST)}createStorageAttribute(e){this.attributeUtils.createAttribute(e,GPUBufferUsage.STORAGE|GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST)}createIndirectStorageAttribute(e){this.attributeUtils.createAttribute(e,GPUBufferUsage.STORAGE|GPUBufferUsage.INDIRECT|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST)}updateAttribute(e){this.attributeUtils.updateAttribute(e)}destroyAttribute(e){this.attributeUtils.destroyAttribute(e)}updateSize(){this.colorBuffer=this.textureUtils.getColorBuffer(),this.defaultRenderPassdescriptor=null}getMaxAnisotropy(){return 16}hasFeature(e){return this.device.features.has(e)}copyTextureToTexture(e,t,r=null,n=null,i=0,s=0){let o=0,a=0,u=0,l=0,c=0,h=0,d=e.image.width,p=e.image.height,f=1;null!==r&&(!0===r.isBox3?(l=r.min.x,c=r.min.y,h=r.min.z,d=r.max.x-r.min.x,p=r.max.y-r.min.y,f=r.max.z-r.min.z):(l=r.min.x,c=r.min.y,d=r.max.x-r.min.x,p=r.max.y-r.min.y,f=1)),null!==n&&(o=n.x,a=n.y,u=n.z||0);const g=this.device.createCommandEncoder({label:"copyTextureToTexture_"+e.id+"_"+t.id}),m=this.get(e).texture,y=this.get(t).texture;g.copyTextureToTexture({texture:m,mipLevel:i,origin:{x:l,y:c,z:h}},{texture:y,mipLevel:s,origin:{x:o,y:a,z:u}},[d,p,f]),this.device.queue.submit([g.finish()]),0===s&&t.generateMipmaps&&this.textureUtils.generateMipmaps(t)}copyFramebufferToTexture(e,t,r){const n=this.get(t);let i=null;i=t.renderTarget?e.isDepthTexture?this.get(t.depthTexture).texture:this.get(t.textures[0]).texture:e.isDepthTexture?this.textureUtils.getDepthBuffer(t.depth,t.stencil):this.context.getCurrentTexture();const s=this.get(e).texture;if(i.format!==s.format)return;let o;if(n.currentPass?(n.currentPass.end(),o=n.encoder):o=this.device.createCommandEncoder({label:"copyFramebufferToTexture_"+e.id}),o.copyTextureToTexture({texture:i,origin:[r.x,r.y,0]},{texture:s},[r.z,r.w]),n.currentPass){const{descriptor:e}=n;for(let t=0;t<e.colorAttachments.length;t++)e.colorAttachments[t].loadOp=XT;if(t.depth&&(e.depthStencilAttachment.depthLoadOp=XT),t.stencil&&(e.depthStencilAttachment.stencilLoadOp=XT),n.currentPass=o.beginRenderPass(e),n.currentSets={attributes:{},bindingGroups:[],pipeline:null,index:null},t.viewport&&this.updateViewport(t),t.scissor){const{x:e,y:r,width:i,height:s}=t.scissorValue;n.currentPass.setScissorRect(e,r,i,s)}}else this.device.queue.submit([o.finish()]);e.generateMipmaps&&this.textureUtils.generateMipmaps(e)}}class SE extends G{constructor(e,t,r,n,i,s){super(e,t,r,n,i,s),this.iesMap=null}copy(e,t){return super.copy(e,t),this.iesMap=e.iesMap,this}}class NE extends G{constructor(e,t,r,n,i,s){super(e,t,r,n,i,s),this.aspect=null}copy(e,t){return super.copy(e,t),this.aspect=e.aspect,this}}class EE extends Tx{constructor(){super(),this.addMaterial(Xg,"MeshPhongMaterial"),this.addMaterial(Ly,"MeshStandardMaterial"),this.addMaterial(ky,"MeshPhysicalMaterial"),this.addMaterial(jy,"MeshToonMaterial"),this.addMaterial(Ug,"MeshBasicMaterial"),this.addMaterial(Wg,"MeshLambertMaterial"),this.addMaterial(Ng,"MeshNormalMaterial"),this.addMaterial(Hy,"MeshMatcapMaterial"),this.addMaterial(xg,"LineBasicMaterial"),this.addMaterial(wg,"LineDashedMaterial"),this.addMaterial(Qy,"PointsMaterial"),this.addMaterial(Ky,"SpriteMaterial"),this.addMaterial(eb,"ShadowMaterial"),this.addLight(cv,U),this.addLight(Xv,V),this.addLight(Zv,j),this.addLight(Jv,G),this.addLight(nx,z),this.addLight(ix,$),this.addLight(sx,H),this.addLight(ex,SE),this.addLight(rx,NE),this.addToneMapping(u_,W),this.addToneMapping(l_,q),this.addToneMapping(c_,X),this.addToneMapping(d_,K),this.addToneMapping(m_,Y),this.addToneMapping(y_,Q)}}class CE extends zx{constructor(e={}){let t;e.forceWebGL?t=FT:(t=wE,e.getFallback=()=>new FT(e));super(new t(e),e),this.library=new EE,this.isWebGPURenderer=!0,"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}}const AE={type:"change"},ME={type:"start"},RE={type:"end"},PE=1e-6,DE=-1,FE=0,OE=1,LE=2,BE=3,kE=4,IE=new i,UE=new i,VE=new o,jE=new o,GE=new o,zE=new ge,$E=new o,HE=new o,WE=new o,qE=new o;class XE extends e{constructor(e,t=null){super(e,t),this.screen={left:0,top:0,width:0,height:0},this.rotateSpeed=1,this.zoomSpeed=1.2,this.panSpeed=.3,this.noRotate=!1,this.noZoom=!1,this.noPan=!1,this.staticMoving=!1,this.dynamicDampingFactor=.2,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.keys=["KeyA","KeyS","KeyD"],this.mouseButtons={LEFT:r.ROTATE,MIDDLE:r.DOLLY,RIGHT:r.PAN},this.target=new o,this.state=DE,this.keyState=DE,this._lastPosition=new o,this._lastZoom=1,this._touchZoomDistanceStart=0,this._touchZoomDistanceEnd=0,this._lastAngle=0,this._eye=new o,this._movePrev=new i,this._moveCurr=new i,this._lastAxis=new o,this._zoomStart=new i,this._zoomEnd=new i,this._panStart=new i,this._panEnd=new i,this._pointers=[],this._pointerPositions={},this._onPointerMove=YE.bind(this),this._onPointerDown=KE.bind(this),this._onPointerUp=QE.bind(this),this._onPointerCancel=ZE.bind(this),this._onContextMenu=sC.bind(this),this._onMouseWheel=iC.bind(this),this._onKeyDown=eC.bind(this),this._onKeyUp=JE.bind(this),this._onTouchStart=oC.bind(this),this._onTouchMove=aC.bind(this),this._onTouchEnd=uC.bind(this),this._onMouseDown=tC.bind(this),this._onMouseMove=rC.bind(this),this._onMouseUp=nC.bind(this),this._target0=this.target.clone(),this._position0=this.object.position.clone(),this._up0=this.object.up.clone(),this._zoom0=this.object.zoom,null!==t&&(this.connect(t),this.handleResize()),this.update()}connect(e){super.connect(e),window.addEventListener("keydown",this._onKeyDown),window.addEventListener("keyup",this._onKeyUp),this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointercancel",this._onPointerCancel),this.domElement.addEventListener("wheel",this._onMouseWheel,{passive:!1}),this.domElement.addEventListener("contextmenu",this._onContextMenu),this.domElement.style.touchAction="none"}disconnect(){window.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("keyup",this._onKeyUp),this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.domElement.removeEventListener("pointercancel",this._onPointerCancel),this.domElement.removeEventListener("wheel",this._onMouseWheel),this.domElement.removeEventListener("contextmenu",this._onContextMenu),this.domElement.style.touchAction="auto"}dispose(){this.disconnect()}handleResize(){const e=this.domElement.getBoundingClientRect(),t=this.domElement.ownerDocument.documentElement;this.screen.left=e.left+window.pageXOffset-t.clientLeft,this.screen.top=e.top+window.pageYOffset-t.clientTop,this.screen.width=e.width,this.screen.height=e.height}update(){this._eye.subVectors(this.object.position,this.target),this.noRotate||this._rotateCamera(),this.noZoom||this._zoomCamera(),this.noPan||this._panCamera(),this.object.position.addVectors(this.target,this._eye),this.object.isPerspectiveCamera?(this._checkDistances(),this.object.lookAt(this.target),this._lastPosition.distanceToSquared(this.object.position)>PE&&(this.dispatchEvent(AE),this._lastPosition.copy(this.object.position))):this.object.isOrthographicCamera&&(this.object.lookAt(this.target),(this._lastPosition.distanceToSquared(this.object.position)>PE||this._lastZoom!==this.object.zoom)&&(this.dispatchEvent(AE),this._lastPosition.copy(this.object.position),this._lastZoom=this.object.zoom))}reset(){this.state=DE,this.keyState=DE,this.target.copy(this._target0),this.object.position.copy(this._position0),this.object.up.copy(this._up0),this.object.zoom=this._zoom0,this.object.updateProjectionMatrix(),this._eye.subVectors(this.object.position,this.target),this.object.lookAt(this.target),this.dispatchEvent(AE),this._lastPosition.copy(this.object.position),this._lastZoom=this.object.zoom}_panCamera(){if(UE.copy(this._panEnd).sub(this._panStart),UE.lengthSq()){if(this.object.isOrthographicCamera){const e=(this.object.right-this.object.left)/this.object.zoom/this.domElement.clientWidth,t=(this.object.top-this.object.bottom)/this.object.zoom/this.domElement.clientWidth;UE.x*=e,UE.y*=t}UE.multiplyScalar(this._eye.length()*this.panSpeed),jE.copy(this._eye).cross(this.object.up).setLength(UE.x),jE.add(VE.copy(this.object.up).setLength(UE.y)),this.object.position.add(jE),this.target.add(jE),this.staticMoving?this._panStart.copy(this._panEnd):this._panStart.add(UE.subVectors(this._panEnd,this._panStart).multiplyScalar(this.dynamicDampingFactor))}}_rotateCamera(){qE.set(this._moveCurr.x-this._movePrev.x,this._moveCurr.y-this._movePrev.y,0);let e=qE.length();e?(this._eye.copy(this.object.position).sub(this.target),$E.copy(this._eye).normalize(),HE.copy(this.object.up).normalize(),WE.crossVectors(HE,$E).normalize(),HE.setLength(this._moveCurr.y-this._movePrev.y),WE.setLength(this._moveCurr.x-this._movePrev.x),qE.copy(HE.add(WE)),GE.crossVectors(qE,this._eye).normalize(),e*=this.rotateSpeed,zE.setFromAxisAngle(GE,e),this._eye.applyQuaternion(zE),this.object.up.applyQuaternion(zE),this._lastAxis.copy(GE),this._lastAngle=e):!this.staticMoving&&this._lastAngle&&(this._lastAngle*=Math.sqrt(1-this.dynamicDampingFactor),this._eye.copy(this.object.position).sub(this.target),zE.setFromAxisAngle(this._lastAxis,this._lastAngle),this._eye.applyQuaternion(zE),this.object.up.applyQuaternion(zE)),this._movePrev.copy(this._moveCurr)}_zoomCamera(){let e;this.state===kE?(e=this._touchZoomDistanceStart/this._touchZoomDistanceEnd,this._touchZoomDistanceStart=this._touchZoomDistanceEnd,this.object.isPerspectiveCamera?this._eye.multiplyScalar(e):this.object.isOrthographicCamera&&(this.object.zoom=Zr.clamp(this.object.zoom/e,this.minZoom,this.maxZoom),this._lastZoom!==this.object.zoom&&this.object.updateProjectionMatrix())):(e=1+(this._zoomEnd.y-this._zoomStart.y)*this.zoomSpeed,1!==e&&e>0&&(this.object.isPerspectiveCamera?this._eye.multiplyScalar(e):this.object.isOrthographicCamera&&(this.object.zoom=Zr.clamp(this.object.zoom/e,this.minZoom,this.maxZoom),this._lastZoom!==this.object.zoom&&this.object.updateProjectionMatrix())),this.staticMoving?this._zoomStart.copy(this._zoomEnd):this._zoomStart.y+=(this._zoomEnd.y-this._zoomStart.y)*this.dynamicDampingFactor)}_getMouseOnScreen(e,t){return IE.set((e-this.screen.left)/this.screen.width,(t-this.screen.top)/this.screen.height),IE}_getMouseOnCircle(e,t){return IE.set((e-.5*this.screen.width-this.screen.left)/(.5*this.screen.width),(this.screen.height+2*(this.screen.top-t))/this.screen.width),IE}_addPointer(e){this._pointers.push(e)}_removePointer(e){delete this._pointerPositions[e.pointerId];for(let t=0;t<this._pointers.length;t++)if(this._pointers[t].pointerId==e.pointerId)return void this._pointers.splice(t,1)}_trackPointer(e){let t=this._pointerPositions[e.pointerId];void 0===t&&(t=new i,this._pointerPositions[e.pointerId]=t),t.set(e.pageX,e.pageY)}_getSecondPointerPosition(e){const t=e.pointerId===this._pointers[0].pointerId?this._pointers[1]:this._pointers[0];return this._pointerPositions[t.pointerId]}_checkDistances(){this.noZoom&&this.noPan||(this._eye.lengthSq()>this.maxDistance*this.maxDistance&&(this.object.position.addVectors(this.target,this._eye.setLength(this.maxDistance)),this._zoomStart.copy(this._zoomEnd)),this._eye.lengthSq()<this.minDistance*this.minDistance&&(this.object.position.addVectors(this.target,this._eye.setLength(this.minDistance)),this._zoomStart.copy(this._zoomEnd)))}}function KE(e){!1!==this.enabled&&(0===this._pointers.length&&(this.domElement.setPointerCapture(e.pointerId),this.domElement.addEventListener("pointermove",this._onPointerMove),this.domElement.addEventListener("pointerup",this._onPointerUp)),this._addPointer(e),"touch"===e.pointerType?this._onTouchStart(e):this._onMouseDown(e))}function YE(e){!1!==this.enabled&&("touch"===e.pointerType?this._onTouchMove(e):this._onMouseMove(e))}function QE(e){!1!==this.enabled&&("touch"===e.pointerType?this._onTouchEnd(e):this._onMouseUp(),this._removePointer(e),0===this._pointers.length&&(this.domElement.releasePointerCapture(e.pointerId),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp)))}function ZE(e){this._removePointer(e)}function JE(){!1!==this.enabled&&(this.keyState=DE,window.addEventListener("keydown",this._onKeyDown))}function eC(e){!1!==this.enabled&&(window.removeEventListener("keydown",this._onKeyDown),this.keyState===DE&&(e.code!==this.keys[FE]||this.noRotate?e.code!==this.keys[OE]||this.noZoom?e.code!==this.keys[LE]||this.noPan||(this.keyState=LE):this.keyState=OE:this.keyState=FE))}function tC(e){let t;switch(e.button){case 0:t=this.mouseButtons.LEFT;break;case 1:t=this.mouseButtons.MIDDLE;break;case 2:t=this.mouseButtons.RIGHT;break;default:t=-1}switch(t){case r.DOLLY:this.state=OE;break;case r.ROTATE:this.state=FE;break;case r.PAN:this.state=LE;break;default:this.state=DE}const n=this.keyState!==DE?this.keyState:this.state;n!==FE||this.noRotate?n!==OE||this.noZoom?n!==LE||this.noPan||(this._panStart.copy(this._getMouseOnScreen(e.pageX,e.pageY)),this._panEnd.copy(this._panStart)):(this._zoomStart.copy(this._getMouseOnScreen(e.pageX,e.pageY)),this._zoomEnd.copy(this._zoomStart)):(this._moveCurr.copy(this._getMouseOnCircle(e.pageX,e.pageY)),this._movePrev.copy(this._moveCurr)),this.dispatchEvent(ME)}function rC(e){const t=this.keyState!==DE?this.keyState:this.state;t!==FE||this.noRotate?t!==OE||this.noZoom?t!==LE||this.noPan||this._panEnd.copy(this._getMouseOnScreen(e.pageX,e.pageY)):this._zoomEnd.copy(this._getMouseOnScreen(e.pageX,e.pageY)):(this._movePrev.copy(this._moveCurr),this._moveCurr.copy(this._getMouseOnCircle(e.pageX,e.pageY)))}function nC(){this.state=DE,this.dispatchEvent(RE)}function iC(e){if(!1!==this.enabled&&!0!==this.noZoom){switch(e.preventDefault(),e.deltaMode){case 2:this._zoomStart.y-=.025*e.deltaY;break;case 1:this._zoomStart.y-=.01*e.deltaY;break;default:this._zoomStart.y-=25e-5*e.deltaY}this.dispatchEvent(ME),this.dispatchEvent(RE)}}function sC(e){!1!==this.enabled&&e.preventDefault()}function oC(e){if(this._trackPointer(e),1===this._pointers.length)this.state=BE,this._moveCurr.copy(this._getMouseOnCircle(this._pointers[0].pageX,this._pointers[0].pageY)),this._movePrev.copy(this._moveCurr);else{this.state=kE;const e=this._pointers[0].pageX-this._pointers[1].pageX,t=this._pointers[0].pageY-this._pointers[1].pageY;this._touchZoomDistanceEnd=this._touchZoomDistanceStart=Math.sqrt(e*e+t*t);const r=(this._pointers[0].pageX+this._pointers[1].pageX)/2,n=(this._pointers[0].pageY+this._pointers[1].pageY)/2;this._panStart.copy(this._getMouseOnScreen(r,n)),this._panEnd.copy(this._panStart)}this.dispatchEvent(ME)}function aC(e){if(this._trackPointer(e),1===this._pointers.length)this._movePrev.copy(this._moveCurr),this._moveCurr.copy(this._getMouseOnCircle(e.pageX,e.pageY));else{const t=this._getSecondPointerPosition(e),r=e.pageX-t.x,n=e.pageY-t.y;this._touchZoomDistanceEnd=Math.sqrt(r*r+n*n);const i=(e.pageX+t.x)/2,s=(e.pageY+t.y)/2;this._panEnd.copy(this._getMouseOnScreen(i,s))}}function uC(e){switch(this._pointers.length){case 0:this.state=DE;break;case 1:this.state=BE,this._moveCurr.copy(this._getMouseOnCircle(e.pageX,e.pageY)),this._movePrev.copy(this._moveCurr);break;case 2:this.state=kE;for(let t=0;t<this._pointers.length;t++)if(this._pointers[t].pointerId!==e.pointerId){const e=this._pointerPositions[this._pointers[t].pointerId];this._moveCurr.copy(this._getMouseOnCircle(e.x,e.y)),this._movePrev.copy(this._moveCurr);break}}this.dispatchEvent(RE)}const lC={type:"change"},cC={type:"start"},hC={type:"end"},dC=new xn,pC=new s,fC=Math.cos(70*Zr.DEG2RAD),gC=new o,mC=2*Math.PI,yC=-1,bC=0,_C=1,vC=2,xC=3,TC=4,wC=5,SC=6,NC=1e-6;class EC extends e{constructor(e,t=null){super(e,t),this.state=yC,this.target=new o,this.cursor=new o,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minTargetRadius=0,this.maxTargetRadius=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.keyRotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.zoomToCursor=!1,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:r.ROTATE,MIDDLE:r.DOLLY,RIGHT:r.PAN},this.touches={ONE:n.ROTATE,TWO:n.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this._lastPosition=new o,this._lastQuaternion=new ge,this._lastTargetPosition=new o,this._quat=(new ge).setFromUnitVectors(e.up,new o(0,1,0)),this._quatInverse=this._quat.clone().invert(),this._spherical=new vn,this._sphericalDelta=new vn,this._scale=1,this._panOffset=new o,this._rotateStart=new i,this._rotateEnd=new i,this._rotateDelta=new i,this._panStart=new i,this._panEnd=new i,this._panDelta=new i,this._dollyStart=new i,this._dollyEnd=new i,this._dollyDelta=new i,this._dollyDirection=new o,this._mouse=new i,this._performCursorZoom=!1,this._pointers=[],this._pointerPositions={},this._controlActive=!1,this._onPointerMove=AC.bind(this),this._onPointerDown=CC.bind(this),this._onPointerUp=MC.bind(this),this._onContextMenu=BC.bind(this),this._onMouseWheel=DC.bind(this),this._onKeyDown=FC.bind(this),this._onTouchStart=OC.bind(this),this._onTouchMove=LC.bind(this),this._onMouseDown=RC.bind(this),this._onMouseMove=PC.bind(this),this._interceptControlDown=kC.bind(this),this._interceptControlUp=IC.bind(this),null!==this.domElement&&this.connect(this.domElement),this.update()}connect(e){super.connect(e),this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointercancel",this._onPointerUp),this.domElement.addEventListener("contextmenu",this._onContextMenu),this.domElement.addEventListener("wheel",this._onMouseWheel,{passive:!1});this.domElement.getRootNode().addEventListener("keydown",this._interceptControlDown,{passive:!0,capture:!0}),this.domElement.style.touchAction="none"}disconnect(){this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.domElement.removeEventListener("pointercancel",this._onPointerUp),this.domElement.removeEventListener("wheel",this._onMouseWheel),this.domElement.removeEventListener("contextmenu",this._onContextMenu),this.stopListenToKeyEvents();this.domElement.getRootNode().removeEventListener("keydown",this._interceptControlDown,{capture:!0}),this.domElement.style.touchAction="auto"}dispose(){this.disconnect()}getPolarAngle(){return this._spherical.phi}getAzimuthalAngle(){return this._spherical.theta}getDistance(){return this.object.position.distanceTo(this.target)}listenToKeyEvents(e){e.addEventListener("keydown",this._onKeyDown),this._domElementKeyEvents=e}stopListenToKeyEvents(){null!==this._domElementKeyEvents&&(this._domElementKeyEvents.removeEventListener("keydown",this._onKeyDown),this._domElementKeyEvents=null)}saveState(){this.target0.copy(this.target),this.position0.copy(this.object.position),this.zoom0=this.object.zoom}reset(){this.target.copy(this.target0),this.object.position.copy(this.position0),this.object.zoom=this.zoom0,this.object.updateProjectionMatrix(),this.dispatchEvent(lC),this.update(),this.state=yC}update(e=null){const t=this.object.position;gC.copy(t).sub(this.target),gC.applyQuaternion(this._quat),this._spherical.setFromVector3(gC),this.autoRotate&&this.state===yC&&this._rotateLeft(this._getAutoRotationAngle(e)),this.enableDamping?(this._spherical.theta+=this._sphericalDelta.theta*this.dampingFactor,this._spherical.phi+=this._sphericalDelta.phi*this.dampingFactor):(this._spherical.theta+=this._sphericalDelta.theta,this._spherical.phi+=this._sphericalDelta.phi);let r=this.minAzimuthAngle,n=this.maxAzimuthAngle;isFinite(r)&&isFinite(n)&&(r<-Math.PI?r+=mC:r>Math.PI&&(r-=mC),n<-Math.PI?n+=mC:n>Math.PI&&(n-=mC),this._spherical.theta=r<=n?Math.max(r,Math.min(n,this._spherical.theta)):this._spherical.theta>(r+n)/2?Math.max(r,this._spherical.theta):Math.min(n,this._spherical.theta)),this._spherical.phi=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,this._spherical.phi)),this._spherical.makeSafe(),!0===this.enableDamping?this.target.addScaledVector(this._panOffset,this.dampingFactor):this.target.add(this._panOffset),this.target.sub(this.cursor),this.target.clampLength(this.minTargetRadius,this.maxTargetRadius),this.target.add(this.cursor);let i=!1;if(this.zoomToCursor&&this._performCursorZoom||this.object.isOrthographicCamera)this._spherical.radius=this._clampDistance(this._spherical.radius);else{const e=this._spherical.radius;this._spherical.radius=this._clampDistance(this._spherical.radius*this._scale),i=e!=this._spherical.radius}if(gC.setFromSpherical(this._spherical),gC.applyQuaternion(this._quatInverse),t.copy(this.target).add(gC),this.object.lookAt(this.target),!0===this.enableDamping?(this._sphericalDelta.theta*=1-this.dampingFactor,this._sphericalDelta.phi*=1-this.dampingFactor,this._panOffset.multiplyScalar(1-this.dampingFactor)):(this._sphericalDelta.set(0,0,0),this._panOffset.set(0,0,0)),this.zoomToCursor&&this._performCursorZoom){let e=null;if(this.object.isPerspectiveCamera){const t=gC.length();e=this._clampDistance(t*this._scale);const r=t-e;this.object.position.addScaledVector(this._dollyDirection,r),this.object.updateMatrixWorld(),i=!!r}else if(this.object.isOrthographicCamera){const t=new o(this._mouse.x,this._mouse.y,0);t.unproject(this.object);const r=this.object.zoom;this.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom/this._scale)),this.object.updateProjectionMatrix(),i=r!==this.object.zoom;const n=new o(this._mouse.x,this._mouse.y,0);n.unproject(this.object),this.object.position.sub(n).add(t),this.object.updateMatrixWorld(),e=gC.length()}else this.zoomToCursor=!1;null!==e&&(this.screenSpacePanning?this.target.set(0,0,-1).transformDirection(this.object.matrix).multiplyScalar(e).add(this.object.position):(dC.origin.copy(this.object.position),dC.direction.set(0,0,-1).transformDirection(this.object.matrix),Math.abs(this.object.up.dot(dC.direction))<fC?this.object.lookAt(this.target):(pC.setFromNormalAndCoplanarPoint(this.object.up,this.target),dC.intersectPlane(pC,this.target))))}else if(this.object.isOrthographicCamera){const e=this.object.zoom;this.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom/this._scale)),e!==this.object.zoom&&(this.object.updateProjectionMatrix(),i=!0)}return this._scale=1,this._performCursorZoom=!1,!!(i||this._lastPosition.distanceToSquared(this.object.position)>NC||8*(1-this._lastQuaternion.dot(this.object.quaternion))>NC||this._lastTargetPosition.distanceToSquared(this.target)>NC)&&(this.dispatchEvent(lC),this._lastPosition.copy(this.object.position),this._lastQuaternion.copy(this.object.quaternion),this._lastTargetPosition.copy(this.target),!0)}_getAutoRotationAngle(e){return null!==e?mC/60*this.autoRotateSpeed*e:mC/60/60*this.autoRotateSpeed}_getZoomScale(e){const t=Math.abs(.01*e);return Math.pow(.95,this.zoomSpeed*t)}_rotateLeft(e){this._sphericalDelta.theta-=e}_rotateUp(e){this._sphericalDelta.phi-=e}_panLeft(e,t){gC.setFromMatrixColumn(t,0),gC.multiplyScalar(-e),this._panOffset.add(gC)}_panUp(e,t){!0===this.screenSpacePanning?gC.setFromMatrixColumn(t,1):(gC.setFromMatrixColumn(t,0),gC.crossVectors(this.object.up,gC)),gC.multiplyScalar(e),this._panOffset.add(gC)}_pan(e,t){const r=this.domElement;if(this.object.isPerspectiveCamera){const n=this.object.position;gC.copy(n).sub(this.target);let i=gC.length();i*=Math.tan(this.object.fov/2*Math.PI/180),this._panLeft(2*e*i/r.clientHeight,this.object.matrix),this._panUp(2*t*i/r.clientHeight,this.object.matrix)}else this.object.isOrthographicCamera?(this._panLeft(e*(this.object.right-this.object.left)/this.object.zoom/r.clientWidth,this.object.matrix),this._panUp(t*(this.object.top-this.object.bottom)/this.object.zoom/r.clientHeight,this.object.matrix)):this.enablePan=!1}_dollyOut(e){this.object.isPerspectiveCamera||this.object.isOrthographicCamera?this._scale/=e:this.enableZoom=!1}_dollyIn(e){this.object.isPerspectiveCamera||this.object.isOrthographicCamera?this._scale*=e:this.enableZoom=!1}_updateZoomParameters(e,t){if(!this.zoomToCursor)return;this._performCursorZoom=!0;const r=this.domElement.getBoundingClientRect(),n=e-r.left,i=t-r.top,s=r.width,o=r.height;this._mouse.x=n/s*2-1,this._mouse.y=-i/o*2+1,this._dollyDirection.set(this._mouse.x,this._mouse.y,1).unproject(this.object).sub(this.object.position).normalize()}_clampDistance(e){return Math.max(this.minDistance,Math.min(this.maxDistance,e))}_handleMouseDownRotate(e){this._rotateStart.set(e.clientX,e.clientY)}_handleMouseDownDolly(e){this._updateZoomParameters(e.clientX,e.clientX),this._dollyStart.set(e.clientX,e.clientY)}_handleMouseDownPan(e){this._panStart.set(e.clientX,e.clientY)}_handleMouseMoveRotate(e){this._rotateEnd.set(e.clientX,e.clientY),this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart).multiplyScalar(this.rotateSpeed);const t=this.domElement;this._rotateLeft(mC*this._rotateDelta.x/t.clientHeight),this._rotateUp(mC*this._rotateDelta.y/t.clientHeight),this._rotateStart.copy(this._rotateEnd),this.update()}_handleMouseMoveDolly(e){this._dollyEnd.set(e.clientX,e.clientY),this._dollyDelta.subVectors(this._dollyEnd,this._dollyStart),this._dollyDelta.y>0?this._dollyOut(this._getZoomScale(this._dollyDelta.y)):this._dollyDelta.y<0&&this._dollyIn(this._getZoomScale(this._dollyDelta.y)),this._dollyStart.copy(this._dollyEnd),this.update()}_handleMouseMovePan(e){this._panEnd.set(e.clientX,e.clientY),this._panDelta.subVectors(this._panEnd,this._panStart).multiplyScalar(this.panSpeed),this._pan(this._panDelta.x,this._panDelta.y),this._panStart.copy(this._panEnd),this.update()}_handleMouseWheel(e){this._updateZoomParameters(e.clientX,e.clientY),e.deltaY<0?this._dollyIn(this._getZoomScale(e.deltaY)):e.deltaY>0&&this._dollyOut(this._getZoomScale(e.deltaY)),this.update()}_handleKeyDown(e){let t=!1;switch(e.code){case this.keys.UP:e.ctrlKey||e.metaKey||e.shiftKey?this.enableRotate&&this._rotateUp(mC*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(0,this.keyPanSpeed),t=!0;break;case this.keys.BOTTOM:e.ctrlKey||e.metaKey||e.shiftKey?this.enableRotate&&this._rotateUp(-mC*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(0,-this.keyPanSpeed),t=!0;break;case this.keys.LEFT:e.ctrlKey||e.metaKey||e.shiftKey?this.enableRotate&&this._rotateLeft(mC*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(this.keyPanSpeed,0),t=!0;break;case this.keys.RIGHT:e.ctrlKey||e.metaKey||e.shiftKey?this.enableRotate&&this._rotateLeft(-mC*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(-this.keyPanSpeed,0),t=!0}t&&(e.preventDefault(),this.update())}_handleTouchStartRotate(e){if(1===this._pointers.length)this._rotateStart.set(e.pageX,e.pageY);else{const t=this._getSecondPointerPosition(e),r=.5*(e.pageX+t.x),n=.5*(e.pageY+t.y);this._rotateStart.set(r,n)}}_handleTouchStartPan(e){if(1===this._pointers.length)this._panStart.set(e.pageX,e.pageY);else{const t=this._getSecondPointerPosition(e),r=.5*(e.pageX+t.x),n=.5*(e.pageY+t.y);this._panStart.set(r,n)}}_handleTouchStartDolly(e){const t=this._getSecondPointerPosition(e),r=e.pageX-t.x,n=e.pageY-t.y,i=Math.sqrt(r*r+n*n);this._dollyStart.set(0,i)}_handleTouchStartDollyPan(e){this.enableZoom&&this._handleTouchStartDolly(e),this.enablePan&&this._handleTouchStartPan(e)}_handleTouchStartDollyRotate(e){this.enableZoom&&this._handleTouchStartDolly(e),this.enableRotate&&this._handleTouchStartRotate(e)}_handleTouchMoveRotate(e){if(1==this._pointers.length)this._rotateEnd.set(e.pageX,e.pageY);else{const t=this._getSecondPointerPosition(e),r=.5*(e.pageX+t.x),n=.5*(e.pageY+t.y);this._rotateEnd.set(r,n)}this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart).multiplyScalar(this.rotateSpeed);const t=this.domElement;this._rotateLeft(mC*this._rotateDelta.x/t.clientHeight),this._rotateUp(mC*this._rotateDelta.y/t.clientHeight),this._rotateStart.copy(this._rotateEnd)}_handleTouchMovePan(e){if(1===this._pointers.length)this._panEnd.set(e.pageX,e.pageY);else{const t=this._getSecondPointerPosition(e),r=.5*(e.pageX+t.x),n=.5*(e.pageY+t.y);this._panEnd.set(r,n)}this._panDelta.subVectors(this._panEnd,this._panStart).multiplyScalar(this.panSpeed),this._pan(this._panDelta.x,this._panDelta.y),this._panStart.copy(this._panEnd)}_handleTouchMoveDolly(e){const t=this._getSecondPointerPosition(e),r=e.pageX-t.x,n=e.pageY-t.y,i=Math.sqrt(r*r+n*n);this._dollyEnd.set(0,i),this._dollyDelta.set(0,Math.pow(this._dollyEnd.y/this._dollyStart.y,this.zoomSpeed)),this._dollyOut(this._dollyDelta.y),this._dollyStart.copy(this._dollyEnd);const s=.5*(e.pageX+t.x),o=.5*(e.pageY+t.y);this._updateZoomParameters(s,o)}_handleTouchMoveDollyPan(e){this.enableZoom&&this._handleTouchMoveDolly(e),this.enablePan&&this._handleTouchMovePan(e)}_handleTouchMoveDollyRotate(e){this.enableZoom&&this._handleTouchMoveDolly(e),this.enableRotate&&this._handleTouchMoveRotate(e)}_addPointer(e){this._pointers.push(e.pointerId)}_removePointer(e){delete this._pointerPositions[e.pointerId];for(let t=0;t<this._pointers.length;t++)if(this._pointers[t]==e.pointerId)return void this._pointers.splice(t,1)}_isTrackingPointer(e){for(let t=0;t<this._pointers.length;t++)if(this._pointers[t]==e.pointerId)return!0;return!1}_trackPointer(e){let t=this._pointerPositions[e.pointerId];void 0===t&&(t=new i,this._pointerPositions[e.pointerId]=t),t.set(e.pageX,e.pageY)}_getSecondPointerPosition(e){const t=e.pointerId===this._pointers[0]?this._pointers[1]:this._pointers[0];return this._pointerPositions[t]}_customWheelEvent(e){const t=e.deltaMode,r={clientX:e.clientX,clientY:e.clientY,deltaY:e.deltaY};switch(t){case 1:r.deltaY*=16;break;case 2:r.deltaY*=100}return e.ctrlKey&&!this._controlActive&&(r.deltaY*=10),r}}function CC(e){!1!==this.enabled&&(0===this._pointers.length&&(this.domElement.setPointerCapture(e.pointerId),this.domElement.addEventListener("pointermove",this._onPointerMove),this.domElement.addEventListener("pointerup",this._onPointerUp)),this._isTrackingPointer(e)||(this._addPointer(e),"touch"===e.pointerType?this._onTouchStart(e):this._onMouseDown(e)))}function AC(e){!1!==this.enabled&&("touch"===e.pointerType?this._onTouchMove(e):this._onMouseMove(e))}function MC(e){switch(this._removePointer(e),this._pointers.length){case 0:this.domElement.releasePointerCapture(e.pointerId),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.dispatchEvent(hC),this.state=yC;break;case 1:const t=this._pointers[0],r=this._pointerPositions[t];this._onTouchStart({pointerId:t,pageX:r.x,pageY:r.y})}}function RC(e){let t;switch(e.button){case 0:t=this.mouseButtons.LEFT;break;case 1:t=this.mouseButtons.MIDDLE;break;case 2:t=this.mouseButtons.RIGHT;break;default:t=-1}switch(t){case r.DOLLY:if(!1===this.enableZoom)return;this._handleMouseDownDolly(e),this.state=_C;break;case r.ROTATE:if(e.ctrlKey||e.metaKey||e.shiftKey){if(!1===this.enablePan)return;this._handleMouseDownPan(e),this.state=vC}else{if(!1===this.enableRotate)return;this._handleMouseDownRotate(e),this.state=bC}break;case r.PAN:if(e.ctrlKey||e.metaKey||e.shiftKey){if(!1===this.enableRotate)return;this._handleMouseDownRotate(e),this.state=bC}else{if(!1===this.enablePan)return;this._handleMouseDownPan(e),this.state=vC}break;default:this.state=yC}this.state!==yC&&this.dispatchEvent(cC)}function PC(e){switch(this.state){case bC:if(!1===this.enableRotate)return;this._handleMouseMoveRotate(e);break;case _C:if(!1===this.enableZoom)return;this._handleMouseMoveDolly(e);break;case vC:if(!1===this.enablePan)return;this._handleMouseMovePan(e)}}function DC(e){!1!==this.enabled&&!1!==this.enableZoom&&this.state===yC&&(e.preventDefault(),this.dispatchEvent(cC),this._handleMouseWheel(this._customWheelEvent(e)),this.dispatchEvent(hC))}function FC(e){!1!==this.enabled&&this._handleKeyDown(e)}function OC(e){switch(this._trackPointer(e),this._pointers.length){case 1:switch(this.touches.ONE){case n.ROTATE:if(!1===this.enableRotate)return;this._handleTouchStartRotate(e),this.state=xC;break;case n.PAN:if(!1===this.enablePan)return;this._handleTouchStartPan(e),this.state=TC;break;default:this.state=yC}break;case 2:switch(this.touches.TWO){case n.DOLLY_PAN:if(!1===this.enableZoom&&!1===this.enablePan)return;this._handleTouchStartDollyPan(e),this.state=wC;break;case n.DOLLY_ROTATE:if(!1===this.enableZoom&&!1===this.enableRotate)return;this._handleTouchStartDollyRotate(e),this.state=SC;break;default:this.state=yC}break;default:this.state=yC}this.state!==yC&&this.dispatchEvent(cC)}function LC(e){switch(this._trackPointer(e),this.state){case xC:if(!1===this.enableRotate)return;this._handleTouchMoveRotate(e),this.update();break;case TC:if(!1===this.enablePan)return;this._handleTouchMovePan(e),this.update();break;case wC:if(!1===this.enableZoom&&!1===this.enablePan)return;this._handleTouchMoveDollyPan(e),this.update();break;case SC:if(!1===this.enableZoom&&!1===this.enableRotate)return;this._handleTouchMoveDollyRotate(e),this.update();break;default:this.state=yC}}function BC(e){!1!==this.enabled&&e.preventDefault()}function kC(e){if("Control"===e.key){this._controlActive=!0;this.domElement.getRootNode().addEventListener("keyup",this._interceptControlUp,{passive:!0,capture:!0})}}function IC(e){if("Control"===e.key){this._controlActive=!1;this.domElement.getRootNode().removeEventListener("keyup",this._interceptControlUp,{passive:!0,capture:!0})}}const UC={type:"change"},VC=1e-6,jC=new ge;class GC extends e{constructor(e,t=null){super(e,t),this.movementSpeed=1,this.rollSpeed=.005,this.dragToLook=!1,this.autoForward=!1,this._moveState={up:0,down:0,left:0,right:0,forward:0,back:0,pitchUp:0,pitchDown:0,yawLeft:0,yawRight:0,rollLeft:0,rollRight:0},this._moveVector=new o(0,0,0),this._rotationVector=new o(0,0,0),this._lastQuaternion=new ge,this._lastPosition=new o,this._status=0,this._onKeyDown=zC.bind(this),this._onKeyUp=$C.bind(this),this._onPointerMove=WC.bind(this),this._onPointerDown=HC.bind(this),this._onPointerUp=qC.bind(this),this._onPointerCancel=XC.bind(this),this._onContextMenu=KC.bind(this),null!==t&&this.connect(t)}connect(e){super.connect(e),window.addEventListener("keydown",this._onKeyDown),window.addEventListener("keyup",this._onKeyUp),this.domElement.addEventListener("pointermove",this._onPointerMove),this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointerup",this._onPointerUp),this.domElement.addEventListener("pointercancel",this._onPointerCancel),this.domElement.addEventListener("contextmenu",this._onContextMenu)}disconnect(){window.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("keyup",this._onKeyUp),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.domElement.removeEventListener("pointercancel",this._onPointerCancel),this.domElement.removeEventListener("contextmenu",this._onContextMenu)}dispose(){this.disconnect()}update(e){if(!1===this.enabled)return;const t=this.object,r=e*this.movementSpeed,n=e*this.rollSpeed;t.translateX(this._moveVector.x*r),t.translateY(this._moveVector.y*r),t.translateZ(this._moveVector.z*r),jC.set(this._rotationVector.x*n,this._rotationVector.y*n,this._rotationVector.z*n,1).normalize(),t.quaternion.multiply(jC),(this._lastPosition.distanceToSquared(t.position)>VC||8*(1-this._lastQuaternion.dot(t.quaternion))>VC)&&(this.dispatchEvent(UC),this._lastQuaternion.copy(t.quaternion),this._lastPosition.copy(t.position))}_updateMovementVector(){const e=this._moveState.forward||this.autoForward&&!this._moveState.back?1:0;this._moveVector.x=-this._moveState.left+this._moveState.right,this._moveVector.y=-this._moveState.down+this._moveState.up,this._moveVector.z=-e+this._moveState.back}_updateRotationVector(){this._rotationVector.x=-this._moveState.pitchDown+this._moveState.pitchUp,this._rotationVector.y=-this._moveState.yawRight+this._moveState.yawLeft,this._rotationVector.z=-this._moveState.rollRight+this._moveState.rollLeft}_getContainerDimensions(){return this.domElement!=document?{size:[this.domElement.offsetWidth,this.domElement.offsetHeight],offset:[this.domElement.offsetLeft,this.domElement.offsetTop]}:{size:[window.innerWidth,window.innerHeight],offset:[0,0]}}}function zC(e){if(!e.altKey&&!1!==this.enabled){switch(e.code){case"ShiftLeft":case"ShiftRight":this.movementSpeedMultiplier=.1;break;case"KeyW":this._moveState.forward=1;break;case"KeyS":this._moveState.back=1;break;case"KeyA":this._moveState.left=1;break;case"KeyD":this._moveState.right=1;break;case"KeyR":this._moveState.up=1;break;case"KeyF":this._moveState.down=1;break;case"ArrowUp":this._moveState.pitchUp=1;break;case"ArrowDown":this._moveState.pitchDown=1;break;case"ArrowLeft":this._moveState.yawLeft=1;break;case"ArrowRight":this._moveState.yawRight=1;break;case"KeyQ":this._moveState.rollLeft=1;break;case"KeyE":this._moveState.rollRight=1}this._updateMovementVector(),this._updateRotationVector()}}function $C(e){if(!1!==this.enabled){switch(e.code){case"ShiftLeft":case"ShiftRight":this.movementSpeedMultiplier=1;break;case"KeyW":this._moveState.forward=0;break;case"KeyS":this._moveState.back=0;break;case"KeyA":this._moveState.left=0;break;case"KeyD":this._moveState.right=0;break;case"KeyR":this._moveState.up=0;break;case"KeyF":this._moveState.down=0;break;case"ArrowUp":this._moveState.pitchUp=0;break;case"ArrowDown":this._moveState.pitchDown=0;break;case"ArrowLeft":this._moveState.yawLeft=0;break;case"ArrowRight":this._moveState.yawRight=0;break;case"KeyQ":this._moveState.rollLeft=0;break;case"KeyE":this._moveState.rollRight=0}this._updateMovementVector(),this._updateRotationVector()}}function HC(e){if(!1!==this.enabled)if(this.dragToLook)this._status++;else{switch(e.button){case 0:this._moveState.forward=1;break;case 2:this._moveState.back=1}this._updateMovementVector()}}function WC(e){if(!1!==this.enabled&&(!this.dragToLook||this._status>0)){const t=this._getContainerDimensions(),r=t.size[0]/2,n=t.size[1]/2;this._moveState.yawLeft=-(e.pageX-t.offset[0]-r)/r,this._moveState.pitchDown=(e.pageY-t.offset[1]-n)/n,this._updateRotationVector()}}function qC(e){if(!1!==this.enabled){if(this.dragToLook)this._status--,this._moveState.yawLeft=this._moveState.pitchDown=0;else{switch(e.button){case 0:this._moveState.forward=0;break;case 2:this._moveState.back=0}this._updateMovementVector()}this._updateRotationVector()}}function XC(){!1!==this.enabled&&(this.dragToLook?(this._status=0,this._moveState.yawLeft=this._moveState.pitchDown=0):(this._moveState.forward=0,this._moveState.back=0,this._updateMovementVector()),this._updateRotationVector())}function KC(e){!1!==this.enabled&&e.preventDefault()}const YC={name:"CopyShader",uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\n\t\tuniform float opacity;\n\n\t\tuniform sampler2D tDiffuse;\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvec4 texel = texture2D( tDiffuse, vUv );\n\t\t\tgl_FragColor = opacity * texel;\n\n\n\t\t}"};class QC{constructor(){this.isPass=!0,this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.renderToScreen=!1}setSize(){}render(){}dispose(){}}const ZC=new Z(-1,1,1,-1,0,1);const JC=new class extends p{constructor(){super(),this.setAttribute("position",new Sr([-1,3,0,-1,-1,0,3,-1,0],3)),this.setAttribute("uv",new Sr([0,2,0,0,2,0],2))}};class eA{constructor(e){this._mesh=new l(JC,e)}dispose(){this._mesh.geometry.dispose()}render(e){e.render(this._mesh,ZC)}get material(){return this._mesh.material}set material(e){this._mesh.material=e}}class tA extends QC{constructor(e,t="tDiffuse"){super(),this.textureID=t,this.uniforms=null,this.material=null,e instanceof Tn?(this.uniforms=e.uniforms,this.material=e):e&&(this.uniforms=wn.clone(e.uniforms),this.material=new Tn({name:void 0!==e.name?e.name:"unspecified",defines:Object.assign({},e.defines),uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader})),this._fsQuad=new eA(this.material)}render(e,t,r){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=r.texture),this._fsQuad.material=this.material,this.renderToScreen?(e.setRenderTarget(null),this._fsQuad.render(e)):(e.setRenderTarget(t),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),this._fsQuad.render(e))}dispose(){this.material.dispose(),this._fsQuad.dispose()}}class rA extends QC{constructor(e,t){super(),this.scene=e,this.camera=t,this.clear=!0,this.needsSwap=!1,this.inverse=!1}render(e,t,r){const n=e.getContext(),i=e.state;let s,o;i.buffers.color.setMask(!1),i.buffers.depth.setMask(!1),i.buffers.color.setLocked(!0),i.buffers.depth.setLocked(!0),this.inverse?(s=0,o=1):(s=1,o=0),i.buffers.stencil.setTest(!0),i.buffers.stencil.setOp(n.REPLACE,n.REPLACE,n.REPLACE),i.buffers.stencil.setFunc(n.ALWAYS,s,4294967295),i.buffers.stencil.setClear(o),i.buffers.stencil.setLocked(!0),e.setRenderTarget(r),this.clear&&e.clear(),e.render(this.scene,this.camera),e.setRenderTarget(t),this.clear&&e.clear(),e.render(this.scene,this.camera),i.buffers.color.setLocked(!1),i.buffers.depth.setLocked(!1),i.buffers.color.setMask(!0),i.buffers.depth.setMask(!0),i.buffers.stencil.setLocked(!1),i.buffers.stencil.setFunc(n.EQUAL,1,4294967295),i.buffers.stencil.setOp(n.KEEP,n.KEEP,n.KEEP),i.buffers.stencil.setLocked(!0)}}class nA extends QC{constructor(){super(),this.needsSwap=!1}render(e){e.state.buffers.stencil.setLocked(!1),e.state.buffers.stencil.setTest(!1)}}class iA{constructor(e,t){if(this.renderer=e,this._pixelRatio=e.getPixelRatio(),void 0===t){const r=e.getSize(new i);this._width=r.width,this._height=r.height,(t=new Sn(this._width*this._pixelRatio,this._height*this._pixelRatio,{type:w})).texture.name="EffectComposer.rt1"}else this._width=t.width,this._height=t.height;this.renderTarget1=t,this.renderTarget2=t.clone(),this.renderTarget2.texture.name="EffectComposer.rt2",this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.renderToScreen=!0,this.passes=[],this.copyPass=new tA(YC),this.copyPass.material.blending=dt,this.clock=new Nn}swapBuffers(){const e=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=e}addPass(e){this.passes.push(e),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}insertPass(e,t){this.passes.splice(t,0,e),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}removePass(e){const t=this.passes.indexOf(e);-1!==t&&this.passes.splice(t,1)}isLastEnabledPass(e){for(let t=e+1;t<this.passes.length;t++)if(this.passes[t].enabled)return!1;return!0}render(e){void 0===e&&(e=this.clock.getDelta());const t=this.renderer.getRenderTarget();let r=!1;for(let n=0,i=this.passes.length;n<i;n++){const t=this.passes[n];if(!1!==t.enabled){if(t.renderToScreen=this.renderToScreen&&this.isLastEnabledPass(n),t.render(this.renderer,this.writeBuffer,this.readBuffer,e,r),t.needsSwap){if(r){const t=this.renderer.getContext(),r=this.renderer.state.buffers.stencil;r.setFunc(t.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,e),r.setFunc(t.EQUAL,1,4294967295)}this.swapBuffers()}void 0!==rA&&(t instanceof rA?r=!0:t instanceof nA&&(r=!1))}}this.renderer.setRenderTarget(t)}reset(e){if(void 0===e){const t=this.renderer.getSize(new i);this._pixelRatio=this.renderer.getPixelRatio(),this._width=t.width,this._height=t.height,(e=this.renderTarget1.clone()).setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.renderTarget1=e,this.renderTarget2=e.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2}setSize(e,t){this._width=e,this._height=t;const r=this._width*this._pixelRatio,n=this._height*this._pixelRatio;this.renderTarget1.setSize(r,n),this.renderTarget2.setSize(r,n);for(let i=0;i<this.passes.length;i++)this.passes[i].setSize(r,n)}setPixelRatio(e){this._pixelRatio=e,this.setSize(this._width,this._height)}dispose(){this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.copyPass.dispose()}}class sA extends QC{constructor(e,t,r=null,n=null,i=null){super(),this.scene=e,this.camera=t,this.overrideMaterial=r,this.clearColor=n,this.clearAlpha=i,this.clear=!0,this.clearDepth=!1,this.needsSwap=!1,this._oldClearColor=new h}render(e,t,r){const n=e.autoClear;let i,s;e.autoClear=!1,null!==this.overrideMaterial&&(s=this.scene.overrideMaterial,this.scene.overrideMaterial=this.overrideMaterial),null!==this.clearColor&&(e.getClearColor(this._oldClearColor),e.setClearColor(this.clearColor,e.getClearAlpha())),null!==this.clearAlpha&&(i=e.getClearAlpha(),e.setClearAlpha(this.clearAlpha)),1==this.clearDepth&&e.clearDepth(),e.setRenderTarget(this.renderToScreen?null:r),!0===this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),e.render(this.scene,this.camera),null!==this.clearColor&&e.setClearColor(this._oldClearColor),null!==this.clearAlpha&&e.setClearAlpha(i),null!==this.overrideMaterial&&(this.scene.overrideMaterial=s),e.autoClear=n}}function oA(e){return oA=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},oA(e)}function aA(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(aA=function(){return!!e})()}function uA(e){var t="function"==typeof Map?new Map:void 0;return uA=function(e){if(null===e||!function(e){try{return-1!==Function.toString.call(e).indexOf("[native code]")}catch(tR){return"function"==typeof e}}(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,r)}function r(){return function(e,t,r){if(aA())return Reflect.construct.apply(null,arguments);var n=[null];n.push.apply(n,t);var i=new(e.bind.apply(e,n));return r&&Gn(i,r.prototype),i}(e,arguments,oA(this).constructor)}return r.prototype=Object.create(e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),Gn(r,e)},uA(e)}var lA=function(e){function t(t){var r;return r=e.call(this,"An error occurred. See https://github.com/styled-components/polished/blob/main/src/internalHelpers/errors.md#"+t+" for more information.")||this,$n(r)}return zn(t,e),t}(uA(Error));function cA(e){return Math.round(255*e)}function hA(e,t,r){return cA(e)+","+cA(t)+","+cA(r)}function dA(e,t,r,n){if(void 0===n&&(n=hA),0===t)return n(r,r,r);var i=(e%360+360)%360/60,s=(1-Math.abs(2*r-1))*t,o=s*(1-Math.abs(i%2-1)),a=0,u=0,l=0;i>=0&&i<1?(a=s,u=o):i>=1&&i<2?(a=o,u=s):i>=2&&i<3?(u=s,l=o):i>=3&&i<4?(u=o,l=s):i>=4&&i<5?(a=o,l=s):i>=5&&i<6&&(a=s,l=o);var c=r-s/2;return n(a+c,u+c,l+c)}var pA={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkgrey:"a9a9a9",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkslategrey:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dimgrey:"696969",dodgerblue:"1e90ff",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",grey:"808080",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgray:"d3d3d3",lightgreen:"90ee90",lightgrey:"d3d3d3",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslategray:"789",lightslategrey:"789",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"0f0",limegreen:"32cd32",linen:"faf0e6",magenta:"f0f",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370db",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"db7093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",rebeccapurple:"639",red:"f00",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",slategrey:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",wheat:"f5deb3",white:"fff",whitesmoke:"f5f5f5",yellow:"ff0",yellowgreen:"9acd32"};var fA=/^#[a-fA-F0-9]{6}$/,gA=/^#[a-fA-F0-9]{8}$/,mA=/^#[a-fA-F0-9]{3}$/,yA=/^#[a-fA-F0-9]{4}$/,bA=/^rgb\(\s*(\d{1,3})\s*(?:,)?\s*(\d{1,3})\s*(?:,)?\s*(\d{1,3})\s*\)$/i,_A=/^rgb(?:a)?\(\s*(\d{1,3})\s*(?:,)?\s*(\d{1,3})\s*(?:,)?\s*(\d{1,3})\s*(?:,|\/)\s*([-+]?\d*[.]?\d+[%]?)\s*\)$/i,vA=/^hsl\(\s*(\d{0,3}[.]?[0-9]+(?:deg)?)\s*(?:,)?\s*(\d{1,3}[.]?[0-9]?)%\s*(?:,)?\s*(\d{1,3}[.]?[0-9]?)%\s*\)$/i,xA=/^hsl(?:a)?\(\s*(\d{0,3}[.]?[0-9]+(?:deg)?)\s*(?:,)?\s*(\d{1,3}[.]?[0-9]?)%\s*(?:,)?\s*(\d{1,3}[.]?[0-9]?)%\s*(?:,|\/)\s*([-+]?\d*[.]?\d+[%]?)\s*\)$/i;function TA(e){if("string"!=typeof e)throw new lA(3);var t=function(e){if("string"!=typeof e)return e;var t=e.toLowerCase();return pA[t]?"#"+pA[t]:e}(e);if(t.match(fA))return{red:parseInt(""+t[1]+t[2],16),green:parseInt(""+t[3]+t[4],16),blue:parseInt(""+t[5]+t[6],16)};if(t.match(gA)){var r=parseFloat((parseInt(""+t[7]+t[8],16)/255).toFixed(2));return{red:parseInt(""+t[1]+t[2],16),green:parseInt(""+t[3]+t[4],16),blue:parseInt(""+t[5]+t[6],16),alpha:r}}if(t.match(mA))return{red:parseInt(""+t[1]+t[1],16),green:parseInt(""+t[2]+t[2],16),blue:parseInt(""+t[3]+t[3],16)};if(t.match(yA)){var n=parseFloat((parseInt(""+t[4]+t[4],16)/255).toFixed(2));return{red:parseInt(""+t[1]+t[1],16),green:parseInt(""+t[2]+t[2],16),blue:parseInt(""+t[3]+t[3],16),alpha:n}}var i=bA.exec(t);if(i)return{red:parseInt(""+i[1],10),green:parseInt(""+i[2],10),blue:parseInt(""+i[3],10)};var s=_A.exec(t.substring(0,50));if(s)return{red:parseInt(""+s[1],10),green:parseInt(""+s[2],10),blue:parseInt(""+s[3],10),alpha:parseFloat(""+s[4])>1?parseFloat(""+s[4])/100:parseFloat(""+s[4])};var o=vA.exec(t);if(o){var a="rgb("+dA(parseInt(""+o[1],10),parseInt(""+o[2],10)/100,parseInt(""+o[3],10)/100)+")",u=bA.exec(a);if(!u)throw new lA(4,t,a);return{red:parseInt(""+u[1],10),green:parseInt(""+u[2],10),blue:parseInt(""+u[3],10)}}var l=xA.exec(t.substring(0,50));if(l){var c="rgb("+dA(parseInt(""+l[1],10),parseInt(""+l[2],10)/100,parseInt(""+l[3],10)/100)+")",h=bA.exec(c);if(!h)throw new lA(4,t,c);return{red:parseInt(""+h[1],10),green:parseInt(""+h[2],10),blue:parseInt(""+h[3],10),alpha:parseFloat(""+l[4])>1?parseFloat(""+l[4])/100:parseFloat(""+l[4])}}throw new lA(5)}function wA(e){return function(e){var t,r=e.red/255,n=e.green/255,i=e.blue/255,s=Math.max(r,n,i),o=Math.min(r,n,i),a=(s+o)/2;if(s===o)return void 0!==e.alpha?{hue:0,saturation:0,lightness:a,alpha:e.alpha}:{hue:0,saturation:0,lightness:a};var u=s-o,l=a>.5?u/(2-s-o):u/(s+o);switch(s){case r:t=(n-i)/u+(n<i?6:0);break;case n:t=(i-r)/u+2;break;default:t=(r-n)/u+4}return t*=60,void 0!==e.alpha?{hue:t,saturation:l,lightness:a,alpha:e.alpha}:{hue:t,saturation:l,lightness:a}}(TA(e))}var SA=function(e){return 7===e.length&&e[1]===e[2]&&e[3]===e[4]&&e[5]===e[6]?"#"+e[1]+e[3]+e[5]:e};function NA(e){var t=e.toString(16);return 1===t.length?"0"+t:t}function EA(e){return NA(Math.round(255*e))}function CA(e,t,r){return SA("#"+EA(e)+EA(t)+EA(r))}function AA(e,t,r){return dA(e,t,r,CA)}function MA(e,t,r){if("number"==typeof e&&"number"==typeof t&&"number"==typeof r)return SA("#"+NA(e)+NA(t)+NA(r));if("object"==typeof e&&void 0===t&&void 0===r)return SA("#"+NA(e.red)+NA(e.green)+NA(e.blue));throw new lA(6)}function RA(e,t,r,n){if("object"==typeof e&&void 0===t&&void 0===r&&void 0===n)return e.alpha>=1?MA(e.red,e.green,e.blue):"rgba("+e.red+","+e.green+","+e.blue+","+e.alpha+")";throw new lA(7)}function PA(e){if("object"!=typeof e)throw new lA(8);if(function(e){return"number"==typeof e.red&&"number"==typeof e.green&&"number"==typeof e.blue&&"number"==typeof e.alpha}(e))return RA(e);if(function(e){return"number"==typeof e.red&&"number"==typeof e.green&&"number"==typeof e.blue&&("number"!=typeof e.alpha||void 0===e.alpha)}(e))return MA(e);if(function(e){return"number"==typeof e.hue&&"number"==typeof e.saturation&&"number"==typeof e.lightness&&"number"==typeof e.alpha}(e))return function(e,t,r,n){if("object"==typeof e&&void 0===t&&void 0===r&&void 0===n)return e.alpha>=1?AA(e.hue,e.saturation,e.lightness):"rgba("+dA(e.hue,e.saturation,e.lightness)+","+e.alpha+")";throw new lA(2)}(e);if(function(e){return"number"==typeof e.hue&&"number"==typeof e.saturation&&"number"==typeof e.lightness&&("number"!=typeof e.alpha||void 0===e.alpha)}(e))return function(e,t,r){if("object"==typeof e&&void 0===t&&void 0===r)return AA(e.hue,e.saturation,e.lightness);throw new lA(1)}(e);throw new lA(8)}function DA(e,t,r){return function(){var n=r.concat(Array.prototype.slice.call(arguments));return n.length>=t?e.apply(this,n):DA(e,t,n)}}function FA(e){return DA(e,e.length,[])}function OA(e,t,r){return Math.max(e,Math.min(t,r))}FA((function(e,t){if("transparent"===t)return t;var r=wA(t);return PA(En({},r,{hue:r.hue+parseFloat(e)}))})),FA((function(e,t){if("transparent"===t)return t;var r=wA(t);return PA(En({},r,{lightness:OA(0,1,r.lightness-parseFloat(e))}))})),FA((function(e,t){if("transparent"===t)return t;var r=wA(t);return PA(En({},r,{saturation:OA(0,1,r.saturation-parseFloat(e))}))})),FA((function(e,t){if("transparent"===t)return t;var r=wA(t);return PA(En({},r,{lightness:OA(0,1,r.lightness+parseFloat(e))}))}));var LA=FA((function(e,t,r){if("transparent"===t)return r;if("transparent"===r)return t;if(0===e)return r;var n=TA(t),i=En({},n,{alpha:"number"==typeof n.alpha?n.alpha:1}),s=TA(r),o=En({},s,{alpha:"number"==typeof s.alpha?s.alpha:1}),a=i.alpha-o.alpha,u=2*parseFloat(e)-1,l=((u*a===-1?u:u+a)/(1+u*a)+1)/2,c=1-l;return RA({red:Math.floor(i.red*l+o.red*c),green:Math.floor(i.green*l+o.green*c),blue:Math.floor(i.blue*l+o.blue*c),alpha:i.alpha*parseFloat(e)+o.alpha*(1-parseFloat(e))})})),BA=LA;var kA=FA((function(e,t){if("transparent"===t)return t;var r=TA(t),n="number"==typeof r.alpha?r.alpha:1;return RA(En({},r,{alpha:OA(0,1,(100*n+100*parseFloat(e))/100)}))})),IA=kA;FA((function(e,t){if("transparent"===t)return t;var r=wA(t);return PA(En({},r,{saturation:OA(0,1,r.saturation+parseFloat(e))}))})),FA((function(e,t){return"transparent"===t?t:PA(En({},wA(t),{hue:parseFloat(e)}))})),FA((function(e,t){return"transparent"===t?t:PA(En({},wA(t),{lightness:parseFloat(e)}))})),FA((function(e,t){return"transparent"===t?t:PA(En({},wA(t),{saturation:parseFloat(e)}))})),FA((function(e,t){return"transparent"===t?t:BA(parseFloat(e),"rgb(0, 0, 0)",t)})),FA((function(e,t){return"transparent"===t?t:BA(parseFloat(e),"rgb(255, 255, 255)",t)})),FA((function(e,t){if("transparent"===t)return t;var r=TA(t),n="number"==typeof r.alpha?r.alpha:1;return RA(En({},r,{alpha:OA(0,1,+(100*n-100*parseFloat(e)).toFixed(2)/100)}))}));var UA=Object.freeze({Linear:Object.freeze({None:function(e){return e},In:function(e){return e},Out:function(e){return e},InOut:function(e){return e}}),Quadratic:Object.freeze({In:function(e){return e*e},Out:function(e){return e*(2-e)},InOut:function(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)}}),Cubic:Object.freeze({In:function(e){return e*e*e},Out:function(e){return--e*e*e+1},InOut:function(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)}}),Quartic:Object.freeze({In:function(e){return e*e*e*e},Out:function(e){return 1- --e*e*e*e},InOut:function(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)}}),Quintic:Object.freeze({In:function(e){return e*e*e*e*e},Out:function(e){return--e*e*e*e*e+1},InOut:function(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)}}),Sinusoidal:Object.freeze({In:function(e){return 1-Math.sin((1-e)*Math.PI/2)},Out:function(e){return Math.sin(e*Math.PI/2)},InOut:function(e){return.5*(1-Math.sin(Math.PI*(.5-e)))}}),Exponential:Object.freeze({In:function(e){return 0===e?0:Math.pow(1024,e-1)},Out:function(e){return 1===e?1:1-Math.pow(2,-10*e)},InOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1)))}}),Circular:Object.freeze({In:function(e){return 1-Math.sqrt(1-e*e)},Out:function(e){return Math.sqrt(1- --e*e)},InOut:function(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)}}),Elastic:Object.freeze({In:function(e){return 0===e?0:1===e?1:-Math.pow(2,10*(e-1))*Math.sin(5*(e-1.1)*Math.PI)},Out:function(e){return 0===e?0:1===e?1:Math.pow(2,-10*e)*Math.sin(5*(e-.1)*Math.PI)+1},InOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?-.5*Math.pow(2,10*(e-1))*Math.sin(5*(e-1.1)*Math.PI):.5*Math.pow(2,-10*(e-1))*Math.sin(5*(e-1.1)*Math.PI)+1}}),Back:Object.freeze({In:function(e){var t=1.70158;return 1===e?1:e*e*((t+1)*e-t)},Out:function(e){var t=1.70158;return 0===e?0:--e*e*((t+1)*e+t)+1},InOut:function(e){var t=2.5949095;return(e*=2)<1?e*e*((t+1)*e-t)*.5:.5*((e-=2)*e*((t+1)*e+t)+2)}}),Bounce:Object.freeze({In:function(e){return 1-UA.Bounce.Out(1-e)},Out:function(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375},InOut:function(e){return e<.5?.5*UA.Bounce.In(2*e):.5*UA.Bounce.Out(2*e-1)+.5}}),generatePow:function(e){return void 0===e&&(e=4),e=(e=e<Number.EPSILON?Number.EPSILON:e)>1e4?1e4:e,{In:function(t){return Math.pow(t,e)},Out:function(t){return 1-Math.pow(1-t,e)},InOut:function(t){return t<.5?Math.pow(2*t,e)/2:(1-Math.pow(2-2*t,e))/2+.5}}}}),VA=function(){return performance.now()},jA=function(){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._tweens={},this._tweensAddedDuringUpdate={},this.add.apply(this,e)}return e.prototype.getAll=function(){var e=this;return Object.keys(this._tweens).map((function(t){return e._tweens[t]}))},e.prototype.removeAll=function(){this._tweens={}},e.prototype.add=function(){for(var e,t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];for(var n=0,i=t;n<i.length;n++){var s=i[n];null===(e=s._group)||void 0===e||e.remove(s),s._group=this,this._tweens[s.getId()]=s,this._tweensAddedDuringUpdate[s.getId()]=s}},e.prototype.remove=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];for(var r=0,n=e;r<n.length;r++){var i=n[r];i._group=void 0,delete this._tweens[i.getId()],delete this._tweensAddedDuringUpdate[i.getId()]}},e.prototype.allStopped=function(){return this.getAll().every((function(e){return!e.isPlaying()}))},e.prototype.update=function(e,t){void 0===e&&(e=VA()),void 0===t&&(t=!0);var r=Object.keys(this._tweens);if(0!==r.length)for(;r.length>0;){this._tweensAddedDuringUpdate={};for(var n=0;n<r.length;n++){var i=this._tweens[r[n]],s=!t;i&&!1===i.update(e,s)&&!t&&this.remove(i)}r=Object.keys(this._tweensAddedDuringUpdate)}},e}(),GA={Linear:function(e,t){var r=e.length-1,n=r*t,i=Math.floor(n),s=GA.Utils.Linear;return t<0?s(e[0],e[1],n):t>1?s(e[r],e[r-1],r-n):s(e[i],e[i+1>r?r:i+1],n-i)},Utils:{Linear:function(e,t,r){return(t-e)*r+e}}},zA=function(){function e(){}return e.nextId=function(){return e._nextId++},e._nextId=0,e}(),$A=new jA,HA=function(){function e(e,t){this._isPaused=!1,this._pauseStart=0,this._valuesStart={},this._valuesEnd={},this._valuesStartRepeat={},this._duration=1e3,this._isDynamic=!1,this._initialRepeat=0,this._repeat=0,this._yoyo=!1,this._isPlaying=!1,this._reversed=!1,this._delayTime=0,this._startTime=0,this._easingFunction=UA.Linear.None,this._interpolationFunction=GA.Linear,this._chainedTweens=[],this._onStartCallbackFired=!1,this._onEveryStartCallbackFired=!1,this._id=zA.nextId(),this._isChainStopped=!1,this._propertiesAreSetUp=!1,this._goToEnd=!1,this._object=e,"object"==typeof t?(this._group=t,t.add(this)):!0===t&&(this._group=$A,$A.add(this))}return e.prototype.getId=function(){return this._id},e.prototype.isPlaying=function(){return this._isPlaying},e.prototype.isPaused=function(){return this._isPaused},e.prototype.getDuration=function(){return this._duration},e.prototype.to=function(e,t){if(void 0===t&&(t=1e3),this._isPlaying)throw new Error("Can not call Tween.to() while Tween is already started or paused. Stop the Tween first.");return this._valuesEnd=e,this._propertiesAreSetUp=!1,this._duration=t<0?0:t,this},e.prototype.duration=function(e){return void 0===e&&(e=1e3),this._duration=e<0?0:e,this},e.prototype.dynamic=function(e){return void 0===e&&(e=!1),this._isDynamic=e,this},e.prototype.start=function(e,t){if(void 0===e&&(e=VA()),void 0===t&&(t=!1),this._isPlaying)return this;if(this._repeat=this._initialRepeat,this._reversed)for(var r in this._reversed=!1,this._valuesStartRepeat)this._swapEndStartRepeatValues(r),this._valuesStart[r]=this._valuesStartRepeat[r];if(this._isPlaying=!0,this._isPaused=!1,this._onStartCallbackFired=!1,this._onEveryStartCallbackFired=!1,this._isChainStopped=!1,this._startTime=e,this._startTime+=this._delayTime,!this._propertiesAreSetUp||t){if(this._propertiesAreSetUp=!0,!this._isDynamic){var n={};for(var i in this._valuesEnd)n[i]=this._valuesEnd[i];this._valuesEnd=n}this._setupProperties(this._object,this._valuesStart,this._valuesEnd,this._valuesStartRepeat,t)}return this},e.prototype.startFromCurrentValues=function(e){return this.start(e,!0)},e.prototype._setupProperties=function(e,t,r,n,i){for(var s in r){var o=e[s],a=Array.isArray(o),u=a?"array":typeof o,l=!a&&Array.isArray(r[s]);if("undefined"!==u&&"function"!==u){if(l){if(0===(m=r[s]).length)continue;for(var c=[o],h=0,d=m.length;h<d;h+=1){var p=this._handleRelativeValue(o,m[h]);if(isNaN(p)){l=!1;break}c.push(p)}l&&(r[s]=c)}if("object"!==u&&!a||!o||l)(void 0===t[s]||i)&&(t[s]=o),a||(t[s]*=1),n[s]=l?r[s].slice().reverse():t[s]||0;else{t[s]=a?[]:{};var f=o;for(var g in f)t[s][g]=f[g];n[s]=a?[]:{};var m=r[s];if(!this._isDynamic){var y={};for(var g in m)y[g]=m[g];r[s]=m=y}this._setupProperties(f,t[s],m,n[s],i)}}}},e.prototype.stop=function(){return this._isChainStopped||(this._isChainStopped=!0,this.stopChainedTweens()),this._isPlaying?(this._isPlaying=!1,this._isPaused=!1,this._onStopCallback&&this._onStopCallback(this._object),this):this},e.prototype.end=function(){return this._goToEnd=!0,this.update(this._startTime+this._duration),this},e.prototype.pause=function(e){return void 0===e&&(e=VA()),this._isPaused||!this._isPlaying||(this._isPaused=!0,this._pauseStart=e),this},e.prototype.resume=function(e){return void 0===e&&(e=VA()),this._isPaused&&this._isPlaying?(this._isPaused=!1,this._startTime+=e-this._pauseStart,this._pauseStart=0,this):this},e.prototype.stopChainedTweens=function(){for(var e=0,t=this._chainedTweens.length;e<t;e++)this._chainedTweens[e].stop();return this},e.prototype.group=function(e){return e?(e.add(this),this):this},e.prototype.remove=function(){var e;return null===(e=this._group)||void 0===e||e.remove(this),this},e.prototype.delay=function(e){return void 0===e&&(e=0),this._delayTime=e,this},e.prototype.repeat=function(e){return void 0===e&&(e=0),this._initialRepeat=e,this._repeat=e,this},e.prototype.repeatDelay=function(e){return this._repeatDelayTime=e,this},e.prototype.yoyo=function(e){return void 0===e&&(e=!1),this._yoyo=e,this},e.prototype.easing=function(e){return void 0===e&&(e=UA.Linear.None),this._easingFunction=e,this},e.prototype.interpolation=function(e){return void 0===e&&(e=GA.Linear),this._interpolationFunction=e,this},e.prototype.chain=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return this._chainedTweens=e,this},e.prototype.onStart=function(e){return this._onStartCallback=e,this},e.prototype.onEveryStart=function(e){return this._onEveryStartCallback=e,this},e.prototype.onUpdate=function(e){return this._onUpdateCallback=e,this},e.prototype.onRepeat=function(e){return this._onRepeatCallback=e,this},e.prototype.onComplete=function(e){return this._onCompleteCallback=e,this},e.prototype.onStop=function(e){return this._onStopCallback=e,this},e.prototype.update=function(t,r){var n,i,s=this;if(void 0===t&&(t=VA()),void 0===r&&(r=e.autoStartOnUpdate),this._isPaused)return!0;if(!this._goToEnd&&!this._isPlaying){if(!r)return!1;this.start(t,!0)}if(this._goToEnd=!1,t<this._startTime)return!0;!1===this._onStartCallbackFired&&(this._onStartCallback&&this._onStartCallback(this._object),this._onStartCallbackFired=!0),!1===this._onEveryStartCallbackFired&&(this._onEveryStartCallback&&this._onEveryStartCallback(this._object),this._onEveryStartCallbackFired=!0);var o=t-this._startTime,a=this._duration+(null!==(n=this._repeatDelayTime)&&void 0!==n?n:this._delayTime),u=this._duration+this._repeat*a,l=function(){if(0===s._duration)return 1;if(o>u)return 1;var e=Math.trunc(o/a),t=o-e*a,r=Math.min(t/s._duration,1);return 0===r&&o===s._duration?1:r}(),c=this._easingFunction(l);if(this._updateProperties(this._object,this._valuesStart,this._valuesEnd,c),this._onUpdateCallback&&this._onUpdateCallback(this._object,l),0===this._duration||o>=this._duration){if(this._repeat>0){var h=Math.min(Math.trunc((o-this._duration)/a)+1,this._repeat);for(i in isFinite(this._repeat)&&(this._repeat-=h),this._valuesStartRepeat)this._yoyo||"string"!=typeof this._valuesEnd[i]||(this._valuesStartRepeat[i]=this._valuesStartRepeat[i]+parseFloat(this._valuesEnd[i])),this._yoyo&&this._swapEndStartRepeatValues(i),this._valuesStart[i]=this._valuesStartRepeat[i];return this._yoyo&&(this._reversed=!this._reversed),this._startTime+=a*h,this._onRepeatCallback&&this._onRepeatCallback(this._object),this._onEveryStartCallbackFired=!1,!0}this._onCompleteCallback&&this._onCompleteCallback(this._object);for(var d=0,p=this._chainedTweens.length;d<p;d++)this._chainedTweens[d].start(this._startTime+this._duration,!1);return this._isPlaying=!1,!1}return!0},e.prototype._updateProperties=function(e,t,r,n){for(var i in r)if(void 0!==t[i]){var s=t[i]||0,o=r[i],a=Array.isArray(e[i]),u=Array.isArray(o);!a&&u?e[i]=this._interpolationFunction(o,n):"object"==typeof o&&o?this._updateProperties(e[i],s,o,n):"number"==typeof(o=this._handleRelativeValue(s,o))&&(e[i]=s+(o-s)*n)}},e.prototype._handleRelativeValue=function(e,t){return"string"!=typeof t?t:"+"===t.charAt(0)||"-"===t.charAt(0)?e+parseFloat(t):parseFloat(t)},e.prototype._swapEndStartRepeatValues=function(e){var t=this._valuesStartRepeat[e],r=this._valuesEnd[e];this._valuesStartRepeat[e]="string"==typeof r?this._valuesStartRepeat[e]+parseFloat(r):this._valuesEnd[e],this._valuesEnd[e]=t},e.autoStartOnUpdate=!1,e}();zA.nextId;var WA=$A;WA.getAll.bind(WA),WA.removeAll.bind(WA),WA.add.bind(WA),WA.remove.bind(WA),WA.update.bind(WA);var qA="http://www.w3.org/1999/xhtml";const XA={svg:"http://www.w3.org/2000/svg",xhtml:qA,xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/"};function KA(e){var t=e+="",r=t.indexOf(":");return r>=0&&"xmlns"!==(t=e.slice(0,r))&&(e=e.slice(r+1)),XA.hasOwnProperty(t)?{space:XA[t],local:e}:e}function YA(e){return function(){var t=this.ownerDocument,r=this.namespaceURI;return r===qA&&t.documentElement.namespaceURI===qA?t.createElement(e):t.createElementNS(r,e)}}function QA(e){return function(){return this.ownerDocument.createElementNS(e.space,e.local)}}function ZA(e){var t=KA(e);return(t.local?QA:YA)(t)}function JA(){}function eM(e){return null==e?JA:function(){return this.querySelector(e)}}function tM(){return[]}function rM(e){return function(){return function(e){return null==e?[]:Array.isArray(e)?e:Array.from(e)}(e.apply(this,arguments))}}function nM(e){return function(t){return t.matches(e)}}var iM=Array.prototype.find;function sM(){return this.firstElementChild}var oM=Array.prototype.filter;function aM(){return Array.from(this.children)}function uM(e){return new Array(e.length)}function lM(e,t){this.ownerDocument=e.ownerDocument,this.namespaceURI=e.namespaceURI,this._next=null,this._parent=e,this.__data__=t}function cM(e,t,r,n,i,s){for(var o,a=0,u=t.length,l=s.length;a<l;++a)(o=t[a])?(o.__data__=s[a],n[a]=o):r[a]=new lM(e,s[a]);for(;a<u;++a)(o=t[a])&&(i[a]=o)}function hM(e,t,r,n,i,s,o){var a,u,l,c=new Map,h=t.length,d=s.length,p=new Array(h);for(a=0;a<h;++a)(u=t[a])&&(p[a]=l=o.call(u,u.__data__,a,t)+"",c.has(l)?i[a]=u:c.set(l,u));for(a=0;a<d;++a)l=o.call(e,s[a],a,s)+"",(u=c.get(l))?(n[a]=u,u.__data__=s[a],c.delete(l)):r[a]=new lM(e,s[a]);for(a=0;a<h;++a)(u=t[a])&&c.get(p[a])===u&&(i[a]=u)}function dM(e){return e.__data__}function pM(e){return"object"==typeof e&&"length"in e?e:Array.from(e)}function fM(e,t){return e<t?-1:e>t?1:e>=t?0:NaN}function gM(e){return function(){this.removeAttribute(e)}}function mM(e){return function(){this.removeAttributeNS(e.space,e.local)}}function yM(e,t){return function(){this.setAttribute(e,t)}}function bM(e,t){return function(){this.setAttributeNS(e.space,e.local,t)}}function _M(e,t){return function(){var r=t.apply(this,arguments);null==r?this.removeAttribute(e):this.setAttribute(e,r)}}function vM(e,t){return function(){var r=t.apply(this,arguments);null==r?this.removeAttributeNS(e.space,e.local):this.setAttributeNS(e.space,e.local,r)}}function xM(e){return e.ownerDocument&&e.ownerDocument.defaultView||e.document&&e||e.defaultView}function TM(e){return function(){this.style.removeProperty(e)}}function wM(e,t,r){return function(){this.style.setProperty(e,t,r)}}function SM(e,t,r){return function(){var n=t.apply(this,arguments);null==n?this.style.removeProperty(e):this.style.setProperty(e,n,r)}}function NM(e){return function(){delete this[e]}}function EM(e,t){return function(){this[e]=t}}function CM(e,t){return function(){var r=t.apply(this,arguments);null==r?delete this[e]:this[e]=r}}function AM(e){return e.trim().split(/^|\s+/)}function MM(e){return e.classList||new RM(e)}function RM(e){this._node=e,this._names=AM(e.getAttribute("class")||"")}function PM(e,t){for(var r=MM(e),n=-1,i=t.length;++n<i;)r.add(t[n])}function DM(e,t){for(var r=MM(e),n=-1,i=t.length;++n<i;)r.remove(t[n])}function FM(e){return function(){PM(this,e)}}function OM(e){return function(){DM(this,e)}}function LM(e,t){return function(){(t.apply(this,arguments)?PM:DM)(this,e)}}function BM(){this.textContent=""}function kM(e){return function(){this.textContent=e}}function IM(e){return function(){var t=e.apply(this,arguments);this.textContent=null==t?"":t}}function UM(){this.innerHTML=""}function VM(e){return function(){this.innerHTML=e}}function jM(e){return function(){var t=e.apply(this,arguments);this.innerHTML=null==t?"":t}}function GM(){this.nextSibling&&this.parentNode.appendChild(this)}function zM(){this.previousSibling&&this.parentNode.insertBefore(this,this.parentNode.firstChild)}function $M(){return null}function HM(){var e=this.parentNode;e&&e.removeChild(this)}function WM(){var e=this.cloneNode(!1),t=this.parentNode;return t?t.insertBefore(e,this.nextSibling):e}function qM(){var e=this.cloneNode(!0),t=this.parentNode;return t?t.insertBefore(e,this.nextSibling):e}function XM(e){return function(){var t=this.__on;if(t){for(var r,n=0,i=-1,s=t.length;n<s;++n)r=t[n],e.type&&r.type!==e.type||r.name!==e.name?t[++i]=r:this.removeEventListener(r.type,r.listener,r.options);++i?t.length=i:delete this.__on}}}function KM(e,t,r){return function(){var n,i=this.__on,s=function(e){return function(t){e.call(this,t,this.__data__)}}(t);if(i)for(var o=0,a=i.length;o<a;++o)if((n=i[o]).type===e.type&&n.name===e.name)return this.removeEventListener(n.type,n.listener,n.options),this.addEventListener(n.type,n.listener=s,n.options=r),void(n.value=t);this.addEventListener(e.type,s,r),n={type:e.type,name:e.name,value:t,listener:s,options:r},i?i.push(n):this.__on=[n]}}function YM(e,t,r){var n=xM(e),i=n.CustomEvent;"function"==typeof i?i=new i(t,r):(i=n.document.createEvent("Event"),r?(i.initEvent(t,r.bubbles,r.cancelable),i.detail=r.detail):i.initEvent(t,!1,!1)),e.dispatchEvent(i)}function QM(e,t){return function(){return YM(this,e,t)}}function ZM(e,t){return function(){return YM(this,e,t.apply(this,arguments))}}lM.prototype={constructor:lM,appendChild:function(e){return this._parent.insertBefore(e,this._next)},insertBefore:function(e,t){return this._parent.insertBefore(e,t)},querySelector:function(e){return this._parent.querySelector(e)},querySelectorAll:function(e){return this._parent.querySelectorAll(e)}},RM.prototype={add:function(e){this._names.indexOf(e)<0&&(this._names.push(e),this._node.setAttribute("class",this._names.join(" ")))},remove:function(e){var t=this._names.indexOf(e);t>=0&&(this._names.splice(t,1),this._node.setAttribute("class",this._names.join(" ")))},contains:function(e){return this._names.indexOf(e)>=0}};var JM=[null];function eR(e,t){this._groups=e,this._parents=t}eR.prototype={constructor:eR,select:function(e){"function"!=typeof e&&(e=eM(e));for(var t=this._groups,r=t.length,n=new Array(r),i=0;i<r;++i)for(var s,o,a=t[i],u=a.length,l=n[i]=new Array(u),c=0;c<u;++c)(s=a[c])&&(o=e.call(s,s.__data__,c,a))&&("__data__"in s&&(o.__data__=s.__data__),l[c]=o);return new eR(n,this._parents)},selectAll:function(e){e="function"==typeof e?rM(e):function(e){return null==e?tM:function(){return this.querySelectorAll(e)}}(e);for(var t=this._groups,r=t.length,n=[],i=[],s=0;s<r;++s)for(var o,a=t[s],u=a.length,l=0;l<u;++l)(o=a[l])&&(n.push(e.call(o,o.__data__,l,a)),i.push(o));return new eR(n,i)},selectChild:function(e){return this.select(null==e?sM:function(e){return function(){return iM.call(this.children,e)}}("function"==typeof e?e:nM(e)))},selectChildren:function(e){return this.selectAll(null==e?aM:function(e){return function(){return oM.call(this.children,e)}}("function"==typeof e?e:nM(e)))},filter:function(e){"function"!=typeof e&&(e=function(e){return function(){return this.matches(e)}}(e));for(var t=this._groups,r=t.length,n=new Array(r),i=0;i<r;++i)for(var s,o=t[i],a=o.length,u=n[i]=[],l=0;l<a;++l)(s=o[l])&&e.call(s,s.__data__,l,o)&&u.push(s);return new eR(n,this._parents)},data:function(e,t){if(!arguments.length)return Array.from(this,dM);var r=t?hM:cM,n=this._parents,i=this._groups;"function"!=typeof e&&(e=function(e){return function(){return e}}(e));for(var s=i.length,o=new Array(s),a=new Array(s),u=new Array(s),l=0;l<s;++l){var c=n[l],h=i[l],d=h.length,p=pM(e.call(c,c&&c.__data__,l,n)),f=p.length,g=a[l]=new Array(f),m=o[l]=new Array(f);r(c,h,g,m,u[l]=new Array(d),p,t);for(var y,b,_=0,v=0;_<f;++_)if(y=g[_]){for(_>=v&&(v=_+1);!(b=m[v])&&++v<f;);y._next=b||null}}return(o=new eR(o,n))._enter=a,o._exit=u,o},enter:function(){return new eR(this._enter||this._groups.map(uM),this._parents)},exit:function(){return new eR(this._exit||this._groups.map(uM),this._parents)},join:function(e,t,r){var n=this.enter(),i=this,s=this.exit();return"function"==typeof e?(n=e(n))&&(n=n.selection()):n=n.append(e+""),null!=t&&(i=t(i))&&(i=i.selection()),null==r?s.remove():r(s),n&&i?n.merge(i).order():i},merge:function(e){for(var t=e.selection?e.selection():e,r=this._groups,n=t._groups,i=r.length,s=n.length,o=Math.min(i,s),a=new Array(i),u=0;u<o;++u)for(var l,c=r[u],h=n[u],d=c.length,p=a[u]=new Array(d),f=0;f<d;++f)(l=c[f]||h[f])&&(p[f]=l);for(;u<i;++u)a[u]=r[u];return new eR(a,this._parents)},selection:function(){return this},order:function(){for(var e=this._groups,t=-1,r=e.length;++t<r;)for(var n,i=e[t],s=i.length-1,o=i[s];--s>=0;)(n=i[s])&&(o&&4^n.compareDocumentPosition(o)&&o.parentNode.insertBefore(n,o),o=n);return this},sort:function(e){function t(t,r){return t&&r?e(t.__data__,r.__data__):!t-!r}e||(e=fM);for(var r=this._groups,n=r.length,i=new Array(n),s=0;s<n;++s){for(var o,a=r[s],u=a.length,l=i[s]=new Array(u),c=0;c<u;++c)(o=a[c])&&(l[c]=o);l.sort(t)}return new eR(i,this._parents).order()},call:function(){var e=arguments[0];return arguments[0]=this,e.apply(null,arguments),this},nodes:function(){return Array.from(this)},node:function(){for(var e=this._groups,t=0,r=e.length;t<r;++t)for(var n=e[t],i=0,s=n.length;i<s;++i){var o=n[i];if(o)return o}return null},size:function(){let e=0;for(const t of this)++e;return e},empty:function(){return!this.node()},each:function(e){for(var t=this._groups,r=0,n=t.length;r<n;++r)for(var i,s=t[r],o=0,a=s.length;o<a;++o)(i=s[o])&&e.call(i,i.__data__,o,s);return this},attr:function(e,t){var r=KA(e);if(arguments.length<2){var n=this.node();return r.local?n.getAttributeNS(r.space,r.local):n.getAttribute(r)}return this.each((null==t?r.local?mM:gM:"function"==typeof t?r.local?vM:_M:r.local?bM:yM)(r,t))},style:function(e,t,r){return arguments.length>1?this.each((null==t?TM:"function"==typeof t?SM:wM)(e,t,null==r?"":r)):function(e,t){return e.style.getPropertyValue(t)||xM(e).getComputedStyle(e,null).getPropertyValue(t)}(this.node(),e)},property:function(e,t){return arguments.length>1?this.each((null==t?NM:"function"==typeof t?CM:EM)(e,t)):this.node()[e]},classed:function(e,t){var r=AM(e+"");if(arguments.length<2){for(var n=MM(this.node()),i=-1,s=r.length;++i<s;)if(!n.contains(r[i]))return!1;return!0}return this.each(("function"==typeof t?LM:t?FM:OM)(r,t))},text:function(e){return arguments.length?this.each(null==e?BM:("function"==typeof e?IM:kM)(e)):this.node().textContent},html:function(e){return arguments.length?this.each(null==e?UM:("function"==typeof e?jM:VM)(e)):this.node().innerHTML},raise:function(){return this.each(GM)},lower:function(){return this.each(zM)},append:function(e){var t="function"==typeof e?e:ZA(e);return this.select((function(){return this.appendChild(t.apply(this,arguments))}))},insert:function(e,t){var r="function"==typeof e?e:ZA(e),n=null==t?$M:"function"==typeof t?t:eM(t);return this.select((function(){return this.insertBefore(r.apply(this,arguments),n.apply(this,arguments)||null)}))},remove:function(){return this.each(HM)},clone:function(e){return this.select(e?qM:WM)},datum:function(e){return arguments.length?this.property("__data__",e):this.node().__data__},on:function(e,t,r){var n,i,s=function(e){return e.trim().split(/^|\s+/).map((function(e){var t="",r=e.indexOf(".");return r>=0&&(t=e.slice(r+1),e=e.slice(0,r)),{type:e,name:t}}))}(e+""),o=s.length;if(!(arguments.length<2)){for(a=t?KM:XM,n=0;n<o;++n)this.each(a(s[n],t,r));return this}var a=this.node().__on;if(a)for(var u,l=0,c=a.length;l<c;++l)for(n=0,u=a[l];n<o;++n)if((i=s[n]).type===u.type&&i.name===u.name)return u.value},dispatch:function(e,t){return this.each(("function"==typeof t?ZM:QM)(e,t))},[Symbol.iterator]:function*(){for(var e=this._groups,t=0,r=e.length;t<r;++t)for(var n,i=e[t],s=0,o=i.length;s<o;++s)(n=i[s])&&(yield n)}};var tR,rR,nR,iR,sR,oR,aR,uR={},lR=[],cR=/acit|ex(?:s|g|n|p|$)|rph|grid|ows|mnc|ntw|ine[ch]|zoo|^ord/i;function hR(e,t){for(var r in t)e[r]=t[r];return e}function dR(e){var t=e.parentNode;t&&t.removeChild(e)}function pR(e,t,r,n,i){var s={type:e,props:t,key:r,ref:n,__k:null,__:null,__b:0,__e:null,__d:void 0,__c:null,constructor:void 0,__v:i};return null==i&&(s.__v=s),tR.vnode&&tR.vnode(s),s}function fR(e){return e.children}function gR(e,t){this.props=e,this.context=t}function mR(e,t){if(null==t)return e.__?mR(e.__,e.__.__k.indexOf(e)+1):null;for(var r;t<e.__k.length;t++)if(null!=(r=e.__k[t])&&null!=r.__e)return r.__e;return"function"==typeof e.type?mR(e):null}function yR(e){var t,r;if(null!=(e=e.__)&&null!=e.__c){for(e.__e=e.__c.base=null,t=0;t<e.__k.length;t++)if(null!=(r=e.__k[t])&&null!=r.__e){e.__e=e.__c.base=r.__e;break}return yR(e)}}function bR(e){(!e.__d&&(e.__d=!0)&&nR.push(e)&&!iR++||oR!==tR.debounceRendering)&&((oR=tR.debounceRendering)||sR)(_R)}function _R(){for(var e;iR=nR.length;)e=nR.sort((function(e,t){return e.__v.__b-t.__v.__b})),nR=[],e.some((function(e){var t,r,n,i,s,o,a;e.__d&&(o=(s=(t=e).__v).__e,(a=t.__P)&&(r=[],(n=hR({},s)).__v=n,i=NR(a,s,n,t.__n,void 0!==a.ownerSVGElement,null,r,null==o?mR(s):o),ER(r,s),i!=o&&yR(s)))}))}function vR(e,t,r,n,i,s,o,a,u){var l,c,h,d,p,f,g,m=r&&r.__k||lR,y=m.length;if(a==uR&&(a=null!=s?s[0]:y?mR(r,0):null),l=0,t.__k=xR(t.__k,(function(r){if(null!=r){if(r.__=t,r.__b=t.__b+1,null===(h=m[l])||h&&r.key==h.key&&r.type===h.type)m[l]=void 0;else for(c=0;c<y;c++){if((h=m[c])&&r.key==h.key&&r.type===h.type){m[c]=void 0;break}h=null}if(d=NR(e,r,h=h||uR,n,i,s,o,a,u),(c=r.ref)&&h.ref!=c&&(g||(g=[]),h.ref&&g.push(h.ref,null,r),g.push(c,r.__c||d,r)),null!=d){var b;if(null==f&&(f=d),void 0!==r.__d)b=r.__d,r.__d=void 0;else if(s==h||d!=a||null==d.parentNode){e:if(null==a||a.parentNode!==e)e.appendChild(d),b=null;else{for(p=a,c=0;(p=p.nextSibling)&&c<y;c+=2)if(p==d)break e;e.insertBefore(d,a),b=a}"option"==t.type&&(e.value="")}a=void 0!==b?b:d.nextSibling,"function"==typeof t.type&&(t.__d=a)}else a&&h.__e==a&&a.parentNode!=e&&(a=mR(h))}return l++,r})),t.__e=f,null!=s&&"function"!=typeof t.type)for(l=s.length;l--;)null!=s[l]&&dR(s[l]);for(l=y;l--;)null!=m[l]&&MR(m[l],m[l]);if(g)for(l=0;l<g.length;l++)AR(g[l],g[++l],g[++l])}function xR(e,t,r){if(null==r&&(r=[]),null==e||"boolean"==typeof e)t&&r.push(t(null));else if(Array.isArray(e))for(var n=0;n<e.length;n++)xR(e[n],t,r);else r.push(t?t("string"==typeof e||"number"==typeof e?pR(null,e,null,null,e):null!=e.__e||null!=e.__c?pR(e.type,e.props,e.key,null,e.__v):e):e);return r}function TR(e,t,r){"-"===t[0]?e.setProperty(t,r):e[t]="number"==typeof r&&!1===cR.test(t)?r+"px":null==r?"":r}function wR(e,t,r,n,i){var s,o,a,u,l;if(i?"className"===t&&(t="class"):"class"===t&&(t="className"),"style"===t)if(s=e.style,"string"==typeof r)s.cssText=r;else{if("string"==typeof n&&(s.cssText="",n=null),n)for(u in n)r&&u in r||TR(s,u,"");if(r)for(l in r)n&&r[l]===n[l]||TR(s,l,r[l])}else"o"===t[0]&&"n"===t[1]?(o=t!==(t=t.replace(/Capture$/,"")),a=t.toLowerCase(),t=(a in e?a:t).slice(2),r?(n||e.addEventListener(t,SR,o),(e.l||(e.l={}))[t]=r):e.removeEventListener(t,SR,o)):"list"!==t&&"tagName"!==t&&"form"!==t&&"type"!==t&&"size"!==t&&!i&&t in e?e[t]=null==r?"":r:"function"!=typeof r&&"dangerouslySetInnerHTML"!==t&&(t!==(t=t.replace(/^xlink:?/,""))?null==r||!1===r?e.removeAttributeNS("http://www.w3.org/1999/xlink",t.toLowerCase()):e.setAttributeNS("http://www.w3.org/1999/xlink",t.toLowerCase(),r):null==r||!1===r&&!/^ar/.test(t)?e.removeAttribute(t):e.setAttribute(t,r))}function SR(e){this.l[e.type](tR.event?tR.event(e):e)}function NR(e,t,r,n,i,s,o,a,u){var l,c,h,d,p,f,g,m,y,b,_=t.type;if(void 0!==t.constructor)return null;(l=tR.__b)&&l(t);try{e:if("function"==typeof _){if(m=t.props,y=(l=_.contextType)&&n[l.__c],b=l?y?y.props.value:l.__:n,r.__c?g=(c=t.__c=r.__c).__=c.__E:("prototype"in _&&_.prototype.render?t.__c=c=new _(m,b):(t.__c=c=new gR(m,b),c.constructor=_,c.render=RR),y&&y.sub(c),c.props=m,c.state||(c.state={}),c.context=b,c.__n=n,h=c.__d=!0,c.__h=[]),null==c.__s&&(c.__s=c.state),null!=_.getDerivedStateFromProps&&(c.__s==c.state&&(c.__s=hR({},c.__s)),hR(c.__s,_.getDerivedStateFromProps(m,c.__s))),d=c.props,p=c.state,h)null==_.getDerivedStateFromProps&&null!=c.componentWillMount&&c.componentWillMount(),null!=c.componentDidMount&&c.__h.push(c.componentDidMount);else{if(null==_.getDerivedStateFromProps&&m!==d&&null!=c.componentWillReceiveProps&&c.componentWillReceiveProps(m,b),!c.__e&&null!=c.shouldComponentUpdate&&!1===c.shouldComponentUpdate(m,c.__s,b)||t.__v===r.__v&&!c.__){for(c.props=m,c.state=c.__s,t.__v!==r.__v&&(c.__d=!1),c.__v=t,t.__e=r.__e,t.__k=r.__k,c.__h.length&&o.push(c),l=0;l<t.__k.length;l++)t.__k[l]&&(t.__k[l].__=t);break e}null!=c.componentWillUpdate&&c.componentWillUpdate(m,c.__s,b),null!=c.componentDidUpdate&&c.__h.push((function(){c.componentDidUpdate(d,p,f)}))}c.context=b,c.props=m,c.state=c.__s,(l=tR.__r)&&l(t),c.__d=!1,c.__v=t,c.__P=e,l=c.render(c.props,c.state,c.context),t.__k=null!=l&&l.type==fR&&null==l.key?l.props.children:Array.isArray(l)?l:[l],null!=c.getChildContext&&(n=hR(hR({},n),c.getChildContext())),h||null==c.getSnapshotBeforeUpdate||(f=c.getSnapshotBeforeUpdate(d,p)),vR(e,t,r,n,i,s,o,a,u),c.base=t.__e,c.__h.length&&o.push(c),g&&(c.__E=c.__=null),c.__e=!1}else null==s&&t.__v===r.__v?(t.__k=r.__k,t.__e=r.__e):t.__e=CR(r.__e,t,r,n,i,s,o,u);(l=tR.diffed)&&l(t)}catch(e){t.__v=null,tR.__e(e,t,r)}return t.__e}function ER(e,t){tR.__c&&tR.__c(t,e),e.some((function(t){try{e=t.__h,t.__h=[],e.some((function(e){e.call(t)}))}catch(e){tR.__e(e,t.__v)}}))}function CR(e,t,r,n,i,s,o,a){var u,l,c,h,d,p=r.props,f=t.props;if(i="svg"===t.type||i,null!=s)for(u=0;u<s.length;u++)if(null!=(l=s[u])&&((null===t.type?3===l.nodeType:l.localName===t.type)||e==l)){e=l,s[u]=null;break}if(null==e){if(null===t.type)return document.createTextNode(f);e=i?document.createElementNS("http://www.w3.org/2000/svg",t.type):document.createElement(t.type,f.is&&{is:f.is}),s=null,a=!1}if(null===t.type)p!==f&&e.data!=f&&(e.data=f);else{if(null!=s&&(s=lR.slice.call(e.childNodes)),c=(p=r.props||uR).dangerouslySetInnerHTML,h=f.dangerouslySetInnerHTML,!a){if(p===uR)for(p={},d=0;d<e.attributes.length;d++)p[e.attributes[d].name]=e.attributes[d].value;(h||c)&&(h&&c&&h.__html==c.__html||(e.innerHTML=h&&h.__html||""))}(function(e,t,r,n,i){var s;for(s in r)"children"===s||"key"===s||s in t||wR(e,s,null,r[s],n);for(s in t)i&&"function"!=typeof t[s]||"children"===s||"key"===s||"value"===s||"checked"===s||r[s]===t[s]||wR(e,s,t[s],r[s],n)})(e,f,p,i,a),h?t.__k=[]:(t.__k=t.props.children,vR(e,t,r,n,"foreignObject"!==t.type&&i,s,o,uR,a)),a||("value"in f&&void 0!==(u=f.value)&&u!==e.value&&wR(e,"value",u,p.value,!1),"checked"in f&&void 0!==(u=f.checked)&&u!==e.checked&&wR(e,"checked",u,p.checked,!1))}return e}function AR(e,t,r){try{"function"==typeof e?e(t):e.current=t}catch(e){tR.__e(e,r)}}function MR(e,t,r){var n,i,s;if(tR.unmount&&tR.unmount(e),(n=e.ref)&&(n.current&&n.current!==e.__e||AR(n,null,t)),r||"function"==typeof e.type||(r=null!=(i=e.__e)),e.__e=e.__d=void 0,null!=(n=e.__c)){if(n.componentWillUnmount)try{n.componentWillUnmount()}catch(e){tR.__e(e,t)}n.base=n.__P=null}if(n=e.__k)for(s=0;s<n.length;s++)n[s]&&MR(n[s],t,r);null!=i&&dR(i)}function RR(e,t,r){return this.constructor(e,r)}function PR(e,t,r){var n,i,s;tR.__&&tR.__(e,t),i=(n=r===aR)?null:t.__k,e=function(e,t,r){var n,i=arguments,s={};for(n in t)"key"!==n&&"ref"!==n&&(s[n]=t[n]);if(arguments.length>3)for(r=[r],n=3;n<arguments.length;n++)r.push(i[n]);if(null!=r&&(s.children=r),"function"==typeof e&&null!=e.defaultProps)for(n in e.defaultProps)void 0===s[n]&&(s[n]=e.defaultProps[n]);return pR(e,s,t,t,null)}(fR,null,[e]),s=[],NR(t,t.__k=e,i||uR,uR,void 0!==t.ownerSVGElement,i?null:lR.slice.call(t.childNodes),s,uR,n),ER(s,e)}function DR(e,t){var r,n;for(n in t=hR(hR({},e.props),t),arguments.length>2&&(t.children=lR.slice.call(arguments,2)),r={},t)"key"!==n&&"ref"!==n&&(r[n]=t[n]);return pR(e.type,r,t.key||e.key,t.ref||e.ref,null)}function FR(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function OR(e,t,r){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t);if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function LR(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function BR(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,i,s,o,a=[],u=!0,l=!1;try{if(s=(r=r.call(e)).next,0===t);else for(;!(u=(n=s.call(r)).done)&&(a.push(n.value),a.length!==t);u=!0);}catch(e){l=!0,i=e}finally{try{if(!u&&null!=r.return&&(o=r.return(),Object(o)!==o))return}finally{if(l)throw i}}return a}}(e,t)||function(e,t){if(e){if("string"==typeof e)return FR(e,t);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?FR(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function kR(e){return kR="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},kR(e)}tR={__e:function(e,t){for(var r,n;t=t.__;)if((r=t.__c)&&!r.__)try{if(r.constructor&&null!=r.constructor.getDerivedStateFromError&&(n=!0,r.setState(r.constructor.getDerivedStateFromError(e))),null!=r.componentDidCatch&&(n=!0,r.componentDidCatch(e)),n)return bR(r.__E=r)}catch(t){e=t}throw e}},rR=function(e){return null!=e&&void 0===e.constructor},gR.prototype.setState=function(e,t){var r;r=this.__s!==this.state?this.__s:this.__s=hR({},this.state),"function"==typeof e&&(e=e(r,this.props)),e&&hR(r,e),null!=e&&this.__v&&(t&&this.__h.push(t),bR(this))},gR.prototype.forceUpdate=function(e){this.__v&&(this.__e=!0,e&&this.__h.push(e),bR(this))},gR.prototype.render=fR,nR=[],iR=0,sR="function"==typeof Promise?Promise.prototype.then.bind(Promise.resolve()):setTimeout,aR=uR;var IR=function(e){if("object"!==kR(e))return e;var t,r=DR(e);r.props&&(r.props=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?LR(Object(r),!0).forEach((function(t){OR(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):LR(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}({},r.props),null!=r&&null!==(t=r.props)&&void 0!==t&&t.children&&(r.props.children=Array.isArray(r.props.children)?r.props.children.map(IR):IR(r.props.children)));return r};!function(e,t){void 0===t&&(t={});var r=t.insertAt;if("undefined"!=typeof document){var n=document.head||document.getElementsByTagName("head")[0],i=document.createElement("style");i.type="text/css","top"===r&&n.firstChild?n.insertBefore(i,n.firstChild):n.appendChild(i),i.styleSheet?i.styleSheet.cssText=e:i.appendChild(document.createTextNode(e))}}(".float-tooltip-kap {\n  position: absolute;\n  width: max-content; /* prevent shrinking near right edge */\n  max-width: max(50%, 150px);\n  padding: 3px 5px;\n  border-radius: 3px;\n  font: 12px sans-serif;\n  color: #eee;\n  background: rgba(0,0,0,0.6);\n  pointer-events: none;\n}\n");var UR=Bs({props:{content:{default:!1},offsetX:{triggerUpdate:!1},offsetY:{triggerUpdate:!1}},init:function(e,t){var r=(arguments.length>2&&void 0!==arguments[2]?arguments[2]:{}).style,n=void 0===r?{}:r,i=function(e){return"string"==typeof e?new eR([[document.querySelector(e)]],[document.documentElement]):new eR([[e]],JM)}(!!e&&"object"===kR(e)&&!!e.node&&"function"==typeof e.node?e.node():e);"static"===i.style("position")&&i.style("position","relative"),t.tooltipEl=i.append("div").attr("class","float-tooltip-kap"),Object.entries(n).forEach((function(e){var r=BR(e,2),n=r[0],i=r[1];return t.tooltipEl.style(n,i)})),t.tooltipEl.style("left","-10000px").style("display","none");var s="tooltip-".concat(Math.round(1e12*Math.random()));t.mouseInside=!1,i.on("mousemove.".concat(s),(function(e){t.mouseInside=!0;var r=function(e,t){if(e=function(e){let t;for(;t=e.sourceEvent;)e=t;return e}(e),void 0===t&&(t=e.currentTarget),t){var r=t.ownerSVGElement||t;if(r.createSVGPoint){var n=r.createSVGPoint();return n.x=e.clientX,n.y=e.clientY,[(n=n.matrixTransform(t.getScreenCTM().inverse())).x,n.y]}if(t.getBoundingClientRect){var i=t.getBoundingClientRect();return[e.clientX-i.left-t.clientLeft,e.clientY-i.top-t.clientTop]}}return[e.pageX,e.pageY]}(e),n=i.node(),s=n.offsetWidth,o=n.offsetHeight,a=[null===t.offsetX||void 0===t.offsetX?"-".concat(r[0]/s*100,"%"):"number"==typeof t.offsetX?"calc(-50% + ".concat(t.offsetX,"px)"):t.offsetX,null===t.offsetY||void 0===t.offsetY?o>130&&o-r[1]<100?"calc(-100% - 6px)":"21px":"number"==typeof t.offsetY?t.offsetY<0?"calc(-100% - ".concat(Math.abs(t.offsetY),"px)"):"".concat(t.offsetY,"px"):t.offsetY];t.tooltipEl.style("left",r[0]+"px").style("top",r[1]+"px").style("transform","translate(".concat(a.join(","),")")),t.content&&t.tooltipEl.style("display","inline")})),i.on("mouseover.".concat(s),(function(){t.mouseInside=!0,t.content&&t.tooltipEl.style("display","inline")})),i.on("mouseout.".concat(s),(function(){t.mouseInside=!1,t.tooltipEl.style("display","none")}))},update:function(e){var t,r;e.tooltipEl.style("display",e.content&&e.mouseInside?"inline":"none"),e.content?e.content instanceof HTMLElement?(e.tooltipEl.text(""),e.tooltipEl.append((function(){return e.content}))):"string"==typeof e.content?e.tooltipEl.html(e.content):!function(e){return rR(DR(e))}(e.content)?e.tooltipEl.style("display","none"):(e.tooltipEl.text(""),t=e.content,delete(r=e.tooltipEl.node()).__k,PR(IR(t),r)):e.tooltipEl.text("")}});function VR(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function jR(e,t,r){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t);if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function GR(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,i,s,o,a=[],u=!0,l=!1;try{if(s=(r=r.call(e)).next,0===t);else for(;!(u=(n=s.call(r)).done)&&(a.push(n.value),a.length!==t);u=!0);}catch(c){l=!0,i=c}finally{try{if(!u&&null!=r.return&&(o=r.return(),Object(o)!==o))return}finally{if(l)throw i}}return a}}(e,t)||$R(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function zR(e){return function(e){if(Array.isArray(e))return VR(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||$R(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function $R(e,t){if(e){if("string"==typeof e)return VR(e,t);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?VR(e,t):void 0}}!function(e,t){void 0===t&&(t={});var r=t.insertAt;if("undefined"!=typeof document){var n=document.head||document.getElementsByTagName("head")[0],i=document.createElement("style");i.type="text/css","top"===r&&n.firstChild?n.insertBefore(i,n.firstChild):n.appendChild(i),i.styleSheet?i.styleSheet.cssText=e:i.appendChild(document.createTextNode(e))}}(".scene-nav-info {\n  position: absolute;\n  bottom: 5px;\n  width: 100%;\n  text-align: center;\n  color: slategrey;\n  opacity: 0.7;\n  font-size: 10px;\n  font-family: sans-serif;\n  pointer-events: none;\n  user-select: none;\n}\n\n.scene-container canvas:focus {\n  outline: none;\n}");var HR=window.THREE?window.THREE:{WebGLRenderer:An,Scene:A,PerspectiveCamera:re,Raycaster:t,SRGBColorSpace:S,TextureLoader:Cn,Vector2:i,Vector3:o,Box3:y,Color:h,Mesh:l,SphereGeometry:c,MeshBasicMaterial:he,BackSide:L,Clock:Nn},WR=Bs({props:{width:{default:window.innerWidth,onChange:function(e,t,r){isNaN(e)&&(t.width=r)}},height:{default:window.innerHeight,onChange:function(e,t,r){isNaN(e)&&(t.height=r)}},viewOffset:{default:[0,0]},backgroundColor:{default:"#000011"},backgroundImageUrl:{},onBackgroundImageLoaded:{},showNavInfo:{default:!0},skyRadius:{default:5e4},objects:{default:[]},lights:{default:[]},enablePointerInteraction:{default:!0,onChange:function(e,t){t.hoverObj=null,t.tooltip&&t.tooltip.content(null)},triggerUpdate:!1},pointerRaycasterThrottleMs:{default:50,triggerUpdate:!1},lineHoverPrecision:{default:1,triggerUpdate:!1},pointsHoverPrecision:{default:1,triggerUpdate:!1},hoverOrderComparator:{triggerUpdate:!1},hoverFilter:{default:function(){return!0},triggerUpdate:!1},tooltipContent:{triggerUpdate:!1},hoverDuringDrag:{default:!1,triggerUpdate:!1},clickAfterDrag:{default:!1,triggerUpdate:!1},onHover:{default:function(){},triggerUpdate:!1},onClick:{default:function(){},triggerUpdate:!1},onRightClick:{triggerUpdate:!1}},methods:{tick:function(e){if(e.initialised){e.controls.enabled&&e.controls.update&&e.controls.update(Math.min(1,e.clock.getDelta())),e.postProcessingComposer?e.postProcessingComposer.render():e.renderer.render(e.scene,e.camera),e.extraRenderers.forEach((function(t){return t.render(e.scene,e.camera)}));var t=+new Date;if(e.enablePointerInteraction&&t-e.lastRaycasterCheck>=e.pointerRaycasterThrottleMs){e.lastRaycasterCheck=t;var r=null;if(e.hoverDuringDrag||!e.isPointerDragging){var n=this.intersectingObjects(e.pointerPos.x,e.pointerPos.y);e.hoverOrderComparator&&n.sort((function(t,r){return e.hoverOrderComparator(t.object,r.object)}));var i=n.find((function(t){return e.hoverFilter(t.object)}))||null;r=i?i.object:null,e.intersection=i||null}r!==e.hoverObj&&(e.onHover(r,e.hoverObj,e.intersection),e.tooltip.content(r&&ks(e.tooltipContent)(r,e.intersection)||null),e.hoverObj=r)}e.tweenGroup.update()}return this},getPointerPos:function(e){var t=e.pointerPos;return{x:t.x,y:t.y}},cameraPosition:function(e,t,r,n){var i=e.camera;if(t&&e.initialised){var s=t,o=r||{x:0,y:0,z:0};if(n){var a=Object.assign({},i.position),u=h();e.tweenGroup.add(new HA(a).to(s,n).easing(UA.Quadratic.Out).onUpdate(l).start()),e.tweenGroup.add(new HA(u).to(o,n/3).easing(UA.Quadratic.Out).onUpdate(c).start())}else l(s),c(o);return this}return Object.assign({},i.position,{lookAt:h()});function l(e){var t=e.x,r=e.y,n=e.z;void 0!==t&&(i.position.x=t),void 0!==r&&(i.position.y=r),void 0!==n&&(i.position.z=n)}function c(t){var r=new HR.Vector3(t.x,t.y,t.z);e.controls.target?e.controls.target=r:i.lookAt(r)}function h(){return Object.assign(new HR.Vector3(0,0,-1e3).applyQuaternion(i.quaternion).add(i.position))}},zoomToFit:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10,n=arguments.length,i=new Array(n>3?n-3:0),s=3;s<n;s++)i[s-3]=arguments[s];return this.fitToBbox(this.getBbox.apply(this,i),t,r)},fitToBbox:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:10,i=e.camera;if(t){var s=new HR.Vector3(0,0,0),o=2*Math.max.apply(Math,zR(Object.entries(t).map((function(e){var t=GR(e,2),r=t[0],n=t[1];return Math.max.apply(Math,zR(n.map((function(e){return Math.abs(s[r]-e)}))))})))),a=(1-2*n/e.height)*i.fov,u=o/Math.atan(a*Math.PI/180),l=u/i.aspect,c=Math.max(u,l);if(c>0){var h=s.clone().sub(i.position).normalize().multiplyScalar(-c);this.cameraPosition(h,s,r)}}return this},getBbox:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){return!0},r=new HR.Box3(new HR.Vector3(0,0,0),new HR.Vector3(0,0,0)),n=e.objects.filter(t);return n.length?(n.forEach((function(e){return r.expandByObject(e)})),Object.assign.apply(Object,zR(["x","y","z"].map((function(e){return jR({},e,[r.min[e],r.max[e]])}))))):null},getScreenCoords:function(e,t,r,n){var i=new HR.Vector3(t,r,n);return i.project(this.camera()),{x:(i.x+1)*e.width/2,y:-(i.y-1)*e.height/2}},getSceneCoords:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=new HR.Vector2(t/e.width*2-1,-r/e.height*2+1),s=new HR.Raycaster;return s.setFromCamera(i,e.camera),Object.assign({},s.ray.at(n,new HR.Vector3))},intersectingObjects:function(e,t,r){var n=new HR.Vector2(t/e.width*2-1,-r/e.height*2+1),i=new HR.Raycaster;return i.params.Line.threshold=e.lineHoverPrecision,i.params.Points.threshold=e.pointsHoverPrecision,i.setFromCamera(n,e.camera),i.intersectObjects(e.objects,!0)},renderer:function(e){return e.renderer},scene:function(e){return e.scene},camera:function(e){return e.camera},postProcessingComposer:function(e){return e.postProcessingComposer},controls:function(e){return e.controls},tbControls:function(e){return e.controls}},stateInit:function(){return{scene:new HR.Scene,camera:new HR.PerspectiveCamera,clock:new HR.Clock,tweenGroup:new jA,lastRaycasterCheck:0}},init:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=r.controlType,i=void 0===n?"trackball":n,s=r.useWebGPU,o=void 0!==s&&s,a=r.rendererConfig,u=void 0===a?{}:a,l=r.extraRenderers,c=void 0===l?[]:l,h=r.waitForLoadComplete,d=void 0===h||h;e.innerHTML="",e.appendChild(t.container=document.createElement("div")),t.container.className="scene-container",t.container.style.position="relative",t.container.appendChild(t.navInfo=document.createElement("div")),t.navInfo.className="scene-nav-info",t.navInfo.textContent={orbit:"Left-click: rotate, Mouse-wheel/middle-click: zoom, Right-click: pan",trackball:"Left-click: rotate, Mouse-wheel/middle-click: zoom, Right-click: pan",fly:"WASD: move, R|F: up | down, Q|E: roll, up|down: pitch, left|right: yaw"}[i]||"",t.navInfo.style.display=t.showNavInfo?null:"none",t.tooltip=new UR(t.container),t.pointerPos=new HR.Vector2,t.pointerPos.x=-2,t.pointerPos.y=-2,["pointermove","pointerdown"].forEach((function(e){return t.container.addEventListener(e,(function(r){if("pointerdown"===e&&(t.isPointerPressed=!0),!t.isPointerDragging&&"pointermove"===r.type&&(r.pressure>0||t.isPointerPressed)&&("touch"!==r.pointerType||void 0===r.movementX||[r.movementX,r.movementY].some((function(e){return Math.abs(e)>1})))&&(t.isPointerDragging=!0),t.enablePointerInteraction){var n=(i=t.container,s=i.getBoundingClientRect(),o=window.pageXOffset||document.documentElement.scrollLeft,a=window.pageYOffset||document.documentElement.scrollTop,{top:s.top+a,left:s.left+o});t.pointerPos.x=r.pageX-n.left,t.pointerPos.y=r.pageY-n.top}var i,s,o,a}),{passive:!0})})),t.container.addEventListener("pointerup",(function(e){t.isPointerPressed&&(t.isPointerPressed=!1,t.isPointerDragging&&(t.isPointerDragging=!1,!t.clickAfterDrag)||requestAnimationFrame((function(){0===e.button&&t.onClick(t.hoverObj||null,e,t.intersection),2===e.button&&t.onRightClick&&t.onRightClick(t.hoverObj||null,e,t.intersection)})))}),{passive:!0,capture:!0}),t.container.addEventListener("contextmenu",(function(e){t.onRightClick&&e.preventDefault()})),t.renderer=new(o?CE:HR.WebGLRenderer)(Object.assign({antialias:!0,alpha:!0},u)),t.renderer.setPixelRatio(Math.min(2,window.devicePixelRatio)),t.container.appendChild(t.renderer.domElement),t.extraRenderers=c,t.extraRenderers.forEach((function(e){e.domElement.style.position="absolute",e.domElement.style.top="0px",e.domElement.style.pointerEvents="none",t.container.appendChild(e.domElement)})),t.postProcessingComposer=new iA(t.renderer),t.postProcessingComposer.addPass(new sA(t.scene,t.camera)),t.controls=new{trackball:XE,orbit:EC,fly:GC}[i](t.camera,t.renderer.domElement),"fly"===i&&(t.controls.movementSpeed=300,t.controls.rollSpeed=Math.PI/6,t.controls.dragToLook=!0),"trackball"!==i&&"orbit"!==i||(t.controls.minDistance=.1,t.controls.maxDistance=t.skyRadius,t.controls.addEventListener("start",(function(){t.controlsEngaged=!0})),t.controls.addEventListener("change",(function(){t.controlsEngaged&&(t.controlsDragging=!0)})),t.controls.addEventListener("end",(function(){t.controlsEngaged=!1,t.controlsDragging=!1}))),[t.renderer,t.postProcessingComposer].concat(zR(t.extraRenderers)).forEach((function(e){return e.setSize(t.width,t.height)})),t.camera.aspect=t.width/t.height,t.camera.updateProjectionMatrix(),t.camera.position.z=1e3,t.scene.add(t.skysphere=new HR.Mesh),t.skysphere.visible=!1,t.loadComplete=t.scene.visible=!d,window.scene=t.scene},update:function(e,t){if(e.width&&e.height&&(t.hasOwnProperty("width")||t.hasOwnProperty("height"))){var r,n=e.width,i=e.height;e.container.style.width="".concat(n,"px"),e.container.style.height="".concat(i,"px"),[e.renderer,e.postProcessingComposer].concat(zR(e.extraRenderers)).forEach((function(e){return e.setSize(n,i)})),e.camera.aspect=n/i;var s=e.viewOffset.slice(0,2);s.some((function(e){return e}))&&(r=e.camera).setViewOffset.apply(r,[n,i].concat(zR(s),[n,i])),e.camera.updateProjectionMatrix()}if(t.hasOwnProperty("viewOffset")){var o,a=e.width,u=e.height,l=e.viewOffset.slice(0,2);l.some((function(e){return e}))?(o=e.camera).setViewOffset.apply(o,[a,u].concat(zR(l),[a,u])):e.camera.clearViewOffset()}if(t.hasOwnProperty("skyRadius")&&e.skyRadius&&(e.controls.hasOwnProperty("maxDistance")&&t.skyRadius&&(e.controls.maxDistance=Math.min(e.controls.maxDistance,e.skyRadius)),e.camera.far=2.5*e.skyRadius,e.camera.updateProjectionMatrix(),e.skysphere.geometry=new HR.SphereGeometry(e.skyRadius)),t.hasOwnProperty("backgroundColor")){var c=TA(e.backgroundColor).alpha;void 0===c&&(c=1),e.renderer.setClearColor(new HR.Color(IA(1,e.backgroundColor)),c)}function h(){e.loadComplete=e.scene.visible=!0}t.hasOwnProperty("backgroundImageUrl")&&(e.backgroundImageUrl?(new HR.TextureLoader).load(e.backgroundImageUrl,(function(t){t.colorSpace=HR.SRGBColorSpace,e.skysphere.material=new HR.MeshBasicMaterial({map:t,side:HR.BackSide}),e.skysphere.visible=!0,e.onBackgroundImageLoaded&&setTimeout(e.onBackgroundImageLoaded),!e.loadComplete&&h()})):(e.skysphere.visible=!1,e.skysphere.material.map=null,!e.loadComplete&&h())),t.hasOwnProperty("showNavInfo")&&(e.navInfo.style.display=e.showNavInfo?null:"none"),t.hasOwnProperty("lights")&&((t.lights||[]).forEach((function(t){return e.scene.remove(t)})),e.lights.forEach((function(t){return e.scene.add(t)}))),t.hasOwnProperty("objects")&&((t.objects||[]).forEach((function(t){return e.scene.remove(t)})),e.objects.forEach((function(t){return e.scene.add(t)})))}});function qR(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function XR(e,t,r){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t);if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function KR(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function YR(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?KR(Object(r),!0).forEach((function(t){XR(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):KR(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function QR(e){return function(e){if(Array.isArray(e))return qR(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return qR(e,t);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?qR(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ZR(e,t){var r=new t;return r._destructor&&r._destructor(),{linkProp:function(t){return{default:r[t](),onChange:function(r,n){n[e][t](r)},triggerUpdate:!1}},linkMethod:function(t){return function(r){for(var n=r[e],i=arguments.length,s=new Array(i>1?i-1:0),o=1;o<i;o++)s[o-1]=arguments[o];var a=n[t].apply(n,s);return a===n?this:a}}}}!function(e,t){void 0===t&&(t={});var r=t.insertAt;if("undefined"!=typeof document){var n=document.head||document.getElementsByTagName("head")[0],i=document.createElement("style");i.type="text/css","top"===r&&n.firstChild?n.insertBefore(i,n.firstChild):n.appendChild(i),i.styleSheet?i.styleSheet.cssText=e:i.appendChild(document.createTextNode(e))}}(".graph-info-msg {\n  top: 50%;\n  width: 100%;\n  text-align: center;\n  color: lavender;\n  opacity: 0.7;\n  font-size: 22px;\n  position: absolute;\n  font-family: Sans-serif;\n}\n\n.scene-container .clickable {\n  cursor: pointer;\n}\n\n.scene-container .grabbable {\n  cursor: move;\n  cursor: grab;\n  cursor: -moz-grab;\n  cursor: -webkit-grab;\n}\n\n.scene-container .grabbable:active {\n  cursor: grabbing;\n  cursor: -moz-grabbing;\n  cursor: -webkit-grabbing;\n}");var JR=window.THREE?window.THREE:{AmbientLight:z,DirectionalLight:V,REVISION:Ae},eP=ZR("forceGraph",xa),tP=Object.assign.apply(Object,QR(["jsonUrl","graphData","numDimensions","dagMode","dagLevelDistance","dagNodeFilter","onDagError","nodeRelSize","nodeId","nodeVal","nodeResolution","nodeColor","nodeAutoColorBy","nodeOpacity","nodeVisibility","nodeThreeObject","nodeThreeObjectExtend","nodePositionUpdate","linkSource","linkTarget","linkVisibility","linkColor","linkAutoColorBy","linkOpacity","linkWidth","linkResolution","linkCurvature","linkCurveRotation","linkMaterial","linkThreeObject","linkThreeObjectExtend","linkPositionUpdate","linkDirectionalArrowLength","linkDirectionalArrowColor","linkDirectionalArrowRelPos","linkDirectionalArrowResolution","linkDirectionalParticles","linkDirectionalParticleSpeed","linkDirectionalParticleWidth","linkDirectionalParticleColor","linkDirectionalParticleResolution","forceEngine","d3AlphaDecay","d3VelocityDecay","d3AlphaMin","ngraphPhysics","warmupTicks","cooldownTicks","cooldownTime","onEngineTick","onEngineStop"].map((function(e){return XR({},e,eP.linkProp(e))})))),rP=Object.assign.apply(Object,QR(["refresh","getGraphBbox","d3Force","d3ReheatSimulation","emitParticle"].map((function(e){return XR({},e,eP.linkMethod(e))})))),nP=ZR("renderObjs",WR),iP=Object.assign.apply(Object,QR(["width","height","backgroundColor","showNavInfo","enablePointerInteraction"].map((function(e){return XR({},e,nP.linkProp(e))})))),sP=Object.assign.apply(Object,QR(["lights","cameraPosition","postProcessingComposer"].map((function(e){return XR({},e,nP.linkMethod(e))}))).concat([{graph2ScreenCoords:nP.linkMethod("getScreenCoords"),screen2GraphCoords:nP.linkMethod("getSceneCoords")}])),oP=Bs({props:YR(YR({nodeLabel:{default:"name",triggerUpdate:!1},linkLabel:{default:"name",triggerUpdate:!1},linkHoverPrecision:{default:1,onChange:function(e,t){return t.renderObjs.lineHoverPrecision(e)},triggerUpdate:!1},enableNavigationControls:{default:!0,onChange:function(e,t){var r=t.renderObjs.controls();r&&(r.enabled=e,e&&r.domElement&&r.domElement.dispatchEvent(new PointerEvent("pointerup")))},triggerUpdate:!1},enableNodeDrag:{default:!0,triggerUpdate:!1},onNodeDrag:{default:function(){},triggerUpdate:!1},onNodeDragEnd:{default:function(){},triggerUpdate:!1},onNodeClick:{triggerUpdate:!1},onNodeRightClick:{triggerUpdate:!1},onNodeHover:{triggerUpdate:!1},onLinkClick:{triggerUpdate:!1},onLinkRightClick:{triggerUpdate:!1},onLinkHover:{triggerUpdate:!1},onBackgroundClick:{triggerUpdate:!1},onBackgroundRightClick:{triggerUpdate:!1}},tP),iP),methods:YR(YR({zoomToFit:function(e,t,r){for(var n,i=arguments.length,s=new Array(i>3?i-3:0),o=3;o<i;o++)s[o-3]=arguments[o];return e.renderObjs.fitToBbox((n=e.forceGraph).getGraphBbox.apply(n,s),t,r),this},pauseAnimation:function(e){return null!==e.animationFrameRequestId&&(cancelAnimationFrame(e.animationFrameRequestId),e.animationFrameRequestId=null),this},resumeAnimation:function(e){return null===e.animationFrameRequestId&&this._animationCycle(),this},_animationCycle:function(e){e.enablePointerInteraction&&(this.renderer().domElement.style.cursor=null),e.forceGraph.tickFrame(),e.renderObjs.tick(),e.animationFrameRequestId=requestAnimationFrame(this._animationCycle)},scene:function(e){return e.renderObjs.scene()},camera:function(e){return e.renderObjs.camera()},renderer:function(e){return e.renderObjs.renderer()},controls:function(e){return e.renderObjs.controls()},tbControls:function(e){return e.renderObjs.tbControls()},_destructor:function(){this.pauseAnimation(),this.graphData({nodes:[],links:[]})}},rP),sP),stateInit:function(e){var t=e.controlType,r=e.rendererConfig,n=e.extraRenderers,i=new xa;return{forceGraph:i,renderObjs:WR({controlType:t,rendererConfig:r,extraRenderers:n}).objects([i]).lights([new JR.AmbientLight(13421772,Math.PI),new JR.DirectionalLight(16777215,.6*Math.PI)])}},init:function(e,t){e.innerHTML="",e.appendChild(t.container=document.createElement("div")),t.container.style.position="relative";var r=document.createElement("div");t.container.appendChild(r),t.renderObjs(r);var n,i=t.renderObjs.camera(),s=t.renderObjs.renderer(),o=t.renderObjs.controls();o.enabled=!!t.enableNavigationControls,t.lastSetCameraZ=i.position.z,t.container.appendChild(n=document.createElement("div")),n.className="graph-info-msg",n.textContent="",t.forceGraph.onLoading((function(){n.textContent="Loading..."})).onFinishLoading((function(){n.textContent=""})).onUpdate((function(){t.graphData=t.forceGraph.graphData(),0===i.position.x&&0===i.position.y&&i.position.z===t.lastSetCameraZ&&t.graphData.nodes.length&&(i.lookAt(t.forceGraph.position),t.lastSetCameraZ=i.position.z=170*Math.cbrt(t.graphData.nodes.length))})).onFinishUpdate((function(){if(t._dragControls){var e=t.graphData.nodes.find((function(e){return e.__initialFixedPos&&!e.__disposeControlsAfterDrag}));e?e.__disposeControlsAfterDrag=!0:t._dragControls.dispose(),t._dragControls=void 0}if(t.enableNodeDrag&&t.enablePointerInteraction&&"d3"===t.forceEngine){var r=t._dragControls=new bi(t.graphData.nodes.map((function(e){return e.__threeObj})).filter((function(e){return e})),i,s.domElement);r.addEventListener("dragstart",(function(e){var t=aP(e.object);if(t){o.enabled=!1,e.object.__initialPos=e.object.position.clone(),e.object.__prevPos=e.object.position.clone();var r=t.__data;!r.__initialFixedPos&&(r.__initialFixedPos={fx:r.fx,fy:r.fy,fz:r.fz}),!r.__initialPos&&(r.__initialPos={x:r.x,y:r.y,z:r.z}),["x","y","z"].forEach((function(e){return r["f".concat(e)]=r[e]})),s.domElement.classList.add("grabbable")}})),r.addEventListener("drag",(function(e){var r=aP(e.object);if(r){if(!e.object.hasOwnProperty("__graphObjType")){var n=e.object.__initialPos,i=e.object.__prevPos,s=e.object.position;r.position.add(s.clone().sub(i)),i.copy(s),s.copy(n)}var o=r.__data,a=r.position,u={x:a.x-o.x,y:a.y-o.y,z:a.z-o.z};["x","y","z"].forEach((function(e){return o["f".concat(e)]=o[e]=a[e]})),t.forceGraph.d3AlphaTarget(.3).resetCountdown(),o.__dragged=!0,t.onNodeDrag(o,u)}})),r.addEventListener("dragend",(function(e){var n=aP(e.object);if(n){delete e.object.__initialPos,delete e.object.__prevPos;var i=n.__data;i.__disposeControlsAfterDrag&&(r.dispose(),delete i.__disposeControlsAfterDrag);var a=i.__initialFixedPos,u=i.__initialPos,l={x:u.x-i.x,y:u.y-i.y,z:u.z-i.z};a&&(["x","y","z"].forEach((function(e){var t="f".concat(e);void 0===a[t]&&delete i[t]})),delete i.__initialFixedPos,delete i.__initialPos,i.__dragged&&(delete i.__dragged,t.onNodeDragEnd(i,l))),t.forceGraph.d3AlphaTarget(0).resetCountdown(),t.enableNavigationControls&&(o.enabled=!0,o.domElement&&o.domElement.ownerDocument&&o.domElement.ownerDocument.dispatchEvent(new PointerEvent("pointerup",{pointerType:"touch"}))),s.domElement.classList.remove("grabbable")}}))}})),JR.REVISION<155&&(t.renderObjs.renderer().useLegacyLights=!1),t.renderObjs.hoverOrderComparator((function(e,t){var r=aP(e);if(!r)return 1;var n=aP(t);if(!n)return-1;var i=function(e){return"node"===e.__graphObjType};return i(n)-i(r)})).tooltipContent((function(e){var r=aP(e);return r&&ks(t["".concat(r.__graphObjType,"Label")])(r.__data)||""})).hoverDuringDrag(!1).onHover((function(e){var r=aP(e);if(r!==t.hoverObj){var n=t.hoverObj?t.hoverObj.__graphObjType:null,i=t.hoverObj?t.hoverObj.__data:null,o=r?r.__graphObjType:null,a=r?r.__data:null;if(n&&n!==o){var u=t["on".concat("node"===n?"Node":"Link","Hover")];u&&u(null,i)}if(o){var l=t["on".concat("node"===o?"Node":"Link","Hover")];l&&l(a,n===o?i:null)}s.domElement.classList[r&&t["on".concat("node"===o?"Node":"Link","Click")]||!r&&t.onBackgroundClick?"add":"remove"]("clickable"),t.hoverObj=r}})).clickAfterDrag(!1).onClick((function(e,r){var n=aP(e);if(n){var i=t["on".concat("node"===n.__graphObjType?"Node":"Link","Click")];i&&i(n.__data,r)}else t.onBackgroundClick&&t.onBackgroundClick(r)})).onRightClick((function(e,r){var n=aP(e);if(n){var i=t["on".concat("node"===n.__graphObjType?"Node":"Link","RightClick")];i&&i(n.__data,r)}else t.onBackgroundRightClick&&t.onBackgroundRightClick(r)})),this._animationCycle()}});function aP(e){for(var t=e;t&&!t.hasOwnProperty("__graphObjType");)t=t.parent;return t}const uP={width:Hn.number,height:Hn.number,graphData:Hn.shape({nodes:Hn.arrayOf(Hn.object).isRequired,links:Hn.arrayOf(Hn.object).isRequired}),backgroundColor:Hn.string,nodeRelSize:Hn.number,nodeId:Hn.string,nodeLabel:Hn.oneOfType([Hn.string,Hn.func]),nodeVal:Hn.oneOfType([Hn.number,Hn.string,Hn.func]),nodeVisibility:Hn.oneOfType([Hn.bool,Hn.string,Hn.func]),nodeColor:Hn.oneOfType([Hn.string,Hn.func]),nodeAutoColorBy:Hn.oneOfType([Hn.string,Hn.func]),onNodeHover:Hn.func,onNodeClick:Hn.func,linkSource:Hn.string,linkTarget:Hn.string,linkLabel:Hn.oneOfType([Hn.string,Hn.func]),linkVisibility:Hn.oneOfType([Hn.bool,Hn.string,Hn.func]),linkColor:Hn.oneOfType([Hn.string,Hn.func]),linkAutoColorBy:Hn.oneOfType([Hn.string,Hn.func]),linkWidth:Hn.oneOfType([Hn.number,Hn.string,Hn.func]),linkCurvature:Hn.oneOfType([Hn.number,Hn.string,Hn.func]),linkDirectionalArrowLength:Hn.oneOfType([Hn.number,Hn.string,Hn.func]),linkDirectionalArrowColor:Hn.oneOfType([Hn.string,Hn.func]),linkDirectionalArrowRelPos:Hn.oneOfType([Hn.number,Hn.string,Hn.func]),linkDirectionalParticles:Hn.oneOfType([Hn.number,Hn.string,Hn.func]),linkDirectionalParticleSpeed:Hn.oneOfType([Hn.number,Hn.string,Hn.func]),linkDirectionalParticleWidth:Hn.oneOfType([Hn.number,Hn.string,Hn.func]),linkDirectionalParticleColor:Hn.oneOfType([Hn.string,Hn.func]),onLinkHover:Hn.func,onLinkClick:Hn.func,dagMode:Hn.oneOf(["td","bu","lr","rl","zin","zout","radialin","radialout"]),dagLevelDistance:Hn.number,dagNodeFilter:Hn.func,onDagError:Hn.func,d3AlphaMin:Hn.number,d3AlphaDecay:Hn.number,d3VelocityDecay:Hn.number,warmupTicks:Hn.number,cooldownTicks:Hn.number,cooldownTime:Hn.number,onEngineTick:Hn.func,onEngineStop:Hn.func,getGraphBbox:Hn.func},lP={zoomToFit:Hn.func,onNodeRightClick:Hn.func,onNodeDrag:Hn.func,onNodeDragEnd:Hn.func,onLinkRightClick:Hn.func,linkHoverPrecision:Hn.number,onBackgroundClick:Hn.func,onBackgroundRightClick:Hn.func,enablePointerInteraction:Hn.bool,enableNodeDrag:Hn.bool},cP={showNavInfo:Hn.bool,nodeOpacity:Hn.number,nodeResolution:Hn.number,nodeThreeObject:Hn.oneOfType([Hn.object,Hn.string,Hn.func]),nodeThreeObjectExtend:Hn.oneOfType([Hn.bool,Hn.string,Hn.func]),nodePositionUpdate:Hn.func,linkOpacity:Hn.number,linkResolution:Hn.number,linkCurveRotation:Hn.oneOfType([Hn.number,Hn.string,Hn.func]),linkMaterial:Hn.oneOfType([Hn.object,Hn.string,Hn.func]),linkThreeObject:Hn.oneOfType([Hn.object,Hn.string,Hn.func]),linkThreeObjectExtend:Hn.oneOfType([Hn.bool,Hn.string,Hn.func]),linkPositionUpdate:Hn.func,linkDirectionalArrowResolution:Hn.number,linkDirectionalParticleResolution:Hn.number,forceEngine:Hn.oneOf(["d3","ngraph"]),ngraphPhysics:Hn.object,numDimensions:Hn.oneOf([1,2,3])};Object.assign({},uP,lP,{linkLineDash:Hn.oneOfType([Hn.arrayOf(Hn.number),Hn.string,Hn.func]),nodeCanvasObjectMode:Hn.oneOfType([Hn.string,Hn.func]),nodeCanvasObject:Hn.func,nodePointerAreaPaint:Hn.func,linkCanvasObjectMode:Hn.oneOfType([Hn.string,Hn.func]),linkCanvasObject:Hn.func,linkPointerAreaPaint:Hn.func,autoPauseRedraw:Hn.bool,minZoom:Hn.number,maxZoom:Hn.number,enableZoomInteraction:Hn.oneOfType([Hn.bool,Hn.func]),enablePanInteraction:Hn.oneOfType([Hn.bool,Hn.func]),onZoom:Hn.func,onZoomEnd:Hn.func,onRenderFramePre:Hn.func,onRenderFramePost:Hn.func});const hP=Object.assign({},uP,lP,cP,{enableNavigationControls:Hn.bool,controlType:Hn.oneOf(["trackball","orbit","fly"]),rendererConfig:Hn.object,extraRenderers:Hn.arrayOf(Hn.shape({render:Hn.func.isRequired}))});Object.assign({},uP,cP,{nodeDesc:Hn.oneOfType([Hn.string,Hn.func]),linkDesc:Hn.oneOfType([Hn.string,Hn.func])}),Object.assign({},uP,cP,{markerAttrs:Hn.object,yOffset:Hn.number,glScale:Hn.number});const dP=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=t.wrapperElementType,n=void 0===r?"div":r,i=t.nodeMapper,s=void 0===i?function(e){return e}:i,o=t.methodNames,a=void 0===o?[]:o,u=t.initPropNames,l=void 0===u?[]:u;return Pn.forwardRef((function(t,r){var i=Pn.useRef(),o=Pn.useMemo((function(){var r=Object.fromEntries(l.filter((function(e){return t.hasOwnProperty(e)})).map((function(e){return[e,t[e]]})));return e(r)}),[]);ti((function(){o(s(i.current))}),Pn.useLayoutEffect),ti((function(){return o._destructor instanceof Function?o._destructor:void 0}));var u,c,h,d=Pn.useCallback((function(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];return o[e]instanceof Function?o[e].apply(o,r):void 0}),[o]),p=Pn.useRef({});return Object.keys((u=t,c=[].concat(Jn(a),Jn(l)),h=new Set(c),Object.assign.apply(Object,[{}].concat(Xn(Object.entries(u).filter((function(e){var t=qn(e,1)[0];return!h.has(t)})).map((function(e){var t=qn(e,2);return Wn({},t[0],t[1])}))))))).filter((function(e){return p.current[e]!==t[e]})).forEach((function(e){return d(e,t[e])})),p.current=t,Pn.useImperativeHandle(r,(function(){return Object.fromEntries(a.map((function(e){return[e,function(){for(var t=arguments.length,r=new Array(t),n=0;n<t;n++)r[n]=arguments[n];return d.apply(void 0,[e].concat(r))}]})))}),[d]),Dn.createElement(n,{ref:i})}))}(oP,{methodNames:["emitParticle","d3Force","d3ReheatSimulation","stopAnimation","pauseAnimation","resumeAnimation","cameraPosition","zoomToFit","getGraphBbox","screen2GraphCoords","graph2ScreenCoords","postProcessingComposer","lights","scene","camera","renderer","controls","refresh"],initPropNames:["controlType","rendererConfig","extraRenderers"]});dP.displayName="ForceGraph3D",dP.propTypes=hP;const pP={nodes:[{id:"UMMAH",group:0}],links:[]},fP=["Binance","OKX","Bybit","Kraken","Bitfinex","Coinbase","Gemini","KuCoin","Bitstamp","Poloniex","Huobi","Bittrex","Gate.io","Deribit","Upbit","Liquid","Coincheck","ZB.com","BitFlyer","MEXC"],gP={fingerprints:{},addFingerprint:(e,t)=>{gP.fingerprints[e]||(gP.fingerprints[e]=new Set),gP.fingerprints[e].add(t)},report:()=>{}};1===pP.nodes.length&&fP.slice(0,10).forEach((e=>{const t=Math.random()>.8;pP.nodes.push({id:e,group:1,alert:t}),pP.links.push({source:"UMMAH",target:e}),gP.addFingerprint(e,`fp_${e}_${Math.random().toString(36).substr(2,9)}`)}));const mP=()=>{const[e,t]=Pn.useState(!0),[r,n]=Pn.useState(pP),[i,s]=Pn.useState(null),[o,a]=Pn.useState("network"),[u,h]=Pn.useState({}),[p,f]=Pn.useState(!0),g=Pn.useRef(null),m=e=>{s(e),e.alert&&alert(`ALERT: ${e.id} flagged for anomaly.`),h((t=>({...t,[e.id]:{activity:Math.random(),latency:100*Math.random(),throughput:1e3*Math.random(),lastUpdate:(new Date).toISOString()}})))},y=()=>{n({...pP})},b=Pn.useMemo((()=>e=>{const t=new c(e.val||5,16,16),r=new d({color:e.color||(e.alert?"#ff4444":"#4a90e2"),transparent:!0,opacity:i?.id===e.id?1:.8}),n=new l(t,r);if(u[e.id]){const t=u[e.id].activity||0;if(n.scale.setScalar(1+.5*t),t>.7){const e=new Mn(8,12,16),t=new he({color:"#00ff88",transparent:!0,opacity:.3}),r=new l(e,t);n.add(r)}}return n}),[i,u]);Pn.useEffect((()=>{const e=setInterval((()=>{if(p){const e={};r.nodes.forEach((t=>{e[t.id]={activity:Math.random(),latency:20+80*Math.random(),throughput:100+900*Math.random(),lastUpdate:(new Date).toISOString()}})),h(e)}}),2e3);return()=>clearInterval(e)}),[r.nodes,p]),Pn.useEffect((()=>{window.FusionVisualizer={render:y},window.filterThreats=(e="anomaly")=>{const t=r.nodes.filter((e=>e.alert||99===e.group));return t}}),[r]);return e&&(()=>{try{const e=document.createElement("canvas");return!(!window.WebGLRenderingContext||!e.getContext("webgl")&&!e.getContext("experimental-webgl"))}catch(uR){return!1}})()?Rn.jsxs("div",{className:"fusion-visualizer w-full h-64 bg-gray-800 rounded relative",id:"fusion-graph-container",children:[Rn.jsx(dP,{ref:g,graphData:r,nodeAutoColorBy:"group",linkDirectionalArrowLength:4,linkDirectionalParticles:2,nodeLabel:e=>{const t=u[e.id];return`${e.id}${e.alert?" âš ï¸ WARNING":""}\n${t?`Latency: ${t.latency?.toFixed(1)}ms\nThroughput: ${t.throughput?.toFixed(0)} ops/s\nActivity: ${(100*t.activity)?.toFixed(1)}%`:""}`},onNodeClick:m,backgroundColor:"rgba(0,0,0,0)",width:500,height:250,nodeColor:e=>{if(i?.id===e.id)return"#00ff88";if(e.alert)return"#ff4444";return(u[e.id]?.activity||0)>.7?"#ffaa00":"#4a90e2"},linkColor:e=>((u[e.source]?.activity||0)+(u[e.target]?.activity||0))/2>.5?"rgba(0,255,136,0.6)":"rgba(255,255,255,0.2)",nodeRelSize:6,linkWidth:e=>2+4*(((u[e.source]?.activity||0)+(u[e.target]?.activity||0))/2),nodeThreeObject:b,enableNodeDrag:!0,enableNavigationControls:!0,showNavInfo:!1}),Rn.jsxs("div",{className:"absolute top-2 left-2 bg-gray-800 p-2 rounded text-white text-xs",children:[Rn.jsxs("div",{className:"grid grid-cols-3 gap-2 mb-2",children:[Rn.jsxs("div",{className:"bg-blue-600 p-1 rounded text-center",children:["Nodes: ",r.nodes.length]}),Rn.jsxs("div",{className:"bg-green-600 p-1 rounded text-center",children:["Links: ",r.links.length]}),Rn.jsxs("div",{className:"bg-purple-600 p-1 rounded text-center",children:["Active: ",r.nodes.filter((e=>e.alert)).length]})]}),Rn.jsx("div",{className:"flex gap-1 mb-2",children:["network","geographic","threat","topology"].map((e=>Rn.jsx("button",{onClick:()=>a(e),className:"px-2 py-1 rounded text-xs "+(o===e?"bg-cyan-600":"bg-gray-600 hover:bg-gray-500"),children:e.charAt(0).toUpperCase()+e.slice(1)},e)))}),Rn.jsx("button",{onClick:()=>f(!p),className:"px-2 py-1 rounded text-xs "+(p?"bg-green-600":"bg-gray-600 hover:bg-gray-500"),children:p?"ðŸ“Š Metrics ON":"ðŸ“Š Metrics OFF"})]}),i&&Rn.jsxs("div",{className:"absolute bottom-2 left-2 bg-gray-800 p-3 rounded text-white text-xs max-w-xs",children:[Rn.jsx("h4",{className:"font-bold text-cyan-400 mb-1",children:i.id}),i.metadata&&Rn.jsxs(Rn.Fragment,{children:[Rn.jsx("p",{className:"mb-1",children:i.metadata.description}),i.metadata.location&&Rn.jsxs("p",{className:"text-gray-300",children:["ðŸ“ ",i.metadata.location.country]})]}),u[i.id]&&Rn.jsxs("div",{className:"mt-2 grid grid-cols-2 gap-1 text-xs",children:[Rn.jsxs("div",{children:["Latency: ",u[i.id].latency?.toFixed(1),"ms"]}),Rn.jsxs("div",{children:["Activity: ",(100*u[i.id].activity)?.toFixed(1),"%"]})]})]}),Rn.jsx("div",{className:"absolute top-2 right-2 bg-green-800 p-2 rounded text-white text-xs",children:Rn.jsxs("div",{className:"flex items-center gap-1",children:[Rn.jsx("div",{className:"w-2 h-2 bg-green-400 rounded-full animate-pulse"}),Rn.jsx("span",{children:"3D Enhanced"})]})})]}):Rn.jsxs("div",{className:"fusion-visualizer w-full h-64 bg-gray-800 rounded flex flex-col justify-center relative",id:"fusion-graph-container",children:[Rn.jsxs("div",{className:"bg-gray-700 p-4 rounded text-center text-white h-full flex flex-col justify-center",children:[Rn.jsx("h3",{className:"text-lg font-bold mb-4",children:"3D Fusion Map"}),Rn.jsxs("div",{className:"grid grid-cols-3 gap-2 mb-4",children:[Rn.jsxs("div",{className:"bg-blue-600 p-2 rounded text-xs",children:["Nodes: ",r.nodes.length]}),Rn.jsxs("div",{className:"bg-green-600 p-2 rounded text-xs",children:["Links: ",r.links.length]}),Rn.jsxs("div",{className:"bg-purple-600 p-2 rounded text-xs",children:["Active: ",r.nodes.filter((e=>e.alert)).length]})]}),Rn.jsx("div",{className:"grid grid-cols-5 gap-2",children:fP.slice(0,10).map((e=>{const t=r.nodes.find((t=>t.id===e)),n=t?.alert;return Rn.jsxs("div",{className:"bg-gray-600 p-2 rounded text-xs cursor-pointer hover:bg-gray-500 "+(n?"border-2 border-red-500":""),onClick:()=>{n&&alert(`ALERT: ${e} flagged for anomaly.`)},children:[e,n?" WARNING":""]},e)}))}),Rn.jsx("div",{className:"mt-4 text-xs text-gray-300",children:"WebGL not supported - Interactive node grid active"}),Rn.jsx("button",{onClick:()=>t(!0),className:"mt-2 bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-xs transition-colors",children:"Retry 3D Mode"})]}),Rn.jsx("div",{className:"absolute top-2 right-2 bg-yellow-800 p-2 rounded text-white text-xs",children:Rn.jsxs("div",{className:"flex items-center gap-1",children:[Rn.jsx("div",{className:"w-2 h-2 bg-yellow-400 rounded-full"}),Rn.jsx("span",{children:"Fallback Mode"})]})})]})};export{mP as FusionVisualizer,mP as default};
